################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement
# Generated on: 2025-10-05 17:40:33
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\engagement_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\notificationService.ts
--------------------------------------------------------------------------------
Content:
// src/lib/engagement/notificationService.ts
import { User } from '@prisma/client';
import { EmailAdapter, RecipientInfo, NotificationContent } from './adapters/email.adapter';
import { WhatsAppAdapter } from './adapters/whatsapp.adapter';
import Handlebars from 'handlebars';
import fs from 'fs';
import path from 'path';

class NotificationServiceImpl {
  private emailAdapter: EmailAdapter;
  private whatsappAdapter: WhatsAppAdapter;

  constructor() {
    this.emailAdapter = new EmailAdapter();
    this.whatsappAdapter = new WhatsAppAdapter();
  }

  private loadEmailTemplate(templateName: string, context: any): NotificationContent {
    const filePath = path.join(process.cwd(), 'src', 'lib', 'engagement', 'templates', 'email', `${templateName}.hbs`);
    const source = fs.readFileSync(filePath, 'utf-8');
    const template = Handlebars.compile(source);
    const htmlBody = template({
      ...context,
      baseUrl: process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000',
    });

    // We can generate a plain text version here if needed, or just use a subject.
    return { subject: '', body: '', htmlBody };
  }

  async sendWelcome(user: User): Promise<void> {
    const recipient: RecipientInfo = { name: user.firstName, email: user.email, phone: user.phone };
    const context = { firstName: user.firstName };

    // Send Email
    const emailContent = this.loadEmailTemplate('welcome', context);
    emailContent.subject = `×‘×¨×•×š ×”×‘× ×œ-NeshamaTech, ${user.firstName}! ×”××¡×¢ ×©×œ×š ××ª×—×™×œ`;
    await this.emailAdapter.send(recipient, emailContent);

    // Send WhatsApp
    const templateSid = process.env.TWILIO_TEMPLATE_WELCOME_SID;
    if (templateSid) {
      await this.whatsappAdapter.send(recipient, templateSid, { '1': user.firstName });
    }
  }

  async sendProfileNudge(user: User, missingItems: string[]): Promise<void> {
    const recipient: RecipientInfo = { name: user.firstName, email: user.email, phone: user.phone };
    const context = { firstName: user.firstName, missingItems };
    
    const emailContent = this.loadEmailTemplate('profileNudge', context);
    emailContent.subject = `${user.firstName}, ×˜×™×¤ ×§×˜×Ÿ ××”×©×“×›× ×™× ×©×™×¢×©×” ×”×‘×“×œ ×’×“×•×œ`;
    await this.emailAdapter.send(recipient, emailContent);
    
    const templateSid = process.env.TWILIO_TEMPLATE_NUDGE_SID;
    if (templateSid) {
      await this.whatsappAdapter.send(recipient, templateSid, { '1': user.firstName, '2': missingItems.slice(0, 2).join(', ') });
    }
  }

  async sendAiInsight(user: User, personalitySummary: string): Promise<void> {
    const recipient: RecipientInfo = { name: user.firstName, email: user.email, phone: user.phone };
    const context = { firstName: user.firstName, personalitySummary };

    const emailContent = this.loadEmailTemplate('aiInsight', context);
    emailContent.subject = `×’×™×œ×™× ×• ××©×”×• ××¢× ×™×™×Ÿ ×¢×œ ×”××™×©×™×•×ª ×©×œ×š, ${user.firstName}`;
    await this.emailAdapter.send(recipient, emailContent);

    const templateSid = process.env.TWILIO_TEMPLATE_AI_INSIGHT_SID;
    if (templateSid) {
      await this.whatsappAdapter.send(recipient, templateSid, { '1': user.firstName, '2': personalitySummary.substring(0, 200) + '...' });
    }
  }
}

export const notificationService = new NotificationServiceImpl();

--- End of Content for notificationService.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\onboardingEngagementService.ts
--------------------------------------------------------------------------------
Content:
// src/lib/engagement/onboardingEngagementService.ts
import prisma from '@/lib/prisma';
import { CampaignStatus } from '@prisma/client';
import aiService from '@/lib/services/aiService';
import profileAiService from '@/lib/services/profileAiService';
import { notificationService } from './notificationService';

interface OnboardingProgress {
  userId: string;
  daysInSystem: number;
  
  // ××” ×”×©×œ×™×?
  completed: {
    hasPhoto: boolean;
    hasAbout: boolean;
    hasQuestionnaire: boolean; // 80%+
    hasPreferences: boolean;
  };
  
  // ×¦×™×•×Ÿ ×›×•×œ×œ
  completionScore: number; // 0-100
  
  // ××” ×”×¦×¢×“ ×”×‘× ×”×›×™ ×—×©×•×‘?
  nextCriticalStep: string;
  
  // ×ª×•×‘× ×ª AI
  aiMotivation?: string;
}

export class OnboardingEngagementService {
  
  /**
   * ×‘×“×™×§×”: ×”×× ×”××©×ª××© ×‘×ª×§×•×¤×ª ×”-onboarding? (×™××™× 1-14)
   */
  static isInOnboarding(daysInSystem: number): boolean {
    return daysInSystem <= 14;
  }
  
  /**
   * × ×™×ª×•×— ×”×ª×§×“××•×ª onboarding
   */
  static async analyzeOnboardingProgress(userId: string): Promise<OnboardingProgress> {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: {
        profile: true,
        images: true,
        questionnaireResponses: { 
          orderBy: { lastSaved: 'desc' }, 
          take: 1 
        },
      },
    });

    if (!user) throw new Error('User not found');

    const daysInSystem = Math.floor(
      (Date.now() - user.createdAt.getTime()) / (1000 * 60 * 60 * 24)
    );

    // ×‘×“×™×§×•×ª ××” ×”×•×©×œ×
    const hasPhoto = user.images.length >= 1;
    const hasAbout = !!(user.profile?.about && user.profile.about.length >= 50);
    const hasPreferences = !!(user.profile?.preferredAgeMin && user.profile?.preferredAgeMax);
    
    // ×—×™×©×•×‘ ×©××œ×•×Ÿ
    let questionnaireScore = 0;
    const qr = user.questionnaireResponses[0];
    if (qr) {
      const worlds = ['valuesAnswers', 'personalityAnswers', 'relationshipAnswers', 
                      'partnerAnswers', 'religionAnswers'];
      let totalAnswered = 0;
      worlds.forEach(w => {
        const answers = qr[w];
        if (Array.isArray(answers)) totalAnswered += answers.length;
      });
      questionnaireScore = Math.min((totalAnswered / 50) * 100, 100);
    }
    const hasQuestionnaire = questionnaireScore >= 80;

    // ×—×™×©×•×‘ ×¦×™×•×Ÿ ×›×•×œ×œ
    let score = 0;
    if (hasPhoto) score += 30;
    if (hasAbout) score += 25;
    if (hasQuestionnaire) score += 30;
    if (hasPreferences) score += 15;

    // ××” ×”×¦×¢×“ ×”×‘×?
    let nextStep = '';
    if (!hasPhoto) nextStep = '×”×¢×œ××ª ×ª××•× ×ª ×¤×¨×•×¤×™×œ';
    else if (!hasAbout) nextStep = '×›×ª×™×‘×ª ×ª×™××•×¨ ××™×©×™';
    else if (!hasQuestionnaire) nextStep = '×”×©×œ××ª ×”×©××œ×•×Ÿ';
    else if (!hasPreferences) nextStep = '×”×’×“×¨×ª ×”×¢×“×¤×•×ª ×©×™×“×•×š';
    else nextStep = '×”×¤×¨×•×¤×™×œ ××•×›×Ÿ!';

    // ×§×‘×œ×ª ×ª×•×‘× ×ª AI (×× ×™×© ××¡×¤×™×§ ××™×“×¢)
    let aiMotivation;
    if (score >= 30) {
      aiMotivation = await this.getAIMotivation(userId, score, nextStep);
    }

    return {
      userId,
      daysInSystem,
      completed: {
        hasPhoto,
        hasAbout,
        hasQuestionnaire,
        hasPreferences,
      },
      completionScore: Math.round(score),
      nextCriticalStep: nextStep,
      aiMotivation,
    };
  }

  /**
   * ×§×‘×œ×ª ××¡×¨ ××•×˜×™×‘×¦×™×” ××•×ª×× ××™×©×™×ª ×-AI
   */
  static async getAIMotivation(
    userId: string, 
    currentScore: number, 
    nextStep: string
  ): Promise<string | undefined> {
    try {
      const narrative = await profileAiService.generateNarrativeProfile(userId);
      if (!narrative) return undefined;

      const analysis = await aiService.getProfileAnalysis(narrative);
      if (!analysis) return undefined;

      // ×‘× ×” prompt ××•×ª××
      const motivationPrompt = `
        ×”××©×ª××© × ××¦× ×‘×ª×”×œ×™×š ×‘× ×™×™×ª ×”×¤×¨×•×¤×™×œ ×©×œ×•.
        ×¦×™×•×Ÿ × ×•×›×—×™: ${currentScore}/100
        ×”×¦×¢×“ ×”×‘×: ${nextStep}
        
        × ×§×•×“×•×ª ×—×•×–×§ ×©×–×™×”×™× ×•:
        ${analysis.completenessReport
          .filter(r => r.status === 'COMPLETE')
          .map(r => `- ${r.feedback}`)
          .join('\n')}
        
        ×›×ª×•×‘ ××©×¤×˜ ××•×˜×™×‘×¦×™×” ××—×“ (××§×¡×™××•× 2 ×©×•×¨×•×ª) ×‘×¢×‘×¨×™×ª ×©××¢×•×“×“ ××•×ª×• ×œ×”××©×™×š.
        ×”×©×ª××© ×‘××™×“×¢ ×”×¡×¤×¦×™×¤×™ ×©×œ×•, ××œ ×ª×”×™×” ×’× ×¨×™.
        ×ª×Ÿ ×œ×• ×”×¨×’×©×” ×©×”×•× ××ª×§×“× ×™×¤×” ×•×©×”×¦×¢×“ ×”×‘× ×”×•× ×”×’×™×•× ×™.
      `;

      // ×›××Ÿ ×ª×§×¨× ×œ-AI - ×œ×¦×•×¨×š ×”×“×•×’××”:
      return analysis.actionableTips[0]?.tip || 
             `×”×¤×¨×•×¤×™×œ ×©×œ×š ×›×‘×¨ ×‘-${currentScore}%! ${nextStep} ×™×¢×œ×” ××•×ª×š ×œ××¢×œ 70% ×•××– ×ª×”×™×” ××•×›×Ÿ ×œ×§×‘×œ ×”×¦×¢×•×ª.`;
      
    } catch (error) {
      console.error('Failed to get AI motivation:', error);
      return undefined;
    }
  }

  /**
   * ×™×¦×™×¨×ª ××™×™×œ onboarding ×¢× AI
   */
  static async createOnboardingEmail(progress: OnboardingProgress) {
    const { daysInSystem, completionScore, nextCriticalStep, aiMotivation } = progress;

    // ×ª×‘× ×™×ª ××™×™×œ ×œ×¤×™ ×™×•×
    if (daysInSystem === 1) {
      return {
        subject: '×‘×¨×•×›×™× ×”×‘××™× ×œ-NeshamaTech! ×”×¦×¢×“ ×”×¨××©×•×Ÿ ×©×œ×š',
        mainMessage: '××¨×’×© ×©×”×¦×˜×¨×¤×ª! ×‘×•××• × ×ª×—×™×œ ×‘×¦×¢×“ ×”×¨××©×•×Ÿ ×•×”×›×™ ×—×©×•×‘.',
        specificAction: nextCriticalStep,
        progressBar: `×”×ª×§×“××•×ª: ${completionScore}%`,
        aiContent: aiMotivation,
        cta: '×‘×•××• × ×ª×—×™×œ',
      };
    }
    
    if (daysInSystem === 3) {
      return {
        subject: '××™×š ××ª×§×“××™×? ×¢×“×›×•×Ÿ ××”×™×¨',
        mainMessage: `×”×¤×¨×•×¤×™×œ ×©×œ×š ×›×‘×¨ ×‘-${completionScore}%. ×›×œ ×”×›×‘×•×“!`,
        specificAction: `×”×¦×¢×“ ×”×‘×: ${nextCriticalStep}`,
        progressBar: this.generateProgressBar(completionScore),
        aiContent: aiMotivation,
        cta: '×œ×”××©×š ×‘× ×™×™×ª ×”×¤×¨×•×¤×™×œ',
      };
    }
    
    if (daysInSystem === 7) {
      return {
        subject: '×©×‘×•×¢ ×¢×‘×¨ - ×‘×•××• × ×¨××” ××™×¤×” ×× ×—× ×•',
        mainMessage: `×¢×‘×¨ ×©×‘×•×¢ ×××– ×”×¦×˜×¨×¤×ª. ××ª/×” ×‘-${completionScore}%.`,
        specificAction: `×›×“×™ ×œ×”×’×™×¢ ×œ-100%: ${nextCriticalStep}`,
        progressBar: this.generateProgressBar(completionScore),
        aiContent: aiMotivation || '×¤×¨×•×¤×™×œ×™× ××•×©×œ××™× ××§×‘×œ×™× ×¤×™ 3 ×™×•×ª×¨ ×”×¦×¢×•×ª ××™×›×•×ª×™×•×ª.',
        cta: '×œ×¡×™×•× ×”×¤×¨×•×¤×™×œ',
      };
    }

    return null;
  }

  /**
   * ×™×¦×™×¨×ª progress bar ×•×™×–×•××œ×™
   */
  static generateProgressBar(score: number): string {
    const filled = Math.floor(score / 10);
    const empty = 10 - filled;
    return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty) + ` ${score}%`;
  }

  /**
   * ×©×œ×™×—×ª ××™×™×œ onboarding ×‘×¤×•×¢×œ
   */
  static async sendOnboardingEmail(user: any, emailData: any) {
    const recipient = {
      name: user.firstName,
      email: user.email,
      phone: user.phone,
    };

    const htmlContent = `
      <!DOCTYPE html>
      <html dir="rtl" lang="he">
      <head>
        <meta charset="UTF-8">
        <style>
          body { font-family: 'Segoe UI', sans-serif; background: #f7fafc; margin: 0; padding: 20px; }
          .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; }
          .header { background: linear-gradient(135deg, #06b6d4, #8b5cf6); padding: 40px 20px; text-align: center; color: white; }
          .content { padding: 40px 30px; line-height: 1.8; }
          .progress { background: #e2e8f0; border-radius: 20px; height: 30px; margin: 20px 0; overflow: hidden; }
          .progress-fill { background: linear-gradient(90deg, #06b6d4, #8b5cf6); height: 100%; transition: width 0.5s; }
          .ai-box { background: #f0f9ff; border-right: 4px solid #06b6d4; padding: 20px; margin: 20px 0; border-radius: 8px; }
          .cta { display: inline-block; background: #06b6d4; color: white; padding: 14px 32px; 
                 border-radius: 8px; text-decoration: none; margin: 20px 0; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>${emailData.subject}</h1>
          </div>
          <div class="content">
            <p>${emailData.mainMessage}</p>
            
            <div class="progress">
              <div class="progress-fill" style="width: ${emailData.progressBar}"></div>
            </div>
            <p style="text-align: center; color: #64748b;">${emailData.progressBar}</p>
            
            <h3>×”×¦×¢×“ ×”×‘× ×©×œ×š:</h3>
            <p><strong>${emailData.specificAction}</strong></p>
            
            ${emailData.aiContent ? `
              <div class="ai-box">
                <strong>ğŸ’¡ ×”×ª×•×‘× ×” ×”××™×©×™×ª ×©×œ×š:</strong><br>
                ${emailData.aiContent}
              </div>
            ` : ''}
            
            <a href="${process.env.NEXT_PUBLIC_BASE_URL}/profile" class="cta">
              ${emailData.cta}
            </a>
            
            <p style="margin-top: 40px; color: #64748b; font-size: 14px;">
              ×‘×‘×¨×›×”,<br>×¦×•×•×ª NeshamaTech
            </p>
          </div>
        </div>
      </body>
      </html>
    `;

    const { EmailAdapter } = await import('./adapters/email.adapter');
    const emailAdapter = new EmailAdapter();
    
    await emailAdapter.send(recipient, {
      subject: emailData.subject,
      body: emailData.mainMessage,
      htmlBody: htmlContent,
    });
  }
}
--- End of Content for onboardingEngagementService.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\userEngagementService.ts
--------------------------------------------------------------------------------
Content:
// src/lib/engagement/userEngagementService.ts
import prisma from '@/lib/prisma';
import { notificationService } from './notificationService';
import { profileFeedbackService } from '@/lib/services/profileFeedbackService';
import aiService from '@/lib/services/aiService';
import { generateNarrativeProfile } from '@/lib/services/profileAiService';
import { getQuestionnaireQuestionsDictionary } from '@/lib/dictionaries';
import { CampaignStatus, User, Profile, UserImage, QuestionnaireResponse } from '@prisma/client';

type FullUser = User & {
  profile: Profile | null;
  images: UserImage[];
  questionnaireResponses: QuestionnaireResponse[];
};

export class UserEngagementService {

  static async processScheduledCommunications() {
    console.log('[Cron Job] Starting to process scheduled communications...');
    const now = new Date();
    const campaignsToProcess = await prisma.userDripCampaign.findMany({
      where: {
        status: CampaignStatus.ACTIVE,
        nextSendDate: { lte: now },
      },
      include: {
        user: {
          include: {
            profile: true,
            images: true,
            questionnaireResponses: { orderBy: { lastSaved: 'desc' }, take: 1 },
          },
        },
      },
    });

    console.log(`[Cron Job] Found ${campaignsToProcess.length} campaigns to process.`);
    let communicationsSent = 0;
    
    for (const campaign of campaignsToProcess) {
      if (!campaign.user || !campaign.user.marketingConsent) {
        await this.updateCampaignStatus(campaign.id, CampaignStatus.PAUSED);
        continue;
      }

      const sentType = await this.sendNextCommunicationInSequence(campaign.user as FullUser, campaign.lastSentType);

      if (sentType) {
        communicationsSent++;
        const nextStep = campaign.currentStep + 1;
        const nextDelayDays = this.getDelayForNextStep(nextStep);

        if (nextDelayDays === null) {
          await this.updateCampaignStatus(campaign.id, CampaignStatus.COMPLETED);
        } else {
          await prisma.userDripCampaign.update({
            where: { id: campaign.id },
            data: {
              currentStep: nextStep,
              lastSentType: sentType,
              nextSendDate: new Date(now.getTime() + nextDelayDays * 24 * 60 * 60 * 1000),
            },
          });
        }
      } else {
        await prisma.userDripCampaign.update({
          where: { id: campaign.id },
          data: {
            nextSendDate: new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000),
          },
        });
      }
    }
    console.log(`[Cron Job] Finished processing. Sent ${communicationsSent} communications.`);
    return { processed: campaignsToProcess.length, sent: communicationsSent };
  }

  private static async sendNextCommunicationInSequence(user: FullUser, lastSentType: string | null): Promise<string | null> {
    const profileCompletion = user.isProfileComplete;
    const qr = user.questionnaireResponses[0];
    const hasAnsweredQuestionnaire = qr && (qr.worldsCompleted?.length || 0) > 0;

    // Condition for Profile Nudge (Day ~4)
    if ((!profileCompletion || user.images.length < 3) && lastSentType !== 'profile_nudge') {
      const questionsDict = await getQuestionnaireQuestionsDictionary('he');
      const report = await profileFeedbackService.compileFeedbackReport(user.id, 'he', questionsDict);
      await notificationService.sendProfileNudge(user, report.missingProfileItems.slice(0, 3));
      return 'profile_nudge';
    }

    // Condition for AI Insight (Day ~8)
    if (hasAnsweredQuestionnaire && !profileCompletion && lastSentType !== 'ai_insight') {
      const narrativeProfile = await generateNarrativeProfile(user.id);
      if (narrativeProfile) {
        const analysis = await aiService.getProfileAnalysis(narrativeProfile);
        if (analysis) {
          await notificationService.sendAiInsight(user, analysis.personalitySummary);
          return 'ai_insight';
        }
      }
    }
    
    // Add future conditions here...

    return null;
  }
  
  private static getDelayForNextStep(step: number): number | null {
    const delays: { [key: number]: number } = {
      2: 4, // 4 days after welcome
      3: 4, // 4 days after nudge
      4: 6, // 6 days after AI insight
    };
    return delays[step] || null;
  }

  static async startCampaignForNewUser(userId: string) {
    // This function will be called AFTER the existing welcome email is sent.
    // It only schedules the *first drip email*.
    const firstDripDelay = this.getDelayForNextStep(2);
    if (firstDripDelay) {
      await prisma.userDripCampaign.create({
        data: {
          userId: userId,
          currentStep: 2,
          nextSendDate: new Date(Date.now() + firstDripDelay * 24 * 60 * 60 * 1000),
          status: CampaignStatus.ACTIVE,
          lastSentType: 'welcome',
        },
      });
    }
  }

  private static async updateCampaignStatus(campaignId: string, status: CampaignStatus) {
    await prisma.userDripCampaign.update({
      where: { id: campaignId },
      data: { status },
    });
  }
}
--- End of Content for userEngagementService.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\adapters
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\adapters\email.adapter.ts
--------------------------------------------------------------------------------
Content:
// src/lib/engagement/adapters/email.adapter.ts
import nodemailer from 'nodemailer';

export interface RecipientInfo {
  email: string;
  phone?: string | null;
  name: string;
}

export interface NotificationContent {
  subject: string;
  body: string; // For text-based channels like SMS or simple emails
  htmlBody?: string; // For rich HTML emails
}

export class EmailAdapter {
  private transporter: nodemailer.Transporter;

  constructor() {
    this.transporter = nodemailer.createTransport({
      service: process.env.EMAIL_SERVICE || 'gmail',
      auth: {
        user: process.env.GMAIL_USER,
        pass: process.env.GMAIL_APP_PASSWORD,
      },
    });
  }

  public canSend(recipient: RecipientInfo): boolean {
    return !!recipient.email;
  }

  public async send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean> {
    if (!this.canSend(recipient)) return false;

    try {
      await this.transporter.sendMail({
        from: `NeshamaTech <${process.env.GMAIL_USER}>`,
        to: recipient.email,
        subject: content.subject,
        html: content.htmlBody || `<p>${content.body.replace(/\n/g, '<br>')}</p>`,
      });
      console.log(`[EmailAdapter] Email sent to ${recipient.email}`);
      return true;
    } catch (error) {
      console.error(`[EmailAdapter] Failed to send email to ${recipient.email}:`, error);
      return false;
    }
  }
}
--- End of Content for email.adapter.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\adapters\whatsapp.adapter.ts
--------------------------------------------------------------------------------
Content:
// src/lib/engagement/adapters/whatsapp.adapter.ts
import twilio from 'twilio';
import { RecipientInfo } from './email.adapter';

export class WhatsAppAdapter {
  private client: twilio.Twilio | null;
  private fromNumber: string;

  constructor() {
    this.fromNumber = process.env.TWILIO_WHATSAPP_NUMBER || '';
    if (process.env.TWILIO_ACCOUNT_SID && process.env.TWILIO_AUTH_TOKEN) {
      this.client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);
    } else {
      this.client = null;
      console.warn('[WhatsAppAdapter] Twilio is not configured.');
    }
  }

  public canSend(recipient: RecipientInfo): boolean {
    return !!(this.client && recipient.phone && recipient.phone.startsWith('+'));
  }

  public async send(recipient: RecipientInfo, templateSid: string, contentVariables: Record<string, string>): Promise<boolean> {
    if (!this.canSend(recipient) || !recipient.phone) return false;

    try {
      await this.client!.messages.create({
        contentSid: templateSid,
        contentVariables: JSON.stringify(contentVariables),
        from: `whatsapp:${this.fromNumber}`,
        to: `whatsapp:${recipient.phone}`,
      });
      console.log(`[WhatsAppAdapter] Message sent to ${recipient.phone}`);
      return true;
    } catch (error: any) {
      console.error(`[WhatsAppAdapter] Failed to send message to ${recipient.phone}:`, error.message);
      return false;
    }
  }
}
--- End of Content for whatsapp.adapter.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates
================================================================================

(This directory contains subdirectories but no files directly. See subdirectories below.)

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates\email
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates\email\aiInsight.hbs
--------------------------------------------------------------------------------
Content:
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×’×™×œ×™× ×• ××©×”×• ××¢× ×™×™×Ÿ ×¢×œ×™×š</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); direction: rtl;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 20px;">
                <table role="presentation" style="max-width: 600px; width: 100%; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.12); overflow: hidden;">
                    
                    <tr>
                        <td style="background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%); padding: 50px 30px; text-align: center; position: relative;">
                            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ§ âœ¨</div>
                            <h1 style="color: white; margin: 0; font-size: 30px; font-weight: 800; line-height: 1.4; text-shadow: 0 2px 15px rgba(0,0,0,0.15);">
                                {{firstName}}, ×™×© ×œ× ×• ×ª×•×‘× ×•×ª ××¨×ª×§×•×ª ×¢×œ×™×š!
                            </h1>
                            <p style="color: rgba(255,255,255,0.95); margin: 12px 0 0 0; font-size: 16px; font-weight: 500;">
                                ××¢×¨×›×ª ×”-AI ×©×œ× ×• × ×™×ª×—×” ××ª ×”×©××œ×•×Ÿ ×©×œ×š
                            </p>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 40px 30px;">
                            <p style="font-size: 17px; color: #2d3748; margin: 0 0 20px 0; line-height: 1.6;">
                                ×”×™×™ {{firstName}},
                            </p>
                            
                            <p style="font-size: 16px; color: #4a5568; margin: 0 0 25px 0; line-height: 1.7;">
                                ×ª×•×“×” ×©×”×©×§×¢×ª ×–××Ÿ ×œ××œ× ××ª ×”×©××œ×•×Ÿ ×©×œ× ×•! ×”×ª×©×•×‘×•×ª ×©×œ×š ×¢×–×¨×• ×œ××¢×¨×›×ª ×”-AI ×”××ª×§×“××ª ×©×œ× ×• ×œ×”×‘×™×Ÿ ××•×ª×š ×˜×•×‘ ×™×•×ª×¨. ×”× ×” ××” ×©×’×™×œ×™× ×•:
                            </p>

                            <div style="background: linear-gradient(135deg, #ede9fe 0%, #fce7f3 100%); border-radius: 20px; padding: 32px; margin: 28px 0; border: 2px solid rgba(139, 92, 246, 0.2); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.1);">
                                <div style="display: flex; align-items: center; margin-bottom: 18px;">
                                    <span style="font-size: 36px; margin-left: 15px;">ğŸ¯</span>
                                    <h2 style="color: transparent; background: linear-gradient(135deg, #8b5cf6, #ec4899); -webkit-background-clip: text; background-clip: text; margin: 0; font-size: 22px; font-weight: 800;">
                                        ×”×ª×•×‘× ×•×ª ×©×œ× ×• ×¢×œ×™×š:
                                    </h2>
                                </div>
                                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.06);">
                                    <p style="color: #1e293b; margin: 0; font-size: 17px; line-height: 1.8; white-space: pre-wrap; font-weight: 500;">{{personalitySummary}}</p>
                                </div>
                            </div>

                            <div style="background: #f7fafc; border-radius: 12px; padding: 25px; margin: 25px 0;">
                                <h3 style="color: #2d3748; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">
                                    ğŸŒŸ ×œ××” ×–×” ×—×©×•×‘?
                                </h3>
                                <p style="color: #4a5568; margin: 0 0 12px 0; font-size: 15px; line-height: 1.7;">
                                    <strong>âœ“ ×”×ª×××” ××“×•×™×§×ª ×™×•×ª×¨:</strong> ×”×©×“×›× ×™× ×©×œ× ×• ××©×ª××©×™× ×‘×ª×•×‘× ×•×ª ×”××œ×” ×›×“×™ ×œ××¦×•× ×œ×š ×”×ª×××•×ª ×©××ª××™××•×ª ×‘×××ª ×œ××™ ×©××ª×”.
                                </p>
                                <p style="color: #4a5568; margin: 0 0 12px 0; font-size: 15px; line-height: 1.7;">
                                    <strong>âœ“ ×”×‘× ×” ××¢××™×§×”:</strong> ×× ×—× ×• ×œ× ×¨×§ ××¡×ª×›×œ×™× ×¢×œ "×’×•×‘×”" ×•"×¢×™×¡×•×§" - ×× ×—× ×• ××‘×™× ×™× ××ª ×”×¢×¨×›×™×, ×”××™×©×™×•×ª ×•×”×—×œ×•××•×ª ×©×œ×š.
                                </p>
                                <p style="color: #4a5568; margin: 0; font-size: 15px; line-height: 1.7;">
                                    <strong>âœ“ ×©×™×—×•×ª ×˜×•×‘×•×ª ×™×•×ª×¨:</strong> ×”×”×ª×××•×ª ×©×œ×š ×™×›×™×¨×• ××•×ª×š ×˜×•×‘ ×™×•×ª×¨ ×›×‘×¨ ××”×”×ª×—×œ×”.
                                </p>
                            </div>

                            <table role="presentation" style="margin: 35px 0;">
                                <tr>
                                    <td style="text-align: center;">
                                        <a href="{{baseUrl}}/profile" style="display: inline-block; background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%); color: white; text-decoration: none; padding: 18px 48px; border-radius: 50px; font-weight: 700; font-size: 17px; box-shadow: 0 10px 30px rgba(6, 182, 212, 0.3);">
                                            ×œ×¦×¤×™×™×” ×‘×¤×¨×•×¤×™×œ ×”××œ× ×©×œ×™ ğŸ¯
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="font-size: 14px; color: #718096; margin: 25px 0 0 0; line-height: 1.6; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                                <strong>×©××œ×•×ª ××• ×¨×•×¦×” ×œ×“×‘×¨ ×¢× ×©×“×›×Ÿ?</strong><br>
                                ×¤×©×•×˜ ×ª×©×™×‘ ×œ××™×™×œ ×”×–×” ×•× ×—×–×•×¨ ××œ×™×š ×‘×”×§×“×!
                            </p>
                        </td>
                    </tr>

                    <tr>
                        <td style="background: #f7fafc; padding: 25px 30px; text-align: center; border-top: 1px solid #e2e8f0;">
                            <p style="margin: 0 0 10px 0; color: #4a5568; font-size: 14px;">
                                ××—×›×™× ×œ×¨××•×ª ×œ××Ÿ ×–×” ××•×‘×™×œ!
                            </p>
                            <p style="margin: 0; color: #a0aec0; font-size: 13px;">
                                ×‘×‘×¨×›×”,<br>×¦×•×•×ª NeshamaTech
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
--- End of Content for aiInsight.hbs ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates\email\profileNudge.hbs
--------------------------------------------------------------------------------
Content:
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×™×¤ ×§×˜×Ÿ ×©×™×¢×©×” ×”×‘×“×œ ×’×“×•×œ</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ecfeff 0%, #fce7f3 100%); direction: rtl;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 20px;">
                <table role="presentation" style="max-width: 600px; width: 100%; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.12); overflow: hidden; border: 1px solid rgba(255,255,255,0.7);">
                    
                    <tr>
                        <td style="background: linear-gradient(135deg, #ec4899 0%, #f97316 100%); padding: 45px 30px; text-align: center; position: relative;">
                            <div style="font-size: 56px; margin-bottom: 15px;">ğŸ’¡</div>
                            <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                                {{firstName}}, ×™×© ×›××Ÿ ×›××” ×“×‘×¨×™× ×©×—×¡×¨×™×...
                            </h1>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 40px 30px;">
                            <p style="font-size: 17px; color: #2d3748; margin: 0 0 20px 0; line-height: 1.6;">
                                ×©×œ×•× {{firstName}},
                            </p>
                            
                            <p style="font-size: 16px; color: #4a5568; margin: 0 0 25px 0; line-height: 1.7;">
                                ×©×× ×• ×œ×‘ ×©×”×¤×¨×•×¤×™×œ ×©×œ×š ×¢×“×™×™×Ÿ ×œ× ××•×©×œ× ×œ×’××¨×™. ×× ×—× ×• ×™×•×“×¢×™× ×©×–×” ×œ×•×§×— ×–××Ÿ, ××‘×œ ×™×© ×œ× ×• × ×ª×•×Ÿ ××¢× ×™×™×Ÿ ×œ×©×ª×£ ××ª×š:
                            </p>

                            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%); border-right: 4px solid #ec4899; border-radius: 16px; padding: 24px; margin: 28px 0; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.1);">
                                <p style="color: #be123c; margin: 0; font-size: 16px; line-height: 1.8; font-weight: 600;">
                                    <strong style="font-size: 20px; display: block; margin-bottom: 8px;">ğŸ“Š × ×ª×•×Ÿ ×©×•×•×” ×œ×“×¢×ª:</strong>
                                    ×¤×¨×•×¤×™×œ×™× ××œ××™× ×¢× ×ª××•× ×•×ª ××™×›×•×ª×™×•×ª ××§×‘×œ×™× <strong style="font-size: 20px; background: linear-gradient(135deg, #ec4899, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">×¤×™ 3 ×™×•×ª×¨</strong> ×”×¦×¢×•×ª ×”×ª×××” ××¤×¨×•×¤×™×œ×™× ×—×œ×§×™×™×!
                                </p>
                            </div>

                            <h2 style="color: #2d3748; margin: 30px 0 20px 0; font-size: 20px; font-weight: 600;">
                                ×”× ×” ××” ×©×—×¡×¨ ×‘×¤×¨×•×¤×™×œ ×©×œ×š:
                            </h2>

                            <div style="background: #f7fafc; border-radius: 12px; padding: 25px; margin: 20px 0;">
                                {{#each missingItems}}
                                <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                                    <span style="color: #f56565; font-size: 20px; margin-left: 10px; flex-shrink: 0;">âœ—</span>
                                    <p style="color: #4a5568; margin: 0; line-height: 1.6; font-size: 15px;">{{this}}</p>
                                </div>
                                {{/each}}
                            </div>

                            <p style="font-size: 16px; color: #4a5568; margin: 25px 0; line-height: 1.7;">
                                ×× ×—× ×• ××‘×˜×™×—×™× ×©×–×” ×œ× ×™×™×§×— ×™×•×ª×¨ ×-<strong>10 ×“×§×•×ª</strong>! ×•×–×” ×™×›×•×œ ×œ×¢×©×•×ª ××ª ×›×œ ×”×”×‘×“×œ ×‘×”×¦×œ×—×” ×©×œ×š ×œ××¦×•× ××ª ×”×”×ª×××” ×”××•×©×œ××ª.
                            </p>

                            <table role="presentation" style="margin: 35px 0;">
                                <tr>
                                    <td style="text-align: center;">
                                        <a href="{{baseUrl}}/profile" style="display: inline-block; background: linear-gradient(135deg, #ec4899 0%, #f97316 100%); color: white; text-decoration: none; padding: 18px 48px; border-radius: 50px; font-weight: 700; font-size: 17px; box-shadow: 0 10px 30px rgba(236, 72, 153, 0.35);">
                                            ×‘×•× × ×©×œ×™× ××ª ×–×” ×ª×•×š 10 ×“×§×•×ª ğŸš€
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="font-size: 14px; color: #718096; margin: 25px 0 0 0; line-height: 1.6; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                                ×¦×¨×™×š ×¢×–×¨×” ××• ×™×© ×©××œ×•×ª? ×¤×©×•×˜ ×ª×©×™×‘ ×œ××™×™×œ ×”×–×” - ×× ×—× ×• ×›××Ÿ ×‘×©×‘×™×œ×š!
                            </p>
                        </td>
                    </tr>

                    <tr>
                        <td style="background: #f7fafc; padding: 25px 30px; text-align: center; border-top: 1px solid #e2e8f0;">
                            <p style="margin: 0 0 5px 0; color: #718096; font-size: 14px;">
                                ××××™× ×™× ×‘×š! â¤ï¸
                            </p>
                            <p style="margin: 0; color: #a0aec0; font-size: 13px;">
                                ×¦×•×•×ª NeshamaTech
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
--- End of Content for profileNudge.hbs ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates\email\welcome.hbs
--------------------------------------------------------------------------------
Content:
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×¨×•×›×™× ×”×‘××™× ×œ-NeshamaTech</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); direction: rtl;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 20px;">
                <table role="presentation" style="max-width: 600px; width: 100%; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.5); overflow: hidden;">
                    <!-- Header with gradient matching site -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #06b6d4 0%, #ec4899 100%); padding: 50px 30px; text-align: center; position: relative;">
                            <div style="position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius: 50%; filter: blur(20px);"></div>
                            <h1 style="color: white; margin: 0; font-size: 32px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                ğŸ‰ ×‘×¨×•×š ×”×‘× ×œ-NeshamaTech!
                            </h1>
                            <p style="color: rgba(255,255,255,0.95); margin: 12px 0 0 0; font-size: 17px; font-weight: 500;">
                                ×”××¡×¢ ×©×œ×š ×œ×”×ª×××” ××•×©×œ××ª ××ª×—×™×œ ×›××Ÿ
                            </p>
                        </td>
                    </tr>
                    
                    <!-- Main Content -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <p style="font-size: 18px; color: #2d3748; margin: 0 0 20px 0; line-height: 1.6;">
                                ×©×œ×•× {{firstName}},
                            </p>
                            
                            <p style="font-size: 16px; color: #4a5568; margin: 0 0 20px 0; line-height: 1.7;">
                                ×›××” ××¨×’×©! ×”×¦×˜×¨×¤×ª ×œ××©×¤×—×ª NeshamaTech - ××¢×¨×›×ª ×”×©×™×“×•×›×™× ×”×—×›××” ×©××©×œ×‘×ª ×˜×›× ×•×œ×•×’×™×” ××ª×§×“××ª ×¢× ×”×‘×™× ×” ×•×”×—×•× ×”×× ×•×©×™×™× ×©×œ ×©×“×›× ×™× ××§×¦×•×¢×™×™×.
                            </p>

                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%); border-radius: 12px; padding: 25px; margin: 25px 0;">
                                <h2 style="color: #5a67d8; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
                                    ğŸ’¡ ××” ×”×œ××”?
                                </h2>
                                <ul style="color: #4a5568; margin: 0; padding-right: 20px; line-height: 1.8;">
                                    <li style="margin-bottom: 10px;">
                                        <strong>×”×©×œ× ××ª ×”×¤×¨×•×¤×™×œ ×©×œ×š</strong> - ×›×›×œ ×©× ×“×¢ ××•×ª×š ×™×•×ª×¨, ×›×š × ×•×›×œ ×œ××¦×•× ×œ×š ×”×ª×××” ×˜×•×‘×” ×™×•×ª×¨
                                    </li>
                                    <li style="margin-bottom: 10px;">
                                        <strong>×”×•×¡×£ ×ª××•× ×•×ª</strong> - ×ª××•× ×” ×©×•×•×” ××œ×£ ××™×œ×™×, ×•-3 ×ª××•× ×•×ª? ×–×” ×”×¨×‘×” ×™×•×ª×¨!
                                    </li>
                                    <li style="margin-bottom: 10px;">
                                        <strong>××œ× ××ª ×”×©××œ×•×Ÿ</strong> - ×–×” ×¢×•×–×¨ ×œ× ×• ×œ×”×‘×™×Ÿ ××™ ××ª×” ×‘×××ª ×•××” ×—×©×•×‘ ×œ×š
                                    </li>
                                </ul>
                            </div>

                            <p style="font-size: 16px; color: #4a5568; margin: 20px 0; line-height: 1.7;">
                                <strong>×˜×™×¤ ×—×©×•×‘:</strong> ×¤×¨×•×¤×™×œ×™× ××œ××™× ×¢× ×ª××•× ×•×ª ××™×›×•×ª×™×•×ª ××§×‘×œ×™× ×¤×™ 3 ×™×•×ª×¨ ×”×ª×××•×ª! ××– ×›×“××™ ×œ×”×©×§×™×¢ ×›××” ×“×§×•×ª ×¢×›×©×™×•.
                            </p>

                            <!-- CTA Button -->
                            <table role="presentation" style="margin: 30px 0;">
                                <tr>
                                    <td style="text-align: center;">
                                        <a href="{{baseUrl}}/profile" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 16px 40px; border-radius: 50px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s;">
                                            ×œ×”×©×œ××ª ×”×¤×¨×•×¤×™×œ ×©×œ×™
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="font-size: 15px; color: #718096; margin: 25px 0 0 0; line-height: 1.6; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                                ×™×© ×©××œ×•×ª? ×× ×—× ×• ×›××Ÿ ×‘×©×‘×™×œ×š! ×¤×©×•×˜ ×ª×©×™×‘ ×œ××™×™×œ ×”×–×” ×•× ×—×–×•×¨ ××œ×™×š ×‘×”×§×“×.
                            </p>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="background: #f7fafc; padding: 25px 30px; text-align: center; border-top: 1px solid #e2e8f0;">
                            <p style="margin: 0 0 10px 0; color: #718096; font-size: 14px;">
                                ×‘×”×¦×œ×—×” ×‘××¡×¢ ×©×œ×š! ğŸ’™
                            </p>
                            <p style="margin: 0; color: #a0aec0; font-size: 13px;">
                                ×¦×•×•×ª NeshamaTech
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
--- End of Content for welcome.hbs ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\lib\engagement\templates\whatsapp
================================================================================

(This directory is empty.)

