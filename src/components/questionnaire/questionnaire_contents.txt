################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire
# Generated on: 2026-02-25 16:08:51
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\MatchmakingQuestionnaire.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/MatchmakingQuestionnaire.tsx
'use client';

import React, {
  useState,
  useMemo,
  useEffect,
  useCallback,
  useRef,
} from 'react';
import { useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import QuestionnaireLayout from './layout/QuestionnaireLayout';
import WorldComponent from './worlds/WorldComponent';
import QuestionnaireCompletion from './common/QuestionnaireCompletion';
import QuestionnaireLandingPage from './pages/QuestionnaireLandingPage';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { cn } from '@/lib/utils';
import WorldsMap from './layout/WorldsMap';
import { useIdleTimeout } from './hooks/useIdleTimeout';
import { signOut } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useQuestionnaireState } from '@/app/[locale]/contexts/QuestionnaireStateContext';

import {
  Loader2,
  CheckCircle,
  AlertTriangle,
  XCircle,
  Info,
  Clock,
  LogOut,
  Sparkles,
  AlertCircle,
  Zap,
} from 'lucide-react';
import type {
  WorldId,
  QuestionnaireSubmission,
  QuestionnaireAnswer,
  AnswerValue,
  Question,
} from './types/types';
import type { QuestionnaireDictionary } from '@/types/dictionary';

import { personalityQuestions } from './questions/personality/personalityQuestions';
import { valuesQuestions } from './questions/values/valuesQuestions';
import { relationshipQuestions } from './questions/relationship/relationshipQuestions';
import { partnerQuestions } from './questions/partner/partnerQuestions';
import { religionQuestions } from './questions/religion/religionQuestions';

const worldConfig: Record<WorldId, { questions: Question[] }> = {
  PERSONALITY: { questions: personalityQuestions },
  VALUES: { questions: valuesQuestions },
  RELATIONSHIP: { questions: relationshipQuestions },
  PARTNER: { questions: partnerQuestions },
  RELIGION: { questions: religionQuestions },
};

enum OnboardingStep {
  LANDING = 'LANDING',
  MAP = 'MAP',
  WORLDS = 'WORLDS',
  COMPLETED = 'COMPLETED',
}

const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

export interface MatchmakingQuestionnaireProps {
  userId?: string;
  onComplete?: () => void;
  initialWorld?: WorldId;
  initialQuestionId?: string;
  dict: QuestionnaireDictionary;
  locale: 'he' | 'en';
}

export default function MatchmakingQuestionnaire({
  userId,
  onComplete,
  initialWorld,
  initialQuestionId,
  dict,
  locale,
}: MatchmakingQuestionnaireProps) {
  console.log(
    `%c[MatchmakingQuestionnaire] ðŸš€ Initializing | User: ${userId ? 'Authenticated' : 'Guest'} | World: ${initialWorld || 'None'} | Question: ${initialQuestionId || 'None'}`,
    'color: #0d9488; font-weight: bold; font-size: 14px;'
  );

  const router = useRouter();
  const sessionId = useMemo(() => `session_${Date.now()}`, []);

  // Check for saved progress
  const hasSavedProgress = useMemo(() => {
    if (typeof window === 'undefined') return false;
    const saved = localStorage.getItem('tempQuestionnaire');
    return !!saved;
  }, []);

  const [currentStep, setCurrentStep] = useState<OnboardingStep>(
    initialWorld ? OnboardingStep.WORLDS : OnboardingStep.LANDING
  );
  const [currentWorld, setCurrentWorld] = useState<WorldId>(
    initialWorld || 'PERSONALITY'
  );
  const [answers, setAnswers] = useState<QuestionnaireAnswer[]>([]);
  const [completedWorlds, setCompletedWorlds] = useState<WorldId[]>([]);
  const [startTime] = useState(() => new Date().toISOString());
  const [lastSavedTime, setLastSavedTime] = useState<Date | null>(null);
  const [isDirectNavigation, setIsDirectNavigation] = useState(false);
  const [currentQuestionIndices, setCurrentQuestionIndices] = useState<
    Record<WorldId, number>
  >({
    PERSONALITY: 0,
    VALUES: 0,
    RELATIONSHIP: 0,
    PARTNER: 0,
    RELIGION: 0,
  });

  const [isSaving, setIsSaving] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isDirty, setIsDirty] = useState(false);
  const { setIsDirty: setGlobalDirty, setSaveHandler } =
    useQuestionnaireState();

  const [toastState, setToastState] = useState<{
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';
    isVisible: boolean;
    action?: { label: string; onClick: () => void };
  }>({
    message: '',
    type: 'info',
    isVisible: false,
  });

  const [showIdleModal, setShowIdleModal] = useState(false);
  const logoutTimer = useRef<NodeJS.Timeout | null>(null);

  // Idle timeout handler
  const handleIdle = useCallback(() => {
    if (userId) {
      console.log(
        '%c[MatchmakingQuestionnaire] â° User idle detected',
        'color: #f97316; font-weight: bold;'
      );
      setShowIdleModal(true);
      logoutTimer.current = setTimeout(() => {
        signOut({ callbackUrl: '/' });
      }, 60000);
    }
  }, [userId]);

  const { resetTimer: resetIdleTimer } = useIdleTimeout({
    onIdle: handleIdle,
    idleTimeSeconds: 7200,
  });

  const handleStayActive = useCallback(() => {
    if (logoutTimer.current) {
      clearTimeout(logoutTimer.current);
    }
    setShowIdleModal(false);
    resetIdleTimer();
    console.log(
      '%c[MatchmakingQuestionnaire] âœ… User stayed active',
      'color: #0d9488; font-weight: bold;'
    );
  }, [resetIdleTimer]);
  // --- ×”×•×¡×¤×”: ×ž× ×™×¢×ª ×™×¦×™××” ×× ×™×© ×©×™× ×•×™×™× ×œ× ×©×ž×•×¨×™× ---
  useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        // ×“×¤×“×¤× ×™× ×ž×•×“×¨× ×™×™× ×“×•×¨×©×™× ××ª ×”×©×•×¨×•×ª ×”××œ×• ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×”×•×“×¢×” ×”×’× ×¨×™×ª
        e.preventDefault();
        e.returnValue = '';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [isDirty]);
  // --------------------------------------------------
  // Sync isDirty state globally
  // ×ž×©×ª× ×” ×¢×–×¨ ×›×“×™ ×œ×–×›×•×¨ ×ž×ª×™ ×”×§×¤×¦× ×• ×œ××—×¨×•× ×”, ×›×“×™ ×œ× ×œ×”×§×¤×™×¥ ×¤×¢×ž×™×™× ×¢×œ ××•×ª×” ×©××œ×” ×‘×˜×¢×•×ª
  const lastReminderCount = useRef(0);

  // Handle initial world
  useEffect(() => {
    if (initialWorld) {
      setCurrentWorld(initialWorld);
    }
  }, [initialWorld]);

  // Enhanced toast notification system
  const showToast = useCallback(
    (
      message: string,
      type: 'success' | 'error' | 'info' | 'warning' = 'info',
      duration: number = 3000,
      action?: { label: string; onClick: () => void }
    ) => {
      console.log(
        `%c[Toast] ${type.toUpperCase()}: ${message}`,
        'color: #6366f1; font-weight: bold;'
      );
      setToastState({ message, type, isVisible: true, action });
      if (!action) {
        setTimeout(() => {
          setToastState((prev) => ({ ...prev, isVisible: false }));
        }, duration);
      }
    },
    []
  );

  // Get next world in sequence
  const getNextWorld = (currentWorldId: WorldId): WorldId | null => {
    const currentIndex = WORLD_ORDER.indexOf(currentWorldId);
    if (currentIndex < WORLD_ORDER.length - 1) {
      return WORLD_ORDER[currentIndex + 1];
    }
    return null;
  };

  // Prepare submission data
  const prepareSubmissionData = useCallback((): QuestionnaireSubmission => {
    const isCompleted = completedWorlds.length === WORLD_ORDER.length;
    return {
      userId: userId || sessionId,
      answers: answers,
      worldsCompleted: completedWorlds,
      completed: isCompleted,
      startedAt: startTime,
      completedAt: isCompleted ? new Date().toISOString() : undefined,
      currentQuestionIndices: currentQuestionIndices,
    };
  }, [
    answers,
    completedWorlds,
    sessionId,
    startTime,
    userId,
    currentQuestionIndices,
  ]);

  // Enhanced save handler with better feedback
  const handleQuestionnaireSave = useCallback(
    async (isAutoSave = false) => {
      if (isSaving && !isAutoSave) return;

      console.log(
        `%c[Save] ${isAutoSave ? 'ðŸ’¾ Auto-saving' : 'ðŸ–±ï¸ Manual save'} | Answers: ${answers.length} | Completed: ${completedWorlds.length}/${WORLD_ORDER.length}`,
        'color: #f97316; font-weight: bold;'
      );

      setIsSaving(true);
      setError(null);

      try {
        const submissionData = prepareSubmissionData();

        // Validation
        const validateSubmission = (data: QuestionnaireSubmission): boolean => {
          if (!data.userId) return false;
          if (!Array.isArray(data.worldsCompleted)) return false;
          if (typeof data.completed !== 'boolean') return false;
          if (!data.startedAt) return false;
          if (data.completed && !data.completedAt) return false;
          return true;
        };

        if (!validateSubmission(submissionData)) {
          throw new Error(dict.matchmaking.errors.invalidSubmission);
        }

        // Save logic
        if (!userId) {
          // Guest user - save to localStorage

          if (answers.length === 0 && completedWorlds.length === 0) {
            console.log('Skipping save for guest - empty data');
            setIsSaving(false);
            return;
          }
          localStorage.setItem(
            'tempQuestionnaire',
            JSON.stringify(submissionData)
          );
          console.log(
            '%c[Save] âœ… Saved to localStorage (guest user)',
            'color: #0d9488; font-weight: bold;'
          );

          if (currentStep === OnboardingStep.COMPLETED) {
            router.push('/auth/signin?callbackUrl=/questionnaire/restore');
          }
        } else {
          // Authenticated user - save to backend
          const response = await fetch('/api/questionnaire', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submissionData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || dict.matchmaking.errors.saveFailed
            );
          }

          console.log(
            '%c[Save] âœ… Saved to backend (authenticated user)',
            'color: #0d9488; font-weight: bold;'
          );
        }

        setLastSavedTime(new Date());
        setIsDirty(false);
        setToastState((prev) => ({ ...prev, isVisible: false }));

        if (!isAutoSave) {
          showToast(dict.matchmaking.toasts.saveSuccess, 'success', 2000);
        }
      } catch (err) {
        console.error(
          '%c[Save] âŒ Save failed:',
          'color: #f43f5e; font-weight: bold;',
          err
        );
        const errorMessage =
          err instanceof Error
            ? err.message
            : dict.matchmaking.errors.saveFailed;
        setError(errorMessage);
        showToast(errorMessage, 'error', 5000);
      } finally {
        setIsSaving(false);
      }
    },
    [
      isSaving,
      prepareSubmissionData,
      userId,
      currentStep,
      router,
      dict.matchmaking.errors,
      dict.matchmaking.toasts,
      showToast,
      answers.length,
      completedWorlds.length,
    ]
  );

  useEffect(() => {
    setSaveHandler(() => handleQuestionnaireSave(false));
  }, [handleQuestionnaireSave, setSaveHandler]);
  useEffect(() => {
    // 1. ×× ×”×ž×©×ª×ž×© ×ž×—×•×‘×¨ - ×œ× ×¢×•×©×™× ×›×œ×•×
    if (userId) return;

    // 2. ×—×™×©×•×‘ ×ž×¡×¤×¨ ×”×ª×©×•×‘×•×ª
    const answerCount = answers.length;

    // 3. ×ª× ××™× ×œ×”×§×¤×¦×ª ×”×”×•×“×¢×”:
    // - ×™×© ×ª×©×•×‘×•×ª
    // - ×–×” ×›×¤×•×œ×” ×©×œ 5 (×©××œ×” 5, 10, 15...)
    // - ×œ× ×”×§×¤×¦× ×• ×›×‘×¨ ×¢×‘×•×¨ ×”×ž×¡×¤×¨ ×”×–×” (×ž×•× ×¢ ×›×¤×™×œ×•×™×•×ª ×‘×¨×™× ×“×•×¨)
    if (
      answerCount > 0 &&
      answerCount % 5 === 0 &&
      answerCount !== lastReminderCount.current
    ) {
      lastReminderCount.current = answerCount;

      showToast(
        '×©×ž× ×• ×œ×‘ ×©××ª/×” ×ž×©×§×™×¢/×”! ðŸ’¡ ×›×“××™ ×œ×”×ª×—×‘×¨ ×›×“×™ ×©×”×ª×©×•×‘×•×ª ×™×™×©×ž×¨×• ×‘×©×¨×ª ×•×œ× ×™××‘×“×• ×× ×”×“×¤×“×¤×Ÿ ×™×™×¡×’×¨.',
        'warning', // ×¦×‘×¢ ×›×ª×•× ×‘×•×œ×˜
        6000, // ×–×ž×Ÿ ×ª×¦×•×’×” ××¨×•×š ×™×•×ª×¨ (6 ×©× ×™×•×ª)
        {
          label: '×”×ª×—×‘×¨×•×ª ×œ×©×ž×™×¨×”',
          onClick: () => {
            // ×©×ž×™×¨×” ×–×ž× ×™×ª ×œ×¤× ×™ ×”×ž×¢×‘×¨
            handleQuestionnaireSave(true);
            router.push('/auth/register?callbackUrl=/questionnaire/restore');
          },
        }
      );
    }
  }, [answers.length, userId, showToast, router, handleQuestionnaireSave]);
  useEffect(() => {
    setGlobalDirty(isDirty);
  }, [isDirty, setGlobalDirty]);
  // Load saved progress
  useEffect(() => {
    const loadProgress = async () => {
      console.log(
        '%c[Load] ðŸ“‚ Loading progress...',
        'color: #0d9488; font-weight: bold;'
      );
      setIsLoading(true);
      setError(null);

      try {
        if (!userId) {
          // Guest user - load from localStorage
          const saved = localStorage.getItem('tempQuestionnaire');
          if (saved) {
            const loadedData = JSON.parse(saved);
            console.log(
              '%c[Load] âœ… Loaded from localStorage',
              'color: #0d9488; font-weight: bold;',
              loadedData
            );
            setAnswers(loadedData.answers || []);
            setCompletedWorlds(loadedData.worldsCompleted || []);

            setCurrentQuestionIndices((prevIndices) => ({
              ...prevIndices,
              ...(loadedData.currentQuestionIndices || {}),
            }));

            if ((loadedData.answers || []).length > 0) {
              setCurrentStep(OnboardingStep.MAP);
            }
          } else {
            console.log(
              '%c[Load] â„¹ï¸ No saved progress found for guest',
              'color: #6b7280; font-weight: bold;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          }
          setIsLoading(false);
          return;
        }

        // Authenticated user - load from server
        const response = await fetch('/api/questionnaire');

        if (!response.ok) {
          if (response.status === 404) {
            console.log(
              '%c[Load] â„¹ï¸ No existing questionnaire data found for user. Starting fresh.',
              'color: #6b7280;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          } else {
            const errorData = await response.json();
            throw new Error(
              errorData.error || dict.matchmaking.errors.loadFailed
            );
          }
        } else {
          const apiResponse = await response.json();
          console.log(
            '%c[Load] âœ… Loaded from backend',
            'color: #0d9488; font-weight: bold;',
            apiResponse
          );

          if (apiResponse.success && apiResponse.data) {
            const loadedData = apiResponse.data;

            const allAnswers = [
              ...(loadedData.answers || []),
              ...(loadedData.valuesAnswers || []),
              ...(loadedData.personalityAnswers || []),
              ...(loadedData.relationshipAnswers || []),
              ...(loadedData.partnerAnswers || []),
              ...(loadedData.religionAnswers || []),
            ].filter(
              (answer, index, self) =>
                index ===
                self.findIndex((a) => a.questionId === answer.questionId)
            );

            setAnswers(allAnswers);
            const loadedCompletedWorlds = loadedData.worldsCompleted || [];
            setCompletedWorlds(loadedCompletedWorlds);

            if (
              loadedData.currentQuestionIndices &&
              typeof loadedData.currentQuestionIndices === 'object'
            ) {
              setCurrentQuestionIndices((prev) => ({
                ...prev,
                ...loadedData.currentQuestionIndices,
              }));
            }

            const isQuestionnaireComplete =
              loadedData.completed ||
              loadedCompletedWorlds.length === WORLD_ORDER.length;

            if (initialWorld && initialQuestionId) {
              const worldQuestions = worldConfig[initialWorld].questions;
              const questionIndex = worldQuestions.findIndex(
                (q) => q.id === initialQuestionId
              );
              if (questionIndex !== -1) {
                setCurrentQuestionIndices((prev) => ({
                  ...prev,
                  [initialWorld]: questionIndex,
                }));
                setCurrentWorld(initialWorld);
                setCurrentStep(OnboardingStep.WORLDS);
                setIsDirectNavigation(true);
              } else {
                setCurrentStep(OnboardingStep.MAP);
              }
            } else if (isQuestionnaireComplete) {
              setCurrentStep(OnboardingStep.MAP);
            } else if (allAnswers.length > 0) {
              const worldToResume =
                WORLD_ORDER.find(
                  (world) => !loadedCompletedWorlds.includes(world)
                ) || WORLD_ORDER[0];
              setCurrentWorld(worldToResume);
              setCurrentStep(OnboardingStep.WORLDS);
              console.log(
                `%c[Load]  resuming questionnaire at world: ${worldToResume}.`,
                'color: #28a745; font-weight: bold;'
              );
            } else {
              setCurrentStep(OnboardingStep.LANDING);
            }
          } else {
            console.log(
              '%c[Load] API response indicates no existing data. Starting from LANDING.',
              'color: #f44336;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          }
        }
      } catch (err) {
        console.error(
          '%c[Load] âŒ Load failed:',
          'color: #f43f5e; font-weight: bold;',
          err
        );
        const errorMessage =
          err instanceof Error
            ? err.message
            : dict.matchmaking.errors.loadFailed;
        setError(errorMessage);
        showToast(errorMessage, 'error', 5000);
        setCurrentStep(OnboardingStep.LANDING);
      } finally {
        setIsLoading(false);
      }
    };

    loadProgress();
  }, [
    userId,
    initialWorld,
    initialQuestionId,
    dict.matchmaking.errors,
    showToast,
  ]);

  // Answer handler
  const handleAnswer = useCallback(
    (worldId: WorldId, questionId: string, value: AnswerValue) => {
      console.log(
        `%c[Answer] ðŸ“ ${worldId} | ${questionId}`,
        'color: #06b6d4; font-weight: bold;'
      );

      setAnswers((prev) => {
        const existingIndex = prev.findIndex(
          (a) => a.worldId === worldId && a.questionId === questionId
        );
        const newAnswer: QuestionnaireAnswer = {
          worldId,
          questionId,
          value,
          answeredAt: new Date().toISOString(),
        };

        if (existingIndex >= 0) {
          const updated = [...prev];
          updated[existingIndex] = newAnswer;
          return updated;
        }
        return [...prev, newAnswer];
      });

      setIsDirty(true);
    },
    []
  );

  // Visibility change handler
  const handleVisibilityChange = useCallback(
    (worldId: WorldId, questionId: string, isVisible: boolean) => {
      console.log(
        `%c[Visibility] ${isVisible ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'} ${worldId} | ${questionId}`,
        'color: #f97316;'
      );

      setAnswers((prev) => {
        const existingIndex = prev.findIndex(
          (a) => a.worldId === worldId && a.questionId === questionId
        );

        if (existingIndex >= 0) {
          const updated = [...prev];
          updated[existingIndex] = {
            ...updated[existingIndex],
            isVisible: isVisible,
          };
          return updated;
        }

        const newAnswer: QuestionnaireAnswer = {
          worldId,
          questionId,
          value: undefined,
          answeredAt: new Date().toISOString(),
          isVisible: isVisible,
        };
        return [...prev, newAnswer];
      });

      setIsDirty(true);
    },
    []
  );

  // World change handler
  const handleWorldChange = useCallback((worldId: WorldId) => {
    console.log(
      `%c[Navigation] ðŸ—ºï¸ Changing to world: ${worldId}`,
      'color: #ec4899; font-weight: bold;'
    );
    setCurrentWorld(worldId);
    setCurrentStep(OnboardingStep.WORLDS);
    setIsDirectNavigation(true);
  }, []);

  // World completion handler
  const handleWorldComplete = useCallback(
    async (worldId: WorldId) => {
      console.log(
        `%c[Complete] âœ¨ World completed: ${worldId}`,
        'color: #0d9488; font-weight: bold;'
      );

      if (!completedWorlds.includes(worldId)) {
        const updatedCompleted = [...completedWorlds, worldId];
        setCompletedWorlds(updatedCompleted);

        await handleQuestionnaireSave(true);

        const nextWorld = getNextWorld(worldId);
        if (nextWorld) {
          showToast(
            dict.matchmaking.toasts.worldFinished.replace(
              '{{worldName}}',
              dict.matchmaking.worldLabels[worldId]
            ),
            'success',
            4000,
            {
              label: dict.matchmaking.toasts.nextWorldAction.replace(
                '{{name}}',
                dict.matchmaking.worldLabels[nextWorld]
              ),
              onClick: () => {
                setCurrentWorld(nextWorld);
                setIsDirectNavigation(false);
              },
            }
          );
        } else {
          console.log(
            '%c[Complete] ðŸ† ALL WORLDS COMPLETED!',
            'color: #fbbf24; font-weight: bold; font-size: 16px;'
          );
          showToast(dict.matchmaking.toasts.allWorldsFinished, 'success', 3000);
          setCurrentStep(OnboardingStep.COMPLETED);
        }
      }
    },
    [
      completedWorlds,
      handleQuestionnaireSave,
      showToast,
      dict.matchmaking.worldLabels,
      dict.matchmaking.toasts,
    ]
  );

  // Exit handler
  const handleExit = useCallback(() => {
    console.log(
      '%c[Navigation] ðŸ”™ Exiting to map',
      'color: #6b7280; font-weight: bold;'
    );
    setCurrentStep(OnboardingStep.MAP);
  }, []);

  // Start questionnaire handler
  const handleStartQuestionnaire = useCallback(() => {
    console.log(
      '%c[Start] ðŸš€ Starting questionnaire',
      'color: #0d9488; font-weight: bold;'
    );

    if (hasSavedProgress && completedWorlds.length > 0) {
      setCurrentStep(OnboardingStep.MAP);
    } else {
      setCurrentWorld('PERSONALITY');
      setCurrentStep(OnboardingStep.WORLDS);
    }
  }, [hasSavedProgress, completedWorlds.length]);

  // Render current world
  const renderCurrentWorld = useCallback(() => {
    const worldProps = {
      onAnswer: handleAnswer,
      onVisibilityChange: handleVisibilityChange,
      onComplete: () => handleWorldComplete(currentWorld),
      onBack: handleExit,
      answers: answers.filter((a) => a.worldId === currentWorld),
      isCompleted: completedWorlds.includes(currentWorld),
      currentQuestionIndex: currentQuestionIndices[currentWorld],
      setCurrentQuestionIndex: (index: number) => {
        setCurrentQuestionIndices((prev) => ({
          ...prev,
          [currentWorld]: index,
        }));
      },
      onSave: (isAutoSave = false) => handleQuestionnaireSave(isAutoSave),
      isSaving: isSaving,
      isDirectNavigation: isDirectNavigation,
      dict: {
        world: dict.world,
        questionCard: dict.questionCard,
        worldLabels: dict.matchmaking.worldLabels,
        answerInput: dict.answerInput,
        interactiveScale: dict.interactiveScale,
        questionsList: dict.questionsList,
        questions: dict.questions,
      },
    };

    return (
      <WorldComponent {...worldProps} worldId={currentWorld} locale={locale} />
    );
  }, [
    currentWorld,
    handleAnswer,
    handleVisibilityChange,
    handleWorldComplete,
    handleExit,
    answers,
    completedWorlds,
    currentQuestionIndices,
    handleQuestionnaireSave,
    isSaving,
    isDirectNavigation,
    dict,
    locale,
  ]);

  const worldStats = useMemo(
    () => ({
      PERSONALITY: { questionCount: personalityQuestions.length },
      VALUES: { questionCount: valuesQuestions.length },
      RELATIONSHIP: { questionCount: relationshipQuestions.length },
      PARTNER: { questionCount: partnerQuestions.length },
      RELIGION: { questionCount: religionQuestions.length },
    }),
    []
  );

  const renderCurrentStep = () => {
    if (isLoading) {
      return (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20"
        >
          <div className="relative">
            <div className="absolute inset-0 bg-gradient-to-r from-teal-400 to-orange-500 rounded-full blur-xl opacity-50 animate-pulse" />
            <Loader2 className="relative h-16 w-16 animate-spin text-teal-600" />
          </div>
          <motion.p
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="mt-6 text-xl font-semibold text-gray-700"
          >
            {dict.matchmaking.loading}
          </motion.p>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.4 }}
            className="mt-4 flex items-center gap-2 text-sm text-gray-500"
          >
            <Sparkles className="w-4 h-4" />
            <span>{dict.matchmaking.loadingSubtext}</span>
          </motion.div>
        </motion.div>
      );
    }

    switch (currentStep) {
      case OnboardingStep.LANDING:
        return (
          <QuestionnaireLandingPage
            onStartQuestionnaire={handleStartQuestionnaire}
            hasSavedProgress={hasSavedProgress}
            isLoading={isSaving}
            dict={dict.landingPage}
            locale={locale}
          />
        );

      case OnboardingStep.MAP:
        return (
          <WorldsMap
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={handleWorldChange}
            dict={dict.worldsMap}
            locale={locale}
            answers={answers}
            worldStats={worldStats}
          />
        );

      case OnboardingStep.WORLDS:
        return (
          <QuestionnaireLayout
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={handleWorldChange}
            onExit={handleExit}
            onSaveProgress={() => handleQuestionnaireSave(false)}
            locale={locale}
            dict={{
              layout: dict.layout,
              worldLabels: dict.matchmaking.worldLabels,
              faq: dict.faq,
              accessibilityFeatures: dict.accessibilityFeatures,
            }}
          >
            {renderCurrentWorld()}
          </QuestionnaireLayout>
        );

      case OnboardingStep.COMPLETED:
        return (
          <QuestionnaireCompletion
            onSendToMatching={async () => {
              console.log(
                '%c[Complete] ðŸŽ¯ Sending to matching...',
                'color: #0d9488; font-weight: bold;'
              );
              if (onComplete) onComplete();
              else router.push('/dashboard');
            }}
            isLoading={isSaving}
            isLoggedIn={!!userId}
            dict={dict.completion}
          />
        );

      default:
        return (
          <div className="flex items-center justify-center min-h-screen">
            <Alert variant="destructive" className="max-w-md">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>
                {dict.matchmaking.errors.stageLoadError}
              </AlertDescription>
            </Alert>
          </div>
        );
    }
  };

  // Enhanced Toast Component
  const Toast = ({
    message,
    type,
    isVisible,
    action,
  }: {
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';
    isVisible: boolean;
    action?: { label: string; onClick: () => void };
  }) => {
    if (!isVisible) return null;

    const typeConfig = {
      success: {
        bg: 'from-teal-500 to-emerald-600',
        icon: CheckCircle,
        border: 'border-teal-400',
      },
      error: {
        bg: 'from-rose-500 to-red-600',
        icon: XCircle,
        border: 'border-rose-400',
      },
      info: {
        bg: 'from-blue-500 to-cyan-600',
        icon: Info,
        border: 'border-blue-400',
      },
      warning: {
        bg: 'from-orange-500 to-amber-600',
        icon: AlertCircle,
        border: 'border-orange-400',
      },
    };

    const config = typeConfig[type];
    const Icon = config.icon;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0, y: 50, scale: 0.9 }}
          animate={{ opacity: 1, y: 0, scale: 1 }}
          exit={{ opacity: 0, y: 20, scale: 0.9 }}
          transition={{ type: 'spring', stiffness: 200, damping: 20 }}
          className={cn(
            'fixed bottom-6 right-6 z-[100] max-w-md backdrop-blur-xl',
            'rounded-2xl shadow-2xl border-2',
            config.border
          )}
        >
          <div
            className={cn(
              'relative overflow-hidden rounded-2xl bg-gradient-to-r p-5',
              config.bg
            )}
          >
            <div className="absolute inset-0 bg-black/10" />
            <div className="relative z-10 flex items-center justify-between gap-4">
              <div className="flex items-center gap-3 flex-1">
                <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                  <Icon className="h-6 w-6 text-white" />
                </div>
                <p className="text-white font-semibold leading-relaxed">
                  {message}
                </p>
              </div>
              {action && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    action.onClick();
                    setToastState((prev) => ({ ...prev, isVisible: false }));
                  }}
                  className="text-white hover:bg-white/20 font-bold border-2 border-white/40 rounded-xl flex-shrink-0"
                >
                  {action.label}
                </Button>
              )}
            </div>
          </div>
        </motion.div>
      </AnimatePresence>
    );
  };

  // Enhanced Idle Modal Component
  const IdleModal = () => {
    if (!showIdleModal) return null;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black/70 backdrop-blur-md z-[200] flex items-center justify-center p-4"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0, y: 20 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            exit={{ scale: 0.9, opacity: 0, y: 20 }}
            transition={{ type: 'spring', stiffness: 200 }}
          >
            <Card className="max-w-md w-full shadow-2xl border-2 border-orange-200">
              <CardHeader className="bg-gradient-to-r from-orange-50 to-amber-50 border-b-2 border-orange-200">
                <CardTitle className="flex items-center gap-3 text-xl">
                  <div className="p-2 bg-gradient-to-br from-orange-400 to-amber-500 rounded-xl">
                    <Clock className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-gray-800">
                    {dict.matchmaking.idleModal.title}
                  </span>
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6 space-y-6">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg flex-shrink-0">
                    <AlertCircle className="w-5 h-5 text-orange-600" />
                  </div>
                  <p className="text-gray-600 leading-relaxed">
                    {dict.matchmaking.idleModal.description}
                  </p>
                </div>

                <div className="flex flex-col sm:flex-row gap-3">
                  <Button
                    variant="outline"
                    onClick={() => signOut({ callbackUrl: '/' })}
                    className="w-full sm:w-auto border-2 border-rose-300 text-rose-600 hover:bg-rose-50"
                  >
                    <LogOut className="w-4 h-4 mr-2" />
                    {dict.matchmaking.idleModal.logoutButton}
                  </Button>
                  <Button
                    onClick={handleStayActive}
                    className="w-full sm:w-auto bg-gradient-to-r from-teal-500 to-orange-500 hover:from-teal-600 hover:to-orange-600 text-white font-bold"
                  >
                    <Zap className="w-4 h-4 mr-2" />
                    {dict.matchmaking.idleModal.stayActiveButton}
                  </Button>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        </motion.div>
      </AnimatePresence>
    );
  };

  // Last Saved Indicator
  const LastSavedIndicator = () => {
    if (!lastSavedTime || currentStep !== OnboardingStep.WORLDS || !userId)
      return null;

    return (
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: 20 }}
        className="fixed bottom-6 left-6 z-40 bg-white/95 backdrop-blur-sm p-3 rounded-xl shadow-lg border-2 border-teal-200"
      >
        <div className="flex items-center gap-2">
          <CheckCircle className="h-4 w-4 text-teal-600" />
          <span className="text-sm font-semibold text-gray-700">
            {dict.matchmaking.lastSaved.replace(
              '{{time}}',
              lastSavedTime.toLocaleTimeString(
                locale === 'he' ? 'he-IL' : 'en-US',
                {
                  hour: '2-digit',
                  minute: '2-digit',
                }
              )
            )}
          </span>
        </div>
      </motion.div>
    );
  };

  // Error Alert
  const ErrorAlert = () => {
    if (!error || currentStep === OnboardingStep.WORLDS) return null;

    return (
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="max-w-2xl mx-auto m-6"
      >
        <Alert
          variant="destructive"
          className="border-2 border-rose-300 shadow-lg"
        >
          <div className="flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 mt-0.5 text-rose-600" />
            <AlertDescription className="text-base leading-relaxed text-rose-800">
              {error}
            </AlertDescription>
          </div>
        </Alert>
      </motion.div>
    );
  };

  return (
    <div
      className={cn(
        'min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        locale === 'he' ? 'dir-rtl' : 'dir-ltr'
      )}
    >
      <IdleModal />
      <LastSavedIndicator />
      <ErrorAlert />

      <AnimatePresence mode="wait">
        <motion.div
          key={currentStep}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.3 }}
        >
          {renderCurrentStep()}
        </motion.div>
      </AnimatePresence>

      <Toast
        message={toastState.message}
        type={toastState.type}
        isVisible={toastState.isVisible}
        action={toastState.action}
      />
    </div>
  );
}
--- End of Content for MatchmakingQuestionnaire.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnaireComplete.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { CheckCircle2, ArrowRight } from 'lucide-react';
import type { QuestionnaireCompletePageDict } from '@/types/dictionary'; // Import dictionary type

// --- Props Interface ---
interface QuestionnaireCompleteProps {
  dict: QuestionnaireCompletePageDict;
}

export default function QuestionnaireComplete({
  dict,
}: QuestionnaireCompleteProps) {
  const { status } = useSession();
  const router = useRouter();

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/auth/signin');
    }
  }, [status, router]);

  if (status === 'loading') {
    return (
      <div className="container mx-auto py-8 px-4">
        <Card className="max-w-xl mx-auto">
          <CardContent className="p-8">
            <div className="text-center">{dict.loading}</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 px-4">
      <Card className="max-w-xl mx-auto bg-green-50 border-green-200">
        <CardHeader className="text-center pb-2">
          <div className="flex justify-center mb-4">
            <CheckCircle2 className="w-12 h-12 text-green-500" />
          </div>
          <CardTitle className="text-2xl">{dict.title}</CardTitle>
        </CardHeader>

        <CardContent className="space-y-6 pt-4">
          <div className="text-center text-gray-600 space-y-2">
            <p>{dict.successMessage1}</p>
            <p>{dict.successMessage2}</p>
          </div>

          <Alert className="bg-blue-50 border-blue-200">
            <AlertDescription>{dict.profilePrompt}</AlertDescription>
          </Alert>

          <div className="flex justify-center pt-4">
            <Button
              onClick={() => router.push('/profile')}
              className="flex items-center"
            >
              {dict.continueButton}
              <ArrowRight className="mr-2 h-5 w-5" />
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
--- End of Content for QuestionnaireComplete.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnairePageClient.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/QuestionnairePageClient.tsx
'use client';

import { useSession } from 'next-auth/react';
import { useState, useEffect } from 'react';
import { useRouter, useSearchParams, useParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft, AlertCircle, Loader2 } from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import QuestionnaireLandingPage from './pages/QuestionnaireLandingPage';
import MatchmakingQuestionnaire from './MatchmakingQuestionnaire';
import StandardizedLoadingSpinner from './common/StandardizedLoadingSpinner'; // <-- ×©×œ×‘ 1: ×”×•×¡×¤×ª ×”×™×™×‘×•×
import type { WorldId } from './types/types';
import type { QuestionnaireDictionary } from '@/types/dictionary';

// Enum to track questionnaire flow stages
enum QuestionnaireStage {
  LANDING = 'LANDING',
  QUESTIONNAIRE = 'QUESTIONNAIRE',
  COMPLETE = 'COMPLETE',
}

// ×”×’×“×¨×ª Props ×œ×¨×›×™×‘
interface QuestionnairePageClientProps {
  dict: QuestionnaireDictionary;
  locale: 'he' | 'en';
}

export default function QuestionnairePageClient({
  dict,
  locale,
}: QuestionnairePageClientProps) {
  const { data: session, status } = useSession();
  const router = useRouter();
  const searchParams = useSearchParams();
  const params = useParams();

  // State for tracking current stage in the flow
  const [currentStage, setCurrentStage] = useState<QuestionnaireStage>(
    QuestionnaireStage.LANDING
  );
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [hasSavedProgress, setHasSavedProgress] = useState(false);
  const [initialWorld, setInitialWorld] = useState<WorldId | undefined>(
    undefined
  );
  const [initialQuestionId, setInitialQuestionId] = useState<
    string | undefined
  >(undefined);

  // Check for existing progress when component mounts
  useEffect(() => {
    const checkExistingProgress = async () => {
      if (status === 'loading') return;
      setIsLoading(true);
      try {
        if (session?.user?.id) {
          const response = await fetch('/api/questionnaire');
          const data = await response.json();
          if (data.success && data.data) {
            setHasSavedProgress(true);
          }
        }
      } catch (err) {
        console.error('Error checking questionnaire progress:', err);
      } finally {
        setIsLoading(false);
      }
    };
    checkExistingProgress();
  }, [session, status]);

  // Check for world parameter in URL and normalize it
  useEffect(() => {
    if (status === 'loading') {
      return;
    }
    const worldParam = searchParams?.get('world');
    const questionParam = searchParams?.get('question');

    if (worldParam) {
      const worldParamUpper = worldParam.toUpperCase() as WorldId;
      const validWorlds: WorldId[] = [
        'PERSONALITY',
        'VALUES',
        'RELATIONSHIP',
        'PARTNER',
        'RELIGION',
      ];
      if (validWorlds.includes(worldParamUpper)) {
        setInitialWorld(worldParamUpper);
        if (questionParam) {
          setInitialQuestionId(questionParam);
        }
        setCurrentStage(QuestionnaireStage.QUESTIONNAIRE);
      } else {
        console.warn(
          `[QuestionnairePage] Invalid world param received in URL: ${worldParam}`
        );
      }
    }
  }, [searchParams, status]);

  const handleStartQuestionnaire = () => {
    setCurrentStage(QuestionnaireStage.QUESTIONNAIRE);
  };

  const handleQuestionnaireComplete = async () => {
    try {
      await router.push('/questionnaire/complete');
      setCurrentStage(QuestionnaireStage.COMPLETE);
    } catch (err) {
      console.error('Error completing questionnaire:', err);
      setError(dict.page.completionError); // ×©×™×ž×•×© ×‘×ž×™×œ×•×Ÿ
    }
  };

  // --- ×©×œ×‘ 2: ×”×—×œ×¤×ª ×¨×›×™×‘ ×”×˜×¢×™× ×” ---
  if (isLoading) {
    return (
      <StandardizedLoadingSpinner
        text={dict.page.loading}
        subtext={
          dict.matchmaking.loadingSubtext || '×¨×§ ×¨×’×¢, ×ž×›×™× ×™× ×œ×š ××ª ×”×ž×¡×¢...'
        }
      />
    );
  }

  const renderCurrentStage = () => {
    switch (currentStage) {
      case QuestionnaireStage.LANDING:
        return (
          <QuestionnaireLandingPage
            onStartQuestionnaire={handleStartQuestionnaire}
            hasSavedProgress={hasSavedProgress}
            dict={dict.landingPage}
            locale={locale}
          />
        );
      case QuestionnaireStage.QUESTIONNAIRE:
        return (
          <MatchmakingQuestionnaire
            userId={session?.user?.id}
            onComplete={handleQuestionnaireComplete}
            initialWorld={initialWorld}
            initialQuestionId={initialQuestionId}
            dict={dict}
            locale={locale}
          />
        );
      case QuestionnaireStage.COMPLETE:
        return null;
      default:
        return <div>{dict.page.stageLoadError}</div>;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {error && (
        <div className="container mx-auto p-4">
          <Alert variant="destructive" className="mb-4">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        </div>
      )}

      {renderCurrentStage()}
    </div>
  );
}
--- End of Content for QuestionnairePageClient.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnaireRestore.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';
import type { QuestionnaireRestoreDict } from '@/types/dictionary'; // Import dictionary type

// --- Props Interface ---
interface QuestionnaireRestoreProps {
  dict: QuestionnaireRestoreDict;
}

export default function QuestionnaireRestore({
  dict,
}: QuestionnaireRestoreProps) {
  const router = useRouter();
  const { data: session, status } = useSession();
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const restoreQuestionnaire = async () => {
      if (isProcessing) return;

      try {
        setIsProcessing(true);
        setError(null);

        const savedData = localStorage.getItem('tempQuestionnaire');

        if (!savedData || !session?.user?.id) {
          router.push('/dashboard');
          return;
        }

        const questionnaireData = JSON.parse(savedData);
        questionnaireData.userId = session.user.id;

        const response = await fetch('/api/questionnaire', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(questionnaireData),
        });

        if (!response.ok) {
          const errorData = await response.json();
          // Developer-facing error can remain in English
          throw new Error(errorData.message || 'Failed to save questionnaire');
        }

        localStorage.removeItem('tempQuestionnaire');
        router.push(
          questionnaireData.completed ? '/dashboard' : '/questionnaire'
        );
      } catch (err) {
        console.error('Error restoring questionnaire:', err);
        // Set user-facing error from the dictionary
        setError(dict.error);
      } finally {
        setIsProcessing(false);
      }
    };

    if (session?.user && !isProcessing && status === 'authenticated') {
      restoreQuestionnaire();
    }
  }, [session, router, isProcessing, status, dict.error]);

  const renderContent = () => {
    if (status === 'loading') {
      return (
        <Card>
          <CardContent className="p-6 text-center">
            <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4" />
            <p className="text-lg">{dict.loading}</p>
          </CardContent>
        </Card>
      );
    }

    if (status === 'unauthenticated') {
      router.push('/login');
      return null;
    }

    if (error) {
      return (
        <>
          <Alert variant="destructive">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
          <div className="mt-4 flex justify-center">
            <Button onClick={() => router.push('/questionnaire')}>
              {dict.backButton}
            </Button>
          </div>
        </>
      );
    }

    return (
      <Card>
        <CardContent className="p-6 text-center">
          <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4" />
          <p className="text-lg">{dict.restoringTitle}</p>
          <p className="text-sm text-gray-500 mt-2">{dict.restoringSubtitle}</p>
        </CardContent>
      </Card>
    );
  };

  return (
    <div className="container mx-auto p-4 max-w-md">{renderContent()}</div>
  );
}
--- End of Content for QuestionnaireRestore.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questionnaire_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\AnswerInput.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/AnswerInput.tsx

import React, { useState, useEffect, useCallback } from 'react';
import { Slider } from '@/components/ui/slider';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  X,
  Plus,
  Minus,
  CheckCircle,
  Eraser,
  Info,
  ChevronDown,
  CornerDownRight,
  AlertCircle,
  Sparkles,
  Clock,
  Copy,
  CheckCheck,
  Edit,
  Trash2,
  Target,
  Flame,
  TrendingUp,
} from 'lucide-react';
import InteractiveScale from './InteractiveScale';
import type { AnswerValue, Option, Question } from '../types/types';
import { cn } from '@/lib/utils';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { motion, AnimatePresence } from 'framer-motion';
import { Badge } from '@/components/ui/badge';
import type { AnswerInputDict, InteractiveScaleDict } from '@/types/dictionary';

type ThemeColor = 'sky' | 'rose' | 'purple' | 'teal' | 'amber';

const getThemeConfig = (themeColor: ThemeColor) => {
  const themes = {
    sky: {
      gradient: 'from-cyan-400 via-sky-500 to-blue-500',
      lightBg: 'from-cyan-50 to-blue-50',
      textColor: 'text-sky-900',
      iconColor: 'text-sky-600',
      borderColor: 'border-sky-400',
      ringColor: 'ring-sky-300',
      bgSoft: 'bg-sky-50',
      shadowColor: 'shadow-sky-200/50',
      hoverBorder: 'hover:border-sky-200',
    },
    rose: {
      gradient: 'from-rose-400 via-pink-500 to-red-500',
      lightBg: 'from-rose-50 to-red-50',
      textColor: 'text-rose-900',
      iconColor: 'text-rose-600',
      borderColor: 'border-rose-400',
      ringColor: 'ring-rose-300',
      bgSoft: 'bg-rose-50',
      shadowColor: 'shadow-rose-200/50',
      hoverBorder: 'hover:border-rose-200',
    },
    purple: {
      gradient: 'from-purple-400 via-violet-500 to-indigo-500',
      lightBg: 'from-purple-50 to-indigo-50',
      textColor: 'text-purple-900',
      iconColor: 'text-purple-600',
      borderColor: 'border-purple-400',
      ringColor: 'ring-purple-300',
      bgSoft: 'bg-purple-50',
      shadowColor: 'shadow-purple-200/50',
      hoverBorder: 'hover:border-purple-200',
    },
    teal: {
      gradient: 'from-teal-400 via-emerald-500 to-green-500',
      lightBg: 'from-teal-50 to-emerald-50',
      textColor: 'text-teal-900',
      iconColor: 'text-teal-600',
      borderColor: 'border-teal-400',
      ringColor: 'ring-teal-300',
      bgSoft: 'bg-teal-50',
      shadowColor: 'shadow-teal-200/50',
      hoverBorder: 'hover:border-teal-200',
    },
    amber: {
      gradient: 'from-amber-400 via-orange-500 to-yellow-500',
      lightBg: 'from-amber-50 to-orange-50',
      textColor: 'text-amber-900',
      iconColor: 'text-amber-600',
      borderColor: 'border-amber-400',
      ringColor: 'ring-amber-300',
      bgSoft: 'bg-amber-50',
      shadowColor: 'shadow-amber-200/50',
      hoverBorder: 'hover:border-amber-200',
    },
  };
  return themes[themeColor] || themes.sky;
};

export interface AnswerInputProps {
  locale: string;
  question: Question;
  themeColor?: ThemeColor;
  value?: AnswerValue;
  onChange?: (value: AnswerValue) => void;
  onClear?: () => void;
  className?: string;
  validationError?: string;
  dict: {
    answerInput: AnswerInputDict;
    interactiveScale: InteractiveScaleDict;
  };
}

export default function AnswerInput({
  question,
  value,
  onChange,
  onClear,
  className = '',
  validationError,
  dict,
  locale,
  themeColor = 'sky',
}: AnswerInputProps) {
  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);

  const [internalValue, setInternalValue] = useState<AnswerValue>(value);
  const [error, setError] = useState<string | null>(null);
  const [customValue, setCustomValue] = useState<string>('');
  const [isFocused, setIsFocused] = useState<boolean>(false);
  const [textAreaHeight, setTextAreaHeight] = useState<number>(150);
  const [isCollapsibleOpen, setIsCollapsibleOpen] = useState<boolean>(false);
  const [textCopied, setTextCopied] = useState(false);

  useEffect(() => {
    setInternalValue(value);
    if (typeof value === 'string') {
      if (value.length > 200) setTextAreaHeight(220);
      else if (value.length > 100) setTextAreaHeight(180);
      else setTextAreaHeight(150);
    } else if (value === undefined || value === null) {
      setTextAreaHeight(150);
    }
  }, [value]);

  const handleClear = useCallback(() => {
    let emptyValue: AnswerValue;
    switch (question.type) {
      case 'multiChoice':
      case 'multiSelect':
      case 'multiSelectWithOther':
        emptyValue = [];
        break;
      case 'budgetAllocation':
        emptyValue = {};
        break;
      case 'openText':
        emptyValue = '';
        break;
      case 'scale':
        emptyValue = undefined;
        break;
      case 'singleChoice':
      case 'scenario':
      case 'iconChoice':
      default:
        emptyValue = undefined;
    }
    setInternalValue(emptyValue);
    setCustomValue('');
    setError(null);
    onClear?.();
  }, [question.type, onClear]);

  const handleValueChange = useCallback(
    (newValue: AnswerValue) => {
      if (
        (question.type === 'singleChoice' ||
          question.type === 'iconChoice' ||
          question.type === 'scenario') &&
        newValue === internalValue &&
        !question.isRequired
      ) {
        handleClear();
        return;
      }
      setInternalValue(newValue);
      setError(null);
      onChange?.(newValue);
    },
    [internalValue, onChange, question.isRequired, question.type, handleClear]
  );

  const handleCopyText = useCallback(() => {
    if (typeof internalValue === 'string' && internalValue) {
      navigator.clipboard.writeText(internalValue);
      setTextCopied(true);
      setTimeout(() => setTextCopied(false), 2000);
    }
  }, [internalValue]);

  const optionVariants = {
    initial: { opacity: 0, y: 20, scale: 0.95 },
    animate: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: {
        duration: 0.3,
        ease: [0.25, 1, 0.5, 1],
      },
    },
    exit: {
      opacity: 0,
      scale: 0.95,
      y: -10,
      transition: { duration: 0.2 },
    },
    hover: {
      scale: 1.02,
      y: -2,
      transition: { duration: 0.2, ease: 'easeOut' },
    },
    tap: { scale: 0.98 },
  };

  const rippleVariants = {
    initial: { scale: 0, opacity: 0.5 },
    animate: {
      scale: 2,
      opacity: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const renderSingleChoiceOption = (
    choiceOption: Option,
    isSelected: boolean
  ) => (
    <motion.div
      key={choiceOption.value}
      variants={optionVariants}
      initial="initial"
      animate="animate"
      exit="exit"
      layout
      className="relative"
    >
      <div
        className={cn(
          'group relative p-4 rounded-2xl cursor-pointer transition-all duration-300',
          'border-2 overflow-hidden',
          isSelected
            ? cn(
                'bg-gradient-to-br',
                theme.lightBg,
                theme.borderColor,
                'shadow-lg',
                theme.shadowColor
              )
            : cn(
                'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-md',
                theme.lightBg
                  .replace('from-', 'hover:from-')
                  .replace('to-', 'hover:to-'),
                theme.hoverBorder
              )
        )}
        onMouseDown={(e) => {
          e.preventDefault();
          handleValueChange(choiceOption.value);
        }}
      >
        {!isSelected && (
          <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/40 to-transparent" />
        )}

        <AnimatePresence>
          {isSelected && (
            <motion.div
              variants={rippleVariants}
              initial="initial"
              animate="animate"
              className={cn(
                'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-20',
                theme.gradient
              )}
            />
          )}
        </AnimatePresence>

        <div
          className={cn(
            'flex items-center justify-between gap-3 relative z-10',
            isRTL && 'flex-row-reverse'
          )}
        >
          <div className={cn('flex items-center gap-3 flex-1')}>
            {choiceOption.icon && (
              <motion.div
                animate={{
                  scale: isSelected ? [1, 1.2, 1] : 1,
                  rotate: isSelected ? [0, 5, -5, 0] : 0,
                }}
                transition={{ duration: 0.5 }}
                className={cn(
                  'p-2 rounded-xl transition-colors',
                  isSelected
                    ? cn(
                        'bg-gradient-to-br text-white shadow-md',
                        theme.gradient
                      )
                    : `bg-gray-100 text-gray-600 group-hover:${theme.bgSoft} group-hover:${theme.iconColor}`
                )}
              >
                {choiceOption.icon}
              </motion.div>
            )}
            <span
              className={cn(
                'font-medium transition-colors',
                isSelected
                  ? theme.textColor
                  : cn(
                      'text-gray-700',
                      theme.textColor.replace('text-', 'group-hover:text-')
                    )
              )}
            >
              {choiceOption.text}
            </span>
          </div>

          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: isSelected ? 1 : 0 }}
            className="relative"
          >
            <div
              className={cn(
                'w-7 h-7 rounded-full bg-gradient-to-br flex items-center justify-center shadow-lg',
                theme.gradient
              )}
            >
              <CheckCircle className="w-4 h-4 text-white" fill="white" />
            </div>
          </motion.div>
        </div>

        {isSelected && (
          <motion.div
            initial={{ scale: 0, rotate: -45 }}
            animate={{ scale: 1, rotate: 0 }}
            className={cn(
              'absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-white/20 to-transparent rounded-bl-full opacity-50',
              theme.gradient
            )}
          />
        )}
      </div>
    </motion.div>
  );

  const renderInput = () => {
    switch (question.type) {
      case 'singleChoice':
        return (
          <div className="space-y-3">
            <AnimatePresence mode="popLayout">
              {question.options?.map((optionItem) => {
                const isSelected = internalValue === optionItem.value;
                return renderSingleChoiceOption(optionItem, isSelected);
              })}
            </AnimatePresence>
          </div>
        );

      case 'scale':
        return (
          <div className="relative">
            <div
              className={cn(
                'absolute inset-0 rounded-2xl blur-xl -z-10 bg-gradient-to-r opacity-50',
                theme.lightBg
              )}
            />

            <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border-2 border-gray-100 shadow-lg">
              <InteractiveScale
                min={question.min ?? 1}
                max={question.max ?? 10}
                step={question.step ?? 1}
                value={
                  typeof internalValue === 'number' ? internalValue : undefined
                }
                onChange={(newValue) => handleValueChange(newValue)}
                showLabels={true}
                showValue={true}
                name={question.id}
                required={question.isRequired}
                ariaLabelledby={question.id}
                dict={dict.interactiveScale}
                themeColor={themeColor}
              />
            </div>
          </div>
        );

      case 'multiChoice':
      case 'multiSelect': {
        const selectedValues = Array.isArray(internalValue)
          ? (internalValue as string[])
          : [];
        const progress = question.maxSelections
          ? (selectedValues.length / question.maxSelections) * 100
          : 0;

        return (
          <div className="space-y-4">
            {question.maxSelections && (
              <motion.div
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                className={cn(
                  'bg-gradient-to-r rounded-xl p-4 border',
                  theme.lightBg,
                  theme.borderColor
                )}
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <Target className={cn('w-4 h-4', theme.iconColor)} />
                    <span
                      className={cn('text-sm font-medium', theme.textColor)}
                    >
                      {dict.answerInput.multiSelect.selectedInfo.replace(
                        '{{count}}',
                        selectedValues.length.toString()
                      )}
                    </span>
                  </div>
                  <Badge
                    className={cn(
                      'text-white bg-gradient-to-r',
                      theme.gradient
                    )}
                  >
                    {selectedValues.length}/{question.maxSelections}
                  </Badge>
                </div>
                <Progress value={progress} className="h-2" />
              </motion.div>
            )}

            <div className="space-y-2">
              <AnimatePresence mode="popLayout">
                {question.options?.map((option, index) => {
                  const isSelected = selectedValues.includes(option.value);
                  const isMaxReached =
                    question.maxSelections &&
                    selectedValues.length >= question.maxSelections &&
                    !isSelected;

                  return (
                    <motion.div
                      key={option.value}
                      variants={optionVariants}
                      initial="initial"
                      animate="animate"
                      exit="exit"
                      layout
                      style={{ zIndex: isSelected ? 10 : 1 }}
                    >
                      <div
                        className={cn(
                          'group relative p-4 rounded-2xl cursor-pointer transition-all duration-300',
                          'border-2 overflow-hidden',
                          isSelected
                            ? cn(
                                'bg-gradient-to-r',
                                theme.lightBg,
                                theme.borderColor,
                                'shadow-lg',
                                theme.shadowColor
                              )
                            : isMaxReached
                              ? 'bg-gray-50 border-gray-200 opacity-50 cursor-not-allowed'
                              : cn(
                                  'bg-white border-gray-200 hover:shadow-md',
                                  theme.bgSoft.replace('bg-', 'hover:bg-') +
                                    '/30',
                                  theme.hoverBorder
                                )
                        )}
                        onMouseDown={(e) => {
                          e.preventDefault();
                          if (isMaxReached) {
                            setError(
                              dict.answerInput.multiSelect.maxSelectionError.replace(
                                '{{count}}',
                                String(question.maxSelections)
                              )
                            );
                            setTimeout(() => setError(null), 2500);
                            return;
                          }

                          let newValues: string[];
                          if (isSelected) {
                            newValues = selectedValues.filter(
                              (v) => v !== option.value
                            );
                          } else {
                            newValues = [...selectedValues, option.value];
                          }
                          handleValueChange(newValues);
                        }}
                      >
                        <AnimatePresence>
                          {isSelected && (
                            <motion.div
                              initial={{ scale: 0, opacity: 0 }}
                              animate={{ scale: 1.5, opacity: 0 }}
                              exit={{ scale: 0, opacity: 0 }}
                              transition={{ duration: 0.6 }}
                              className={cn(
                                'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-20',
                                theme.gradient
                              )}
                            />
                          )}
                        </AnimatePresence>

                        <div
                          className={cn(
                            'flex items-center justify-between gap-3 relative z-10',
                            isRTL && 'flex-row-reverse'
                          )}
                        >
                          <div
                            className={cn(
                              'flex items-center gap-3 flex-1',
                              isRTL && 'flex-row-reverse text-right'
                            )}
                          >
                            {option.icon && (
                              <motion.div
                                animate={{ scale: isSelected ? 1.1 : 1 }}
                                className={cn(
                                  'p-2 rounded-xl transition-all',
                                  isSelected
                                    ? cn(
                                        'bg-gradient-to-br text-white',
                                        theme.gradient
                                      )
                                    : cn(
                                        'bg-gray-100 text-gray-600',
                                        theme.bgSoft.replace(
                                          'bg-',
                                          'group-hover:bg-'
                                        )
                                      )
                                )}
                              >
                                {option.icon}
                              </motion.div>
                            )}
                            <span
                              className={cn(
                                'font-medium',
                                isSelected ? theme.textColor : 'text-gray-700'
                              )}
                            >
                              {option.text}
                            </span>
                          </div>

                          <motion.div
                            className={cn(
                              'w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all',
                              isSelected
                                ? cn(
                                    'bg-gradient-to-br',
                                    theme.gradient,
                                    theme.borderColor
                                  )
                                : 'border-gray-300 bg-white'
                            )}
                          >
                            <AnimatePresence>
                              {isSelected && (
                                <motion.div
                                  initial={{ scale: 0, rotate: -180 }}
                                  animate={{ scale: 1, rotate: 0 }}
                                  exit={{ scale: 0, rotate: 180 }}
                                >
                                  <CheckCheck
                                    className="w-4 h-4 text-white"
                                    strokeWidth={3}
                                  />
                                </motion.div>
                              )}
                            </AnimatePresence>
                          </motion.div>
                        </div>
                      </div>
                    </motion.div>
                  );
                })}
              </AnimatePresence>
            </div>

            <AnimatePresence>
              {error && (
                <motion.div
                  initial={{ opacity: 0, y: -10, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, scale: 0.95 }}
                  className="flex items-center gap-2 p-3 bg-red-50 border-2 border-red-200 rounded-xl"
                >
                  <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                  <p className="text-sm font-medium text-red-700">{error}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      case 'multiSelectWithOther': {
        const selectedWithOtherValues = Array.isArray(internalValue)
          ? (internalValue as string[])
          : [];
        const customAnswers = selectedWithOtherValues.filter((v) =>
          v.startsWith('custom:')
        );
        const predefinedAnswers = selectedWithOtherValues.filter(
          (v) => !v.startsWith('custom:')
        );
        const isCustomValueEmpty = !customValue.trim();
        const isMaxLengthReached =
          question.maxSelections !== undefined &&
          selectedWithOtherValues.length >= question.maxSelections;

        return (
          <div className="space-y-4">
            <div className="space-y-2">
              {question.options?.map((option) => {
                if (option.value === 'other') return null;
                const isSelected = predefinedAnswers.includes(option.value);

                return (
                  <motion.div
                    key={option.value}
                    variants={optionVariants}
                    initial="initial"
                    animate="animate"
                    layout
                  >
                    <div
                      className={cn(
                        'p-4 rounded-2xl cursor-pointer border-2 transition-all',
                        isSelected
                          ? cn(
                              'bg-gradient-to-r shadow-lg',
                              theme.lightBg,
                              theme.borderColor
                            )
                          : cn(
                              'bg-white border-gray-200',
                              theme.bgSoft.replace('bg-', 'hover:bg-') + '/30',
                              theme.hoverBorder
                            )
                      )}
                      onMouseDown={(e) => {
                        e.preventDefault();
                        if (isMaxLengthReached && !isSelected) {
                          setError(
                            dict.answerInput.multiSelect.maxSelectionError.replace(
                              '{{count}}',
                              String(question.maxSelections)
                            )
                          );
                          setTimeout(() => setError(null), 2500);
                          return;
                        }

                        let newValues: string[];
                        if (isSelected) {
                          newValues = predefinedAnswers.filter(
                            (v) => v !== option.value
                          );
                        } else {
                          newValues = [...predefinedAnswers, option.value];
                        }
                        handleValueChange([...newValues, ...customAnswers]);
                      }}
                    >
                      <div
                        className={cn(
                          'flex items-center justify-between',
                          isRTL && 'flex-row-reverse'
                        )}
                      >
                        <div
                          className={cn(
                            'flex items-center gap-3',
                            isRTL && 'flex-row-reverse'
                          )}
                        >
                          {option.icon && (
                            <div
                              className={cn(
                                'p-2 rounded-xl',
                                isSelected
                                  ? cn(
                                      'text-white bg-gradient-to-r',
                                      theme.gradient
                                    )
                                  : 'bg-gray-100 text-gray-600'
                              )}
                            >
                              {option.icon}
                            </div>
                          )}
                          <span
                            className={cn(
                              'font-medium',
                              isSelected ? theme.textColor : 'text-gray-700'
                            )}
                          >
                            {option.text}
                          </span>
                        </div>
                        <motion.div
                          className={cn(
                            'w-6 h-6 rounded-lg border-2 flex items-center justify-center',
                            isSelected
                              ? cn(
                                  'bg-gradient-to-r',
                                  theme.gradient,
                                  theme.borderColor
                                )
                              : 'border-gray-300'
                          )}
                        >
                          {isSelected && (
                            <CheckCheck className="w-4 h-4 text-white" />
                          )}
                        </motion.div>
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </div>

            {/* Custom input section */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="relative"
            >
              <div className="absolute inset-0 bg-gradient-to-r from-purple-100/50 to-pink-100/50 rounded-2xl blur-xl" />
              <div className="relative bg-white rounded-2xl p-5 border-2 border-dashed border-purple-300 space-y-3">
                <div className="flex items-center gap-2 text-purple-900">
                  <Sparkles className="w-5 h-5" />
                  <Label className="font-semibold">
                    {dict.answerInput.multiSelectWithOther.addOtherOptionLabel}
                  </Label>
                </div>

                <div className="flex gap-2">
                  <Input
                    value={customValue}
                    onChange={(e) => setCustomValue(e.target.value)}
                    placeholder={
                      dict.answerInput.multiSelectWithOther
                        .otherOptionPlaceholder
                    }
                    className="flex-1 border-2 border-purple-200 focus:border-purple-400 rounded-xl"
                    disabled={isMaxLengthReached && isCustomValueEmpty}
                  />
                  <Button
                    type="button"
                    size="sm"
                    onMouseDown={(e) => {
                      e.preventDefault();
                      if (!isCustomValueEmpty) {
                        if (isMaxLengthReached) {
                          setError(
                            dict.answerInput.multiSelect.maxSelectionError.replace(
                              '{{count}}',
                              String(question.maxSelections)
                            )
                          );
                          setTimeout(() => setError(null), 2500);
                          return;
                        }
                        const newCustomAnswer = `custom:${customValue.trim()}`;
                        if (!customAnswers.includes(newCustomAnswer)) {
                          handleValueChange([
                            ...predefinedAnswers,
                            ...customAnswers,
                            newCustomAnswer,
                          ]);
                          setCustomValue('');
                        } else {
                          setError(
                            dict.answerInput.multiSelectWithOther.errorExists
                          );
                          setTimeout(() => setError(null), 2500);
                        }
                      }
                    }}
                    disabled={isCustomValueEmpty || isMaxLengthReached}
                    className="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
                  >
                    <Plus className="w-4 h-4 mr-1" />
                    {dict.answerInput.multiSelectWithOther.addButton}
                  </Button>
                </div>

                <AnimatePresence>
                  {customAnswers.length > 0 && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      exit={{ opacity: 0, height: 0 }}
                      className="space-y-2 pt-2"
                    >
                      <Label className="text-xs text-purple-700 flex items-center gap-1">
                        <Edit className="w-3 h-3" />
                        {
                          dict.answerInput.multiSelectWithOther
                            .addedAnswersLabel
                        }
                      </Label>
                      {customAnswers.map((customVal, index) => (
                        <motion.div
                          key={index}
                          initial={{ opacity: 0, x: -20 }}
                          animate={{ opacity: 1, x: 0 }}
                          exit={{ opacity: 0, x: 20 }}
                          className="flex items-center justify-between p-3 bg-purple-50 rounded-xl border border-purple-200"
                        >
                          <div className="flex items-center gap-2">
                            <CornerDownRight className="w-4 h-4 text-purple-500" />
                            <span className="text-sm font-medium text-purple-900">
                              {customVal.replace('custom:', '')}
                            </span>
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="h-7 w-7 text-purple-400 hover:text-red-500 hover:bg-red-50"
                            onMouseDown={(e) => {
                              e.preventDefault();
                              const newValues = selectedWithOtherValues.filter(
                                (v) => v !== customVal
                              );
                              handleValueChange(newValues);
                            }}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </motion.div>
                      ))}
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </motion.div>

            {error && (
              <motion.div
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                className="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-xl"
              >
                <AlertCircle className="w-5 h-5 text-red-500" />
                <p className="text-sm text-red-700">{error}</p>
              </motion.div>
            )}
          </div>
        );
      }

      case 'scenario':
        return (
          <div className="space-y-3">
            {question.options?.map((option, index) => {
              const optionValue = option.value || option.text;
              const isSelected = internalValue === optionValue;

              return (
                <motion.div
                  key={index}
                  variants={optionVariants}
                  initial="initial"
                  animate="animate"
                  layout
                >
                  <div
                    className={cn(
                      'relative p-5 rounded-2xl cursor-pointer border-2 transition-all overflow-hidden',
                      isSelected
                        ? cn(
                            'bg-gradient-to-br shadow-xl',
                            theme.lightBg,
                            theme.borderColor,
                            theme.shadowColor
                          )
                        : cn(
                            'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-lg',
                            theme.lightBg
                              .replace('from-', 'hover:from-')
                              .replace('to-', 'hover:to-'),
                            theme.hoverBorder
                          )
                    )}
                    onMouseDown={(e) => {
                      e.preventDefault();
                      handleValueChange(optionValue);
                    }}
                  >
                    <div
                      className={cn(
                        'absolute top-0 right-0 w-32 h-32 bg-gradient-to-br to-transparent rounded-bl-full opacity-20',
                        theme.gradient
                      )}
                    />

                    <div className="relative z-10">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div
                            className={cn(
                              'font-semibold text-lg mb-2 transition-colors',
                              isSelected ? theme.textColor : 'text-gray-800'
                            )}
                          >
                            {option.text}
                          </div>
                          {option.description && (
                            <p
                              className={cn(
                                'text-sm leading-relaxed transition-colors',
                                isSelected ? 'text-gray-700' : 'text-gray-600'
                              )}
                            >
                              {option.description}
                            </p>
                          )}
                        </div>

                        <motion.div
                          initial={{ scale: 0 }}
                          animate={{ scale: isSelected ? 1 : 0 }}
                        >
                          <div
                            className={cn(
                              'w-8 h-8 rounded-full bg-gradient-to-br flex items-center justify-center shadow-lg',
                              theme.gradient
                            )}
                          >
                            <CheckCircle
                              className="w-5 h-5 text-white"
                              fill="white"
                            />
                          </div>
                        </motion.div>
                      </div>
                    </div>

                    {isSelected && (
                      <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        className={cn(
                          'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-10',
                          theme.gradient
                        )}
                      />
                    )}
                  </div>
                </motion.div>
              );
            })}
          </div>
        );

      case 'iconChoice':
        return (
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {question.options?.map((option) => {
              const isSelected = internalValue === option.value;

              return (
                <TooltipProvider key={option.value} delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <motion.div
                        variants={optionVariants}
                        initial="initial"
                        animate="animate"
                        onMouseDown={(e) => {
                          e.preventDefault();
                          handleValueChange(option.value);
                        }}
                      >
                        <Card
                          className={cn(
                            'relative p-6 cursor-pointer transition-all min-h-[140px]',
                            'flex flex-col items-center justify-center gap-3 text-center overflow-hidden',
                            'border-2',
                            isSelected
                              ? cn(
                                  'bg-gradient-to-br shadow-xl',
                                  theme.lightBg,
                                  theme.borderColor,
                                  theme.shadowColor
                                )
                              : cn(
                                  'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-lg',
                                  theme.lightBg
                                    .replace('from-', 'hover:from-')
                                    .replace('to-', 'hover:to-'),
                                  theme.hoverBorder
                                )
                          )}
                        >
                          <AnimatePresence>
                            {isSelected && (
                              <motion.div
                                initial={{ scale: 0, opacity: 0 }}
                                animate={{ scale: 2, opacity: 0.3 }}
                                exit={{ scale: 0, opacity: 0 }}
                                transition={{ duration: 0.6 }}
                                className={cn(
                                  'absolute inset-0 bg-gradient-to-br blur-2xl',
                                  theme.gradient
                                )}
                              />
                            )}
                          </AnimatePresence>

                          <AnimatePresence>
                            {isSelected && (
                              <motion.div
                                initial={{ scale: 0, rotate: -180 }}
                                animate={{ scale: 1, rotate: 0 }}
                                exit={{ scale: 0, rotate: 180 }}
                                className={cn(
                                  'absolute -top-2 -right-2 bg-gradient-to-br text-white rounded-full p-1.5 shadow-lg z-10',
                                  theme.gradient
                                )}
                              >
                                <CheckCircle className="h-4 w-4" fill="white" />
                              </motion.div>
                            )}
                          </AnimatePresence>

                          <div className="relative z-10">
                            <motion.div
                              animate={{
                                scale: isSelected ? [1, 1.2, 1] : 1,
                                rotate: isSelected ? [0, 10, -10, 0] : 0,
                              }}
                              transition={{ duration: 0.5 }}
                              className={cn(
                                'text-5xl mb-3 transition-all',
                                isSelected
                                  ? 'drop-shadow-lg'
                                  : 'opacity-70 group-hover:opacity-100'
                              )}
                            >
                              {option.icon}
                            </motion.div>

                            <span
                              className={cn(
                                'text-sm font-semibold transition-colors',
                                isSelected ? theme.textColor : 'text-gray-700'
                              )}
                            >
                              {option.text}
                            </span>
                          </div>
                        </Card>
                      </motion.div>
                    </TooltipTrigger>
                    {option.description && (
                      <TooltipContent
                        side="top"
                        className="max-w-xs bg-white/95 backdrop-blur-sm"
                      >
                        <p className="text-sm">{option.description}</p>
                      </TooltipContent>
                    )}
                  </Tooltip>
                </TooltipProvider>
              );
            })}
          </div>
        );

      case 'openText': {
        let textValue = '';
        if (typeof internalValue === 'string') {
          textValue = internalValue;
        } else if (
          typeof internalValue === 'object' &&
          internalValue !== null &&
          !Array.isArray(internalValue) &&
          'text' in internalValue
        ) {
          textValue = String(internalValue.text || '');
        }

        const hasMinLength =
          question.minLength !== undefined && question.minLength > 0;
        const hasMaxLength =
          question.maxLength !== undefined && question.maxLength > 0;
        const isMinLengthMet =
          !hasMinLength || textValue.length >= (question.minLength ?? 0);
        const isCloseToMax =
          hasMaxLength && textValue.length > (question.maxLength ?? 0) * 0.85;
        const lengthExceeded =
          hasMaxLength && textValue.length > (question.maxLength ?? 0);
        const completionPercentage = hasMinLength
          ? Math.min(
              100,
              Math.round((textValue.length / (question.minLength ?? 1)) * 100)
            )
          : 0;

        const wordCount = textValue.trim()
          ? textValue.trim().split(/\s+/).length
          : 0;
        const estimatedReadTime = Math.max(1, Math.ceil(wordCount / 200));

        return (
          <div className="space-y-4">
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex items-center justify-between gap-4 flex-wrap"
            >
              <div className="flex items-center gap-3">
                <Badge
                  variant="outline"
                  className={cn(
                    'text-xs',
                    theme.bgSoft,
                    theme.textColor.replace('900', '700'),
                    theme.borderColor
                  )}
                >
                  <Edit className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.wordCount.replace(
                    '{{count}}',
                    wordCount.toString()
                  )}
                </Badge>
                {wordCount > 0 && (
                  <Badge
                    variant="outline"
                    className="bg-purple-50 text-purple-700 border-purple-200"
                  >
                    <Clock className="w-3 h-3 mr-1" />
                    {dict.answerInput.openText.readingTime.replace(
                      '{{count}}',
                      estimatedReadTime.toString()
                    )}
                  </Badge>
                )}
              </div>

              {hasMinLength && (
                <Badge
                  className={cn(
                    'transition-all',
                    isMinLengthMet
                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                      : completionPercentage > 50
                        ? 'bg-gradient-to-r from-amber-500 to-orange-600 text-white'
                        : 'bg-gradient-to-r from-gray-400 to-gray-500 text-white'
                  )}
                >
                  {dict.answerInput.openText.completionPercentage.replace(
                    '{{count}}',
                    completionPercentage.toString()
                  )}
                </Badge>
              )}
            </motion.div>

            <div className="relative">
              <div
                className={cn(
                  'absolute inset-0 rounded-2xl blur-2xl -z-10 bg-gradient-to-br opacity-50',
                  theme.lightBg
                )}
              />

              <div
                className={cn(
                  'relative rounded-2xl transition-all duration-300 overflow-hidden',
                  'border-2',
                  isFocused
                    ? cn(
                        theme.borderColor,
                        'shadow-xl',
                        theme.shadowColor,
                        'ring-4',
                        theme.ringColor
                      )
                    : lengthExceeded
                      ? 'border-red-400 shadow-lg shadow-red-200/50'
                      : isCloseToMax
                        ? 'border-amber-400 shadow-lg shadow-amber-200/50'
                        : cn('border-gray-200 shadow-md', theme.hoverBorder)
                )}
              >
                <Textarea
                  value={textValue}
                  onChange={(e) => handleValueChange(e.target.value)}
                  onFocus={() => setIsFocused(true)}
                  onBlur={() => setIsFocused(false)}
                  placeholder={
                    question.placeholder ||
                    dict.answerInput.openText.placeholder
                  }
                  className={cn(
                    'resize-y border-0 focus-visible:ring-0 w-full min-h-[180px] text-base leading-relaxed',
                    'bg-white/80 backdrop-blur-sm relative z-10',
                    textValue.length > 0 ? (isRTL ? 'pl-14' : 'pr-14') : '',
                    isRTL ? 'py-4 pr-4' : 'py-4 pl-4'
                  )}
                  style={{ height: `${textAreaHeight}px` }}
                  aria-label={question.question}
                  aria-invalid={
                    (!isMinLengthMet && question.isRequired) || lengthExceeded
                  }
                />

                {textValue.length > 0 && (
                  <div
                    className={cn(
                      'absolute top-3 flex flex-col gap-2 z-20',
                      isRTL ? 'left-3' : 'right-3'
                    )}
                  >
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <motion.button
                            className={cn(
                              'p-2 rounded-xl transition-all shadow-md',
                              textCopied
                                ? 'bg-gradient-to-br from-green-500 to-emerald-600 text-white'
                                : `bg-white text-gray-600 hover:${theme.bgSoft} hover:${theme.iconColor}`
                            )}
                            onMouseDown={(e) => {
                              e.preventDefault();
                              handleCopyText();
                            }}
                          >
                            {textCopied ? (
                              <CheckCheck className="h-4 w-4" />
                            ) : (
                              <Copy className="h-4 w-4" />
                            )}
                          </motion.button>
                        </TooltipTrigger>
                        <TooltipContent>
                          <p>
                            {textCopied
                              ? dict.answerInput.tooltips.copied
                              : dict.answerInput.tooltips.copy}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>

                    {!question.isRequired && (
                      <TooltipProvider>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <motion.button
                              className="p-2 rounded-xl bg-white text-gray-600 hover:bg-red-50 hover:text-red-600 transition-all shadow-md"
                              onMouseDown={(e) => {
                                e.preventDefault();
                                handleClear();
                              }}
                            >
                              <Eraser className="h-4 w-4" />
                            </motion.button>
                          </TooltipTrigger>
                          <TooltipContent>
                            <p>{dict.answerInput.tooltips.clearText}</p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                    )}
                  </div>
                )}
              </div>
            </div>

            {hasMinLength && question.isRequired && (
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                className="space-y-2"
              >
                <div className="flex items-center justify-between text-sm">
                  <div className="flex items-center gap-2">
                    {isMinLengthMet ? (
                      <>
                        <CheckCircle className="w-4 h-4 text-green-500" />
                        <span className="text-green-700 font-medium">
                          {dict.answerInput.openText.minLengthMet}
                        </span>
                      </>
                    ) : (
                      <>
                        <TrendingUp className="w-4 h-4 text-amber-500" />
                        <span className="text-amber-700 font-medium">
                          {dict.answerInput.openText.minLengthRequired.replace(
                            '{{count}}',
                            (
                              (question.minLength ?? 0) - textValue.length
                            ).toString()
                          )}
                        </span>
                      </>
                    )}
                  </div>
                  <span
                    className={cn(
                      'font-bold text-lg',
                      isMinLengthMet ? 'text-green-600' : 'text-amber-600'
                    )}
                  >
                    {completionPercentage}%
                  </span>
                </div>

                <div className="relative h-3 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${completionPercentage}%` }}
                    transition={{ duration: 0.5, ease: 'easeOut' }}
                    className={cn(
                      'absolute inset-y-0 left-0 rounded-full',
                      'bg-gradient-to-r',
                      isMinLengthMet
                        ? 'from-green-500 to-emerald-600'
                        : completionPercentage > 50
                          ? 'from-amber-500 to-orange-600'
                          : 'from-gray-400 to-gray-500'
                    )}
                  />

                  {!isMinLengthMet && completionPercentage > 0 && (
                    <motion.div
                      className="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent"
                      animate={{ x: ['-100%', '200%'] }}
                      transition={{
                        duration: 2,
                        repeat: Infinity,
                        ease: 'linear',
                      }}
                    />
                  )}
                </div>
              </motion.div>
            )}

            <div className="flex flex-wrap gap-2">
              {hasMinLength && (
                <Badge
                  variant="outline"
                  className={cn(
                    'border-2',
                    !isMinLengthMet && question.isRequired
                      ? 'border-red-300 bg-red-50 text-red-700'
                      : cn(
                          theme.borderColor,
                          theme.bgSoft,
                          theme.textColor.replace('900', '700')
                        )
                  )}
                >
                  <Info className="w-3 h-3 mr-1" />
                  {question.isRequired
                    ? dict.answerInput.openText.minLengthInfoRequired.replace(
                        '{{count}}',
                        String(question.minLength ?? 0)
                      )
                    : dict.answerInput.openText.minLengthInfoRecommended.replace(
                        '{{count}}',
                        String(question.minLength ?? 0)
                      )}
                </Badge>
              )}

              {lengthExceeded && (
                <Badge className="bg-gradient-to-r from-red-500 to-rose-600 text-white animate-pulse">
                  <AlertCircle className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.maxLengthExceeded}
                </Badge>
              )}

              {textValue.length > 50 && !lengthExceeded && (
                <Badge
                  variant="outline"
                  className="border-green-300 bg-green-50 text-green-700"
                >
                  <Flame className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.writingGreat}
                </Badge>
              )}
            </div>

            {question.description && (
              <Collapsible
                open={isCollapsibleOpen}
                onOpenChange={setIsCollapsibleOpen}
              >
                <CollapsibleTrigger asChild>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="w-full flex items-center justify-between px-4 py-3 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 rounded-xl transition-all border-2 border-dashed border-purple-200"
                  >
                    <div className="flex items-center gap-2">
                      <Sparkles className="h-5 w-5 text-purple-500" />
                      <span className="font-semibold text-purple-900">
                        {dict.answerInput.openText.tipsButton}
                      </span>
                    </div>
                    <motion.div
                      animate={{ rotate: isCollapsibleOpen ? 180 : 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <ChevronDown className="h-5 w-5 text-purple-500" />
                    </motion.div>
                  </Button>
                </CollapsibleTrigger>
                <CollapsibleContent>
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="mt-3 p-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200"
                  >
                    <div className="prose prose-sm max-w-none text-purple-900">
                      {question.description}
                    </div>
                  </motion.div>
                </CollapsibleContent>
              </Collapsible>
            )}
          </div>
        );
      }

      case 'budgetAllocation': {
        const budgetValues = (internalValue as Record<string, number>) || {};
        const totalPointsRequired = question.totalPoints ?? 100;

        // Calculate totals
        const totalAllocated = Object.values(budgetValues).reduce(
          (sum, val) => sum + (Number(val) || 0),
          0
        );
        const remaining = totalPointsRequired - totalAllocated;

        // Determine status color
        let statusColor = 'text-blue-600';
        let statusBg = 'bg-blue-100';
        let statusBorder = 'border-blue-200';

        if (remaining === 0) {
          statusColor = 'text-green-600';
          statusBg = 'bg-green-100';
          statusBorder = 'border-green-200';
        } else if (remaining < 0) {
          statusColor = 'text-red-600';
          statusBg = 'bg-red-100';
          statusBorder = 'border-red-200';
        }

        return (
          <div className="space-y-5">
            {/* 1. Cleaner Summary Bar */}
            <div
              className={cn(
                'sticky top-0 z-20 flex items-center justify-between p-3 rounded-xl border-2 backdrop-blur-md shadow-sm transition-colors duration-300',
                statusBg,
                statusBorder
              )}
            >
              <div className="flex items-center gap-2">
                <div
                  className={cn('p-1.5 rounded-full bg-white/50', statusColor)}
                >
                  {remaining === 0 ? (
                    <CheckCircle className="w-5 h-5" />
                  ) : (
                    <Target className="w-5 h-5" />
                  )}
                </div>
                <span className={cn('font-bold text-sm', statusColor)}>
                  {remaining === 0
                    ? dict.answerInput.budgetAllocation.statusComplete
                    : remaining > 0
                      ? dict.answerInput.budgetAllocation.statusRemaining.replace(
                          '{{count}}',
                          remaining.toString()
                        )
                      : dict.answerInput.budgetAllocation.statusExceeded.replace(
                          '{{count}}',
                          Math.abs(remaining).toString()
                        )}
                </span>
              </div>
              <div className="text-xs font-semibold px-2 py-1 bg-white/60 rounded-md">
                {totalAllocated} / {totalPointsRequired}
              </div>
            </div>

            {/* 2. Simplified Category List */}
            <div className="grid gap-3">
              {question.categories?.map((category, index) => {
                const currentValue = budgetValues[category.value] || 0;

                const maxAllowed = Math.min(
                  totalPointsRequired,
                  currentValue + Math.max(0, remaining)
                );

                return (
                  <div
                    key={category.value}
                    className={cn(
                      'bg-white rounded-xl border-2 p-3 sm:p-4 transition-all duration-200',
                      currentValue > 0
                        ? 'border-blue-200 shadow-sm'
                        : 'border-gray-100 hover:border-gray-200'
                    )}
                  >
                    {/* Header: Label + Controls */}
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2 text-gray-700">
                        {category.icon && (
                          <span className="text-gray-400">{category.icon}</span>
                        )}
                        <span className="font-medium text-sm sm:text-base">
                          {category.label}
                        </span>
                      </div>

                      {/* Manual Controls (+/- buttons) */}
                      <div className="flex items-center gap-1">
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-7 w-7 rounded-full hover:bg-gray-100 text-gray-500"
                          onClick={() => {
                            const newVal = Math.max(0, currentValue - 1);
                            handleValueChange({
                              ...budgetValues,
                              [category.value]: newVal,
                            });
                          }}
                          disabled={currentValue <= 0}
                        >
                          <Minus className="w-3 h-3" />
                        </Button>

                        <Input
                          type="number"
                          value={currentValue.toString()}
                          min={0}
                          max={maxAllowed}
                          className={cn(
                            'w-16 h-8 text-center font-bold text-sm p-1', // ×¢×™×¦×•×‘ ×ž×•×ª×× ×œ×’×•×“×œ ×§×•×ž×¤×§×˜×™
                            currentValue > 0
                              ? 'bg-blue-50 text-blue-700 border-blue-200'
                              : 'bg-gray-50 text-gray-500 border-gray-200'
                          )}
                          onChange={(e) => {
                            // ×”×ž×¨×ª ×”×¢×¨×š ×œ×ž×¡×¤×¨ (×˜×™×¤×•×œ ×‘×ž×—×¨×•×–×ª ×¨×™×§×” ×›-0)
                            let newValue = parseInt(e.target.value);
                            if (isNaN(newValue)) newValue = 0;

                            // ×—×™×©×•×‘ ×”×ž×§×¡×™×ž×™×•× ×”××¤×©×¨×™ ×¢×‘×•×¨ ×©×“×” ×–×” ×¡×¤×¦×™×¤×™×ª
                            // (×”×¢×¨×š ×”× ×•×›×—×™ + ×ž×” ×©× ×•×ª×¨ ×‘×ª×§×¦×™×‘ ×”×›×œ×œ×™)
                            const maxForThisField = currentValue + remaining;

                            // ×•×™×“×•× ×©×”×¢×¨×š ×œ× ×—×•×¨×’ ×ž×”×’×‘×•×œ×•×ª
                            if (newValue < 0) newValue = 0;
                            if (newValue > maxForThisField)
                              newValue = maxForThisField;

                            handleValueChange({
                              ...budgetValues,
                              [category.value]: newValue,
                            });
                          }}
                          // ×ž×•× ×¢ ×©×œ×™×—×ª ×˜×•×¤×¡ ×‘×œ×—×™×¦×” ×¢×œ Enter
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') e.preventDefault();
                          }}
                        />

                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-7 w-7 rounded-full hover:bg-gray-100 text-gray-500"
                          onClick={() => {
                            if (remaining > 0) {
                              const newVal = currentValue + 1;
                              handleValueChange({
                                ...budgetValues,
                                [category.value]: newVal,
                              });
                            }
                          }}
                          disabled={remaining <= 0}
                        >
                          <Plus className="w-3 h-3" />
                        </Button>
                      </div>
                    </div>

                    {/* Slider */}
                    <Slider
                      value={[currentValue]}
                      min={0}
                      max={maxAllowed}
                      step={1}
                      onValueChange={(val) => {
                        handleValueChange({
                          ...budgetValues,
                          [category.value]: val[0],
                        });
                      }}
                      className={cn(
                        'cursor-pointer',
                        currentValue > 0
                          ? '[&>.bg-primary]:bg-blue-500'
                          : '[&>.bg-primary]:bg-gray-300'
                      )}
                    />
                  </div>
                );
              })}
            </div>
            {/* Reset Button */}
            {totalAllocated > 0 && (
              <div className="flex justify-end">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={handleClear}
                  className="text-gray-400 hover:text-red-500 text-xs gap-1"
                >
                  <Trash2 className="w-3 h-3" />
                  {dict.answerInput.budgetAllocation.resetButton}
                </Button>
              </div>
            )}

            <AnimatePresence>
              {validationError && (
                <motion.div
                  initial={{ opacity: 0, y: -10, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, y: -10, scale: 0.95 }}
                  className="flex items-center gap-3 p-4 bg-red-50 border-2 border-red-200 rounded-xl"
                >
                  <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                  <p className="text-sm font-medium text-red-700">
                    {validationError}
                  </p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      default:
        console.warn('Unsupported question type:', question.type);
        return (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="p-6 bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-2xl"
          >
            <div className="flex items-start gap-3">
              <div className="p-2 bg-amber-500 rounded-lg">
                <AlertCircle className="w-5 h-5 text-white" />
              </div>
              <div>
                <p className="font-bold text-amber-900 mb-1">
                  {dict.answerInput.unsupportedType.replace(
                    '{{type}}',
                    question.type
                  )}
                </p>
                <p className="text-sm text-amber-700">
                  {dict.answerInput.supportContactMessage}
                </p>
              </div>
            </div>
          </motion.div>
        );
    }
  };

  return (
    <div className={cn('space-y-4', className)}>
      {renderInput()}

      <style>{`
        @keyframes shimmer {
          0% {
            transform: translateX(-100%);
          }
          100% {
            transform: translateX(100%);
          }
        }

        @keyframes float {
          0%, 100% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(-10px);
          }
        }

        @keyframes pulse-glow {
          0%, 100% {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
          }
          50% {
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
          }
        }

        .animate-float {
          animation: float 3s ease-in-out infinite;
        }

        .animate-pulse-glow {
          animation: pulse-glow 2s ease-in-out infinite;
        }
      `}</style>
    </div>
  );
}
--- End of Content for AnswerInput.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\InteractiveScale.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/InteractiveScale.tsx
'use client';

import React, { useState, useCallback, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Star, Heart, ThumbsUp } from 'lucide-react';
import type { InteractiveScaleDict } from '@/types/dictionary';

// ×”×’×“×¨×•×ª ×”×¦×‘×¢×™× ×”×“×™× ×ž×™×•×ª ×¢×‘×•×¨ ×›×œ ×¢×•×œ×
type ThemeColor = 'sky' | 'rose' | 'purple' | 'teal' | 'amber';

const getThemeConfig = (themeColor: ThemeColor) => {
  const themes = {
    sky: {
      gradientStyle:
        'linear-gradient(to right, rgb(34 211 238), rgb(14 165 233), rgb(59 130 246))',
    },
    rose: {
      gradientStyle:
        'linear-gradient(to right, rgb(251 113 133), rgb(236 72 153), rgb(239 68 68))',
    },
    purple: {
      gradientStyle:
        'linear-gradient(to right, rgb(192 132 252), rgb(139 92 246), rgb(99 102 241))',
    },
    teal: {
      gradientStyle:
        'linear-gradient(to right, rgb(45 212 191), rgb(16 185 129), rgb(34 197 94))',
    },
    amber: {
      gradientStyle:
        'linear-gradient(to right, rgb(251 191 36), rgb(249 115 22), rgb(234 179 8))',
    },
  };
  return themes[themeColor] || themes.sky;
};

interface ScaleOption {
  value: number;
  label: string;
  description?: string;
  icon?: React.ReactNode;
}

interface InteractiveScaleProps {
  min?: number;
  max?: number;
  step?: number;
  defaultValue?: number;
  value?: number;
  onChange?: (value: number) => void;
  onComplete?: (value: number) => void;
  labels?: { min: string; max: string; middle?: string };
  descriptions?: { min?: string; max?: string; middle?: string };
  options?: ScaleOption[];
  mode?: 'numeric' | 'icons' | 'hearts' | 'stars' | 'thumbs';
  size?: 'sm' | 'md' | 'lg';
  showLabels?: boolean;
  showValue?: boolean;
  showTooltips?: boolean;
  isDisabled?: boolean;
  className?: string;
  required?: boolean;
  name?: string;
  error?: string;
  ariaLabelledby?: string;
  dict: InteractiveScaleDict;
  themeColor?: ThemeColor;
}

const defaultIcons = { stars: Star, hearts: Heart, thumbs: ThumbsUp };

export default function InteractiveScale({
  min = 1,
  max = 10,
  step = 1,
  defaultValue,
  value: controlledValue,
  onChange,
  onComplete,
  labels,
  options,
  mode = 'numeric',
  size = 'md',
  showLabels = true,
  showValue = true,
  showTooltips = true,
  isDisabled = false,
  className = '',
  required = false,
  name,
  error,
  dict,
  themeColor = 'sky',
}: InteractiveScaleProps) {
  const [internalValue, setInternalValue] = useState<number | null>(
    defaultValue || null
  );
  const [hoveredValue, setHoveredValue] = useState<number | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  const theme = getThemeConfig(themeColor);

  const value = controlledValue !== undefined ? controlledValue : internalValue;

  const handleValueChange = useCallback(
    (newValue: number) => {
      if (!isDisabled) {
        setInternalValue(newValue);
        onChange?.(newValue);
      }
    },
    [isDisabled, onChange]
  );

  const handleClick = useCallback(
    (clickedValue: number) => {
      handleValueChange(clickedValue);
      onComplete?.(clickedValue);
    },
    [handleValueChange, onComplete]
  );

  const handleKeyPress = useCallback(
    (event: React.KeyboardEvent, itemValue: number) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handleClick(itemValue);
      }
    },
    [handleClick]
  );

  const handleMouseMove = useCallback(
    (event: MouseEvent) => {
      if (isDragging && containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const width = rect.width;
        const percentage = Math.max(0, Math.min(1, x / width));
        const range = max - min;
        const newValue = Math.round((percentage * range) / step) * step + min;
        handleValueChange(newValue);
        setHoveredValue(newValue);
      }
    },
    [isDragging, min, max, step, handleValueChange]
  );

  const handleTouchMove = useCallback(
    (event: TouchEvent) => {
      if (isDragging && containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        const touch = event.touches[0];
        const x = touch.clientX - rect.left;
        const width = rect.width;
        const percentage = Math.max(0, Math.min(1, x / width));
        const range = max - min;
        const newValue = Math.round((percentage * range) / step) * step + min;
        handleValueChange(newValue);
        setHoveredValue(newValue);
      }
    },
    [isDragging, min, max, step, handleValueChange]
  );

  useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('touchmove', handleTouchMove);
      window.addEventListener('mouseup', () => setIsDragging(false));
      window.addEventListener('touchend', () => setIsDragging(false));
    }
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('touchmove', handleTouchMove);
      window.removeEventListener('mouseup', () => setIsDragging(false));
      window.removeEventListener('touchend', () => setIsDragging(false));
    };
  }, [isDragging, handleMouseMove, handleTouchMove]);

  const getScaleItems = () => {
    if (options) return options;
    const items: ScaleOption[] = [];
    for (let i = min; i <= max; i += step) {
      const item: ScaleOption = { value: i, label: i.toString() };
      if (mode !== 'numeric') {
        const Icon = defaultIcons[mode as keyof typeof defaultIcons];
        item.icon = <Icon className="w-4 h-4 sm:w-5 sm:h-5" />;
      }
      items.push(item);
    }
    return items;
  };

  const scaleItems = getScaleItems();
  const activeValue = hoveredValue !== null ? hoveredValue : value;

  // ×’×•×“×œ×™× ×¨×¡×¤×•× ×¡×™×‘×™×™× - ×§×˜×Ÿ ×™×•×ª×¨ ×‘×ž×•×‘×™×™×œ
  const sizeClasses = {
    sm: 'h-7 sm:h-8 text-xs sm:text-sm',
    md: 'h-8 sm:h-10 text-sm sm:text-base',
    lg: 'h-10 sm:h-12 text-base sm:text-lg',
  };

  // ×—×™×©×•×‘ ×’×•×“×œ ×”×›×¤×ª×•×¨×™× ×œ×¤×™ ×ž×¡×¤×¨ ×”×¤×¨×™×˜×™×
  const getButtonSizeClasses = () => {
    if (scaleItems.length <= 5) {
      return 'w-10 h-10 sm:w-12 sm:h-12';
    } else if (scaleItems.length <= 7) {
      return 'w-8 h-8 sm:w-10 sm:h-10';
    } else {
      // ×¢×‘×•×¨ 8+ ×¤×¨×™×˜×™× - ×‘×ž×•×‘×™×™×œ ×ž×©×ª×ž×©×™× ×‘×’×•×“×œ ×’×ž×™×© ×©×ž×ª×—×œ×§ ×©×•×•×”
      // ×‘×“×¡×§×˜×•×¤ ×—×•×–×¨×™× ×œ×’×•×“×œ ×§×‘×•×¢
      return 'flex-1 h-7 min-w-0 sm:flex-none sm:w-8 sm:h-8';
    }
  };

  return (
    <div
      className={cn(
        'relative space-y-2 w-full',
        isDisabled && 'opacity-50 cursor-not-allowed',
        className
      )}
    >
      <div
        ref={containerRef}
        className={cn(
          'relative flex items-center justify-between',
          // ×¨×•×•×—×™× ×“×™× ×ž×™×™× ×œ×¤×™ ×ž×¡×¤×¨ ×”×¤×¨×™×˜×™×
          // ×‘×ž×•×‘×™×™×œ ×¢× ×”×¨×‘×” ×¤×¨×™×˜×™× - ×¨×•×•×— ×ž×™× ×™×ž×œ×™
          scaleItems.length <= 5
            ? 'gap-2 sm:gap-3'
            : scaleItems.length <= 7
              ? 'gap-1 sm:gap-2'
              : 'gap-0.5 sm:gap-1',
          sizeClasses[size]
        )}
        onMouseDown={() => !isDisabled && setIsDragging(true)}
        onTouchStart={() => !isDisabled && setIsDragging(true)}
      >
        {showLabels && labels && (
          <div className="absolute -top-6 left-0 right-0 flex justify-between text-xs sm:text-sm text-gray-500 px-1">
            <span className="text-right">{labels.min}</span>
            {labels.middle && (
              <span className="hidden sm:inline">{labels.middle}</span>
            )}
            <span className="text-left">{labels.max}</span>
          </div>
        )}
        <div className="relative flex-1 flex items-center justify-between w-full">
          <AnimatePresence>
            {scaleItems.map((item) => (
              <TooltipProvider key={item.value}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <motion.button
                      type="button"
                      style={
                        activeValue !== null && item.value <= activeValue
                          ? { background: theme.gradientStyle }
                          : undefined
                      }
                      className={cn(
                        'relative flex items-center justify-center',
                        // ×’×•×“×œ×™× ×“×™× ×ž×™×™× ×œ×¤×™ ×ž×¡×¤×¨ ×¤×¨×™×˜×™×
                        getButtonSizeClasses(),
                        'rounded-full transition-all duration-200',
                        'focus:outline-none focus:ring-2 focus:ring-offset-1 sm:focus:ring-offset-2',
                        'active:scale-95 touch-manipulation',
                        // ×˜×§×¡×˜ ×§×˜×Ÿ ×™×•×ª×¨ ×‘×ž×•×‘×™×™×œ ×œ×¡×§×™×™×œ×•×ª ××¨×•×›×•×ª
                        scaleItems.length > 7 && 'text-xs sm:text-sm',
                        activeValue !== null &&
                          item.value <= activeValue &&
                          'text-white shadow-md',
                        activeValue !== null &&
                          item.value > activeValue &&
                          'bg-gray-200 hover:bg-gray-300',
                        isDisabled && 'cursor-not-allowed'
                      )}
                      onMouseDown={(e) => {
                        e.stopPropagation();
                        handleClick(item.value);
                      }}
                      onTouchStart={(e) => {
                        e.stopPropagation();
                        handleClick(item.value);
                      }}
                      onKeyDown={(e) => handleKeyPress(e, item.value)}
                      onMouseEnter={() =>
                        !isDisabled && setHoveredValue(item.value)
                      }
                      onMouseLeave={() => setHoveredValue(null)}
                      disabled={isDisabled}
                      aria-label={dict.ariaLabel.replace(
                        '{{value}}',
                        item.value.toString()
                      )}
                      initial={{ scale: 0.8, opacity: 0 }}
                      animate={{ scale: 1, opacity: 1 }}
                      exit={{ scale: 0.8, opacity: 0 }}
                      transition={{ duration: 0.15 }}
                    >
                      {item.icon || item.label}
                    </motion.button>
                  </TooltipTrigger>
                  {showTooltips && item.description && (
                    <TooltipContent>
                      <p className="text-xs sm:text-sm">{item.description}</p>
                    </TooltipContent>
                  )}
                </Tooltip>
              </TooltipProvider>
            ))}
          </AnimatePresence>
        </div>
      </div>
      {showValue && value !== null && (
        <div className="text-center text-xs sm:text-sm text-gray-500 mt-2">
          {dict.selectedValue.replace('{{value}}', value.toString())}
        </div>
      )}
      {error && (
        <div className="text-xs sm:text-sm text-red-500 mt-1">{error}</div>
      )}
      {required && (
        <input
          type="hidden"
          name={name}
          value={value || ''}
          required
          aria-hidden="true"
        />
      )}
    </div>
  );
}
--- End of Content for InteractiveScale.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionCard.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { VisibilityToggleButton } from '@/components/ui/VisibilityToggleButton';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import {
  Bookmark,
  AlertCircle,
  HelpCircle,
  SkipForward,
  Star,
  Lightbulb,
  Save,
  Loader2,
  BookUser,
  Clock,
  TrendingUp,
} from 'lucide-react';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { motion, AnimatePresence } from 'framer-motion';
import type { Question, QuestionDepth } from '../types/types';
import { cn } from '@/lib/utils';
import type { QuestionCardDict } from '@/types/dictionary';

// --- Props Interface ---
interface QuestionCardProps {
  question: Question;
  depth: QuestionDepth;
  isRequired?: boolean;
  onSkip?: () => void;
  onBookmark?: () => void;
  onHelp?: () => void;
  className?: string;
  validationError?: string;
  isDisabled?: boolean;
  children?: React.ReactNode;
  locale?: 'he' | 'en';
  themeColor?: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
  isVisible: boolean;
  onVisibilityChange: (isVisible: boolean) => void;
  onSave?: () => void;
  isSaving?: boolean;
  dict: QuestionCardDict;
  currentQuestionNumber?: number;
  totalQuestions?: number;
  estimatedTimeMinutes?: number;
}

// --- Helper Functions ---
const getThemeConfig = (themeColor: string) => {
  const themes = {
    sky: {
      gradient: 'from-sky-400 to-blue-500',
      lightGradient: 'from-sky-50 via-blue-50 to-white',
      glowColor: 'shadow-sky-400/30',
    },
    rose: {
      gradient: 'from-rose-400 to-red-500',
      lightGradient: 'from-rose-50 via-red-50 to-white',
      glowColor: 'shadow-rose-400/30',
    },
    purple: {
      gradient: 'from-purple-400 to-indigo-500',
      lightGradient: 'from-purple-50 via-indigo-50 to-white',
      glowColor: 'shadow-purple-400/30',
    },
    teal: {
      gradient: 'from-teal-400 to-emerald-500',
      lightGradient: 'from-teal-50 via-emerald-50 to-white',
      glowColor: 'shadow-teal-400/30',
    },
    amber: {
      gradient: 'from-amber-400 to-orange-500',
      lightGradient: 'from-amber-50 via-orange-50 to-white',
      glowColor: 'shadow-amber-400/30',
    },
  };
  return themes[themeColor as keyof typeof themes] || themes.sky;
};

const getDepthIcon = (depth: QuestionDepth) => {
  switch (depth) {
    case 'BASIC':
      return <Star className="w-3.5 h-3.5" fill="currentColor" />;
    case 'ADVANCED':
      return (
        <>
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
        </>
      );
    case 'EXPERT':
      return (
        <>
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
        </>
      );
    default:
      return <Star className="w-3.5 h-3.5" fill="currentColor" />;
  }
};

// --- Main Component ---
export default function QuestionCard({
  question,
  depth,
  isRequired = false,
  onSkip,
  onBookmark,
  onHelp,
  className = '',
  validationError,
  isDisabled = false,
  children,
  locale = 'he',
  themeColor = 'sky',
  isVisible,
  onVisibilityChange,
  onSave,
  isSaving,
  dict,
  currentQuestionNumber,
  totalQuestions,
  estimatedTimeMinutes = 5,
}: QuestionCardProps) {
  // --- State and Variables ---
  const [isBookmarked, setIsBookmarked] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [showBenefit, setShowBenefit] = useState(true);

  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);

  // --- Effects ---
  useEffect(() => {
    if (currentQuestionNumber && currentQuestionNumber % 5 === 0) {
      setShowBenefit(true);
      const timer = setTimeout(() => setShowBenefit(false), 8000);
      return () => clearTimeout(timer);
    } else {
      setShowBenefit(false);
    }
  }, [currentQuestionNumber]);

  // --- Animation Variants ---
  const cardVariants = {
    initial: { opacity: 0, y: 30, scale: 0.98 },
    animate: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: { duration: 0.5, ease: [0.25, 1, 0.5, 1] },
    },
    exit: { opacity: 0, y: -20, transition: { duration: 0.3 } },
  };

  const currentBenefit =
    dict.benefitMessages[
      Math.floor(
        ((currentQuestionNumber || 0) / 5) % dict.benefitMessages.length
      )
    ];
  const progressPercentage =
    currentQuestionNumber && totalQuestions
      ? Math.round((currentQuestionNumber / totalQuestions) * 100)
      : 0;

  return (
    <motion.div
      key={question.id}
      initial="initial"
      animate="animate"
      exit="exit"
      variants={cardVariants}
      className="relative"
    >
      {/* Main Card */}
      <div
        role="region"
        aria-labelledby={question.id}
        className={cn(
          'relative overflow-hidden rounded-3xl bg-white/90 backdrop-blur-sm shadow-xl border border-white/60 transition-all duration-500',
          isDisabled && 'opacity-75 cursor-not-allowed',
          className
        )}
      >
        {/* Top Gradient Bar */}
        <div className={cn('h-1.5 w-full bg-gradient-to-r', theme.gradient)} />

        {/* Decorative Orbs */}
        <div
          className={cn(
            'absolute top-4 w-40 h-40 rounded-full bg-gradient-to-br opacity-20 blur-3xl pointer-events-none',
            theme.lightGradient,
            isRTL ? 'left-[-20px]' : 'right-[-20px]'
          )}
        />

        {/* Header Section */}
        <div className="relative px-6 sm:px-8 pt-6 pb-4 space-y-4">
          {/* Progress Bar */}
          {currentQuestionNumber && totalQuestions && (
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex items-center gap-3 mb-4"
            >
              <div className="flex-1">
                <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${progressPercentage}%` }}
                    transition={{ duration: 0.8, ease: 'easeOut' }}
                    className="h-full bg-gradient-to-r from-teal-400 to-orange-400"
                  />
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-sm font-bold text-gray-700">
                  {currentQuestionNumber}/{totalQuestions}
                </span>
              </div>
            </motion.div>
          )}

          {/* Badges Row */}
          <div className="flex items-center justify-between">
            <div
              className={cn(
                'flex flex-wrap items-center gap-2',
                isRTL && 'flex-row-reverse'
              )}
            >
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger>
                    <Badge
                      className={cn(
                        'flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r text-white border-0 shadow-sm transition-all hover:shadow-md',
                        theme.gradient,
                        theme.glowColor
                      )}
                    >
                      {getDepthIcon(depth)}
                      <span className="text-xs font-bold tracking-wide">
                        {dict.depthLabels[depth]}
                      </span>
                    </Badge>
                  </TooltipTrigger>
                  <TooltipContent
                    side="bottom"
                    className="max-w-xs bg-white/95 backdrop-blur-sm"
                  >
                    <p className="text-sm font-medium">
                      {dict.depthDescriptions[depth]}
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>

              {isRequired && (
                <Badge className="bg-gradient-to-r from-rose-500 to-red-600 text-white text-xs font-semibold px-3 py-1.5 border-0 shadow-sm">
                  <span className="relative flex h-2 w-2 mr-1.5">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                  </span>
                  {dict.requiredBadge}
                </Badge>
              )}

              {estimatedTimeMinutes && (
                <Badge
                  variant="outline"
                  className="flex items-center gap-1.5 text-xs border-gray-200 bg-white/50 text-gray-600 backdrop-blur-sm"
                >
                  <Clock className="w-3.5 h-3.5" />
                  <span>
                    {dict.estimatedTime.replace(
                      '{{minutes}}',
                      String(estimatedTimeMinutes)
                    )}
                  </span>
                </Badge>
              )}
            </div>

            {/* Action Buttons (Help/Bookmark) */}
            <div className="flex items-center gap-1">
              {onBookmark && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setIsBookmarked(!isBookmarked)}
                        className={cn(
                          'h-9 w-9 rounded-xl transition-all duration-300',
                          isBookmarked
                            ? 'text-orange-500 bg-orange-50'
                            : 'text-gray-400 hover:bg-gray-100'
                        )}
                      >
                        <Bookmark
                          className="w-5 h-5"
                          fill={isBookmarked ? 'currentColor' : 'none'}
                        />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {isBookmarked
                          ? dict.tooltips.removeBookmark
                          : dict.tooltips.addBookmark}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}

              {question.metadata?.helpText && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setShowHelp(!showHelp)}
                        className={cn(
                          'h-9 w-9 rounded-xl transition-all duration-300',
                          showHelp
                            ? 'text-teal-600 bg-teal-50'
                            : 'text-gray-400 hover:bg-gray-100'
                        )}
                      >
                        <HelpCircle className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {showHelp
                          ? dict.tooltips.hideHelp
                          : dict.tooltips.showHelp}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}
            </div>
          </div>

          {/* Question Text */}
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1, duration: 0.4 }}
          >
            <h2
              id={question.id}
              className={cn(
                'text-2xl sm:text-3xl font-bold text-gray-800 leading-tight mt-2',
                isRTL ? 'text-right' : 'text-left'
              )}
            >
              {question.question}
            </h2>
          </motion.div>
        </div>

        {/* Content Section */}
        <div className="relative px-6 sm:px-8 pb-6 space-y-6">
          <AnimatePresence>
            {showHelp && question.metadata?.helpText && (
              <motion.div
                initial={{ opacity: 0, height: 0, y: -10 }}
                animate={{ opacity: 1, height: 'auto', y: 0 }}
                exit={{ opacity: 0, height: 0, y: -10 }}
                transition={{ duration: 0.3 }}
              >
                <div className="rounded-2xl p-4 border bg-teal-50/50 border-teal-100">
                  <div
                    className={cn(
                      'flex items-start gap-3',
                      isRTL && 'flex-row-reverse'
                    )}
                  >
                    <div className="flex-shrink-0 p-1.5 rounded-lg bg-teal-100 text-teal-600">
                      <Lightbulb className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-medium text-teal-800 leading-relaxed">
                        {question.metadata.helpText}
                      </p>
                    </div>
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Validation Error */}
          <AnimatePresence>
            {validationError && (
              <motion.div
                initial={{ opacity: 0, height: 0, y: -10 }}
                animate={{ opacity: 1, height: 'auto', y: 0 }}
                exit={{ opacity: 0, height: 0, y: -10 }}
                transition={{ duration: 0.3 }}
              >
                <Alert
                  role="alert"
                  className="bg-rose-50 border-rose-200 text-rose-900"
                >
                  <div
                    className={cn(
                      'flex items-center gap-3',
                      isRTL && 'flex-row-reverse'
                    )}
                  >
                    <AlertCircle className="h-5 w-5 text-rose-600 flex-shrink-0" />
                    <AlertDescription className="text-sm font-medium">
                      {validationError}
                    </AlertDescription>
                  </div>
                </Alert>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Answer Input Container */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.2, duration: 0.4 }}
            className="relative"
          >
            {children}
          </motion.div>
        </div>

        {/* Encouragement Footer */}
        <AnimatePresence>
          {showBenefit &&
            currentQuestionNumber &&
            currentQuestionNumber % 5 === 0 && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="bg-orange-50/50 border-t border-orange-100 px-6 py-3"
              >
                <div className="flex items-center justify-center gap-2 text-orange-700">
                  <TrendingUp className="w-4 h-4" />
                  <span className="text-sm font-semibold">
                    {currentBenefit}
                  </span>
                </div>
              </motion.div>
            )}
        </AnimatePresence>

        {/* Card Footer */}
        <div className="relative px-6 sm:px-8 py-4 bg-gray-50/80 border-t border-gray-100 flex justify-between items-center backdrop-blur-sm">
          <div className="flex items-center gap-2">
            <VisibilityToggleButton
              isVisible={isVisible}
              onToggle={() => onVisibilityChange(!isVisible)}
              disabled={isDisabled}
              visibleText={dict.visibilityButton.visible}
              hiddenText={dict.visibilityButton.hidden}
            />

            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Link
                    href="/profile?tab=questionnaire"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-9 w-9 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                    >
                      <BookUser className="w-4 h-4" />
                    </Button>
                  </Link>
                </TooltipTrigger>
                <TooltipContent>
                  <p className="text-sm">{dict.tooltips.viewProfile}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>

          <div className="flex items-center gap-2">
            {onSave && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-9 w-9 rounded-xl text-teal-600 hover:bg-teal-50"
                      onClick={onSave}
                      disabled={isSaving || isDisabled}
                    >
                      {isSaving ? (
                        <Loader2 className="w-4 h-4 animate-spin" />
                      ) : (
                        <Save className="w-4 h-4" />
                      )}
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      {isSaving
                        ? dict.tooltips.saveProgressSaving
                        : dict.tooltips.saveProgress}
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}

            {onSkip && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onSkip}
                disabled={isRequired || isDisabled}
                className={cn(
                  'rounded-xl px-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100',
                  isRequired && 'opacity-50 cursor-not-allowed'
                )}
              >
                {isRequired ? (
                  <span className="text-xs">{dict.skipButton.required}</span>
                ) : (
                  <div className="flex items-center gap-1.5">
                    <span className="text-sm">{dict.skipButton.skip}</span>
                    <SkipForward className="w-4 h-4" />
                  </div>
                )}
              </Button>
            )}
          </div>
        </div>
      </div>
    </motion.div>
  );
}
--- End of Content for QuestionCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionnaireCompletion.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionnaireCompletion.tsx
'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  Send,
  CheckCircle2,
  BookUser,
  Loader2,
  Trophy,
  Zap,
  Award,
  Star,
  Target,
  Clock,
  ArrowRight,
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import type { QuestionnaireCompletionDict } from '@/types/dictionary';

interface QuestionnaireCompletionProps {
  onSendToMatching: () => void;
  isLoading?: boolean;
  isLoggedIn?: boolean;
  dict: QuestionnaireCompletionDict;
  // ×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×¤×¦×™×•× ×œ×™×•×ª
  totalQuestions?: number;
  answeredQuestions?: number;
  timeSpentMinutes?: number;
  worldsCompleted?: number;
  locale?: 'he' | 'en';
}

// Confetti Component
const Confetti: React.FC = () => {
  const confettiColors = [
    'bg-red-500',
    'bg-blue-500',
    'bg-yellow-500',
    'bg-green-500',
    'bg-purple-500',
    'bg-pink-500',
    'bg-orange-500',
    'bg-cyan-500',
  ];

  const confettiPieces = Array.from({ length: 50 }, (_, i) => ({
    id: i,
    left: Math.random() * 100,
    delay: Math.random() * 2,
    duration: 3 + Math.random() * 2,
    color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
    rotation: Math.random() * 360,
  }));

  return (
    <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
      {confettiPieces.map((piece) => (
        <motion.div
          key={piece.id}
          className={cn('absolute w-3 h-3 rounded-sm', piece.color)}
          initial={{
            top: '-5%',
            left: `${piece.left}%`,
            rotate: 0,
            opacity: 1,
          }}
          animate={{
            top: '105%',
            rotate: piece.rotation * 3,
            opacity: 0,
          }}
          transition={{
            duration: piece.duration,
            delay: piece.delay,
            ease: 'easeIn',
          }}
        />
      ))}
    </div>
  );
};

// Achievement Badge Component
const AchievementBadge: React.FC<{
  icon: React.ReactNode;
  title: string;
  description: string;
  delay: number;
}> = ({ icon, title, description, delay }) => {
  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.8, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      transition={{ delay, duration: 0.5, type: 'spring', stiffness: 200 }}
      className="flex items-start gap-3 p-4 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-white shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105"
    >
      <div className="flex-shrink-0 p-2 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-md">
        {icon}
      </div>
      <div className="flex-1 min-w-0">
        <h4 className="font-bold text-gray-800 text-sm">{title}</h4>
        <p className="text-xs text-gray-600 mt-0.5">{description}</p>
      </div>
    </motion.div>
  );
};

// Stats Card Component
const StatsCard: React.FC<{
  icon: React.ReactNode;
  value: string | number;
  label: string;
  gradient: string;
  delay: number;
}> = ({ icon, value, label, gradient, delay }) => {
  const [count, setCount] = useState(0);
  const finalValue = typeof value === 'number' ? value : parseInt(value) || 0;

  useEffect(() => {
    if (typeof value === 'number') {
      let start = 0;
      const duration = 2000;
      const increment = finalValue / (duration / 16);
      const timer = setInterval(() => {
        start += increment;
        if (start >= finalValue) {
          setCount(finalValue);
          clearInterval(timer);
        } else {
          setCount(Math.floor(start));
        }
      }, 16);
      return () => clearInterval(timer);
    }
  }, [value, finalValue]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 30 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay, duration: 0.6, type: 'spring' }}
      className="relative overflow-hidden"
    >
      <div
        className={cn(
          'relative p-6 rounded-3xl bg-gradient-to-br',
          gradient,
          'text-white shadow-2xl border-2 border-white/20'
        )}
      >
        {/* Background decoration */}
        <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full blur-2xl" />
        <div className="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full blur-xl" />

        <div className="relative z-10">
          <div className="flex items-center justify-between mb-3">
            <div className="p-2 bg-white/20 rounded-xl backdrop-blur-sm">
              {icon}
            </div>
          </div>
          <div className="text-4xl font-bold mb-1">
            {typeof value === 'number' ? count : value}
          </div>
          <div className="text-sm font-medium text-white/90">{label}</div>
        </div>
      </div>
    </motion.div>
  );
};

const QuestionnaireCompletion: React.FC<QuestionnaireCompletionProps> = ({
  onSendToMatching,
  isLoading = false,
  isLoggedIn = false,
  dict,
  totalQuestions = 0,
  answeredQuestions = 0,
  timeSpentMinutes = 0,
  locale = 'he',
}) => {
  const [showConfetti, setShowConfetti] = useState(false);
  const [showContent, setShowContent] = useState(false);
  const isRTL = locale === 'he';

  useEffect(() => {
    // Show confetti immediately
    setShowConfetti(true);
    // Show content after a brief delay
    setTimeout(() => setShowContent(true), 300);
    // Hide confetti after 4 seconds
    setTimeout(() => setShowConfetti(false), 4000);
  }, []);

  const completionPercentage = totalQuestions
    ? Math.round((answeredQuestions / totalQuestions) * 100)
    : 100;

  const achievements = [
    {
      icon: <CheckCircle2 className="w-5 h-5" />,
      title: dict.achievements.completed.title,
      description: dict.achievements.completed.description,
    },
    {
      icon: <Zap className="w-5 h-5" />,
      title: dict.achievements.speed.title,
      description: dict.achievements.speed.description.replace(
        '{{minutes}}',
        timeSpentMinutes.toString()
      ),
    },
    {
      icon: <Target className="w-5 h-5" />,
      title: dict.achievements.profile.title,
      description: dict.achievements.profile.description,
    },
  ];

  return (
    <div
      className="min-h-screen relative overflow-hidden"
      dir={isRTL ? 'rtl' : 'ltr'}
    >
      {/* Background Gradient */}
      <div className="fixed inset-0 bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50 -z-10" />

      {/* Animated Background Elements */}
      <div className="fixed inset-0 -z-10 overflow-hidden">
        <motion.div
          animate={{
            scale: [1, 1.2, 1],
            rotate: [0, 90, 0],
            opacity: [0.3, 0.5, 0.3],
          }}
          transition={{ duration: 20, repeat: Infinity }}
          className="absolute -top-1/2 -left-1/2 w-full h-full bg-gradient-to-br from-cyan-200 to-blue-300 rounded-full blur-3xl"
        />
        <motion.div
          animate={{
            scale: [1, 1.3, 1],
            rotate: [0, -90, 0],
            opacity: [0.3, 0.5, 0.3],
          }}
          transition={{ duration: 25, repeat: Infinity }}
          className="absolute -bottom-1/2 -right-1/2 w-full h-full bg-gradient-to-br from-pink-200 to-rose-300 rounded-full blur-3xl"
        />
      </div>

      {/* Confetti */}
      <AnimatePresence>{showConfetti && <Confetti />}</AnimatePresence>

      {/* Main Content */}
      <div className="relative z-10 max-w-5xl mx-auto px-4 py-12">
        <AnimatePresence>
          {showContent && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.5 }}
              className="space-y-8"
            >
              {/* Hero Section */}
              <motion.div
                initial={{ opacity: 0, y: -50, scale: 0.9 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                transition={{ duration: 0.7, type: 'spring', stiffness: 100 }}
                className="text-center space-y-6"
              >
                {/* Trophy Icon with Pulse */}
                <motion.div
                  animate={{
                    scale: [1, 1.1, 1],
                    rotate: [0, 5, -5, 0],
                  }}
                  transition={{
                    duration: 2,
                    repeat: Infinity,
                    repeatType: 'reverse',
                  }}
                  className="inline-block"
                >
                  <div className="relative">
                    <div className="absolute inset-0 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full blur-xl opacity-50" />
                    <div className="relative p-8 bg-gradient-to-br from-amber-400 via-orange-500 to-red-500 rounded-full shadow-2xl">
                      <Trophy
                        className="w-20 h-20 text-white"
                        strokeWidth={2.5}
                      />
                    </div>
                  </div>
                </motion.div>

                {/* Title */}
                <div className="space-y-3">
                  <motion.h1
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3, duration: 0.6 }}
                    className="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600"
                  >
                    {dict.title}
                  </motion.h1>
                  <motion.p
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.5, duration: 0.6 }}
                    className="text-xl md:text-2xl text-gray-700 font-medium max-w-2xl mx-auto leading-relaxed"
                  >
                    {isLoggedIn
                      ? dict.loggedInDescription
                      : dict.guestDescription}
                  </motion.p>
                </div>
              </motion.div>

              {/* Stats Grid */}
              {totalQuestions > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <StatsCard
                    icon={<Star className="w-6 h-6" />}
                    value={completionPercentage}
                    label={dict.stats.completion}
                    gradient="from-purple-500 via-pink-500 to-rose-500"
                    delay={0.7}
                  />
                  <StatsCard
                    icon={<CheckCircle2 className="w-6 h-6" />}
                    value={answeredQuestions}
                    label={dict.stats.answered}
                    gradient="from-cyan-500 via-blue-500 to-indigo-500"
                    delay={0.9}
                  />
                  <StatsCard
                    icon={<Clock className="w-6 h-6" />}
                    value={`${timeSpentMinutes}'`}
                    label={dict.stats.time}
                    gradient="from-emerald-500 via-teal-500 to-green-500"
                    delay={1.1}
                  />
                </div>
              )}

              {/* Achievements Section */}
              <motion.div
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 1.3, duration: 0.6 }}
                className="bg-white/40 backdrop-blur-md rounded-3xl p-8 border-2 border-white shadow-2xl"
              >
                <div className="flex items-center gap-3 mb-6">
                  <div className="p-3 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl shadow-lg">
                    <Award className="w-6 h-6 text-white" />
                  </div>
                  <h2 className="text-2xl font-bold text-gray-800">
                    {dict.unlocksTitle}
                  </h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {achievements.map((achievement, index) => (
                    <AchievementBadge
                      key={index}
                      {...achievement}
                      delay={1.5 + index * 0.2}
                    />
                  ))}
                </div>
              </motion.div>

              {/* CTA Section */}
              <motion.div
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 2.1, duration: 0.6 }}
                className="bg-white/60 backdrop-blur-lg rounded-3xl p-8 md:p-10 border-2 border-white shadow-2xl"
              >
                {isLoggedIn ? (
                  <div className="space-y-6">
                    <div className="text-center space-y-2">
                      <p className="text-lg font-semibold text-gray-800">
                        {dict.loggedInContent.prompt}
                      </p>
                      <p className="text-gray-600">
                        {dict.loggedInContent.promptSubtitle}
                      </p>
                    </div>

                    <div className="flex flex-col sm:flex-row gap-4 max-w-2xl mx-auto">
                      <Button
                        onClick={onSendToMatching}
                        disabled={isLoading}
                        size="lg"
                        className={cn(
                          'flex-1 h-14 text-lg font-bold rounded-2xl shadow-xl transition-all duration-300',
                          'bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600',
                          'hover:from-purple-700 hover:via-pink-700 hover:to-rose-700',
                          'hover:shadow-2xl hover:scale-105',
                          'disabled:opacity-50 disabled:cursor-not-allowed'
                        )}
                      >
                        {isLoading ? (
                          <>
                            <Loader2 className="w-6 h-6 animate-spin" />
                            <span className="mr-2">
                              {dict.loggedInContent.sendingButton}
                            </span>
                          </>
                        ) : (
                          <>
                            <Send className="w-6 h-6" />
                            <span className="mr-2">
                              {dict.loggedInContent.sendButton}
                            </span>
                            <ArrowRight className="w-5 h-5" />
                          </>
                        )}
                      </Button>

                      <Link
                        href="/profile?tab=questionnaire"
                        className="flex-1"
                      >
                        <Button
                          variant="outline"
                          size="lg"
                          disabled={isLoading}
                          className="w-full h-14 text-lg font-semibold rounded-2xl border-2 bg-white hover:bg-gray-50 transition-all duration-300 hover:scale-105"
                        >
                          <BookUser className="w-6 h-6 text-blue-600" />
                          <span className="mr-2">
                            {dict.loggedInContent.reviewButton}
                          </span>
                        </Button>
                      </Link>
                    </div>
                  </div>
                ) : (
                  <div className="max-w-md mx-auto text-center space-y-6">
                    <p className="text-lg text-gray-700">
                      {isRTL
                        ? '×›×“×™ ×œ×”×ž×©×™×š ×•×œ×§×‘×œ ×”×ª××ž×•×ª, ×× × ×”×ª×—×‘×¨ ×œ×—×©×‘×•×Ÿ ×©×œ×š'
                        : 'To continue and receive matches, please log in to your account'}
                    </p>
                    <Button
                      onClick={onSendToMatching}
                      size="lg"
                      className="w-full h-14 text-lg font-bold rounded-2xl shadow-xl bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition-all duration-300 hover:scale-105"
                    >
                      <span className="mr-2">
                        {dict.guestContent.loginButton}
                      </span>
                      <ArrowRight className="w-5 h-5" />
                    </Button>
                  </div>
                )}
              </motion.div>

              {/* Decorative Elements */}
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 2.5, duration: 1 }}
                className="flex justify-center gap-4 text-4xl"
              >
                <motion.span
                  animate={{ rotate: [0, 15, -15, 0] }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  ðŸŽŠ
                </motion.span>
                <motion.span
                  animate={{ scale: [1, 1.2, 1] }}
                  transition={{ duration: 1.5, repeat: Infinity }}
                >
                  â¤ï¸
                </motion.span>
                <motion.span
                  animate={{ rotate: [0, -15, 15, 0] }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  ðŸŽ‰
                </motion.span>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Custom Styles */}
      <style>{`
        @keyframes shimmer {
          0% {
            background-position: -100% 0;
          }
          100% {
            background-position: 200% 0;
          }
        }
      `}</style>
    </div>
  );
};

export default QuestionnaireCompletion;
--- End of Content for QuestionnaireCompletion.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionnaireSyncer.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionnaireSyncer.tsx
'use client';

import { useEffect, useRef } from 'react';
import { useSession } from 'next-auth/react';
import { toast } from 'sonner';

export default function QuestionnaireSyncer() {
  const { data: session, status } = useSession();
  const isSyncing = useRef(false);

  useEffect(() => {
    const syncData = async () => {
      // 1. ×ª× ××™× ×œ×”×¤×¢×œ×ª ×”×¡× ×›×¨×•×Ÿ: ×ž×©×ª×ž×© ×ž×—×•×‘×¨ + ×œ× ×ž×¡× ×›×¨×Ÿ ×›×¨×’×¢
      if (
        status !== 'authenticated' ||
        !session?.user?.id ||
        isSyncing.current
      ) {
        return;
      }

      // 2. ×‘×“×™×§×” ×× ×™×© ×ž×™×“×¢ ×œ×•×§××œ×™
      const localDataString = localStorage.getItem('tempQuestionnaire');
      if (!localDataString) return;

      try {
        const localData = JSON.parse(localDataString);

        // ×‘×“×™×§×” ×©×”×ž×™×“×¢ ×”×œ×•×§××œ×™ ×ž×›×™×œ ×ª×•×›×Ÿ ××ž×™×ª×™
        if (!localData.answers || localData.answers.length === 0) {
          return;
        }

        isSyncing.current = true;
        console.log(
          '[QuestionnaireSyncer] Found local data for registered user. Syncing...'
        );

        // 3. ×¢×“×›×•×Ÿ ×”-ID ×©×œ ×”×ž×©×ª×ž×© ×‘×ž×™×“×¢ ×”×œ×•×§××œ×™ ×œ-ID ×”××ž×™×ª×™ ×ž×”×¡×©×Ÿ
        localData.userId = session.user.id;

        // 4. ×©×œ×™×—×” ×œ×©×¨×ª
        const response = await fetch('/api/questionnaire', {
          method: 'PUT', // ×©×™×ž×•×© ×‘-PUT ×›×¤×™ ×©×ž×•×’×“×¨ ×‘-API ×©×œ×š ×œ×¢×“×›×•×Ÿ/×™×¦×™×¨×”
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(localData),
        });

        if (!response.ok) {
          throw new Error('Failed to sync questionnaire data');
        }

        const result = await response.json();

        // 5. × ×™×§×•×™ ×”×œ×•×§××œ ×¡×˜×•×¨×’' ×¨×§ ×œ××—×¨ ×”×¦×œ×—×” ×•×•×“××™×ª
        localStorage.removeItem('tempQuestionnaire');

        console.log('[QuestionnaireSyncer] Sync successful:', result);
        toast.success('×”×ª×©×•×‘×•×ª ×©×œ×š ×œ×©××œ×•×Ÿ × ×©×ž×¨×• ×•×©×•×—×–×¨×• ×‘×”×¦×œ×—×”!');
      } catch (error) {
        console.error('[QuestionnaireSyncer] Sync failed:', error);
        // ×”×¢×¨×”: ×× ×—× ×• *×œ×* ×ž×•×—×§×™× ××ª ×”-localStorage ×‘×ž×§×¨×” ×©×œ ×©×’×™××”, ×›×“×™ ×œ× ×¡×•×ª ×©×•×‘ ×‘×¤×¢× ×”×‘××”
      } finally {
        isSyncing.current = false;
      }
    };

    syncData();
  }, [status, session]);

  // ×”×¨×›×™×‘ ×”×–×” ×œ× ×ž×¨× ×“×¨ ×›×œ×•×, ×”×•× ×¨×§ ×œ×•×’×™×§×”
  return null;
}
--- End of Content for QuestionnaireSyncer.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionsList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionsList.tsx
'use client';

import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  CheckCircle,
  AlertCircle,
  Circle,
  Sparkles,
  Star,
  Zap,
  CheckCircle2,
  AlertTriangle,
  Award,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import type {
  Question,
  QuestionnaireAnswer,
  AnswerValue,
  QuestionDepth,
} from '../types/types';
import { Badge } from '@/components/ui/badge';
import { motion, AnimatePresence } from 'framer-motion';
import type { QuestionsListDict } from '@/types/dictionary';

interface QuestionsListProps {
  locale: string;
  allQuestions: Question[];
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
  answers: QuestionnaireAnswer[];
  className?: string;
  onClose?: () => void;
  themeColor?: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
  dict: QuestionsListDict;
}

const getThemeConfig = (themeColor: string) => {
  const themes = {
    sky: {
      gradient: 'from-cyan-400 via-sky-500 to-blue-500',
      lightBg: 'from-cyan-50 to-blue-50',
      textColor: 'text-cyan-700',
      iconColor: 'text-cyan-600',
      borderColor: 'border-cyan-200',
      ringColor: 'ring-cyan-300',
      bgSoft: 'bg-cyan-50',
      shadowColor: 'shadow-cyan-200/50',
    },
    rose: {
      gradient: 'from-rose-400 via-pink-500 to-red-500',
      lightBg: 'from-rose-50 to-pink-50',
      textColor: 'text-rose-700',
      iconColor: 'text-rose-600',
      borderColor: 'border-rose-200',
      ringColor: 'ring-rose-300',
      bgSoft: 'bg-rose-50',
      shadowColor: 'shadow-rose-200/50',
    },
    purple: {
      gradient: 'from-purple-400 via-violet-500 to-indigo-500',
      lightBg: 'from-purple-50 to-indigo-50',
      textColor: 'text-purple-700',
      iconColor: 'text-purple-600',
      borderColor: 'border-purple-200',
      ringColor: 'ring-purple-300',
      bgSoft: 'bg-purple-50',
      shadowColor: 'shadow-purple-200/50',
    },
    teal: {
      gradient: 'from-teal-400 via-emerald-500 to-green-500',
      lightBg: 'from-teal-50 to-emerald-50',
      textColor: 'text-teal-700',
      iconColor: 'text-teal-600',
      borderColor: 'border-teal-200',
      ringColor: 'ring-teal-300',
      bgSoft: 'bg-teal-50',
      shadowColor: 'shadow-teal-200/50',
    },
    amber: {
      gradient: 'from-amber-400 via-orange-500 to-yellow-500',
      lightBg: 'from-amber-50 to-orange-50',
      textColor: 'text-amber-700',
      iconColor: 'text-amber-600',
      borderColor: 'border-amber-200',
      ringColor: 'ring-amber-300',
      bgSoft: 'bg-amber-50',
      shadowColor: 'shadow-amber-200/50',
    },
  };
  return themes[themeColor as keyof typeof themes] || themes.sky;
};

const QuestionsList: React.FC<QuestionsListProps> = ({
  allQuestions,
  currentQuestionIndex,
  setCurrentQuestionIndex,
  answers,
  locale = 'he',
  className = '',
  onClose,
  themeColor = 'sky',
  dict,
}) => {
  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);
  const [hoveredIndex, setHoveredIndex] = useState<number | null>(null);

  const findAnswer = (questionId: string): AnswerValue | undefined => {
    return answers.find((a) => a.questionId === questionId)?.value;
  };

  const isAnswerNotEmpty = (answer: AnswerValue | undefined): boolean => {
    if (answer === undefined || answer === null) return false;
    if (typeof answer === 'string' && answer.trim() === '') return false;
    if (Array.isArray(answer) && answer.length === 0) return false;
    if (
      typeof answer === 'object' &&
      !Array.isArray(answer) &&
      Object.keys(answer).length === 0
    )
      return false;
    return true;
  };

  const handleItemClick = (index: number) => {
    setCurrentQuestionIndex(index);
    onClose?.();
  };

  // ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
  const answeredCount = allQuestions.filter((q) =>
    isAnswerNotEmpty(findAnswer(q.id))
  ).length;
  const totalCount = allQuestions.length;
  const progressPercentage = Math.round((answeredCount / totalCount) * 100);

  // ×”×•×“×¢×ª ×ž×•×˜×™×‘×¦×™×” ×“×™× ×ž×™×ª ×ž×”×ž×™×œ×•×Ÿ
  const getMotivationalMessage = () => {
    if (progressPercentage >= 100) {
      return {
        emoji: 'ðŸŽ‰',
        title: dict.motivationalMessages.finish.title,
        subtitle: dict.motivationalMessages.finish.subtitle,
        color: 'from-green-500 to-emerald-500',
      };
    }
    if (progressPercentage >= 75) {
      return {
        emoji: 'ðŸ”¥',
        title: dict.motivationalMessages.threeQuarters.title,
        subtitle: dict.motivationalMessages.threeQuarters.subtitle,
        color: theme.gradient,
      };
    }
    if (progressPercentage >= 50) {
      return {
        emoji: 'â­',
        title: dict.motivationalMessages.half.title,
        subtitle: dict.motivationalMessages.half.subtitle,
        color: theme.gradient,
      };
    }
    if (progressPercentage >= 25) {
      return {
        emoji: 'ðŸš€',
        title: dict.motivationalMessages.quarter.title,
        subtitle: dict.motivationalMessages.quarter.subtitle,
        color: theme.gradient,
      };
    }
    return {
      emoji: 'ðŸ’ª',
      title: dict.motivationalMessages.start.title,
      subtitle: dict.motivationalMessages.start.subtitle,
      color: theme.gradient,
    };
  };

  const motivationalMessage = getMotivationalMessage();

  // ×× ×™×ž×¦×™×•×ª
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.03,
      },
    },
  };

  const itemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.3, ease: 'easeOut' },
    },
  };

  return (
    <ScrollArea className={cn('h-full', className)}>
      <div className="px-2 pb-2">
        {/* Summary Section - ×¡×˜×˜×™×¡×˜×™×§×•×ª */}
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4 }}
          className="flex-shrink-0 mb-4 space-y-4"
        >
          {/* Progress Stats */}
          <div className="bg-white rounded-2xl p-4 border-2 border-gray-100 shadow-md">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <div
                  className={cn(
                    'p-2 rounded-xl bg-gradient-to-br',
                    theme.gradient,
                    'text-white shadow-md'
                  )}
                >
                  <CheckCircle2 className="w-4 h-4" />
                </div>
                <div>
                  <div className="text-2xl font-bold text-gray-800">
                    {answeredCount}/{totalCount}
                  </div>
                  <div className="text-xs text-gray-600">
                    {dict.stats.answeredQuestions}
                  </div>
                </div>
              </div>
              <div className="text-center">
                <div className={cn('text-3xl font-bold', theme.textColor)}>
                  {progressPercentage}%
                </div>
                <div className="text-xs text-gray-500">
                  {dict.stats.complete}
                </div>
              </div>
            </div>

            {/* Progress Bar */}
            <div className="relative h-3 bg-gray-100 rounded-full overflow-hidden">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${progressPercentage}%` }}
                transition={{ duration: 1, ease: 'easeOut' }}
                className={cn(
                  'h-full bg-gradient-to-r',
                  theme.gradient,
                  'shadow-lg'
                )}
              />
            </div>
          </div>

          {/* Motivational Card */}
          <motion.div
            animate={{ scale: [1, 1.02, 1] }}
            transition={{ duration: 3, repeat: Infinity }}
            className={cn(
              'relative overflow-hidden rounded-2xl p-4 text-white shadow-lg',
              'bg-gradient-to-r',
              motivationalMessage.color
            )}
          >
            <div className="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full blur-2xl" />
            <div className="relative z-10 flex items-center gap-3">
              <div className="text-3xl">{motivationalMessage.emoji}</div>
              <div className="flex-1">
                <div className="font-bold text-lg">
                  {motivationalMessage.title}
                </div>
                <div className="text-sm text-white/90">
                  {motivationalMessage.subtitle}
                </div>
              </div>
            </div>
          </motion.div>

          {/* Quick Stats */}
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-3 border border-blue-100">
              <div className="flex items-center gap-2 mb-1">
                <Zap className="w-4 h-4 text-blue-600" />
                <span className="text-xs font-semibold text-blue-700">
                  {dict.stats.remaining}
                </span>
              </div>
              <div className="text-2xl font-bold text-blue-900">
                {totalCount - answeredCount}
              </div>
            </div>

            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-3 border border-green-100">
              <div className="flex items-center gap-2 mb-1">
                <Award className="w-4 h-4 text-green-600" />
                <span className="text-xs font-semibold text-green-700">
                  {dict.stats.done}
                </span>
              </div>
              <div className="text-2xl font-bold text-green-900">
                {answeredCount}
              </div>
            </div>
          </div>
        </motion.div>

        {/* Questions List */}
        <motion.div
          variants={containerVariants}
          initial="hidden"
          animate="visible"
          className="relative space-y-2"
          dir={isRTL ? 'rtl' : 'ltr'}
        >
          {/* Timeline Line */}
          <div
            className="absolute top-0 bottom-0 w-0.5 bg-gradient-to-b from-gray-200 via-gray-300 to-gray-200 rounded-full"
            style={isRTL ? { right: '1.75rem' } : { left: '1.75rem' }}
          />

          {allQuestions.map((q, index) => {
            const answer = findAnswer(q.id);
            const isAnswered = isAnswerNotEmpty(answer);
            const isCurrent = index === currentQuestionIndex;
            const isHovered = hoveredIndex === index;

            // ××™×™×§×•×Ÿ ×¡×˜×˜×•×¡
            let StatusIcon;
            let statusColor = '';
            let statusBgColor = '';

            if (isCurrent) {
              StatusIcon = Sparkles;
              statusColor = theme.iconColor;
              statusBgColor = cn('bg-gradient-to-br', theme.lightBg);
            } else if (isAnswered) {
              StatusIcon = CheckCircle2;
              statusColor = 'text-green-600';
              statusBgColor = 'bg-green-50';
            } else if (q.isRequired) {
              StatusIcon = AlertTriangle;
              statusColor = 'text-rose-500';
              statusBgColor = 'bg-rose-50';
            } else {
              StatusIcon = Circle;
              statusColor = 'text-gray-300';
              statusBgColor = 'bg-gray-50';
            }

            const depthMap: { [key in QuestionDepth]: number } = {
              BASIC: 1,
              ADVANCED: 2,
              EXPERT: 3,
            };
            const starCount = depthMap[q.depth] || 1;

            return (
              <motion.button
                key={q.id}
                variants={itemVariants}
                type="button"
                onClick={() => handleItemClick(index)}
                onMouseEnter={() => setHoveredIndex(index)}
                onMouseLeave={() => setHoveredIndex(null)}
                className={cn(
                  'relative w-full flex items-start text-start p-4 rounded-2xl transition-all duration-300 border-2 group',
                  'hover:shadow-lg active:scale-[0.98]',
                  isCurrent
                    ? cn(
                        'bg-gradient-to-br',
                        theme.lightBg,
                        theme.borderColor,
                        'ring-2',
                        theme.ringColor,
                        theme.shadowColor
                      )
                    : isAnswered
                    ? 'bg-white border-green-200 hover:border-green-300 hover:bg-green-50/30'
                    : q.isRequired
                    ? 'bg-white border-rose-200 hover:border-rose-300 hover:bg-rose-50/30'
                    : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                )}
                aria-current={isCurrent ? 'step' : undefined}
              >
                {/* Icon Container */}
                <motion.div
                  
                  
                  className={cn(
                    'flex-shrink-0 z-10 rounded-xl p-2.5 shadow-md border-2 border-white transition-all duration-300',
                    statusBgColor,
                    isHovered && 'shadow-lg'
                  )}
                >
                  <StatusIcon className={cn('h-5 w-5', statusColor)} />
                </motion.div>

                {/* Content */}
                <div className="flex-1 min-w-0 ml-3 space-y-2">
                  {/* Question Number & Text */}
                  <div>
                    <span
                      className={cn(
                        'inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold mr-2',
                        isCurrent
                          ? cn(
                              'bg-gradient-to-br',
                              theme.gradient,
                              'text-white'
                            )
                          : 'bg-gray-100 text-gray-600'
                      )}
                    >
                      {index + 1}
                    </span>
                    <p
                      className={cn(
                        'inline text-sm leading-relaxed transition-colors',
                        isCurrent
                          ? cn(theme.textColor, 'font-semibold')
                          : isAnswered
                          ? 'text-gray-700 font-medium'
                          : 'text-gray-600'
                      )}
                    >
                      {q.question}
                    </p>
                  </div>

                  {/* Badges Row */}
                  <div className="flex items-center gap-2 flex-wrap">
                    {/* Depth Badge */}
                    <Badge
                      variant="outline"
                      className={cn(
                        'text-[10px] font-medium border transition-all',
                        isCurrent
                          ? cn(
                              'bg-white/80 backdrop-blur-sm',
                              theme.borderColor,
                              theme.textColor
                            )
                          : 'bg-white border-gray-200 text-gray-600'
                      )}
                    >
                      {Array.from({ length: starCount }).map((_, i) => (
                        <Star
                          key={i}
                          className="w-2.5 h-2.5 inline mx-0.5"
                          fill="currentColor"
                        />
                      ))}
                      <span className="ml-1">
                        {dict.depthLabels[q.depth]}
                      </span>
                    </Badge>

                    {/* Required Badge */}
                    {q.isRequired && !isAnswered && (
                      <Badge
                        variant="outline"
                        className="text-[10px] font-semibold bg-rose-50 border-rose-300 text-rose-700"
                      >
                        <AlertCircle className="w-2.5 h-2.5 mr-1" />
                        {dict.badges.required}
                      </Badge>
                    )}

                    {/* Answered Badge */}
                    {isAnswered && (
                      <Badge
                        variant="outline"
                        className="text-[10px] font-semibold bg-green-50 border-green-300 text-green-700"
                      >
                        <CheckCircle className="w-2.5 h-2.5 mr-1" />
                        {dict.badges.answered}
                      </Badge>
                    )}
                  </div>
                </div>

                {/* Hover Indicator */}
                <AnimatePresence>
                  {isHovered && !isCurrent && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0 }}
                      animate={{ opacity: 1, scale: 1 }}
                      exit={{ opacity: 0, scale: 0 }}
                      transition={{ duration: 0.2 }}
                      className="absolute top-1/2 -translate-y-1/2"
                      style={isRTL ? { left: '8px' } : { right: '8px' }}
                    >
                      <div
                        className={cn(
                          'w-8 h-8 rounded-full flex items-center justify-center',
                          'bg-gradient-to-br',
                          theme.gradient,
                          'text-white shadow-lg'
                        )}
                      >
                        <Zap className="w-4 h-4" />
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* Current Pulse Effect */}
                {isCurrent && (
                  <motion.div
                    className={cn(
                      'absolute inset-0 rounded-2xl border-2',
                      theme.borderColor
                    )}
                    animate={{
                      scale: [1, 1.02, 1],
                      opacity: [0.5, 0.8, 0.5],
                    }}
                    transition={{
                      duration: 2,
                      repeat: Infinity,
                      ease: 'easeInOut',
                    }}
                  />
                )}
              </motion.button>
            );
          })}
        </motion.div>
      </div>
    </ScrollArea>
  );
};

export default QuestionsList;
--- End of Content for QuestionsList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\StandardizedLoadingSpinner.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Sparkles } from 'lucide-react';

// ==================== INTERFACES ====================

interface StandardizedLoadingSpinnerProps {
  text?: string;
  subtext?: string;
  className?: string;
}

// ==================== CINEMATIC TIMING ====================
const TIMING = {
  drawDuration: 0.1,
  fillDelay: 0.1,
  stagger: 0.05,
  assemblyStart: 0.4,
  particleDuration: 1.2,
  convergenceStart: 0.6,
  convergenceDuration: 1.8,
  liquidFillStart: 0.8,
  liquidFillDuration: 2.5,
};

// Custom easing curves
const EASING = {
  dramatic: [0.175, 0.885, 0.32, 1.275],
  settle: [0.23, 1, 0.32, 1],
  elastic: [0.68, -0.55, 0.265, 1.55],
  breath: [0.4, 0, 0.6, 1],
  liquid: [0.45, 0, 0.55, 1],
};

// ==================== HELPER COMPONENTS ====================

function FloatingParticles({ count = 20 }) {
  const [particles, setParticles] = useState<any[]>([]);

  useEffect(() => {
    setParticles(
      Array.from({ length: count }, (_, i) => ({
        id: i,
        x: Math.random() * 100,
        y: Math.random() * 100,
        size: Math.random() * 4 + 2,
        duration: Math.random() * 3 + 4,
        delay: Math.random() * 2,
        color:
          Math.random() > 0.5
            ? 'rgba(227, 138, 41, 0.4)'
            : 'rgba(54, 131, 104, 0.4)',
      }))
    );
  }, [count]);

  if (particles.length === 0) return null;

  return (
    <div className="absolute inset-0 overflow-hidden pointer-events-none">
      {particles.map((p) => (
        <motion.div
          key={p.id}
          className="absolute rounded-full"
          style={{
            left: `${p.x}%`,
            top: `${p.y}%`,
            width: p.size,
            height: p.size,
            backgroundColor: p.color,
            filter: 'blur(1px)',
          }}
          animate={{
            y: [0, -30, 0],
            x: [0, Math.sin(p.id) * 15, 0],
            opacity: [0.3, 0.7, 0.3],
            scale: [1, 1.2, 1],
          }}
          transition={{
            duration: p.duration,
            repeat: Infinity,
            delay: p.delay,
            ease: 'easeInOut',
          }}
        />
      ))}
    </div>
  );
}

function ParticleTrail({
  startX,
  startY,
  endX,
  endY,
  color,
  delay,
  count = 8,
}: any) {
  const [particles, setParticles] = useState<any[]>([]);

  useEffect(() => {
    setParticles(
      Array.from({ length: count }, (_, i) => ({
        id: i,
        offsetX: (Math.random() - 0.5) * 40,
        offsetY: (Math.random() - 0.5) * 40,
        size: Math.random() * 6 + 3,
        delay: delay + i * 0.05,
      }))
    );
  }, [count, delay]);

  if (particles.length === 0) return null;

  return (
    <>
      {particles.map((p) => (
        <motion.circle
          key={p.id}
          cx={startX}
          cy={startY}
          r={p.size}
          fill={color}
          initial={{ opacity: 0, cx: startX, cy: startY }}
          animate={{
            cx: [startX, endX + p.offsetX, endX + p.offsetX * 2],
            cy: [startY, endY + p.offsetY, endY + p.offsetY * 2],
            opacity: [0, 0.8, 0],
            r: [p.size, p.size * 0.5, 0],
          }}
          transition={{
            duration: TIMING.particleDuration,
            delay: p.delay,
            ease: EASING.settle,
          }}
        />
      ))}
    </>
  );
}

function ConvergingParticles({ phase }: { phase: string }) {
  const [particles, setParticles] = useState<any[]>([]);

  useEffect(() => {
    setParticles(
      Array.from({ length: 60 }, (_, i) => {
        const angle = (i / 60) * Math.PI * 2;
        const distance = 300 + Math.random() * 200;
        const centerX = 512;
        const centerY = 900;

        const isBottomArea = i > 30;
        const endX = centerX + (Math.random() - 0.5) * 180;
        const endY = isBottomArea
          ? 950 + Math.random() * 200
          : 750 + Math.random() * 200;

        return {
          id: i,
          startX: centerX + Math.cos(angle) * distance,
          startY: centerY + Math.sin(angle) * distance,
          endX: endX,
          endY: endY,
          size: Math.random() * 9 + 4,
          delay: Math.random() * 0.6,
          color:
            i % 3 === 0
              ? 'rgba(227, 138, 41, 0.85)'
              : i % 3 === 1
                ? 'rgba(54, 131, 104, 0.85)'
                : 'rgba(109, 186, 140, 0.85)',
        };
      })
    );
  }, []);

  if (phase !== 'assembled' || particles.length === 0) return null;

  return (
    <>
      {particles.map((p) => (
        <motion.circle
          key={p.id}
          r={p.size}
          fill={p.color}
          initial={{
            cx: p.startX,
            cy: p.startY,
            opacity: 0,
            scale: 0,
          }}
          animate={{
            cx: [p.startX, p.endX, p.endX],
            cy: [p.startY, p.endY, p.endY],
            opacity: [0, 0.85, 0.65],
            scale: [0, 1.3, 1],
          }}
          transition={{
            duration: TIMING.convergenceDuration,
            delay: TIMING.convergenceStart + p.delay,
            ease: EASING.dramatic,
            repeat: Infinity,
            repeatDelay: 0.3,
          }}
          filter="url(#particleGlow)"
        />
      ))}
    </>
  );
}

function ShimmerOverlay({ phase }: { phase: string }) {
  return (
    <motion.rect
      x="0"
      y="0"
      width="1024"
      height="1536"
      fill="url(#shimmerGradient)"
      initial={{ opacity: 0, x: -1024 }}
      animate={
        phase === 'assembled'
          ? {
              opacity: [0, 0.6, 0],
              x: [-1024, 1024, 1024],
            }
          : { opacity: 0 }
      }
      transition={{
        duration: 1.5,
        repeat: Infinity,
        repeatDelay: 3,
        ease: 'easeInOut',
      }}
    />
  );
}

// ==================== NEW: DUAL LIQUID FILL COMPONENT ====================

function DualLiquidFillEffect({ phase }: { phase: string }) {
  // Animation phase: 0 = bottom filling, 1 = top filling, 2 = top emptying, 3 = bottom emptying
  const [animPhase, setAnimPhase] = useState(0);
  const [bottomFill, setBottomFill] = useState(0);
  const [topFill, setTopFill] = useState(0);

  useEffect(() => {
    const phaseDuration = 2500; // Duration for each phase in ms

    let animationFrame: number;
    let startTime = Date.now();

    const animate = () => {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / phaseDuration, 1);
      // Smooth easing
      const eased =
        progress < 0.5
          ? 2 * progress * progress
          : 1 - Math.pow(-2 * progress + 2, 2) / 2;

      switch (animPhase) {
        case 0: // Bottom filling
          setBottomFill(eased * 100);
          setTopFill(0);
          break;
        case 1: // Top filling
          setBottomFill(100);
          setTopFill(eased * 100);
          break;
        case 2: // Top emptying
          setBottomFill(100);
          setTopFill(100 - eased * 100);
          break;
        case 3: // Bottom emptying
          setBottomFill(100 - eased * 100);
          setTopFill(0);
          break;
      }

      if (progress < 1) {
        animationFrame = requestAnimationFrame(animate);
      } else {
        // Move to next phase
        startTime = Date.now();
        setAnimPhase((prev) => (prev + 1) % 4);
      }
    };

    animationFrame = requestAnimationFrame(animate);

    return () => {
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
    };
  }, [animPhase]);

  // The white space paths
  const topInnerPath =
    'M529.065 626.084C577.139 619.835 552.774 567.948 540.471 541.073C538.219 536.154 527.51 501.438 526.785 500.754C514.707 528.562 464.621 626.326 529.065 626.084Z';

  // Bottom area path (the green leaf inner area)
  const bottomInnerPath =
    'M330.116 738.601C330.7 742.335 330.652 745.025 333.854 747.337C338.899 750.978 351.661 749.998 357.829 749.459C362.928 749.328 370.963 748.92 371.669 742.671C372.55 734.885 374.633 713.696 369.718 707.774C361.787 704.909 340.95 705.77 331.367 705.795C329.048 715.971 330.863 728.827 330.116 738.601Z';

  // Bounding boxes (approximate)
  // Bottom: roughly x: 329-372, y: 705-750 (height ~45)
  // Top: roughly x: 465-577, y: 500-626 (height ~126)

  const bottomBounds = { x: 325, y: 702, width: 55, height: 52 };
  const topBounds = { x: 462, y: 498, width: 120, height: 132 };

  return (
    <g>
      <defs>
        {/* Clip paths */}
        <clipPath id="topFlameClip">
          <path d={topInnerPath} />
        </clipPath>
        <clipPath id="bottomLeafClip">
          <path d={bottomInnerPath} />
        </clipPath>

        {/* Orange gradient for bottom */}
        <linearGradient
          id="orangeLiquidGradient"
          x1="0%"
          y1="0%"
          x2="0%"
          y2="100%"
        >
          <stop offset="0%" stopColor="#F4A940" />
          <stop offset="50%" stopColor="#E38A29" />
          <stop offset="100%" stopColor="#D4782A" />
        </linearGradient>

        {/* Teal/Green gradient for top */}
        <linearGradient
          id="tealLiquidGradient"
          x1="0%"
          y1="0%"
          x2="0%"
          y2="100%"
        >
          <stop offset="0%" stopColor="#2DD4BF" />
          <stop offset="50%" stopColor="#4AA174" />
          <stop offset="100%" stopColor="#368368" />
        </linearGradient>
      </defs>

      {/* ===== BOTTOM AREA (Orange) - Inside the green leaf ===== */}
      <g clipPath="url(#bottomLeafClip)">
        {/* Main liquid - grows from bottom */}
        <rect
          x={bottomBounds.x}
          y={
            bottomBounds.y +
            bottomBounds.height -
            (bottomFill / 100) * bottomBounds.height
          }
          width={bottomBounds.width}
          height={(bottomFill / 100) * bottomBounds.height}
          fill="url(#orangeLiquidGradient)"
        />

        {/* Wave on top */}
        {bottomFill > 5 && (
          <motion.ellipse
            cx={bottomBounds.x + bottomBounds.width / 2}
            cy={
              bottomBounds.y +
              bottomBounds.height -
              (bottomFill / 100) * bottomBounds.height
            }
            rx={bottomBounds.width / 2 + 5}
            ry={3}
            fill="#F4A940"
            animate={{
              ry: [2, 4, 2],
            }}
            transition={{
              duration: 1,
              repeat: Infinity,
              ease: 'easeInOut',
            }}
          />
        )}
      </g>

      {/* Glow around bottom filled area */}
      {bottomFill > 30 && (
        <motion.path
          d={bottomInnerPath}
          fill="none"
          stroke="#E38A29"
          strokeWidth="4"
          style={{ filter: 'blur(6px)' }}
          animate={{
            opacity: [0.3, 0.6, 0.3],
          }}
          transition={{
            duration: 1.5,
            repeat: Infinity,
          }}
        />
      )}

      {/* ===== TOP AREA (Teal/Green) - Inside the flame ===== */}
      <g clipPath="url(#topFlameClip)">
        {/* Main liquid - grows from bottom */}
        <rect
          x={topBounds.x}
          y={
            topBounds.y + topBounds.height - (topFill / 100) * topBounds.height
          }
          width={topBounds.width}
          height={(topFill / 100) * topBounds.height}
          fill="url(#tealLiquidGradient)"
        />

        {/* Wave on top */}
        {topFill > 5 && (
          <motion.ellipse
            cx={topBounds.x + topBounds.width / 2}
            cy={
              topBounds.y +
              topBounds.height -
              (topFill / 100) * topBounds.height
            }
            rx={topBounds.width / 2 + 10}
            ry={4}
            fill="#2DD4BF"
            animate={{
              ry: [3, 6, 3],
            }}
            transition={{
              duration: 1.2,
              repeat: Infinity,
              ease: 'easeInOut',
            }}
          />
        )}
      </g>

      {/* Glow around top filled area */}
      {topFill > 30 && (
        <motion.path
          d={topInnerPath}
          fill="none"
          stroke="#4AA174"
          strokeWidth="5"
          style={{ filter: 'blur(8px)' }}
          animate={{
            opacity: [0.3, 0.6, 0.3],
          }}
          transition={{
            duration: 1.5,
            repeat: Infinity,
          }}
        />
      )}
    </g>
  );
}

// ==================== ANIMATED LOGO COMPONENT ====================

function AnimatedNeshamaLogo({ size = 140 }) {
  const [phase, setPhase] = useState('hidden');
  const height = size * 1.5;

  useEffect(() => {
    const timers = [
      setTimeout(() => setPhase('drawing'), 50),
      setTimeout(() => setPhase('filling'), TIMING.drawDuration * 1000 + 100),
      setTimeout(
        () => setPhase('entering'),
        (TIMING.drawDuration + TIMING.fillDelay) * 1000
      ),
      setTimeout(
        () => setPhase('assembled'),
        TIMING.assemblyStart * 1000 + 800
      ),
    ];
    return () => timers.forEach(clearTimeout);
  }, []);

  const drawVariants = {
    hidden: { pathLength: 0, opacity: 0 },
    drawing: {
      pathLength: 1,
      opacity: 1,
      transition: { duration: TIMING.drawDuration, ease: EASING.settle },
    },
  };

  const mainFlameVariants = {
    hidden: { x: 120, y: -150, rotate: 35, scale: 0.3, opacity: 0 },
    entering: {
      x: 0,
      y: 0,
      rotate: 0,
      scale: 1,
      opacity: 1,
      transition: { duration: 1, ease: EASING.elastic },
    },
    assembled: {
      x: 0,
      y: [0, -4, 0],
      rotate: 0,
      scale: 1,
      opacity: 1,
      transition: { y: { duration: 3, repeat: Infinity, ease: EASING.breath } },
    },
  };

  const greenLeafVariants = {
    hidden: { x: -100, y: 120, rotate: -30, scale: 0.3, opacity: 0 },
    entering: {
      x: 0,
      y: 0,
      rotate: 0,
      scale: 1,
      opacity: 1,
      transition: { duration: 1, ease: EASING.elastic, delay: TIMING.stagger },
    },
    assembled: {
      x: 0,
      y: [0, -3, 0],
      rotate: 0,
      scale: 1,
      opacity: 1,
      transition: {
        y: { duration: 3, repeat: Infinity, ease: EASING.breath, delay: 0.2 },
      },
    },
  };

  const innerVariants = {
    hidden: { scale: 0, opacity: 0 },
    entering: {
      scale: 1,
      opacity: 1,
      transition: {
        duration: 0.8,
        ease: EASING.dramatic,
        delay: TIMING.stagger * 2,
      },
    },
    assembled: {
      scale: 1,
      opacity: 1,
      transition: { duration: 2, repeat: Infinity, ease: EASING.breath },
    },
  };

  const glowVariants = {
    hidden: { opacity: 0, scale: 0.5 },
    entering: {
      opacity: [0, 0.8, 0.5],
      scale: [0.5, 1.2, 1],
      transition: {
        duration: 1.2,
        delay: TIMING.assemblyStart - 0.3,
        ease: EASING.dramatic,
      },
    },
    assembled: {
      opacity: [0.4, 0.7, 0.4],
      scale: [1, 1.08, 1],
      transition: { duration: 3, repeat: Infinity, ease: EASING.breath },
    },
  };

  const flashVariants = {
    hidden: { opacity: 0, scale: 0.8 },
    entering: {
      opacity: [0, 1, 0],
      scale: [0.8, 1.5, 2],
      transition: {
        duration: 0.6,
        delay: TIMING.assemblyStart - 0.1,
        ease: EASING.settle,
      },
    },
    assembled: { opacity: 0 },
  };

  const currentPhase = ['drawing', 'filling'].includes(phase)
    ? 'hidden'
    : phase;

  return (
    <div className="relative" style={{ width: size, height }}>
      <FloatingParticles count={15} />

      <motion.div
        className="absolute blur-3xl"
        style={{
          width: size * 1.6,
          height: height * 1.3,
          left: -size * 0.3,
          top: -height * 0.15,
          background: `
            radial-gradient(ellipse at 60% 30%, rgba(227, 138, 41, 0.5) 0%, transparent 50%),
            radial-gradient(ellipse at 40% 70%, rgba(54, 131, 104, 0.5) 0%, transparent 50%)
          `,
          borderRadius: '40% 60% 70% 30% / 40% 50% 60% 50%',
        }}
        variants={glowVariants}
        initial="hidden"
        animate={currentPhase}
      />

      <motion.div
        className="absolute rounded-full"
        style={{
          width: size * 1.2,
          height: height * 0.8,
          left: -size * 0.1,
          top: height * 0.1,
          background:
            'radial-gradient(circle, rgba(255,255,255,0.95) 0%, rgba(255,200,150,0.5) 30%, transparent 60%)',
        }}
        variants={flashVariants}
        initial="hidden"
        animate={currentPhase}
      />

      <motion.svg
        width={size}
        height={height}
        viewBox="0 0 1024 1536"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        style={{ position: 'relative', zIndex: 1 }}
      >
        <defs>
          <linearGradient
            id="animatedOrange"
            gradientUnits="userSpaceOnUse"
            x1="400"
            y1="1200"
            x2="800"
            y2="300"
          >
            <motion.stop
              offset="0%"
              animate={{ stopColor: ['#E38A29', '#D4782A', '#E38A29'] }}
              transition={{ duration: 4, repeat: Infinity }}
            />
            <motion.stop
              offset="50%"
              animate={{ stopColor: ['#E9A54A', '#E38A29', '#E9A54A'] }}
              transition={{ duration: 4, repeat: Infinity }}
            />
            <motion.stop
              offset="100%"
              animate={{ stopColor: ['#F4C67A', '#E9A54A', '#F4C67A'] }}
              transition={{ duration: 4, repeat: Infinity }}
            />
          </linearGradient>

          <linearGradient
            id="shimmerGradient"
            x1="0%"
            y1="0%"
            x2="100%"
            y2="0%"
          >
            <stop offset="0%" stopColor="rgba(255,255,255,0)" />
            <stop offset="40%" stopColor="rgba(255,255,255,0)" />
            <stop offset="50%" stopColor="rgba(255,255,255,0.8)" />
            <stop offset="60%" stopColor="rgba(255,255,255,0)" />
            <stop offset="100%" stopColor="rgba(255,255,255,0)" />
          </linearGradient>

          <linearGradient
            id="gradient_2"
            gradientUnits="userSpaceOnUse"
            x1="327"
            y1="1095"
            x2="485"
            y2="821"
          >
            <motion.stop
              offset="0%"
              animate={{ stopColor: ['#00686D', '#005558', '#00686D'] }}
              transition={{ duration: 5, repeat: Infinity }}
            />
            <motion.stop
              offset="100%"
              animate={{ stopColor: ['#4AA174', '#3D8B63', '#4AA174'] }}
              transition={{ duration: 5, repeat: Infinity }}
            />
          </linearGradient>

          <linearGradient
            id="gradient_0"
            gradientUnits="userSpaceOnUse"
            x1="672"
            y1="810"
            x2="669"
            y2="885"
          >
            <stop offset="0" stopColor="#998842" />
            <stop offset="1" stopColor="#5F8958" />
          </linearGradient>
          <linearGradient
            id="gradient_1"
            gradientUnits="userSpaceOnUse"
            x1="801"
            y1="861"
            x2="781"
            y2="962"
          >
            <stop offset="0" stopColor="#B29649" />
            <stop offset="1" stopColor="#658F64" />
          </linearGradient>
          <linearGradient
            id="gradient_3"
            gradientUnits="userSpaceOnUse"
            x1="432"
            y1="756"
            x2="402"
            y2="812"
          >
            <stop offset="0" stopColor="#9D954F" />
            <stop offset="1" stopColor="#619967" />
          </linearGradient>

          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="8" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter
            id="particleGlow"
            x="-100%"
            y="-100%"
            width="300%"
            height="300%"
          >
            <feGaussianBlur stdDeviation="2" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>

        <ParticleTrail
          startX={900}
          startY={100}
          endX={550}
          endY={600}
          color="rgba(227, 138, 41, 0.6)"
          delay={0}
        />
        <ParticleTrail
          startX={100}
          startY={1200}
          endX={400}
          endY={900}
          color="rgba(54, 131, 104, 0.6)"
          delay={TIMING.stagger}
        />

        <ConvergingParticles phase={phase} />

        {/* ===== DUAL LIQUID FILL EFFECT - Starts immediately ===== */}
        <DualLiquidFillEffect phase={phase} />

        <ShimmerOverlay phase={phase} />

        <motion.g
          variants={mainFlameVariants}
          initial="hidden"
          animate={currentPhase}
          style={{ originX: '550px', originY: '600px' }}
          filter={phase === 'assembled' ? 'url(#glow)' : undefined}
        >
          <motion.path
            d="M388.097 645.658C387.73 625.574 391.003 595.44 394.381 575.789C409.99 485.202 452.727 401.482 516.943 335.695C535.058 316.882 564.247 289.248 586.876 277.419C568.183 324.177 575.675 381.958 595.248 427.155C610.055 461.345 633.073 496.358 656.77 525.013C714.256 594.526 787.214 652.624 822.313 738.278C827.582 751.135 833.238 767.642 835.446 781.4C848.678 855.058 833.292 940.859 790.794 1003.05C790.136 1003.99 789.447 1004.92 788.728 1005.82C787.072 1010.12 773.865 1026.29 770.222 1030.77C727.741 1082.99 660.517 1133.39 599.827 1162.21C621.826 1139.05 644.429 1105.36 655.583 1075.42C671.044 1034.39 672.515 989.405 659.767 947.456C656.152 935.954 651.23 925.418 646.224 914.501C645.505 913.571 639.852 903.332 639.013 901.867C633.506 892.254 627.995 883.463 621.665 874.6C599.814 844.007 531.059 769.109 523.933 734.308C518.076 720.977 518.352 703.54 519.204 689.438C507.891 697.442 500.647 705.259 493.752 717.33C492.067 720.281 488.397 727.189 486.465 729.531C480.193 734.728 471.119 769.809 470.217 778.053C468.854 773.032 460.718 773.645 455.504 772.678C443.718 770.592 425.755 765.976 416.519 757.849C404.379 747.166 388.247 745.822 376.756 738.33L374.559 739.034C371.638 735.589 376.301 712.232 372.505 708.13C367.103 702.291 341.354 704.835 332.748 703.701C331.577 703.394 332.354 699.286 332.36 698.362C332.411 690.087 339.342 651.849 337.157 647.223L336.725 646.696C321.277 647.349 305.48 646.532 289.652 647.211L289.473 612.931C317.112 605.012 339.229 573.32 359.07 554.177C346.535 583.074 344.734 616.821 337.856 645.732C354.603 645.847 371.35 645.823 388.097 645.658ZM529.065 626.084C577.139 619.835 552.774 567.948 540.471 541.073C538.219 536.154 527.51 501.438 526.785 500.754C514.707 528.562 464.621 626.326 529.065 626.084Z"
            stroke="#E38A29"
            strokeWidth="3"
            fill="none"
            variants={drawVariants}
            initial="hidden"
            animate={phase === 'drawing' ? 'drawing' : 'drawing'}
          />
          <motion.path
            d="M388.097 645.658C387.73 625.574 391.003 595.44 394.381 575.789C409.99 485.202 452.727 401.482 516.943 335.695C535.058 316.882 564.247 289.248 586.876 277.419C568.183 324.177 575.675 381.958 595.248 427.155C610.055 461.345 633.073 496.358 656.77 525.013C714.256 594.526 787.214 652.624 822.313 738.278C827.582 751.135 833.238 767.642 835.446 781.4C848.678 855.058 833.292 940.859 790.794 1003.05C790.136 1003.99 789.447 1004.92 788.728 1005.82C787.072 1010.12 773.865 1026.29 770.222 1030.77C727.741 1082.99 660.517 1133.39 599.827 1162.21C621.826 1139.05 644.429 1105.36 655.583 1075.42C671.044 1034.39 672.515 989.405 659.767 947.456C656.152 935.954 651.23 925.418 646.224 914.501C645.505 913.571 639.852 903.332 639.013 901.867C633.506 892.254 627.995 883.463 621.665 874.6C599.814 844.007 531.059 769.109 523.933 734.308C518.076 720.977 518.352 703.54 519.204 689.438C507.891 697.442 500.647 705.259 493.752 717.33C492.067 720.281 488.397 727.189 486.465 729.531C480.193 734.728 471.119 769.809 470.217 778.053C468.854 773.032 460.718 773.645 455.504 772.678C443.718 770.592 425.755 765.976 416.519 757.849C404.379 747.166 388.247 745.822 376.756 738.33L374.559 739.034C371.638 735.589 376.301 712.232 372.505 708.13C367.103 702.291 341.354 704.835 332.748 703.701C331.577 703.394 332.354 699.286 332.36 698.362C332.411 690.087 339.342 651.849 337.157 647.223L336.725 646.696C321.277 647.349 305.48 646.532 289.652 647.211L289.473 612.931C317.112 605.012 339.229 573.32 359.07 554.177C346.535 583.074 344.734 616.821 337.856 645.732C354.603 645.847 371.35 645.823 388.097 645.658ZM529.065 626.084C577.139 619.835 552.774 567.948 540.471 541.073C538.219 536.154 527.51 501.438 526.785 500.754C514.707 528.562 464.621 626.326 529.065 626.084Z"
            fill="url(#animatedOrange)"
            initial={{ fillOpacity: 0 }}
            animate={{ fillOpacity: phase !== 'drawing' ? 1 : 0 }}
            transition={{ duration: 0.6, ease: EASING.breath }}
          />
        </motion.g>

        {/* ===== MAIN GREEN LEAF ===== */}
        <motion.g
          variants={greenLeafVariants}
          initial="hidden"
          animate={currentPhase}
          style={{ originX: '380px', originY: '950px' }}
          filter={phase === 'assembled' ? 'url(#glow)' : undefined}
        >
          <motion.path
            d="M337.157 647.223C339.342 651.849 332.411 690.087 332.36 698.362C332.354 699.286 331.577 703.394 332.748 703.701C341.354 704.835 367.103 702.291 372.505 708.13C376.301 712.232 371.638 735.589 374.559 739.034L376.756 738.33C388.247 745.822 404.379 747.166 416.519 757.849C425.755 765.976 443.718 770.592 455.504 772.678C460.718 773.645 468.854 773.032 470.217 778.053C471.119 769.809 480.193 734.728 486.465 729.531C485.386 732.345 484.346 735.205 483.231 738C466.823 779.155 462.739 824.408 475.911 867.141C477.16 869.353 480.167 876.839 481.705 879.899C486.897 890.23 492.422 900.979 499.22 910.373C540.122 966.887 588.038 1006.46 587.596 1082.75C587.318 1130.7 565.46 1180.72 531.452 1214.61C525.717 1211.46 516.25 1204.76 510.627 1201L472.853 1175.58C402.125 1127.9 327.517 1078.59 282.906 1003.64C245.647 941.037 228.653 848.045 247.089 776.958C257.292 795.59 272.506 810.201 286.562 825.663C282.009 803.119 277.555 780.191 274.959 757.343C273.069 740.704 272.454 723.79 271.575 707.068C278.443 706.347 283.952 706.228 290.87 706.107C299.576 706.145 323.755 706.691 330.935 705.489C330.187 697.59 335.738 656.518 337.157 647.223ZM330.116 738.601C330.7 742.335 330.652 745.025 333.854 747.337C338.899 750.978 351.661 749.998 357.829 749.459C362.928 749.328 370.963 748.92 371.669 742.671C372.55 734.885 374.633 713.696 369.718 707.774C361.787 704.909 340.95 705.77 331.367 705.795C329.048 715.971 330.863 728.827 330.116 738.601Z"
            stroke="#368368"
            strokeWidth="3"
            fill="none"
            variants={drawVariants}
            initial="hidden"
            animate={phase === 'drawing' ? 'drawing' : 'drawing'}
            transition={{ delay: 0.1 }}
          />
          <motion.path
            d="M337.157 647.223C339.342 651.849 332.411 690.087 332.36 698.362C332.354 699.286 331.577 703.394 332.748 703.701C341.354 704.835 367.103 702.291 372.505 708.13C376.301 712.232 371.638 735.589 374.559 739.034L376.756 738.33C388.247 745.822 404.379 747.166 416.519 757.849C425.755 765.976 443.718 770.592 455.504 772.678C460.718 773.645 468.854 773.032 470.217 778.053C471.119 769.809 480.193 734.728 486.465 729.531C485.386 732.345 484.346 735.205 483.231 738C466.823 779.155 462.739 824.408 475.911 867.141C477.16 869.353 480.167 876.839 481.705 879.899C486.897 890.23 492.422 900.979 499.22 910.373C540.122 966.887 588.038 1006.46 587.596 1082.75C587.318 1130.7 565.46 1180.72 531.452 1214.61C525.717 1211.46 516.25 1204.76 510.627 1201L472.853 1175.58C402.125 1127.9 327.517 1078.59 282.906 1003.64C245.647 941.037 228.653 848.045 247.089 776.958C257.292 795.59 272.506 810.201 286.562 825.663C282.009 803.119 277.555 780.191 274.959 757.343C273.069 740.704 272.454 723.79 271.575 707.068C278.443 706.347 283.952 706.228 290.87 706.107C299.576 706.145 323.755 706.691 330.935 705.489C330.187 697.59 335.738 656.518 337.157 647.223ZM330.116 738.601C330.7 742.335 330.652 745.025 333.854 747.337C338.899 750.978 351.661 749.998 357.829 749.459C362.928 749.328 370.963 748.92 371.669 742.671C372.55 734.885 374.633 713.696 369.718 707.774C361.787 704.909 340.95 705.77 331.367 705.795C329.048 715.971 330.863 728.827 330.116 738.601Z"
            fill="url(#gradient_2)"
            initial={{ fillOpacity: 0 }}
            animate={{ fillOpacity: phase !== 'drawing' ? 1 : 0 }}
            transition={{ duration: 0.6, delay: 0.1, ease: EASING.breath }}
          />
        </motion.g>

        {/* ===== SECONDARY ELEMENTS & PIXELS ===== */}
        <motion.path
          fill="#368368"
          d="M709.758 887.961C729.763 881.953 745.855 886.921 762.727 872.739L764.936 933.742L766.088 935.01C765.803 948.068 763.455 958.509 760.471 971.218C759.958 973.404 757.623 980.812 758.065 981.949C760.382 976.633 764.275 960.642 764.91 954.685C773.124 956.272 779.615 959.413 787.45 961.859C794.418 964.035 800.856 965.456 807.82 967.924C808.721 974.158 788.623 1000.63 788.728 1005.82C787.072 1010.12 773.865 1026.29 770.222 1030.77C727.741 1082.99 660.517 1133.39 599.827 1162.21C621.826 1139.05 644.429 1105.36 655.583 1075.42C671.044 1034.39 672.515 989.405 659.767 947.456C656.152 935.954 651.23 925.418 646.224 914.501L646.758 913.351C642.961 904.363 628.177 883.15 627.961 878.418L628.76 877.338C635.54 876.642 656.133 880.561 663.909 880.966C674.283 881.506 681.455 880.459 691.753 878.718C695.294 878.12 700.659 877.9 702.781 875.751C708.315 885.454 721.483 933.241 723.635 935.534L724.066 934.724L723.787 934.054C721.591 928.643 721.323 923.541 719.6 918.575C715.957 908.075 712.712 898.721 709.758 887.961Z"
          variants={innerVariants}
          initial="hidden"
          animate={currentPhase}
        />
        <motion.path
          fill="url(#gradient_0)"
          d="M523.933 734.308C525.907 735.103 526.071 736.436 527.076 739.029C535.443 760.632 562.736 800.882 579.286 818.163C577.59 817.737 607.027 818.042 604.656 818.504C617.5 816.002 659.327 820.35 668.689 814.509C667.052 810.166 662.521 805.717 661.767 802.327L662.323 801.831C666.225 805.554 674.681 823.401 679.021 823.388C681.704 823.381 684.351 822.03 687.19 821.983C702.015 821.736 735.219 825.4 745.542 813.781C745.753 813.544 745.945 813.292 746.147 813.047C745.333 809.06 742.134 804.771 740.583 800.844C733.605 783.184 723.208 766.896 712.626 751.211C707.382 743.44 699.981 734.485 695.426 726.539C708.605 741.729 719.948 759.609 730.142 776.963C731.458 779.202 736.419 789.18 737.703 790.484C742.074 800.861 747.059 811.196 750.998 821.699C761.473 850.29 766.975 880.463 767.266 910.911C767.316 914.829 767.386 932.07 766.088 935.01L764.936 933.742C767.39 919.085 764.816 887.207 762.727 872.739C745.855 886.921 729.763 881.953 709.758 887.961C712.712 898.721 715.957 908.075 719.6 918.575C721.323 923.541 721.591 928.643 723.787 934.054L724.066 934.724L723.635 935.534C721.483 933.241 708.315 885.454 702.781 875.751C700.659 877.9 695.294 878.12 691.753 878.718C681.455 880.459 674.283 881.506 663.909 880.966C656.133 880.561 635.54 876.642 628.76 877.338L627.961 878.418C628.177 883.15 642.961 904.363 646.758 913.351L646.224 914.501C645.505 913.571 639.852 903.332 639.013 901.867C633.506 892.254 627.995 883.463 621.665 874.6C599.814 844.007 531.059 769.109 523.933 734.308Z"
          variants={innerVariants}
          initial="hidden"
          animate={currentPhase}
        />
        <motion.path
          fill="url(#gradient_1)"
          d="M835.446 781.4C848.678 855.058 833.292 940.859 790.794 1003.05C790.136 1003.99 789.447 1004.92 788.728 1005.82C788.623 1000.63 808.721 974.158 807.82 967.924C800.856 965.456 794.418 964.035 787.45 961.859C779.615 959.413 773.124 956.272 764.91 954.685C764.275 960.642 760.382 976.633 758.065 981.949C757.623 980.812 759.958 973.404 760.471 971.218C763.455 958.509 765.803 948.068 766.088 935.01C767.386 932.07 767.316 914.829 767.266 910.911C766.975 880.463 761.473 850.29 750.998 821.699C747.059 811.196 742.074 800.861 737.703 790.484C744.786 795.618 758.629 839.067 761.048 849.918C761.882 853.66 762.923 858.606 764.21 862.267C765.239 861.47 769.903 858.764 771.19 859.197C779.598 862.025 831.21 870.864 836.621 867.181C841.075 856.65 837.774 818.153 837.603 805.05C837.516 798.434 833.905 787.799 835.446 781.4Z"
          variants={innerVariants}
          initial="hidden"
          animate={currentPhase}
        />
        <motion.path
          fill="url(#gradient_3)"
          d="M337.157 647.223C339.342 651.849 332.411 690.087 332.36 698.362C332.354 699.286 331.577 703.394 332.748 703.701C341.354 704.835 367.103 702.291 372.505 708.13C376.301 712.232 371.638 735.589 374.559 739.034L376.756 738.33C388.247 745.822 404.379 747.166 416.519 757.849C425.755 765.976 443.718 770.592 455.504 772.678C460.718 773.645 468.854 773.032 470.217 778.053C471.119 769.809 480.193 734.728 486.465 729.531C485.386 732.345 484.346 735.205 483.231 738C466.823 779.155 462.739 824.408 475.911 867.141C470.037 862.121 470.194 843.968 467.634 836.298C464.609 834.736 463.358 837.42 460.278 836.853C451.413 835.221 442.768 833.57 434.565 829.874C420.947 823.596 407.855 816.236 395.415 807.863C387.585 802.63 379.649 796.19 371.301 792.088C373.618 800.593 395.254 847.69 395.046 849.025C392.668 845.946 390.515 839.685 388.616 835.954C380.465 819.937 374.159 804.501 367.654 787.786C368.985 779.944 360.325 758.37 357.829 749.459C362.928 749.328 370.963 748.92 371.669 742.671C372.55 734.885 374.633 713.696 369.718 707.774C361.787 704.909 340.95 705.77 331.367 705.795L330.935 705.489C330.187 697.59 335.738 656.518 337.157 647.223Z"
          variants={innerVariants}
          initial="hidden"
          animate={currentPhase}
        />
        <motion.path
          fill="#6B9964"
          d="M330.935 705.489L331.367 705.795C329.048 715.971 330.863 728.827 330.116 738.601C330.7 742.335 330.652 745.025 333.854 747.337C338.899 750.978 351.661 749.998 357.829 749.459C360.325 758.37 368.985 779.944 367.654 787.786C364.016 778.825 363.504 764.032 357.916 758.428C354.565 756.891 353.915 756.419 350.302 757.308C343.558 752.195 337.405 753.633 331.676 749.525C325.419 745.052 321.223 742.141 315.483 736.879C311.269 733.015 295.086 712.717 291.896 712.467C290.25 714.937 291.663 717.936 290.844 722.043C290.051 718.869 289.637 709.077 290.87 706.107C299.576 706.145 323.755 706.691 330.935 705.489Z"
          variants={innerVariants}
          initial="hidden"
          animate={currentPhase}
        />
      </motion.svg>
    </div>
  );
}

// ==================== MAIN COMPONENT ====================

export default function StandardizedLoadingSpinner({
  text = '×˜×•×¢×Ÿ...',
  subtext,
  className,
}: StandardizedLoadingSpinnerProps) {
  const [key] = useState(0);

  return (
    <div
      className={`min-h-screen flex flex-col items-center justify-center p-8 overflow-hidden ${className || ''}`}
    >
      <div className="relative z-10">
        <AnimatedNeshamaLogo size={160} key={key} />
      </div>

      {text && (
        <motion.p
          key={`text-${key}`}
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{
            delay: TIMING.assemblyStart + 0.3,
            duration: 0.6,
            ease: EASING.settle,
          }}
          className="mt-6 text-xl font-semibold text-gray-700 text-center"
        >
          {text}
        </motion.p>
      )}

      {subtext && (
        <motion.div
          key={`sub-${key}`}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: TIMING.assemblyStart + 0.6 }}
          className="mt-4 flex items-center gap-2 text-sm text-gray-500"
        >
          <Sparkles className="w-4 h-4" />
          <span>{subtext}</span>
        </motion.div>
      )}
    </div>
  );
}
--- End of Content for StandardizedLoadingSpinner.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\AccessibilityFeatures.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/AccessibilityFeatures.tsx
'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  Accessibility,
  Plus,
  Minus,
  MoonStar,
  SunMedium,
  Type,
  MousePointer,
  Hand,
  Contrast,
  Speech,
  X,
  Settings,
  Volume2,
  VolumeX,
  Palette,
  Eye,
  RefreshCw,
  Check,
  Sparkles,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Slider } from '@/components/ui/slider';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import type { AccessibilityFeaturesDict } from '@/types/dictionary';
import { useIsMobile } from '../hooks/useMediaQuery';

declare global {
  interface Window {
    webkitAudioContext: typeof AudioContext;
  }
}

interface AccessibilityFeaturesProps {
  className?: string;
  isPanelOpen?: boolean;
  onPanelOpenChange?: (isOpen: boolean) => void;
  dict: AccessibilityFeaturesDict;
}

interface AccessibilitySettings {
  fontScale: number;
  contrastMode: 'normal' | 'high' | 'dark';
  reducedMotion: boolean;
  readableMode: boolean;
  bigCursor: boolean;
  textReader: boolean;
  soundEnabled: boolean;
}

const defaultSettings: AccessibilitySettings = {
  fontScale: 1,
  contrastMode: 'normal',
  reducedMotion: false,
  readableMode: false,
  bigCursor: false,
  textReader: false,
  soundEnabled: true,
};

const getSettingName = (
  key: keyof AccessibilitySettings,
  dict: AccessibilityFeaturesDict
): string => {
  return dict.settingNames[key] || key;
};

export default function AccessibilityFeatures({
  className,
  isPanelOpen,
  onPanelOpenChange,
  dict,
}: AccessibilityFeaturesProps) {
  const [settings, setSettings] =
    useState<AccessibilitySettings>(defaultSettings);
  const [internalShowPanel, setInternalShowPanel] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);
  const [showToast, setShowToast] = useState<{
    message: string;
    type: 'success' | 'info';
    visible: boolean;
  }>({ message: '', type: 'info', visible: false });

  const panelRef = useRef<HTMLDivElement>(null);
  const toastTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const isMobile = useIsMobile();

  const showAccessibilityPanel =
    isPanelOpen !== undefined ? isPanelOpen : internalShowPanel;
  const setShowAccessibilityPanel = onPanelOpenChange || setInternalShowPanel;

  useEffect(() => {
    const savedSettings = localStorage.getItem('accessibilitySettings');
    if (savedSettings) {
      try {
        const parsed = JSON.parse(savedSettings);
        setSettings({ ...defaultSettings, ...parsed });
      } catch (error) {
        console.error('Error loading accessibility settings:', error);
      }
    }
  }, []);

  useEffect(() => {
    const htmlElement = document.documentElement;
    htmlElement.style.fontSize = `${settings.fontScale * 100}%`;
    htmlElement.classList.toggle(
      'high-contrast',
      settings.contrastMode === 'high'
    );
    htmlElement.classList.toggle('dark-mode', settings.contrastMode === 'dark');
    htmlElement.classList.toggle('reduce-motion', settings.reducedMotion);
    htmlElement.classList.toggle('readable-font', settings.readableMode);
    htmlElement.classList.toggle('big-cursor', settings.bigCursor);
    updateAccessibilityStyles();
    localStorage.setItem('accessibilitySettings', JSON.stringify(settings));
  }, [settings]);

  const updateAccessibilityStyles = () => {
    const styleElement =
      document.getElementById('accessibility-styles') ||
      document.createElement('style');
    styleElement.id = 'accessibility-styles';
    styleElement.textContent = `
      .high-contrast { filter: contrast(1.5) brightness(1.1); }
      .dark-mode { filter: invert(1) hue-rotate(180deg); background: #1a1a1a !important; }
      .reduce-motion * { animation-duration: 0.001s !important; transition-duration: 0.001s !important; }
      .readable-font * { font-family: 'Arial', 'Helvetica', sans-serif !important; letter-spacing: 0.05em !important; word-spacing: 0.1em !important; line-height: 1.6 !important; }
      .big-cursor, .big-cursor * { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16"><circle fill="%23000" stroke="%23fff" stroke-width="2" cx="8" cy="8" r="6"/></svg>') 16 16, auto !important; }
      .accessibility-panel-enter { opacity: 0; transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .accessibility-panel-enter-active { opacity: 1; transform: scale(1) translateY(0); }
      .accessibility-panel-exit { opacity: 1; transform: scale(1) translateY(0); transition: all 0.2s ease-in; }
      .accessibility-panel-exit-active { opacity: 0; transform: scale(0.95) translateY(10px); }
      .accessibility-button { transition: all 0.3s ease; }
      .accessibility-button:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
      .accessibility-button:active { transform: scale(0.95); }
      .toast-enter { opacity: 0; transform: translateY(20px) scale(0.9); transition: all 0.3s ease; }
      .toast-enter-active { opacity: 1; transform: translateY(0) scale(1); }
      .toast-exit { opacity: 1; transform: translateY(0) scale(1); transition: all 0.2s ease; }
      .toast-exit-active { opacity: 0; transform: translateY(20px) scale(0.9); }
      .pulse-animation { animation: pulse 2s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } }
      .setting-card { transition: all 0.2s ease; border-radius: 8px; }
      .setting-card:hover { background-color: rgba(59, 130, 246, 0.05); transform: translateX(-2px); }
    `;
    if (!document.getElementById('accessibility-styles')) {
      document.head.appendChild(styleElement);
    }
  };

  const showSuccessToast = useCallback((message: string) => {
    setShowToast({ message, type: 'success', visible: true });
    if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
    toastTimeoutRef.current = setTimeout(() => {
      setShowToast((prev) => ({ ...prev, visible: false }));
    }, 2500);
  }, []);

  const playClickSound = useCallback(() => {
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const audioContext = new AudioContext();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.01,
        audioContext.currentTime + 0.1
      );
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    } catch (error) {
      console.log('Could not play sound:', error);
    }
  }, []);

  const updateSetting = useCallback(
    <K extends keyof AccessibilitySettings>(
      key: K,
      value: AccessibilitySettings[K]
    ) => {
      setSettings((prev) => ({ ...prev, [key]: value }));
      setHasChanges(true);
      if (settings.soundEnabled) playClickSound();
      const settingName = getSettingName(key, dict);
      showSuccessToast(
        dict.toasts.settingUpdated.replace('{{settingName}}', settingName)
      );
    },
    [settings.soundEnabled, playClickSound, dict, showSuccessToast]
  );

  const readSelectedText = useCallback((e: MouseEvent) => {
    const element = e.target as HTMLElement;
    if (element && element.textContent && 'speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const text = element.textContent.trim();
      if (text && text.length > 0) {
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const hebrewVoice = voices.find((voice) => voice.lang === 'he-IL');
        if (hebrewVoice) {
          utterance.voice = hebrewVoice;
          utterance.lang = 'he-IL';
        }
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      }
    }
  }, []);

  const toggleTextReader = useCallback(() => {
    const willBeActive = !settings.textReader;
    updateSetting('textReader', willBeActive);
    if (willBeActive) {
      document.addEventListener('click', readSelectedText);
      showSuccessToast(dict.toasts.readerEnabled);
    } else {
      document.removeEventListener('click', readSelectedText);
      if (window.speechSynthesis) window.speechSynthesis.cancel();
    }
  }, [
    settings.textReader,
    updateSetting,
    readSelectedText,
    showSuccessToast,
    dict.toasts.readerEnabled,
  ]);

  const resetSettings = () => {
    setSettings(defaultSettings);
    setHasChanges(false);
    showSuccessToast(dict.toasts.settingsReset);
    if (settings.soundEnabled) playClickSound();
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        panelRef.current &&
        !panelRef.current.contains(event.target as Node)
      ) {
        const target = event.target as HTMLElement;
        if (!target.closest('[data-accessibility-trigger]')) {
          setShowAccessibilityPanel(false);
        }
      }
    };
    if (showAccessibilityPanel) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showAccessibilityPanel, setShowAccessibilityPanel]);

  useEffect(() => {
    return () => {
      if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
      document.removeEventListener('click', readSelectedText);
    };
  }, [readSelectedText]);

  const contrastOptions = [
    { key: 'normal' as const, icon: SunMedium },
    { key: 'high' as const, icon: Contrast },
    { key: 'dark' as const, icon: MoonStar },
  ];

  const advancedOptions = [
    {
      key: 'sound' as const,
      setting: 'soundEnabled' as const,
      icon: settings.soundEnabled ? Volume2 : VolumeX,
    },
    { key: 'reader' as const, setting: 'textReader' as const, icon: Speech },
    {
      key: 'cursor' as const,
      setting: 'bigCursor' as const,
      icon: MousePointer,
    },
    { key: 'font' as const, setting: 'readableMode' as const, icon: Eye },
    { key: 'motion' as const, setting: 'reducedMotion' as const, icon: Hand },
  ];

  return (
    <>
      <div
        className={cn(
          'fixed z-50 right-4',
          isMobile ? 'bottom-24' : 'bottom-4'
        )}
      >
        <Button
          data-accessibility-trigger
          variant={showAccessibilityPanel ? 'default' : 'outline'}
          size="icon"
          className={cn(
            'accessibility-button rounded-full shadow-lg transition-all duration-300',
            'hover:shadow-xl bg-white border-2',
            showAccessibilityPanel
              ? 'bg-blue-600 border-blue-600 text-white shadow-blue-200'
              : 'border-blue-200 hover:border-blue-400 hover:bg-blue-50',
            hasChanges && 'ring-2 ring-blue-400 ring-opacity-50 ring-offset-2',
            className
          )}
          onClick={() => setShowAccessibilityPanel(!showAccessibilityPanel)}
          title={
            showAccessibilityPanel
              ? dict.triggerButton.close
              : dict.triggerButton.open
          }
        >
          <div className="relative">
            {showAccessibilityPanel ? (
              <X className="h-5 w-5" />
            ) : (
              <Accessibility className="h-5 w-5" />
            )}
            {hasChanges && !showAccessibilityPanel && (
              <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-600 rounded-full pulse-animation" />
            )}
          </div>
        </Button>
      </div>

      {showAccessibilityPanel && (
        <div
          ref={panelRef}
          className={cn(
            'fixed z-40 bottom-20 right-4 max-w-sm w-[340px]',
            'accessibility-panel-enter accessibility-panel-enter-active'
          )}
        >
          <Card className="shadow-2xl border-2 border-blue-100 bg-white">
            <CardHeader className="pb-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-lg">
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg flex items-center gap-2 text-slate-800">
                  <div className="p-1.5 bg-blue-100 rounded-lg">
                    <Settings className="h-4 w-4 text-blue-600" />
                  </div>
                  {dict.panelTitle}
                  {hasChanges && (
                    <Badge
                      variant="secondary"
                      className="text-xs bg-blue-100 text-blue-700 border-blue-200"
                    >
                      <Sparkles className="h-3 w-3 mr-1" />
                      {dict.changedBadge}
                    </Badge>
                  )}
                </CardTitle>
              </div>
              <p className="text-xs text-slate-600 mt-1">
                {dict.panelSubtitle}
              </p>
            </CardHeader>

            <CardContent className="space-y-6 pt-5 max-h-[65vh] overflow-y-auto">
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <Label className="text-sm font-medium flex items-center gap-2">
                    <Type className="h-4 w-4 text-blue-500" />
                    {dict.textSize.title}
                  </Label>
                  <div className="flex items-center gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-8 w-8 p-0 hover:bg-blue-50 border-blue-200"
                      onClick={() =>
                        updateSetting(
                          'fontScale',
                          Math.max(0.8, settings.fontScale - 0.1)
                        )
                      }
                      disabled={settings.fontScale <= 0.8}
                    >
                      <Minus className="h-3 w-3" />
                    </Button>
                    <Badge
                      variant="outline"
                      className="min-w-[55px] text-center font-mono bg-blue-50 border-blue-200"
                    >
                      {Math.round(settings.fontScale * 100)}%
                    </Badge>
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-8 w-8 p-0 hover:bg-blue-50 border-blue-200"
                      onClick={() =>
                        updateSetting(
                          'fontScale',
                          Math.min(1.6, settings.fontScale + 0.1)
                        )
                      }
                      disabled={settings.fontScale >= 1.6}
                    >
                      <Plus className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
                <Slider
                  value={[settings.fontScale * 100]}
                  min={80}
                  max={160}
                  step={5}
                  onValueChange={(value) =>
                    updateSetting('fontScale', value[0] / 100)
                  }
                  className="py-2"
                />
                <p className="text-xs text-slate-500">
                  {dict.textSize.description}
                </p>
              </div>

              <div className="space-y-4">
                <Label className="text-sm font-medium flex items-center gap-2">
                  <Palette className="h-4 w-4 text-blue-500" />
                  {dict.displayMode.title}
                </Label>
                <div className="grid grid-cols-3 gap-2">
                  {contrastOptions.map(({ key, icon: Icon }) => {
                    const optionDict = dict.contrastOptions[key];
                    return (
                      <Button
                        key={key}
                        variant={
                          settings.contrastMode === key ? 'default' : 'outline'
                        }
                        size="sm"
                        className={cn(
                          'h-14 flex flex-col gap-1 text-xs transition-all relative',
                          settings.contrastMode === key
                            ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                            : 'hover:bg-blue-50 border-blue-200'
                        )}
                        onClick={() => updateSetting('contrastMode', key)}
                        title={optionDict.description}
                      >
                        <Icon className="h-4 w-4" />
                        <span className="font-medium">{optionDict.label}</span>
                        {settings.contrastMode === key && (
                          <div className="absolute top-1 right-1">
                            <Check className="h-3 w-3" />
                          </div>
                        )}
                      </Button>
                    );
                  })}
                </div>
              </div>

              <div className="space-y-4 pt-2 border-t border-slate-200">
                <Label className="text-sm font-medium text-slate-700">
                  {dict.additionalSettings.title}
                </Label>
                {advancedOptions.map(({ key, setting, icon: Icon }) => {
                  const optionDict = dict.advancedOptions[key];
                  return (
                    <div
                      key={key}
                      className="setting-card flex items-center justify-between group p-3 rounded-lg"
                    >
                      <div className="flex items-center gap-3">
                        <div
                          className={cn(
                            'p-2 rounded-lg transition-colors',
                            settings[setting]
                              ? 'bg-blue-100 text-blue-600'
                              : 'bg-slate-100 text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-500'
                          )}
                        >
                          <Icon className="h-4 w-4" />
                        </div>
                        <div className="flex-1">
                          <Label className="text-sm font-medium cursor-pointer">
                            {optionDict.label}
                          </Label>
                          <p className="text-xs text-slate-500 mt-0.5 leading-relaxed">
                            {optionDict.description}
                          </p>
                        </div>
                      </div>
                      <Switch
                        checked={settings[setting]}
                        onCheckedChange={(checked) => {
                          if (setting === 'textReader') toggleTextReader();
                          else updateSetting(setting, checked);
                        }}
                      />
                    </div>
                  );
                })}
              </div>

              <div className="pt-4 border-t border-slate-200">
                <Button
                  variant="outline"
                  size="sm"
                  className={cn(
                    'w-full flex items-center gap-2 transition-all',
                    hasChanges
                      ? 'hover:bg-red-50 hover:border-red-200 hover:text-red-700'
                      : 'opacity-50 cursor-not-allowed'
                  )}
                  onClick={resetSettings}
                  disabled={!hasChanges}
                >
                  <RefreshCw className="h-4 w-4" />
                  {dict.resetButton}
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {showToast.visible && (
        <div className="fixed bottom-4 left-4 z-50 toast-enter toast-enter-active">
          <div className="bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 border border-green-500">
            <div className="p-1 bg-green-500 rounded-full">
              <Check className="h-3 w-3" />
            </div>
            <span className="text-sm font-medium">{showToast.message}</span>
          </div>
        </div>
      )}
    </>
  );
}
--- End of Content for AccessibilityFeatures.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\FAQ.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/FAQ.tsx
'use client';

import React, { useState, useMemo } from 'react';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { cn } from '@/lib/utils';
import {
  Search,
  HelpCircle,
  ArrowRight,
  Info,
  Clock,
  Star,
  AlertCircle,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import type { QuestionnaireFaqDict, FaqAnswerPart } from '@/types/dictionary';

interface FAQProps {
  className?: string;
  showSearch?: boolean;
  showCategories?: boolean;
  initialOpenId?: string;
  dict: QuestionnaireFaqDict;
}

// Metadata for FAQs (category, popularity) which is NOT in the dictionary
// Keys must match the keys in dict.items
const faqMetadata: {
  [key: string]: {
    category: keyof QuestionnaireFaqDict['categories'];
    isPopular?: boolean;
  };
} = {
  'save-progress': { category: 'technical', isPopular: true },
  'time-to-complete': { category: 'process', isPopular: true },
  'required-questions': { category: 'process' },
  'how-matching-works': { category: 'process', isPopular: true },
  'privacy-info': { category: 'privacy' },
  'edit-answers': { category: 'technical' },
  'match-percentage': { category: 'results' },
  'incomplete-questionnaire': { category: 'process' },
  'inactive-account': { category: 'general' },
};

// Helper function to render the answer JSX from dictionary data
const renderAnswer = (answerParts: FaqAnswerPart[]) => (
  <div className="space-y-3">
    {answerParts.map((part, index) => {
      switch (part.type) {
        case 'p':
          return <p key={index}>{part.content}</p>;
        case 'list':
          return (
            <ol key={index} className="list-decimal mr-5 space-y-1 pr-5">
              {(part.content as string[]).map((item, i) => (
                <li key={i}>{item}</li>
              ))}
            </ol>
          );
        case 'tip':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-blue-50 rounded-md"
            >
              <Clock className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-blue-700">
                {part.title && <p className="font-medium mb-1">{part.title}</p>}
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'info':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-blue-50 rounded-md"
            >
              <Info className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-blue-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'star':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-amber-50 rounded-md border border-amber-100"
            >
              <Star className="h-5 w-5 text-amber-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-amber-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'alert':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-red-50 rounded-md border border-red-100"
            >
              <AlertCircle className="h-5 w-5 text-red-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-red-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        default:
          return null;
      }
    })}
  </div>
);

export default function FAQ({
  className,
  showSearch = true,
  showCategories = true,
  initialOpenId,
  dict,
}: FAQProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [activeCategory, setActiveCategory] = useState<string | null>(null);
  const [expandedItems, setExpandedItems] = useState<string[]>(
    initialOpenId ? [initialOpenId] : []
  );

  const faqItems = useMemo(() => {
    return Object.keys(dict.items).map((id) => {
      const key = id as keyof typeof dict.items;
      return {
        id,
        question: dict.items[key].question,
        answer: renderAnswer(dict.items[key].answer),
        category: faqMetadata[key]?.category || 'general',
        isPopular: faqMetadata[key]?.isPopular || false,
      };
    });
  }, [dict]);

  const categories = useMemo(
    () => [
      {
        id: 'process',
        label: dict.categories.process,
        icon: <ArrowRight className="h-4 w-4" />,
      },
      {
        id: 'technical',
        label: dict.categories.technical,
        icon: <HelpCircle className="h-4 w-4" />,
      },
      {
        id: 'privacy',
        label: dict.categories.privacy,
        icon: <Info className="h-4 w-4" />,
      },
      {
        id: 'results',
        label: dict.categories.results,
        icon: <Star className="h-4 w-4" />,
      },
      {
        id: 'general',
        label: dict.categories.general,
        icon: <Info className="h-4 w-4" />,
      },
    ],
    [dict.categories]
  );

  const filteredItems = useMemo(() => {
    return faqItems.filter((item) => {
      const matchesSearch =
        !searchQuery ||
        item.question.toLowerCase().includes(searchQuery.toLowerCase());

      const matchesCategory =
        !activeCategory || item.category === activeCategory;

      return matchesSearch && matchesCategory;
    });
  }, [faqItems, searchQuery, activeCategory]);

  return (
    <Card className={cn('shadow-sm', className)}>
      <CardHeader className="pb-3">
        <CardTitle className="text-lg md:text-xl">{dict.title}</CardTitle>
        <p className="text-gray-500 text-sm">{dict.subtitle}</p>

        {showSearch && (
          <div className="relative mt-2">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
            <Input
              placeholder={dict.searchPlaceholder}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 bg-gray-50"
            />
          </div>
        )}

        {showCategories && (
          <div className="flex flex-wrap gap-2 mt-3">
            <Badge
              variant={activeCategory === null ? 'default' : 'outline'}
              className="cursor-pointer"
              onClick={() => setActiveCategory(null)}
            >
              {dict.categories.all}
            </Badge>

            {categories.map((category) => (
              <Badge
                key={category.id}
                variant={activeCategory === category.id ? 'default' : 'outline'}
                className="cursor-pointer flex items-center gap-1"
                onClick={() =>
                  setActiveCategory(
                    activeCategory === category.id ? null : category.id
                  )
                }
              >
                {category.icon}
                {category.label}
              </Badge>
            ))}
          </div>
        )}
      </CardHeader>

      <CardContent>
        {filteredItems.length === 0 ? (
          <div className="text-center py-8">
            <HelpCircle className="h-12 w-12 mx-auto text-gray-300 mb-2" />
            <p className="text-gray-500">{dict.emptyState}</p>
          </div>
        ) : (
          <Accordion
            type="multiple"
            value={expandedItems}
            onValueChange={setExpandedItems}
            className="space-y-2"
          >
            {filteredItems.map((item) => (
              <AccordionItem
                key={item.id}
                value={item.id}
                className={cn(
                  'border rounded-lg px-4 py-1',
                  expandedItems.includes(item.id)
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-white border-gray-200 hover:border-blue-200'
                )}
              >
                <AccordionTrigger className="hover:no-underline py-3">
                  <div className="flex items-center gap-2 text-right">
                    <span className="font-medium text-start">
                      {item.question}
                    </span>
                    {item.isPopular && (
                      <Badge
                        variant="outline"
                        className="bg-amber-50 text-amber-700 border-amber-200 text-xs whitespace-nowrap"
                      >
                        {dict.popularBadge}
                      </Badge>
                    )}
                  </div>
                </AccordionTrigger>
                <AccordionContent className="text-gray-700 pt-1 pb-4">
                  {item.answer}
                </AccordionContent>
              </AccordionItem>
            ))}
          </Accordion>
        )}
      </CardContent>
    </Card>
  );
}
--- End of Content for FAQ.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\MatchResultCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/MatchResultCard.tsx
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  X,
  MessageCircle,
  User,
  MapPin,
  Calendar,
  GraduationCap,
  Briefcase,
  Sparkles,
  Star,
  BookOpen,
  ChevronsDown,
  ChevronsUp,
  Music,
  Coffee,
  Bookmark,
  ExternalLink,
} from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { MatchResultCardDict } from '@/types/dictionary';

interface MatchTrait {
  name: string;
  score: number; // 0-100
  description?: string;
}

interface CommonInterest {
  name: string;
  category:
    | 'hobby'
    | 'value'
    | 'lifestyle'
    | 'religion'
    | 'education'
    | 'other';
  icon?: React.ReactNode;
}

interface MatchResultCardProps {
  id: string;
  name: string;
  age: number;
  location: string;
  distance?: number;
  profileImage?: string;
  matchPercentage: number;
  occupation?: string;
  education?: string;
  about?: string;
  matchTraits?: MatchTrait[];
  commonInterests?: CommonInterest[];
  lastActive?: Date;
  conversationStarted?: boolean;
  bookmarked?: boolean;
  className?: string;
  onAccept?: (id: string) => void;
  onReject?: (id: string) => void;
  onMessage?: (id: string) => void;
  onViewProfile?: (id: string) => void;
  onBookmark?: (id: string, bookmarked: boolean) => void;
  isPremium?: boolean;
  dict: MatchResultCardDict;
}

export default function MatchResultCard({
  id,
  name,
  age,
  location,
  distance,
  profileImage,
  matchPercentage,
  occupation,
  education,
  about,
  matchTraits = [],
  commonInterests = [],
  lastActive,
  conversationStarted = false,
  bookmarked = false,
  className,
  onAccept,
  onReject,
  onMessage,
  onViewProfile,
  onBookmark,
  isPremium = false,
  dict,
}: MatchResultCardProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isBookmarked, setIsBookmarked] = useState(bookmarked);
  const [showConfirmReject, setShowConfirmReject] = useState(false);

  const getCategoryIcon = (category: string) => {
    switch (category) {
      case 'hobby':
        return <Music className="h-3.5 w-3.5" />;
      case 'value':
        return <Heart className="h-3.5 w-3.5" />;
      case 'lifestyle':
        return <Coffee className="h-3.5 w-3.5" />;
      case 'religion':
        return <BookOpen className="h-3.5 w-3.5" />;
      case 'education':
        return <GraduationCap className="h-3.5 w-3.5" />;
      default:
        return <Star className="h-3.5 w-3.5" />;
    }
  };

  const formatLastActive = (date?: Date) => {
    if (!date) return dict.lastActiveFormat.unknown;
    const now = new Date();
    const diffInDays = Math.floor(
      (now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24)
    );
    if (diffInDays === 0) return dict.lastActiveFormat.today;
    if (diffInDays === 1) return dict.lastActiveFormat.yesterday;
    if (diffInDays < 7)
      return dict.lastActiveFormat.daysAgo.replace(
        '{{count}}',
        diffInDays.toString()
      );
    const diffInWeeks = Math.floor(diffInDays / 7);
    if (diffInDays < 30)
      return dict.lastActiveFormat.weeksAgo.replace(
        '{{count}}',
        diffInWeeks.toString()
      );
    const diffInMonths = Math.floor(diffInDays / 30);
    return dict.lastActiveFormat.monthsAgo.replace(
      '{{count}}',
      diffInMonths.toString()
    );
  };

  const handleBookmark = () => {
    setIsBookmarked(!isBookmarked);
    if (onBookmark) onBookmark(id, !isBookmarked);
  };

  const getMatchColor = () => {
    if (matchPercentage >= 90) return 'from-green-400 to-emerald-500';
    if (matchPercentage >= 80) return 'from-emerald-400 to-green-500';
    if (matchPercentage >= 70) return 'from-blue-400 to-blue-500';
    if (matchPercentage >= 60) return 'from-blue-400 to-cyan-500';
    return 'from-cyan-400 to-blue-500';
  };

  const expandVariants = {
    hidden: { height: 0, opacity: 0 },
    visible: {
      height: 'auto',
      opacity: 1,
      transition: {
        height: { duration: 0.3 },
        opacity: { duration: 0.3, delay: 0.1 },
      },
    },
  };

  return (
    <Card
      className={cn(
        'overflow-hidden transition-all border',
        isExpanded ? 'shadow-md' : 'shadow-sm hover:shadow-md',
        isPremium ? 'border-amber-200' : 'border-blue-100',
        className
      )}
    >
      {isPremium && (
        <div className="absolute top-0 left-0 bg-gradient-to-r from-amber-400 to-amber-600 text-white px-2 py-0.5 text-xs rounded-br-md z-10">
          <Sparkles className="h-3 w-3 inline-block mr-1" />
          {dict.premiumBadge}
        </div>
      )}

      <div className="p-4 flex md:flex-row flex-col gap-4">
        <div className="relative">
          <Avatar className="w-24 h-24 rounded-lg border-2 border-white shadow-sm">
            <AvatarImage src={profileImage} alt={name} />
            <AvatarFallback className="bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600 text-3xl">
              {name.charAt(0)}
            </AvatarFallback>
          </Avatar>
          <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2">
            <Badge
              className={cn(
                'rounded-full bg-gradient-to-r px-2 text-white border-0 shadow-sm',
                getMatchColor()
              )}
            >
              <Sparkles className="h-3 w-3 mr-1" />
              {dict.matchPercentageBadge.replace(
                '{{percentage}}',
                matchPercentage.toString()
              )}
            </Badge>
          </div>
        </div>

        <div className="flex-1 space-y-2">
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-lg font-medium">
                {name}, {age}
              </h3>
              <div className="flex items-center text-sm text-gray-600">
                <MapPin className="h-3.5 w-3.5 mr-1" />
                {location}
                {distance && <span className="mr-1">({distance} ×§×ž)</span>}
              </div>
            </div>
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="ghost"
                    size="icon"
                    className={cn(
                      'h-8 w-8 rounded-full',
                      isBookmarked ? 'text-amber-500' : 'text-gray-400'
                    )}
                    onClick={handleBookmark}
                  >
                    <Bookmark className="h-5 w-5" />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>
                    {isBookmarked
                      ? dict.tooltips.removeFromBookmarks
                      : dict.tooltips.addToBookmarks}
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>

          <div className="space-y-1">
            {occupation && (
              <div className="flex items-center text-sm text-gray-600">
                <Briefcase className="h-3.5 w-3.5 mr-1 text-gray-500" />
                {occupation}
              </div>
            )}
            {education && (
              <div className="flex items-center text-sm text-gray-600">
                <GraduationCap className="h-3.5 w-3.5 mr-1 text-gray-500" />
                {education}
              </div>
            )}
          </div>

          {commonInterests.length > 0 && (
            <div className="flex flex-wrap gap-1 pt-1">
              {commonInterests.slice(0, 3).map((interest, index) => (
                <Badge
                  key={index}
                  variant="outline"
                  className="bg-blue-50 text-blue-700 border-blue-200 text-xs py-0 h-5"
                >
                  {interest.icon || getCategoryIcon(interest.category)}
                  <span className="mr-1 truncate max-w-[100px]">
                    {interest.name}
                  </span>
                </Badge>
              ))}
              {commonInterests.length > 3 && (
                <Badge
                  variant="outline"
                  className="bg-gray-50 text-gray-600 border-gray-200 text-xs"
                >
                  +{commonInterests.length - 3}
                </Badge>
              )}
            </div>
          )}
        </div>
      </div>

      <div className="px-4 pb-3 flex gap-2 justify-center">
        {onReject &&
          (showConfirmReject ? (
            <>
              <Button
                variant="destructive"
                size="sm"
                className="flex-1"
                onClick={() => onReject(id)}
              >
                {dict.buttons.confirmReject}
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="flex-1"
                onClick={() => setShowConfirmReject(false)}
              >
                {dict.buttons.cancel}
              </Button>
            </>
          ) : (
            <Button
              variant="outline"
              size="sm"
              className="flex-1 border-red-200 text-red-600 hover:bg-red-50 hover:text-red-700"
              onClick={() => setShowConfirmReject(true)}
            >
              <X className="h-4 w-4 mr-1" />
              {dict.buttons.reject}
            </Button>
          ))}
        {onAccept && (
          <Button
            variant="default"
            size="sm"
            className="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700"
            onClick={() => onAccept(id)}
          >
            <Heart className="h-4 w-4 mr-1" />
            {dict.buttons.accept}
          </Button>
        )}
        {conversationStarted && onMessage && (
          <Button
            variant="default"
            size="sm"
            className="flex-1"
            onClick={() => onMessage(id)}
          >
            <MessageCircle className="h-4 w-4 mr-1" />
            {dict.buttons.continueChat}
          </Button>
        )}
      </div>

      <div className="px-4 pb-2 text-center">
        <Button
          variant="ghost"
          size="sm"
          className="text-xs text-gray-500 hover:text-gray-700"
          onClick={() => setIsExpanded(!isExpanded)}
        >
          {isExpanded ? (
            <>
              <ChevronsUp className="h-3.5 w-3.5 mr-1" />
              {dict.buttons.hideMore}
            </>
          ) : (
            <>
              <ChevronsDown className="h-3.5 w-3.5 mr-1" />
              {dict.buttons.showMore}
            </>
          )}
        </Button>
      </div>

      <AnimatePresence>
        {isExpanded && (
          <motion.div
            variants={expandVariants}
            initial="hidden"
            animate="visible"
            exit="hidden"
            className="border-t border-gray-100"
          >
            <CardContent className="p-4 space-y-5">
              {about && (
                <div className="space-y-2">
                  <h4 className="text-sm font-medium flex items-center">
                    <User className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.about.replace('{{name}}', name)}
                  </h4>
                  <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border">
                    {about}
                  </p>
                </div>
              )}
              {matchTraits.length > 0 && (
                <div className="space-y-3">
                  <h4 className="text-sm font-medium flex items-center">
                    <Sparkles className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.topMatches}
                  </h4>
                  <div className="space-y-2">
                    {matchTraits.map((trait, index) => (
                      <TooltipProvider key={index}>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <div className="space-y-1">
                              <div className="flex justify-between text-sm">
                                <span>{trait.name}</span>
                                <span className="text-sm text-gray-600">
                                  {trait.score}%
                                </span>
                              </div>
                              <Progress
                                value={trait.score}
                                className={cn(
                                  'h-2',
                                  trait.score >= 80
                                    ? '[--progress-foreground:theme(colors.green.500)]'
                                    : trait.score >= 60
                                      ? '[--progress-foreground:theme(colors.blue.500)]'
                                      : '[--progress-foreground:theme(colors.blue.400)]'
                                )}
                              />
                            </div>
                          </TooltipTrigger>
                          {trait.description && (
                            <TooltipContent side="top" className="max-w-xs">
                              <p>
                                {dict.tooltips.traitDescription.replace(
                                  '{{description}}',
                                  trait.description
                                )}
                              </p>
                            </TooltipContent>
                          )}
                        </Tooltip>
                      </TooltipProvider>
                    ))}
                  </div>
                </div>
              )}
              {commonInterests.length > 0 && (
                <div className="space-y-3">
                  <h4 className="text-sm font-medium flex items-center">
                    <Heart className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.commonInterests}
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {commonInterests.map((interest, index) => (
                      <Badge
                        key={index}
                        variant="outline"
                        className={cn(
                          'bg-blue-50 text-blue-700 border-blue-200',
                          interest.category === 'value' &&
                            'bg-pink-50 text-pink-700 border-pink-200',
                          interest.category === 'religion' &&
                            'bg-purple-50 text-purple-700 border-purple-200',
                          interest.category === 'education' &&
                            'bg-emerald-50 text-emerald-700 border-emerald-200'
                        )}
                      >
                        {interest.icon || getCategoryIcon(interest.category)}
                        <span className="mr-1">{interest.name}</span>
                      </Badge>
                    ))}
                  </div>
                </div>
              )}
              {lastActive && (
                <div className="text-sm text-gray-500 flex items-center">
                  <Calendar className="h-4 w-4 mr-1 text-gray-400" />
                  {dict.sections.lastActive.replace(
                    '{{time}}',
                    formatLastActive(lastActive)
                  )}
                </div>
              )}
            </CardContent>
            <CardFooter className="px-4 py-3 bg-gray-50 flex justify-between">
              {onViewProfile && (
                <Button
                  variant="outline"
                  size="sm"
                  className="w-full"
                  onClick={() => onViewProfile(id)}
                >
                  <ExternalLink className="h-4 w-4 mr-1" />
                  {dict.buttons.viewFullProfile}
                </Button>
              )}
            </CardFooter>
          </motion.div>
        )}
      </AnimatePresence>
    </Card>
  );
}
--- End of Content for MatchResultCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\UserStats.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/UserStats.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  UserCheck,
  Users,
  Calendar,
  Sparkles,
  Heart,
  CheckCheck,
  BarChart4,
  Zap,
  Award,
  Star,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { UserStatsDict } from '@/types/dictionary';

interface UserStatsProps {
  totalQuestionsAnswered: number;
  totalQuestionsCount: number;
  activeMatches?: number;
  pendingMatches?: number;
  matchScore?: number;
  profileCompletion?: number;
  activeWorldsCompleted?: string[];
  personalityTraits?: Array<{
    trait: string;
    score: number;
  }>;
  activityLevel?: 'low' | 'medium' | 'high';
  registrationDate?: Date;
  lastActive?: Date;
  className?: string;
  dict: UserStatsDict;
}

export default function UserStats({
  totalQuestionsAnswered,
  totalQuestionsCount,
  activeMatches = 0,
  pendingMatches = 0,
  matchScore = 0,
  profileCompletion = 0,
  activeWorldsCompleted = [],
  personalityTraits = [],
  activityLevel = 'medium',
  registrationDate,
  className,
  dict,
}: UserStatsProps) {
  const formatDate = (date?: Date) => {
    if (!date) return dict.common.notAvailable;
    return date.toLocaleDateString('he-IL');
  };

  const getDaysActive = () => {
    if (!registrationDate) return 0;
    const today = new Date();
    const diffTime = Math.abs(today.getTime() - registrationDate.getTime());
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  };

  const getActivityLevelColor = () => {
    switch (activityLevel) {
      case 'high':
        return 'text-green-600 bg-green-100';
      case 'medium':
        return 'text-blue-600 bg-blue-100';
      case 'low':
        return 'text-amber-600 bg-amber-100';
      default:
        return 'text-gray-600 bg-gray-100';
    }
  };

  const worldConfig = [
    { id: 'PERSONALITY', color: 'blue' },
    { id: 'VALUES', color: 'emerald' },
    { id: 'RELATIONSHIP', color: 'purple' },
    { id: 'PARTNER', color: 'pink' },
    { id: 'RELIGION', color: 'indigo' },
  ];

  return (
    <div className={cn('space-y-4', className)}>
      <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
        <CardHeader className="pb-2">
          <CardTitle className="text-lg flex items-center">
            <UserCheck className="h-5 w-5 mr-2 text-blue-500" />
            {dict.matchStatsCard.title}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
              <div className="text-xs text-gray-600 mb-1">
                {dict.matchStatsCard.activeMatches}
              </div>
              <div className="flex items-center">
                <Users className="h-5 w-5 text-blue-600 mr-2" />
                <span className="text-2xl font-semibold">{activeMatches}</span>
              </div>
            </div>
            <div className="bg-amber-50 p-3 rounded-lg border border-amber-100">
              <div className="text-xs text-gray-600 mb-1">
                {dict.matchStatsCard.pendingMatches}
              </div>
              <div className="flex items-center">
                <Calendar className="h-5 w-5 text-amber-600 mr-2" />
                <span className="text-2xl font-semibold">{pendingMatches}</span>
              </div>
            </div>
            <div className="col-span-2 bg-gray-50 p-3 rounded-lg border">
              <div className="flex justify-between mb-1">
                <div className="text-xs text-gray-600">
                  {dict.matchStatsCard.matchScore}
                </div>
                <Badge variant="outline" className="text-xs">
                  {matchScore}%
                </Badge>
              </div>
              <Progress
                value={matchScore}
                className={cn(
                  'h-2',
                  matchScore > 70
                    ? '[--progress-foreground:theme(colors.green.500)]'
                    : '[--progress-foreground:theme(colors.blue.500)]'
                )}
              />
            </div>
            <div className="col-span-2 flex justify-between text-sm p-2">
              <div className="flex items-center text-gray-600">
                <Sparkles className="h-4 w-4 mr-1 text-blue-400" />
                {dict.matchStatsCard.daysActive.replace(
                  '{{days}}',
                  getDaysActive().toString()
                )}
              </div>
              <div className="text-gray-600">
                {dict.matchStatsCard.joinDate.replace(
                  '{{date}}',
                  formatDate(registrationDate)
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
        <CardHeader className="pb-2">
          <CardTitle className="text-lg flex items-center">
            <BarChart4 className="h-5 w-5 mr-2 text-blue-500" />
            {dict.profileProgressCard.title}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="space-y-1">
              <div className="flex justify-between text-sm">
                <div className="flex items-center">
                  <CheckCheck className="h-4 w-4 mr-1 text-blue-500" />
                  {dict.profileProgressCard.profileCompletion}
                </div>
                <Badge
                  variant="outline"
                  className={cn(
                    'text-xs',
                    profileCompletion >= 80
                      ? 'border-green-500 text-green-600'
                      : 'border-amber-500 text-amber-600'
                  )}
                >
                  {profileCompletion}%
                </Badge>
              </div>
              <Progress
                value={profileCompletion}
                className={cn(
                  'h-2',
                  profileCompletion < 30
                    ? '[--progress-foreground:theme(colors.red.500)]'
                    : profileCompletion < 70
                      ? '[--progress-foreground:theme(colors.amber.500)]'
                      : '[--progress-foreground:theme(colors.green.500)]'
                )}
              />
            </div>
            <div className="space-y-1">
              <div className="flex justify-between text-sm">
                <div className="flex items-center">
                  <Zap className="h-4 w-4 mr-1 text-amber-500" />
                  {dict.profileProgressCard.questionsAnswered}
                </div>
                <span className="text-xs text-gray-600">
                  {totalQuestionsAnswered} {dict.profileProgressCard.outOf}{' '}
                  {totalQuestionsCount}
                </span>
              </div>
              <Progress
                value={(totalQuestionsAnswered / totalQuestionsCount) * 100}
                className="h-2"
              />
            </div>
            <div className="pt-2">
              <div className="text-sm mb-2 flex items-center">
                <Heart className="h-4 w-4 mr-1 text-pink-500" />
                <span>{dict.profileProgressCard.completedWorlds}</span>
              </div>
              <div className="flex flex-wrap gap-2">
                {worldConfig.map((world) => {
                  const isCompleted = activeWorldsCompleted.includes(world.id);
                  const worldName =
                    dict.worlds[world.id as keyof typeof dict.worlds];
                  return (
                    <Badge
                      key={world.id}
                      variant={isCompleted ? 'default' : 'outline'}
                      className={
                        isCompleted
                          ? `bg-${world.color}-100 hover:bg-${world.color}-200 text-${world.color}-800 border-${world.color}-200`
                          : `text-gray-500 border-gray-200 bg-gray-50`
                      }
                    >
                      {isCompleted && <CheckCheck className="h-3 w-3 mr-1" />}
                      {worldName}
                    </Badge>
                  );
                })}
              </div>
            </div>
            {activityLevel && (
              <div className="flex justify-between items-center pt-2 text-sm text-gray-600">
                <div>{dict.profileProgressCard.activityLevel}</div>
                <Badge
                  variant="outline"
                  className={cn(
                    'font-normal border-0',
                    getActivityLevelColor()
                  )}
                >
                  {dict.activityLevels[activityLevel]}
                </Badge>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {personalityTraits && personalityTraits.length > 0 && (
        <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg flex items-center">
              <Award className="h-5 w-5 mr-2 text-blue-500" />
              {dict.personalityTraitsCard.title}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {personalityTraits.map((trait, index) => (
                <TooltipProvider key={index}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <div className="space-y-1">
                        <div className="flex justify-between text-sm">
                          <div className="flex items-center">
                            <Star className="h-3.5 w-3.5 mr-1 text-amber-500" />
                            {trait.trait}
                          </div>
                          <span className="text-xs">{trait.score}%</span>
                        </div>
                        <Progress
                          value={trait.score}
                          className={cn(
                            'h-1.5',
                            'relative overflow-hidden',
                            'before:absolute before:inset-0 before:bg-gradient-to-r before:from-blue-400',
                            trait.score < 40
                              ? 'before:to-blue-500'
                              : trait.score < 70
                                ? 'before:to-purple-500'
                                : 'before:to-pink-500'
                          )}
                        />
                      </div>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {dict.tooltips.traitScore.replace(
                          '{{score}}',
                          trait.score.toString()
                        )}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
--- End of Content for UserStats.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks\useIdleTimeout.ts
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/hooks/useIdleTimeout.ts
import { useState, useEffect, useCallback, useRef } from 'react';

interface UseIdleTimeoutProps {
  onIdle: () => void;
  idleTimeSeconds?: number;
}

export function useIdleTimeout({ onIdle, idleTimeSeconds = 7200 }: UseIdleTimeoutProps) { // ×‘×¨×™×¨×ª ×ž×—×“×œ: ×©×¢×ª×™×™×
  const [isIdle, setIsIdle] = useState(false);
  // --- This is the corrected line ---
  const timeoutId = useRef<NodeJS.Timeout | null>(null);

  const startTimer = useCallback(() => {
    // Clear any existing timer before starting a new one
    if (timeoutId.current) {
      clearTimeout(timeoutId.current);
    }
    
    timeoutId.current = setTimeout(() => {
      setIsIdle(true);
      onIdle();
    }, idleTimeSeconds * 1000);
  }, [idleTimeSeconds, onIdle]);

  const resetTimer = useCallback(() => {
    // The previous implementation was already correct, it just needed the right type
    if (timeoutId.current) {
      clearTimeout(timeoutId.current);
    }
    setIsIdle(false);
    startTimer();
  }, [startTimer]);

  const handleEvent = useCallback(() => {
    resetTimer();
  }, [resetTimer]);

  useEffect(() => {
    // ××™×¨×•×¢×™× ×©×™××¤×¡×• ××ª ×”×˜×™×™×ž×¨
    const events = ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'];
    
    // ×”×ª×—×œ×ª ×”×˜×™×™×ž×¨ ×”×¨××©×•× ×™
    startTimer();

    // ×”×•×¡×¤×ª ×ž××–×™× ×™×
    events.forEach(event => window.addEventListener(event, handleEvent));

    // × ×™×§×•×™
    return () => {
      if (timeoutId.current) {
        clearTimeout(timeoutId.current);
      }
      events.forEach(event => window.removeEventListener(event, handleEvent));
    };
  }, [handleEvent, startTimer]);

  return { isIdle, resetTimer };
}
--- End of Content for useIdleTimeout.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks\useMediaQuery.ts
--------------------------------------------------------------------------------
Content:
import { useState, useEffect } from "react";

/**
 * ×”×•×§ ×”×ž××¤×©×¨ ×œ× ×˜×¨ ×©×™× ×•×™×™× ×‘×ž×“×™×” ×§×•×•×¨×™
 * 
 * @param query ×ž×—×¨×•×–×ª ×ž×“×™×” ×§×•×•×¨×™ ×›×’×•×Ÿ "(max-width: 768px)"
 * @returns ×‘×•×œ×™×× ×™ ×”×ž×¦×™×™×Ÿ ×”×× ×”×ž×“×™×” ×§×•×•×¨×™ ×¤×¢×™×œ
 * 
 * ×“×•×’×ž××•×ª ×œ×©×™×ž×•×©:
 * const isMobile = useMediaQuery("(max-width: 768px)");
 * const isTablet = useMediaQuery("(min-width: 769px) and (max-width: 1024px)");
 * const isDesktop = useMediaQuery("(min-width: 1025px)");
 */
export function useMediaQuery(query: string): boolean {
  // ×ž×¦×‘ ×”×ª××ž×ª ×”×ž×“×™×” ×”× ×•×›×—×™×ª
  const [matches, setMatches] = useState<boolean>(false);

  // ×–×™×”×•×™ ×”×× ×× ×• × ×ž×¦××™× ×‘×¡×‘×™×‘×ª ×“×¤×“×¤×Ÿ
  const isBrowser = typeof window !== "undefined";

  useEffect(() => {
    // ×× ××™× × ×• ×‘×“×¤×“×¤×Ÿ, ××™×Ÿ ×˜×¢× ×œ×”×ž×©×™×š
    if (!isBrowser) {
      return undefined;
    }

    // ×‘×“×™×§×” ×¨××©×•× ×™×ª ×©×œ ×”×ª××ž×ª ×”×ž×“×™×”
    const media = window.matchMedia(query);
    setMatches(media.matches);

    // ×›×©×ž×ª×¨×—×© ×©×™× ×•×™ ×‘×”×ª××ž×ª ×”×ž×“×™×”, ×¢×“×›×Ÿ ××ª ×”×ž×¦×‘
    const listener = (event: MediaQueryListEvent) => {
      setMatches(event.matches);
    };

    // ×¨×™×©×•× ×”××–× ×” ×œ×©×™× ×•×™×™×
    if (media.addEventListener) {
      media.addEventListener("change", listener);
    } else {
      // ×ª×ž×™×›×” ×‘×“×¤×“×¤× ×™× ×™×©× ×™× ×™×•×ª×¨
      media.addListener(listener);
    }

    // × ×™×§×•×™ ×”××–× ×” ×‘×¢×ª ×¢×–×™×‘×ª ×”×§×•×ž×¤×•× × ×˜×”
    return () => {
      if (media.removeEventListener) {
        media.removeEventListener("change", listener);
      } else {
        // ×ª×ž×™×›×” ×‘×“×¤×“×¤× ×™× ×™×©× ×™× ×™×•×ª×¨
        media.removeListener(listener);
      }
    };
  }, [query, isBrowser]);

  return matches;
}

// ×ž×§×¦×¨×™× × ×¤×•×¦×™× ×œ×©×™×ž×•×©
export function useIsMobile() {
  return useMediaQuery("(max-width: 767px)");
}

export function useIsTablet() {
  return useMediaQuery("(min-width: 768px) and (max-width: 1023px)");
}

export function useIsDesktop() {
  return useMediaQuery("(min-width: 1024px)");
}

export function useIsDarkMode() {
  return useMediaQuery("(prefers-color-scheme: dark)");
}

export function useReducedMotion() {
  return useMediaQuery("(prefers-reduced-motion: reduce)");
}

export default useMediaQuery;
--- End of Content for useMediaQuery.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\QuestionnaireLayout.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/QuestionnaireLayout.tsx
'use client';

import React, { useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import {
  Loader2,
  Menu,
  Save,
  CheckCircle,
  LogIn,
  UserPlus,
} from 'lucide-react';
import type { WorldId } from '../types/types';
import { cn } from '@/lib/utils';
import { useMediaQuery } from '../hooks/useMediaQuery';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { QuestionnaireSidebar } from './QuestionnaireSidebar';
import type {
  QuestionnaireLayoutDict,
  MatchmakingQuestionnaireDict,
  QuestionnaireFaqDict,
  AccessibilityFeaturesDict,
} from '@/types/dictionary';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';

// Props Interface
export interface QuestionnaireLayoutProps {
  children: React.ReactNode;
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit?: () => void;
  locale?: 'he' | 'en';
  onSaveProgress?: () => Promise<void>;
  dict: {
    layout: QuestionnaireLayoutDict;
    worldLabels: MatchmakingQuestionnaireDict['worldLabels'];
    faq: QuestionnaireFaqDict;
    accessibilityFeatures: AccessibilityFeaturesDict;
  };
  // Props ×—×“×©×™× ×©×™×•×¢×‘×¨×• ×ž-WorldComponent
  mobileHeaderContent?: React.ReactNode;
  onMenuOpen?: () => void;
}

// Note: Specific world colors (Sky, Rose, etc.) are kept for the specific world content,
// but the layout shell uses the new global palette (Teal/Orange).

export default function QuestionnaireLayout({
  children,
  currentWorld,
  completedWorlds,
  onWorldChange,
  onExit,
  locale = 'he',
  onSaveProgress,
  dict,
  mobileHeaderContent,
  onMenuOpen,
}: QuestionnaireLayoutProps) {
  const { status } = useSession();
  const router = useRouter();
  const isLoggedIn = status === 'authenticated';

  const [isSaving, setIsSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);

  const isDesktop = useMediaQuery('(min-width: 1024px)');
  const isRTL = locale === 'he';

  const handleSave = useCallback(async () => {
    if (!onSaveProgress) return;
    setIsSaving(true);
    try {
      await onSaveProgress();
      setLastSaved(new Date());
      setSaveSuccess(true);
      setTimeout(() => setSaveSuccess(false), 2000);
    } catch (err) {
      console.error('Save failed in layout:', err);
    } finally {
      setIsSaving(false);
    }
  }, [onSaveProgress]);

  const handleMenuOpen = () => {
    setIsMobileSidebarOpen(true);
    if (onMenuOpen) {
      onMenuOpen();
    }
  };

  return (
    <div
      className={cn(
        // Updated Main Background
        'min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        isRTL ? 'rtl' : 'ltr'
      )}
    >
      {isDesktop ? (
        <div className="flex flex-row">
          <QuestionnaireSidebar
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={onWorldChange}
            onExit={onExit!}
            locale={locale}
            isLoggedIn={isLoggedIn}
            onSaveProgress={handleSave}
            isSaving={isSaving}
            saveSuccess={saveSuccess}
            lastSaved={lastSaved}
            dict={{
              layout: dict.layout,
              worldLabels: dict.worldLabels,
              faq: dict.faq,
              accessibilityFeatures: dict.accessibilityFeatures,
            }}
          />
          <main className="flex-1 overflow-y-auto p-4 md:p-8 lg:p-10">
            {children}
          </main>
        </div>
      ) : (
        <div className="flex flex-col">
          {/* Mobile Sidebar Sheet - Hidden by default */}
          <Sheet
            open={isMobileSidebarOpen}
            onOpenChange={setIsMobileSidebarOpen}
          >
            <SheetContent
              side={isRTL ? 'right' : 'left'}
              className="w-[320px] p-0 flex flex-col"
            >
              <QuestionnaireSidebar
                currentWorld={currentWorld}
                completedWorlds={completedWorlds}
                onWorldChange={(worldId) => {
                  onWorldChange(worldId);
                  setIsMobileSidebarOpen(false);
                }}
                onExit={() => {
                  if (onExit) onExit();
                  setIsMobileSidebarOpen(false);
                }}
                locale={locale}
                isLoggedIn={isLoggedIn}
                onSaveProgress={handleSave}
                isSaving={isSaving}
                saveSuccess={saveSuccess}
                lastSaved={lastSaved}
                dict={dict}
              />
            </SheetContent>
          </Sheet>

          <main className="flex-1">
            {!isLoggedIn && (
              <div className="p-4">
                {/* Updated Unauthenticated Prompt Colors */}
                <div className="rounded-xl bg-amber-50 p-4 border border-amber-200 text-center">
                  <h3 className="text-sm font-semibold text-amber-800">
                    {dict.layout.unauthenticatedPrompt.title}
                  </h3>
                  <p className="text-xs text-amber-700 mt-1">
                    {dict.layout.unauthenticatedPrompt.subtitle}
                  </p>
                  <div className="flex justify-center gap-2 mt-3">
                    <Button
                      size="sm"
                      // Teal buttons for action
                      className="bg-teal-600 hover:bg-teal-700 text-white"
                      onClick={() => router.push('/auth/signin')}
                    >
                      <LogIn className="w-4 h-4 ml-2" />
                      {dict.layout.unauthenticatedPrompt.loginButton}
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      className="border-teal-600 text-teal-700 hover:bg-teal-50"
                      onClick={() => router.push('/auth/register')}
                    >
                      <UserPlus className="w-4 h-4 ml-2" />
                      {dict.layout.unauthenticatedPrompt.registerButton}
                    </Button>
                  </div>
                </div>
              </div>
            )}
            <div className="p-2 sm:p-4">
              {/* Pass menu opener function to children */}
              {React.Children.map(children, (child) => {
                if (React.isValidElement(child)) {
                  return React.cloneElement(child as React.ReactElement<any>, {
                    onMobileMenuOpen: handleMenuOpen,
                  });
                }
                return child;
              })}
            </div>
          </main>
        </div>
      )}
    </div>
  );
}
--- End of Content for QuestionnaireLayout.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\QuestionnaireSidebar.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/QuestionnaireSidebar.tsx
'use client';

import React from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  Heart,
  User,
  Users,
  Save,
  CheckCircle,
  Loader2,
  UserCheck,
  Home,
  LogIn,
  UserPlus,
  Scroll,
  ChevronLeft,
  ChevronRight,
  Edit,
  BookUser,
  Info,
  Sparkles,
  Target,
  Compass,
  Award,
  Check,
} from 'lucide-react';
import type { WorldId } from '../types/types';
import { cn } from '@/lib/utils';
import { motion } from 'framer-motion';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import FAQ from '../components/FAQ';
import type {
  QuestionnaireLayoutDict,
  MatchmakingQuestionnaireDict,
  QuestionnaireFaqDict,
  AccessibilityFeaturesDict,
} from '@/types/dictionary';

// Interface for props
interface QuestionnaireSidebarProps {
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit: () => void;
  locale: 'he' | 'en';
  isLoggedIn: boolean;
  onSaveProgress: () => Promise<void>;
  isSaving: boolean;
  saveSuccess: boolean;
  lastSaved: Date | null;
  dict: {
    layout: QuestionnaireLayoutDict;
    worldLabels: MatchmakingQuestionnaireDict['worldLabels'];
    faq: QuestionnaireFaqDict;
    accessibilityFeatures: AccessibilityFeaturesDict;
  };
}

const worldConfig = {
  PERSONALITY: { icon: User, themeColor: 'sky', order: 1 },
  VALUES: { icon: Heart, themeColor: 'rose', order: 2 },
  RELATIONSHIP: { icon: Users, themeColor: 'purple', order: 3 },
  PARTNER: { icon: UserCheck, themeColor: 'teal', order: 4 },
  RELIGION: { icon: Scroll, themeColor: 'amber', order: 5 },
} as const;

const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

const colorMap = {
  sky: {
    gradient: 'from-sky-400 to-blue-500',
    bg: 'bg-sky-50',
    text: 'text-sky-600',
    border: 'border-sky-300',
    ring: 'ring-sky-400',
  },
  rose: {
    gradient: 'from-rose-400 to-pink-500',
    bg: 'bg-rose-50',
    text: 'text-rose-600',
    border: 'border-rose-300',
    ring: 'ring-rose-400',
  },
  purple: {
    gradient: 'from-purple-400 to-indigo-500',
    bg: 'bg-purple-50',
    text: 'text-purple-600',
    border: 'border-purple-300',
    ring: 'ring-purple-400',
  },
  teal: {
    gradient: 'from-teal-400 to-emerald-500',
    bg: 'bg-teal-50',
    text: 'text-teal-600',
    border: 'border-teal-300',
    ring: 'ring-teal-400',
  },
  amber: {
    gradient: 'from-amber-400 to-orange-500',
    bg: 'bg-amber-50',
    text: 'text-amber-600',
    border: 'border-amber-300',
    ring: 'ring-amber-400',
  },
};

const completedStyles = {
  sky: {
    border: 'border-sky-300',
    bgGradient: 'bg-gradient-to-r from-sky-50 to-sky-100',
    hoverGradient: 'hover:from-sky-100 hover:to-sky-150',
  },
  rose: {
    border: 'border-rose-300',
    bgGradient: 'bg-gradient-to-r from-rose-50 to-rose-100',
    hoverGradient: 'hover:from-rose-100 hover:to-rose-150',
  },
  purple: {
    border: 'border-purple-300',
    bgGradient: 'bg-gradient-to-r from-purple-50 to-purple-100',
    hoverGradient: 'hover:from-purple-100 hover:to-purple-150',
  },
  teal: {
    border: 'border-teal-300',
    bgGradient: 'bg-gradient-to-r from-teal-50 to-teal-100',
    hoverGradient: 'hover:from-teal-100 hover:to-teal-150',
  },
  amber: {
    border: 'border-amber-300',
    bgGradient: 'bg-gradient-to-r from-amber-50 to-amber-100',
    hoverGradient: 'hover:from-amber-100 hover:to-amber-150',
  },
} as const;

type ThemeColor = keyof typeof colorMap;

const NavButton = React.memo(
  ({
    worldId,
    currentWorld,
    completedWorlds,
    onWorldChange,
    dict,
    isMobile = false,
    currentThemeColor,
    locale,
  }: {
    worldId: WorldId;
    currentWorld: WorldId;
    completedWorlds: WorldId[];
    onWorldChange: (worldId: WorldId) => void;
    dict: QuestionnaireSidebarProps['dict'];
    isMobile?: boolean;
    currentThemeColor: ThemeColor;
    locale: 'he' | 'en';
  }) => {
    const { icon: Icon, themeColor, order } = worldConfig[worldId];
    const label = dict.worldLabels[worldId];
    const isActive = currentWorld === worldId;
    const isCompleted = completedWorlds.includes(worldId);
    const colors = colorMap[themeColor];
    const currentColors = colorMap[currentThemeColor];
    const isRTL = locale === 'he';

    let status: 'active' | 'completed' | 'available' = 'available';
    if (isActive) status = 'active';
    else if (isCompleted) status = 'completed';

    const statusConfig = {
      active: {
        containerClass: cn(
          'relative overflow-hidden border-2 shadow-lg',
          `bg-gradient-to-r ${colors.gradient} ${colors.border}`,
          'ring-2 ring-offset-1',
          colors.ring
        ),
        textClass: 'text-white font-bold',
        iconClass: 'text-white',
        badge: (
          <motion.div
            animate={{ x: [0, 3, 0] }}
            transition={{ duration: 1.5, repeat: Infinity }}
            className="flex-shrink-0"
          >
            {isRTL ? (
              <ChevronLeft className="h-5 w-5 text-white" />
            ) : (
              <ChevronRight className="h-5 w-5 text-white" />
            )}
          </motion.div>
        ),
        shimmer: true,
      },
      completed: {
        containerClass: cn(
          'border-2 shadow-sm hover:shadow-md',
          completedStyles[currentThemeColor].border,
          completedStyles[currentThemeColor].bgGradient,
          completedStyles[currentThemeColor].hoverGradient
        ),
        textClass: cn('font-semibold', currentColors.text),
        iconClass: currentColors.text,
        badge: (
          <div className="flex items-center gap-1">
            <Check className={cn('h-4 w-4', currentColors.text)} />
            <Edit
              className={cn('h-3.5 w-3.5 opacity-60', currentColors.text)}
            />
          </div>
        ),
        shimmer: false,
      },
      available: {
        containerClass: cn(
          'bg-white border-2 border-gray-200',
          'hover:bg-gray-50 hover:border-gray-300',
          'shadow-sm hover:shadow'
        ),
        textClass: 'text-gray-700 font-medium',
        iconClass: colors.text,
        badge: null,
        shimmer: false,
      },
    };
    const config = statusConfig[status];

    return (
      <motion.div
        initial={{ opacity: 0, x: isMobile ? 0 : -20 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay: order * 0.05 }}
      >
        <Button
          variant="ghost"
          size={isMobile ? 'sm' : 'default'}
          className={cn(
            'flex items-center justify-between w-full mb-2.5 transition-all duration-300 rounded-xl relative',
            config.containerClass,
            isMobile ? 'py-3 px-3' : 'p-4 h-auto'
          )}
          onClick={() => onWorldChange(worldId)}
        >
          {config.shimmer && (
            <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full animate-shimmer"></span>
          )}
          <div className="relative z-10 flex items-center gap-3 flex-1">
            <div
              className={cn(
                'p-2 rounded-lg flex-shrink-0 transition-all duration-300',
                status === 'active'
                  ? 'bg-white/20 backdrop-blur-sm'
                  : status === 'completed'
                    ? currentColors.bg
                    : colors.bg
              )}
            >
              <Icon className={cn('h-5 w-5', config.iconClass)} />
            </div>
            <div className="flex flex-col items-start flex-1 min-w-0">
              <span className={cn('truncate text-sm', config.textClass)}>
                {label}
              </span>
              {!isMobile && (
                <span
                  className={cn(
                    'text-xs font-normal',
                    status === 'active' ? 'text-white/80' : 'text-gray-500'
                  )}
                >
                  {status === 'active' && dict.layout.navButtonStatus.active}
                  {status === 'completed' &&
                    dict.layout.navButtonStatus.completed}
                  {status === 'available' &&
                    dict.layout.navButtonStatus.available.replace(
                      '{{order}}',
                      String(order)
                    )}
                </span>
              )}
            </div>
            <div className="flex-shrink-0">{config.badge}</div>
          </div>
        </Button>
      </motion.div>
    );
  }
);
NavButton.displayName = 'NavButton';

const _QuestionnaireSidebar: React.FC<QuestionnaireSidebarProps> = ({
  currentWorld,
  completedWorlds,
  onWorldChange,
  onExit,
  locale,
  isLoggedIn,
  onSaveProgress,
  isSaving,
  saveSuccess,
  lastSaved,
  dict,
}) => {
  const isRTL = locale === 'he';
  const profileLinkWithTab = `/${locale}/profile?tab=questionnaire`;
  const currentThemeColor = worldConfig[currentWorld].themeColor;
  const currentColors = colorMap[currentThemeColor];

  const completionPercent = Math.round(
    (completedWorlds.length / WORLD_ORDER.length) * 100
  );

  return (
    <>
      <div className="relative p-6 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white">
        <div className="absolute inset-0 bg-black/5" />
        <div className="relative z-10">
          <div className="flex items-center gap-3 mb-3">
            <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
              <Compass className="h-6 w-6" />
            </div>
            <div>
              <h3 className="font-extrabold text-2xl">
                {dict.layout.sidebarHeader.title}
              </h3>
              <p className="text-sm text-white/90">
                {dict.layout.sidebarHeader.subtitle}
              </p>
            </div>
          </div>
        </div>
      </div>
      <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        className="mx-4 my-4 p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200/60 shadow-sm"
      >
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <div className={cn('p-1.5 rounded-lg', currentColors.bg)}>
              <Target className={cn('h-4 w-4', currentColors.text)} />
            </div>
            <span className="text-sm font-bold text-gray-800">
              {dict.layout.sidebarProgress.title}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs font-medium text-gray-600">
              {dict.layout.sidebarProgress.worldsLabel
                .replace('{{completedCount}}', String(completedWorlds.length))
                .replace('{{totalCount}}', String(WORLD_ORDER.length))}
            </span>
            <span className={cn('text-base font-bold', currentColors.text)}>
              {completionPercent}%
            </span>
          </div>
        </div>
        <div className="relative h-2 bg-gray-200 rounded-full overflow-hidden">
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: `${completionPercent}%` }}
            transition={{ duration: 1, ease: 'easeOut' }}
            className={cn(
              'absolute inset-y-0 left-0 bg-gradient-to-r rounded-full',
              currentColors.gradient
            )}
          />
        </div>
        {completionPercent === 100 && (
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            className="flex items-center justify-center gap-2 mt-2"
          >
            <Award className="h-4 w-4 text-amber-500" />
            <p className="text-xs font-bold text-amber-600">
              {dict.layout.sidebarProgress.completionMessage}
            </p>
          </motion.div>
        )}
      </motion.div>
      <div className="flex-1 px-4 py-3 overflow-y-auto">
        <div className="space-y-1">
          {WORLD_ORDER.map((worldId) => (
            <NavButton
              key={worldId}
              worldId={worldId}
              currentWorld={currentWorld}
              completedWorlds={completedWorlds}
              onWorldChange={onWorldChange}
              dict={dict}
              currentThemeColor={currentThemeColor}
              locale={locale}
            />
          ))}
        </div>
      </div>
      {!isLoggedIn && (
        <div className="px-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.4 }}
            className="mx-auto my-3 p-5 bg-gradient-to-br from-cyan-50 via-blue-50 to-indigo-50 border-2 border-cyan-300/60 rounded-xl shadow-md"
          >
            <div className="text-center space-y-3">
              <div className="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full shadow-lg mb-2">
                <Sparkles className="w-6 h-6 text-white" />
              </div>
              <p className="text-base text-cyan-900 font-bold">
                {dict.layout.unauthenticatedPrompt.title}
              </p>
              <p className="text-sm text-cyan-700 leading-relaxed">
                {dict.layout.unauthenticatedPrompt.subtitle}
              </p>
              <div className="flex gap-2 justify-center pt-2">
                <Link href="/auth/signin">
                  <Button
                    variant="outline"
                    size="sm"
                    className="bg-white/90 border-2 border-cyan-300 text-cyan-700 hover:bg-cyan-50 hover:border-cyan-400 font-semibold shadow-sm"
                  >
                    <LogIn className="w-4 h-4 ml-1" />
                    {dict.layout.unauthenticatedPrompt.loginButton}
                  </Button>
                </Link>
                <Link href="/auth/register">
                  <Button
                    size="sm"
                    className="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold shadow-md"
                  >
                    <UserPlus className="w-4 h-4 ml-1" />
                    {dict.layout.unauthenticatedPrompt.registerButton}
                  </Button>
                </Link>
              </div>
            </div>
          </motion.div>
        </div>
      )}
      <div className="p-4 border-t-2 border-gray-200 mt-auto space-y-3 bg-gray-50/50">
        {lastSaved && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="flex items-center justify-center gap-2 p-2 bg-green-100/80 rounded-lg border border-green-300/60"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <span className="text-xs font-semibold text-green-700">
              {dict.layout.lastSavedSuccess.replace(
                '{{time}}',
                lastSaved.toLocaleTimeString(
                  locale === 'he' ? 'he-IL' : 'en-US'
                )
              )}
            </span>
          </motion.div>
        )}
        <Button
          variant="outline"
          className={cn(
            'w-full font-bold shadow-sm border-2 transition-all duration-300',
            saveSuccess
              ? 'bg-green-100 border-green-300 text-green-700'
              : 'bg-white hover:bg-gray-50 border-gray-300'
          )}
          onClick={onSaveProgress}
          disabled={isSaving}
        >
          {isSaving ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              {dict.layout.saveButton.saving}
            </>
          ) : saveSuccess ? (
            <>
              <CheckCircle className="w-4 h-4 mr-2" />
              {dict.layout.saveButton.saved}
            </>
          ) : (
            <>
              <Save className="w-4 h-4 mr-2" />
              {dict.layout.saveButton.default}
            </>
          )}
        </Button>
        <Link href={profileLinkWithTab}>
          <Button
            variant="outline"
            className="w-full font-semibold border-2 border-teal-300 text-teal-700 hover:bg-teal-50 hover:border-teal-400"
          >
            <BookUser className="w-4 h-4 mr-2" />
            {dict.layout.actionButtons.review}
          </Button>
        </Link>
        <Button
          variant="outline"
          className="w-full font-semibold border-2 border-gray-300 hover:bg-gray-50"
          onClick={onExit}
        >
          <Home className="w-4 h-4 mr-2" />
          {dict.layout.actionButtons.exitToMap}
        </Button>
        <Sheet>
          <SheetTrigger asChild>
            <Button
              variant="outline"
              size="default"
              className="w-full justify-start gap-2 bg-white hover:bg-gray-50 border-2 border-gray-200 font-semibold"
            >
              <div className="p-1 bg-purple-100 rounded">
                <Info className="h-3.5 w-3.5 text-purple-600" />
              </div>
              {dict.layout.actionButtons.faq}
            </Button>
          </SheetTrigger>
          <SheetContent
            side={isRTL ? 'left' : 'right'}
            className="w-full sm:max-w-lg"
          >
            <SheetHeader>
              <SheetTitle className="text-xl font-bold">
                {dict.layout.faqSheet.title}
              </SheetTitle>
            </SheetHeader>
            <div className="mt-6">
              <FAQ dict={dict.faq} />
            </div>
          </SheetContent>
        </Sheet>
      </div>
    </>
  );
};

export const QuestionnaireSidebar: React.FC<QuestionnaireSidebarProps> = (
  props
) => {
  return (
    <aside className="w-full lg:w-96 bg-gradient-to-b from-white to-gray-100/60 border-e-2 border-gray-200/80 flex flex-col h-screen sticky top-0">
      <_QuestionnaireSidebar {...props} />
    </aside>
  );
};
--- End of Content for QuestionnaireSidebar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\WorldsMap.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/WorldsMap.tsx

'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import Link from 'next/link';
import { motion, AnimatePresence, useInView } from 'framer-motion';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  Scroll,
  Heart,
  Users,
  User,
  CheckCircle2,
  Lock,
  ArrowRight,
  Star,
  UserCheck,
  Sparkles,
  Edit3,
  Award,
  BookUser,
  ChevronDown,
  Compass,
  Map,
  Check,
  Clock,
  ArrowLeft,
  Trophy,
  Target,
  Zap,
  TrendingUp,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useSession } from 'next-auth/react';
import type { WorldsMapDict, WorldsMapWorldContent } from '@/types/dictionary';
import type { QuestionnaireAnswer, WorldId } from '../types/types';

// Visual configuration (icons, colors)
const worldsConfig = {
  PERSONALITY: { icon: User, order: 1, themeColor: 'sky' },
  VALUES: { icon: Heart, order: 2, themeColor: 'rose' },
  RELATIONSHIP: {
    icon: Users,
    order: 3,
    themeColor: 'purple',
  },
  PARTNER: {
    icon: UserCheck,
    order: 4,
    themeColor: 'teal',
  },
  RELIGION: { icon: Scroll, order: 5, themeColor: 'amber' },
} as const;

// Ensure this matches your WorldId type definition
const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

type WorldStatus =
  | 'completed'
  | 'recommended'
  | 'active'
  | 'available'
  | 'locked';

// Component Props Interfaces
interface WorldsMapProps {
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  answers: QuestionnaireAnswer[];
  worldStats: Record<WorldId, { questionCount: number }>;
  className?: string;
  dict: WorldsMapDict;
  locale: 'he' | 'en';
}

interface WorldCardProps {
  worldId: WorldId;
  status: WorldStatus;
  onSelect: () => void;
  dict: WorldsMapDict['worldCard'];
  fullContent: WorldsMapWorldContent; // <--- ×”×ª×™×§×•×Ÿ: ×©×™×ž×•×© ×‘×˜×™×¤×•×¡ ×”×™×©×™×¨
  stats: { questionCount: number; estimatedTime: number };
  progress: { completed: number; total: number };
  locale: 'he' | 'en';
  worldNumber: number;
}

interface ProgressHeaderProps {
  userName?: string | null;
  completionPercent: number;
  completedCount: number;
  totalCount: number;
  nextRecommendedWorld?: WorldId;
  onGoToRecommended: () => void;
  dict: WorldsMapDict['progressHeader'];
  worldLabels: WorldsMapDict['worldLabels'];
  totalAnswered: number;
  totalQuestions: number;
}

// Enhanced Background Component
const EnhancedBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none">
    <div className="absolute inset-0 opacity-30">
      <div className="absolute top-10 left-10 w-64 h-64 bg-teal-300/20 rounded-full blur-3xl animate-float-slow" />
      <div
        className="absolute top-1/3 right-20 w-56 h-56 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      />
      <div
        className="absolute bottom-20 left-1/3 w-72 h-72 bg-rose-300/15 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      />
      <div
        className="absolute bottom-1/4 right-1/4 w-48 h-48 bg-amber-200/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '6s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:32px_32px]" />
    <svg
      className="absolute inset-0 w-full h-full opacity-5"
      viewBox="0 0 1000 1000"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#0d9488" stopOpacity="0.2" />{' '}
          {/* Teal */}
          <stop offset="50%" stopColor="#f97316" stopOpacity="0.15" />{' '}
          {/* Orange */}
          <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.1" />{' '}
          {/* Rose */}
        </linearGradient>
      </defs>
      <path
        d="M0,250 Q250,150 500,250 T1000,250 L1000,0 L0,0 Z"
        fill="url(#bgGrad)"
        className="animate-pulse-slow"
      />
      <path
        d="M0,750 Q250,850 500,750 T1000,750 L1000,1000 L0,1000 Z"
        fill="url(#bgGrad)"
        className="animate-pulse-slow"
        style={{ animationDelay: '3s' }}
      />
    </svg>
  </div>
);

// Enhanced Progress Header
const ProgressHeader: React.FC<ProgressHeaderProps> = ({
  userName,
  completionPercent,
  completedCount,
  totalCount,
  nextRecommendedWorld,
  onGoToRecommended,
  dict,
  worldLabels,
  totalAnswered,
  totalQuestions,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  return (
    <motion.div
      ref={ref}
      className="relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border-2 border-white/60 overflow-hidden"
      initial={{ opacity: 0, y: -30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: -30 }}
      transition={{ duration: 0.6, ease: 'easeOut' }}
    >
      {/* Decorative elements */}
      <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-teal-200/30 to-transparent rounded-bl-full blur-2xl" />
      <div className="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-tr-full blur-xl" />

      <div className="relative z-10 p-6 sm:p-8 space-y-6">
        {/* Header Section */}
        <div className="flex items-start justify-between gap-4">
          <div className="flex-1">
            <div className="inline-flex items-center gap-2 bg-gradient-to-r from-teal-100 to-orange-100 rounded-full px-4 py-2 mb-4">
              <Map className="w-4 h-4 text-teal-600" />
              <span className="text-sm font-bold text-teal-700">
                {dict.mapTitle}
              </span>
            </div>
            <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2 leading-tight">
              {userName ? (
                <>
                  {dict.greeting.replace('{{name}}', userName)}
                  <br />
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                    {dict.journeyQuestion}
                  </span>
                </>
              ) : (
                <>
                  {dict.greetingNoName}
                  <br />
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                    {dict.journeyTitle}
                  </span>
                </>
              )}
            </h1>
            <p className="text-base text-gray-600">
              {dict.progressText
                .replace('{{completedCount}}', completedCount.toString())
                .replace('{{totalCount}}', totalCount.toString())
                .replace('{{totalAnswered}}', totalAnswered.toString())
                .replace('{{totalQuestions}}', totalQuestions.toString())}
            </p>
          </div>

          {/* Completion Badge */}
          {completionPercent > 0 && (
            <motion.div
              initial={{ scale: 0, rotate: -180 }}
              animate={{ scale: 1, rotate: 0 }}
              transition={{ type: 'spring', stiffness: 200, damping: 15 }}
              className="flex-shrink-0"
            >
              <div className="relative">
                <div className="w-20 h-20 rounded-full bg-gradient-to-br from-teal-400 to-orange-500 flex items-center justify-center shadow-lg">
                  <span className="text-2xl font-extrabold text-white">
                    {completionPercent}%
                  </span>
                </div>
                {completionPercent === 100 && (
                  <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ delay: 0.3 }}
                    className="absolute -top-1 -right-1"
                  >
                    <Trophy className="w-7 h-7 text-amber-500 fill-amber-400" />
                  </motion.div>
                )}
              </div>
            </motion.div>
          )}
        </div>

        {/* Progress Bar */}
        <div className="space-y-3">
          <div className="flex items-center gap-4">
            <Progress
              value={completionPercent}
              className="h-3 rounded-full flex-1 bg-gray-200/80"
              indicatorClassName="bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 transition-all duration-500 rounded-full"
            />
          </div>

          {/* Milestones */}
          <div className="flex justify-between text-xs text-gray-500 px-1">
            <span
              className={
                completionPercent >= 20 ? 'text-teal-600 font-bold' : ''
              }
            >
              {dict.milestones.start}
            </span>
            <span
              className={
                completionPercent >= 40 ? 'text-teal-600 font-bold' : ''
              }
            >
              {dict.milestones.onTrack}
            </span>
            <span
              className={
                completionPercent >= 60 ? 'text-orange-600 font-bold' : ''
              }
            >
              {dict.milestones.inProgress}
            </span>
            <span
              className={
                completionPercent >= 80 ? 'text-orange-600 font-bold' : ''
              }
            >
              {dict.milestones.almostThere}
            </span>
            <span
              className={
                completionPercent === 100 ? 'text-amber-600 font-bold' : ''
              }
            >
              {dict.milestones.completed}
            </span>
          </div>
        </div>

        {/* Next Recommended Action */}
        {nextRecommendedWorld && completionPercent < 100 && (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="pt-4 border-t border-gray-200/60"
          >
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div className="flex items-start gap-3">
                <div className="p-2 bg-gradient-to-br from-teal-400 to-orange-500 rounded-lg flex-shrink-0">
                  <Compass className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="font-bold text-gray-800 mb-1">
                    {dict.nextStepTitle}
                  </h3>
                  <p className="text-sm text-gray-600">
                    {dict.nextStepPrompt.replace(
                      '{{worldName}}',
                      worldLabels[nextRecommendedWorld]
                    )}
                  </p>
                </div>
              </div>
              <Button
                size="lg"
                onClick={onGoToRecommended}
                className="w-full sm:w-auto bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white font-bold shadow-xl hover:shadow-2xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1"
              >
                <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
                <div className="relative z-10 flex items-center gap-2">
                  <Sparkles className="h-5 w-5 fill-current" />
                  <span>{dict.ctaButton}</span>
                  <ArrowLeft className="h-4 w-4 group-hover:-translate-x-1 transition-transform" />
                </div>
              </Button>
            </div>
          </motion.div>
        )}

        {/* Completion Message */}
        {completionPercent === 100 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="pt-4 border-t border-gray-200/60"
          >
            <div className="text-center p-6 bg-gradient-to-r from-teal-50 via-orange-50 to-amber-50 rounded-2xl">
              <Trophy className="w-12 h-12 mx-auto mb-3 text-amber-500 fill-amber-400" />
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                {dict.completionTitle}
              </h3>
              <p className="text-gray-600">{dict.completionSubtitle}</p>
            </div>
          </motion.div>
        )}
      </div>
    </motion.div>
  );
};

// Enhanced World Card
const WorldCard: React.FC<WorldCardProps> = ({
  worldId,
  status,
  onSelect,
  dict,
  fullContent,
  locale,
  stats,
  progress,
  worldNumber,
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const config = worldsConfig[worldId];
  const { icon: Icon, themeColor } = config;
  const isRTL = locale === 'he';
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  const ForwardArrow = isRTL ? ArrowLeft : ArrowRight;

  const progressPercent =
    progress.total > 0
      ? Math.round((progress.completed / progress.total) * 100)
      : 0;

  const colorMap = {
    sky: {
      gradient: 'from-sky-400 to-blue-500',
      bg: 'bg-sky-100',
      text: 'text-sky-600',
      border: 'border-sky-300',
      glow: 'shadow-sky-400/30',
    },
    rose: {
      gradient: 'from-rose-400 to-pink-500',
      bg: 'bg-rose-100',
      text: 'text-rose-600',
      border: 'border-rose-300',
      glow: 'shadow-rose-400/30',
    },
    purple: {
      gradient: 'from-purple-400 to-indigo-500',
      bg: 'bg-purple-100',
      text: 'text-purple-600',
      border: 'border-purple-300',
      glow: 'shadow-purple-400/30',
    },
    teal: {
      gradient: 'from-teal-400 to-emerald-500',
      bg: 'bg-teal-100',
      text: 'text-teal-600',
      border: 'border-teal-300',
      glow: 'shadow-teal-400/30',
    },
    amber: {
      gradient: 'from-amber-400 to-orange-500',
      bg: 'bg-amber-100',
      text: 'text-amber-600',
      border: 'border-amber-300',
      glow: 'shadow-amber-400/30',
    },
  };

  const colors = colorMap[themeColor as keyof typeof colorMap];

  const statusInfo = {
    completed: {
      Icon: CheckCircle2,
      text: dict.statuses.completed,
      badge: 'bg-green-100 text-green-700 border-green-300',
      action: dict.actions.edit,
      ActionIcon: Edit3,
      cardStyle: 'border-green-300 bg-white/90',
    },
    recommended: {
      Icon: Star,
      text: dict.statuses.recommended,
      badge:
        'bg-gradient-to-r from-teal-100 to-orange-100 text-teal-700 border-teal-300 font-bold animate-pulse-glow',
      action: dict.actions.startRecommended,
      ActionIcon: Zap,
      cardStyle:
        'border-teal-400 bg-gradient-to-br from-white via-teal-50/30 to-orange-50/30 shadow-2xl scale-[1.02] ring-2 ring-teal-300/50',
    },
    active: {
      Icon: Target,
      text: dict.statuses.active,
      badge: `${colors.bg} ${colors.text} ${colors.border}`,
      action: dict.actions.continue,
      ActionIcon: ForwardArrow,
      cardStyle: `${colors.border} bg-white/90`,
    },
    available: {
      Icon: Compass,
      text: dict.statuses.available,
      badge: 'bg-gray-100 text-gray-700 border-gray-300',
      action: dict.actions.start,
      ActionIcon: ForwardArrow,
      cardStyle: 'border-gray-300 bg-white/80',
    },
    locked: {
      Icon: Lock,
      text: dict.statuses.locked,
      badge: 'bg-gray-200 text-gray-500 border-gray-300',
      action: dict.actions.locked,
      ActionIcon: Lock,
      cardStyle: 'border-gray-300 bg-gray-50/80 opacity-60',
    },
  }[status];

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.5, delay: worldNumber * 0.1 }}
      whileHover={
        status !== 'locked'
          ? { y: -8, scale: 1.02, transition: { duration: 0.3 } }
          : undefined
      }
    >
      <Card
        className={cn(
          'relative overflow-hidden transition-all duration-300 ease-out h-full backdrop-blur-sm border-2',
          statusInfo.cardStyle,
          status === 'locked' && 'cursor-not-allowed',
          status === 'recommended' && 'animate-float-gentle'
        )}
      >
        {/* Decorative background elements */}
        <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-white/40 to-transparent rounded-bl-full blur-xl" />
        <div className="absolute bottom-0 left-0 w-20 h-20 bg-gradient-to-tr from-white/30 to-transparent rounded-tr-full blur-lg" />

        {/* Recommended Badge Ribbon */}
        {status === 'recommended' && (
          <div className="absolute top-4 -right-10 rotate-45 bg-gradient-to-r from-teal-500 to-orange-500 text-white text-xs font-bold px-12 py-1 shadow-lg z-20">
            {dict.recommendedRibbon}
          </div>
        )}

        <div className="relative z-10 p-6 space-y-4">
          {/* Header Section */}
          <div className="flex items-start justify-between gap-4">
            {/* Icon */}
            <motion.div
              className={cn(
                'relative p-4 rounded-2xl flex-shrink-0 bg-gradient-to-br shadow-lg',
                colors.gradient
              )}
              transition={{ type: 'spring', stiffness: 300 }}
            >
              <div className="absolute inset-0 rounded-2xl bg-white/20 backdrop-blur-sm" />
              <Icon className="relative z-10 w-8 h-8 text-white" />
            </motion.div>

            {/* Status Badge */}
            <Badge
              variant="outline"
              className={cn(
                'font-semibold text-xs px-3 py-1 border-2',
                statusInfo.badge
              )}
            >
              <statusInfo.Icon className="w-3 h-3 me-1.5 inline" />
              {statusInfo.text}
            </Badge>
          </div>

          {/* World Number */}
          <div className="flex items-center gap-2">
            <div className="inline-flex items-center gap-1.5 bg-gray-100 rounded-full px-3 py-1">
              <span className="text-xs font-bold text-gray-600">
                {dict.worldNumberLabel.replace(
                  '{{number}}',
                  worldNumber.toString()
                )}
              </span>
            </div>
            {status === 'completed' && (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ type: 'spring', stiffness: 200 }}
              >
                <Check className="w-4 h-4 text-green-500" />
              </motion.div>
            )}
          </div>

          {/* Title */}
          <div>
            <h3 className="text-2xl font-bold text-gray-800 mb-2 leading-tight">
              {fullContent.title}
            </h3>
            <p className="text-sm text-gray-600 leading-relaxed">
              {fullContent.description}
            </p>
          </div>

          {/* Progress Bar (for active/in-progress worlds) */}
          {(status === 'active' ||
            (status === 'completed' && progressPercent < 100)) && (
            <div className="space-y-2">
              <div className="flex items-center justify-between text-xs">
                <span className="text-gray-600 font-medium">
                  {dict.progressLabel
                    .replace('{{completed}}', progress.completed.toString())
                    .replace('{{total}}', progress.total.toString())}
                </span>
                <span className={cn('font-bold', colors.text)}>
                  {progressPercent}%
                </span>
              </div>
              <Progress
                value={progressPercent}
                className="h-2 rounded-full bg-gray-200/80"
                indicatorClassName={cn(
                  'bg-gradient-to-r transition-all duration-500',
                  colors.gradient
                )}
              />
            </div>
          )}

          {/* Stats */}
          <div className="flex items-center gap-4 pt-2 border-t border-gray-200/60">
            <div className="flex items-center gap-2 text-sm text-gray-600">
              <div className={cn('p-1.5 rounded-lg', colors.bg)}>
                <BookUser className={cn('w-4 h-4', colors.text)} />
              </div>
              <span className="font-medium">
                {stats.questionCount} {dict.questionsLabel}
              </span>
            </div>
            <div className="flex items-center gap-2 text-sm text-gray-600">
              <div className={cn('p-1.5 rounded-lg', colors.bg)}>
                <Clock className={cn('w-4 h-4', colors.text)} />
              </div>
              <span className="font-medium">
                ~{stats.estimatedTime} {dict.minutesLabel}
              </span>
            </div>
          </div>

          {/* Expandable Details */}
          {fullContent.benefits && fullContent.benefits.length > 0 && (
            <div className="pt-2">
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors w-full"
                disabled={status === 'locked'}
              >
                <span>{dict.expandButton}</span>
                <motion.div
                  animate={{ rotate: isExpanded ? 180 : 0 }}
                  transition={{ duration: 0.3 }}
                >
                  <ChevronDown className="w-4 h-4" />
                </motion.div>
              </button>

              <AnimatePresence>
                {isExpanded && (
                  <motion.div
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: 'auto', opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.3 }}
                    className="overflow-hidden"
                  >
                    <ul className="mt-3 space-y-2">
                      {fullContent.benefits.map((benefit, idx) => (
                        <motion.li
                          key={idx}
                          initial={{ opacity: 0, x: -10 }}
                          animate={{ opacity: 1, x: 0 }}
                          transition={{ delay: idx * 0.1 }}
                          className="flex items-start gap-2 text-sm text-gray-600"
                        >
                          <Check
                            className={cn(
                              'w-4 h-4 mt-0.5 flex-shrink-0',
                              colors.text
                            )}
                          />
                          <span>{benefit}</span>
                        </motion.li>
                      ))}
                    </ul>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          )}

          {/* Action Button */}
          <Button
            className={cn(
              'w-full font-bold shadow-md hover:shadow-xl transition-all duration-300 group relative overflow-hidden',
              status === 'completed' &&
                'bg-white border-2 border-green-300 text-green-700 hover:bg-green-50',
              status === 'recommended' &&
                // Updated Recommended CTA
                'bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white',
              (status === 'active' || status === 'available') &&
                `bg-gradient-to-r ${colors.gradient} hover:opacity-90 text-white`,
              status === 'locked' &&
                'bg-gray-200 text-gray-500 cursor-not-allowed hover:bg-gray-200'
            )}
            onClick={onSelect}
            disabled={status === 'locked'}
          >
            {(status === 'recommended' ||
              status === 'active' ||
              status === 'available') && (
              <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/25 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
            )}
            <span className="relative z-10 flex items-center justify-center gap-2">
              <statusInfo.ActionIcon className="w-4 h-4" />
              {statusInfo.action}
            </span>
          </Button>
        </div>
      </Card>
    </motion.div>
  );
};

// Review Card Component
const ReviewCard: React.FC<{
  dict: WorldsMapDict['reviewCard'];
  locale: 'he' | 'en';
}> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });
  const isRTL = locale === 'he';
  const ReviewButtonArrow = isRTL ? ArrowLeft : ArrowRight;

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 20 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 20 }}
      transition={{ duration: 0.5, delay: 0.2 }}
    >
      {/* Updated Review Card Colors */}
      <Card className="relative overflow-hidden bg-gradient-to-br from-white via-teal-50/40 to-white backdrop-blur-md shadow-xl border-2 border-teal-200/60">
        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-teal-200/30 to-transparent rounded-bl-full blur-2xl" />
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-tr-full blur-xl" />

        <CardContent className="relative z-10 p-6 flex flex-col sm:flex-row items-center justify-between gap-6">
          <div className="flex items-start gap-4">
            <div className="p-4 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-2xl shadow-lg flex-shrink-0">
              <BookUser className="w-7 h-7 text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                {dict.title}
              </h3>
              <p className="text-sm text-gray-600 leading-relaxed">
                {dict.description}
              </p>
            </div>
          </div>
          <Link href={`/${locale}/profile?tab=questionnaire`}>
            <Button
              size="lg"
              variant="outline"
              className="w-full sm:w-auto bg-white/90 border-2 border-teal-300 text-teal-700 hover:bg-teal-50 hover:border-teal-400 font-bold shadow-md hover:shadow-lg transition-all duration-300 group"
            >
              <ReviewButtonArrow className="w-5 h-5 me-2 group-hover:-translate-x-1 transition-transform" />
              {dict.button}
            </Button>
          </Link>
        </CardContent>
      </Card>
    </motion.div>
  );
};

// Completion Banner Component
const CompletionBanner: React.FC<{
  userName?: string | null;
  dict: WorldsMapDict['completionBanner'];
}> = ({ userName, dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, scale: 0.9 }}
      animate={isInView ? { opacity: 1, scale: 1 } : { opacity: 0, scale: 0.9 }}
      transition={{ duration: 0.6, type: 'spring' }}
    >
      <Card className="relative overflow-hidden bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white text-center shadow-2xl border-0">
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-10 left-10 w-40 h-40 bg-white rounded-full blur-3xl animate-float-slow" />
          <div
            className="absolute bottom-10 right-10 w-32 h-32 bg-white rounded-full blur-2xl animate-float-slow"
            style={{ animationDelay: '2s' }}
          />
        </div>

        <CardContent className="relative z-10 p-12">
          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={
              isInView ? { scale: 1, rotate: 0 } : { scale: 0, rotate: -180 }
            }
            transition={{ type: 'spring', stiffness: 150, delay: 0.2 }}
          >
            <Trophy className="w-20 h-20 mx-auto mb-6 text-amber-300 fill-amber-200" />
          </motion.div>

          <h2 className="text-4xl font-extrabold mb-4">
            {userName
              ? dict.title.replace('{{name}}', userName)
              : dict.titleNoName}
          </h2>
          <p className="text-xl font-semibold mb-2 opacity-95">
            {dict.subtitle}
          </p>
          <p className="text-base opacity-90 max-w-2xl mx-auto leading-relaxed">
            {dict.description}
          </p>

          <motion.div
            className="mt-8 flex items-center justify-center gap-6"
            initial={{ opacity: 0, y: 20 }}
            animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 20 }}
            transition={{ delay: 0.4 }}
          >
            <div className="flex items-center gap-2">
              <div className="p-2 bg-white/20 rounded-lg">
                <Check className="w-5 h-5" />
              </div>
              <span className="font-semibold">{dict.statWorlds}</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="p-2 bg-white/20 rounded-lg">
                <TrendingUp className="w-5 h-5" />
              </div>
              <span className="font-semibold">{dict.statReport}</span>
            </div>
          </motion.div>
        </CardContent>
      </Card>
    </motion.div>
  );
};

// Main Component
export default function WorldsMap({
  currentWorld,
  completedWorlds,
  onWorldChange,
  className = '',
  dict,
  locale,
  answers,
  worldStats,
}: WorldsMapProps) {
  const { data: session } = useSession();
  const isRTL = locale === 'he';

  useEffect(() => {
    console.log(
      `%c[WorldsMap] Language is now: ${locale}`,
      'color: #14b8a6; font-weight: bold; font-size: 14px;'
    );
  }, [locale]);

  const worldsProgress = useMemo(() => {
    const progressMap: Record<WorldId, { completed: number; total: number }> = {
      PERSONALITY: {
        completed: 0,
        total: worldStats.PERSONALITY.questionCount,
      },
      VALUES: { completed: 0, total: worldStats.VALUES.questionCount },
      RELATIONSHIP: {
        completed: 0,
        total: worldStats.RELATIONSHIP.questionCount,
      },
      PARTNER: { completed: 0, total: worldStats.PARTNER.questionCount },
      RELIGION: { completed: 0, total: worldStats.RELIGION.questionCount },
    };

    for (const worldId of WORLD_ORDER) {
      const answeredQuestionsInWorld = new Set(
        answers.filter((a) => a.worldId === worldId).map((a) => a.questionId)
      );
      progressMap[worldId].completed = answeredQuestionsInWorld.size;
    }

    return progressMap;
  }, [answers, worldStats]);

  const totalQuestions = useMemo(
    () => WORLD_ORDER.reduce((sum, w) => sum + worldStats[w].questionCount, 0),
    [worldStats]
  );

  const totalAnswered = useMemo(
    () => WORLD_ORDER.reduce((sum, w) => sum + worldsProgress[w].completed, 0),
    [worldsProgress]
  );

  const completionPercent = Math.round(
    (completedWorlds.length / WORLD_ORDER.length) * 100
  );

  const nextRecommendedWorld = WORLD_ORDER.find(
    (world) => !completedWorlds.includes(world)
  );

  const getWorldStatus = (worldId: WorldId): WorldStatus => {
    if (completedWorlds.includes(worldId)) return 'completed';
    if (worldId === nextRecommendedWorld) return 'recommended';
    if (worldId === currentWorld) return 'active';
    return 'available';
  };

  return (
    <div
      className={cn(
        'relative min-h-screen p-4 sm:p-6 lg:p-8 bg-gradient-to-b from-slate-50 via-teal-50/30 to-slate-50 overflow-hidden',
        className
      )}
      dir={isRTL ? 'rtl' : 'ltr'}
    >
      <EnhancedBackground />

      <div className="relative max-w-7xl mx-auto space-y-8 z-10">
        {/* Progress Header */}
        <ProgressHeader
          userName={session?.user?.firstName}
          completionPercent={completionPercent}
          completedCount={completedWorlds.length}
          totalCount={WORLD_ORDER.length}
          nextRecommendedWorld={nextRecommendedWorld}
          onGoToRecommended={() =>
            nextRecommendedWorld && onWorldChange(nextRecommendedWorld)
          }
          dict={dict.progressHeader}
          worldLabels={dict.worldLabels}
          totalAnswered={totalAnswered}
          totalQuestions={totalQuestions}
        />

        {/* Review Card (shown after completing at least one world) */}
        {completedWorlds.length > 0 && completionPercent < 100 && (
          <ReviewCard dict={dict.reviewCard} locale={locale} />
        )}

        {/* Worlds Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {WORLD_ORDER.map((worldId, index) => {
            const stats = {
              questionCount: worldStats[worldId].questionCount,
              estimatedTime: Math.max(
                5,
                Math.round(worldStats[worldId].questionCount * 0.4)
              ),
            };
            return (
              <WorldCard
                key={worldId}
                worldId={worldId}
                worldNumber={index + 1}
                status={getWorldStatus(worldId)}
                onSelect={() => onWorldChange(worldId)}
                dict={dict.worldCard}
                fullContent={dict.worldsContent[worldId]}
                stats={stats}
                locale={locale}
                progress={worldsProgress[worldId]}
              />
            );
          })}
        </div>

        {/* Completion Banner */}
        {completionPercent === 100 && (
          <CompletionBanner
            userName={session?.user?.firstName}
            dict={dict.completionBanner}
          />
        )}
      </div>

      <style>{`
        @keyframes pulse-slow {
          0%, 100% { opacity: 0.8; }
          50% { opacity: 1; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-glow {
          0%, 100% { 
            box-shadow: 0 0 5px rgba(20, 184, 166, 0.3);
          }
          50% { 
            box-shadow: 0 0 20px rgba(20, 184, 166, 0.6), 0 0 30px rgba(249, 115, 22, 0.4);
          }
        }
        .animate-pulse-glow {
          animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes float-slow {
          0%, 100% { 
            transform: translateY(0) translateX(0); 
          }
          25% { 
            transform: translateY(-25px) translateX(15px); 
          }
          50% { 
            transform: translateY(-10px) translateX(25px); 
          }
          75% { 
            transform: translateY(-20px) translateX(10px); 
          }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }

        @keyframes float-gentle {
          0%, 100% { 
            transform: translateY(0); 
          }
          50% { 
            transform: translateY(-5px); 
          }
        }
        .animate-float-gentle {
          animation: float-gentle 3s ease-in-out infinite;
        }

        @keyframes shimmer {
          100% { 
            transform: translateX(100%); 
          }
        }
        .animate-shimmer {
          animation: shimmer 2.5s infinite;
        }
      `}</style>
    </div>
  );
}
--- End of Content for WorldsMap.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\pages
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\pages\QuestionnaireLandingPage.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/pages/QuestionnaireLandingPage.tsx
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import {
  Heart,
  User,
  Users,
  Scroll,
  Clock,
  ArrowRight,
  Star,
  Shield,
  CheckCircle,
  Lock,
  ArrowLeft,
  Loader2,
  Sparkles,
  UserCheck,
  Target,
  Lightbulb,
  FileText,
  Zap,
  AlertCircle,
  MessageCircle,
  Calendar,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useSession } from 'next-auth/react';
import { useIsMobile } from '../hooks/useMediaQuery';
import { motion, useInView } from 'framer-motion';
import type { QuestionnaireLandingPageDict } from '@/types/dictionary';
import type { WorldId } from '../types/types';

// --- Props Interface ---
interface QuestionnaireLandingPageProps {
  onStartQuestionnaire: () => void;
  hasSavedProgress: boolean;
  isLoading?: boolean;
  dict: QuestionnaireLandingPageDict;
  locale: string;
}

// --- Animation Variants ---
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.1, delayChildren: 0.2 },
  },
};

const fadeInUp = {
  hidden: { opacity: 0, y: 30 },
  visible: {
    opacity: 1,
    y: 0,
    transition: { duration: 0.6, ease: 'easeOut' },
  },
};

const staggeredCardVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.15, delayChildren: 0.1 },
  },
};

// --- Enhanced Background Component ---
const DynamicBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none">
    <div className="absolute inset-0 opacity-30">
      <div className="absolute top-10 left-10 w-72 h-72 bg-teal-300/20 rounded-full blur-3xl animate-float-slow" />
      <div
        className="absolute top-1/3 right-20 w-64 h-64 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      />
      <div
        className="absolute bottom-20 left-1/3 w-80 h-80 bg-rose-300/15 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      />
      <div
        className="absolute bottom-1/4 right-1/4 w-56 h-56 bg-amber-200/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '6s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:30px_30px]" />
    <svg
      className="absolute inset-0 w-full h-full opacity-5"
      viewBox="0 0 1000 1000"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#0d9488" stopOpacity="0.2" />
          <stop offset="50%" stopColor="#f97316" stopOpacity="0.15" />
          <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.1" />
        </linearGradient>
      </defs>
      <path
        d="M0,300 Q250,200 500,300 T1000,300 L1000,0 L0,0 Z"
        fill="url(#grad1)"
        className="animate-pulse-slow"
      />
      <path
        d="M0,700 Q250,800 500,700 T1000,700 L1000,1000 L0,1000 Z"
        fill="url(#grad1)"
        className="animate-pulse-slow"
        style={{ animationDelay: '3s' }}
      />
    </svg>
  </div>
);

// --- Problem Card Component ---
interface ProblemCardProps {
  icon: React.ReactNode;
  title: string;
  description: string;
  delay?: number;
}

const ProblemCard: React.FC<ProblemCardProps> = ({
  icon,
  title,
  description,
  delay = 0,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.3 });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, x: -30 }}
      animate={isInView ? { opacity: 1, x: 0 } : { opacity: 0, x: -30 }}
      transition={{ duration: 0.6, delay }}
      className="flex items-start gap-4 p-6 bg-rose-50/80 backdrop-blur-sm rounded-2xl border-2 border-rose-200/60 shadow-sm hover:shadow-lg transition-all duration-300 group"
    >
      <div className="flex-shrink-0 p-3 rounded-xl bg-gradient-to-br from-rose-400 to-red-500 text-white shadow-md group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-rose-500/25">
        {icon}
      </div>
      <div className="flex-1">
        <h4 className="font-bold text-lg text-gray-800 mb-2">{title}</h4>
        <p className="text-gray-600 leading-relaxed">{description}</p>
      </div>
    </motion.div>
  );
};

// --- Solution Card Component ---
interface SolutionCardProps {
  icon: React.ReactNode;
  title: string;
  description: string;
  gradient: string;
  shadowColor: string;
  bgGradient: string;
  delay?: number;
}

const SolutionCard: React.FC<SolutionCardProps> = ({
  icon,
  title,
  description,
  gradient,
  shadowColor,
  bgGradient,
  delay = 0,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.3 });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.6, delay }}
      className={`group relative overflow-hidden rounded-3xl bg-gradient-to-br ${bgGradient} p-8 ${shadowColor} shadow-xl hover:shadow-2xl border border-white/60 transition-all duration-500 h-full`}
    >
      <div className="absolute top-4 right-4 w-20 h-20 rounded-full bg-gradient-to-br from-white/30 to-transparent blur-xl" />
      <div className="absolute bottom-4 left-4 w-12 h-12 rounded-full bg-gradient-to-br from-white/40 to-transparent blur-lg" />

      <div className="relative z-10 flex flex-col h-full">
        <div className="flex items-center justify-center mb-6">
          <div
            className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${gradient} flex items-center justify-center text-white shadow-xl transform group-hover:rotate-12 transition-transform duration-500`}
          >
            {icon}
            <div className="absolute inset-0 rounded-2xl bg-white/15 backdrop-blur-sm" />
          </div>
        </div>
        <h4 className="font-bold text-gray-800 text-xl mb-4 text-center leading-tight">
          {title}
        </h4>
        <p className="text-gray-600 text-base leading-relaxed text-center flex-1">
          {description}
        </p>
        <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
      </div>
    </motion.div>
  );
};

// --- Main Component ---
export default function QuestionnaireLandingPage({
  onStartQuestionnaire,
  hasSavedProgress,
  isLoading = false,
  dict,
  locale,
}: QuestionnaireLandingPageProps) {
  const { status, data: session } = useSession();
  const isMobile = useIsMobile();
  const isRTL = locale === 'he';

  const [showBottomCta, setShowBottomCta] = useState(false);
  const topCtaRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!isMobile || !topCtaRef.current) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        setShowBottomCta(!entry.isIntersecting);
      },
      {
        threshold: 0,
        rootMargin: '0px',
      }
    );

    observer.observe(topCtaRef.current);

    return () => {
      observer.disconnect();
    };
  }, [isMobile]);

  const worldVisuals = [
    { id: 'PERSONALITY', icon: <User className="h-7 w-7" />, color: 'blue' },
    { id: 'VALUES', icon: <Heart className="h-7 w-7" />, color: 'rose' },
    {
      id: 'RELATIONSHIP',
      icon: <Users className="h-7 w-7" />,
      color: 'purple',
    },
    { id: 'PARTNER', icon: <UserCheck className="h-7 w-7" />, color: 'teal' },
    { id: 'RELIGION', icon: <Scroll className="h-7 w-7" />, color: 'amber' },
  ] as const;

  const getCtaText = () => {
    if (hasSavedProgress) return dict.cta.continue;
    if (session?.user?.firstName)
      return dict.cta.startAsUser.replace('{{name}}', session.user.firstName);
    return dict.cta.startDefault;
  };

  const CtaIcon = hasSavedProgress ? CheckCircle : Heart;
  const ArrowIcon = isRTL ? ArrowLeft : ArrowRight;

  return (
    <div
      className={cn(
        'relative min-h-screen overflow-hidden bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        isRTL ? 'dir-rtl text-right' : 'dir-ltr text-left',
        isMobile && 'pb-28'
      )}
    >
      <DynamicBackground />

      {/* SECTION 1: HERO */}
      <motion.section
        className="relative py-16 sm:py-20 px-4 text-center"
        initial="hidden"
        animate="visible"
        variants={containerVariants}
      >
        <div className="max-w-5xl mx-auto">
          <motion.div
            className="inline-flex items-center gap-3 bg-white/90 backdrop-blur-sm rounded-full px-6 py-3 shadow-lg border border-white/60 mb-8"
            variants={fadeInUp}
          >
            <Sparkles className="w-5 h-5 text-teal-500" />
            <span className="text-teal-700 font-bold text-sm">
              {dict.hero.badge}
            </span>
          </motion.div>

          <motion.h1
            className="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-6 tracking-tight leading-tight"
            variants={fadeInUp}
          >
            <span className="text-gray-800">{dict.hero.title1}</span>
            <br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 animate-gradient">
              {dict.hero.title2}
            </span>
          </motion.h1>

          <motion.p
            className="text-xl md:text-2xl text-gray-700 max-w-3xl mx-auto leading-relaxed mb-4"
            variants={fadeInUp}
          >
            {dict.hero.subtitle1}
            <br className="hidden sm:inline" />
            {dict.hero.subtitle2}{' '}
            <span className="font-bold text-teal-700">
              {dict.hero.subtitleHighlight}
            </span>{' '}
            {dict.hero.subtitle3}
          </motion.p>

          <motion.div
            className="inline-flex items-center gap-2 bg-amber-100/80 rounded-full px-5 py-2 border border-amber-300/60 mb-10"
            variants={fadeInUp}
          >
            <Clock className="w-4 h-4 text-amber-700" />
            <span className="text-amber-800 font-semibold text-sm">
              {dict.hero.timeEstimate}
            </span>
          </motion.div>

          <motion.div
            ref={topCtaRef}
            className="flex flex-col sm:flex-row gap-4 justify-center items-center"
            variants={fadeInUp}
          >
            <Button
              size="lg"
              className="w-full sm:w-auto text-lg font-bold px-10 py-7 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1"
              onClick={onStartQuestionnaire}
              disabled={isLoading}
            >
              <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
              <div className="relative z-10 flex items-center justify-center gap-2">
                {isLoading ? (
                  <Loader2 className="h-6 w-6 animate-spin" />
                ) : (
                  <>
                    <CtaIcon className="h-6 w-6 fill-white" />
                    <span>{getCtaText()}</span>
                    <ArrowIcon className="h-5 w-5" />
                  </>
                )}
              </div>
            </Button>

            {status !== 'authenticated' && (
              <Link href="/auth/signin">
                <Button
                  variant="outline"
                  size="lg"
                  className="w-full sm:w-auto text-base font-medium px-8 py-6 border-2 border-teal-200 text-teal-700 hover:bg-teal-50 hover:border-teal-300 rounded-full transition-all duration-300 bg-white/80 backdrop-blur-sm"
                >
                  <Lock className={cn('h-5 w-5', isRTL ? 'ms-2' : 'me-2')} />
                  {dict.cta.login}
                </Button>
              </Link>
            )}
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 2: THE PROBLEM */}
      <motion.section
        className="py-20 px-4 relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <div className="inline-flex items-center gap-3 bg-rose-100/80 backdrop-blur-sm rounded-full px-6 py-3 shadow-md border border-rose-200/60 mb-6">
              <AlertCircle className="w-5 h-5 text-rose-600" />
              <span className="text-rose-700 font-bold">
                {dict.problemSection.badge}
              </span>
            </div>
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
              {dict.problemSection.title1}
              <br />
              <span className="text-2xl sm:text-3xl text-gray-600 font-normal">
                {dict.problemSection.title2}
              </span>
            </h2>
          </motion.div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto mb-12">
            <ProblemCard
              icon={<MessageCircle className="w-6 h-6" />}
              title={dict.problemSection.cards.generalAnswers.title}
              description={dict.problemSection.cards.generalAnswers.description}
              delay={0}
            />
            <ProblemCard
              icon={<Calendar className="w-6 h-6" />}
              title={dict.problemSection.cards.wastedTime.title}
              description={dict.problemSection.cards.wastedTime.description}
              delay={0.15}
            />
            <ProblemCard
              icon={<Target className="w-6 h-6" />}
              title={dict.problemSection.cards.lackOfFocus.title}
              description={dict.problemSection.cards.lackOfFocus.description}
              delay={0.3}
            />
            <ProblemCard
              icon={<AlertCircle className="w-6 h-6" />}
              title={dict.problemSection.cards.frustration.title}
              description={dict.problemSection.cards.frustration.description}
              delay={0.45}
            />
          </div>

          <motion.div
            className="text-center"
            initial={{ opacity: 0, scale: 0.9 }}
            whileInView={{ opacity: 1, scale: 1 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.6 }}
          >
            <div className="inline-block bg-gradient-to-r from-amber-50 via-orange-50 to-rose-50 rounded-3xl px-8 py-5 shadow-xl border-2 border-amber-200/60">
              <p className="text-xl md:text-2xl font-bold text-gray-800">
                {dict.problemSection.insight}
              </p>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 3: THE SOLUTION */}
      <motion.section
        className="py-20 px-4 relative bg-white/40 backdrop-blur-sm"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <div className="inline-flex items-center gap-3 bg-teal-50 backdrop-blur-sm rounded-full px-6 py-3 shadow-md border border-teal-200 mb-6">
              <Lightbulb className="w-5 h-5 text-teal-600" />
              <span className="text-teal-700 font-bold">
                {dict.solutionSection.badge}
              </span>
            </div>
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
              {dict.solutionSection.title}{' '}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500">
                {dict.solutionSection.titleHighlight}
              </span>
            </h2>
            <p className="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
              {dict.solutionSection.subtitle1}
              <br className="hidden sm:inline" />
              {dict.solutionSection.subtitle2}
            </p>
          </motion.div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <SolutionCard
              icon={<Heart className="w-8 h-8" />}
              title={dict.solutionSection.cards.selfDiscovery.title}
              description={dict.solutionSection.cards.selfDiscovery.description}
              gradient="from-rose-400 via-pink-500 to-red-500"
              shadowColor="shadow-rose-500/25"
              bgGradient="from-rose-50 via-white to-red-50"
              delay={0}
            />
            <SolutionCard
              icon={<FileText className="w-8 h-8" />}
              title={dict.solutionSection.cards.fullPicture.title}
              description={dict.solutionSection.cards.fullPicture.description}
              gradient="from-teal-400 via-teal-500 to-emerald-500"
              shadowColor="shadow-teal-500/25"
              bgGradient="from-teal-50 via-white to-emerald-50"
              delay={0.15}
            />
            <SolutionCard
              icon={<Target className="w-8 h-8" />}
              title={dict.solutionSection.cards.focusedSearch.title}
              description={dict.solutionSection.cards.focusedSearch.description}
              gradient="from-orange-400 via-amber-500 to-yellow-500"
              shadowColor="shadow-orange-500/25"
              bgGradient="from-orange-50 via-white to-amber-50"
              delay={0.3}
            />
          </div>

          <motion.div
            className="mt-16 text-center"
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.5 }}
          >
            <div className="inline-block bg-gradient-to-r from-teal-50 via-white to-orange-50 rounded-2xl p-8 shadow-lg border border-teal-100/60">
              <div className="flex items-center justify-center gap-3 mb-4">
                <Zap className="w-6 h-6 text-orange-500" />
                <h3 className="text-2xl font-bold text-gray-800">
                  {dict.solutionSection.result.title}
                </h3>
                <Zap className="w-6 h-6 text-orange-500" />
              </div>
              <p className="text-lg text-gray-600 leading-relaxed max-w-2xl">
                {dict.solutionSection.result.description}
              </p>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 4: THE WORLDS */}
      <motion.section
        className="py-20 px-4 relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <h2 className="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">
              {dict.worldsSection.title}
            </h2>
            <div className="w-24 h-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 mx-auto rounded-full mb-6" />
            <p className="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
              {dict.worldsSection.subtitle}
            </p>
          </motion.div>

          <motion.div
            className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6"
            variants={staggeredCardVariants}
          >
            {worldVisuals.map((world, index) => {
              const colorClasses = {
                blue: 'from-sky-400 to-blue-500',
                rose: 'from-rose-400 to-red-500',
                purple: 'from-purple-400 to-indigo-500',
                teal: 'from-teal-400 to-emerald-500',
                amber: 'from-amber-400 to-yellow-500',
              };

              const worldInfo = dict.worldsSection.worlds[world.id as WorldId];

              return (
                <motion.div key={world.id} variants={fadeInUp}>
                  <div className="relative overflow-hidden rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 bg-white/95 backdrop-blur-sm border-2 border-white/60 flex flex-col h-full group p-8 text-center items-center">
                    <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-white/50 to-transparent rounded-bl-full blur-xl" />
                    <div
                      className={cn(
                        'relative p-5 rounded-2xl bg-gradient-to-br text-white shadow-xl mb-6 group-hover:scale-110 group-hover:rotate-6 transition-all duration-300',
                        colorClasses[world.color]
                      )}
                    >
                      <div className="absolute inset-0 rounded-2xl bg-white/20 backdrop-blur-sm" />
                      <div className="relative z-10">{world.icon}</div>
                    </div>
                    <div className="inline-flex items-center justify-center px-3 py-1 rounded-full bg-gray-100 mb-4">
                      <span className="text-xs font-bold text-gray-600">
                        {dict.worldsSection.worldLabel.replace(
                          '{{number}}',
                          (index + 1).toString()
                        )}
                      </span>
                    </div>
                    <h3 className="text-xl font-bold text-gray-800 mb-3 leading-tight">
                      {worldInfo.title}
                    </h3>
                    <p className="text-sm text-gray-600 leading-relaxed">
                      {worldInfo.description}
                    </p>
                  </div>
                </motion.div>
              );
            })}
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 5: FEATURES */}
      <motion.section
        className="py-20 px-4 bg-gradient-to-b from-white/80 to-teal-50/40"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-5xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <h2 className="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">
              {dict.featuresSection.title}
            </h2>
            <div className="w-24 h-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 mx-auto rounded-full mb-6" />
          </motion.div>

          <motion.div
            className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center"
            variants={staggeredCardVariants}
          >
            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-teal-400 to-emerald-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-teal-500/25">
                <Clock className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.fast.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.fast.description}
              </p>
            </motion.div>

            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-orange-400 to-amber-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-orange-500/25">
                <Shield className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.private.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.private.description}
              </p>
            </motion.div>

            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-rose-400 to-red-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-rose-500/25">
                <Star className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.instantResult.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.instantResult.description}
              </p>
            </motion.div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 6: FINAL CTA */}
      <motion.section
        className="py-24 px-4 text-center relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.15 }}
        variants={containerVariants}
      >
        <div className="max-w-4xl mx-auto">
          <motion.div
            className="relative bg-gradient-to-br from-white/95 via-teal-50/80 to-orange-50/80 backdrop-blur-xl rounded-3xl p-12 md:p-16 shadow-2xl border-2 border-white/60"
            variants={fadeInUp}
          >
            <div className="absolute -top-6 left-1/2 -translate-x-1/2">
              <div className="bg-gradient-to-r from-teal-500 via-orange-500 to-rose-500 rounded-full p-4 shadow-xl">
                <Sparkles className="w-8 h-8 text-white" />
              </div>
            </div>

            <div className="absolute top-4 right-8 w-24 h-24 bg-gradient-to-br from-teal-200/30 to-transparent rounded-full blur-2xl" />
            <div className="absolute bottom-4 left-8 w-32 h-32 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-full blur-2xl" />

            <div className="relative z-10">
              <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
                {dict.finalCta.title1}
                <br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-600 to-amber-600">
                  {dict.finalCta.title2}
                </span>
              </h2>
              <p className="text-xl text-gray-600 mb-10 leading-relaxed max-w-2xl mx-auto whitespace-pre-line">
                {dict.finalCta.subtitle}
              </p>

              <motion.div variants={fadeInUp}>
                <Button
                  size="lg"
                  onClick={onStartQuestionnaire}
                  disabled={isLoading}
                  className="text-xl font-bold px-12 py-8 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1 hover:scale-105"
                >
                  <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/40 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
                  <div className="relative z-10 flex items-center justify-center gap-3">
                    {isLoading ? (
                      <Loader2 className="h-7 w-7 animate-spin" />
                    ) : (
                      <>
                        <FileText className="h-7 w-7 group-hover:rotate-12 transition-transform" />
                        <span>{dict.finalCta.buttonText}</span>
                        <ArrowIcon className="h-6 w-6 group-hover:-translate-x-1 transition-transform" />
                      </>
                    )}
                  </div>
                </Button>
              </motion.div>

              <motion.div
                className="mt-8 flex items-center justify-center gap-3 text-gray-600"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.4 }}
              >
                <CheckCircle className="w-5 h-5 text-teal-500" />
                <span className="font-medium">{dict.finalCta.assurance}</span>
              </motion.div>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* MOBILE STICKY CTA */}
      {isMobile && showBottomCta && (
        <motion.div
          initial={{ y: 100, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          exit={{ y: 100, opacity: 0 }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          className="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-xl border-t-2 border-teal-200/80 shadow-2xl z-50"
        >
          <Button
            size="lg"
            className="w-full text-base font-bold py-4 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white rounded-xl shadow-xl hover:shadow-2xl transition-all group relative overflow-hidden"
            onClick={onStartQuestionnaire}
            disabled={isLoading}
          >
            <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
            <div className="relative z-10 flex items-center justify-center gap-2">
              {isLoading ? (
                <Loader2 className="h-5 w-5 animate-spin" />
              ) : (
                <>
                  <CtaIcon className="h-5 w-5 fill-white" />
                  <span>{getCtaText()}</span>
                </>
              )}
            </div>
          </Button>
        </motion.div>
      )}

      <footer className="text-center py-8 text-gray-500 text-sm bg-slate-50/80">
        {dict.footer.copyright.replace(
          '{{year}}',
          new Date().getFullYear().toString()
        )}
      </footer>

      <style>{`
        @keyframes float-slow {
          0%, 100% { transform: translateY(0) translateX(0); }
          25% { transform: translateY(-25px) translateX(15px); }
          50% { transform: translateY(-10px) translateX(25px); }
          75% { transform: translateY(-20px) translateX(10px); }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }
        
        @keyframes pulse-slow {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 6s ease-in-out infinite;
        }
        
        @keyframes shimmer {
          100% { transform: translateX(100%); }
        }
        .animate-shimmer {
          animation: shimmer 2.5s infinite;
        }
        
        @keyframes gradient {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
        }
        .animate-gradient {
          background-size: 200% 200%;
          animation: gradient 4s ease-in-out infinite;
        }

        .shadow-3xl {
          box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3);
        }
      `}</style>
    </div>
  );
}
--- End of Content for QuestionnaireLandingPage.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions
================================================================================

(This directory contains subdirectories but no files directly. See subdirectories below.)

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\partner
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\partner\partnerQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/partner/partnerQuestions.tsx
import { Question } from '../../types/types';
import {
  Heart,
  Brain,
  Smile,
  ShieldCheck,
  Star,
  Users,
  Moon,
  Home,
  Target,
  Scale,
  BookOpen,
  Scroll,
  Activity,
  Coffee,
  Eye,
  Car,
  Flag,
  Globe,
  HandHeart,
  Lightbulb,
  Briefcase,
  PiggyBank,
  Info,
  Sparkles,
  Palette,
  Headphones,
  MessageCircle,
  TrendingUp,
  Building2,
  Mountain,
  TreePine,
  MapPin,
  DollarSign,
  HelpCircle,
} from 'lucide-react';

export const partnerQuestions: Question[] = [
  {
    worldId: 'PARTNER',
    id: 'partner_initial_impression_priorities_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'appearance_style', icon: <Eye /> },
      { value: 'smile_energy', icon: <Smile /> },
      { value: 'conversation_chemistry', icon: <MessageCircle /> },
      { value: 'wit_depth', icon: <Brain /> },
      { value: 'sense_of_security', icon: <ShieldCheck /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_appearance_importance_scale_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_intelligence_types',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'emotional', icon: <Heart /> },
      { value: 'analytical', icon: <Brain /> },
      { value: 'life_smarts', icon: <Sparkles /> },
      { value: 'creative', icon: <Lightbulb /> },
      { value: 'spiritual_torah', icon: <BookOpen /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_core_character_traits_essential_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'integrity', icon: <ShieldCheck /> },
      { value: 'warmth', icon: <Heart /> },
      { value: 'optimism', icon: <Smile /> },
      { value: 'maturity', icon: <Target /> },
      { value: 'ambition', icon: <Star /> },
      { value: 'communication', icon: <HandHeart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_completion_trait',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 20,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_emotional_expression_preference',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'open_verbal' },
        { value: 'action_oriented' },
        { value: 'balanced' },
        { value: 'not_critical' },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PARTNER',
    id: 'partner_dating_persona',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'observer_listener', icon: <Headphones /> },
      { value: 'storyteller_initiator', icon: <MessageCircle /> },
      { value: 'humorous_light', icon: <Smile /> },
      { value: 'deep_serious', icon: <Brain /> },
      { value: 'shy_reserved', icon: <Moon /> },
    ],
    metadata: { estimatedTime: 3 },
  },

  {
    worldId: 'PARTNER',
    id: 'partner_lifestyle_pace_preference_revised',
    category: 'partner',
    subcategory: 'lifestyle_social',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'dynamic_active', icon: <Activity /> },
      { value: 'calm_serene', icon: <Home /> },
      { value: 'balanced', icon: <Scale /> },
      { value: 'adventurous_spontaneous', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_financial_habits_scale',
    category: 'partner',
    subcategory: 'career_finance_education',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_career_ambition_preference_revised',
    category: 'partner',
    subcategory: 'career_finance_education',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'ambition_focus', icon: <Star /> },
      { value: 'work_life_balance', icon: <Scale /> },
      { value: 'personal_satisfaction', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_deal_breakers_open_text_revised',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_common_disqualifiers',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_personality_clash',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_red_flag_vs_quirk',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_in_laws_conflict',
    category: 'partner',
    subcategory: 'family_background',
    type: 'iconChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'loyalty_to_couple', icon: <ShieldCheck /> },
      { value: 'mediation_compromise', icon: <Scale /> },
      { value: 'diplomacy', icon: <Users /> },
      { value: 'loyalty_to_family_of_origin', icon: <Home /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_family_connection_importance',
    category: 'partner',
    subcategory: 'family_background',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PARTNER',
    id: 'partner_must_have_quality_final_revised',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 10,
    maxLength: 150,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_romantic_past_comfort',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'no_past' },
        { value: 'short_term_ok' },
        { value: 'long_term_ok' },
        { value: 'past_is_past' },
    ],
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'PARTNER',
    id: 'partner_what_you_bring',
    category: 'partner',
    subcategory: 'self_perception',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
},

];
--- End of Content for partnerQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\personality
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\personality\personalityQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/personality/personalityQuestions.tsx
import { Question } from '../../types/types';
import {
  Sun,
  Moon,
  Users,
  Brain,
  Heart,
  Target,
  Compass,
  Cloud,
  Leaf,
  Home,
  Watch,
  Scale,
  Coffee,
  MessageCircle,
  HandHeart,
  Lightbulb,
  Sparkles,
  Star,
   BatteryCharging,
    Phone,
  Smile,
  ShieldCheck,
  BookOpen,
  Palette,
  Headphones,
  Mountain,
  Bed,
  Utensils,
  Activity,
  Edit,
  HelpCircle,
  Anchor,
  Feather,
} from 'lucide-react';

export const personalityQuestions: Question[] = [
  {
    worldId: 'PERSONALITY',
    id: 'personality_core_trait_selection_revised',
    category: 'personality',
    subcategory: 'self_perception',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'empathetic_sensitive', icon: <Heart /> },
      { value: 'honest_reliable', icon: <ShieldCheck /> },
      { value: 'optimistic_cheerful', icon: <Sun /> },
      { value: 'humorous', icon: <Smile /> },
      { value: 'intelligent_curious', icon: <Brain /> },
      { value: 'ambitious_motivated', icon: <Star /> },
      { value: 'easygoing_flexible', icon: <Feather /> },
      { value: 'responsible_organized', icon: <Target /> },
      { value: 'creative_original', icon: <Lightbulb /> },
      { value: 'stable_grounded', icon: <Anchor /> },
      { value: 'decisive_confident', icon: <Compass /> },
      { value: 'generous_caring', icon: <HandHeart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_social_battery_recharge',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'scenario',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'quiet_evening_home', icon: <Moon /> },
      { value: 'intimate_gathering', icon: <Coffee /> },
      { value: 'energetic_social_outing', icon: <Users /> },
      { value: 'flexible_combination', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_loneliness_coping',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'recharge_renew', icon: <BatteryCharging /> },
      { value: 'productivity_focus', icon: <Brain /> },
      { value: 'mild_loneliness', icon: <Phone /> },
      { value: 'discomfort', icon: <Users /> },
    ],
    metadata: { estimatedTime: 1 },
},
  {
    worldId: 'PERSONALITY',
    id: 'personality_biological_clock',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
{
        worldId: 'PERSONALITY',
        id: 'personality_sleep_flexibility',
        category: 'personality',
        subcategory: 'lifestyle',
        type: 'singleChoice',
        depth: 'ADVANCED',
        isRequired: false,
        options: [
            { value: 'very_flexible' },
            { value: 'somewhat_flexible' },
            { value: 'not_flexible' },
        ],
        metadata: { estimatedTime: 1 },
    },

  {
    worldId: 'PERSONALITY',
    id: 'personality_daily_structure_revised',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'order_planning', icon: <Watch /> },
      { value: 'flexibility_flow', icon: <Cloud /> },
      { value: 'task_oriented', icon: <Target /> },
      { value: 'balance', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_social_situation_revised',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'initiator', icon: <Users /> },
      { value: 'joiner', icon: <Coffee /> },
      { value: 'deep_diver', icon: <MessageCircle /> },
      { value: 'observer', icon: <Compass /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
        worldId: 'PERSONALITY',
        id: 'personality_pressure_pattern',
        category: 'personality',
        subcategory: 'emotional_coping',
        type: 'iconChoice',
        depth: 'ADVANCED',
        isRequired: false,
        options: [
            { value: 'need_space', icon: <Moon /> },
            { value: 'seek_support', icon: <Users /> },
            { value: 'action_oriented', icon: <Target /> },
            { value: 'avoidance_distraction', icon: <Cloud /> },
        ],
        metadata: { estimatedTime: 1 },
    },
    {
        worldId: 'PERSONALITY',
        id: 'personality_life_pace',
        category: 'personality',
        subcategory: 'lifestyle',
        type: 'singleChoice',
        depth: 'BASIC',
        isRequired: false,
        options: [
            { value: 'planned_efficient' },
            { value: 'organized_spontaneous' },
            { value: 'flexible_flow' },
            { value: 'minimalist_calm' },
        ],
        metadata: { estimatedTime: 1 },
    },

  {
    worldId: 'PERSONALITY',
    id: 'personality_self_portrayal_revised',
    category: 'personality',
    subcategory: 'self_perception',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 70,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_unproductive_day_feeling',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'self_compassion', icon: <Heart /> },
      { value: 'criticism_action', icon: <Target /> },
      { value: 'analysis_learning', icon: <Brain /> },
      { value: 'immediate_fix', icon: <Activity /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_plan_change_reaction',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_stress_management_revised',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'multiSelectWithOther',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'movement_sport', icon: <Activity /> },
      { value: 'talk_vent', icon: <Users /> },
      { value: 'alone_time_rest', icon: <Bed /> },
      { value: 'nature', icon: <Leaf /> },
      { value: 'creative_hobby', icon: <Palette /> },
      { value: 'order_organization', icon: <Brain /> },
      { value: 'media_disconnect', icon: <Headphones /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_friendship_in_action',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_friend_in_crisis',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'emotional_support', icon: <Heart /> },
      { value: 'problem_solving', icon: <Brain /> },
      { value: 'clarification_analysis', icon: <MessageCircle /> },
      { value: 'distraction', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_seeking_help',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'solve_alone' },
      { value: 'share_selectively' },
      { value: 'consult_trusted_circle' },
      { value: 'seek_professional_guidance' },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PERSONALITY',
    id: 'personality_handling_criticism_revised',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_communication_style_revised',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'direct_clear', icon: <Target /> },
      { value: 'empathetic_listening', icon: <HandHeart /> },
      { value: 'logic_facts', icon: <Brain /> },
      { value: 'humor_lightness', icon: <Smile /> },
      { value: 'openness_emotional_sharing', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_humor_type',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 2,
    options: [
      { value: 'cynical_witty' },
      { value: 'puns_wordplay' },
      { value: 'situational_sitcom' },
      { value: 'self_deprecating' },
      { value: 'silly_light' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_learning_process',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_failure_lesson',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_good_vs_perfect_day',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_vacation_compass',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'relaxation', icon: <Bed /> },
      { value: 'adventure', icon: <Mountain /> },
      { value: 'city_life', icon: <Sparkles /> },
      { value: 'social_time', icon: <Users /> },
      { value: 'romance', icon: <Heart /> },
      { value: 'enrichment', icon: <BookOpen /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_primary_motivation_revised',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'achieving_goals', icon: <Star /> },
      { value: 'building_connections', icon: <Heart /> },
      { value: 'giving_impact', icon: <HandHeart /> },
      { value: 'learning_curiosity', icon: <BookOpen /> },
      { value: 'creativity_expression', icon: <Sparkles /> },
      { value: 'security_stability', icon: <ShieldCheck /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_strengths_and_weaknesses_revised',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 70,
    maxLength: 600,
    metadata: { estimatedTime: 3 },
  },
];
--- End of Content for personalityQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\relationship
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\relationship\relationshipQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/relationship/relationshipQuestions.tsx
import { Question } from '../../types/types';
import {
  Briefcase,
  BookOpen,
  Target,
  Heart,
  Users,
  Home,
  MessageCircle,
  Scale,
  Brain,
  Moon,
  Sparkles,
  HandHeart,
  ShieldCheck,
  Link,
  Map,
  Clock,
  Award,
  Baby,
  Coffee,
  Bed,
  Smile,
  Gift,
  Info,
  HelpCircle,
} from 'lucide-react';

export const relationshipQuestions: Question[] = [
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_core_meaning_revised',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'deep_emotional_connection', icon: <Heart /> },
      { value: 'friendship_support', icon: <Users /> },
      { value: 'commitment_security', icon: <Link /> },
      { value: 'shared_growth', icon: <Sparkles /> },
      { value: 'building_home_family', icon: <Home /> },
    ],
    minSelections: 1,
    maxSelections: 2,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_key_feelings_from_partner_revised',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelectWithOther',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'support_understanding', icon: <HandHeart /> },
      { value: 'appreciation_respect', icon: <Award /> },
      { value: 'security_trust', icon: <ShieldCheck /> },
      { value: 'desire_attraction', icon: <Sparkles /> },
      { value: 'lightness_fun', icon: <Smile /> },
      { value: 'intellectual_partnership', icon: <Brain /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_love_languages',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    minSelections: 1,
    maxSelections: 2,
    options: [
      { value: 'words_of_affirmation' },
      { value: 'quality_time' },
      { value: 'physical_touch' },
      { value: 'acts_of_service' },
      { value: 'receiving_gifts' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_communication_ideal_revised',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'openness_directness', icon: <MessageCircle /> },
      { value: 'sensitivity_empathy', icon: <Heart /> },
      { value: 'solution_focused', icon: <Brain /> },
      { value: 'balance', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_handling_partner_disappointment_revised',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'withdraw_process', icon: <Moon /> },
      { value: 'immediate_talk', icon: <MessageCircle /> },
      { value: 'suppression', icon: <ShieldCheck /> },
      { value: 'logical_analysis', icon: <Brain /> },
      { value: 'not_sure', icon: <HelpCircle /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_repair_mechanism',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'processing_talk', icon: <MessageCircle /> },
      { value: 'hug_move_on', icon: <HandHeart /> },
      { value: 'time_out', icon: <Clock /> },
      { value: 'change_of_scenery', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_meaningful_apology',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'express_remorse', icon: <Heart /> },
      { value: 'take_responsibility', icon: <ShieldCheck /> },
      { value: 'offer_to_fix', icon: <Target /> },
      { value: 'saying_sorry', icon: <MessageCircle /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_silent_treatment_view',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_expressing_needs',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
        { value: 'keep_inside' },
        { value: 'wait_for_right_moment' },
        { value: 'direct_conversation' },
        { value: 'hint_repeatedly' },
    ],
    metadata: { estimatedTime: 1 },
},

{
    worldId: 'RELATIONSHIP',
    id: 'relationship_physical_intimacy_importance',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'scale',
    depth: 'EXPERT',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'RELATIONSHIP',
    id: 'relationship_screen_time_approach',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'very_limited' },
        { value: 'balanced_usage' },
        { value: 'flexible_usage' },
    ],
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'RELATIONSHIP',
    id: 'relationship_argument_style',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'expressive_emotive' },
        { value: 'need_time_to_process' },
        { value: 'immediate_resolution' },
        { value: 'conflict_avoidant' },
    ],
    metadata: { estimatedTime: 1 },
},


  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_partner_bad_day',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'listen_contain', icon: <Heart /> },
      { value: 'analyze_solve', icon: <Brain /> },
      { value: 'give_space', icon: <Home /> },
      { value: 'distract', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_receiving_support',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'need_to_vent', icon: <MessageCircle /> },
      { value: 'need_solutions', icon: <Brain /> },
      { value: 'need_distraction', icon: <Sparkles /> },
      { value: 'need_space', icon: <Home /> },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_household_philosophy',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_daily_togetherness_vs_autonomy_revised',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_role_in_growth',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'scale',
    depth: 'EXPERT',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_celebrating_success',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_family_vision_children_revised',
    category: 'relationship',
    subcategory: 'family_future_vision',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'central_part', icon: <Baby /> },
      { value: 'see_myself_as_parent', icon: <Home /> },
      { value: 'open_but_not_essential', icon: <Scale /> },
      { value: 'less_relevant', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_deal_breaker_summary_final_revised',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_dating_journey_reflection',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'new_to_process', icon: <Sparkles /> },
      { value: 'some_experience', icon: <Map /> },
      { value: 'long_journey', icon: <Clock /> },
      { value: 'taking_a_break', icon: <Moon /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_dating_journey_lesson',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
];
--- End of Content for relationshipQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion\religionQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/religion/religionQuestions.tsx
import { Question } from '../../types/types';
import {
  Scroll,
  BookOpen,
  Users,
  Home,
  Target,
  Scale,
  Heart,
  Sparkles,
  ShieldCheck,
  Flag,
  X,
  HandHeart,
  Lightbulb,
  Info,
  PocketKnife,
  Bed,
  Smile,
  Brain,
} from 'lucide-react';

export const religionQuestions: Question[] = [
  {
    worldId: 'RELIGION',
    id: 'religion_core_feeling_of_faith',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'security_stability', icon: <ShieldCheck /> },
      { value: 'meaning_belonging', icon: <Target /> },
      { value: 'joy_gratitude', icon: <Sparkles /> },
      { value: 'challenge_growth', icon: <Brain /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_my_personal_prayer',
    category: 'religion',
    subcategory: 'personal_reflection',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_rabbinic_guidance_role_revised',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_shabbat_experience',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'family_time', icon: <Home /> },
      { value: 'spiritual_ascension', icon: <BookOpen /> },
      { value: 'rest_recharge', icon: <Bed /> },
      { value: 'community_social', icon: <Users /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_daily_spiritual_connection',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 3,
    options: [
      { value: 'torah_study' },
      { value: 'personal_prayer' },
      { value: 'nature_gratitude' },
      { value: 'acts_of_kindness' },
      { value: 'song_music' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_kashrut_observance_details_revised',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_modesty_personal_approach_revised',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_secular_culture_scenario',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'avoid', icon: <X /> },
      { value: 'filter_check', icon: <Info /> },
      { value: 'social_inclusion', icon: <Users /> },
      { value: 'suggest_alternative', icon: <Smile /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_general_culture_consumption',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_community_role',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'central' },
      { value: 'important' },
      { value: 'secondary' },
      { value: 'not_seeking' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_partner_torah_learning_expectation',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'dedicated_daily' },
      { value: 'regularly_flexible' },
      { value: 'when_possible' },
      { value: 'not_a_focus' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_army_service_attitude',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'essential_for_men' },
      { value: 'meaningful_service' },
      { value: 'torah_is_protection' },
      { value: 'flexible_personal_choice' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_zionism_importance',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_intergroup_friendships',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'large_part' },
      { value: 'some_friends' },
      { value: 'mostly_homogeneous' },
    ],
    metadata: { estimatedTime: 1 },
  },

  {
    worldId: 'RELIGION',
    id: 'religion_doubts_and_struggles',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_partner_ideal_religious_profile_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_flexibility_religious_differences_partner_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_gender_roles_philosophy',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'budgetAllocation',
    depth: 'EXPERT',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'traditional', icon: <Scroll /> },
      { value: 'egalitarian', icon: <Scale /> },
      { value: 'flexible', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_children_education_religious_vision_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_other_denominations_attitude',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'decline' },
      { value: 'conditional_participation' },
      { value: 'accept_openly' },
      { value: 'depends_on_context' },
    ],
    metadata: { estimatedTime: 1 },
  },
];
--- End of Content for religionQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\values
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\values\valuesQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/values/valuesQuestions.tsx
import { Question } from '../../types/types';
import {
  Heart,
  Scale,
  Brain,
  BookOpen,
  Users,
  Home,
  Briefcase,
  Target,
  PiggyBank,
  HandHeart,
  TrendingUp,
  Leaf,
  Sparkles,
  ShieldCheck,
  Flag,
  HelpCircle,
  Info,
  Scroll,
  DollarSign,
  Activity,
  MessageCircle,
} from 'lucide-react';

export const valuesQuestions: Question[] = [
  {
    worldId: 'VALUES',
    id: 'values_core_identification_revised',
    category: 'values',
    subcategory: 'core_values',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'family_connections', icon: <Heart /> },
      { value: 'integrity_honesty', icon: <ShieldCheck /> },
      { value: 'spirituality_faith', icon: <BookOpen /> },
      { value: 'personal_growth', icon: <TrendingUp /> },
      { value: 'giving_contribution', icon: <HandHeart /> },
      { value: 'career_fulfillment', icon: <Briefcase /> },
      { value: 'financial_security', icon: <PiggyBank /> },
      { value: 'creativity_expression', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_core_elaboration_revised',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 70,
    maxLength: 600,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_childhood_home_atmosphere',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 10,
    maxLength: 150,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_quiet_heroes',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_childhood_shaping_experience',
    category: 'values',
    subcategory: 'core_values',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 3,
    options: [
      { value: 'financial_struggle_or_abundance', icon: <DollarSign /> },
      { value: 'parental_relationship_dynamics', icon: <Home /> },
      { value: 'social_challenges_school', icon: <Users /> },
      { value: 'health_or_loss_experiences', icon: <Heart /> },
      { value: 'academic_pressure_or_freedom', icon: <BookOpen /> },
      { value: 'religious_environment_strict_or_open', icon: <Scroll /> },
    ],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_strength_from_challenge',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },

  {
    worldId: 'VALUES',
    id: 'values_two_job_offers',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'scenario',
    depth: 'EXPERT',
    isRequired: false,
    options: [{ value: 'offer_a' }, { value: 'offer_b' }],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_life_priorities_allocation_revised',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'relationship', icon: <Heart /> },
      { value: 'family', icon: <Home /> },
      { value: 'career', icon: <Briefcase /> },
      { value: 'spirituality', icon: <BookOpen /> },
      { value: 'community', icon: <Users /> },
      { value: 'leisure', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 4 },
  },
  {
    worldId: 'VALUES',
    id: 'values_health_lifestyle_importance',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_risk_attitude',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'iconChoice', // ×©×™× ×•×™ ×ž×¡×•×’ scale ×œ-iconChoice
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'stability_anchor', icon: <ShieldCheck /> }, // ×¢×•×’×Ÿ ×•×™×¦×™×‘×•×ª
      { value: 'calculated_balance', icon: <Scale /> }, // ××™×–×•×Ÿ ×ž×—×•×©×‘
      { value: 'growth_opportunity', icon: <TrendingUp /> }, // ×¦×ž×™×—×” ×•×”×–×“×ž× ×•×ª
    ],
    metadata: { estimatedTime: 1 },
  },

  {
    worldId: 'VALUES',
    id: 'values_feeling_of_home',
    category: 'values',
    subcategory: 'community_social',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_definition_of_rich_life',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_attitude_towards_money_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'security_tool', icon: <PiggyBank /> },
      { value: 'means_for_experiences', icon: <Sparkles /> },
      { value: 'balance_responsibility', icon: <Scale /> },
      { value: 'simplicity', icon: <Leaf /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_definition_of_success',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_extended_family_involvement',
    category: 'values',
    subcategory: 'community_social',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'high_involvement' },
      { value: 'healthy_boundaries' },
      { value: 'minimal_involvement' },
      { value: 'depends_on_dynamics' },
    ],
    metadata: { estimatedTime: 1 },
  },

  {
    worldId: 'VALUES',
    id: 'values_lost_wallet',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_moral_dilemma',
    category: 'values',
    subcategory: 'core_values',
    type: 'scenario',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'express_discomfort' },
      { value: 'listen_without_judgment' },
      { value: 'challenge_and_advise' },
      { value: 'do_not_intervene' },
    ],
    metadata: { estimatedTime: 2 },
  },

  {
    worldId: 'VALUES',
    id: 'values_giving_tzedaka_importance_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_education_pursuit_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'lifelong_learning', icon: <BookOpen /> },
      { value: 'goal_oriented_learning', icon: <Target /> },
      { value: 'experiential_learning', icon: <Sparkles /> },
      { value: 'appreciative_but_passive', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_parents_tradition_conflict',
    category: 'values',
    subcategory: 'challenges_conflicts',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_social_political_stance_importance_partner_revised',
    category: 'values',
    subcategory: 'community_social',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_dealing_with_disagreement_partner_revised',
    category: 'values',
    subcategory: 'challenges_conflicts',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'discussion_understanding', icon: <MessageCircle /> },
      { value: 'finding_common_ground', icon: <Brain /> },
      { value: 'seeking_compromise', icon: <Scale /> },
      { value: 'agree_to_disagree', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_non_negotiable_for_partner_revised',
    category: 'values',
    subcategory: 'summary_future',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
];
--- End of Content for valuesQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\types\types.ts
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/types/types.ts

// Basic type definitions
export type WorldId =
  | 'VALUES'
  | 'RELATIONSHIP'
  | 'PERSONALITY'
  | 'PARTNER'
  | 'RELIGION';

export type QuestionType =
  | 'singleChoice'
  | 'multiChoice'
  | 'multiSelect'
  | 'openText'
  | 'scale'
  | 'iconChoice'
  | 'budgetAllocation'
  | 'ranking'
  | 'scenario'
  | 'multiSelectWithOther';

export type QuestionDepth = 'BASIC' | 'ADVANCED' | 'EXPERT';

export type AnswerValue = string | number | string[] | number[] | Record<string, number> | { text: string; lang: string } | undefined;

export type AnswerStatus = 'COMPLETE' | 'PARTIAL' | 'SKIPPED';

// --- UPDATED INTERFACES ---

export interface Option {
  value: string; // This is the key for the dictionary
  icon?: React.ReactNode;
  text?: string; // Re-added as optional
  description?: string; // Re-added as optional
  allowFreeText?: boolean;
  placeholder?: string;
}

export interface BudgetCategory {
  value: string; // The key for the dictionary
  label?: string; // Re-added as optional
  icon?: React.ReactNode;
  description?: string; // Re-added as optional
  min?: number;
  max?: number;
}

export interface QuestionMetadata {
  estimatedTime?: number;
  tags?: string[];
  helpText?: string; // Re-added as optional
}

export interface ScaleLabels {
  min: string;
  max: string;
  middle?: string;
}

export interface ScaleDescriptions {
  min?: string;
  max?: string;
  middle?: string;
  [key: number]: string;
}

export interface Question {
  worldId: string;
  id: string;
  category: string;
  subcategory?: string;
  question?: string; // Re-added as optional
  type: QuestionType;
  depth: QuestionDepth;
  isRequired?: boolean;
  options?: Option[];
  placeholder?: string; // Re-added as optional
  description?: string; // Re-added as optional
  minLength?: number;
  maxLength?: number;
  minSelections?: number;
  maxSelections?: number;
  min?: number;
  max?: number;
  step?: number;
  labels?: ScaleLabels;
  scaleDescriptions?: ScaleDescriptions;
  categories?: BudgetCategory[];
  totalPoints?: number;
  metadata?: QuestionMetadata;
  items?: Option[];
  icon?: React.ReactNode;
}

// --- Answer-related interfaces ---

export interface QuestionnaireAnswer {
  questionId: string;
  worldId: WorldId;
  value: AnswerValue;
  answeredAt: string;
  isVisible?: boolean;
  language?: 'en' | 'he'; 
}

export interface Answer extends QuestionnaireAnswer {
  status?: AnswerStatus;
}

// --- Component Props interfaces ---

export interface WorldComponentProps {
  onAnswer: (questionId: string, value: AnswerValue) => void;
  onComplete: () => void;
  onBack: () => void;
  answers: QuestionnaireAnswer[];
  isCompleted?: boolean;
  language?: string;
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
}

export interface AnswerInputProps {
  question: Question;
  value?: AnswerValue;
  onChange?: (value: AnswerValue) => void;
  onClear?: () => void;
  language?: string;
  showValidation?: boolean;
  className?: string;
  validationError?: string;
}

export interface QuestionnaireLayoutProps {
  children: React.ReactNode;
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit?: () => void;
  language?: string;
  onSaveProgress?: () => Promise<void>;
  isLoggedIn?: boolean;
}

// --- Data storage interfaces ---

export interface QuestionnaireSubmission {
  userId: string;
  answers: QuestionnaireAnswer[];
  worldsCompleted: WorldId[];
  completed: boolean;
  startedAt: string;
  completedAt?: string;
    currentQuestionIndices?: Record<WorldId, number>;
}
--- End of Content for types.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\worlds
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\worlds\WorldComponent.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/worlds/WorldComponent.tsx
'use client';

import { CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import QuestionCard from '../common/QuestionCard';
import AnswerInput from '../common/AnswerInput';
import QuestionsList from '../common/QuestionsList';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import {
  ArrowLeft,
  ArrowRight,
  AlertCircle,
  CheckCircle,
  List,
  Loader2,
  Save,
  ListChecks,
  Sparkles,
  Target,
  Star,
  Award,
  Heart,
  Compass,
} from 'lucide-react';
import { Card } from '@/components/ui/card';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import type {
  AnswerValue,
  Question,
  QuestionnaireAnswer,
  WorldId,
} from '../types/types';
import { cn } from '@/lib/utils';
import { useMediaQuery } from '../hooks/useMediaQuery';
import { motion, AnimatePresence } from 'framer-motion';
import type {
  WorldComponentDict,
  QuestionCardDict,
  AnswerInputDict,
  InteractiveScaleDict,
  QuestionsListDict,
  QuestionsDictionary,
} from '@/types/dictionary';

// Questions Imports
import { personalityQuestions } from '../questions/personality/personalityQuestions';
import { valuesQuestions } from '../questions/values/valuesQuestions';
import { relationshipQuestions } from '../questions/relationship/relationshipQuestions';
import { partnerQuestions } from '../questions/partner/partnerQuestions';
import { religionQuestions } from '../questions/religion/religionQuestions';

const worldConfig: Record<
  WorldId,
  {
    questions: Question[];
    themeColor: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
    icon: React.ReactNode;
    gradient: string;
  }
> = {
  PERSONALITY: {
    questions: personalityQuestions,
    themeColor: 'sky',
    icon: <Sparkles className="w-5 h-5" />,
    gradient: 'from-cyan-400 via-sky-500 to-blue-500',
  },
  VALUES: {
    questions: valuesQuestions,
    themeColor: 'rose',
    icon: <Heart className="w-5 h-5" />,
    gradient: 'from-rose-400 via-pink-500 to-red-500',
  },
  RELATIONSHIP: {
    questions: relationshipQuestions,
    themeColor: 'purple',
    icon: <Target className="w-5 h-5" />,
    gradient: 'from-purple-400 via-violet-500 to-indigo-500',
  },
  PARTNER: {
    questions: partnerQuestions,
    themeColor: 'teal',
    icon: <Star className="w-5 h-5" />,
    gradient: 'from-teal-400 via-emerald-500 to-green-500',
  },
  RELIGION: {
    questions: religionQuestions,
    themeColor: 'amber',
    icon: <Award className="w-5 h-5" />,
    gradient: 'from-amber-400 via-orange-500 to-yellow-500',
  },
};

const getQuestionWithText = (
  questionStructure: Question,
  dict: WorldComponentDynamicProps['dict']
): Question => {
  const qContent =
    dict.questions[questionStructure.worldId as WorldId]?.[
      questionStructure.id
    ];

  if (!qContent) {
    console.error(
      `Missing dictionary entry for question: ${questionStructure.id}`
    );
    return {
      ...questionStructure,
      question: `Error: Missing text for ${questionStructure.id}`,
    };
  }

  const optionsWithText = questionStructure.options?.map((opt) => {
    const optionContent = qContent.options?.[opt.value];
    if (typeof optionContent === 'string') {
      return { ...opt, text: optionContent };
    }
    if (typeof optionContent === 'object' && optionContent !== null) {
      return {
        ...opt,
        text: optionContent.text,
        description: optionContent.description,
      };
    }
    return { ...opt, text: opt.value };
  });

  const categoriesWithText = questionStructure.categories?.map((cat) => {
    const categoryContent = qContent.categories?.[cat.value];
    if (typeof categoryContent === 'string') {
      return { ...cat, label: categoryContent };
    }
    if (typeof categoryContent === 'object' && categoryContent !== null) {
      return {
        ...cat,
        label: categoryContent.label,
        description: categoryContent.description,
      };
    }
    return { ...cat, label: cat.value };
  });

  return {
    ...questionStructure,
    question: qContent.question,
    placeholder: qContent.placeholder,
    metadata: {
      ...questionStructure.metadata,
      helpText: qContent.helpText,
    },
    options: optionsWithText,
    categories: categoriesWithText,
    labels: qContent.labels || questionStructure.labels,
  };
};

interface WorldComponentDynamicProps {
  worldId: WorldId;
  onAnswer: (worldId: WorldId, questionId: string, value: AnswerValue) => void;
  onVisibilityChange: (
    worldId: WorldId,
    questionId: string,
    isVisible: boolean
  ) => void;
  onComplete: () => void;
  onBack: () => void;
  answers: QuestionnaireAnswer[];
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
  onSave?: (isAutoSave?: boolean) => void;
  isSaving?: boolean;
  lastSaved?: Date | null;
  isDirectNavigation?: boolean;
  dict: {
    world: WorldComponentDict;
    questionCard: QuestionCardDict;
    answerInput: AnswerInputDict;
    interactiveScale: InteractiveScaleDict;
    questionsList: QuestionsListDict;
    questions: QuestionsDictionary;
    worldLabels: Record<WorldId, string>;
  };
  locale: 'he' | 'en';
  onMobileMenuOpen?: () => void;
}

export default function WorldComponent({
  worldId,
  onAnswer,
  onVisibilityChange,
  onComplete,
  onBack,
  answers,
  currentQuestionIndex,
  setCurrentQuestionIndex,
  onSave,
  isSaving,
  lastSaved,
  isDirectNavigation = false,
  dict,
  locale,
  onMobileMenuOpen,
}: WorldComponentDynamicProps) {
  const worldDict = dict.world;
  const validationDict = worldDict.errors.validation;

  const [validationErrors, setValidationErrors] = useState<
    Record<string, string>
  >({});
  const isDesktop = useMediaQuery('(min-width: 1024px)');
  const [isListVisible, setIsListVisible] = useState(true);
  const isRTL = locale === 'he';
  const [animateError, setAnimateError] = useState(false);
  const [showCelebration, setShowCelebration] = useState(false);
  const [isCompleting, setIsCompleting] = useState(false);

  const {
    questions: allQuestionsStructure,
    themeColor,
    icon,
    gradient,
  } = worldConfig[worldId];

  const allQuestions = useMemo(
    () =>
      allQuestionsStructure.map((qStruct) =>
        getQuestionWithText(qStruct, dict)
      ),
    [allQuestionsStructure, dict]
  );

  const title = dict.worldLabels[worldId];

  const answeredQuestions = allQuestions.filter((q) =>
    answers.find((a) => a.questionId === q.id && a.value !== undefined)
  ).length;
  const requiredAnswered = allQuestions.filter(
    (q) =>
      q.isRequired &&
      answers.find((a) => a.questionId === q.id && a.value !== undefined)
  ).length;
  const totalRequired = allQuestions.filter((q) => q.isRequired).length;

  const remainingTimeMinutes = useMemo(() => {
    let totalMinutes = 0;
    for (let i = currentQuestionIndex; i < allQuestions.length; i++) {
      totalMinutes += allQuestions[i].metadata?.estimatedTime || 1;
    }
    return Math.max(1, Math.round(totalMinutes));
  }, [currentQuestionIndex, allQuestions]);

  useEffect(() => {
    if (currentQuestionIndex < 0) {
      setCurrentQuestionIndex(0);
    } else if (currentQuestionIndex >= allQuestions.length) {
      setCurrentQuestionIndex(allQuestions.length - 1);
    }
  }, [currentQuestionIndex, allQuestions.length, setCurrentQuestionIndex]);

  const handleAnswer = useCallback(
    (value: AnswerValue) => {
      const currentQuestion = allQuestions[currentQuestionIndex];
      onAnswer(worldId, currentQuestion.id, value);

      const newErrors = { ...validationErrors };
      delete newErrors[currentQuestion.id];
      setValidationErrors(newErrors);
    },
    [
      currentQuestionIndex,
      allQuestions,
      worldId,
      onAnswer,
      validationErrors,
      setValidationErrors,
    ]
  );

  const handleNext = useCallback(async () => {
    const currentQuestion = allQuestions[currentQuestionIndex];
    const currentAnswer = answers.find(
      (a) => a.questionId === currentQuestion.id
    );

    if (
      currentQuestion.isRequired &&
      (!currentAnswer?.value ||
        (Array.isArray(currentAnswer.value) &&
          currentAnswer.value.length === 0))
    ) {
      setValidationErrors({
        [currentQuestion.id]: validationDict.required,
      });
      setAnimateError(true);
      setTimeout(() => setAnimateError(false), 500);
      return;
    }

    if (currentQuestionIndex < allQuestions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
      if (onSave) {
        onSave(true); // true ××•×ž×¨: ×ª×©×ž×•×¨, ××‘×œ ××œ ×ª×¦×™×’ ×”×•×“×¢×” ×§×•×¤×¦×ª ×œ×ž×©×ª×ž×©
      }
      const progress = Math.round(
        ((currentQuestionIndex + 2) / allQuestions.length) * 100
      );
      if ([25, 50, 75].includes(progress)) {
        setShowCelebration(true);
        setTimeout(() => setShowCelebration(false), 3000);
      }
    } else {
      if (requiredAnswered < totalRequired) {
        setValidationErrors({
          general: validationDict.generalRequired
            .replace('{{current}}', requiredAnswered.toString())
            .replace('{{total}}', totalRequired.toString()),
        });
        setAnimateError(true);
        setTimeout(() => setAnimateError(false), 500);
        return;
      }

      setIsCompleting(true);
      setShowCelebration(true);
      await new Promise((resolve) => setTimeout(resolve, 2000));
      onComplete();
      setIsCompleting(false);
    }
  }, [
    currentQuestionIndex,
    allQuestions,
    answers,
    setCurrentQuestionIndex,
    onComplete,
    validationDict,
    requiredAnswered,
    totalRequired,
  ]);

  const handlePrevious = useCallback(() => {
    if (currentQuestionIndex > 0) {
      setCurrentQuestionIndex(currentQuestionIndex - 1);
    } else {
      onBack();
    }
  }, [currentQuestionIndex, setCurrentQuestionIndex, onBack]);

  const overallProgress = (answeredQuestions / allQuestions.length) * 100;
  const currentQuestion = allQuestions[currentQuestionIndex];
  const currentAnswer = answers.find(
    (a) => a.questionId === currentQuestion?.id
  );

  const renderQuestionCard = () => {
    if (!currentQuestion) {
      return (
        <Card className="rounded-3xl shadow-xl border-2 border-gray-200 p-8">
          <div className="text-center text-gray-500">
            <AlertCircle className="w-12 h-12 mx-auto mb-4" />
            <p>{worldDict.errors.noQuestionFound}</p>
          </div>
        </Card>
      );
    }

    return (
      <motion.div
        key={currentQuestion.id}
        initial={{ opacity: 0, x: isRTL ? -50 : 50 }}
        animate={{
          opacity: 1,
          x: 0,
          scale: animateError ? [1, 1.02, 1] : 1,
        }}
        exit={{ opacity: 0, x: isRTL ? 50 : -50 }}
        transition={{ duration: 0.3 }}
      >
        <QuestionCard
          question={currentQuestion}
          depth={currentQuestion.depth}
          isRequired={currentQuestion.isRequired}
          validationError={validationErrors[currentQuestion.id]}
          locale={locale}
          themeColor={themeColor}
          isVisible={currentAnswer?.isVisible ?? true}
          onVisibilityChange={(isVisible) =>
            onVisibilityChange(worldId, currentQuestion.id, isVisible)
          }
          dict={dict.questionCard}
          currentQuestionNumber={currentQuestionIndex + 1}
          totalQuestions={allQuestions.length}
          estimatedTimeMinutes={remainingTimeMinutes}
        >
          <AnswerInput
            question={currentQuestion}
            value={currentAnswer?.value}
            onChange={handleAnswer}
            locale={locale}
            themeColor={themeColor}
            dict={{
              answerInput: dict.answerInput,
              interactiveScale: dict.interactiveScale,
            }}
          />
          {validationErrors[currentQuestion.id] && (
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="mt-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl"
            >
              <div className="flex items-center gap-3">
                <AlertCircle className="h-5 w-5 text-red-600 flex-shrink-0" />
                <p className="text-sm font-medium text-red-800">
                  {validationErrors[currentQuestion.id]}
                </p>
              </div>
            </motion.div>
          )}
        </QuestionCard>
      </motion.div>
    );
  };

  const renderNavigationButtons = () => {
    const PrevIcon = isRTL ? ArrowRight : ArrowLeft;
    const NextIcon = isRTL ? ArrowLeft : ArrowRight;

    if (isDesktop) {
      return (
        <motion.div
          className="flex items-center justify-between gap-4 mt-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
        >
          <Button
            variant="outline"
            onClick={handlePrevious}
            className="flex items-center gap-3 rounded-2xl px-6 py-6 text-base font-semibold border-2 hover:bg-gray-50 transition-all duration-300"
          >
            <PrevIcon className="h-5 w-5" />
            <span>
              {currentQuestionIndex === 0
                ? worldDict.buttons.backToMap
                : worldDict.buttons.previous}
            </span>
          </Button>

          {currentQuestionIndex < allQuestions.length - 1 ? (
            <Button
              variant="default"
              onClick={handleNext}
              className={cn(
                'flex items-center gap-3 rounded-2xl px-8 py-6 text-base font-bold shadow-lg',
                'bg-gradient-to-r text-white hover:opacity-90 transition-all duration-300',
                gradient
              )}
            >
              <span>{worldDict.buttons.next}</span>
              <NextIcon className="h-5 w-5" />
            </Button>
          ) : (
            <Button
              onClick={handleNext}
              disabled={isCompleting}
              className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white flex items-center gap-3 rounded-2xl px-8 py-6 text-base font-bold shadow-lg transition-all duration-300 disabled:opacity-70 disabled:cursor-not-allowed"
            >
              {isCompleting ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin" />
                  <span>{worldDict.buttons.completing}</span>
                </>
              ) : (
                <>
                  <span>{worldDict.buttons.finish}</span>
                  <CheckCircle className="h-5 w-5" />
                </>
              )}
            </Button>
          )}
        </motion.div>
      );
    }

    // Mobile buttons
    return (
      <motion.div
        className="fixed bottom-4 left-0 right-0 z-40 px-4"
        initial={{ opacity: 0, y: 100 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3, type: 'spring', stiffness: 100 }}
      >
        <div className="max-w-2xl mx-auto flex items-center justify-between gap-3">
          <Button
            variant="outline"
            onClick={handlePrevious}
            className="flex items-center gap-2 rounded-full px-5 py-6 bg-white/95 backdrop-blur-sm border-2 shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300"
          >
            <PrevIcon className="h-5 w-5" />
            <span className="font-semibold text-sm">
              {currentQuestionIndex === 0
                ? worldDict.buttons.backToMap
                : worldDict.buttons.prevShort}
            </span>
          </Button>

          <div className="flex items-center gap-2 px-4 py-3 bg-white/95 backdrop-blur-sm rounded-full border-2 border-gray-200 shadow-lg">
            <span className="text-xs font-bold text-gray-600">
              {currentQuestionIndex + 1}/{allQuestions.length}
            </span>
          </div>

          {currentQuestionIndex < allQuestions.length - 1 ? (
            <Button
              onClick={handleNext}
              className={cn(
                'flex items-center gap-2 rounded-full px-5 py-6 font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300',
                'bg-gradient-to-r text-white',
                gradient
              )}
            >
              <span className="text-sm">{worldDict.buttons.nextShort}</span>
              <NextIcon className="h-5 w-5" />
            </Button>
          ) : (
            <Button
              onClick={handleNext}
              disabled={isCompleting}
              className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white flex items-center gap-2 rounded-full px-5 py-6 font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 disabled:opacity-70 disabled:scale-100"
            >
              {isCompleting ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin" />
                  <span className="text-sm">
                    {worldDict.buttons.completing}
                  </span>
                </>
              ) : (
                <>
                  <span className="text-sm">
                    {worldDict.buttons.finishShort}
                  </span>
                  <CheckCircle className="h-5 w-5" />
                </>
              )}
            </Button>
          )}
        </div>
      </motion.div>
    );
  };

  const renderCelebration = () => {
    if (!showCelebration) return null;

    const progressPercent = Math.round(
      (answeredQuestions / allQuestions.length) * 100
    );
    let message = '';
    if (progressPercent === 25) message = worldDict.celebration.quarter;
    else if (progressPercent === 50) message = worldDict.celebration.half;
    else if (progressPercent === 75)
      message = worldDict.celebration.threeQuarters;
    else if (progressPercent >= 100) message = worldDict.celebration.complete;

    if (!message) return null;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0, scale: 0.8, y: 50 }}
          animate={{ opacity: 1, scale: 1, y: 0 }}
          exit={{ opacity: 0, scale: 0.8, y: 50 }}
          className={cn(
            'fixed left-1/2 transform -translate-x-1/2 z-50',
            isDesktop ? 'bottom-8' : 'bottom-24'
          )}
        >
          <div
            className={cn(
              'bg-gradient-to-r text-white px-8 py-4 rounded-full shadow-2xl border-4 border-white',
              gradient
            )}
          >
            <p className="text-xl font-bold text-center">{message}</p>
          </div>
        </motion.div>
      </AnimatePresence>
    );
  };

  const MobileWorldHeader = () => {
    const formatLastSaved = (date: Date | null) => {
      if (!date) return null;
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) {
        return worldDict.header.lastSaved.now;
      } else if (diffMins === 1) {
        return worldDict.header.lastSaved.minuteAgo;
      } else if (diffMins < 60) {
        return worldDict.header.lastSaved.minutesAgo.replace(
          '{{count}}',
          diffMins.toString()
        );
      } else {
        const diffHours = Math.floor(diffMins / 60);
        return worldDict.header.lastSaved.hoursAgo.replace(
          '{{count}}',
          diffHours.toString()
        );
      }
    };

    const lastSavedText = formatLastSaved(lastSaved || null);

    return (
      <div className="bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-lg border-2 border-white mb-6">
        <div className="flex items-center justify-between gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={onMobileMenuOpen}
            className="p-2.5 bg-white border-2 border-gray-300 rounded-xl flex-shrink-0 transition-all duration-200 hover:scale-105 hover:bg-gray-50 hover:border-gray-400 shadow-sm"
          >
            <Compass className="h-5 w-5 text-gray-700" />
          </Button>
  <Button
      variant="outline"
      size="sm"
      onClick={() => onSave && onSave(false)} // false = ×©×ž×™×¨×” ×™×“× ×™×ª ×¢× ×”×•×“×¢×”
      disabled={isSaving}
      className="p-2.5 bg-white border-2 border-teal-200 text-teal-600 rounded-xl flex-shrink-0 hover:bg-teal-50 shadow-sm"
    >
      {isSaving ? (
        <Loader2 className="h-5 w-5 animate-spin" />
      ) : (
        <Save className="h-5 w-5" />
      )}
    </Button>
          <div className="flex items-center gap-2 flex-1 min-w-0">
            <div
              className={cn(
                'p-2 rounded-xl bg-gradient-to-br text-white flex-shrink-0',
                gradient
              )}
            >
              {icon}
            </div>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2">
                <h2 className="font-bold text-base text-gray-800 truncate">
                  {title}
                </h2>
                {(isSaving || lastSavedText) && (
                  <div className="flex items-center gap-1">
                    {isSaving ? (
                      <>
                        <Loader2 className="h-3 w-3 text-blue-500 animate-spin" />
                        <span className="text-xs text-blue-600 font-medium whitespace-nowrap">
                          {worldDict.buttons.saving}
                        </span>
                      </>
                    ) : lastSavedText ? (
                      <>
                        <CheckCircle className="h-3 w-3 text-green-500" />
                        <span className="text-xs text-green-600 font-medium whitespace-nowrap">
                          {lastSavedText}
                        </span>
                      </>
                    ) : null}
                  </div>
                )}
              </div>
              <span className="text-xs text-gray-500 font-medium">
                {worldDict.header.questionLabel
                  .replace('{{current}}', (currentQuestionIndex + 1).toString())
                  .replace('{{total}}', allQuestions.length.toString())}
              </span>
            </div>
          </div>

          <Sheet>
            <SheetTrigger asChild>
              <Button
                variant="outline"
                size="sm"
                className="gap-1.5 font-medium rounded-xl flex-shrink-0 px-2 sm:px-3 transition-all duration-200 hover:scale-105"
              >
                <List className="h-4 w-4" />
                <span className="hidden sm:inline">
                  {worldDict.buttons.questionList}
                </span>
              </Button>
            </SheetTrigger>
            <SheetContent
              side={isRTL ? 'left' : 'right'}
              className="w-[300px] sm:w-[400px] flex flex-col p-0"
            >
              <SheetHeader className="p-4 border-b">
                <SheetTitle>
                  <div className="flex items-center gap-3">
                    <div
                      className={cn(
                        'p-2 rounded-lg bg-gradient-to-br text-white',
                        gradient
                      )}
                    >
                      <ListChecks className="h-5 w-5" />
                    </div>
                    <span className="text-lg">
                      {worldDict.listSheet.title.replace(
                        '{{worldTitle}}',
                        title
                      )}
                    </span>
                  </div>
                </SheetTitle>
              </SheetHeader>
              <div className="flex-1 overflow-hidden">
                <QuestionsList
                  allQuestions={allQuestions}
                  currentQuestionIndex={currentQuestionIndex}
                  setCurrentQuestionIndex={setCurrentQuestionIndex}
                  answers={answers}
                  locale={locale}
                  themeColor={themeColor}
                  className="h-full"
                  dict={dict.questionsList}
                />
              </div>
            </SheetContent>
          </Sheet>
        </div>

        <div className="mt-3 space-y-1">
          <div className="flex justify-between text-xs font-medium">
            <span className="text-gray-600">
              {worldDict.header.overallProgress}
            </span>
            <span className={cn('font-bold', `text-${themeColor}-600`)}>
              {Math.round(overallProgress)}%
            </span>
          </div>
          <Progress
            value={overallProgress}
            className="h-2"
            indicatorClassName={cn('bg-gradient-to-r', gradient)}
          />
        </div>
      </div>
    );
  };

  if (isDesktop) {
    return (
      <div className="w-full" dir={isRTL ? 'rtl' : 'ltr'}>
        <div
          className={cn(
            'transition-all duration-500 ease-in-out',
            isListVisible ? 'grid grid-cols-12 gap-8' : 'flex justify-center'
          )}
        >
          <div
            className={cn(
              'space-y-6',
              isListVisible
                ? 'col-span-12 lg:col-span-7 xl:col-span-8'
                : 'w-full max-w-5xl mx-auto'
            )}
          >
            {renderQuestionCard()}
            {renderNavigationButtons()}
          </div>

          <AnimatePresence>
            {isListVisible && (
              <motion.div
                className="col-span-12 lg:col-span-5 xl:col-span-4"
                initial={{ opacity: 0, width: 0 }}
                animate={{ opacity: 1, width: 'auto' }}
                exit={{ opacity: 0, width: 0 }}
                transition={{ duration: 0.4, ease: 'easeInOut' }}
              >
                <div className="sticky top-8">
                  <Card className="rounded-3xl shadow-2xl border-2 border-white overflow-hidden h-[calc(100vh-4rem)]">
                    <div className={cn('h-2 bg-gradient-to-r', gradient)} />
                    <CardHeader
                      className={cn(
                        'pb-4 pt-6 border-b-2 bg-gradient-to-br',
                        `from-${themeColor}-50/50 to-${themeColor}-50/30`
                      )}
                    >
                      <CardTitle className="text-xl font-bold flex items-center gap-3 text-gray-800">
                        <div
                          className={cn(
                            'p-2 rounded-xl bg-gradient-to-br text-white',
                            gradient
                          )}
                        >
                          <ListChecks className="h-5 w-5" />
                        </div>
                        <span>
                          {worldDict.listSheet.title.replace(
                            '{{worldTitle}}',
                            title
                          )}
                        </span>
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="p-2 overflow-hidden h-[calc(100%-100px)]">
                      <QuestionsList
                        allQuestions={allQuestions}
                        currentQuestionIndex={currentQuestionIndex}
                        setCurrentQuestionIndex={setCurrentQuestionIndex}
                        answers={answers}
                        locale={locale}
                        themeColor={themeColor}
                        className="h-full"
                        dict={dict.questionsList}
                      />
                    </CardContent>
                  </Card>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
        {renderCelebration()}
      </div>
    );
  } else {
    // Mobile view
    return (
      <div
        className="max-w-2xl mx-auto p-2 sm:p-4 space-y-6 pb-32 min-h-screen"
        dir={isRTL ? 'rtl' : 'ltr'}
      >
        <MobileWorldHeader />
        {renderQuestionCard()}
        {renderNavigationButtons()}
        {renderCelebration()}
      </div>
    );
  }
}
--- End of Content for WorldComponent.tsx ---

