################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages
# Generated on: 2026-02-20 07:17:46
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\AvailabilityRequestCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/AvailabilityRequestCard.tsx

import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Clock, CheckCircle, XCircle } from 'lucide-react';
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
import type { AvailabilityRequestCardDict } from '@/types/dictionary';
import { cn } from '@/lib/utils';
import type { Locale } from '../../../i18n-config';

interface AvailabilityRequestCardProps {
  inquiry: ExtendedAvailabilityInquiry;
  currentUserId: string;
  onRespond: (inquiryId: string, isAvailable: boolean) => Promise<void>;
  dict: AvailabilityRequestCardDict;
  locale: Locale;
}

export default function AvailabilityRequestCard({
  inquiry,
  currentUserId,
  onRespond,
  dict,
  locale,
}: AvailabilityRequestCardProps) {
  const isFirstParty = inquiry.firstPartyId === currentUserId;
  const isSecondParty = inquiry.secondPartyId === currentUserId;
  const totalResponses = [
    inquiry.firstPartyResponse,
    inquiry.secondPartyResponse,
  ].filter((r) => r !== null).length;
  const progress = (totalResponses / 2) * 100;

  return (
    <Card>
      <CardContent className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h3 className="font-medium">{dict.title}</h3>
            <p className="text-sm text-gray-600">
              {dict.fromMatchmaker.replace(
                '{{name}}',
                `${inquiry.matchmaker.firstName} ${inquiry.matchmaker.lastName}`
              )}
            </p>
          </div>
          <Clock className="w-5 h-5 text-gray-400" />
        </div>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-gray-500">
                {dict.firstPartyLabel}
              </div>
              <div className="flex items-center mt-1">
                {inquiry.firstPartyResponse === null ? (
                  <Clock
                    className={cn(
                      'w-4 h-4 text-yellow-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : inquiry.firstPartyResponse ? (
                  <CheckCircle
                    className={cn(
                      'w-4 h-4 text-green-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : (
                  <XCircle
                    className={cn(
                      'w-4 h-4 text-red-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                )}
                <span>
                  {inquiry.firstParty.firstName} {inquiry.firstParty.lastName}
                </span>
              </div>
            </div>
            <div>
              <div className="text-sm text-gray-500">
                {dict.secondPartyLabel}
              </div>
              <div className="flex items-center mt-1">
                {inquiry.secondPartyResponse === null ? (
                  <Clock
                    className={cn(
                      'w-4 h-4 text-yellow-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : inquiry.secondPartyResponse ? (
                  <CheckCircle
                    className={cn(
                      'w-4 h-4 text-green-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : (
                  <XCircle
                    className={cn(
                      'w-4 h-4 text-red-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                )}
                <span>
                  {inquiry.secondParty.firstName} {inquiry.secondParty.lastName}
                </span>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <div className="flex justify-between text-sm text-gray-500">
              <span>{dict.progressLabel}</span>
              <span>{progress}%</span>
            </div>
            <Progress value={progress} className="w-full" />
          </div>

          {inquiry.note && (
            <div className="text-sm text-gray-600">
              <strong>{dict.noteLabel}</strong> {inquiry.note}
            </div>
          )}

          {((isFirstParty && inquiry.firstPartyResponse === null) ||
            (isSecondParty && inquiry.secondPartyResponse === null)) && (
            <div className="flex gap-2 mt-4">
              <Button
                onClick={() => onRespond(inquiry.id, true)}
                className="flex-1 bg-green-600 hover:bg-green-700"
              >
                <CheckCircle
                  className={cn('h-4 w-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />{' '}
                {dict.buttons.available}
              </Button>
              <Button
                onClick={() => onRespond(inquiry.id, false)}
                variant="outline"
                className="flex-1"
              >
                <XCircle
                  className={cn('h-4 w-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />{' '}
                {dict.buttons.unavailable}
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
--- End of Content for AvailabilityRequestCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MatchmakerChatPanel.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/MatchmakerChatPanel.tsx
'use client';

import React, {
  useState,
  useEffect,
  useCallback,
  useRef,
  useMemo,
} from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  MessageCircle,
  Loader2,
  ChevronLeft,
  ChevronRight,
  ChevronDown,
  ChevronUp,
  Users,
  Inbox,
  Clock,
  Send,
  Search,
  X,
} from 'lucide-react';
import { cn, getInitials } from '@/lib/utils';
import { format, isToday, isYesterday } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import { toast } from 'sonner';
import SuggestionChatTab from '../matchmaker/suggestions/details/SuggestionChatTab';
import type { Locale } from '../../../i18n-config';

// ==========================================
// Types
// ==========================================

interface PartyInfo {
  id: string;
  name: string;
  lastMessage?: string;
  lastMessageTime?: string;
  lastMessageSenderType?: 'user' | 'matchmaker' | 'system';
  unreadCount: number;
}

interface SuggestionChatSummary {
  suggestionId: string;
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  status: string;
  totalUnread: number;
}

interface DirectChatSummary {
  userId: string;
  name: string;
  lastMessage?: string;
  lastMessageTime?: string;
  lastMessageIsMine?: boolean;
  unreadCount: number;
}

interface ChatMessage {
  id: string;
  content: string;
  senderType: 'user' | 'matchmaker' | 'system';
  senderId: string;
  createdAt: string;
}

interface SelectedChat {
  suggestionId: string;
  partyId: string;
  partyName: string;
  isFirstParty: boolean;
  isDirect?: boolean;
  directUserId?: string;
}

interface MatchmakerChatPanelProps {
  locale: Locale;
}

// ==========================================
// Helpers
// ==========================================

function formatTime(dateStr: string | undefined, locale: Locale) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const loc = locale === 'he' ? he : enUS;
  if (isToday(date)) return format(date, 'HH:mm', { locale: loc });
  if (isYesterday(date)) return locale === 'he' ? 'אתמול' : 'Yesterday';
  return format(date, 'dd/MM', { locale: loc });
}

function truncate(text: string, maxLen: number) {
  if (text.length <= maxLen) return text;
  return text.slice(0, maxLen) + '…';
}

/** Highlight matching text segments */
function HighlightText({
  text,
  highlight,
}: {
  text: string;
  highlight: string;
}) {
  if (!highlight.trim()) return <>{text}</>;
  const regex = new RegExp(
    `(${highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`,
    'gi'
  );
  const parts = text.split(regex);
  return (
    <>
      {parts.map((part, i) =>
        regex.test(part) ? (
          <mark
            key={i}
            className="bg-amber-200/70 text-inherit rounded-sm px-0.5"
          >
            {part}
          </mark>
        ) : (
          <span key={i}>{part}</span>
        )
      )}
    </>
  );
}

// ==========================================
// DirectChatView Sub-Component
// ==========================================

function DirectChatView({
  userId,
  userName,
  locale,
  onBack,
}: {
  userId: string;
  userName: string;
  locale: Locale;
  onBack: () => void;
}) {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);
  const isHe = locale === 'he';

  const loadMessages = useCallback(async () => {
    try {
      const res = await fetch(`/api/matchmaker/direct-chats/${userId}`);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      if (data.success) setMessages(data.messages || []);
    } catch (error) {
      console.error('Error loading direct messages:', error);
    } finally {
      setIsLoading(false);
    }
  }, [userId]);

  useEffect(() => {
    loadMessages();
    fetch(`/api/matchmaker/direct-chats/${userId}`, { method: 'PATCH' }).catch(
      console.error
    );
    const interval = setInterval(loadMessages, 12000);
    return () => clearInterval(interval);
  }, [loadMessages, userId]);

  useEffect(() => {
    if (scrollRef.current)
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages]);

  const handleSend = async () => {
    if (!newMessage.trim() || isSending) return;
    setIsSending(true);
    try {
      const res = await fetch(`/api/matchmaker/direct-chats/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: newMessage.trim() }),
      });
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      if (data.success && data.message) {
        setMessages((prev) => [...prev, data.message]);
        setNewMessage('');
      }
    } catch {
      toast.error(isHe ? 'שגיאה בשליחה' : 'Send error');
    } finally {
      setIsSending(false);
    }
  };

  return (
    <Card className="shadow-lg border-0 overflow-hidden bg-white">
      <CardHeader className="bg-gradient-to-r from-purple-50 to-pink-50/40 border-b py-3">
        <div className="flex items-center gap-3">
          <Button
            variant="ghost"
            size="sm"
            onClick={onBack}
            className="gap-1 text-gray-600 hover:text-gray-900 hover:bg-purple-50"
          >
            <ChevronLeft className="w-4 h-4 rtl:-scale-x-100" />
            {isHe ? 'חזרה' : 'Back'}
          </Button>
          <div className="h-6 w-px bg-gray-200" />
          <div className="flex items-center gap-2.5">
            <Avatar className="w-9 h-9 shadow-sm ring-2 ring-white">
              <AvatarFallback className="bg-gradient-to-br from-purple-400 to-pink-500 text-white text-xs font-bold">
                {getInitials(userName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-semibold text-gray-800 text-sm">{userName}</p>
              <p className="text-xs text-gray-500">
                {isHe ? 'שיחה כללית' : 'General Chat'}
              </p>
            </div>
          </div>
        </div>
      </CardHeader>
      <CardContent className="p-0 flex flex-col h-[500px]">
        {isLoading ? (
          <div className="flex-1 flex items-center justify-center">
            <Loader2 className="w-6 h-6 animate-spin text-purple-500" />
          </div>
        ) : (
          <>
            <div
              ref={scrollRef}
              className="flex-1 overflow-y-auto p-4 space-y-3"
            >
              {messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-center">
                  <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-50 to-pink-50 flex items-center justify-center mb-3">
                    <MessageCircle className="w-7 h-7 text-purple-300" />
                  </div>
                  <p className="text-sm text-gray-500">
                    {isHe
                      ? 'אין הודעות עדיין. שלח/י הודעה ראשונה!'
                      : 'No messages yet. Send the first message!'}
                  </p>
                </div>
              ) : (
                messages.map((msg) => {
                  const isMine = msg.senderType === 'matchmaker';
                  return (
                    <div
                      key={msg.id}
                      className={cn(
                        'flex',
                        isMine ? 'justify-end' : 'justify-start'
                      )}
                    >
                      <div
                        className={cn(
                          'max-w-[75%] rounded-2xl px-4 py-2.5 shadow-sm',
                          isMine
                            ? 'bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-br-md'
                            : 'bg-white border border-gray-200 text-gray-800 rounded-bl-md'
                        )}
                      >
                        <p className="text-sm whitespace-pre-wrap leading-relaxed">
                          {msg.content}
                        </p>
                        <p
                          className={cn(
                            'text-[10px] mt-1',
                            isMine ? 'text-purple-200' : 'text-gray-400'
                          )}
                        >
                          {formatTime(msg.createdAt, locale)}
                        </p>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
            <div className="border-t bg-gray-50/50 p-3">
              <div className="flex items-center gap-2">
                <input
                  type="text"
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSend();
                    }
                  }}
                  placeholder={isHe ? 'כתוב/י הודעה...' : 'Type a message...'}
                  className="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-300 focus:border-transparent"
                  dir={isHe ? 'rtl' : 'ltr'}
                />
                <Button
                  size="sm"
                  onClick={handleSend}
                  disabled={!newMessage.trim() || isSending}
                  className="rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-4 h-10 shadow-sm"
                >
                  {isSending ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Send className="w-4 h-4 rtl:-scale-x-100" />
                  )}
                </Button>
              </div>
            </div>
          </>
        )}
      </CardContent>
    </Card>
  );
}

// ==========================================
// Main Component
// ==========================================

export default function MatchmakerChatPanel({
  locale,
}: MatchmakerChatPanelProps) {
  const [chatSummaries, setChatSummaries] = useState<SuggestionChatSummary[]>(
    []
  );
  const [directChats, setDirectChats] = useState<DirectChatSummary[]>([]);
  const [expandedSuggestions, setExpandedSuggestions] = useState<Set<string>>(
    new Set()
  );
  const [selectedChat, setSelectedChat] = useState<SelectedChat | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // ====== SEARCH STATE ======
  const [searchQuery, setSearchQuery] = useState('');
  const [isSearchFocused, setIsSearchFocused] = useState(false);
  const searchInputRef = useRef<HTMLInputElement>(null);

  const isHe = locale === 'he';

  // ==========================================
  // Load data
  // ==========================================

  const loadChatSummaries = useCallback(async () => {
    try {
      const [suggestionsRes, unreadRes, directRes] = await Promise.all([
        fetch('/api/matchmaker/suggestions'),
        fetch('/api/matchmaker/chat/unread'),
        fetch('/api/matchmaker/direct-chats'),
      ]);

      if (!suggestionsRes.ok) throw new Error('Failed to fetch suggestions');

      const suggestions = await suggestionsRes.json();
      let unreadData: { bySuggestion?: Record<string, number> } = {};
      if (unreadRes.ok) {
        unreadData = await unreadRes.json();
      }
      const unreadMap = unreadData.bySuggestion || {};

      if (directRes.ok) {
        const directData = await directRes.json();
        if (directData.success) {
          setDirectChats(directData.chats || []);
        }
      }

      const summaries: SuggestionChatSummary[] = suggestions
        .filter((s: { category: string }) => s.category !== 'HISTORY')
        .map(
          (s: {
            id: string;
            status: string;
            firstParty: { id: string; firstName: string; lastName: string };
            secondParty: { id: string; firstName: string; lastName: string };
          }) => ({
            suggestionId: s.id,
            firstParty: {
              id: s.firstParty.id,
              name: `${s.firstParty.firstName} ${s.firstParty.lastName}`,
              unreadCount: 0,
            },
            secondParty: {
              id: s.secondParty.id,
              name: `${s.secondParty.firstName} ${s.secondParty.lastName}`,
              unreadCount: 0,
            },
            status: s.status,
            totalUnread: unreadMap[s.id] || 0,
          })
        )
        .sort(
          (a: SuggestionChatSummary, b: SuggestionChatSummary) =>
            b.totalUnread - a.totalUnread
        );

      setChatSummaries(summaries);

      // Only auto-expand unread when NOT searching
      if (!searchQuery.trim()) {
        const withUnread = summaries
          .filter((s: SuggestionChatSummary) => s.totalUnread > 0)
          .map((s: SuggestionChatSummary) => s.suggestionId);
        setExpandedSuggestions(new Set(withUnread));
      }

      for (const summary of summaries) {
        fetchLastMessagesForSummary(summary, suggestions);
      }
    } catch (error) {
      console.error('Error loading chat summaries:', error);
    } finally {
      setIsLoading(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const fetchLastMessagesForSummary = async (
    summary: SuggestionChatSummary,
    allSuggestions: Array<{
      id: string;
      firstParty: { id: string };
      secondParty: { id: string };
    }>
  ) => {
    try {
      const res = await fetch(
        `/api/matchmaker/suggestions/${summary.suggestionId}/chat`
      );
      if (!res.ok) return;
      const data = await res.json();
      if (!data.success || !data.messages?.length) return;

      const msgs = data.messages as Array<{
        content: string;
        createdAt: string;
        senderType: 'user' | 'matchmaker' | 'system';
        senderId: string;
        targetUserId?: string | null;
      }>;
      const suggestion = allSuggestions.find(
        (s) => s.id === summary.suggestionId
      );
      if (!suggestion) return;

      const firstId = suggestion.firstParty.id;
      const secondId = suggestion.secondParty.id;

      const firstMsgs = msgs.filter(
        (m) =>
          (m.senderType === 'user' && m.senderId === firstId) ||
          (m.senderType === 'matchmaker' &&
            (m.targetUserId === firstId || !m.targetUserId))
      );
      const secondMsgs = msgs.filter(
        (m) =>
          (m.senderType === 'user' && m.senderId === secondId) ||
          (m.senderType === 'matchmaker' &&
            (m.targetUserId === secondId || !m.targetUserId))
      );

      const lastFirst = firstMsgs[firstMsgs.length - 1];
      const lastSecond = secondMsgs[secondMsgs.length - 1];

      setChatSummaries((prev) =>
        prev.map((s) =>
          s.suggestionId === summary.suggestionId
            ? {
                ...s,
                firstParty: {
                  ...s.firstParty,
                  lastMessage: lastFirst?.content,
                  lastMessageTime: lastFirst?.createdAt,
                  lastMessageSenderType: lastFirst?.senderType,
                },
                secondParty: {
                  ...s.secondParty,
                  lastMessage: lastSecond?.content,
                  lastMessageTime: lastSecond?.createdAt,
                  lastMessageSenderType: lastSecond?.senderType,
                },
              }
            : s
        )
      );
    } catch {
      /* silent */
    }
  };

  useEffect(() => {
    loadChatSummaries();
    const interval = setInterval(loadChatSummaries, 30000);
    return () => clearInterval(interval);
  }, [loadChatSummaries]);

  // ==========================================
  // Filtered data (search)
  // ==========================================

  const normalizedQuery = searchQuery.trim().toLowerCase();

  const filteredSummaries = useMemo(() => {
    if (!normalizedQuery) return chatSummaries;
    return chatSummaries.filter(
      (s) =>
        s.firstParty.name.toLowerCase().includes(normalizedQuery) ||
        s.secondParty.name.toLowerCase().includes(normalizedQuery)
    );
  }, [chatSummaries, normalizedQuery]);

  const filteredDirectChats = useMemo(() => {
    if (!normalizedQuery) return directChats;
    return directChats.filter((dc) =>
      dc.name.toLowerCase().includes(normalizedQuery)
    );
  }, [directChats, normalizedQuery]);

  // Auto-expand all matching suggestions when searching
  useEffect(() => {
    if (normalizedQuery) {
      const matchingIds = filteredSummaries.map((s) => s.suggestionId);
      setExpandedSuggestions(new Set(matchingIds));
    }
    // When clearing search, revert to showing only unread expanded
    if (!normalizedQuery && chatSummaries.length > 0) {
      const withUnread = chatSummaries
        .filter((s) => s.totalUnread > 0)
        .map((s) => s.suggestionId);
      setExpandedSuggestions(new Set(withUnread));
    }
  }, [normalizedQuery, filteredSummaries, chatSummaries]);

  // ==========================================
  // Handlers
  // ==========================================

  const toggleExpand = (suggestionId: string) => {
    setExpandedSuggestions((prev) => {
      const next = new Set(prev);
      if (next.has(suggestionId)) {
        next.delete(suggestionId);
      } else {
        next.add(suggestionId);
      }
      return next;
    });
  };

  const openChat = (
    suggestionId: string,
    partyId: string,
    partyName: string,
    isFirstParty: boolean
  ) => {
    setSelectedChat({ suggestionId, partyId, partyName, isFirstParty });
  };

  const closeChat = () => {
    setSelectedChat(null);
    loadChatSummaries();
  };

  const clearSearch = () => {
    setSearchQuery('');
    searchInputRef.current?.focus();
  };

  // ==========================================
  // Helpers
  // ==========================================

  const totalUnread =
    chatSummaries.reduce((sum, s) => sum + s.totalUnread, 0) +
    directChats.reduce((sum, dc) => sum + dc.unreadCount, 0);

  const getStatusLabel = (status: string) => {
    const labels: Record<string, { he: string; en: string; color: string }> = {
      PENDING_FIRST_PARTY: {
        he: "ממתין לצד א'",
        en: 'Pending Party A',
        color: 'bg-amber-50 text-amber-700 border-amber-200',
      },
      PENDING_SECOND_PARTY: {
        he: "ממתין לצד ב'",
        en: 'Pending Party B',
        color: 'bg-teal-50 text-teal-700 border-teal-200',
      },
      FIRST_PARTY_APPROVED: {
        he: "צד א' אישר/ה",
        en: 'Party A Approved',
        color: 'bg-green-50 text-green-700 border-green-200',
      },
      SECOND_PARTY_APPROVED: {
        he: "צד ב' אישר/ה",
        en: 'Party B Approved',
        color: 'bg-green-50 text-green-700 border-green-200',
      },
      CONTACT_DETAILS_SHARED: {
        he: 'פרטי קשר נשלחו',
        en: 'Details Shared',
        color: 'bg-teal-50 text-teal-700 border-teal-200',
      },
      DATING: {
        he: 'בדייט',
        en: 'Dating',
        color: 'bg-amber-50 text-amber-700 border-amber-200',
      },
    };
    const info = labels[status] || {
      he: status,
      en: status,
      color: 'bg-gray-100 text-gray-700',
    };
    return { label: isHe ? info.he : info.en, color: info.color };
  };

  // ==========================================
  // Render - Chat View
  // ==========================================

  if (selectedChat) {
    if (selectedChat.isDirect) {
      return (
        <DirectChatView
          userId={selectedChat.directUserId!}
          userName={selectedChat.partyName}
          locale={locale}
          onBack={closeChat}
        />
      );
    }

    return (
      <Card className="shadow-lg border-0 overflow-hidden bg-white">
        <CardHeader className="bg-gradient-to-r from-teal-50 to-amber-50/40 border-b py-3">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="sm"
              onClick={closeChat}
              className="gap-1 text-gray-600 hover:text-gray-900 hover:bg-teal-50"
            >
              <ChevronLeft className="w-4 h-4 rtl:-scale-x-100" />
              {isHe ? 'חזרה' : 'Back'}
            </Button>
            <div className="h-6 w-px bg-gray-200" />
            <div className="flex items-center gap-2.5">
              <Avatar className="w-9 h-9 shadow-sm ring-2 ring-white">
                <AvatarFallback
                  className={cn(
                    'text-white text-xs font-bold bg-gradient-to-br',
                    selectedChat.isFirstParty
                      ? 'from-teal-400 to-cyan-500'
                      : 'from-amber-400 to-orange-500'
                  )}
                >
                  {getInitials(selectedChat.partyName)}
                </AvatarFallback>
              </Avatar>
              <div>
                <p className="font-semibold text-gray-800 text-sm">
                  {selectedChat.partyName}
                </p>
                <p className="text-xs text-gray-500">
                  {selectedChat.isFirstParty
                    ? isHe
                      ? "צד א'"
                      : 'Party A'
                    : isHe
                      ? "צד ב'"
                      : 'Party B'}
                </p>
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="p-0">
          <SuggestionChatTab
            suggestionId={selectedChat.suggestionId}
            locale={locale}
            defaultParty={selectedChat.isFirstParty ? 'first' : 'second'}
            hidePartyTabs={true}
          />
        </CardContent>
      </Card>
    );
  }

  // ==========================================
  // Render - List View
  // ==========================================

  if (isLoading) {
    return (
      <Card className="shadow-lg border-0 bg-white/80">
        <CardContent className="flex items-center justify-center h-64">
          <Loader2 className="w-6 h-6 animate-spin text-teal-500" />
        </CardContent>
      </Card>
    );
  }

  const hasResults =
    filteredSummaries.length > 0 || filteredDirectChats.length > 0;
  const isSearching = normalizedQuery.length > 0;

  return (
    <Card className="shadow-lg border-0 overflow-hidden bg-white/80 backdrop-blur-sm">
      <CardHeader className="bg-gradient-to-r from-teal-50 to-amber-50/40 border-b pb-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 text-white shadow-md">
              <MessageCircle className="w-5 h-5" />
            </div>
            <div>
              <CardTitle className="text-lg">
                {isHe ? "צ'אט עם מועמדים" : 'Chat with Candidates'}
              </CardTitle>
              <p className="text-sm text-gray-500">
                {isHe ? 'בחר/י מועמד/ת לשיחה' : 'Select a candidate to chat'}
              </p>
            </div>
          </div>
          {totalUnread > 0 && (
            <Badge className="bg-amber-500 text-white border-0 px-3 py-1 text-sm shadow-sm">
              {totalUnread} {isHe ? 'חדשות' : 'new'}
            </Badge>
          )}
        </div>

        {/* ====== SEARCH BAR ====== */}
        <div className="mt-3">
          <div className="relative">
            <Search
              className={cn(
                'absolute top-1/2 -translate-y-1/2 w-4 h-4 transition-colors',
                isSearchFocused ? 'text-teal-500' : 'text-gray-400',
                isHe ? 'right-3' : 'left-3'
              )}
            />
            <input
              ref={searchInputRef}
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onFocus={() => setIsSearchFocused(true)}
              onBlur={() => setIsSearchFocused(false)}
              placeholder={
                isHe ? 'חיפוש מועמד/ת לפי שם...' : 'Search candidate by name...'
              }
              className={cn(
                'w-full py-2.5 rounded-xl border bg-white text-sm transition-all duration-200',
                'focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-teal-400',
                'placeholder:text-gray-400',
                isHe ? 'pr-10 pl-10' : 'pl-10 pr-10',
                isSearchFocused
                  ? 'border-teal-300 shadow-sm'
                  : 'border-gray-200'
              )}
              dir={isHe ? 'rtl' : 'ltr'}
            />
            {/* Clear button */}
            {searchQuery && (
              <button
                onClick={clearSearch}
                className={cn(
                  'absolute top-1/2 -translate-y-1/2 p-1 rounded-full hover:bg-gray-100 transition-colors',
                  isHe ? 'left-2' : 'right-2'
                )}
              >
                <X className="w-4 h-4 text-gray-400 hover:text-gray-600" />
              </button>
            )}
          </div>

          {/* Search result count */}
          {isSearching && (
            <div className="flex items-center gap-2 mt-2 px-1">
              <Badge
                variant="outline"
                className={cn(
                  'text-xs font-medium',
                  hasResults
                    ? 'border-teal-200 text-teal-700 bg-teal-50/50'
                    : 'border-gray-200 text-gray-500'
                )}
              >
                <Search className="w-3 h-3 me-1" />
                {hasResults
                  ? isHe
                    ? `נמצאו ${filteredSummaries.length} הצעות ו-${filteredDirectChats.length} שיחות ישירות`
                    : `Found ${filteredSummaries.length} suggestions & ${filteredDirectChats.length} direct chats`
                  : isHe
                    ? 'לא נמצאו תוצאות'
                    : 'No results found'}
              </Badge>
            </div>
          )}
        </div>
      </CardHeader>

      <CardContent className="p-0">
        <ScrollArea className="h-[600px]">
          {!hasResults ? (
            <div className="flex flex-col items-center justify-center h-full py-12 text-center px-4">
              <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-50 to-amber-50 flex items-center justify-center mb-4">
                {isSearching ? (
                  <Search className="w-8 h-8 text-gray-300" />
                ) : (
                  <Inbox className="w-8 h-8 text-gray-300" />
                )}
              </div>
              <p className="text-sm font-medium text-gray-600 mb-1">
                {isSearching
                  ? isHe
                    ? `לא נמצאו תוצאות עבור "${searchQuery}"`
                    : `No results for "${searchQuery}"`
                  : isHe
                    ? 'אין הצעות פעילות כרגע'
                    : 'No active suggestions'}
              </p>
              {isSearching && (
                <p className="text-xs text-gray-400">
                  {isHe
                    ? 'נסה/י לחפש שם אחר או לנקות את החיפוש'
                    : 'Try a different name or clear the search'}
                </p>
              )}
            </div>
          ) : (
            <div className="divide-y divide-gray-100">
              {/* ======== Direct Chats Section ======== */}
              {filteredDirectChats.length > 0 && (
                <>
                  <div className="px-5 py-2.5 bg-purple-50/50 border-b">
                    <p className="text-xs font-semibold text-purple-600 uppercase tracking-wider">
                      {isHe ? 'שיחות כלליות' : 'General Chats'}
                      {isSearching && (
                        <span className="text-purple-400 font-normal ms-1">
                          ({filteredDirectChats.length})
                        </span>
                      )}
                    </p>
                  </div>
                  {filteredDirectChats.map((dc) => (
                    <button
                      key={dc.userId}
                      onClick={() =>
                        setSelectedChat({
                          suggestionId: '',
                          partyId: dc.userId,
                          partyName: dc.name,
                          isFirstParty: false,
                          isDirect: true,
                          directUserId: dc.userId,
                        })
                      }
                      className="w-full px-5 py-3.5 flex items-center gap-3 hover:bg-purple-50/40 transition-colors text-start border-b border-gray-100"
                    >
                      <Avatar className="w-11 h-11 shadow-sm ring-2 ring-white">
                        <AvatarFallback className="bg-gradient-to-br from-purple-400 to-pink-500 text-white text-xs font-bold">
                          {getInitials(dc.name)}
                        </AvatarFallback>
                      </Avatar>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between mb-0.5">
                          <p className="font-medium text-gray-800 text-sm">
                            <HighlightText
                              text={dc.name}
                              highlight={searchQuery}
                            />
                          </p>
                          {dc.lastMessageTime && (
                            <span className="text-[10px] text-gray-400">
                              {formatTime(dc.lastMessageTime, locale)}
                            </span>
                          )}
                        </div>
                        {dc.lastMessage ? (
                          <p className="text-xs text-gray-500 truncate">
                            {dc.lastMessageIsMine && (
                              <span className="text-purple-600 font-medium">
                                {isHe ? 'את/ה: ' : 'You: '}
                              </span>
                            )}
                            {truncate(dc.lastMessage, 50)}
                          </p>
                        ) : (
                          <p className="text-xs text-gray-400 italic">
                            {isHe ? 'לחץ/י לפתיחת שיחה' : 'Click to open chat'}
                          </p>
                        )}
                      </div>
                      {dc.unreadCount > 0 && (
                        <Badge className="bg-purple-500 text-white text-xs px-2 py-0.5 border-0 shadow-sm animate-pulse">
                          {dc.unreadCount}
                        </Badge>
                      )}
                    </button>
                  ))}
                  {filteredSummaries.length > 0 && (
                    <div className="px-5 py-2.5 bg-teal-50/50 border-b">
                      <p className="text-xs font-semibold text-teal-600 uppercase tracking-wider">
                        {isHe ? 'שיחות לפי הצעה' : 'Suggestion Chats'}
                        {isSearching && (
                          <span className="text-teal-400 font-normal ms-1">
                            ({filteredSummaries.length})
                          </span>
                        )}
                      </p>
                    </div>
                  )}
                </>
              )}

              {/* Show section header even when no direct chats but searching */}
              {filteredDirectChats.length === 0 &&
                filteredSummaries.length > 0 &&
                isSearching && (
                  <div className="px-5 py-2.5 bg-teal-50/50 border-b">
                    <p className="text-xs font-semibold text-teal-600 uppercase tracking-wider">
                      {isHe ? 'שיחות לפי הצעה' : 'Suggestion Chats'}
                      <span className="text-teal-400 font-normal ms-1">
                        ({filteredSummaries.length})
                      </span>
                    </p>
                  </div>
                )}

              {/* ======== Suggestion Chats Section ======== */}
              {filteredSummaries.map((summary) => {
                const isExpanded = expandedSuggestions.has(
                  summary.suggestionId
                );
                const statusInfo = getStatusLabel(summary.status);

                // Determine which party matches the search (for visual hint)
                const firstMatches =
                  isSearching &&
                  summary.firstParty.name
                    .toLowerCase()
                    .includes(normalizedQuery);
                const secondMatches =
                  isSearching &&
                  summary.secondParty.name
                    .toLowerCase()
                    .includes(normalizedQuery);

                return (
                  <div key={summary.suggestionId}>
                    {/* Suggestion Header */}
                    <button
                      onClick={() => toggleExpand(summary.suggestionId)}
                      className={cn(
                        'w-full px-5 py-3.5 flex items-center justify-between hover:bg-gray-50/80 transition-colors text-start',
                        summary.totalUnread > 0 && 'bg-teal-50/30',
                        isSearching && 'bg-teal-50/20'
                      )}
                    >
                      <div className="flex items-center gap-3">
                        <div className="relative flex-shrink-0">
                          <Avatar
                            className={cn(
                              'w-11 h-11 shadow-sm ring-2',
                              firstMatches ? 'ring-amber-300' : 'ring-white'
                            )}
                          >
                            <AvatarFallback className="bg-gradient-to-br from-teal-400 to-cyan-500 text-white text-xs font-bold">
                              {getInitials(summary.firstParty.name)}
                            </AvatarFallback>
                          </Avatar>
                          <Avatar
                            className={cn(
                              'w-7 h-7 absolute -bottom-0.5 -end-2 shadow-sm ring-2',
                              secondMatches ? 'ring-amber-300' : 'ring-white'
                            )}
                          >
                            <AvatarFallback className="bg-gradient-to-br from-amber-400 to-orange-500 text-white text-[9px] font-bold">
                              {getInitials(summary.secondParty.name)}
                            </AvatarFallback>
                          </Avatar>
                        </div>

                        <div>
                          <p className="font-semibold text-gray-800 text-sm">
                            <HighlightText
                              text={summary.firstParty.name.split(' ')[0]}
                              highlight={searchQuery}
                            />
                            {' & '}
                            <HighlightText
                              text={summary.secondParty.name.split(' ')[0]}
                              highlight={searchQuery}
                            />
                          </p>
                          <Badge
                            variant="outline"
                            className={cn(
                              'text-[10px] px-1.5 py-0 mt-0.5 border',
                              statusInfo.color
                            )}
                          >
                            {statusInfo.label}
                          </Badge>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        {summary.totalUnread > 0 && (
                          <Badge className="bg-amber-500 text-white text-xs px-2 py-0.5 border-0 shadow-sm animate-pulse">
                            {summary.totalUnread}
                          </Badge>
                        )}
                        {isExpanded ? (
                          <ChevronUp className="w-4 h-4 text-gray-400" />
                        ) : (
                          <ChevronDown className="w-4 h-4 text-gray-400" />
                        )}
                      </div>
                    </button>

                    {/* Expanded: Party Cards */}
                    {isExpanded && (
                      <div className="px-5 pb-4 pt-1 space-y-2 bg-gray-50/50">
                        {/* First Party */}
                        <button
                          onClick={() =>
                            openChat(
                              summary.suggestionId,
                              summary.firstParty.id,
                              summary.firstParty.name,
                              true
                            )
                          }
                          className={cn(
                            'w-full p-3 rounded-xl bg-white border hover:border-teal-300 hover:bg-teal-50/40 transition-all flex items-center gap-3 shadow-sm text-start',
                            firstMatches
                              ? 'border-amber-300 bg-amber-50/20'
                              : 'border-gray-200'
                          )}
                        >
                          <Avatar className="w-10 h-10 shadow-sm flex-shrink-0">
                            <AvatarFallback className="bg-gradient-to-br from-teal-400 to-cyan-500 text-white text-sm font-bold">
                              {getInitials(summary.firstParty.name)}
                            </AvatarFallback>
                          </Avatar>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-0.5">
                              <p className="font-medium text-gray-800 text-sm">
                                <HighlightText
                                  text={summary.firstParty.name}
                                  highlight={searchQuery}
                                />
                              </p>
                              <div className="flex items-center gap-1.5">
                                {summary.firstParty.lastMessageTime && (
                                  <span className="text-[10px] text-gray-400 flex items-center gap-0.5">
                                    <Clock className="w-3 h-3" />
                                    {formatTime(
                                      summary.firstParty.lastMessageTime,
                                      locale
                                    )}
                                  </span>
                                )}
                                <Badge
                                  variant="outline"
                                  className="text-[10px] border-teal-200 text-teal-700 px-1.5 py-0"
                                >
                                  {isHe ? "צד א'" : 'Party A'}
                                </Badge>
                              </div>
                            </div>
                            {summary.firstParty.lastMessage ? (
                              <p className="text-xs text-gray-500 truncate">
                                {summary.firstParty.lastMessageSenderType ===
                                  'matchmaker' && (
                                  <span className="text-teal-600 font-medium">
                                    {isHe ? 'את/ה: ' : 'You: '}
                                  </span>
                                )}
                                {truncate(summary.firstParty.lastMessage, 50)}
                              </p>
                            ) : (
                              <p className="text-xs text-gray-400 italic">
                                {isHe
                                  ? 'לחץ/י לפתיחת שיחה'
                                  : 'Click to open chat'}
                              </p>
                            )}
                          </div>
                          <ChevronRight className="w-4 h-4 text-gray-300 flex-shrink-0 rtl:-scale-x-100" />
                        </button>

                        {/* Second Party */}
                        <button
                          onClick={() =>
                            openChat(
                              summary.suggestionId,
                              summary.secondParty.id,
                              summary.secondParty.name,
                              false
                            )
                          }
                          className={cn(
                            'w-full p-3 rounded-xl bg-white border hover:border-amber-300 hover:bg-amber-50/40 transition-all flex items-center gap-3 shadow-sm text-start',
                            secondMatches
                              ? 'border-amber-300 bg-amber-50/20'
                              : 'border-gray-200'
                          )}
                        >
                          <Avatar className="w-10 h-10 shadow-sm flex-shrink-0">
                            <AvatarFallback className="bg-gradient-to-br from-amber-400 to-orange-500 text-white text-sm font-bold">
                              {getInitials(summary.secondParty.name)}
                            </AvatarFallback>
                          </Avatar>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-0.5">
                              <p className="font-medium text-gray-800 text-sm">
                                <HighlightText
                                  text={summary.secondParty.name}
                                  highlight={searchQuery}
                                />
                              </p>
                              <div className="flex items-center gap-1.5">
                                {summary.secondParty.lastMessageTime && (
                                  <span className="text-[10px] text-gray-400 flex items-center gap-0.5">
                                    <Clock className="w-3 h-3" />
                                    {formatTime(
                                      summary.secondParty.lastMessageTime,
                                      locale
                                    )}
                                  </span>
                                )}
                                <Badge
                                  variant="outline"
                                  className="text-[10px] border-amber-200 text-amber-700 px-1.5 py-0"
                                >
                                  {isHe ? "צד ב'" : 'Party B'}
                                </Badge>
                              </div>
                            </div>
                            {summary.secondParty.lastMessage ? (
                              <p className="text-xs text-gray-500 truncate">
                                {summary.secondParty.lastMessageSenderType ===
                                  'matchmaker' && (
                                  <span className="text-teal-600 font-medium">
                                    {isHe ? 'את/ה: ' : 'You: '}
                                  </span>
                                )}
                                {truncate(summary.secondParty.lastMessage, 50)}
                              </p>
                            ) : (
                              <p className="text-xs text-gray-400 italic">
                                {isHe
                                  ? 'לחץ/י לפתיחת שיחה'
                                  : 'Click to open chat'}
                              </p>
                            )}
                          </div>
                          <ChevronRight className="w-4 h-4 text-gray-300 flex-shrink-0 rtl:-scale-x-100" />
                        </button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </ScrollArea>
      </CardContent>
    </Card>
  );
}
--- End of Content for MatchmakerChatPanel.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MatchmakerUserSearchDialog.tsx
--------------------------------------------------------------------------------
Content:
// =============================================================================
// src/components/messages/MatchmakerUserSearchDialog.tsx
// =============================================================================
//
// Dialog for matchmaker to:
//   1. Search registered users
//   2. Select individuals or "Select All"
//   3. Write and broadcast a message
//
// Usage:
//   <MatchmakerUserSearchDialog
//     open={isOpen}
//     onClose={() => setIsOpen(false)}
//     onSent={() => { setIsOpen(false); refreshChats(); }}
//     locale={locale}
//   />
// =============================================================================

'use client';

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import {
  Search,
  Send,
  Loader2,
  Users,
  CheckCheck,
  X,
  UserSearch,
  Megaphone,
} from 'lucide-react';
import { cn, getInitials } from '@/lib/utils';
import type { Locale } from '../../../i18n-config';

// ==========================================
// Types
// ==========================================

interface SearchableUser {
  id: string;
  name: string;
  firstName: string;
  lastName: string;
  email: string;
  phone: string | null;
  gender?: string;
  city?: string;
  availabilityStatus?: string;
}

interface MatchmakerUserSearchDialogProps {
  open: boolean;
  onClose: () => void;
  onSent: () => void;
  locale: Locale;
}

// ==========================================
// Dictionary
// ==========================================

const dict = {
  he: {
    title: 'שליחת הודעה למועמדים',
    description: 'חפש/י מועמדים ושלח/י הודעה ישירה',
    searchPlaceholder: 'חיפוש לפי שם או מייל...',
    selectAll: 'בחר הכל',
    deselectAll: 'בטל בחירה',
    selectedCount: 'נבחרו',
    users: 'מועמדים',
    messagePlaceholder: 'כתוב/י הודעה לשליחה...',
    send: 'שלח הודעה',
    sending: 'שולח...',
    sendToSelected: 'שלח ל-{{count}} מועמדים',
    sendToAll: 'שלח לכל המועמדים',
    noResults: 'לא נמצאו תוצאות',
    noResultsHint: 'נסה/י חיפוש אחר',
    successSingle: 'ההודעה נשלחה בהצלחה!',
    successMultiple: 'ההודעה נשלחה ל-{{count}} מועמדים!',
    errorSend: 'שגיאה בשליחת ההודעה',
    errorEmpty: 'יש לבחור לפחות מועמד אחד ולכתוב הודעה',
    loading: 'טוען...',
    available: 'פנוי/ה',
    dating: 'בתהליך',
    city: 'עיר',
  },
  en: {
    title: 'Send Message to Candidates',
    description: 'Search for candidates and send a direct message',
    searchPlaceholder: 'Search by name or email...',
    selectAll: 'Select All',
    deselectAll: 'Deselect All',
    selectedCount: 'Selected',
    users: 'candidates',
    messagePlaceholder: 'Write a message to send...',
    send: 'Send Message',
    sending: 'Sending...',
    sendToSelected: 'Send to {{count}} candidates',
    sendToAll: 'Send to all candidates',
    noResults: 'No results found',
    noResultsHint: 'Try a different search term',
    successSingle: 'Message sent successfully!',
    successMultiple: 'Message sent to {{count}} candidates!',
    errorSend: 'Error sending message',
    errorEmpty: 'Select at least one candidate and write a message',
    loading: 'Loading...',
    available: 'Available',
    dating: 'In process',
    city: 'City',
  },
};

// ==========================================
// Component
// ==========================================

export default function MatchmakerUserSearchDialog({
  open,
  onClose,
  onSent,
  locale,
}: MatchmakerUserSearchDialogProps) {
  const t = dict[locale] || dict.he;
  const isHe = locale === 'he';

  const [searchQuery, setSearchQuery] = useState('');
  const [users, setUsers] = useState<SearchableUser[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [message, setMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [selectAllMode, setSelectAllMode] = useState(false);

  const searchTimeout = useRef<NodeJS.Timeout | null>(null);

  // ==========================================
  // Search users
  // ==========================================

  const searchUsers = useCallback(async (query: string) => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams({ q: query, limit: '100' });
      const res = await fetch(`/api/matchmaker/users/searchable?${params}`);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      if (data.success) {
        setUsers(data.users || []);
        setTotalCount(data.totalCount || 0);
      }
    } catch (error) {
      console.error('Search error:', error);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Debounced search
  useEffect(() => {
    if (!open) return;

    if (searchTimeout.current) clearTimeout(searchTimeout.current);
    searchTimeout.current = setTimeout(() => {
      searchUsers(searchQuery);
    }, 300);

    return () => {
      if (searchTimeout.current) clearTimeout(searchTimeout.current);
    };
  }, [searchQuery, open, searchUsers]);

  // Load all users on open
  useEffect(() => {
    if (open) {
      searchUsers('');
      setSelectedIds(new Set());
      setMessage('');
      setSelectAllMode(false);
    }
  }, [open, searchUsers]);

  // ==========================================
  // Selection handlers
  // ==========================================

  const toggleUser = (userId: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(userId)) {
        next.delete(userId);
        setSelectAllMode(false);
      } else {
        next.add(userId);
      }
      return next;
    });
  };

  const toggleSelectAll = () => {
    if (selectAllMode) {
      setSelectedIds(new Set());
      setSelectAllMode(false);
    } else {
      setSelectedIds(new Set(users.map((u) => u.id)));
      setSelectAllMode(true);
    }
  };

  // ==========================================
  // Send message
  // ==========================================

  const handleSend = async () => {
    if (selectedIds.size === 0 || !message.trim()) {
      toast.error(t.errorEmpty);
      return;
    }

    setIsSending(true);
    try {
      // If select-all mode and all visible users are selected, send to 'all'
      const sendToAll =
        selectAllMode && selectedIds.size === totalCount && searchQuery === '';

      const body = sendToAll
        ? { content: message.trim(), userIds: 'all' }
        : { content: message.trim(), userIds: Array.from(selectedIds) };

      const res = await fetch('/api/matchmaker/direct-chats/broadcast', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.error || 'Failed');
      }

      const data = await res.json();

      if (data.success) {
        const count = data.sentCount || selectedIds.size;
        if (count === 1) {
          toast.success(t.successSingle);
        } else {
          toast.success(t.successMultiple.replace('{{count}}', String(count)));
        }
        onSent();
      }
    } catch (error) {
      console.error('Broadcast error:', error);
      toast.error(t.errorSend);
    } finally {
      setIsSending(false);
    }
  };

  // ==========================================
  // Helpers
  // ==========================================

  const getAvailabilityBadge = (status?: string) => {
    if (status === 'AVAILABLE')
      return (
        <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-green-50 text-green-600 border border-green-200">
          {t.available}
        </span>
      );
    if (status === 'DATING')
      return (
        <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-600 border border-amber-200">
          {t.dating}
        </span>
      );
    return null;
  };

  // ==========================================
  // Render
  // ==========================================

  return (
    <Dialog open={open} onOpenChange={(isOpen) => !isOpen && onClose()}>
      <DialogContent
        className="max-w-2xl max-h-[85vh] flex flex-col p-0 gap-0"
        dir={isHe ? 'rtl' : 'ltr'}
      >
        {/* Header */}
        <DialogHeader className="px-6 pt-6 pb-4 border-b bg-gradient-to-r from-purple-50 to-pink-50/40">
          <div className="flex items-center gap-3">
            <div className="p-2.5 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-md">
              <Megaphone className="w-5 h-5" />
            </div>
            <div>
              <DialogTitle className="text-lg font-bold text-gray-800">
                {t.title}
              </DialogTitle>
              <DialogDescription className="text-sm text-gray-500">
                {t.description}
              </DialogDescription>
            </div>
          </div>
        </DialogHeader>

        {/* Search Bar */}
        <div className="px-6 py-3 border-b bg-gray-50/50">
          <div className="relative">
            <Search
              className={cn(
                'absolute top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400',
                isHe ? 'right-3' : 'left-3'
              )}
            />
            <Input
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder={t.searchPlaceholder}
              className={cn(
                'rounded-xl border-gray-200 focus:border-purple-300 focus:ring-purple-200',
                isHe ? 'pr-10' : 'pl-10'
              )}
              dir={isHe ? 'rtl' : 'ltr'}
            />
          </div>

          {/* Select All + Count */}
          <div className="flex items-center justify-between mt-3">
            <button
              onClick={toggleSelectAll}
              className="flex items-center gap-2 text-sm font-medium text-purple-600 hover:text-purple-700 transition-colors"
            >
              <Checkbox
                checked={selectAllMode}
                onCheckedChange={toggleSelectAll}
                className="border-purple-300 data-[state=checked]:bg-purple-500"
              />
              {selectAllMode ? t.deselectAll : t.selectAll}
            </button>

            <div className="flex items-center gap-2 text-sm text-gray-500">
              {selectedIds.size > 0 && (
                <Badge className="bg-purple-100 text-purple-700 border-purple-200 font-semibold">
                  {t.selectedCount}: {selectedIds.size}
                </Badge>
              )}
              <span>
                {totalCount} {t.users}
              </span>
            </div>
          </div>
        </div>

        {/* User List */}
        <ScrollArea className="flex-1 min-h-0 max-h-[300px]">
          {isLoading ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="w-6 h-6 animate-spin text-purple-500" />
              <span className="text-sm text-gray-500 ms-2">{t.loading}</span>
            </div>
          ) : users.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-center px-4">
              <UserSearch className="w-12 h-12 text-gray-300 mb-3" />
              <p className="text-sm font-medium text-gray-600">{t.noResults}</p>
              <p className="text-xs text-gray-400 mt-1">{t.noResultsHint}</p>
            </div>
          ) : (
            <div className="divide-y divide-gray-50">
              {users.map((user) => {
                const isSelected = selectedIds.has(user.id);
                return (
                  <button
                    key={user.id}
                    onClick={() => toggleUser(user.id)}
                    className={cn(
                      'w-full px-6 py-3 flex items-center gap-3 transition-colors text-start',
                      isSelected
                        ? 'bg-purple-50/60'
                        : 'hover:bg-gray-50/80'
                    )}
                  >
                    <Checkbox
                      checked={isSelected}
                      onCheckedChange={() => toggleUser(user.id)}
                      className="border-gray-300 data-[state=checked]:bg-purple-500 flex-shrink-0"
                    />

                    <Avatar className="w-9 h-9 shadow-sm flex-shrink-0">
                      <AvatarFallback
                        className={cn(
                          'text-white text-xs font-bold bg-gradient-to-br',
                          user.gender === 'MALE'
                            ? 'from-blue-400 to-indigo-500'
                            : 'from-pink-400 to-rose-500'
                        )}
                      >
                        {getInitials(user.name)}
                      </AvatarFallback>
                    </Avatar>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <p className="font-medium text-gray-800 text-sm truncate">
                          {user.name}
                        </p>
                        {getAvailabilityBadge(user.availabilityStatus)}
                      </div>
                      <div className="flex items-center gap-2 text-xs text-gray-400 mt-0.5">
                        {user.city && <span>{user.city}</span>}
                        {user.city && user.email && <span>·</span>}
                        <span className="truncate">{user.email}</span>
                      </div>
                    </div>

                    {isSelected && (
                      <CheckCheck className="w-4 h-4 text-purple-500 flex-shrink-0" />
                    )}
                  </button>
                );
              })}
            </div>
          )}
        </ScrollArea>

        {/* Message Input + Send */}
        <div className="border-t bg-gray-50/30 p-4 space-y-3">
          <Textarea
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            placeholder={t.messagePlaceholder}
            className="min-h-[80px] max-h-[120px] resize-none rounded-xl border-gray-200 focus:border-purple-300 focus:ring-purple-200"
            dir={isHe ? 'rtl' : 'ltr'}
            rows={3}
          />

          <div className="flex items-center justify-between">
            <Button
              variant="ghost"
              size="sm"
              onClick={onClose}
              className="text-gray-500"
            >
              <X className="w-4 h-4 me-1" />
              {isHe ? 'ביטול' : 'Cancel'}
            </Button>

            <Button
              onClick={handleSend}
              disabled={
                selectedIds.size === 0 || !message.trim() || isSending
              }
              className="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl shadow-md px-6"
            >
              {isSending ? (
                <>
                  <Loader2 className="w-4 h-4 animate-spin me-2" />
                  {t.sending}
                </>
              ) : (
                <>
                  <Send className={cn('w-4 h-4 me-2', isHe && '-scale-x-100')} />
                  {selectAllMode && searchQuery === ''
                    ? t.sendToAll
                    : selectedIds.size > 0
                      ? t.sendToSelected.replace(
                          '{{count}}',
                          String(selectedIds.size)
                        )
                      : t.send}
                </>
              )}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
--- End of Content for MatchmakerUserSearchDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/MessageList.tsx

import React from 'react';
import type { UnifiedMessage } from '@/types/messages';
import MessageListItem from './MessageListItem';
import { ScrollArea } from '@/components/ui/scroll-area';
import { useSession } from 'next-auth/react';
import type { MessagesPageDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';
// הוסף את ה-Hook של הנוטיפיקציות
import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';

interface MessageListProps {
  messages: UnifiedMessage[];
  selectedMessageId: string | null;
  onSelectMessage: (message: UnifiedMessage) => void;
  dict: MessagesPageDict;
  locale: Locale;
}

const MessageList: React.FC<MessageListProps> = ({
  messages,
  selectedMessageId,
  onSelectMessage,
  dict,
  locale,
}) => {
  const { data: session } = useSession();
  const userId = session?.user?.id;

  
  // שימוש בקונטקסט כדי לרענן את ה-badge
  const { refreshNotifications } = useNotifications();

  if (!userId) return null;

  // פונקציה שתטפל בלחיצה
  const handleMessageSelect = async (message: UnifiedMessage) => {
    // 1. קריאה לפונקציה המקורית שפותחת את ההודעה ב-UI
    onSelectMessage(message);

    // 2. אם ההודעה לא מסומנת כנקראה, נסמן אותה בשרת
      if (!message.isRead) {
      try {
        await fetch('/api/messages/mark-as-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            id: message.id, 
            type: message.type 
          }),
        });

        // 3. רענון הנוטיפיקציות כדי שה-Badge ב-Navbar יתעדכן
        refreshNotifications(); // פונקציה זו מגיעה מהקונטקסט
      } catch (error) {
        console.error('Failed to mark message as read', error);
      }
    }
  };

  return (
    <div className="bg-white h-full flex flex-col">
      <div className="p-4 border-b">
        <h2 className="text-xl font-bold text-gray-800">
          {dict.messageList.header}
        </h2>
        <p className="text-sm text-gray-500">
          {dict.messageList.subtitle.replace(
            '{{count}}',
            messages.length.toString()
          )}
        </p>
      </div>
      <ScrollArea className="flex-1">
        <div className="p-2 space-y-1">
          {messages.map((message) => (
            <MessageListItem
              key={message.id}
              message={message}
              isSelected={message.id === selectedMessageId}
              onSelect={() => handleMessageSelect(message)} // שימוש בפונקציה החדשה
              userId={userId}
              dict={dict.messageListItem}
              locale={locale}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  );
};

export default MessageList;
--- End of Content for MessageList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageListItem.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/MessageListItem.tsx

import React from 'react';
import Image from 'next/image';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import type { UnifiedMessage } from '@/types/messages';
import { CheckCircle, Zap, MessageCircle, Info, Heart } from 'lucide-react';
import type { MessageListItemDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface MessageListItemProps {
  message: UnifiedMessage;
  isSelected: boolean;
  onSelect: () => void;
  userId: string;
  dict: MessageListItemDict;
  locale: Locale;
}

// Komponent pomocniczy do wyboru ikony i koloru na podstawie typu wiadomości
const MessageIcon: React.FC<{ type: UnifiedMessage['type'] }> = ({ type }) => {
  switch (type) {
    case 'ACTION_REQUIRED':
      return <Zap className="w-3 h-3 text-orange-500 fill-current" />;
    case 'MATCHMAKER_MESSAGE':
    case 'INQUIRY_RESPONSE':
      return <MessageCircle className="w-3 h-3 text-blue-500 fill-current" />;
    case 'STATUS_UPDATE':
      return <Info className="w-3 h-3 text-cyan-500" />;
    case 'NEW_SUGGESTION':
      return <Heart className="w-3 h-3 text-pink-500 fill-current" />;
    default:
      return null;
  }
};

const MessageListItem: React.FC<MessageListItemProps> = ({
  message,
  isSelected,
  onSelect,
  userId,
  dict,
  locale,
}) => {
  // Jeśli nie ma payloadu lub sugestii, nie renderujemy elementu
  const suggestion = message.payload?.suggestion;
  if (!suggestion) return null;

  // Identyfikacja drugiej strony w sugestii
  const otherParty =
    suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty;
  if (!otherParty) return null; // Dodatkowe zabezpieczenie

  const isActionRequired = message.type === 'ACTION_REQUIRED';
  const mainImage = otherParty.images?.find((img) => img.isMain);

  return (
    <button
      onClick={onSelect}
      className={cn(
        'w-full p-3 rounded-xl transition-all duration-200 flex items-start gap-4',
        locale === 'he' ? 'text-right' : 'text-left',
        isSelected ? 'bg-cyan-50 border border-cyan-200' : 'hover:bg-gray-100'
      )}
    >
      {/* Sekcja awatara z ikoną */}
      <div className="relative flex-shrink-0">
        <Avatar className="w-12 h-12 border-2 border-white shadow-md">
          {mainImage?.url ? (
            <Image
              src={getRelativeCloudinaryPath(mainImage.url)}
              alt={otherParty.firstName}
              fill
              className="object-cover"
              sizes="48px"
            />
          ) : (
            <AvatarFallback
              className={cn(
                'font-bold text-white',
                isActionRequired
                  ? 'bg-gradient-to-br from-orange-500 to-amber-500'
                  : 'bg-gradient-to-br from-cyan-500 to-blue-500'
              )}
            >
              {getInitials(`${otherParty.firstName} ${otherParty.lastName}`)}
            </AvatarFallback>
          )}
        </Avatar>
        {/* Mała ikona wskazująca typ wiadomości */}
        <div
          className={cn(
            'absolute -bottom-1 p-1 bg-white rounded-full shadow-lg',
            locale === 'he' ? '-left-1' : '-right-1'
          )}
        >
          <MessageIcon type={message.type} />
        </div>
      </div>

      {/* Sekcja treści */}
      <div className="flex-1 min-w-0">
        <div className="flex justify-between items-center">
          <h3 className="font-bold text-gray-800 truncate">{message.title}</h3>
          <span className="text-xs text-gray-400 flex-shrink-0">
            {formatDistanceToNow(new Date(message.timestamp), {
              addSuffix: true,
              locale: locale === 'he' ? he : enUS,
            })}
          </span>
        </div>
        <p className="text-sm text-gray-600 truncate">{message.description}</p>

        {/* Specjalna odznaka "Dopasowanie!" */}
        {message.type === 'STATUS_UPDATE' &&
          suggestion.status === 'CONTACT_DETAILS_SHARED' && (
            <Badge className="mt-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 text-xs shadow-md">
              <CheckCircle
                className={cn('w-3 h-3', locale === 'he' ? 'ml-1' : 'mr-1')}
              />
              {dict.matchBadge}
            </Badge>
          )}
      </div>
    </button>
  );
};

export default MessageListItem;
--- End of Content for MessageListItem.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessagesPage.tsx
--------------------------------------------------------------------------------
Content:
// FILENAME: src/app/components/messages/MessagesPage.tsx

'use client';

import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';
import { useState, useEffect, useCallback } from 'react';
import { useSession } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { toast } from 'sonner';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Clock, CheckCircle, XCircle, Loader2, Users } from 'lucide-react';
// --- START OF FIX ---
// Changed 'ExtendedInquiry' to 'ExtendedAvailabilityInquiry' to match the updated types file
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
// --- END OF FIX ---
import { Session } from 'next-auth';

// This component is now specifically for the matchmaker's view of availability requests.
// The candidate's message center is handled by MessageList.tsx which uses the unified feed.

export default function MessagesPage() {
  const { data: session } = useSession() as { data: Session | null };
  const { refreshNotifications } = useNotifications();
  // --- START OF FIX ---
  // Updated the state type to use the new name
  const [inquiries, setInquiries] = useState<ExtendedAvailabilityInquiry[]>([]);
  // --- END OF FIX ---
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [filters, setFilters] = useState({
    status: 'pending',
    timeframe: 'all',
  });
  const [note, setNote] = useState('');

  const loadInquiries = useCallback(async () => {
    try {
      setLoading(true);
      const queryParams = new URLSearchParams({
        status: filters.status,
        timeframe: filters.timeframe,
      });

      // This API endpoint is specific to matchmakers fetching availability inquiries
      const response = await fetch(`/api/matchmaker/inquiries?${queryParams}`);
      if (!response.ok)
        throw new Error('Failed to load availability inquiries');
      const data = await response.json();
      setInquiries(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load inquiries');
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => {
    if (session?.user) {
      loadInquiries();
    }
  }, [session, loadInquiries]);

  const handleResponse = async (inquiryId: string, isAvailable: boolean) => {
    try {
      const response = await fetch(
        `/api/matchmaker/inquiries/${inquiryId}/respond`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isAvailable, note }),
        }
      );

      if (!response.ok) {
        throw new Error('Failed to submit response');
      }

      await loadInquiries();
      await refreshNotifications();
      setNote('');
      toast.success('תגובתך נשמרה בהצלחה!');
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'Failed to submit response';
      setError(errorMessage);
      toast.error(errorMessage);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  if (inquiries.length === 0) {
    return (
      <Card className="max-w-4xl mx-auto mt-8">
        <CardContent className="p-6 text-center">
          <Users className="w-12 h-12 mx-auto text-gray-400 mb-4" />
          <h3 className="text-lg font-medium">אין בקשות זמינות</h3>
          <p className="text-gray-500">
            כרגע אין בקשות לבדיקת זמינות הממתינות לך.
          </p>
        </CardContent>
      </Card>
    );
  }

  // The rest of the component's JSX remains the same as it correctly handles the logic
  // for displaying and responding to Availability Inquiries.
  return (
    <div className="container mx-auto py-8 px-4">
      <Card className="mb-6">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle>בקשות לבדיקת זמינות</CardTitle>
          <div className="flex gap-4">
            <Select
              value={filters.status}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, status: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי סטטוס" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="pending">ממתין לתגובה</SelectItem>
                <SelectItem value="completed">טופל</SelectItem>
              </SelectContent>
            </Select>
            <Select
              value={filters.timeframe}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, timeframe: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי זמן" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="today">היום</SelectItem>
                <SelectItem value="week">שבוע אחרון</SelectItem>
                <SelectItem value="month">חודש אחרון</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
      </Card>
      {error && (
        <Alert variant="destructive" className="mb-6">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      <div className="grid grid-cols-1 gap-6">
        {inquiries.map((inquiry) => (
          <Card key={inquiry.id}>
            <CardContent className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="font-medium">בקשת בדיקת זמינות</h3>
                  <p className="text-sm text-gray-600">
                    מאת {inquiry.matchmaker.firstName}{' '}
                    {inquiry.matchmaker.lastName}
                  </p>
                </div>
                <Clock className="w-5 h-5 text-gray-400" />
              </div>
              <div className="space-y-4">
                {inquiry.note && (
                  <div className="text-sm text-gray-600 mt-2">
                    <strong>הערה:</strong> {inquiry.note}
                  </div>
                )}
                {!inquiry.firstPartyResponse && (
                  <>
                    <div className="space-y-2">
                      <label className="block text-sm font-medium">
                        הערות (אופציונלי):
                      </label>
                      <Textarea
                        value={note}
                        onChange={(e) => setNote(e.target.value)}
                        placeholder="הוסף/י הערות..."
                        className="w-full"
                      />
                    </div>
                    <div className="flex gap-2 mt-4">
                      <Button
                        onClick={() => handleResponse(inquiry.id, true)}
                        className="flex-1 bg-green-600 hover:bg-green-700"
                      >
                        <CheckCircle className="mr-2 h-4 w-4" /> אני זמין/ה
                      </Button>
                      <Button
                        onClick={() => handleResponse(inquiry.id, false)}
                        variant="outline"
                        className="flex-1"
                      >
                        <XCircle className="mr-2 h-4 w-4" /> לא זמין/ה כרגע
                      </Button>
                    </div>
                  </>
                )}
                {inquiry.firstPartyResponse !== null && (
                  <div className="space-y-4">
                    <div
                      className={`flex items-center gap-2 p-2 rounded-md ${inquiry.firstPartyResponse ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}
                    >
                      {inquiry.firstPartyResponse ? (
                        <CheckCircle className="h-5 w-5" />
                      ) : (
                        <XCircle className="h-5 w-5" />
                      )}
                      <span>
                        {inquiry.firstPartyResponse
                          ? 'אישרת זמינות'
                          : 'ציינת שאינך זמין/ה'}
                      </span>
                    </div>
                    <div>
                      <Button
                        onClick={() =>
                          handleResponse(
                            inquiry.id,
                            !inquiry.firstPartyResponse
                          )
                        }
                        className={`w-full ${inquiry.firstPartyResponse ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                      >
                        {inquiry.firstPartyResponse ? (
                          <>
                            <XCircle className="mr-2 h-4 w-4" /> שינוי תשובה -
                            אינני זמין/ה
                          </>
                        ) : (
                          <>
                            <CheckCircle className="mr-2 h-4 w-4" /> שינוי תשובה
                            - אני זמין/ה
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
--- End of Content for MessagesPage.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\NotificationCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/NotificationCard.tsx

import React from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { formatDistanceToNow } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import type { FeedItem } from '@/types/messages';
import {
  Heart,
  MessageCircle,
  ArrowLeft,
  Zap,
  CheckCircle,
  Info,
  ArrowRight,
} from 'lucide-react';
import type { MessagesPageDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface NotificationCardProps {
  item: FeedItem;
  userId: string;
  // ✨ PROP UPDATE: קבלת חלק מהמילון ו-locale
  dict: MessagesPageDict['notificationCard'];
  locale: Locale;
}

const NotificationCard: React.FC<NotificationCardProps> = ({
  item,
  userId,
  dict,
  locale,
}) => {
  // ... (לוגיקת האייקונים נשארת זהה)
  const iconMap: Record<
    FeedItem['type'],
    { icon: React.ElementType; color: string; gradient: string }
  > = {
    NEW_SUGGESTION: {
      icon: Heart,
      color: 'text-pink-500',
      gradient: 'from-pink-400 to-rose-500',
    },
    ACTION_REQUIRED: {
      icon: Zap,
      color: 'text-orange-500',
      gradient: 'from-orange-400 to-amber-500',
    },
    STATUS_UPDATE: {
      icon: CheckCircle,
      color: 'text-green-500',
      gradient: 'from-emerald-400 to-green-500',
    },
    MATCHMAKER_MESSAGE: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
    INQUIRY_RESPONSE: {
      icon: Info,
      color: 'text-cyan-500',
      gradient: 'from-cyan-400 to-teal-500',
    },
    AVAILABILITY_INQUIRY: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
  };

  const { icon: Icon, gradient } = iconMap[item.type] || {
    icon: Info,
    gradient: 'from-gray-400 to-slate-500',
  };
  const suggestion = item.payload.suggestion;
  const matchmaker = suggestion?.matchmaker;

  const otherParty = suggestion
    ? suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty
    : null;
  const mainImage = otherParty?.images?.find((img) => img.isMain);

  return (
    <Card className="shadow-lg border-0 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 bg-white">
      <CardContent className="p-5 flex items-start gap-4">
        <div className="flex flex-col items-center gap-2 flex-shrink-0">
          <div
            className={cn(
              'w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br shadow-md',
              gradient
            )}
          >
            <Icon className="w-6 h-6 text-white" />
          </div>
          {matchmaker && (
            <Avatar
              className="w-10 h-10 border-2 border-white"
              title={`${dict.matchmakerPrefix} ${matchmaker.firstName}`}
            >
              <AvatarFallback className="bg-gray-200 text-gray-600 text-sm font-bold">
                {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
              </AvatarFallback>
            </Avatar>
          )}
        </div>

        <div className="flex-1 min-w-0">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <h3 className="font-bold text-gray-800 text-lg leading-tight">
                {item.title}
              </h3>
              <p className="text-sm text-gray-600 mt-1">{item.description}</p>
            </div>
            <span className="text-xs text-gray-400 flex-shrink-0 pl-2">
              {/* ✨ LOCALE UPDATE: שימוש ב-locale עבור תאריך */}
              {formatDistanceToNow(new Date(item.timestamp), {
                addSuffix: true,
                locale: locale === 'he' ? he : enUS,
              })}
            </span>
          </div>

          <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
            {otherParty && (
              <div className="flex items-center gap-2">
                <Avatar className="w-8 h-8 border-2 border-white shadow">
                  {mainImage?.url ? (
                    <Image
                      src={getRelativeCloudinaryPath(mainImage.url)}
                      alt={otherParty.firstName}
                      fill
                      className="object-cover"
                      sizes="32px"
                    />
                  ) : (
                    <AvatarFallback className="bg-gray-300 text-gray-700 font-bold text-xs">
                      {getInitials(
                        `${otherParty.firstName} ${otherParty.lastName}`
                      )}
                    </AvatarFallback>
                  )}
                </Avatar>
                {/* ✨ TEXT UPDATE: שימוש במילון */}
                <span className="text-sm font-medium text-gray-700">
                  {dict.suggestionWith.replace(
                    '{{name}}',
                    otherParty.firstName
                  )}
                </span>
              </div>
            )}
            <Link href={item.link} passHref>
              <Button className="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full shadow-md hover:shadow-lg transition-all duration-300">
                {dict.viewDetails}
                {/* ✨ LOCALE UPDATE: שינוי כיוון החץ */}
                {locale === 'he' ? (
                  <ArrowLeft className="mr-2 h-4 w-4" />
                ) : (
                  <ArrowRight className="ml-2 h-4 w-4" />
                )}
              </Button>
            </Link>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default NotificationCard;
--- End of Content for NotificationCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\UserChatPanel.tsx
--------------------------------------------------------------------------------
Content:
// =============================================================================
// 26. UserChatPanel — Chat sidebar + active chat view
// File: src/components/messages/UserChatPanel.tsx
// =============================================================================
//
// Two-pane layout:
//   Left: list of chats (direct + per-suggestion)
//   Right: active chat view
//
// Mobile: shows one pane at a time with back button
// =============================================================================

'use client';

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import {
  MessageCircle,
  Loader2,
  ChevronLeft,
  ChevronRight,
  Send,
  Inbox,
  Clock,
  User,
  Heart,
  RefreshCw,
  Bot,
} from 'lucide-react';
import { cn, getInitials } from '@/lib/utils';
import { format, isToday, isYesterday } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import type { Locale } from '../../../i18n-config';

// ==========================================
// Types
// ==========================================

interface ChatSummary {
  id: string;
  type: 'direct' | 'suggestion';
  title: string;
  subtitle?: string;
  matchmakerName: string;
  lastMessage?: string;
  lastMessageTime?: string;
  lastMessageIsMine?: boolean;
  unreadCount: number;
  suggestionId?: string;
  status?: string;
}

interface ChatMessage {
  id: string;
  content: string;
  senderId: string;
  senderType: 'user' | 'matchmaker' | 'system';
  senderName: string;
  isRead: boolean;
  createdAt: string;
  isMine: boolean;
}

interface UserChatPanelProps {
  locale: Locale;
}

// ==========================================
// Helpers
// ==========================================

function formatTime(dateStr: string | undefined, locale: Locale) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const loc = locale === 'he' ? he : enUS;
  if (isToday(date)) return format(date, 'HH:mm', { locale: loc });
  if (isYesterday(date)) return locale === 'he' ? 'אתמול' : 'Yesterday';
  return format(date, 'dd/MM', { locale: loc });
}

function truncate(text: string, maxLen: number) {
  if (text.length <= maxLen) return text;
  return text.slice(0, maxLen) + '…';
}

// ==========================================
// Component
// ==========================================

export default function UserChatPanel({ locale }: UserChatPanelProps) {
  const [chats, setChats] = useState<ChatSummary[]>([]);
  const [selectedChatId, setSelectedChatId] = useState<string | null>(null);
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [isLoadingList, setIsLoadingList] = useState(true);
  const [isLoadingMessages, setIsLoadingMessages] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const isHe = locale === 'he';

  const selectedChat = chats.find((c) => c.id === selectedChatId);

  // ==========================================
  // Load chat list
  // ==========================================

  const loadChats = useCallback(async () => {
    try {
      const res = await fetch('/api/messages/chats');
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      if (data.success) {
        setChats(data.chats);
      }
    } catch (error) {
      console.error('Error loading chats:', error);
    } finally {
      setIsLoadingList(false);
    }
  }, []);

  useEffect(() => {
    loadChats();
    const interval = setInterval(loadChats, 30000);
    return () => clearInterval(interval);
  }, [loadChats]);

  // ==========================================
  // Load messages for selected chat
  // ==========================================

  const loadMessages = useCallback(async () => {
    if (!selectedChatId) return;

    try {
      const endpoint =
        selectedChatId === 'direct'
          ? '/api/messages/direct'
          : `/api/suggestions/${selectedChatId}/chat`;

      const res = await fetch(endpoint);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      if (data.success) {
        setMessages(data.messages || []);
      }
    } catch (error) {
      console.error('Error loading messages:', error);
    } finally {
      setIsLoadingMessages(false);
    }
  }, [selectedChatId]);

  useEffect(() => {
    if (selectedChatId) {
      setIsLoadingMessages(true);
      loadMessages();
      // Mark as read
      const endpoint =
        selectedChatId === 'direct'
          ? '/api/messages/direct'
          : `/api/suggestions/${selectedChatId}/chat`;
      fetch(endpoint, { method: 'PATCH' }).catch(console.error);
    }
  }, [selectedChatId, loadMessages]);

  // Poll messages when chat is open
  useEffect(() => {
    if (!selectedChatId) return;
    const interval = setInterval(loadMessages, 12000);
    return () => clearInterval(interval);
  }, [selectedChatId, loadMessages]);

  // Auto-scroll
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  // ==========================================
  // Send message
  // ==========================================

  const handleSend = async () => {
    if (!newMessage.trim() || isSending || !selectedChatId) return;
    setIsSending(true);

    try {
      const endpoint =
        selectedChatId === 'direct'
          ? '/api/messages/direct'
          : `/api/suggestions/${selectedChatId}/chat`;

      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: newMessage.trim() }),
      });

      if (!res.ok) throw new Error('Failed to send');
      const data = await res.json();

      if (data.success && data.message) {
        setMessages((prev) => [...prev, data.message]);
        setNewMessage('');
        textareaRef.current?.focus();
      }
    } catch (error) {
      console.error('Send error:', error);
      toast.error(isHe ? 'שגיאה בשליחת ההודעה' : 'Error sending message');
    } finally {
      setIsSending(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const openChat = (chatId: string) => {
    setSelectedChatId(chatId);
    setMessages([]);
  };

  const closeChat = () => {
    setSelectedChatId(null);
    setMessages([]);
    loadChats(); // Refresh unread counts
  };

  // ==========================================
  // Render — Chat View (when a chat is selected)
  // ==========================================

  if (selectedChat) {
    return (
      <Card className="shadow-lg border-0 overflow-hidden bg-white">
        {/* Chat Header */}
        <CardHeader className="bg-gradient-to-r from-teal-50 to-cyan-50/40 border-b py-3">
          <div className="flex items-center gap-3">
            <Button
              variant="ghost"
              size="sm"
              onClick={closeChat}
              className="gap-1 text-gray-600 hover:text-gray-900 hover:bg-teal-50"
            >
              {isHe ? (
                <ChevronRight className="w-4 h-4" />
              ) : (
                <ChevronLeft className="w-4 h-4" />
              )}
              {isHe ? 'חזרה' : 'Back'}
            </Button>
            <div className="h-6 w-px bg-gray-200" />
            <div className="flex items-center gap-2.5">
              <Avatar className="w-9 h-9 shadow-sm ring-2 ring-white">
                <AvatarFallback
                  className={cn(
                    'text-white text-xs font-bold bg-gradient-to-br',
                    selectedChat.type === 'direct'
                      ? 'from-purple-400 to-pink-500'
                      : 'from-teal-400 to-cyan-500'
                  )}
                >
                  {selectedChat.type === 'direct' ? (
                    <User className="w-4 h-4" />
                  ) : (
                    getInitials(selectedChat.title)
                  )}
                </AvatarFallback>
              </Avatar>
              <div>
                <p className="font-semibold text-gray-800 text-sm">
                  {selectedChat.type === 'direct'
                    ? selectedChat.matchmakerName
                    : selectedChat.title}
                </p>
                <p className="text-xs text-gray-500">
                  {selectedChat.type === 'direct'
                    ? isHe
                      ? 'שיחה כללית עם השדכן/ית'
                      : 'General chat with matchmaker'
                    : `${isHe ? 'שדכן/ית:' : 'Matchmaker:'} ${selectedChat.matchmakerName}`}
                </p>
              </div>
            </div>
          </div>
        </CardHeader>

        {/* Messages */}
        <CardContent className="p-0">
          <div className="flex flex-col h-[500px]">
            <ScrollArea className="flex-1 px-4" ref={scrollRef}>
              {isLoadingMessages ? (
                <div className="flex items-center justify-center h-full py-12">
                  <Loader2 className="w-6 h-6 animate-spin text-teal-500" />
                </div>
              ) : messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full py-12 text-center">
                  <div className="w-16 h-16 rounded-full bg-gradient-to-br from-teal-100 to-cyan-100 flex items-center justify-center mb-4">
                    <MessageCircle className="w-8 h-8 text-teal-400" />
                  </div>
                  <h3 className="font-medium text-gray-700 mb-1">
                    {isHe ? 'אין הודעות עדיין' : 'No messages yet'}
                  </h3>
                  <p className="text-sm text-gray-500">
                    {isHe
                      ? 'שלח/י הודעה כדי להתחיל שיחה'
                      : 'Send a message to start the conversation'}
                  </p>
                </div>
              ) : (
                <div className="py-4 space-y-3">
                  {messages.map((msg) => (
                    <div
                      key={msg.id}
                      className={cn(
                        'flex',
                        msg.isMine ? 'justify-end' : 'justify-start',
                        msg.senderType === 'system' && 'justify-center'
                      )}
                    >
                      {msg.senderType === 'system' ? (
                        <div className="flex items-center gap-1.5 text-xs text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full">
                          <Bot className="w-3 h-3" />
                          {msg.content}
                        </div>
                      ) : (
                        <div
                          className={cn(
                            'max-w-[75%] rounded-2xl px-4 py-2.5 shadow-sm',
                            msg.isMine
                              ? 'bg-gradient-to-br from-teal-500 to-cyan-500 text-white rounded-br-md'
                              : 'bg-white border border-gray-200 text-gray-800 rounded-bl-md'
                          )}
                        >
                          {!msg.isMine && (
                            <p
                              className={cn(
                                'text-xs font-semibold mb-1',
                                msg.senderType === 'matchmaker'
                                  ? 'text-purple-600'
                                  : 'text-teal-600'
                              )}
                            >
                              {msg.senderName}
                            </p>
                          )}
                          <p className="text-sm whitespace-pre-wrap leading-relaxed">
                            {msg.content}
                          </p>
                          <p
                            className={cn(
                              'text-[10px] mt-1',
                              msg.isMine ? 'text-white/70' : 'text-gray-400'
                            )}
                          >
                            {format(new Date(msg.createdAt), 'HH:mm', {
                              locale: isHe ? he : enUS,
                            })}
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </ScrollArea>

            {/* Input */}
            <div className="border-t bg-gray-50/50 p-3">
              <div className="flex items-end gap-2">
                <Textarea
                  ref={textareaRef}
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={isHe ? 'כתוב/י הודעה...' : 'Type a message...'}
                  className="flex-1 min-h-[44px] max-h-32 resize-none rounded-xl border-gray-200 focus:border-teal-300 focus:ring-teal-200"
                  rows={1}
                  dir={isHe ? 'rtl' : 'ltr'}
                />
                <Button
                  onClick={handleSend}
                  disabled={!newMessage.trim() || isSending}
                  size="icon"
                  className="h-11 w-11 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 shadow-md flex-shrink-0"
                >
                  {isSending ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Send className={cn('w-4 h-4', isHe && '-scale-x-100')} />
                  )}
                </Button>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  // ==========================================
  // Render — Chat List
  // ==========================================

  if (isLoadingList) {
    return (
      <Card className="shadow-lg border-0 bg-white/80">
        <CardContent className="flex items-center justify-center h-64">
          <Loader2 className="w-6 h-6 animate-spin text-teal-500" />
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="shadow-lg border-0 overflow-hidden bg-white/80 backdrop-blur-sm">
      <CardHeader className="bg-gradient-to-r from-teal-50 to-cyan-50/40 border-b">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-600 text-white shadow-md">
              <MessageCircle className="w-5 h-5" />
            </div>
            <div>
              <CardTitle className="text-lg">
                {isHe ? 'השיחות שלי' : 'My Conversations'}
              </CardTitle>
              <p className="text-sm text-gray-500">
                {isHe ? 'שיחות עם השדכן/ית שלך' : 'Conversations with your matchmaker'}
              </p>
            </div>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={loadChats}
            className="text-gray-500 hover:text-teal-600"
          >
            <RefreshCw className="w-4 h-4" />
          </Button>
        </div>
      </CardHeader>

      <CardContent className="p-0">
        {chats.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-center px-4">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-50 to-cyan-50 flex items-center justify-center mb-4">
              <Inbox className="w-8 h-8 text-gray-300" />
            </div>
            <p className="text-sm text-gray-500 mb-1 font-medium">
              {isHe ? "אין שיחות עדיין" : 'No conversations yet'}
            </p>
            <p className="text-xs text-gray-400">
              {isHe
                ? 'כשתקבל/י הצעה, תוכל/י לשוחח עם השדכן/ית כאן'
                : "When you receive a suggestion, you'll be able to chat here"}
            </p>
          </div>
        ) : (
          <ScrollArea className="max-h-[600px]">
            <div className="divide-y divide-gray-100">
              {chats.map((chat) => (
                <button
                  key={chat.id}
                  onClick={() => openChat(chat.id)}
                  className="w-full px-5 py-4 flex items-center gap-3.5 hover:bg-gray-50/80 transition-colors text-start"
                >
                  {/* Avatar */}
                  <div className="relative flex-shrink-0">
                    <Avatar className="w-12 h-12 shadow-sm ring-2 ring-white">
                      <AvatarFallback
                        className={cn(
                          'text-white font-bold bg-gradient-to-br',
                          chat.type === 'direct'
                            ? 'from-purple-400 to-pink-500'
                            : 'from-teal-400 to-cyan-500'
                        )}
                      >
                        {chat.type === 'direct' ? (
                          <User className="w-5 h-5" />
                        ) : (
                          getInitials(chat.title)
                        )}
                      </AvatarFallback>
                    </Avatar>
                    {chat.type === 'suggestion' && (
                      <div className="absolute -bottom-0.5 -end-1 p-0.5 bg-white rounded-full shadow">
                        <Heart className="w-3 h-3 text-pink-500 fill-pink-500" />
                      </div>
                    )}
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between mb-0.5">
                      <p className="font-semibold text-gray-800 text-sm truncate">
                        {chat.type === 'direct'
                          ? isHe
                            ? `💬 שיחה עם ${chat.matchmakerName}`
                            : `💬 Chat with ${chat.matchmakerName}`
                          : chat.title}
                      </p>
                      <div className="flex items-center gap-1.5 flex-shrink-0">
                        {chat.lastMessageTime && (
                          <span className="text-[10px] text-gray-400 flex items-center gap-0.5">
                            <Clock className="w-3 h-3" />
                            {formatTime(chat.lastMessageTime, locale)}
                          </span>
                        )}
                      </div>
                    </div>

                    {/* Subtitle */}
                    <p className="text-xs text-gray-400 mb-0.5">
                      {chat.type === 'direct'
                        ? isHe
                          ? 'שיחה כללית'
                          : 'General chat'
                        : `${isHe ? 'שדכן/ית:' : 'Matchmaker:'} ${chat.matchmakerName}`}
                    </p>

                    {/* Last message preview */}
                    {chat.lastMessage ? (
                      <p className="text-xs text-gray-500 truncate">
                        {chat.lastMessageIsMine && (
                          <span className="text-teal-600 font-medium">
                            {isHe ? 'אני: ' : 'Me: '}
                          </span>
                        )}
                        {truncate(chat.lastMessage, 60)}
                      </p>
                    ) : (
                      <p className="text-xs text-gray-400 italic">
                        {isHe ? 'לחץ/י לפתיחת שיחה' : 'Tap to open chat'}
                      </p>
                    )}
                  </div>

                  {/* Unread badge + Arrow */}
                  <div className="flex items-center gap-2 flex-shrink-0">
                    {chat.unreadCount > 0 && (
                      <Badge className="bg-teal-500 text-white text-xs px-2 py-0.5 border-0 shadow-sm animate-pulse">
                        {chat.unreadCount}
                      </Badge>
                    )}
                    <ChevronLeft className="w-4 h-4 text-gray-300 rtl:-scale-x-100" />
                  </div>
                </button>
              ))}
            </div>
          </ScrollArea>
        )}
      </CardContent>
    </Card>
  );
}
--- End of Content for UserChatPanel.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\messages_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

