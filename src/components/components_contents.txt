################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components
# Generated on: 2025-11-30 20:19:38
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\Providers.tsx
--------------------------------------------------------------------------------
Content:
// src/components/Providers.tsx
"use client";

import { SessionProvider } from "next-auth/react";
import { NotificationProvider } from "@/app/[locale]/contexts/NotificationContext";
import { TooltipProvider } from "@/components/ui/tooltip";
import { ReactNode } from "react";

interface ProvidersProps {
  children: ReactNode;
}

const Providers = ({ children }: ProvidersProps) => {
  return (
    <SessionProvider refetchOnWindowFocus={false}>
      <NotificationProvider>
        <TooltipProvider delayDuration={0}>
          {children}
        </TooltipProvider>
      </NotificationProvider>
    </SessionProvider>
  );
};

export default Providers;
--- End of Content for Providers.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\components_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ChatWidget
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ChatWidget\ChatWidget.tsx
--------------------------------------------------------------------------------
Content:
'use client';
import React, { useState, useRef, useEffect } from 'react';
import {
  MessageCircle,
  Send,
  X,
  Bot,
  User,
  Sparkles,
  Mail,
  Heart,
} from 'lucide-react';
import { usePathname } from 'next/navigation';

import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import type { ChatWidgetDict } from '@/types/dictionary';

// --- Type Definitions ---
interface ChatWidgetProps {
  dict: ChatWidgetDict;
}

interface ActionButton {
  type: 'email';
  label: string;
}

interface ChatMessage {
  sender: 'bot' | 'user';
  text: string;
  actions?: ActionButton[];
  timestamp: Date;
  isFallback?: boolean;
}

type ChatMode = 'question' | 'gatheringEmail' | 'composingEmail';

const EMAIL_REGEX = /\S+@\S+\.\S+/;

export default function ChatWidget({ dict }: ChatWidgetProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [chatMode, setChatMode] = useState<ChatMode>('question');
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [isLimitReached, setIsLimitReached] = useState(false);
  const [hasUnreadMessage, setHasUnreadMessage] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [viewportHeight, setViewportHeight] = useState(0);

  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(scrollToBottom, [messages, isLoading]);

  useEffect(() => {
    const handleResize = () => setViewportHeight(window.innerHeight);
    setViewportHeight(window.innerHeight);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    if (isOpen && inputRef.current) {
      const timer = setTimeout(() => scrollToBottom(), 300);
      return () => clearTimeout(timer);
    }
  }, [isOpen, viewportHeight]);

  useEffect(() => {
    if (isOpen && messages.length === 0) {
      setIsLoading(true);
      setTimeout(() => {
        const welcomeMessage: ChatMessage = {
          sender: 'bot',
          text: dict.texts.welcome,
          timestamp: new Date(),
        };
        setMessages([welcomeMessage]);
        setIsLoading(false);
      }, 800);
    }
  }, [isOpen, messages.length, dict.texts.welcome]);

  useEffect(() => {
    if (
      !isOpen &&
      messages.length > 0 &&
      messages[messages.length - 1].sender === 'bot'
    ) {
      setHasUnreadMessage(true);
    } else if (isOpen) {
      setHasUnreadMessage(false);
    }
  }, [isOpen, messages]);

  const clearError = () => setError(null);
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'he';

  const switchToEmailMode = () => {
    setChatMode('gatheringEmail');
    const emailModeMessage: ChatMessage = {
      sender: 'bot',
      text: dict.texts.switchToEmailPrompt,
      timestamp: new Date(),
    };
    setMessages((prev) => [...prev, emailModeMessage]);
    setInputValue('');
    clearError();
  };

  const submitQuestion = async (questionText: string) => {
    const userMessageCount = messages.filter(
      (msg) => msg.sender === 'user'
    ).length;

    if (userMessageCount >= 10 && !isLimitReached) {
      const limitMessage: ChatMessage = {
        sender: 'bot',
        text: dict.texts.limitReached,
        actions: [{ type: 'email', label: dict.email_action_button }],
        timestamp: new Date(),
      };
      setMessages((prev) => [...prev, limitMessage]);
      setIsLimitReached(true);
      return;
    }

    if (!questionText.trim() || isLoading || isLimitReached) return;

    clearError();
    const userMessage: ChatMessage = {
      sender: 'user',
      text: questionText,
      timestamp: new Date(),
    };
    setMessages((prev) => [...prev, userMessage]);
    setIsLoading(true);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: questionText, locale }),
      });

      if (!response.ok) throw new Error(`Server error: ${response.status}`);

      const data = await response.json();
      const botMessage: ChatMessage = {
        sender: 'bot',
        text: data.reply,
        actions: data.actions,
        isFallback: data.isFallback,
        timestamp: new Date(),
      };

      setTimeout(() => {
        setMessages((prev) => [...prev, botMessage]);
        setIsLoading(false);
      }, 1000);
    } catch (error) {
      console.error('Chat error:', error);
      setError(dict.texts.genericError);
      setIsLoading(false);
    }
  };

  const handleEmailFlow = async () => {
    if (!inputValue.trim()) return;
    clearError();

    if (chatMode === 'gatheringEmail') {
      if (!EMAIL_REGEX.test(inputValue)) {
        setError(dict.texts.emailError);
        return;
      }

      setUserEmail(inputValue);
      const userEmailMessage: ChatMessage = {
        sender: 'user',
        text: inputValue,
        timestamp: new Date(),
      };
      const confirmEmailMessage: ChatMessage = {
        sender: 'bot',
        text: dict.texts.composeEmailPrompt,
        timestamp: new Date(),
      };

      setMessages((prev) => [...prev, userEmailMessage, confirmEmailMessage]);
      setChatMode('composingEmail');
      setInputValue('');
      return;
    }

    if (chatMode === 'composingEmail' && userEmail) {
      const emailText = inputValue;
      const userMessageText: ChatMessage = {
        sender: 'user',
        text: emailText,
        timestamp: new Date(),
      };

      setMessages((prev) => [...prev, userMessageText]);
      setIsLoading(true);
      setInputValue('');

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: emailText,
            type: 'email',
            userEmail,
          }),
        });

        if (!response.ok) throw new Error('Failed to send email');

        const data = await response.json();
        const successMessage: ChatMessage = {
          sender: 'bot',
          text: data.reply,
          timestamp: new Date(),
        };

        setTimeout(() => {
          setMessages((prev) => [...prev, successMessage]);
          setIsLoading(false);
          setChatMode('question');
          setUserEmail(null);
        }, 1000);
      } catch (error) {
        console.error('Email error:', error);
        setError(dict.texts.sendEmailError);
        setIsLoading(false);
      }
    }
  };

  const handleFormSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (chatMode === 'question') {
      submitQuestion(inputValue);
      setInputValue('');
    } else {
      handleEmailFlow();
    }
  };

  const getPlaceholderText = () => {
    if (isLimitReached) return dict.texts.placeholderLimitReached;
    switch (chatMode) {
      case 'gatheringEmail':
        return dict.texts.placeholderGatheringEmail;
      case 'composingEmail':
        return dict.texts.placeholderComposingEmail;
      default:
        return dict.texts.placeholderDefault;
    }
  };

  const formatTime = (date: Date) =>
    date.toLocaleTimeString('he-IL', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    });

  const shouldShowPromptQuestions = () => {
    if (isLoading || isLimitReached || chatMode !== 'question') return false;
    if (messages.length === 1 && messages[0].sender === 'bot') return true;
    const lastMessage = messages[messages.length - 1];
    return (
      lastMessage?.sender === 'bot' &&
      !lastMessage.actions &&
      !lastMessage.isFallback
    );
  };

  return (
    <>
      <div className="fixed bottom-6 left-6 md:bottom-6 md:left-6 z-[100]">
        <div className="relative">
          {hasUnreadMessage && !isOpen && (
            <div className="absolute -top-1 -right-1 w-5 h-5 bg-orange-500 rounded-full animate-pulse border-2 border-white z-10 flex items-center justify-center">
              <span className="text-white text-xs font-bold">1</span>
            </div>
          )}
          {!isOpen && (
            // Updated to teal-400 for the ping animation
            <div className="absolute inset-0 rounded-full bg-teal-400 opacity-20 animate-ping" />
          )}
          <Button
            id="onboarding-target-chat-widget"
            aria-label={isOpen ? dict.aria_close : dict.aria_open}
            aria-expanded={isOpen}
            aria-controls="chat-panel"
            size="icon"
            // Updated gradient to match Hero Section (Teal -> Orange -> Amber)
            className="relative rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 group w-16 h-16 md:w-16 md:h-16 border-2 border-white touch-manipulation"
            onClick={() => setIsOpen(!isOpen)}
          >
            {isOpen ? (
              <X className="w-7 h-7 text-white transition-all duration-300 group-hover:rotate-90" />
            ) : (
              <div className="flex items-center justify-center">
                <MessageCircle className="w-7 h-7 text-white transition-all duration-300 group-hover:scale-110" />
                <Heart className="w-3 h-3 text-white absolute top-2 right-2 opacity-60" />
              </div>
            )}
          </Button>
        </div>
      </div>

      <div
        id="chat-panel"
        role="dialog"
        aria-modal="true"
        aria-labelledby="chat-panel-title"
        className={cn(
          'fixed z-[99] bg-white rounded-3xl shadow-2xl flex flex-col transition-all duration-500 ease-in-out border border-gray-100',
          isOpen
            ? 'opacity-100 scale-100 translate-y-0'
            : 'opacity-0 scale-95 translate-y-4 pointer-events-none',
          'top-16 bottom-16 left-4 right-4 sm:top-12 sm:bottom-12 sm:left-6 sm:right-6 md:fixed md:bottom-28 md:left-6 md:right-auto md:top-auto md:w-96 md:h-[32rem] md:max-w-none'
        )}
        style={{
          maxHeight:
            viewportHeight > 0 && window.innerWidth < 768
              ? `${viewportHeight - 120}px`
              : undefined,
        }}
      >
        {/* Updated Header Gradient to Teal */}
        <div className="bg-gradient-to-r from-teal-600 to-teal-700 p-4 md:p-5 rounded-t-3xl text-white flex items-center justify-between shadow-lg shrink-0">
          <div className="flex items-center min-w-0 flex-1">
            <div className="relative shrink-0">
              <Bot className="w-7 h-7 md:w-7 md:h-7 mr-3 opacity-90" />
              {/* Updated Status dot to Emerald/Green (matches palette) */}
              <div className="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-emerald-400 rounded-full border border-white" />
            </div>
            <div className="min-w-0 flex-1">
              <h3 id="chat-panel-title" className="font-bold text-lg truncate">
                {dict.header_title}
              </h3>
              <p className="text-sm opacity-90 truncate">
                {dict.header_subtitle}
              </p>
            </div>
          </div>
          <div className="text-xs opacity-75 bg-white/10 px-3 py-1.5 rounded-full shrink-0">
            {dict.header_status}
          </div>
        </div>

        <div className="flex-1 p-4 md:p-4 overflow-y-auto bg-gradient-to-b from-gray-50 to-white min-h-0 overscroll-behavior-contain">
          <div
            className="space-y-5 md:space-y-4"
            aria-live="polite"
            aria-atomic="false"
          >
            {messages.map((msg, index) => (
              <div key={index}>
                <div
                  className={`flex items-start gap-3 ${
                    msg.sender === 'user' ? 'justify-end' : 'justify-start'
                  }`}
                >
                  {msg.sender === 'bot' && (
                    // Updated Bot Icon Background to Teal-50
                    <div className="bg-teal-50 p-2.5 rounded-full self-start shadow-sm shrink-0">
                      <Bot className="w-5 h-5 text-teal-700" />
                    </div>
                  )}
                  <div className="flex flex-col max-w-[85%] md:max-w-[80%] min-w-0">
                    <div
                      className={cn(
                        'p-4 rounded-2xl shadow-sm leading-relaxed break-words',
                        msg.sender === 'user'
                          ? // Updated User Bubble Gradient to Teal
                            'bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-br-lg'
                          : 'bg-white border border-gray-100 rounded-bl-lg'
                      )}
                    >
                      <p className="text-base font-normal whitespace-pre-wrap leading-relaxed">
                        {msg.text}
                      </p>
                    </div>
                    <span
                      className={cn(
                        'text-xs text-gray-400 mt-2 px-2',
                        msg.sender === 'user' ? 'text-left' : 'text-right'
                      )}
                    >
                      {formatTime(msg.timestamp)}
                    </span>
                  </div>
                  {msg.sender === 'user' && (
                    <div className="bg-gray-200 p-2.5 rounded-full self-start shadow-sm shrink-0">
                      <User className="w-5 h-5 text-gray-600" />
                    </div>
                  )}
                </div>

                {msg.sender === 'bot' && msg.actions && !isLoading && (
                  <div className="flex flex-col gap-3 mt-4 mr-14">
                    {msg.actions.map((action, actionIndex) => (
                      <Button
                        key={actionIndex}
                        variant="outline"
                        // Updated Action Button to Teal colors
                        className="justify-start text-right bg-white border-teal-200 text-teal-700 hover:bg-teal-50 rounded-xl shadow-sm text-base py-3 px-4 h-auto touch-manipulation min-h-[48px]"
                        onClick={switchToEmailMode}
                      >
                        <Mail className="w-5 h-5 ml-2" />
                        {dict.email_action_button}
                      </Button>
                    ))}
                  </div>
                )}
              </div>
            ))}

            {isLoading && (
              <div className="flex items-start gap-3 justify-start">
                {/* Updated Loading Icon to Teal */}
                <div className="bg-teal-50 p-2.5 rounded-full self-start shadow-sm shrink-0">
                  <Bot className="w-5 h-5 text-teal-700" />
                </div>
                <div className="bg-white border border-gray-100 rounded-2xl rounded-bl-lg p-4 shadow-sm">
                  {/* Updated Loading Dots: Teal, Orange, Teal (Synergy!) */}
                  <div className="flex items-center space-x-1 rtl:space-x-reverse">
                    <div className="h-2 w-2 bg-teal-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                    <div className="h-2 w-2 bg-orange-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                    <div className="h-2 w-2 bg-teal-500 rounded-full animate-bounce"></div>
                  </div>
                </div>
              </div>
            )}

            {shouldShowPromptQuestions() && (
              <div className="pt-3 mr-14">
                <div className="flex items-center gap-2 text-sm text-gray-500 mb-4">
                  {/* Updated Sparkles to Orange for contrast */}
                  <Sparkles className="w-4 h-4 text-orange-500" />
                  <span>{dict.prompt_header}</span>
                </div>
                <div className="flex flex-wrap gap-2.5">
                  {dict.prompt_questions.map((q) => (
                    <Button
                      key={q}
                      variant="outline"
                      // Updated Prompt Buttons to Teal theme
                      className="rounded-full text-sm h-auto py-3 px-4 bg-white hover:bg-teal-50 border-teal-200 text-teal-700 transition-all duration-200 hover:shadow-sm touch-manipulation min-h-[44px]"
                      onClick={() => submitQuestion(q)}
                    >
                      {q}
                    </Button>
                  ))}
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>
        </div>

        {error && (
          <div className="px-4 py-3 bg-red-50 border-t border-red-100 shrink-0">
            <p className="text-sm text-red-600 text-center leading-relaxed">
              {error}
            </p>
          </div>
        )}

        <form
          onSubmit={handleFormSubmit}
          className="p-4 border-t border-gray-100 bg-white rounded-b-3xl shrink-0"
        >
          {chatMode === 'question' && !isLimitReached && (
            <div className="text-center mb-4">
              <Button
                type="button"
                variant="link"
                // Updated Link Button to Teal
                className="text-sm text-teal-600 hover:text-teal-800 h-auto p-2 underline-offset-4 touch-manipulation min-h-[44px]"
                onClick={switchToEmailMode}
              >
                {dict.email_link_button}
              </Button>
            </div>
          )}
          <div className="flex items-center gap-3">
            <label htmlFor="chat-input" className="sr-only">
              {getPlaceholderText()}
            </label>
            <input
              ref={inputRef}
              id="chat-input"
              type={chatMode === 'gatheringEmail' ? 'email' : 'text'}
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              placeholder={getPlaceholderText()}
              // Updated Focus Ring to Teal
              className="flex-1 px-4 py-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-base transition-all duration-200 bg-gray-50 focus:bg-white min-w-0 touch-manipulation"
              disabled={isLoading || isLimitReached}
              dir="rtl"
              style={{ fontSize: '16px' }}
            />
            <Button
              type="submit"
              size="icon"
              aria-label="שלח הודעה"
              // Updated Send Button to Teal
              className="rounded-2xl bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 shrink-0 shadow-md hover:shadow-lg transition-all duration-200 w-12 h-12 touch-manipulation"
              disabled={isLoading || !inputValue.trim() || isLimitReached}
            >
              <Send className="w-6 h-6" />
            </Button>
          </div>
        </form>
      </div>
    </>
  );
}
--- End of Content for ChatWidget.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\HomePage.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/HomePage.tsx

'use client';

import React, { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';

// Import all sections
import HeroSection from './sections/HeroSection';
import ValuePropositionSection from './sections/ValuePropositionSection';
import OurMethodSection from './sections/OurMethodSection';
import HowItWorksSection from './sections/HowItWorksSection';
import MatchmakerTeamSection from './sections/MatchmakerTeamSection';
import SuccessStoriesSection from './sections/SuccessStoriesSection';
import FAQSection from './sections/FAQSection';
import PrivacyAssuranceSection from './sections/PrivacyAssuranceSection';
import CTASection from './sections/CTASection';
import FooterSection from './sections/FooterSection';

// Import external components
import ChatWidget from '../ChatWidget/ChatWidget';
import StickyNav, { NavLink } from './components/StickyNav';
import CookieBanner from '../ui/CookieBanner';
import type { Dictionary } from '@/types/dictionary';
import { generateDemoData } from './components/demo-data';
import NeshmaInsightSectionB from './sections/NeshmaInsightSectionB';  // ← חדש!

// ✅ 1. הגדרת הטיפוס עבור נתוני הדמו
type DemoData = Awaited<ReturnType<typeof generateDemoData>>;

// ✅ 2. עדכון הממשק של ה-props כך שיכלול גם את demoData
interface HomePageProps {
  dict: Dictionary;
  demoData: DemoData;
  locale: 'he' | 'en';
}

export default function HomePage({ dict, demoData, locale }: HomePageProps) {
  // ✅ 3. קבלת demoData כ-prop
  const { data: session } = useSession();
  const [isVisible, setIsVisible] = useState(false);
  const [isScrolled, setIsScrolled] = useState(false);

  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 10);
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();

    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }, []);

  useEffect(() => {
    setIsVisible(true);
  }, []);

  const navLinks: NavLink[] = [
    { id: 'how-it-works', label: dict.stickyNav.navLinks.howItWorks },
    { id: 'suggestion-demo', label: dict.stickyNav.navLinks.suggestionDemo },
    { id: 'success-stories', label: dict.stickyNav.navLinks.successStories },
    { id: 'our-team', label: dict.stickyNav.navLinks.ourTeam },
    { id: 'faq', label: dict.stickyNav.navLinks.faq },
  ];

  return (
    <div className="min-h-screen w-full overflow-x-hidden">
      <StickyNav
        navLinks={navLinks}
        session={session}
        isVisible={isScrolled}
        dict={dict.stickyNav} // ✨ הוסף את ה-prop הזה
        locale={locale}
      />

      <HeroSection
        session={session}
        isVisible={isVisible}
        dict={dict.heroSection}
        locale={locale}
      />
      <ValuePropositionSection dict={dict.valueProposition} />
{/* ✨ תובנת נשמה - גרסה B (Personal Conversation) */}
      <NeshmaInsightSectionB locale={locale} dict={dict.neshmaInsight} />
    
      <OurMethodSection dict={dict.ourMethod} />

      {/* ✅ 4. העברת demoData לרכיב HowItWorksSection פותרת את שגיאת 'Cannot find name' */}
      <HowItWorksSection
        dict={dict.howItWorks}
        suggestionsDict={dict.suggestions}
        profileCardDict={dict.profilePage.profileCard}
        demoData={demoData}
        locale={locale}
      />


      <MatchmakerTeamSection dict={dict.matchmakerTeam} />
      <SuccessStoriesSection dict={dict.successStories} locale={locale} />
      <FAQSection dict={dict.faq} locale={locale} />
      <PrivacyAssuranceSection dict={dict.privacyAssurance} locale={locale} />
      <CTASection dict={dict.cta} locale={locale} />
      <FooterSection dict={dict.footer} />

      <ChatWidget dict={dict.chatWidget} />
      <CookieBanner dict={dict.cookieBanner} />
    </div>
  );
}
--- End of Content for HomePage.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\ComparisonItem.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/ComparisonItem.tsx

import React from 'react';

export interface ComparisonItemProps {
  children: React.ReactNode;
  isNegative?: boolean;
}

// Helper component for the comparison items
const ComparisonItem: React.FC<ComparisonItemProps> = ({
  children,
  isNegative = false,
}) => (
  <li className="flex items-start">
    {/* <<< שינוי נגישות: הוספת aria-hidden="true" ל-div שעוטף את האייקון הדקורטיבי >>> */}
    <div
      aria-hidden="true"
      className={`p-1 rounded-full ${
        isNegative ? 'bg-red-100 text-red-600' : 'bg-cyan-100 text-cyan-600'
      } mr-3 mt-1 flex-shrink-0`}
    >
      {isNegative ? (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className="h-4 w-4"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fillRule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clipRule="evenodd"
          />
        </svg>
      ) : (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className="h-4 w-4"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fillRule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clipRule="evenodd"
          />
        </svg>
      )}
    </div>
    <span
      className={`text-sm ${isNegative ? 'text-gray-700' : 'text-gray-700'}`}
    >
      {children}
    </span>
  </li>
);

export default ComparisonItem;
--- End of Content for ComparisonItem.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\DemoProfileCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/DemoProfileCard.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import { cn } from '@/lib/utils';
import { AnimatePresence, motion } from 'framer-motion';
import {
  Sparkles,
  BookOpen,
  Target,
  ChevronLeft,
  ChevronRight,
  ArrowRight,
  Quote,
  MapPin,
  Briefcase,
  Star,
  ArrowLeft,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

// --- Demo Data (ללא שינוי) ---
const DEMO_PROFILE = {
  firstName: 'נועה',
  age: 29,
  city: 'תל אביב',
  occupation: 'מעצבת UX/UI',
  religiousLevel: 'דתיה ליברלית',
  about:
    'אופטימית וחובבת שיחות עומק על כוס קפה. מוצאת יופי בדברים הקטנים של החיים, בין אם זה טיול בטבע או פלייליסט טוב. אחרי כמה ניסיונות שלא צלחו, אני יודעת היום טוב יותר מה נכון לי, ומחפשת שותף לדרך, לבנות יחד בית שמלא בצחוק, כבוד הדדי וצמיחה משותפת.',
};

const DEMO_IMAGES = [
  {
    id: '1',
    url: 'https://images.pexels.com/photos/3771836/pexels-photo-3771836.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
    isMain: true,
  },
  {
    id: '2',
    url: 'https://images.pexels.com/photos/3775164/pexels-photo-3775164.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
  },
  {
    id: '3',
    url: 'https://images.pexels.com/photos/3771045/pexels-photo-3771045.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
  },
  {
    id: '4',
    url: 'https://images.pexels.com/photos/1758531/pexels-photo-1758531.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
  },
  {
    id: '5',
    url: 'https://images.pexels.com/photos/4009409/pexels-photo-4009409.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
  },
  {
    id: '6',
    url: 'https://images.pexels.com/photos/718978/pexels-photo-718978.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
  },
];

const DEMO_QA = [
  {
    question: 'מה הערך החשוב ביותר שתרצי להנחיל בבית שתקימי?',
    answer:
      'כבוד הדדי. היכולת להקשיב באמת, גם כשלא מסכימים, וליצור מרחב בטוח שבו שנינו יכולים להיות הגרסה הכי אותנטית של עצמנו.',
  },
  {
    question: 'איך את רואה את חלוקת התפקידים בזוגיות מודרנית?',
    answer:
      "אני מאמינה בשותפות מלאה. לא 'תפקידים' קבועים, אלא צוות שפועל יחד. יום אחד אני אהיה החזקה כשהוא צריך תמיכה, ויום אחר הוא יהיה שם בשבילי. הכל בתקשורת וגמישות.",
  },
];

const TABS = [
  { id: 'essence', label: 'המהות', icon: Sparkles },
  { id: 'story', label: 'התשובות', icon: BookOpen },
  { id: 'vision', label: 'החזון', icon: Target },
];

const QandAItem: React.FC<{ q: string; a: string }> = ({ q, a }) => (
  // Updated colors to Teal/Orange theme
  <div className="bg-white/60 p-4 rounded-xl shadow-sm border border-orange-100">
    <h4 className="font-bold text-teal-800 mb-2">{q}</h4>
    <p className="text-gray-700 leading-relaxed italic">“{a}”</p>
  </div>
);

// --- Main Component ---
export const DemoProfileCard = ({ locale }: { locale: 'he' | 'en' }) => {
  const [activeTab, setActiveTab] = useState('essence');
  const [mainImageIndex, setMainImageIndex] = useState(0);

  const handleImageNav = (direction: 'next' | 'prev') => {
    setMainImageIndex((prevIndex) => {
      if (direction === 'next') {
        return (prevIndex + 1) % DEMO_IMAGES.length;
      } else {
        return (prevIndex - 1 + DEMO_IMAGES.length) % DEMO_IMAGES.length;
      }
    });
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 50 }}
      whileInView={{ opacity: 1, y: 0 }}
      viewport={{ once: true, amount: 0.3 }}
      transition={{ duration: 0.8, ease: 'easeOut' }}
      // Updated container background
      className="w-full max-w-4xl mx-auto bg-white/80 backdrop-blur-xl rounded-[2rem] shadow-2xl p-4 sm:p-6 border border-white/60 relative overflow-hidden"
    >
      {/* Background Gradient Blob */}
      <div className="absolute top-0 right-0 w-64 h-64 bg-teal-100/50 rounded-full blur-3xl -z-10" />
      <div className="absolute bottom-0 left-0 w-64 h-64 bg-orange-100/50 rounded-full blur-3xl -z-10" />

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 relative z-10">
        {/* Left Side: Image Gallery */}
        <div className="flex flex-col gap-4">
          <div className="relative aspect-[3/4] rounded-2xl overflow-hidden shadow-lg group">
            <AnimatePresence initial={false}>
              <motion.div
                key={mainImageIndex}
                className="absolute inset-0"
                initial={{ opacity: 0.5, scale: 1.05 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.95 }}
                transition={{ duration: 0.4, ease: 'easeInOut' }}
              >
                <Image
                  src={DEMO_IMAGES[mainImageIndex].url}
                  alt={`תמונה של ${DEMO_PROFILE.firstName}`}
                  fill
                  className="object-cover"
                  sizes="(max-width: 1024px) 100vw, 50vw"
                />
              </motion.div>
            </AnimatePresence>
            <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent" />
            <Button
              variant="ghost"
              size="icon"
              className="absolute top-1/2 -translate-y-1/2 left-2 sm:left-4 bg-black/20 text-white backdrop-blur-sm rounded-full hover:bg-black/40"
              onPointerDown={() => handleImageNav('prev')}
              aria-label="התמונה הקודמת"
            >
              <ChevronLeft />
            </Button>
            {/* Note: Previous code had duplicate Next button with left arrow, fixing to just one Next button */}
            <Button
              variant="ghost"
              size="icon"
              className="absolute top-1/2 -translate-y-1/2 right-2 sm:right-4 bg-black/20 text-white backdrop-blur-sm rounded-full hover:bg-black/40"
              onClick={() => handleImageNav('next')}
              aria-label="התמונה הבאה"
            >
              <ChevronRight />
            </Button>
          </div>
          <div className="grid grid-cols-6 gap-2">
            {DEMO_IMAGES.map((image, index) => (
              <button
                key={image.id}
                className={cn(
                  'aspect-square rounded-lg overflow-hidden relative transition-all duration-300 transform hover:scale-105',
                  mainImageIndex === index
                    ? 'ring-2 ring-offset-2 ring-orange-500 shadow-md' // Highlight color: Orange
                    : 'opacity-60 hover:opacity-100'
                )}
                onPointerDown={() => setMainImageIndex(index)}
                aria-label={`הצג תמונה מספר ${index + 1}`}
              >
                <Image
                  src={image.url}
                  alt={`תמונה קטנה ${index + 1}`}
                  fill
                  className="object-cover"
                />
              </button>
            ))}
          </div>
        </div>

        {/* Right Side: Profile Info */}
        <div className="bg-white/50 backdrop-blur-sm p-4 sm:p-6 rounded-2xl border border-white/80 flex flex-col">
          {/* Header */}
          <div className="text-center mb-4">
            <h3 className="text-3xl sm:text-4xl font-extrabold text-gray-800">
              {DEMO_PROFILE.firstName}, {DEMO_PROFILE.age}
            </h3>
            <div className="flex items-center justify-center gap-4 mt-2 text-gray-600">
              <div className="flex items-center gap-1.5">
                <MapPin className="w-4 h-4 text-teal-600" />
                <span>{DEMO_PROFILE.city}</span>
              </div>
              <div className="flex items-center gap-1.5">
                <Briefcase className="w-4 h-4 text-orange-500" />
                <span>{DEMO_PROFILE.occupation}</span>
              </div>
            </div>
          </div>

          {/* Navigation Tabs - Updated Colors */}
          <div
            className="mb-4 bg-slate-100 p-1 rounded-full grid grid-cols-3 gap-1"
            role="tablist"
            aria-label="ניווט בפרופיל הדמו"
          >
            {TABS.map((tab) => (
              <button
                key={tab.id}
                id={`tab-${tab.id}`}
                role="tab"
                aria-selected={activeTab === tab.id}
                aria-controls={`panel-${tab.id}`}
                onPointerDown={() => setActiveTab(tab.id)}
                className={cn(
                  'relative w-full rounded-full py-2 text-sm font-semibold transition-colors duration-300',
                  activeTab === tab.id
                    ? 'text-white'
                    : 'text-gray-600 hover:bg-white/60 hover:text-teal-700'
                )}
              >
                {activeTab === tab.id && (
                  <motion.div
                    layoutId="demo-profile-active-tab"
                    // Active Tab Gradient: Teal to Orange
                    className="absolute inset-0 bg-gradient-to-r from-teal-500 to-orange-500 rounded-full shadow-md"
                    transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                  />
                )}
                <span className="relative z-10 flex items-center justify-center gap-1.5">
                  <tab.icon className="w-4 h-4" />
                  {tab.label}
                </span>
              </button>
            ))}
          </div>

          {/* Content Panels */}
          <div className="flex-grow min-h-[250px]">
            <AnimatePresence mode="wait">
              {activeTab === 'essence' && (
                <motion.div
                  key="essence"
                  role="tabpanel"
                  id="panel-essence"
                  aria-labelledby="tab-essence"
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.3, ease: 'easeInOut' }}
                  className="space-y-4"
                >
                  <div className="relative bg-white/60 p-4 rounded-xl shadow-sm border border-teal-100">
                    <Quote className="absolute top-2 right-2 w-8 h-8 text-teal-200/50 transform scale-x-[-1]" />
                    <p className="text-lg text-gray-800 italic font-medium leading-relaxed">
                      {DEMO_PROFILE.about}
                    </p>
                  </div>
                  <Badge className="bg-gradient-to-r from-teal-500 to-emerald-500 text-white border-0 shadow-md px-3 py-1.5 text-sm font-bold flex items-center gap-1.5 w-fit mx-auto sm:mx-0">
                    <Star className="w-4 h-4" />
                    <span>{DEMO_PROFILE.religiousLevel}</span>
                  </Badge>
                </motion.div>
              )}
              {activeTab === 'story' && (
                <motion.div
                  key="story"
                  role="tabpanel"
                  id="panel-story"
                  aria-labelledby="tab-story"
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.3, ease: 'easeInOut' }}
                  className="space-y-4"
                >
                  {DEMO_QA.map((item, index) => (
                    <QandAItem key={index} q={item.question} a={item.answer} />
                  ))}
                </motion.div>
              )}
              {activeTab === 'vision' && (
                <motion.div
                  key="vision"
                  role="tabpanel"
                  id="panel-vision"
                  aria-labelledby="tab-vision"
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.3, ease: 'easeInOut' }}
                  className="space-y-4"
                >
                  <QandAItem
                    q="איך אני רואה את בן/בת הזוג שלי?"
                    a="אדם עם לב פתוח, חוש הומור, ורצון אמיתי לצמוח יחד. מישהו שהוא גם החבר הכי טוב וגם השותף למסע."
                  />
                  <QandAItem
                    q="מה החזון שלי למשפחה?"
                    a="בית חם ותוסס, פתוח לאורחים, שבו ילדים גדלים עם ערכים של נתינה, אהבת תורה וארץ ישראל."
                  />
                </motion.div>
              )}
            </AnimatePresence>
          </div>

          {/* CTA - Updated Gradient Button */}
          <div className="mt-auto pt-4 text-center">
            <Link href={`/${locale}/auth/register`}>
              <Button
                size="lg"
                className="w-full bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group font-bold text-lg h-12"
              >
                <span className="relative z-10 flex items-center justify-center">
                  רוצים לקבל הצעות כאלה?
                  {locale === 'he' ? (
                    <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                  ) : (
                    <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                  )}{' '}
                </span>
              </Button>
            </Link>
          </div>
        </div>
      </div>
    </motion.div>
  );
};
--- End of Content for DemoProfileCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\FAQItem.tsx
--------------------------------------------------------------------------------
Content:

// src/components/HomePage/components/FAQItem.tsx

import React, { useState } from 'react';
import { ChevronDown } from 'lucide-react';

export interface FAQItemProps {
  question: string;
  answer: string;
}

// FAQ Item Component
const FAQItem: React.FC<FAQItemProps> = ({ question, answer }) => {
  const [isOpen, setIsOpen] = useState(false);

  // יצירת ID ייחודי עבור התוכן שייפתח
  const contentId = `faq-answer-${question.replace(/\s+/g, '-').toLowerCase()}`;

  return (
    <div className={`border-b border-gray-100 last:border-0 transition-colors duration-300 ${isOpen ? 'bg-orange-50/30' : 'bg-transparent'}`}>
      <button
        className={`flex justify-between items-center w-full py-5 px-2 text-right focus:outline-none transition-all duration-300 rounded-lg ${
          isOpen ? 'text-teal-700' : 'text-gray-700 hover:text-teal-600 hover:bg-gray-50'
        }`}
        onPointerDown={() => setIsOpen(!isOpen)}
        aria-expanded={isOpen}
        aria-controls={contentId}
      >
        <span className={`font-bold text-lg ${isOpen ? 'text-teal-700' : ''}`}>
          {question}
        </span>
        <span
          className={`transform transition-transform duration-300 p-1 rounded-full ${
            isOpen ? 'rotate-180 text-orange-500 bg-orange-100' : 'text-gray-400'
          }`}
        >
          <ChevronDown className="w-5 h-5" />
        </span>
      </button>
      <div
        id={contentId}
        hidden={!isOpen}
        className={`overflow-hidden transition-all duration-500 ease-in-out px-2 ${
          isOpen ? 'max-h-96 pb-6 opacity-100' : 'max-h-0 opacity-0'
        }`}
      >
        <p className="text-gray-600 leading-relaxed border-t border-dashed border-teal-100 pt-3 mt-1">
          {answer}
        </p>
      </div>
    </div>
  );
};

export default FAQItem;
--- End of Content for FAQItem.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\FeatureCard.tsx
--------------------------------------------------------------------------------
Content:

import React from "react";
import { Card, CardContent } from "@/components/ui/card";

// Type definitions
export interface FeatureCardProps {
  icon: React.ReactElement<{ className?: string }>;
  title: string;
  description: string;
  // שומרים על שמות המפתחות לתאימות, אך העיצוב בפועל ישתנה ל-Teal, Emerald, Orange, Rose
  color: "cyan" | "green" | "orange" | "pink";
}

// Component for feature cards with improved hover effects and new color palette
const FeatureCard: React.FC<FeatureCardProps> = ({
  icon,
  title,
  description,
  color,
}) => {
  const colorClasses = {
    // Cyan mapped to Teal (Primary Brand Color)
    cyan: {
      gradient: "from-teal-500/20 to-teal-700/20",
      bg: "from-teal-50 to-teal-100",
      text: "text-teal-600 group-hover:text-teal-700",
      title: "group-hover:text-teal-700",
      shadow: "shadow-teal-500/25",
      border: "border-teal-100",
    },
    // Green mapped to Emerald (Fresh look)
    green: {
      gradient: "from-emerald-500/20 to-emerald-700/20",
      bg: "from-emerald-50 to-emerald-100",
      text: "text-emerald-600 group-hover:text-emerald-700",
      title: "group-hover:text-emerald-700",
      shadow: "shadow-emerald-500/25",
      border: "border-emerald-100",
    },
    // Orange mapped to Orange/Amber (Warmth)
    orange: {
      gradient: "from-orange-500/20 to-amber-600/20",
      bg: "from-orange-50 to-amber-50",
      text: "text-orange-600 group-hover:text-orange-700",
      title: "group-hover:text-orange-700",
      shadow: "shadow-orange-500/25",
      border: "border-orange-100",
    },
    // Pink mapped to Rose (Matches Hero section accent)
    pink: {
      gradient: "from-rose-500/20 to-red-600/20",
      bg: "from-rose-50 to-red-50",
      text: "text-rose-600 group-hover:text-rose-700",
      title: "group-hover:text-rose-700",
      shadow: "shadow-rose-500/25",
      border: "border-rose-100",
    },
  };

  const currentStyle = colorClasses[color];

  return (
    <Card 
      className={`group relative overflow-hidden shadow-lg transition-all duration-500 hover:shadow-2xl hover:-translate-y-2 border ${currentStyle.border} bg-white/80 backdrop-blur-sm`}
    >
      {/* רקע בסיס */}
      <div className="absolute inset-0 bg-gradient-to-br from-white via-white to-slate-50 opacity-100 transition-opacity duration-500" />
      
      {/* רקע בריחוף - גלוס צבעוני */}
      <div
        className={`absolute -inset-1 bg-gradient-to-br ${currentStyle.gradient} opacity-0 group-hover:opacity-100 blur-xl transition-all duration-500`}
      />
      
      <CardContent className="relative p-8">
        <div className="mb-6 flex justify-center transform transition-transform duration-500 group-hover:scale-110">
          <div
            className={`p-4 rounded-2xl bg-gradient-to-br ${currentStyle.bg} shadow-md group-hover:shadow-lg transition-all duration-500 ${currentStyle.shadow} ring-1 ring-white/60`}
          >
            {React.cloneElement(icon, {
              className: `w-8 h-8 ${currentStyle.text} transition-colors duration-500`,
            })}
          </div>
        </div>
        <h3
          className={`text-xl font-bold mb-3 text-gray-800 ${currentStyle.title} transition-colors duration-300 text-center`}
        >
          {title}
        </h3>
        <p className="text-gray-600 leading-relaxed group-hover:text-gray-800 transition-colors duration-300 text-center">
          {description}
        </p>
      </CardContent>
    </Card>
  );
};

export default FeatureCard;
--- End of Content for FeatureCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\FooterComponents.tsx
--------------------------------------------------------------------------------
Content:

import React from "react";
import Link from "next/link";

// Helper component for footer links
export const FooterLink: React.FC<{
  href: string;
  children: React.ReactNode;
}> = ({ href, children }) => (
  <li className="transition-transform duration-300 hover:translate-x-1">
    <Link
      href={href}
      className="text-gray-400 hover:text-teal-400 transition-colors duration-300 flex items-center group"
    >
      <span className="ml-2 text-teal-600/0 group-hover:text-teal-500 transition-all duration-300 -translate-x-2 group-hover:translate-x-0">›</span>
      {children}
    </Link>
  </li>
);

// Helper component for footer items with icons
export const FooterItem: React.FC<{ icon: string; text: string }> = ({
  icon,
  text,
}) => (
  <li className="flex items-center group transition-transform duration-300 hover:translate-x-1">
    <span className="ml-2 text-teal-500/70 group-hover:text-orange-400 transition-colors duration-300">{icon}</span>
    <span className="text-gray-400 hover:text-white transition-colors duration-300">
      {text}
    </span>
  </li>
);
--- End of Content for FooterComponents.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\LiveSuggestionDemo.tsx
--------------------------------------------------------------------------------
Content:

'use client';

import React, { useState } from 'react';
import { ZoomIn } from 'lucide-react';
import MinimalSuggestionCard from '@/components/suggestions/cards/MinimalSuggestionCard';
import SuggestionDetailsModal from '@/components/suggestions/modals/SuggestionDetailsModal';
import type { ExtendedMatchSuggestion } from '@/components/suggestions/types';
import type { AiSuggestionAnalysisResult } from '@/lib/services/aiService';
import type {
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary';

// הגדרת טיפוס לתרגומי הדמו הספציפיים שנוספו
type SuggestionDemoDict = {
  hoverTitle: string;
  hoverSubtitle: string;
};

// עדכון הממשק של ה-props
interface LiveSuggestionDemoProps {
  suggestion: ExtendedMatchSuggestion;
  userId: string;
  demoAiAnalysis: AiSuggestionAnalysisResult | null;
  suggestionsDict: SuggestionsDictionary;
  profileCardDict: ProfileCardDict;
  suggestionDemoDict: SuggestionDemoDict;
  locale: 'he' | 'en';
}

/**
 * קומפוננטה להצגת הדגמה חיה של כרטיס הצעה והמודאל הנפתח ממנו.
 * עודכן לעיצוב התואם את ה-HeroSection (Teal/Orange palette).
 */
export const LiveSuggestionDemo: React.FC<LiveSuggestionDemoProps> = ({
  suggestion,
  userId,
  demoAiAnalysis,
  suggestionsDict,
  profileCardDict,
  locale,
  suggestionDemoDict,
}) => {
  const [isModalOpen, setIsModalOpen] = useState(false);

  const handleCloseModal = () => setIsModalOpen(false);
  const handleOpenModal = () => setIsModalOpen(true);

  const questionnaireData =
    suggestion.secondParty.questionnaireResponses?.[0] || null;

  return (
    <div className="w-full max-w-sm lg:max-w-md mx-auto flex flex-col items-center gap-4">
      {/*
       * ===================================================================
       * עדכון עיצובי:
       * 1. צללים (Shadows): הוחלפו לצללים צבעוניים (Teal/Orange) כדי להתאים ל-Hero.
       * 2. מסגרת (Border): נוספה מסגרת עדינה לבנה/שקופה למראה "זכוכית".
       * 3. פוקוס (Ring): עודכן לצבע Teal.
       * ===================================================================
       */}
      <div
        role="button"
        tabIndex={0}
        className="relative group cursor-pointer rounded-2xl overflow-hidden shadow-xl shadow-teal-900/5 hover:shadow-2xl hover:shadow-orange-500/20 transition-all duration-500 w-full focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-teal-500 border border-white/60 bg-white"
        onClick={handleOpenModal}
        onKeyDown={(e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleOpenModal();
          }
        }}
        aria-label={`הצג הצעה עבור ${suggestion.secondParty.firstName}`}
      >
        <MinimalSuggestionCard
          suggestion={suggestion}
          userId={userId}
          onClick={handleOpenModal}
          onInquiry={handleOpenModal}
          onApprove={handleOpenModal}
          onDecline={handleOpenModal}
          isApprovalDisabled={true}
          dict={suggestionsDict.card}
          locale={locale}
        />

        {/* 
         * שכבת הריחוף (Overlay) - עודכנה לגרדיאנט Teal עמוק ושקיפות 
         * במקום שחור פשוט, כדי להתאים לאווירה היוקרתית והנקייה של ה-Hero.
         */}
        <div className="absolute inset-0 bg-gradient-to-t from-teal-900/95 via-teal-800/60 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col items-center justify-center text-white p-4 pointer-events-none backdrop-blur-[2px]">
          {/* אייקון עם אנימציה קלה */}
          <div className="bg-white/10 p-3 rounded-full mb-3 backdrop-blur-sm border border-white/20 transform group-hover:scale-110 transition-transform duration-300">
            <ZoomIn className="w-10 h-10 text-white drop-shadow-md" />
          </div>
          
          <p className="font-bold text-xl text-center drop-shadow-sm">
            {suggestionDemoDict.hoverTitle}
          </p>
          <p className="text-sm text-center text-teal-50 mt-1 max-w-[80%] leading-relaxed">
            {suggestionDemoDict.hoverSubtitle}
          </p>
          
          {/* פס קישוט תחתון התואם לגרדיאנט של הכפתור הראשי */}
          <div className="mt-4 w-12 h-1 bg-gradient-to-r from-teal-400 via-orange-400 to-amber-400 rounded-full shadow-lg shadow-orange-500/30" />
        </div>
      </div>

      <SuggestionDetailsModal
        suggestion={suggestion}
        userId={userId}
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        onActionRequest={(suggestion, action) => {
          alert(
            `זוהי הדגמה בלבד. הפעולה המבוקשת היא "${action === 'approve' ? 'אישור' : 'דחייה'}" עבור ההצעה ל${suggestion.secondParty.firstName}. במערכת האמיתית, היה נפתח חלון אישור.`
          );
        }}
        questionnaire={questionnaireData}
        isDemo={true}
        demoAnalysisData={demoAiAnalysis}
        dict={{
          suggestions: suggestionsDict,
          profileCard: profileCardDict,
        }}
        locale={locale}
      />
    </div>
  );
};
--- End of Content for LiveSuggestionDemo.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\MatchmakerCard.tsx
--------------------------------------------------------------------------------
Content:
import React from "react";
import { Card, CardContent } from "@/components/ui/card";

export interface MatchmakerCardProps {
  name: string;
  role: string;
  description: string;
  color: "cyan" | "green" | "orange" | "pink";
}

// Matchmaker Card Component
const MatchmakerCard: React.FC<MatchmakerCardProps> = ({
  name,
  role,
  description,
  color,
}) => {
  // Mapping to new Palette:
  const colorClasses = {
    cyan: { // Maps to Teal
      gradient: "from-teal-500/10 to-teal-700/10",
      bg: "from-teal-400 to-teal-500",
      border: "border-teal-100",
      shadow: "shadow-teal-200/50",
      text: "text-teal-700",
    },
    green: { // Maps to Emerald
      gradient: "from-emerald-500/10 to-emerald-700/10",
      bg: "from-emerald-400 to-emerald-500",
      border: "border-emerald-100",
      shadow: "shadow-emerald-200/50",
      text: "text-emerald-700",
    },
    orange: { // Maps to Orange/Amber
      gradient: "from-orange-500/10 to-amber-700/10",
      bg: "from-orange-400 to-amber-500",
      border: "border-orange-100",
      shadow: "shadow-orange-200/50",
      text: "text-orange-700",
    },
    pink: { // Maps to Rose
      gradient: "from-rose-500/10 to-rose-700/10",
      bg: "from-rose-400 to-rose-500",
      border: "border-rose-100",
      shadow: "shadow-rose-200/50",
      text: "text-rose-700",
    },
  };

  return (
    <Card className="group relative overflow-hidden bg-white/80 backdrop-blur-sm border border-gray-100 hover:border-transparent shadow-sm hover:shadow-2xl transition-all duration-500 rounded-2xl h-full">
      {/* Hover Glow Effect */}
      <div
        className={`absolute -inset-1 bg-gradient-to-br ${colorClasses[color].gradient} opacity-0 group-hover:opacity-100 rounded-2xl blur-xl transition-all duration-500`}
      />
      
      <CardContent className="relative p-8 flex flex-col items-center text-center z-10">
        {/* Avatar */}
        <div
          className={`w-24 h-24 rounded-2xl rotate-3 group-hover:rotate-0 bg-gradient-to-br ${colorClasses[color].bg} flex items-center justify-center text-white text-3xl font-bold mb-6 ${colorClasses[color].shadow} shadow-lg transform group-hover:scale-110 transition-all duration-500 ease-out`}
        >
          {name.charAt(0)}
        </div>
        
        <h3 className="text-2xl font-bold mb-2 text-gray-800">{name}</h3>
        <p className={`text-sm font-semibold uppercase tracking-wider mb-4 ${colorClasses[color].text}`}>
          {role}
        </p>
        
        {/* Divider */}
        <div className={`w-16 h-1 bg-gradient-to-r ${colorClasses[color].bg} rounded-full mb-5 opacity-80`}></div>
        
        <p className="text-gray-600 text-base leading-relaxed">
          {description}
        </p>
      </CardContent>
    </Card>
  );
};

export default MatchmakerCard;
--- End of Content for MatchmakerCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\Step.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/Step.tsx
import React from "react";

export interface StepProps {
  number: string;
  title: string;
  description: React.ReactNode;
  isLast?: boolean;
  // עדכון: החלפתי את purple ב-orange כדי להתאים לקריאה מ-HowItWorksSection
  color: "teal" | "amber" | "rose" | "orange";
}

// Modernized Step Component with enhanced visuals matching the Landing Page theme
const Step: React.FC<StepProps> = ({
  number,
  title,
  description,
  isLast = false,
  color,
}) => {
  const colorClasses = {
    teal: {
      gradient: "from-teal-400 to-emerald-500",
      hover: "group-hover:text-teal-700",
      border: "group-hover:border-teal-200",
      shadow: "group-hover:shadow-teal-100",
      line: "from-teal-400 to-teal-200",
      bgBadge: "bg-teal-50",
    },
    amber: {
      gradient: "from-amber-400 to-orange-500",
      hover: "group-hover:text-amber-700",
      border: "group-hover:border-amber-200",
      shadow: "group-hover:shadow-amber-100",
      line: "from-amber-400 to-amber-200",
      bgBadge: "bg-amber-50",
    },
    rose: {
      gradient: "from-rose-400 to-pink-500",
      hover: "group-hover:text-rose-700",
      border: "group-hover:border-rose-200",
      shadow: "group-hover:shadow-rose-100",
      line: "from-rose-400 to-rose-200",
      bgBadge: "bg-rose-50",
    },
    // כאן הוספתי את orange במקום purple
    orange: {
      gradient: "from-orange-400 to-red-500",
      hover: "group-hover:text-orange-700",
      border: "group-hover:border-orange-200",
      shadow: "group-hover:shadow-orange-100",
      line: "from-orange-400 to-orange-200",
      bgBadge: "bg-orange-50",
    },
  };

  const currentStyle = colorClasses[color];

  return (
    <div className="flex gap-6 items-start group relative">
      {/* Connecting line between steps */}
      {!isLast && (
        <div
          // הערה: אם האתר בעברית (RTL), הקו צריך להיות ממוקם בצד ימין.
          // right-6 מותאם למרכז העיגול שרוחבו 12 (3rem -> אמצע 1.5rem/24px = right-6)
          className={`absolute top-12 bottom-0 right-6 w-0.5 bg-gradient-to-b ${currentStyle.line} rounded-full opacity-40`}
        />
      )}

      {/* Number Circle */}
      <div
        className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${currentStyle.gradient} text-white flex items-center justify-center flex-shrink-0 text-lg font-bold shadow-lg group-hover:scale-110 ${currentStyle.shadow} transition-all duration-500 z-10 relative`}
      >
        {number}
        {/* Glow effect behind the number */}
        <div className={`absolute inset-0 rounded-2xl blur opacity-40 bg-gradient-to-br ${currentStyle.gradient} -z-10`} />
      </div>

      {/* Content Card */}
      <div
        className={`flex-1 bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-sm group-hover:shadow-lg transition-all duration-300 border border-white/60 ${currentStyle.border}`}
      >
        <h3
          className={`text-xl font-bold mb-3 text-gray-800 ${currentStyle.hover} transition-colors duration-300`}
        >
          {title}
        </h3>
        <div className="text-gray-600 leading-relaxed group-hover:text-gray-700">
          {description}
        </div>
      </div>
    </div>
  );
};

export default Step;
--- End of Content for Step.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\StickyNav.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/StickyNav.tsx

'use client';

import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { UserPlus, Menu, X } from 'lucide-react';
import { cn } from '@/lib/utils';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import { signOut } from 'next-auth/react';
import type { Session } from 'next-auth';
import type { UserImage } from '@/types/next-auth';
import UserDropdown from '@/components/layout/UserDropdown';
import type { StickyNavDict } from '@/types/dictionary';

export interface NavLink {
  id: string;
  label: string;
}

interface StickyNavProps {
  locale: 'he' | 'en';
  navLinks: NavLink[];
  session: Session | null;
  isVisible: boolean;
  dict: StickyNavDict;
}

// ======================== קומפוננטת הלוגו ========================
const StickyLogo = ({ homepageAriaLabel }: { homepageAriaLabel: string }) => {
  return (
    <Link
      href="/"
      className="hidden md:flex items-center gap-x-3 group shrink-0"
      aria-label={homepageAriaLabel}
    >
      <div className="relative h-10 w-10">
        <Image
          src={getRelativeCloudinaryPath(
            'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png'
          )}
          alt="NeshamaTech Icon"
          fill
          className="object-contain transition-transform duration-500 group-hover:scale-110 group-hover:rotate-6"
          priority
        />
      </div>
      <span
        className="
        text-2xl
        font-bold
        tracking-tight
        bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500
        text-transparent bg-clip-text
        bg-size-200 bg-pos-0 group-hover:bg-pos-100
        transition-all duration-700 ease-in-out
      "
      >
        NeshamaTech
      </span>
    </Link>
  );
};
// ========================================================================

const StickyNav: React.FC<StickyNavProps> = ({
  navLinks,
  session,
  isVisible,
  dict,
  locale,
}) => {
  const [activeSection, setActiveSection] = useState('');
  const sectionRefs = useRef<(HTMLElement | null)[]>([]);
  const [mobileNavState, setMobileNavState] = useState<'open' | 'closed'>(
    'open'
  );
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    if (typeof window === 'undefined') return;

    setIsMobile(window.innerWidth < 768);

    sectionRefs.current = navLinks.map((link) =>
      document.getElementById(link.id)
    );

    const handleScroll = () => {
      const currentScrollY = window.scrollY;
      const navHeight = isMobile ? 64 : 80;
      const triggerPoint = currentScrollY + navHeight + 40;

      let currentSection = '';

      for (let i = sectionRefs.current.length - 1; i >= 0; i--) {
        const section = sectionRefs.current[i];
        if (section && section.offsetTop <= triggerPoint) {
          currentSection = navLinks[i].id;
          break;
        }
      }

      setActiveSection(currentSection);
    };

    const handleResize = () => setIsMobile(window.innerWidth < 768);

    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleResize);
    handleScroll();
    handleResize();

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('resize', handleResize);
    };
  }, [navLinks, isMobile]);

  const handleLinkClick = (
    e: React.PointerEvent<HTMLAnchorElement>,
    href: string
  ) => {
    e.preventDefault();

    const element = document.querySelector(href);
    if (element) {
      const navHeight = isMobile ? 64 : 80;
      const topOffset = isMobile ? 80 : 0;
      const padding = 30;
      const headerOffset = navHeight + topOffset + padding;

      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition =
        elementPosition + window.pageYOffset - headerOffset;
      window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    }
  };

  const isNavOpen = mobileNavState === 'open';
  const navVariants = {
    hidden: { y: '-120%', opacity: 0 },
    visible: { y: 0, opacity: 1 },
  };

  const handleSignOut = () => {
    signOut({ callbackUrl: '/' });
  };

  const getInitials = () => {
    const fullName = session?.user?.name;
    if (!fullName) return 'P';
    const names = fullName.split(' ');
    return (
      (names[0]?.[0] || '') +
      (names.length > 1 ? names[names.length - 1]?.[0] || '' : '')
    ).toUpperCase();
  };

  const getMainProfileImage = (): UserImage | null => {
    if (session?.user?.image) {
      return {
        id: 'session-image',
        url: session.user.image,
        isMain: true,
        userId: session.user.id,
        createdAt: new Date(),
        updatedAt: new Date(),
        cloudinaryPublicId: null,
      };
    }
    return null;
  };

  const mainProfileImage = getMainProfileImage();
  const profileIconSize = 'w-10 h-10';

  return (
    <>
      <AnimatePresence>
        {isVisible && (
          <motion.header
            variants={navVariants}
            initial="hidden"
            animate={isMobile ? (isNavOpen ? 'visible' : 'hidden') : 'visible'}
            exit="hidden"
            transition={{ duration: 0.3, ease: 'easeOut' }}
            className="fixed top-0 left-0 right-0 z-40 w-full h-16 md:h-20"
          >
            {/* Background: Glassmorphism with subtle Teal tint */}
            <div className="absolute inset-0 bg-white/90 backdrop-blur-xl shadow-sm border-b border-teal-50/50 supports-[backdrop-filter]:bg-white/80"></div>

            <div className="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
              <StickyLogo homepageAriaLabel={dict.homepageAriaLabel} />

              <nav className="hidden md:flex items-center gap-1 relative">
                {navLinks.map((link) => (
                  <a
                    key={link.id}
                    href={`#${link.id}`}
                    onPointerDown={(e) => handleLinkClick(e, `#${link.id}`)}
                    className={cn(
                      'relative px-5 py-2.5 rounded-full text-sm transition-all duration-300',
                      activeSection === link.id
                        ? 'font-bold text-teal-700' // Active
                        : 'font-medium text-gray-600 hover:text-teal-600 hover:bg-teal-50/50' // Hover
                    )}
                  >
                    {activeSection === link.id && (
                      <motion.div
                        layoutId="active-nav-link"
                        className="absolute inset-0 bg-gradient-to-r from-teal-50 to-orange-50/50 rounded-full z-0 border border-teal-100/50"
                        transition={{
                          type: 'spring',
                          stiffness: 300,
                          damping: 30,
                        }}
                      />
                    )}
                    <span className="relative z-10">{link.label}</span>
                  </a>
                ))}
              </nav>

              <div className="flex md:hidden items-center justify-between w-full">
                <nav className="flex-grow overflow-x-auto scrollbar-hide">
                  <div className="flex items-center gap-2 px-1">
                    {navLinks.map((link) => (
                      <a
                        key={link.id}
                        href={`#${link.id}`}
                        onPointerDown={(e) => handleLinkClick(e, `#${link.id}`)}
                        className={cn(
                          'relative px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0',
                          activeSection === link.id
                            ? 'font-bold text-teal-700 bg-teal-100/50 border border-teal-200/30'
                            : 'font-medium text-gray-600 hover:text-teal-600 hover:bg-teal-50/50'
                        )}
                      >
                        {link.label}
                      </a>
                    ))}
                  </div>
                </nav>
                <div className="pl-2">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="rounded-full text-gray-500 hover:bg-gray-100 hover:text-teal-600"
                    onClick={() => setMobileNavState('closed')}
                    aria-label={dict.closeNavAriaLabel}
                  >
                    <X className="h-5 w-5" />
                  </Button>
                </div>
              </div>

              <div className="hidden md:flex items-center gap-3">
                {session ? (
                  <UserDropdown
                    session={session}
                    mainProfileImage={mainProfileImage}
                    getInitials={getInitials}
                    handleSignOut={handleSignOut}
                    profileIconSize={profileIconSize}
                    locale={locale}
                  />
                ) : (
                  <Link href="/auth/register">
                    <Button className="group relative overflow-hidden bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 px-7 py-6">
                      <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></span>
                      <span className="relative z-10 flex items-center font-bold text-base">
                        <UserPlus className="mr-2 h-5 w-5" />
                        {dict.signUpButton}
                      </span>
                    </Button>
                  </Link>
                )}
              </div>
            </div>
          </motion.header>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {isMobile && isVisible && !isNavOpen && (
          <motion.div
            initial={{ scale: 0, opacity: 0, y: 50 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            exit={{ scale: 0, opacity: 0, y: 50 }}
            transition={{ type: 'spring', stiffness: 500, damping: 30 }}
            className="fixed bottom-32 left-4 z-50"
          >
            <Button
              size="icon"
              className="rounded-full h-14 w-14 bg-gradient-to-br from-teal-500 to-teal-600 text-white shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-300 border-2 border-white/20"
              onClick={() => setMobileNavState('open')}
              aria-label={dict.openNavAriaLabel}
            >
              <Menu className="h-7 w-7" />
            </Button>
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
};

export default StickyNav;
--- End of Content for StickyNav.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\TestimonialCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/TestimonialCard.tsx

import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Heart } from 'lucide-react';

export interface TestimonialCardProps {
  text: string;
  author: string;
  result?: string;
  color: 'cyan' | 'green' | 'orange' | 'pink';
}

const TestimonialCard: React.FC<TestimonialCardProps> = ({
  text,
  author,
  result,
  color,
}) => {
  // Mapping old prop names to new Palette:
  // cyan -> Teal (Hero primary)
  // green -> Emerald (Growth/Success)
  // orange -> Orange/Amber (Hero secondary)
  // pink -> Rose (Warmth/Emotion)
  const colorClasses = {
    cyan: {
      gradient1: 'from-teal-100/80 to-teal-50/50',
      gradient2: 'from-teal-50/50 to-teal-100/80',
      avatar: 'from-teal-500 to-teal-600',
      result: 'text-teal-600',
      iconBg: 'bg-teal-50',
    },
    green: {
      gradient1: 'from-emerald-100/80 to-emerald-50/50',
      gradient2: 'from-emerald-50/50 to-emerald-100/80',
      avatar: 'from-emerald-500 to-emerald-600',
      result: 'text-emerald-600',
      iconBg: 'bg-emerald-50',
    },
    orange: {
      gradient1: 'from-orange-100/80 to-amber-50/50',
      gradient2: 'from-amber-50/50 to-orange-100/80',
      avatar: 'from-orange-500 to-orange-600',
      result: 'text-orange-600',
      iconBg: 'bg-orange-50',
    },
    pink: {
      gradient1: 'from-rose-100/80 to-pink-50/50',
      gradient2: 'from-pink-50/50 to-rose-100/80',
      avatar: 'from-rose-500 to-rose-600',
      result: 'text-rose-600',
      iconBg: 'bg-rose-50',
    },
  };

  return (
    <Card className="group relative overflow-hidden border border-white/60 bg-white/70 backdrop-blur-md shadow-lg hover:shadow-2xl hover:border-teal-100 transition-all duration-500 h-full rounded-2xl">
      {/* Background Orbs */}
      <div
        className={`absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br ${colorClasses[color].gradient1} opacity-60 rounded-full blur-2xl transition-all duration-500 group-hover:scale-110`}
      />
      <div
        className={`absolute -bottom-10 -left-10 w-32 h-32 bg-gradient-to-br ${colorClasses[color].gradient2} opacity-40 rounded-full blur-2xl transition-all duration-500 group-hover:scale-110`}
      />

      <CardContent className="relative p-8 h-full flex flex-col z-10">
        {/* Quote Icon */}
        <div
          aria-hidden="true"
          className="mb-4 text-5xl font-serif text-gray-200/80 group-hover:text-gray-300 transition-colors duration-300"
        >
          ❝
        </div>
        
        <p className="text-gray-700 leading-relaxed text-lg mb-8 flex-grow font-medium">
          {text}
        </p>

        <div className="flex flex-col mt-auto">
          <div className="flex items-center gap-3">
            <div
              aria-hidden="true"
              className={`w-12 h-12 rounded-full bg-gradient-to-br ${colorClasses[color].avatar} flex items-center justify-center text-white text-lg font-bold shadow-md transform group-hover:scale-105 transition-transform duration-300`}
            >
              {author[0]}
            </div>
            <div>
              <p className="font-bold text-gray-800 text-base">{author}</p>
              {result && (
                <div
                  className={`mt-1 text-xs font-semibold ${colorClasses[color].result} flex items-center gap-1`}
                >
                   <Heart className="w-3 h-3 fill-current" />
                   <span>{result}</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default TestimonialCard;
--- End of Content for TestimonialCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\demo-data.ts
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/demo-data.ts

import type { Locale } from '../../../../i18n-config';
import type { ExtendedMatchSuggestion, PartyInfo } from '@/components/suggestions/types';
import type { QuestionnaireResponse as QuestionnaireResponseType } from '@/types/next-auth';
import type { AiSuggestionAnalysisResult } from '@/lib/services/aiService';
import { ReligiousJourney, ServiceType, Gender, AvailabilityStatus, KippahType, TestimonialStatus, SubmissionSource } from '@prisma/client';

const getDemoContent = async (locale: Locale) => {
  if (locale === 'en') {
    return await import('./demo-content/en');
  }
  return await import('./demo-content/he');
};

export const generateDemoData = async (locale: Locale) => {
  const content = await getDemoContent(locale);
  const { femaleProfileContent, maleProfileContent, suggestionContent, aiAnalysisContent, matchmakerContent } = content;
  const isHebrew = locale === 'he';

  const noaQuestionnaireResponse: QuestionnaireResponseType = {
    id: 'qr-demo-noa-updated', userId: 'demo-profile-noa',
    personalityAnswers: {}, 
    valuesAnswers: {},
    relationshipAnswers: {},
    partnerAnswers: {},
    religionAnswers: {},
    valuesCompleted: true, personalityCompleted: true, relationshipCompleted: true, partnerCompleted: true, religionCompleted: true,
    worldsCompleted: ['VALUES', 'RELATIONSHIP', 'PARTNER', 'PERSONALITY', 'RELIGION'],
    completed: true, startedAt: new Date(), completedAt: new Date(), lastSaved: new Date(), createdAt: new Date(), updatedAt: new Date(),
    formattedAnswers: femaleProfileContent.formattedAnswers,
        currentQuestionIndices: {
      PERSONALITY: 0,
      VALUES: 0,
      RELATIONSHIP: 0,
      PARTNER: 0,
      RELIGION: 0,
    },

  };

  const danielQuestionnaireResponse: QuestionnaireResponseType = {
    id: 'qr-demo-daniel-updated', userId: 'demo-profile-daniel',
    personalityAnswers: {},
    valuesAnswers: {},
    relationshipAnswers: {},
    partnerAnswers: {},
    religionAnswers: {},
    valuesCompleted: true, personalityCompleted: true, relationshipCompleted: true, partnerCompleted: true, religionCompleted: true,
    worldsCompleted: ['VALUES', 'PERSONALITY', 'PARTNER', 'RELATIONSHIP', 'RELIGION'],
    completed: true, startedAt: new Date(), completedAt: new Date(), lastSaved: new Date(), createdAt: new Date(), updatedAt: new Date(),
    formattedAnswers: maleProfileContent.formattedAnswers,
    currentQuestionIndices: {
      PERSONALITY: 0,
      VALUES: 0,
      RELATIONSHIP: 0,
      PARTNER: 0,
      RELIGION: 0,
    },
  };
  
  const noaProfile: PartyInfo = {
    id: 'demo-profile-noa', email: 'noa.demo@example.com', firstName: femaleProfileContent.firstName, lastName: femaleProfileContent.lastName, isProfileComplete: true,
    images: [
        { id: 'img1', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967771/IMG-20250731-WA0077_ekb71p.jpg', isMain: true, userId: 'demo-profile-noa', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
        { id: 'img2', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967772/IMG-20250731-WA0078_l5mhu1.jpg', isMain: false, userId: 'demo-profile-noa', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
        { id: 'img3', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967770/IMG-20250731-WA0076_wy6uhe.jpg', isMain: false, userId: 'demo-profile-noa', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
    ],
    profile: {
      id: 'profile-noa-demo', userId: 'demo-profile-noa', gender: Gender.FEMALE, birthDate: new Date('1996-05-15T00:00:00.000Z'), height: 168, maritalStatus: 'רווקה',
      occupation: femaleProfileContent.occupation, education: femaleProfileContent.education, city: femaleProfileContent.city, religiousLevel: 'דתי-לאומי ליברלי',
      shomerNegiah: false, serviceType: ServiceType.NATIONAL_SERVICE_TWO_YEARS, serviceDetails: femaleProfileContent.serviceDetails, about: femaleProfileContent.about,
      profileHeadline: femaleProfileContent.profileHeadline, birthDateIsApproximate: false, nativeLanguage: 'עברית', educationLevel: 'תואר ראשון', origin: 'מעורב (אשכנזי-מזרחי)',
      religiousJourney: ReligiousJourney.BORN_INTO_CURRENT_LIFESTYLE, additionalLanguages: ['אנגלית'], hasChildrenFromPrevious: false, createdAt: new Date(), updatedAt: new Date(),
      headCovering: null, kippahType: null, 
      manualEntryText: isHebrew 
        ? 'נועה היא שילוב קסום של נפש אמנית, יצירתיות מתפרצת ולב רחב וקשוב. היא אישה שרואה את היופי בפרטים הקטנים של החיים, ומביאה איתה אופטימיות וחום לכל מקום אליו היא מגיעה.\n\nהמסע שלה שזור בחיבור עמוק לאנשים וליוצרים. החל משירות לאומי משמעותי עם ילדים בעלי צרכים מיוחדים, דרך לימודים במדרשה ועד לקריירה מצליחה כמעצבת, נועה היא אדם שמוצא משמעות בנתינה ובביטוי אישי. היא אשת שיחה מרתקת, אך גם יודעת להעריך את השקט והטבע.\n\nכעת, היא מחפשת שותף אמיתי לדרך, אדם עם טוב לב וראש פתוח, לבנות יחד בית שיהווה מרחב בטוח לצמיחה, לשיחות עומק אל תוך הלילה, ולצחוק פשוט ומתגלגל. היא שואפת לקשר המבוסס על כבוד הדדי, חברות אמת ותקשורת כנה.\n\nאנו ב-NeshamaTech רואים בנועה אישה איכותית ומרשימה, עם עומק ורגישות שנדיר למצוא.'
        : 'Noa is a captivating blend of an artist\'s soul, boundless creativity, and a deeply attentive heart. She is a woman who sees the beauty in life\'s small details and brings optimism and warmth wherever she goes.\n\nHer journey is woven from a deep connection to people and creativity. From her meaningful national service with children with special needs, through her studies at a Midrasha, to a successful career as a designer, Noa is someone who finds meaning in giving and in personal expression. She is an engaging conversationalist who also appreciates quiet, nature, and introspection.\n\nShe is now looking for a true partner for the journey—a person with kindness and an open mind, to build a home that is a safe space for growth, for deep conversations into the night, and for simple, rolling laughter. She aspires to a relationship founded on mutual respect, true friendship, and honest communication.\n\nWe at NeshamaTech see Noa as a remarkable and high-quality woman, with a depth and sensitivity that are truly rare.',
      profileCharacterTraits: ['optimistic', 'creative', 'empathetic'], profileHobbies: ['travel', 'reading', 'art_crafts'],
      aliyaCountry: null, aliyaYear: null,  
      inspiringCoupleStory: isHebrew ? 'ההורים שלי. הם מגיעים מעולמות שונים לגמרי - אבא איש כספים ריאלי ואמא אמנית ויוצרת - והם הצליחו לבנות שותפות מדהימה שמבוססת על כבוד, השלמה הדדית והמון חוש הומור. הם ההוכחה שלי שאהבה אמיתית היא גשר בין עולמות.' : 'My parents. They come from completely different worlds - my dad is a rational finance guy and my mom is an artist and creator - yet they managed to build an amazing partnership based on respect, complementing each other, and a lot of humor. They are my proof that true love bridges worlds.',
      influentialRabbi: 'הרבנית ימימה מזרחי',
      parentStatus: 'נשואים באושר', fatherOccupation: 'יועץ פיננסי', motherOccupation: 'אמנית ובעלת סטודיו לקרמיקה', siblings: 2, position: 2,
      hasMedicalInfo: false, isMedicalInfoVisible: false, medicalInfoDetails: null, medicalInfoDisclosureTiming: null, preferredAgeMin: 28, preferredAgeMax: 35,
      preferredHeightMin: 175, preferredHeightMax: 190, 
      // --- START: עדכון ערכים ---
      preferredReligiousLevels: ['דתי-לאומי ליברלי', 'דתי-לאומי תורני', 'דתי-לאומי סטנדרטי'], 
      preferredLocations: ['תל אביב', 'רמת גן', 'גבעתיים', 'ירושלים'],
      preferredEducation: ['תואר ראשון', 'תואר שני'], 
      preferredOccupations: ['הייטק', 'הנדסה', 'חינוך', 'מחקר'],
      preferredOrigins: ['אנגלו-סקסי', 'מעורב', 'צפון אפריקאי'],
      // --- END: עדכון ערכים ---
      contactPreference: 'both', preferredMaritalStatuses: ['רווק/ה'],
      preferredShomerNegiah: 'flexible', preferredPartnerHasChildren: 'no_preferred', preferredServiceTypes: [], preferredHeadCoverings: [],
      preferredKippahTypes: [], preferredCharacterTraits: [], preferredHobbies: [], preferredAliyaStatus: 'no_preference', preferredReligiousJourneys: [],
      isProfileVisible: true, preferredMatchmakerGender: null, matchingNotes: '', verifiedBy: null, availabilityStatus: AvailabilityStatus.AVAILABLE,
      availabilityNote: null, availabilityUpdatedAt: null, lastActive: null, hasViewedProfilePreview: false, needsAiProfileUpdate: false,
      isAboutVisible: true,
      isFriendsSectionVisible: true,
      isNeshamaTechSummaryVisible: true,
       cvUrl: null,
      cvSummary: null,
      testimonials: [
        {
          id: 'testimonial-noa-1',
          authorName: isHebrew ? 'יעל כהן' : 'Yael Cohen',
          relationship: isHebrew ? 'חברת ילדות' : 'Childhood Friend',
          content: isHebrew ? 'אני מכירה את נועה מאז שהיינו ילדות, ותמיד הערצתי את היכולת שלה לראות את היופי בכל דבר. היא החברה הזאת שתמיד תקשיב עד הסוף, תיתן את העצה הכי אמיתית, ואז תגרום לך לצחוק עד שיכאב. הלב הענק שלה והאופטימיות המדבקת שלה הם מתנה לכל מי שסביבה.' : 'I\'ve known Noa since we were kids, and I\'ve always admired her ability to see the beauty in everything. She\'s that friend who will always listen until the very end, give the most genuine advice, and then make you laugh until it hurts. Her huge heart and contagious optimism are a gift to everyone around her.',
          isPhoneVisibleToMatch: false,
          status: TestimonialStatus.APPROVED,
          submittedBy: SubmissionSource.FRIEND,
          createdAt: new Date(),
        },
        {
          id: 'testimonial-noa-2',
          authorName: isHebrew ? 'דוד לוי' : 'David Levi',
          relationship: isHebrew ? 'קולגה לשעבר' : 'Former Colleague',
          content: isHebrew ? 'עבדתי עם נועה על מספר פרויקטים. מעבר לכישרון העיצובי המדהים שלה, יש לה אינטליגנציה רגשית נדירה. היא יודעת להוביל, אבל תמיד בעדינות ובכבוד, וליצור סביבה שבה כולם מרגישים שותפים. היא מקצוענית אמיתית עם נשמה של אמנית.' : 'I worked with Noa on several projects. Beyond her amazing design talent, she has a rare emotional intelligence. She knows how to lead, but always with gentleness and respect, creating an environment where everyone feels like a partner. She is a true professional with an artist\'s soul.',
          isPhoneVisibleToMatch: false,
          status: TestimonialStatus.APPROVED,
          submittedBy: SubmissionSource.FRIEND,
          createdAt: new Date(),
        },
      ],
    },
    questionnaireResponses: [noaQuestionnaireResponse],
  };

  const danielProfile: PartyInfo = {
    id: 'demo-profile-daniel', email: 'daniel.demo@example.com', firstName: maleProfileContent.firstName, lastName: maleProfileContent.lastName, isProfileComplete: true,
    images: [
        { id: 'img1m', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967649/IMG-20250731-WA0059_mqskdw.jpg', isMain: true, userId: 'demo-profile-daniel', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
        { id: 'img2m', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967649/IMG-20250731-WA0060_ia8nka.jpg', isMain: false, userId: 'demo-profile-daniel', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
        { id: 'img3m', url: 'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967649/IMG-20250731-WA0061_aug5ix.jpg', isMain: false, userId: 'demo-profile-daniel', createdAt: new Date(), updatedAt: new Date(), cloudinaryPublicId: null },
    ],
    profile: {
      id: 'profile-daniel-demo', userId: 'demo-profile-daniel', gender: Gender.MALE, birthDate: new Date('1994-08-20T00:00:00.000Z'), height: 182, maritalStatus: 'רווק',
      occupation: maleProfileContent.occupation, education: maleProfileContent.education, city: maleProfileContent.city, religiousLevel: 'דתי-לאומי תורני',
      shomerNegiah: true, serviceType: ServiceType.MILITARY_OFFICER, serviceDetails: maleProfileContent.serviceDetails, about: maleProfileContent.about, profileHeadline: maleProfileContent.profileHeadline,
      birthDateIsApproximate: false, nativeLanguage: 'עברית', additionalLanguages: ['אנגלית'], educationLevel: 'תואר ראשון', origin: 'אנגלו-סקסי',
      religiousJourney: ReligiousJourney.BORN_INTO_CURRENT_LIFESTYLE, kippahType: KippahType.KNITTED_SMALL, hasChildrenFromPrevious: false, createdAt: new Date(), updatedAt: new Date(),
      headCovering: null, 
      manualEntryText: isHebrew 
        ? 'דניאל הוא איש של חיבורים מרתקים: בין קוד לוגי לעומק של סוגיה תלמודית, ובין אחריות של קצין קרבי לניגון חסידי מלא נשמה. הוא אדם המשלב רצינות, אמינות ושאיפה למצוינות בכל תחום בחייו.\n\nהמסלול שלו משקף אדם המשלב עשייה ומשמעות. שירותו כקצין בהנדסה קרבית עיצב בו תחושת אחריות עמוקה, בעוד שלימודיו בישיבת הר עציון ובטכניון חידדו את יכולותיו האנליטיות ואת חיבורו לעולם התורה. הוא אדם שנמצא בצמיחה מתמדת, הן אינטלקטואלית והן רוחנית.\n\nהוא שואף לבנות בית של תורה ושמחה, המבוסס על שותפות אמת, צמיחה הדדית ופתיחות מחשבתית. הוא מחפש אישה אינטליגנטית וערכית, שתהיה לו חברה לשיח, שותפה לאתגרים, וביחד יבנו עולם מלא בטוב ובמשמעות.\n\nב-NeshamaTech, אנו מתרשמים מהשילוב הנדיר של רצינות, עומק תורני ויכולת ביצוע שדניאל מביא עמו.'
        : 'Daniel is a man of compelling connections: between logical code and the depth of a Talmudic passage, and between the responsibility of a combat officer and a soulful Hasidic melody. He is a person who combines seriousness, reliability, and a drive for excellence in every area of his life.\n\nHis path reflects a man who merges action with meaning. His service as an officer in the Combat Engineering Corps instilled in him a profound sense of responsibility, while his studies at Yeshivat Har Etzion and the Technion sharpened his analytical abilities and his connection to the world of Torah. He is a person in constant growth, both intellectually and spiritually.\n\nHe seeks to build a home of Torah and joy, founded on a true partnership, mutual growth, and open-mindedness. He is looking for an intelligent and value-driven woman to be his partner in conversation and in challenges, to build a world filled with goodness and meaning together.\n\nAt NeshamaTech, we are impressed by the rare blend of seriousness, Torah depth, and practical ability that Daniel embodies.',
      profileCharacterTraits: ['driven', 'honest', 'family_oriented'], profileHobbies: ['travel', 'music_playing_instrument'],
      aliyaCountry: 'ארה"ב', aliyaYear: 2004, 
      inspiringCoupleStory: isHebrew ? 'הסבים והסבתות שלי, שעלו לארץ מארה"ב מתוך אידיאלים ציוניים ובנו כאן חיים לתפארת. החיבור העמוק שלהם למסורת היהודית, יחד עם המחויבות שלהם לבניית המדינה והקהילה, והשותפות החמה והאוהבת ביניהם, הם המצפן שמנחה אותי.' : 'My grandparents, who made Aliyah from the US out of Zionist ideals and built a wonderful life here. Their deep connection to Jewish tradition, combined with their commitment to building the state and the community, and their warm and loving partnership, are the compass that guides me.',
      influentialRabbi: 'הרב זקס זצ"ל',
      parentStatus: 'נשואים', fatherOccupation: 'מהנדס תוכנה', motherOccupation: 'רופאת משפחה', siblings: 3, position: 2,
      hasMedicalInfo: false, isMedicalInfoVisible: false, medicalInfoDetails: null, medicalInfoDisclosureTiming: null, preferredAgeMin: 26, preferredAgeMax: 32,
      preferredHeightMin: 160, preferredHeightMax: 175, 
      // --- START: עדכון ערכים ---
      preferredReligiousLevels: ['דתי-לאומי תורני', 'דתי-לאומי סטנדרטי'], 
      preferredLocations: ['ירושלים', 'גוש עציון', 'מודיעין'],
      preferredEducation: ['תואר ראשון', 'תואר שני'],
      preferredOccupations: ['עיצוב', 'אמנות', 'חינוך', 'טיפול'],
      preferredOrigins: [], // פתוח לכל המוצאים
      // --- END: עדכון ערכים ---
      contactPreference: 'matchmaker', preferredMaritalStatuses: ['רווק/ה'],
      preferredShomerNegiah: 'yes', preferredPartnerHasChildren: 'no_preferred', preferredServiceTypes: [], preferredHeadCoverings: [],
      preferredKippahTypes: [], preferredCharacterTraits: [], preferredHobbies: [], preferredAliyaStatus: 'no_preference', preferredReligiousJourneys: [],
      isProfileVisible: true, preferredMatchmakerGender: null, matchingNotes: '', verifiedBy: null, availabilityStatus: AvailabilityStatus.AVAILABLE,
      availabilityNote: null, availabilityUpdatedAt: null, lastActive: null, hasViewedProfilePreview: false, needsAiProfileUpdate: false,
      isAboutVisible: true,
      isFriendsSectionVisible: true,
      isNeshamaTechSummaryVisible: true,
       cvUrl: null,
      cvSummary: null,
      testimonials: [
        {
          id: 'testimonial-daniel-1',
          authorName: isHebrew ? 'איתי שרמן' : 'Itai Sherman',
          relationship: isHebrew ? 'חבר מהצבא' : 'Army Buddy',
          content: isHebrew ? 'שירתתי עם דניאל כקצינים. הוא מהאנשים האלה שאתה יודע שתמיד יהיו שם בשבילך, לא משנה מה. יש לו עמוד שדרה ערכי חזק, אבל בלי טיפת התנשאות. הוא איש שיחה אמיתי, אפשר לדבר איתו על סוגיה בגמרא ודקה אחרי זה על כדורסל.' : 'I served with Daniel as an officer. He\'s one of those guys you know will always have your back, no matter what. He has a strong ethical backbone, but without a hint of arrogance. He\'s a true conversationalist; you can discuss a Gemara topic with him one minute and basketball the next.',
          isPhoneVisibleToMatch: false,
          status: TestimonialStatus.APPROVED,
          submittedBy: SubmissionSource.FRIEND,
          createdAt: new Date(),
        },
        {
          id: 'testimonial-daniel-2',
          authorName: isHebrew ? 'יונתן אביב' : 'Yonatan Aviv',
          relationship: isHebrew ? 'חברותא מהישיבה' : 'Yeshiva Chavruta (Study Partner)',
          content: isHebrew ? 'למדתי עם דניאל חברותא בהר עציון. הראש האנליטי החד שלו, יחד עם הצמא שלו לאמת ולמשמעות, זה שילוב נדיר. הוא לא מפחד משאלות קשות, לא בתורה ולא בחיים. הוא בחור רציני שיודע גם לנגן ולשמוח.' : 'I learned with Daniel as a chavruta at Har Etzion. His sharp analytical mind, combined with his thirst for truth and meaning, is a rare combination. He isn\'t afraid of tough questions, neither in Torah nor in life. He\'s a serious guy who also knows how to play music and have fun.',
          isPhoneVisibleToMatch: false,
          status: TestimonialStatus.APPROVED,
          submittedBy: SubmissionSource.FRIEND,
          createdAt: new Date(),
        },
      ],
    },
    questionnaireResponses: [danielQuestionnaireResponse],
  };

  const baseFirstParty: PartyInfo = {
    id: 'visitor-user-id', email: 'visitor@example.com',
    firstName: locale === 'he' ? 'המשתמש/ת' : 'Our', lastName: locale === 'he' ? 'שלנו' : 'User',
    isProfileComplete: true, profile: null, images: [], questionnaireResponses: [],
  };

  const demoSuggestionDataMale: ExtendedMatchSuggestion = {
    id: 'demo-suggestion-homepage-male', firstPartyId: 'visitor-user-id', secondPartyId: 'demo-profile-daniel', status: 'PENDING_FIRST_PARTY', priority: 'HIGH',
    matchingReason: suggestionContent.femaleToMaleReason, firstPartyNotes: suggestionContent.femaleToMalePersonalNote, secondPartyNotes: null,
    internalNotes: null, followUpNotes: null, responseDeadline: null,     matchmaker: { firstName: matchmakerContent.eytan.firstName, lastName: matchmakerContent.eytan.lastName },
    secondParty: danielProfile, firstParty: baseFirstParty, matchmakerId: 'matchmaker-demo-2', createdAt: new Date(), updatedAt: new Date(),
    lastActivity: new Date(), category: 'ACTIVE', decisionDeadline: new Date(), lastStatusChange: new Date(), previousStatus: 'DRAFT',
    firstPartySent: new Date(), firstPartyResponded: null, secondPartySent: null, secondPartyResponded: null, firstMeetingScheduled: null, closedAt: null,
    statusHistory: [],
  };

  const demoSuggestionDataFemale: ExtendedMatchSuggestion = {
    id: 'demo-suggestion-homepage-female', firstPartyId: 'visitor-user-id', secondPartyId: 'demo-profile-noa', status: 'PENDING_FIRST_PARTY', priority: 'HIGH',
    matchingReason: suggestionContent.maleToFemaleReason, firstPartyNotes: suggestionContent.maleToFemalePersonalNote, secondPartyNotes: null,
    internalNotes: null, followUpNotes: null, responseDeadline: null,  matchmaker: { firstName: matchmakerContent.dina.firstName, lastName: matchmakerContent.dina.lastName },
    secondParty: noaProfile, firstParty: baseFirstParty, matchmakerId: 'matchmaker-demo', createdAt: new Date(), updatedAt: new Date(),
    lastActivity: new Date(), category: 'ACTIVE', decisionDeadline: new Date(), lastStatusChange: new Date(), previousStatus: 'DRAFT',
    firstPartySent: new Date(), firstPartyResponded: null, secondPartySent: null, secondPartyResponded: null, firstMeetingScheduled: null, closedAt: null,
    statusHistory: [],
  };
  
  const demoAiAnalysisForDaniel: AiSuggestionAnalysisResult = {
    overallScore: 91, 
    matchTitle: aiAnalysisContent.forMaleTitle, 
    matchSummary: aiAnalysisContent.forMaleSummary,
    // עכשיו המערכים האלה יתמלאו מהתוכן שהוספנו
    compatibilityPoints: aiAnalysisContent.compatibilityPoints,
    pointsToConsider: aiAnalysisContent.pointsToConsider,
    suggestedConversationStarters: aiAnalysisContent.suggestedConversationStarters,
  };

  const demoAiAnalysisForNoa: AiSuggestionAnalysisResult = {
    overallScore: 91, 
    matchTitle: aiAnalysisContent.forFemaleTitle, 
    matchSummary: aiAnalysisContent.forFemaleSummary,
    // עכשיו המערכים האלה יתמלאו מהתוכן שהוספנו
    compatibilityPoints: aiAnalysisContent.compatibilityPoints,
    pointsToConsider: aiAnalysisContent.pointsToConsider,
    suggestedConversationStarters: aiAnalysisContent.suggestedConversationStarters,
  };

  return { demoSuggestionDataFemale, demoSuggestionDataMale, demoAiAnalysisForDaniel, demoAiAnalysisForNoa };
};
--- End of Content for demo-data.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\demo-content
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\demo-content\en.ts
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/components/demo-content/en.ts

export const femaleProfileContent = {
  firstName: 'Noa',
  lastName: 'Israeli',
  occupation: 'Senior UX/UI Designer',
  city: 'Tel Aviv',
  education: 'B.Des in Visual Communication, Bezalel; Graduate of Lindenbaum Midrasha',
  serviceDetails: 'Meaningful two-year National Service at "Krembo Wings" with children with special needs.',
  religiousLevel: 'dati_leumi_liberal',
  about: 'An optimist, creative, and a lover of good conversations. I grew up in a warm home where I learned what a partnership based on friendship and mutual respect looks like. After a challenging and fulfilling National Service at "Krembo Wings," I pursued a career in design, where I express my artistic soul. I\'m a people person, but I also enjoy my quiet time with a good book or a walk in nature. I\'m looking for a life partner, a man with a good heart and an open mind, to build a happy home together, with space for personal and mutual growth, where communication is the key to everything.',
  profileHeadline: 'Designing life with a smile, looking for a partner for the adventure.',

  formattedAnswers: {
    PERSONALITY: [
      {
        questionId: 'demo_noa_p1',
        question: "How would you describe yourself in 3-5 sentences?",
        questionType: 'openText',
        rawValue: "I'm an optimistic and positive person who believes you can find the good in any situation. I'm very creative, which is expressed in my work and hobbies, and I have good listening skills - friends say I'm 'receptive'. I value deep conversations, but I also love to laugh and enjoy the simple things.",
        displayText: "I'm an optimistic and positive person who believes you can find the good in any situation. I'm very creative, which is expressed in my work and hobbies, and I have good listening skills - friends say I'm 'receptive'. I value deep conversations, but I also love to laugh and enjoy the simple things.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_p2',
        question: "What is your natural 'biological clock'?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "I lean towards being a 'night owl' - I'm more creative and productive in the evening hours.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_p3',
        question: "When you feel overwhelmed, what are your 'go-to' strategies for resetting?",
        questionType: 'multiSelect',
        rawValue: ['A good talk with a friend', 'Getting out into nature', 'Engaging in a creative hobby'],
        displayText: "My main strategies are a good talk with a friend, getting out into nature, and engaging in art or a creative hobby.",
        isVisible: true, answeredAt: new Date(),
      },
    ],
    VALUES: [
      {
        questionId: 'demo_noa_v1',
        question: "Share a story of a time you followed your most important value.",
        questionType: 'openText',
        rawValue: "The most important value to me is mutual respect. At a professional crossroads, I could have taken a big project at a colleague's expense, but I chose to collaborate. Although I earned less personal 'credit', we built something better together and maintained a healthy relationship. It was proof to myself that the journey is just as important as the destination.",
        displayText: "The most important value to me is mutual respect. At a professional crossroads, I could have taken a big project at a colleague's expense, but I chose to collaborate. Although I earned less personal 'credit', we built something better together and maintained a healthy relationship. It was proof to myself that the journey is just as important as the destination.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_v2',
        question: "What is your definition of a 'rich life,' independent of money?",
        questionType: 'openText',
        rawValue: "A rich life is a life full of deep connections, experiences that expand the heart, and creation that gives expression to the soul. It's a wealth of time and meaning, not of objects.",
        displayText: "A rich life is a life full of deep connections, experiences that expand the heart, and creation that gives expression to the soul. It's a wealth of time and meaning, not of objects.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_v3',
        question: "At this stage of your life, how is your attention distributed among different areas?",
        questionType: 'budgetAllocation',
        rawValue: { 'Partnership': 30, 'Family': 20, 'Leisure & Self-Care': 20, 'Career': 15, 'Friends & Community': 10, 'Spirituality': 5 },
        displayText: "The answer is displayed as a visual chart.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELATIONSHIP: [
      {
        questionId: 'demo_noa_r1',
        question: "What's your 'formula' for sharing responsibilities in managing a home?",
        questionType: 'openText',
        rawValue: "I believe in a full and flexible partnership, like I saw in my parents' home. Not fixed 'roles', but a team that works together according to strengths and available time. It's all about open communication.",
        displayText: "I believe in a full and flexible partnership, like I saw in my parents' home. Not fixed 'roles', but a team that works together according to strengths and available time. It's all about open communication.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_r2',
        question: "After a disagreement, what is the most effective way for you to 'repair' the connection?",
        questionType: 'iconChoice',
        rawValue: 'processing_talk',
        displayText: "A calm conversation to process what happened, to listen, and to reach a mutual understanding.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_r3',
        question: "In the balance between 'we' and 'me' time, where do you naturally fall?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "I thrive on shared time and activities, but it's also important for me to maintain personal space and my own hobbies.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    PARTNER: [
      {
        questionId: 'demo_noa_pa1',
        question: "What is the one character trait your partner must have?",
        questionType: 'openText',
        rawValue: "The one quality upon which everything rests is kindness. A person with a good heart is someone who knows how to give, receive, forgive, and be a true partner. Everything else is built on this foundation.",
        displayText: "The one quality upon which everything rests is kindness. A person with a good heart is someone who knows how to give, receive, forgive, and be a true partner. Everything else is built on this foundation.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_pa2',
        question: "Which trait, perhaps less developed in you, would you be happy to find in a partner to complement you?",
        questionType: 'openText',
        rawValue: "I'm a person who thinks a lot and sometimes hesitates. I would be happy to find someone a bit more decisive and confident, someone who can help me jump into the water sometimes and balance my tendency to overthink.",
        displayText: "I'm a person who thinks a lot and sometimes hesitates. I would be happy to find someone a bit more decisive and confident, someone who can help me jump into the water sometimes and balance my tendency to overthink.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_pa3',
        question: "When you think of an 'intelligent' partner, which type do you value most?",
        questionType: 'budgetAllocation',
        rawValue: { 'Emotional': 40, 'Creative': 30, 'Life Smarts': 20, 'Analytical': 10 },
        displayText: "The answer is displayed as a visual chart.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELIGION: [
      {
        questionId: 'demo_noa_re1',
        question: "What is your vision for the education of the children in the home you'll build?",
        questionType: 'openText',
        rawValue: 'My vision is to establish a home where children grow up with values of giving, love of Torah, and the Land of Israel. It is important to me that the education be open and allow for questioning, one that nurtures thinking individuals with a deep, internal reverence for God.',
        displayText: 'My vision is to establish a home where children grow up with values of giving, love of Torah, and the Land of Israel. It is important to me that the education be open and allow for questioning, one that nurtures thinking individuals with a deep, internal reverence for God.',
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_re2',
        question: "What is the core experience you seek and receive from Shabbat?",
        questionType: 'iconChoice',
        rawValue: 'family_time',
        displayText: "Time for family, for togetherness, and for conversation. The quiet moments of a Shabbat meal are sacred to me.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_re3',
        question: "How flexible would you be if there were differences in Halachic practice between you and a partner?",
        questionType: 'scale',
        rawValue: 8,
        displayText: "I am very flexible and open. I believe a relationship is a journey of mutual growth, and as long as there is a foundation of respect and reverence for God, we can find a shared path.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
  },
};

export const maleProfileContent = {
  firstName: 'Daniel',
  lastName: 'Cohen',
  occupation: 'Software Engineer & M.Sc. Student',
  city: 'Jerusalem',
  education: 'Graduate of Yeshivat Har Etzion; B.Sc. in Software Engineering, Technion',
  serviceDetails: 'Significant service as an officer in the Combat Engineering Corps, company commander and platoon leader.',
  religiousLevel: 'dati_leumi_torani',
  about: 'A man of people and action, I combine worlds that seem distant but for me are one - the dynamism of high-tech and the depth of the Beit Midrash. My service as a combat officer shaped me and taught me a great deal about responsibility, leadership, and true friendship. I believe true growth happens outside the comfort zone, whether in a complex project at work or a challenging sugya in Gemara. I\'m looking for a true life partner to build a home together with reverence for God, open-mindedness, a lot of joy, and a constant desire to grow and develop together.',
  profileHeadline: 'Engineer by day, Torah scholar by night. Seeking a partner to build a world with.',
  
  formattedAnswers: {
    PERSONALITY: [
      {
        questionId: 'demo_daniel_p1',
        question: "What are the 3-5 key things you'd want us to highlight so people understand who you truly are?",
        questionType: 'openText',
        rawValue: "I'm a man of action, I love challenges and goals. Reliability is very important to me, and I always try to stand by my word. I have a strong analytical side, which I got from my studies at Yeshivat HaGush and in engineering, but I balance it with a creative side - I love playing the guitar and connect deeply with the world of Hasidut. I seek constant growth, both in my career and personal life.",
        displayText: "I'm a man of action, I love challenges and goals. Reliability is very important to me, and I always try to stand by my word. I have a strong analytical side, which I got from my studies at Yeshivat HaGush and in engineering, but I balance it with a creative side - I love playing the guitar and connect deeply with the world of Hasidut. I seek constant growth, both in my career and personal life.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_p2',
        question: "Which 'operating system' best describes how you function day-to-day?",
        questionType: 'iconChoice',
        rawValue: 'task_oriented',
        displayText: "Mission-Oriented: I function best with clear goals to accomplish.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_p3',
        question: "Share a story about a significant failure or challenge and what you learned from it.",
        questionType: 'openText',
        rawValue: "I failed an important exam in my undergraduate studies. It taught me the importance of perseverance, the ability to get up after a fall, and most importantly, that failure is not the end of the world but an opportunity to learn and improve.",
        displayText: "I failed an important exam in my undergraduate studies. It taught me the importance of perseverance, the ability to get up after a fall, and most importantly, that failure is not the end of the world but an opportunity to learn and improve.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    VALUES: [
      {
        questionId: 'demo_daniel_v1',
        question: "Share a story of a time you followed your most important value.",
        questionType: 'openText',
        rawValue: "My central value is responsibility. When I served as an officer in the Combat Engineering Corps, I had to make a complex operational decision under pressure. I chose the safer course of action, even though it was less 'glamorous'. It was a decision based on responsibility for the lives of my soldiers, and it reinforced my understanding that integrity and responsibility are above all else.",
        displayText: "My central value is responsibility. When I served as an officer in the Combat Engineering Corps, I had to make a complex operational decision under pressure. I chose the safer course of action, even though it was less 'glamorous'. It was a decision based on responsibility for the lives of my soldiers, and it reinforced my understanding that integrity and responsibility are above all else.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_v2',
        question: "Who are the people you admire as role models, and why?",
        questionType: 'openText',
        rawValue: "Rabbi Sacks zt\"l. His ability to bridge worlds, to present deep and relevant Jewish thought, and to be a man of both spirit and action at the highest level is a huge inspiration for me.",
        displayText: "Rabbi Sacks zt\"l. His ability to bridge worlds, to present deep and relevant Jewish thought, and to be a man of both spirit and action at the highest level is a huge inspiration for me.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_v3',
        question: "What is your approach to lifelong learning and intellectual growth?",
        questionType: 'iconChoice',
        rawValue: 'lifelong_learning',
        displayText: "It's an essential part of who I am - I am always reading, learning, and developing, both in my professional field and in my Torah studies.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELATIONSHIP: [
      {
        questionId: 'demo_daniel_r1',
        question: "What's one thing a relationship can't survive without for you, and what is your greatest aspiration?",
        questionType: 'openText',
        rawValue: "The absolute deal-breaker is a lack of integrity. The greatest aspiration is a true partnership. The knowledge that I have someone by my side, that we are a team against whatever life brings, and that we always look out for each other.",
        displayText: "The absolute deal-breaker is a lack of integrity. The greatest aspiration is a true partnership. The knowledge that I have someone by my side, that we are a team against whatever life brings, and that we always look out for each other.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_r2',
        question: "What's more important in a partner: someone who accepts you as you are, or someone who challenges you to grow?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "Acceptance is very important, but I'm looking for a partner who will help me be the best version of myself, and challenge me when needed. Shared growth is a supreme value in my eyes.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_r3',
        question: "When your partner comes home after a terrible day, what is your natural response?",
        questionType: 'iconChoice',
        rawValue: 'analyze_solve',
        displayText: "My initial tendency is to try to understand what happened, analyze the situation, and think together about practical solutions that could help.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    PARTNER: [
      {
        questionId: 'demo_daniel_pa1',
        question: "Which trait, perhaps less developed in you, would you be happy to find in a partner to complement you?",
        questionType: 'openText',
        rawValue: "As someone who is used to planning and acting in a very structured way, I would be happy to find someone with more spontaneity and flow, someone who will help me get out of the box sometimes and bring some adventure into life.",
        displayText: "As someone who is used to planning and acting in a very structured way, I would be happy to find someone with more spontaneity and flow, someone who will help me get out of the box sometimes and bring some adventure into life.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_pa2',
        question: "How would you allocate 100 'compatibility points' among the most essential character traits for you in a partner?",
        questionType: 'budgetAllocation',
        rawValue: { 'Integrity & Honesty': 30, 'Maturity & Stability': 25, 'Ambition & Growth': 20, 'Optimism': 15, 'Good Communication': 10 },
        displayText: "The answer is displayed as a visual chart.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_pa3',
        question: "What is your absolute 'red line,' a trait you could not live with?",
        questionType: 'openText',
        rawValue: "A red line for me is a lack of ambition to develop and improve. I'm not looking for someone perfect, but it's important to me that she has an internal motivation to grow, learn, and be a better version of herself. Passivity and an unwillingness to face challenges is something I find very difficult to connect with.",
        displayText: "A red line for me is a lack of ambition to develop and improve. I'm not looking for someone perfect, but it's important to me that she has an internal motivation to grow, learn, and be a better version of herself. Passivity and an unwillingness to face challenges is something I find very difficult to connect with.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELIGION: [
      {
        questionId: 'demo_daniel_re1',
        question: "What prayer, Jewish concept, or idea resonates most with you?",
        questionType: 'openText',
        rawValue: "A passage from Rabbi Sacks that talks about 'faith as an ongoing conversation'. It connects with my perception that faith is not static, but a dynamic journey of questions, searching, and answers, which fascinates me.",
        displayText: "A passage from Rabbi Sacks that talks about 'faith as an ongoing conversation'. It connects with my perception that faith is not static, but a dynamic journey of questions, searching, and answers, which fascinates me.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_re2',
        question: "In building a Jewish home, how do you envision the partnership regarding roles and responsibilities?",
        questionType: 'budgetAllocation',
        rawValue: { 'Flexible': 60, 'Traditional': 30, 'Egalitarian': 10 },
        displayText: "The answer is displayed as a visual chart.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_re3',
        question: "What role does spiritual guidance (from a Rabbi, etc.) play in your life when making significant decisions?",
        questionType: 'scale',
        rawValue: 8,
        displayText: "Consulting with a spiritual figure is an integral part of my decision-making process on significant issues. I see it as a source of wisdom, balance, and connection to tradition.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
  },
};

export const suggestionContent = {
  femaleToMaleReason: 'I connected you because I identified in both of you a similar aspiration for a life of meaning, where there is room for both depth and lightness. Daniel\'s stability, responsibility, and calmness, combined with Noa\'s warmth, creativity, and optimism, create tremendous potential for a partnership based on both security and inspiration. I believe your conversations could be fascinating, and you have a strong shared value base to build a real home upon.',
  femaleToMalePersonalNote: 'Daniel is a serious, value-driven man with a heart of gold. He impressively combines the world of Torah (a graduate of HaGush) with the world of action (a Technion-educated engineer) and is looking for a true life partner. I think you two have a lot to talk about.',
  maleToFemaleReason: 'What particularly resonated with me in your connection is the shared search for a "true partnership" – a relationship based on friendship, growth, and mutual respect. Your stability and pursuit of meaning, together with Noa\'s creativity, optimism, and empathy, which are also reflected in her professional and volunteer choices, create an amazing foundation for a real, deep, and joyful relationship.',
  maleToFemalePersonalNote: 'This is a suggestion I am particularly excited to present to you. Noa is a high-quality woman, with a depth and sensitivity that are rare to find. I think she is exactly what you were looking for.',
};

export const aiAnalysisContent = {
  forMaleTitle: 'A Partnership of Stability and Creativity',
  forMaleSummary: 'The connection between Daniel and Noa shows particularly high potential, based on a fascinating balance between shared core values and complementary personalities. The combination of Daniel\'s practical, ambitious nature and Noa\'s emotional depth and creativity creates a solid foundation for a long-term partnership.',
  forFemaleTitle: 'A Connection of Optimism and Responsibility',
  forFemaleSummary: 'The match between Noa and Daniel is very promising, based on a deep connection at the level of values and personality. Noa\'s creativity and optimism harmoniously complement Daniel\'s stability and responsibility, creating potential for a balanced and supportive relationship.',

  // START: Expanded AI Content
  compatibilityPoints: [
    {
      area: 'Shared Values and Worldview',
      explanation: 'You both see a relationship as a "true partnership" and family as a core value. Noa\'s desire for "kindness" and Daniel\'s emphasis on "integrity and responsibility" connect perfectly to form the basis of a healthy, mature relationship.'
    },
    {
      area: 'Intellectual and Emotional Compatibility',
      explanation: 'Noa\'s desire for "deep conversations" and her search for intelligence and curiosity align with Daniel\'s analytical and scholarly nature (a graduate of both Yeshivat Har Etzion and the Technion). There is potential for a fascinating intellectual connection and conversations late into the night.'
    },
    {
      area: 'Complementary Personalities',
      explanation: 'The combination of Daniel\'s practical, mission-oriented nature and Noa\'s artistic and creative soul creates a beautiful balance. He can provide stability and security, while she can bring spontaneity, color, and sensitivity to their shared life.'
    },
    {
      area: 'Balanced Lifestyle',
      explanation: 'You both appreciate a balance between career and ambition on one hand, and quality time, friends, and nature on the other. A shared love for hiking could be a source of many wonderful shared experiences.'
    }
  ],
  pointsToConsider: [
    {
      area: 'Shomer Negiah (Observing Touch)',
      explanation: 'Noa, it\'s important to know that Daniel is Shomer Negiah. This is a significant point to discuss openly and respectfully to understand its implications for both of you at the beginning of the relationship.'
    },
    {
      area: 'Geographic Location',
      explanation: 'Daniel lives in Jerusalem and you live in Tel Aviv. This is a gap that needs to be acknowledged and discussed, exploring both of your flexibility regarding a future place of residence.'
    },
    {
      area: 'Communication Styles',
      explanation: 'Daniel tends to analyze and solve problems, while you, Noa, seek more emotional processing and conversation. This is a wonderful opportunity to learn each other\'s languages of support.'
    }
  ],
  suggestedConversationStarters: [
    'You both defined "partnership" as an important value. What does a "true partnership" look like to you in daily life?',
    'How do you balance your professional ambitions with your desire for a full personal, spiritual, and creative life?',
    'Tell me about a project or challenge (personal or professional) that you took on and what you learned from the process.',
    'What is the most important thing you want a partner to understand about you right from the start?'
  ]
  // END: Expanded AI Content
};

export const matchmakerContent = {
  dina: {
    firstName: 'Dina',
    lastName: 'Englerd'
  },
  eytan: {
    firstName: 'Eytan',
    lastName: 'Englerd'
  }
};
--- End of Content for en.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\components\demo-content\he.ts
--------------------------------------------------------------------------------
Content:
export const femaleProfileContent = {
  firstName: 'נועה',
  lastName: 'ישראלי',
  occupation: 'מעצבת UX/UI בכירה',
  city: 'תל אביב',
  education: 'תואר ראשון בתקשורת חזותית, בצלאל; בוגרת מדרשת לינדנבאום',
  serviceDetails: 'שירות לאומי משמעותי של שנתיים בעמותת "כנפיים של קרמבו" עם ילדים בעלי צרכים מיוחדים.',
  religiousLevel: 'dati_leumi_liberal',
  about: 'אופטימית, יצירתית ואוהבת שיחות טובות. גדלתי בבית חם, שבו למדתי מהי זוגיות המבוססת על חברות וכבוד הדדי. אחרי שירות לאומי מאתגר ומספק ב"כנפיים של קרמבו", המשכתי לעולם העיצוב, שם אני מוצאת ביטוי לנפש האמנותית שלי. אני אדם של אנשים, אבל גם נהנית מהשקט שלי עם ספר טוב או טיול בטבע. מחפשת שותף לחיים, אדם עם לב טוב וראש פתוח, לבנות יחד בית שמח, עם מרחב לצמיחה אישית וזוגית, שבו התקשורת היא המפתח להכל.',
  profileHeadline: 'מעצבת את החיים בחיוך, מחפשת שותף להרפתקה.',
  
  formattedAnswers: {
    PERSONALITY: [
      {
        questionId: 'demo_noa_p1',
        question: "איך היית מתארת את עצמך ב-3-5 משפטים?",
        questionType: 'openText',
        rawValue: "אני אדם אופטימי וחיובי, שמאמין שאפשר למצוא את הטוב בכל מצב. אני מאוד יצירתית, מה שבא לידי ביטוי בעבודה ובתחביבים שלי, ויש לי יכולת הקשבה טובה - חברים אומרים שאני 'מכילה'. חשוב לי מאוד לנהל שיחות עומק, אבל אני גם אוהבת לצחוק וליהנות מהדברים הפשוטים.",
        displayText: "אני אדם אופטימי וחיובי, שמאמין שאפשר למצוא את הטוב בכל מצב. אני מאוד יצירתית, מה שבא לידי ביטוי בעבודה ובתחביבים שלי, ויש לי יכולת הקשבה טובה - חברים אומרים שאני 'מכילה'. חשוב לי מאוד לנהל שיחות עומק, אבל אני גם אוהבת לצחוק וליהנות מהדברים הפשוטים.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_p2',
        question: "מהו ה'שעון הביולוגי' הטבעי שלך?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "נטייה ל'ציפור לילה' - אני יותר יצירתית ופרודוקטיבית בשעות הערב.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_p3',
        question: "כשאת מרגישה מוצפת, לאן את פונה כדי 'לאפס את המערכת'?",
        questionType: 'multiSelect',
        rawValue: ['שיחה עם חברה', 'יציאה לטבע', 'עיסוק ביצירה'],
        displayText: "הדרכים העיקריות שלי הן שיחה טובה עם חברה, יציאה לטבע, ועיסוק ביצירה או אמנות.",
        isVisible: true, answeredAt: new Date(),
      },
    ],
    VALUES: [
      {
        questionId: 'demo_noa_v1',
        question: "ספרי על צומת דרכים אחד בחיים שבו פעלת לפי ערך שהכי חשוב לך.",
        questionType: 'openText',
        rawValue: "הערך הכי חשוב לי הוא כבוד הדדי. בצומת דרכים מקצועי שהיה לי, יכולתי לקחת פרויקט גדול על חשבון קולגה, אבל בחרתי לשתף פעולה. למרות שהרווחתי פחות 'קרדיט' אישי, בנינו יחד משהו טוב יותר ושמרנו על מערכת יחסים בריאה. זו הייתה הוכחה לעצמי שהדרך חשובה לי לא פחות מהתוצאה.",
        displayText: "הערך הכי חשוב לי הוא כבוד הדדי. בצומת דרכים מקצועי שהיה לי, יכולתי לקחת פרויקט גדול על חשבון קולגה, אבל בחרתי לשתף פעולה. למרות שהרווחתי פחות 'קרדיט' אישי, בנינו יחד משהו טוב יותר ושמרנו על מערכת יחסים בריאה. זו הייתה הוכחה לעצמי שהדרך חשובה לי לא פחות מהתוצאה.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_v2',
        question: "מהי ההגדרה שלך ל'חיים עשירים', שאינה קשורה לכסף?",
        questionType: 'openText',
        rawValue: "חיים עשירים הם חיים שמלאים בקשרים עמוקים, חוויות שמרחיבות את הלב, ויצירה שנותנת ביטוי לנשמה. זה עושר של זמן ושל משמעות, לא של חפצים.",
        displayText: "חיים עשירים הם חיים שמלאים בקשרים עמוקים, חוויות שמרחיבות את הלב, ויצירה שנותנת ביטוי לנשמה. זה עושר של זמן ושל משמעות, לא של חפצים.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_noa_v3',
        question: "בשלב זה של חייך, כיצד מתחלקת תשומת הלב שלך בין התחומים השונים?",
        questionType: 'budgetAllocation',
        rawValue: { 'זוגיות': 30, 'משפחה': 20, 'פנאי וטיפוח עצמי': 20, 'קריירה': 15, 'חברים וקהילה': 10, 'רוחניות': 5 },
        displayText: "התשובה מוצגת כגרף ויזואלי.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELATIONSHIP: [
      {
        questionId: 'demo_noa_r1',
        question: "מהי בעיניך 'הנוסחה' לחלוקת אחריות בניהול בית משותף?",
        questionType: 'openText',
        rawValue: "אני מאמינה בשותפות מלאה וגמישה, כמו שראיתי בבית הורי, שם אבא איש כספים ואמא אמנית, וכל אחד מביא את החוזקות שלו. לא 'תפקידים' קבועים, אלא צוות שפועל יחד לפי נקודות החוזק והזמן הפנוי. הכל בתקשורת פתוחה.",
        displayText: "אני מאמינה בשותפות מלאה וגמישה, כמו שראיתי בבית הורי. לא 'תפקידים' קבועים, אלא צוות שפועל יחד לפי נקודות החוזק והזמן הפנוי. הכל בתקשורת פתוחה.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_r2',
        question: "לאחר ויכוח, מהי הדרך היעילה ביותר עבורך 'לתקן' את הקשר?",
        questionType: 'iconChoice',
        rawValue: 'processing_talk',
        displayText: "שיחת עיבוד רגועה כדי להבין מה קרה, להקשיב ולהגיע להבנה הדדית.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_r3',
        question: "באיזון שבין 'אנחנו' ל'אני', לאן את נוטה באופן טבעי?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "אני משגשגת בזמן משותף ופעילויות משותפות, אבל חשוב לי גם לשמור על מרחב אישי ותחביבים משלי.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    PARTNER: [
       {
        questionId: 'demo_noa_pa1',
        question: "מהי תכונת האופי האחת שחייבת להיות בבן הזוג שלך?",
        questionType: 'openText',
        rawValue: "התכונה האחת שעליה הכל עומד היא טוב לב. אדם עם לב טוב הוא אדם שיודע לתת, לקבל, לסלוח ולהיות שותף אמיתי. כל השאר נבנה על היסוד הזה.",
        displayText: "התכונה האחת שעליה הכל עומד היא טוב לב. אדם עם לב טוב הוא אדם שיודע לתת, לקבל, לסלוח ולהיות שותף אמיתי. כל השאר נבנה על היסוד הזה.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_noa_pa2',
        question: "איזו תכונה שפחות חזקה אצלך, היית שמחה למצוא אצל בן הזוג כדי שתשלימו זה את זו?",
        questionType: 'openText',
        rawValue: "אני אדם שחושב הרבה ולפעמים מהסס. הייתי שמחה למצוא מישהו קצת יותר החלטי ועם ביטחון, כזה שיעזור לי לפעמים לקפוץ למים ויאזן את הנטייה שלי לחשוב יותר מדי.",
        displayText: "אני אדם שחושב הרבה ולפעמים מהסס. הייתי שמחה למצוא מישהו קצת יותר החלטי ועם ביטחון, כזה שיעזור לי לפעמים לקפוץ למים ויאזן את הנטייה שלי לחשוב יותר מדי.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_noa_pa3',
        question: "כשאת חושבת על 'אינטליגנציה' אצל בן זוג, מה הכי חשוב לך?",
        questionType: 'budgetAllocation',
        rawValue: { 'רגשית': 40, 'יצירתית': 30, 'חוכמת חיים': 20, 'אנליטית': 10 },
        displayText: "התשובה מוצגת כגרף ויזואלי.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELIGION: [
      {
        questionId: 'demo_noa_re1',
        question: "מהו החזון שלך לחינוך הילדים בבית שתקימי?",
        questionType: 'openText',
        rawValue: 'החזון שלי הוא להקים בית שבו ילדים גדלים עם ערכים של נתינה, אהבת התורה וארץ ישראל. חשוב לי שהחינוך יהיה דתי-לאומי פתוח ומאפשר שאלת שאלות, כזה שמצמיח אנשים חושבים, עם יראת שמיים פנימית ועמוקה.',
        displayText: 'החזון שלי הוא להקים בית שבו ילדים גדלים עם ערכים של נתינה, אהבת התורה וארץ ישראל. חשוב לי שהחינוך יהיה דתי-לאומי פתוח ומאפשר שאלת שאלות, כזה שמצמיח אנשים חושבים, עם יראת שמיים פנימית ועמוקה.',
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_re2',
        question: "מהי החוויה המרכזית שאת מחפשת ומקבלת מהשבת?",
        questionType: 'iconChoice',
        rawValue: 'family_time',
        displayText: "זמן למשפחה, לביחד ולשיח. הרגעים השקטים של סעודת שבת הם קודש קודשים עבורי.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_noa_re3',
        question: "באיזו מידה את פתוחה לגמישות אם יתגלו פערים בגישה ההלכתית בינך לבין בן הזוג?",
        questionType: 'scale',
        rawValue: 8,
        displayText: "אני מאוד גמישה ופתוחה. אני מאמינה שזוגיות היא מסע של צמיחה משותפת, וכל עוד יש בסיס של כבוד ויראת שמיים, אפשר למצוא את הדרך המשותפת.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
  },
};

export const maleProfileContent = {
  firstName: 'דניאל',
  lastName: 'כהן',
  occupation: 'מהנדס תוכנה וסטודנט לתואר שני',
  city: 'ירושלים',
  education: 'בוגר ישיבת הר עציון; תואר ראשון בהנדסת תוכנה, הטכניון',
  serviceDetails: 'שירות משמעותי כקצין בהנדסה קרבית, מ"מ וסמ"פ.',
  religiousLevel: 'dati_leumi_torani',
  about: 'איש של אנשים ושל עשייה, משלב בין עולמות שנראים רחוקים אבל בשבילי הם לגמרי אחד - הדינמיות של ההייטק והעומק של בית המדרש. השירות כקצין קרבי עיצב אותי ולימד אותי המון על אחריות, מנהיגות וחברות אמת. אני מאמין שצמיחה אמיתית קורית מחוץ לאזור הנוחות, בין אם זה בפרויקט מורכב בעבודה או בסוגיה מאתגרת בגמרא. מחפש שותפה אמיתית לחיים, לבנות יחד בית עם יראת שמיים, פתיחות מחשבתית, הרבה שמחה, ורצון תמידי לגדול ולהתפתח יחד.',
  profileHeadline: 'מהנדס ביום, לומד תורה בערב. מחפש שותפה לבנות עולם.',
  
  formattedAnswers: {
    PERSONALITY: [
      {
        questionId: 'demo_daniel_p1',
        question: "מהם 3-5 הדברים המרכזיים שהיית רוצה שנדגיש כדי שיבינו מי אתה באמת?",
        questionType: 'openText',
        rawValue: "אני אדם של עשייה, אוהב אתגרים ומטרות. חשובה לי מאוד האמינות, ואני תמיד משתדל לעמוד במילה שלי. יש לי צד אנליטי חזק, שקיבלתי מהלימודים בישיבת הגוש ובהנדסה, אבל אני מאזן את זה עם צד יצירתי - אני אוהב לנגן בגיטרה ומתחבר מאוד לעולם החסידות. אני מחפש צמיחה מתמדת, גם בקריירה וגם בחיים האישיים.",
        displayText: "אני אדם של עשייה, אוהב אתגרים ומטרות. חשובה לי מאוד האמינות, ואני תמיד משתדל לעמוד במילה שלי. יש לי צד אנליטי חזק, שקיבלתי מהלימודים בישיבת הגוש ובהנדסה, אבל אני מאזן את זה עם צד יצירתי - אני אוהב לנגן בגיטרה ומתחבר מאוד לעולם החסידות. אני מחפש צמיחה מתמדת, גם בקריירה וגם בחיים האישיים.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_p2',
        question: "באיזו 'מערכת הפעלה' הראש שלך עובד הכי טוב ביום-יום?",
        questionType: 'iconChoice',
        rawValue: 'task_oriented',
        displayText: "משימתיות - אני מתפקד הכי טוב עם יעדים ברורים להשגה.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_p3',
        question: "ספר על כישלון או אתגר משמעותי, ומה למדת ממנו על עצמך.",
        questionType: 'openText',
        rawValue: "נכשלתי במבחן חשוב בתואר הראשון. זה לימד אותי על החשיבות של התמדה, על היכולת לקום אחרי נפילה, ובעיקר שכישלון הוא לא סוף העולם אלא הזדמנות ללמוד ולהשתפר.",
        displayText: "נכשלתי במבחן חשוב בתואר הראשון. זה לימד אותי על החשיבות של התמדה, על היכולת לקום אחרי נפילה, ובעיקר שכישלון הוא לא סוף העולם אלא הזדמנות ללמוד ולהשתפר.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    VALUES: [
      {
        questionId: 'demo_daniel_v1',
        question: "ספר על צומת דרכים אחד בחיים שבו פעלת לפי הערך שהכי חשוב לך.",
        questionType: 'openText',
        rawValue: "הערך המרכזי שלי הוא אחריות. כששירתי כקצין בהנדסה קרבית, הייתי צריך לקבל החלטה מבצעית מורכבת תחת לחץ. בחרתי בדרך הפעולה הבטוחה יותר, למרות שהיא הייתה פחות 'זוהרת'. זו הייתה החלטה שהתבססה על אחריות לחיי החיילים שלי, והיא חיזקה אצלי את ההבנה שיושרה ואחריות הן מעל הכל.",
        displayText: "הערך המרכזי שלי הוא אחריות. כששירתי כקצין בהנדסה קרבית, הייתי צריך לקבל החלטה מבצעית מורכבת תחת לחץ. בחרתי בדרך הפעולה הבטוחה יותר, למרות שהיא הייתה פחות 'זוהרת'. זו הייתה החלטה שהתבססה על אחריות לחיי החיילים שלי, והיא חיזקה אצלי את ההבנה שיושרה ואחריות הן מעל הכל.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_v2',
        question: "מי הם האנשים שמהווים עבורך מודל לחיקוי, ומדוע?",
        questionType: 'openText',
        rawValue: "הרב זקס זצ\"ל. היכולת שלו לגשר בין עולמות, להציג מחשבה יהודית עמוקה ורלוונטית, ולהיות איש רוח ומעשה ברמה הגבוהה ביותר היא השראה עצומה עבורי.",
        displayText: "הרב זקס זצ\"ל. היכולת שלו לגשר בין עולמות, להציג מחשבה יהודית עמוקה ורלוונטית, ולהיות איש רוח ומעשה ברמה הגבוהה ביותר היא השראה עצומה עבורי.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_v3',
        question: "מהי גישתך להתפתחות אינטלקטואלית ולמידה מתמדת?",
        questionType: 'iconChoice',
        rawValue: 'lifelong_learning',
        displayText: "זה חלק מהותי ממני - אני תמיד קורא, לומד ומתפתח, גם בתחום המקצועי וגם בתחום התורני.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELATIONSHIP: [
      {
        questionId: 'demo_daniel_r1',
        question: "מהו הדבר האחד שבלעדיו קשר זוגי לא יכול לעבוד עבורך, ומהי השאיפה הגדולה ביותר?",
        questionType: 'openText',
        rawValue: "הדיל ברייקר המוחלט הוא חוסר יושרה. השאיפה הגדולה ביותר היא שותפות אמיתית. הידיעה שיש לי מישהי לצידי, שאנחנו צוות מול כל אתגר, ושדואגים תמיד אחד לשנייה.",
        displayText: "הדיל ברייקר המוחלט הוא חוסר יושרה. השאיפה הגדולה ביותר היא שותפות אמיתית. הידיעה שיש לי מישהי לצידי, שאנחנו צוות מול כל אתגר, ושדואגים תמיד אחד לשנייה.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_r2',
        question: "מה יותר חשוב לך בבת זוג: מישהי שתקבל אותך כמו שאתה, או מישהי שתאתגר אותך לצמוח?",
        questionType: 'scale',
        rawValue: 7,
        displayText: "חשובה לי מאוד הקבלה, אבל אני מחפש שותפה שתעזור לי להיות הגרסה הכי טובה של עצמי, ותאתגר אותי כשצריך. צמיחה משותפת היא ערך עליון בעיניי.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_r3',
        question: "כשבת הזוג שלך חוזרת הביתה אחרי יום נוראי, מה תהיה התגובה הטבעית שלך?",
        questionType: 'iconChoice',
        rawValue: 'analyze_solve',
        displayText: "הנטייה הראשונית שלי היא לנסות להבין מה קרה, לנתח את המצב ולחשוב יחד על פתרונות מעשיים שיכולים לעזור.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    PARTNER: [
      {
        questionId: 'demo_daniel_pa1',
        question: "איזו תכונה או יכולת, שאולי פחות חזקה אצלך, היית שמח למצוא אצל בת הזוג כדי שתשלימו זו את זה?",
        questionType: 'openText',
        rawValue: "כאדם שרגיל לתכנן ולפעול בצורה מאוד מובנית, הייתי שמח למצוא מישהי עם יותר ספונטניות וזרימה, כזו שתעזור לי לפעמים לצאת מהקופסה ולהכניס קצת הרפתקנות לחיים.",
        displayText: "כאדם שרגיל לתכנן ולפעול בצורה מאוד מובנית, הייתי שמח למצוא מישהי עם יותר ספונטניות וזרימה, כזו שתעזור לי לפעמים לצאת מהקופסה ולהכניס קצת הרפתקנות לחיים.",
        isVisible: true, answeredAt: new Date(),
      },
      {
        questionId: 'demo_daniel_pa2',
        question: "איך היית מחלק 100 'נקודות התאמה' בין תכונות האופי החיוניות לך בבת זוג?",
        questionType: 'budgetAllocation',
        rawValue: { 'יושרה ואמינות': 30, 'בגרות ויציבות': 25, 'שאפתנות וצמיחה': 20, 'אופטימיות': 15, 'תקשורת טובה': 10 },
        displayText: "התשובה מוצגת כגרף ויזואלי.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_daniel_pa3',
        question: "מהו ה'קו האדום' המוחלט שלך, תכונה שלא תוכל לחיות איתה בשלום?",
        questionType: 'openText',
        rawValue: "קו אדום עבורי הוא חוסר שאיפה להתפתח ולהשתפר. אני לא מחפש מישהי מושלמת, אבל חשוב לי שתהיה לה מוטיבציה פנימית לצמוח, ללמוד ולהיות גרסה טובה יותר של עצמה. פסיביות וחוסר רצון להתמודד עם אתגרים זה משהו שקשה לי מאוד להתחבר אליו.",
        displayText: "קו אדום עבורי הוא חוסר שאיפה להתפתח ולהשתפר. אני לא מחפש מישהי מושלמת, אבל חשוב לי שתהיה לה מוטיבציה פנימית לצמוח, ללמוד ולהיות גרסה טובה יותר של עצמה. פסיביות וחוסר רצון להתמודד עם אתגרים זה משהו שקשה לי מאוד להתחבר אליו.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
    RELIGION: [
      {
        questionId: 'demo_daniel_re1',
        question: "מהו קטע תפילה, הגות או רעיון יהודי שמדבר אליך במיוחד?",
        questionType: 'openText',
        rawValue: "קטע של הרב זקס שמדבר על 'אמונה כשיחה מתמשכת'. זה מתחבר לי לתפיסה שהאמונה היא לא משהו סטטי, אלא מסע דינמי של שאלה, חיפוש ותשובה, וזה מרתק אותי.",
        displayText: "קטע של הרב זקס שמדבר על 'אמונה כשיחה מתמשכת'. זה מתחבר לי לתפיסה שהאמונה היא לא משהו סטטי, אלא מסע דינמי של שאלה, חיפוש ותשובה, וזה מרתק אותי.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_daniel_re2',
        question: "בבניית בית יהודי, כיצד היית רואה את חלוקת האחריות בין גבר לאישה?",
        questionType: 'budgetAllocation',
        rawValue: { 'חלוקה גמישה': 60, 'חלוקה מסורתית': 30, 'שותפות שוויונית': 10 },
        displayText: "התשובה מוצגת כגרף ויזואלי.",
        isVisible: true, answeredAt: new Date(),
      },
       {
        questionId: 'demo_daniel_re3',
        question: "מה מקומה של הדרכה רוחנית (רב, רבנית) בחייך בקבלת החלטות משמעותיות?",
        questionType: 'scale',
        rawValue: 8,
        displayText: "התייעצות עם דמות רוחנית היא חלק בלתי נפרד מתהליך קבלת ההחלטות שלי בנושאים משמעותיים. אני רואה בזה מקור לחוכמה, איזון וחיבור למסורת.",
        isVisible: true, answeredAt: new Date(),
      }
    ],
  },
};

export const suggestionContent = {
  femaleToMaleReason: 'חיברתי ביניכם כי זיהיתי בשניכם שאיפה דומה לחיים של משמעות, שבהם יש מקום גם לעומק וגם לקלילות. היציבות, האחריות והשקט של דניאל, יחד עם החום, היצירתיות והאופטימיות של נועה, יוצרים פוטנציאל אדיר לזוגיות שמבוססת גם על ביטחון וגם על השראה. אני מאמינה שהשיחות ביניכם יכולות להיות מרתקות, ושיש לכם בסיס ערכי משותף חזק לבנות עליו בית אמיתי.',
  femaleToMalePersonalNote: 'דניאל הוא בחור רציני, ערכי ועם לב זהב. הוא משלב בצורה מרשימה בין עולם התורה (בוגר הגוש) לעולם המעשה (מהנדס בוגר טכניון), ומחפש שותפה אמיתית לחיים. אני חושב שיש לכם הרבה על מה לדבר.',
  maleToFemaleReason: 'מה שהדהד לי במיוחד בחיבור ביניכם הוא החיפוש המשותף אחר "שותפות אמת" - קשר שמבוסס על חברות, צמיחה וכבוד הדדי. היציבות והשאיפה למשמעות שלך, יחד עם היצירתיות, האופטימיות והאמפתיה של נועה, שבאות לידי ביטוי גם בבחירות המקצועיות וההתנדבותיות שלה, יוצרים בסיס מדהים לקשר אמיתי, עמוק ומלא שמחה.',
  maleToFemalePersonalNote: 'זו הצעה שאני מתרגשת במיוחד להציג לך. נועה היא בחורה איכותית, עם עומק ורגישות שנדיר למצוא. אני חושבת שהיא בדיוק מה שחיפשת.',
};

export const aiAnalysisContent = {
  forMaleTitle: 'שותפות של יציבות ויצירתיות',
  forMaleSummary: 'החיבור בין דניאל לנועה מציג פוטנציאל גבוה במיוחד, המבוסס על איזון מרתק בין ערכי ליבה משותפים לבין אישיות משלימה. השילוב בין האופי המעשי, האחראי והשאפתני של דניאל לבין העומק הרגשי, האופטימיות והיצירתיות של נועה יוצר בסיס איתן לשותפות ארוכת טווח.',
  forFemaleTitle: 'חיבור בין אופטימיות לאחריות',
  forFemaleSummary: 'ההתאמה בין נועה לדניאל מבטיחה מאוד ומתבססת על חיבור עמוק ברמת הערכים והאישיות. היצירתיות, הרגישות והאופטימיות של נועה משלימות באופן הרמוני את היציבות, האחריות והנחישות של דניאל, ויוצרות פוטנציאל לזוגיות מאוזנת, תומכת ומלאת תוכן.',
  
  // START: תוכן AI מורחב
  compatibilityPoints: [
    {
      area: 'ערכים משותפים וראיית עולם',
      explanation: 'שניכם רואים בזוגיות "שותפות אמת" ובמשפחה ערך עליון. הרצון של נועה ב"טוב לב" והדגש של דניאל על "יושרה ואחריות" מתחברים באופן מושלם לבסיס של קשר בריא ובוגר.'
    },
    {
      area: 'התאמה אינטלקטואלית ורגשית',
      explanation: 'הרצון של נועה ב"שיחות עומק" והחיפוש אחר אינטליגנציה וסקרנות תואמים את אופיו האנליטי והלמדני של דניאל (בוגר ישיבת הר עציון והטכניון). יש פוטנציאל לחיבור אינטלקטואלי מרתק ושיחות אל תוך הלילה.'
    },
    {
      area: 'אישיות משלימה',
      explanation: 'השילוב בין האופי המעשי והמשימתי של דניאל לבין הנפש האמנותית והיצירתית של נועה יוצר איזון יפהפה. הוא יכול להעניק יציבות וביטחון, והיא יכולה להכניס ספונטניות, צבע ורגישות לחייהם המשותפים.'
    },
    {
      area: 'סגנון חיים מאוזן',
      explanation: 'שניכם מעריכים איזון בין קריירה ושאפתנות לבין זמן איכות, חברים וטבע. האהבה המשותפת לטיולים יכולה להוות מקור לחוויות משותפות רבות.'
    }
  ],
  pointsToConsider: [
    {
      area: 'שמירת נגיעה',
      explanation: 'נועה, חשוב לדעת שדניאל שומר נגיעה. זוהי נקודה מהותית שכדאי לדבר עליה בפתיחות ובכבוד כדי להבין את המשמעויות עבור שניכם בתחילת הקשר.'
    },
    {
      area: 'מיקום גיאוגרפי',
      explanation: 'דניאל מתגורר בירושלים ואת בתל אביב. זהו פער שיש לתת עליו את הדעת ולדון בגמישות של שניכם לגבי מקום מגורים עתידי.'
    },
    {
      area: 'סגנון תקשורת',
      explanation: 'דניאל נוטה לנתח ולפתור בעיות, בעוד שאת, נועה, מחפשת יותר עיבוד רגשי ושיחה. זו הזדמנות נהדרת ללמוד את שפות התמיכה אחד של השנייה.'
    }
  ],
  suggestedConversationStarters: [
    'שניכם הגדרתם "שותפות" כערך חשוב. מהי "שותפות" אמיתית בעיניכם, ואיך היא באה לידי ביטוי ביום-יום?',
    'איך אתם מאזנים בין השאיפות המקצועיות שלכם לבין הרצון לחיים אישיים, רוחניים ויצירתיים מלאים?',
    'ספרו על פרויקט או אתגר (אישי או מקצועי) שלקחתם על עצמכם ומה למדתם מהתהליך.',
    'מה הדבר הכי חשוב לכם שבן/בת הזוג יבינו עליכם כבר בהתחלה?'
  ]
  // END: תוכן AI מורחב
};

export const matchmakerContent = {
  dina: {
    firstName: 'דינה',
    lastName: 'אנגלרד'
  },
  eytan: {
    firstName: 'איתן',
    lastName: 'אנגלרד'
  }
};
--- End of Content for he.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\CTASection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/CTASection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Sparkles, ArrowRight } from 'lucide-react';
import type { CtaDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface CTAProps {
  dict: CtaDict;
  locale: 'he' | 'en';
}

const CTASection: React.FC<CTAProps> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.2,
        delayChildren: 0.1,
      },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 40 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.8,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  const iconVariants = {
    hidden: { opacity: 0, scale: 0, rotate: -180 },
    visible: {
      opacity: 1,
      scale: 1,
      rotate: 0,
      transition: {
        duration: 0.6,
        delay: 0.3,
        type: 'spring',
        stiffness: 260,
        damping: 15,
      },
    },
  };

  const textVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const buttonVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      className="py-16 md:py-20 px-4 bg-white relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Updated Background Overlay: Teal -> Orange/Rose mix */}
      <div className="absolute inset-0 bg-gradient-to-br from-teal-50 to-orange-50/50 opacity-70"></div>

      <div className="max-w-4xl mx-auto text-center relative">
        <motion.div
          // Updated Border
          className="bg-white/80 backdrop-blur-sm rounded-2xl p-8 md:p-12 shadow-xl border border-teal-100"
          variants={cardVariants}
        >
          <motion.div
            // Updated Icon Colors
            className="inline-block mb-6 p-3 bg-teal-100 rounded-full text-teal-600"
            variants={iconVariants}
            whileHover={{
              rotate: [0, -10, 10, 0],
              transition: { duration: 0.6 },
            }}
          >
            <Sparkles className="w-8 h-8" />
          </motion.div>

          <motion.h2
            className="text-3xl sm:text-4xl font-bold text-gray-800 mb-4"
            variants={textVariants}
          >
            {dict.title_part1}
            {/* Updated Title Gradient */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500">
              {' '}
              {dict.title_highlight}
            </span>
          </motion.h2>

          <motion.p
            className="text-lg text-gray-600 mb-8 max-w-2xl mx-auto"
            variants={textVariants}
          >
            {dict.subtitle}
          </motion.p>

          <motion.div variants={buttonVariants}>
            <Link href="/auth/register">
              <motion.div
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
              >
                <Button
                  size="lg"
                  // Updated Button Gradient to Match Hero
                  className="bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl group"
                >
                  <span className="relative z-10 flex items-center">
                    {dict.button}
                    {locale === 'he' ? (
                      <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                    ) : (
                      <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                    )}{' '}
                  </span>
                </Button>
              </motion.div>
            </Link>
          </motion.div>
        </motion.div>
      </div>
    </motion.section>
  );
};

export default CTASection;
--- End of Content for CTASection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\FAQSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/FAQSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import FAQItem from '../components/FAQItem';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  ArrowLeft,
  Sparkles,
  MessageCircle,
  Shield,
  Clock,
  ArrowRight,
  Users,
  HelpCircle,
  FileText,
} from 'lucide-react';
import type { FaqDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface FAQProps {
  dict: FaqDict;
  locale: 'he' | 'en';
}

const FAQSection: React.FC<FAQProps> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.05 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.2,
      },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const faqContainerVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        staggerChildren: 0.1,
        delayChildren: 0.3,
      },
    },
  };

  const faqItemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.5, ease: 'easeOut' },
    },
  };

  const contactBlockVariants = {
    hidden: { opacity: 0, y: 30, scale: 0.95 },
    visible: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  // Updated Icons Palette to match Hero (Teal, Orange, Rose, Amber)
  const faqIcons = [
    {
      icon: <Sparkles className="w-5 h-5" />,
      color: 'from-amber-400 to-orange-500', // Energy/Warmth
    },
    {
      icon: <Users className="w-5 h-5" />,
      color: 'from-teal-400 to-emerald-500', // Tech/Growth
    },
    {
      icon: <Shield className="w-5 h-5" />,
      color: 'from-orange-400 to-rose-500', // Security/Protection (Warm)
    },
    {
      icon: <FileText className="w-5 h-5" />,
      color: 'from-rose-400 to-pink-500', // Content/Heart
    },
    {
      icon: <Clock className="w-5 h-5" />,
      color: 'from-teal-500 to-cyan-500', // Time/Efficiency
    },
  ];

  return (
    <motion.section
      ref={ref}
      id="faq"
      // Updated Background: Slate -> Teal hint -> Orange hint
      className="py-16 md:py-20 px-4 bg-gradient-to-br from-slate-50 via-white to-orange-50/20 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 overflow-hidden">
        {/* Updated Orbs colors */}
        <div className="absolute top-20 left-10 w-32 h-32 bg-gradient-to-br from-teal-200/30 to-emerald-300/20 rounded-full blur-3xl animate-float-slow"></div>
        <div
          className="absolute top-60 right-20 w-40 h-40 bg-gradient-to-br from-orange-200/25 to-amber-300/15 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute bottom-40 left-1/3 w-36 h-36 bg-gradient-to-br from-rose-200/20 to-pink-300/15 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '4s' }}
        ></div>
        <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#0d9488_1px,transparent_1px)] [background-size:30px_30px]"></div>

        <svg
          className="absolute inset-0 w-full h-full"
          viewBox="0 0 1000 1000"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <linearGradient id="waveGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stopColor="#14b8a6" stopOpacity="0.08" /> {/* Teal */}
              <stop offset="100%" stopColor="#f97316" stopOpacity="0.05" /> {/* Orange */}
            </linearGradient>
          </defs>
          <path
            d="M0,200 C300,100 700,300 1000,200 L1000,0 L0,0 Z"
            fill="url(#waveGrad1)"
            className="animate-pulse-slow"
          />
          <path
            d="M0,800 C300,700 700,900 1000,800 L1000,1000 L0,1000 Z"
            fill="url(#waveGrad1)"
            className="animate-pulse-slow"
            style={{ animationDelay: '3s' }}
          />
        </svg>
      </div>

      <div className="max-w-4xl mx-auto relative">
        <motion.div className="text-center mb-16" variants={headerVariants}>
          <div className="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-8 py-4 shadow-lg border border-white/60 mb-8">
            <HelpCircle className="w-6 h-6 text-teal-600" />
            <span className="text-teal-700 font-semibold text-lg">
              {dict.header}
            </span>
          </div>

          <h2 className="text-4xl sm:text-5xl md:text-6xl font-bold text-gray-800 mb-6 leading-tight">
            {dict.title_part1}
            {/* Updated Title Gradient */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500">
              {' '}
              {dict.title_highlight}
            </span>
          </h2>

          {/* Updated Divider Lines */}
          <div className="flex items-center justify-center gap-2 mb-8">
            <div className="w-16 h-1 bg-gradient-to-r from-teal-400 to-orange-500 rounded-full"></div>
            <div className="w-3 h-3 bg-gradient-to-r from-orange-400 to-rose-500 rounded-full"></div>
            <div className="w-16 h-1 bg-gradient-to-r from-rose-500 to-pink-500 rounded-full"></div>
          </div>

          <p className="text-xl md:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </motion.div>

        <motion.div className="relative mb-16" variants={faqContainerVariants}>
          <div className="absolute inset-0 -m-4 bg-white/60 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/40"></div>

          <div className="relative p-8 md:p-12">
            <div className="space-y-1">
              {dict.questions.map((item, index) => (
                <motion.div
                  key={item.question}
                  variants={faqItemVariants}
                  whileHover={{ x: 4 }}
                  transition={{ duration: 0.2 }}
                  className="group"
                >
                  <div className="bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-100/80 hover:border-teal-200 transition-all duration-300 hover:shadow-lg overflow-hidden">
                    <div className="relative">
                      <div
                        className={`h-1 bg-gradient-to-r ${faqIcons[index % faqIcons.length].color} opacity-60 group-hover:opacity-100 transition-opacity duration-300`}
                      ></div>
                      <div className="p-6">
                        <div className="flex items-center gap-4 mb-4">
                          <div
                            className={`p-3 rounded-full bg-gradient-to-r ${faqIcons[index % faqIcons.length].color} text-white shadow-lg group-hover:scale-110 transition-transform duration-300`}
                          >
                            {faqIcons[index % faqIcons.length].icon}
                          </div>
                          <h3 className="text-xl font-bold text-gray-800 flex-1">
                            {item.question}
                          </h3>
                        </div>
                        <div className="relative">
                          {/* Note: Passing empty question to FAQItem as the title is already displayed above */}
                          <FAQItem question="" answer={item.answer} />
                        </div>
                      </div>
                      <div className="absolute bottom-0 right-0 w-32 h-32 opacity-5">
                        <div
                          className={`w-full h-full bg-gradient-to-tl ${faqIcons[index % faqIcons.length].color} rounded-full transform translate-x-16 translate-y-16`}
                        ></div>
                      </div>
                    </div>
                  </div>
                </motion.div>
              ))}
            </div>
          </div>
        </motion.div>

        <motion.div
          className="relative text-center"
          variants={contactBlockVariants}
        >
          {/* Updated Contact Block Background */}
          <div className="absolute inset-0 -m-8 bg-gradient-to-br from-teal-500/10 via-orange-500/5 to-rose-500/10 rounded-3xl backdrop-blur-sm border border-white/30"></div>

          <div className="relative max-w-2xl mx-auto p-12">
            <motion.div
              // Updated Icon Background
              className="inline-block mb-6 p-4 bg-gradient-to-r from-teal-500 to-orange-600 rounded-full shadow-xl"
              whileHover={{ rotate: [0, -10, 10, 0], scale: 1.1 }}
              transition={{ duration: 0.6 }}
            >
              <MessageCircle className="w-8 h-8 text-white" />
            </motion.div>

            <h3 className="text-3xl font-bold text-gray-800 mb-4">
              {dict.contact_block.title_part1}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                {' '}
                {dict.contact_block.title_highlight}
              </span>
            </h3>

            <p className="text-lg text-gray-600 mb-8 leading-relaxed">
              {dict.contact_block.subtitle}
            </p>

            <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <Link href={`/${locale}/contact`}>
                <motion.div
                  whileHover={{ scale: 1.05, y: -2 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Button
                    size="lg"
                    // Updated Button Gradient
                    className="bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl px-8 py-4 text-lg font-semibold group"
                  >
                    <span className="flex items-center gap-3">
                      {dict.contact_block.button}
                      {locale === 'he' ? (
                        <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                      ) : (
                        <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                      )}{' '}
                    </span>
                  </Button>
                </motion.div>
              </Link>

              <div className="flex items-center gap-3 text-gray-600">
                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span className="font-medium">
                  {dict.contact_block.availability}
                </span>
              </div>
            </div>
          </div>
        </motion.div>
      </div>

      <style>{`
        @keyframes float-slow {
          0%,
          100% {
            transform: translateY(0px) rotate(0deg);
          }
          50% {
            transform: translateY(-20px) rotate(2deg);
          }
        }
        @keyframes pulse-slow {
          0%,
          100% {
            opacity: 0.8;
          }
          50% {
            opacity: 1;
          }
        }
        .animate-float-slow {
          animation: float-slow 8s ease-in-out infinite;
        }
        .animate-pulse-slow {
          animation: pulse-slow 4s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default FAQSection;
--- End of Content for FAQSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\FooterSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/FooterSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Heart } from 'lucide-react';
import { FooterLink, FooterItem } from '../components/FooterComponents';
import type { FooterDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface FooterProps {
  dict: FooterDict;
}

const FooterSection: React.FC<FooterProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.2,
      },
    },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const logoVariants = {
    hidden: { opacity: 0, scale: 0.8, y: 20 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };
  const columnVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.05,
      },
    },
  };
  const listItemVariants = {
    hidden: { opacity: 0, x: -10 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.4, ease: 'easeOut' },
    },
  };
  const bottomSectionVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut', delay: 0.5 },
    },
  };
  return (
    <motion.footer
      ref={ref}
      // Background: Slate-900 with gradients matching the Hero theme
      className="bg-gradient-to-br from-slate-900 to-slate-800 text-white py-12 md:py-16 px-4 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwVjB6bTEwIDEwaDIwdjIwSDEwVjEweiIvPjwvZz48L2c+PC9zdmc+')]"></div>

      <div className="max-w-6xl mx-auto relative">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 md:gap-12">
          <motion.div className="md:col-span-1" variants={logoVariants}>
            <motion.div
              whileHover={{ scale: 1.05 }}
              transition={{ duration: 0.2 }}
            >
              <Link href="/" className="flex items-center gap-2 group mb-6">
                <div className="relative overflow-hidden rounded-full p-1 transition-all duration-300 group-hover:scale-110">
                  {/* Heart Icon: Rose color for warmth */}
                  <Heart
                    className="h-7 w-7 text-rose-500 transition-all duration-300 group-hover:text-rose-400"
                    fill="#1e293b"
                  />
                </div>
                {/* Logo Text Hover: Orange */}
                <span className="text-xl font-bold text-white group-hover:text-orange-300 transition-all duration-300">
                  NeshamaTech
                </span>
              </Link>
            </motion.div>
            <motion.p className="text-gray-400 mb-6" variants={fadeInUp}>
              {dict.description}
            </motion.p>
          </motion.div>

          {/* Navigation Column */}
          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              {/* Header Gradient: Teal -> Orange */}
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-orange-400">
                {dict.columns.navigation.title}
              </span>
              {/* Separator Line: Teal/Orange */}
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-teal-400/30 to-orange-400/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.navigation.links.map((link) => (
                <motion.div key={link.href} variants={listItemVariants}>
                  <FooterLink href={link.href}>{link.text}</FooterLink>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>

          {/* Information Column */}
          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              {/* Header Gradient: Teal -> Orange */}
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-orange-400">
                {dict.columns.information.title}
              </span>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-teal-400/30 to-orange-400/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.information.links.map((link) => (
                <motion.div key={link.href} variants={listItemVariants}>
                  <FooterLink href={link.href}>{link.text}</FooterLink>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>

          {/* Contact Column */}
          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              {/* Header Gradient: Teal -> Orange */}
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-orange-400">
                {dict.columns.contact.title}
              </span>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-teal-400/30 to-orange-400/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.contact.items.map((item) => (
                <motion.div key={item.text} variants={listItemVariants}>
                  <FooterItem icon={item.icon} text={item.text} />
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
        </div>

        <motion.div
          className="mt-8 md:mt-12 pt-6 md:pt-8 border-t border-slate-700/50"
          variants={bottomSectionVariants}
        >
          <div className="text-center">
            <motion.div
              className="mb-4"
              whileHover={{ scale: 1.05 }}
              transition={{ duration: 0.2 }}
            >
              {/* Motto Badge: Teal/Orange background */}
              <span className="inline-block px-4 py-2 rounded-full bg-gradient-to-r from-teal-500/10 to-orange-400/10 text-teal-400 hover:from-teal-500/20 hover:to-orange-400/20 transition-colors duration-300 border border-teal-500/20">
                {dict.motto}
              </span>
            </motion.div>
            <p className="text-gray-400">{dict.copyright}</p>
          </div>
        </motion.div>
      </div>
    </motion.footer>
  );
};
export default FooterSection;
--- End of Content for FooterSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\HeroSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/HeroSection.tsx

'use client';

import React, { useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import {
  ArrowLeft,
  ArrowRight,
  Shield,
  User,
  BookOpen,
  Brain,
  Handshake,
} from 'lucide-react';
import { Session } from 'next-auth';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import type { HeroSectionDict, PrincipleDict } from '@/types/dictionary';

interface HeroSectionProps {
  session: Session | null;
  isVisible: boolean;
  dict: HeroSectionDict;
  locale: 'he' | 'en';
}

// --- קומפוננטת מכונת הכתיבה (מעודכנת לצבעים החדשים) ---
const TypewriterText: React.FC<{
  text: string;
  delay?: number;
  speed?: number;
  className?: string;
  locale: 'he' | 'en';
}> = ({ text, delay = 0, speed = 30, className = '', locale }) => {
  const [displayedText, setDisplayedText] = useState('');
  const [isStarted, setIsStarted] = useState(false);
  const [isFinished, setIsFinished] = useState(false);

  useEffect(() => {
    const startTimer = setTimeout(() => setIsStarted(true), delay);
    return () => clearTimeout(startTimer);
  }, [delay]);

  useEffect(() => {
    if (!isStarted || displayedText.length >= text.length) return;
    const interval = setInterval(() => {
      setDisplayedText(text.substring(0, displayedText.length + 1));
    }, speed);
    return () => clearInterval(interval);
  }, [displayedText, text, speed, isStarted]);

  useEffect(() => {
    if (!isStarted || isFinished) return;
    if (displayedText.length >= text.length) {
      setIsFinished(true);
      return;
    }
    const interval = setInterval(() => {
      setDisplayedText(text.substring(0, displayedText.length + 1));
    }, speed);
    return () => clearInterval(interval);
  }, [displayedText, text, speed, isStarted, isFinished]);

  const dynamicStyle: React.CSSProperties = {
    direction: locale === 'he' ? 'rtl' : 'ltr',
    textAlign: isFinished ? 'center' : locale === 'he' ? 'right' : 'left',
    width: '100%',
  };

  return (
    <div
      className={className}
      aria-label={text}
      aria-live="polite"
      style={dynamicStyle}
    >
      {displayedText}
      {!isFinished && (
        // צבע הסמן עודכן ל-Teal/Orange
        <span className="inline-block w-0.5 h-6 bg-gradient-to-b from-teal-500 via-orange-400 to-teal-500 animate-pulse ml-1 align-text-top shadow-sm shadow-teal-400/40 rounded-full"></span>
      )}
    </div>
  );
};

// --- קומפוננטות העקרונות ---
const principleIcons = [
  <BookOpen
    key="principle-icon-1"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
  <Shield
    key="principle-icon-2"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
  <User
    key="principle-icon-3"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
];

// --- קומפוננטת כרטיסיית העקרונות (מעודכנת לפלטה החדשה) ---
interface DesktopPrincipleCardProps {
  principle: PrincipleDict;
  index: number;
}
const DesktopPrincipleCard: React.FC<DesktopPrincipleCardProps> = ({
  principle,
  index,
}) => {
  const getColors = (idx: number) => {
    const colors = [
      {
        // Teal / Knowledge
        gradient: 'from-teal-400 via-teal-500 to-emerald-500',
        shadowColor: 'shadow-teal-500/25',
        glowColor: 'shadow-teal-400/30',
        bgGradient: 'from-teal-50 via-white to-emerald-50',
      },
      {
        // Orange / Privacy (Shifted from Purple to Orange/Amber to match Landing)
        gradient: 'from-orange-400 via-amber-500 to-yellow-500',
        shadowColor: 'shadow-orange-500/25',
        glowColor: 'shadow-orange-400/30',
        bgGradient: 'from-orange-50 via-white to-amber-50',
      },
      {
        // Rose / Personal (Shifted from Pink to Rose)
        gradient: 'from-rose-400 via-pink-500 to-red-500',
        shadowColor: 'shadow-rose-500/25',
        glowColor: 'shadow-rose-400/30',
        bgGradient: 'from-rose-50 via-white to-red-50',
      },
    ];
    return colors[idx % colors.length];
  };

  const colors = getColors(index);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5, delay: 0.7 + index * 0.1 }}
      whileHover={{ y: -8, scale: 1.02 }}
      className={`group relative overflow-hidden rounded-3xl bg-gradient-to-br ${colors.bgGradient} p-8 ${colors.shadowColor} shadow-2xl border border-white/60 h-full transition-all duration-500`}
    >
      <div className="absolute top-4 right-4 w-20 h-20 rounded-full bg-gradient-to-br from-white/30 to-transparent blur-xl" />
      <div className="absolute bottom-4 left-4 w-12 h-12 rounded-full bg-gradient-to-br from-white/40 to-transparent blur-lg" />
      <div className="relative z-10 h-full flex flex-col">
        <div className="flex items-center justify-center mb-6">
          <div
            className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${colors.gradient} flex items-center justify-center text-white ${colors.glowColor} shadow-xl transform group-hover:rotate-12 transition-transform duration-500`}
          >
            {principleIcons[index]}
            <div className="absolute inset-0 rounded-2xl bg-white/15 backdrop-blur-sm" />
          </div>
        </div>
        <h4 className="font-bold text-gray-800 text-lg mb-4 text-center leading-tight">
          {principle.title}
        </h4>
        <p className="text-gray-700 text-sm leading-relaxed text-center flex-1">
          {principle.description}
        </p>
        <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
      </div>
    </motion.div>
  );
};

// --- קומפוננטת הטאבים למובייל (מעודכנת) ---
interface MobilePrinciplesTabsProps {
  isVisible: boolean;
  dict: {
    principlesHeader: { title: string; subtitle: string };
    principles: PrincipleDict[];
  };
}
const MobilePrinciplesTabs: React.FC<MobilePrinciplesTabsProps> = ({
  dict,
}) => {
  const [activeTab, setActiveTab] = useState(0);

  const principlesData = useMemo(
    () =>
      dict.principles.map((p, index) => {
        const colors = [
          {
            // Teal
            gradient: 'from-teal-400 via-teal-500 to-emerald-500',
            shadowColor: 'shadow-teal-500/25',
            glowColor: 'shadow-teal-400/30',
            bgGradient: 'from-teal-50 via-white to-emerald-50',
            accentColor: 'bg-teal-500',
          },
          {
            // Orange/Amber
            gradient: 'from-orange-400 via-amber-500 to-yellow-500',
            shadowColor: 'shadow-orange-500/25',
            glowColor: 'shadow-orange-400/30',
            bgGradient: 'from-orange-50 via-white to-amber-50',
            accentColor: 'bg-orange-500',
          },
          {
            // Rose
            gradient: 'from-rose-400 via-pink-500 to-red-500',
            shadowColor: 'shadow-rose-500/25',
            glowColor: 'shadow-rose-400/30',
            bgGradient: 'from-rose-50 via-white to-red-50',
            accentColor: 'bg-rose-500',
          },
        ];
        return {
          ...p,
          icon: principleIcons[index],
          ...colors[index % colors.length],
        };
      }),
    [dict.principles]
  );

  return (
    <div className="w-full">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.6 }}
        className="text-center mb-8"
      >
        <h3 className="text-2xl font-bold text-gray-800 mb-3">
          {dict.principlesHeader.title}
        </h3>
        <p className="text-gray-600 text-sm max-w-sm mx-auto leading-relaxed">
          {dict.principlesHeader.subtitle}
        </p>
        <div className="relative mt-4">
          <div className="w-16 h-0.5 bg-gradient-to-r from-teal-400 via-orange-400 to-rose-400 rounded-full mx-auto" />
          <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rounded-full border-2 border-orange-400" />
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.7 }}
        className="relative mb-6"
      >
        <div className="relative bg-white/90 rounded-2xl p-2 shadow-xl border border-white/30">
          <div className="relative flex">
            {principlesData.map((principle, index) => (
              <button
                key={index}
                className={`flex-1 py-3 px-1 flex flex-col items-center justify-center gap-2 relative z-20 rounded-xl transition-all duration-500 ${activeTab === index ? `bg-gradient-to-r ${principle.gradient} ${principle.shadowColor} shadow-lg` : 'bg-transparent hover:bg-white/40'}`}
                onClick={() => setActiveTab(index)}
              >
                <div
                  className={`flex items-center justify-center mb-2 transition-all duration-300 ${activeTab === index ? 'scale-110' : 'hover:scale-105'}`}
                >
                  <div
                    className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300 ${activeTab === index ? `bg-gradient-to-br ${principle.gradient} shadow-lg` : 'bg-white/60 shadow-sm'}`}
                  >
                    {React.cloneElement(principle.icon as React.ReactElement<{ className?: string; strokeWidth?: number }>, {
                      className: `w-5 h-5 ${activeTab === index ? 'text-white' : 'text-gray-700'}`,
                      strokeWidth: 2.5,
                    })}
                  </div>
                </div>
                <div
                  className={`text-xs font-bold text-center leading-tight flex items-center justify-center px-1 transition-all duration-300 ${activeTab === index ? 'text-white [text-shadow:0_1px_2px_rgba(0,0,0,0.3)] transform scale-105' : 'text-gray-900 hover:text-black'}`}
                >
                  <span className="relative">
                    {principle.shortTitle}
                    {activeTab === index && (
                      <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-4 h-0.5 bg-white/60 rounded-full" />
                    )}
                  </span>
                </div>
              </button>
            ))}
          </div>
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.8 }}
        className="relative"
      >
        <AnimatePresence mode="wait">
          {principlesData.map(
            (principle, index) =>
              activeTab === index && (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: 50, scale: 0.95 }}
                  animate={{ opacity: 1, x: 0, scale: 1 }}
                  exit={{ opacity: 0, x: -50, scale: 0.95 }}
                  transition={{ duration: 0.4, ease: 'easeInOut' }}
                  className="absolute inset-0"
                >
                  <div
                    className={`relative overflow-hidden rounded-3xl bg-gradient-to-br ${principle.bgGradient} p-8 ${principle.shadowColor} shadow-2xl border border-white/50`}
                  >
                    <div className="relative z-10">
                      <div className="flex items-center justify-center mb-6">
                        <div
                          className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${principle.gradient} flex items-center justify-center text-white ${principle.glowColor} shadow-xl`}
                        >
                          {principle.icon}
                        </div>
                      </div>
                      <h4 className="font-bold text-gray-800 text-xl mb-4 text-center leading-tight tracking-wide">
                        {principle.title}
                      </h4>
                      <p className="text-gray-700 text-base leading-relaxed text-center px-2 max-w-md mx-auto">
                        {principle.description}
                      </p>
                      <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
                    </div>
                  </div>
                </motion.div>
              )
          )}
        </AnimatePresence>
        <div className="h-80" />
      </motion.div>
    </div>
  );
};

// --- הרכיב הראשי - HeroSection ---
const HeroSection: React.FC<HeroSectionProps> = ({
  isVisible,
  dict,
  locale,
}) => {
  const logoUrl =
    'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png';

  return (
    <motion.section
      className="relative min-h-screen pt-12 pb-16 md:pt-16 md:pb-20 overflow-hidden flex flex-col items-center justify-center w-full px-4 sm:px-6 lg:px-8"
      initial="hidden"
      animate={isVisible ? 'visible' : 'hidden'}
      transition={{ staggerChildren: 0.2 }}
    >
      {/* רקע מעודכן - תואם ל-Landing Page */}
      <div
        className="absolute inset-0 bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20 animate-gradient-slow"
        style={{ backgroundSize: '400% 400%' }}
      />
      <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:20px_20px]"></div>
      
      {/* Orbs צבעוניים - Teal, Orange, Rose */}
      <div className="absolute top-[15%] left-[5%] w-72 h-72 rounded-full bg-teal-300/20 blur-3xl animate-float-slow"></div>
      <div
        className="absolute bottom-[20%] right-[5%] w-64 h-64 rounded-full bg-orange-300/20 blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      ></div>
       <div
        className="absolute top-[40%] right-[15%] w-48 h-48 rounded-full bg-rose-300/15 blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      ></div>

      <div className="relative z-10 w-full max-w-7xl mx-auto flex flex-col items-center">
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, ease: 'easeOut' }}
          className="text-center"
        >
   <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-extrabold text-gray-800 tracking-tight leading-tight">
            {dict.titleLine1}
            <br className="sm:hidden" />
            {/* גרדיאנט כותרת מעודכן - תואם לכפתור (Teal -> Orange -> Amber) */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 animate-gradient mx-3">
              {dict.highlightedWord}
            </span>
          </h1>
          <div className="mt-6 max-w-4xl mx-auto text-lg md:text-xl leading-relaxed min-h-[8rem] md:min-h-[6rem]">
            <div className="relative group">
              <div className="absolute inset-0 bg-gradient-to-br from-white/70 via-teal-50/40 to-orange-50/40 backdrop-blur-lg rounded-3xl border-2 border-white/70 shadow-2xl group-hover:shadow-teal-200/30 transition-all duration-500"></div>
              <div className="relative p-8 md:p-10">
                {isVisible && (
                  <TypewriterText
                    text={dict.typewriterText}
                    delay={1200}
                    speed={32}
                    className="block text-center leading-relaxed text-transparent bg-clip-text bg-gradient-to-br from-gray-700 via-gray-600 to-gray-700 font-bold tracking-wide drop-shadow-sm"
                    locale={locale}
                  />
                )}
              </div>
              {/* קו תחתון - Teal/Orange */}
              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-20 h-1.5 bg-gradient-to-r from-teal-400 via-orange-400 to-teal-400 rounded-full shadow-lg shadow-orange-300/40"></div>
            </div>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, delay: 0.2 }}
          className="w-full max-w-4xl mt-12 md:mt-16"
          aria-hidden="true"
        >
          {/* START: ויזואליזציית סינרגיה - מובייל (צבעים מעודכנים) */}
          <div className={`md:hidden relative h-64`}>
            <svg
              className="absolute inset-0 w-full h-full overflow-visible"
              viewBox="0 0 320 256"
            >
              <defs>
                <filter id="glow-mobile">
                  <feGaussianBlur
                    stdDeviation="3.5"
                    result="coloredBlur"
                  ></feGaussianBlur>
                  <feMerge>
                    <feMergeNode in="coloredBlur"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                  </feMerge>
                </filter>
              </defs>
              {/* קו שמאלי (טכנולוגי) - Teal */}
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 30 128 C 90 60, 130 60, 160 110"
                stroke="#0d9488" 
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow-mobile)"
              />
              {/* קו ימני (אנושי) - Orange */}
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 290 128 C 230 196, 190 196, 160 110"
                stroke="#f97316" 
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow-mobile)"
              />
            </svg>

            {/* אלמנט שמאל - כלים טכנולוגיים */}
            <div
              className={`absolute top-1/2 left-4 -translate-y-1/2 flex flex-col items-center gap-2 opacity-0 ${isVisible ? 'animate-synergy-enter-left' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Brain className="w-8 h-8 text-teal-600" />
              </div>
              <span className="font-bold text-gray-700 text-sm text-center">
                {dict.synergy.techTools}
              </span>
            </div>

            {/* אלמנט ימין - ליווי אישי */}
            <div
              className={`absolute top-1/2 right-4 -translate-y-1/2 flex flex-col items-center gap-2 opacity-0 ${isVisible ? 'animate-synergy-enter-right' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Handshake className="w-8 h-8 text-orange-500" />
              </div>
              <span className="font-bold text-gray-700 text-sm text-center">
                {dict.synergy.personalGuidance}
              </span>
            </div>

            {/* לוגו במרכז */}
            <div
              className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 ${isVisible ? 'animate-match-point-appear' : ''}`}
            >
              <div className="p-3 bg-gradient-to-br from-white to-orange-50 rounded-full shadow-2xl border-2 border-white">
                <div className="relative w-9 h-9">
                  <Image
                    src={getRelativeCloudinaryPath(logoUrl)}
                    alt="NeshamaTech Logo"
                    fill
                    className="object-contain"
                  />
                </div>
              </div>
            </div>
          </div>
          {/* END: ויזואליזציית סינרגיה למובייל */}

          {/* ויזואליזציית סינרגיה - דסקטופ (צבעים מעודכנים) */}
          <div className={`hidden md:block relative h-64`}>
            <div
              className={`absolute top-1/2 left-0 -translate-y-1/2 flex items-center gap-3 opacity-0 ${isVisible ? 'animate-synergy-enter-left' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Brain className="w-8 h-8 text-teal-600" />
              </div>
              <span className="font-bold text-gray-700">
                {dict.synergy.techTools}
              </span>{' '}
            </div>
            <div
              className={`absolute top-1/2 right-0 -translate-y-1/2 flex items-center gap-3 opacity-0 ${isVisible ? 'animate-synergy-enter-right' : ''}`}
            >
              <span className="font-bold text-gray-700">
                {dict.synergy.personalGuidance}
              </span>
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Handshake className="w-8 h-8 text-orange-500" />
              </div>
            </div>
            <svg
              className="absolute inset-0 w-full h-full overflow-visible"
              viewBox="0 0 700 256"
            >
              <defs>
                <filter id="glow">
                  <feGaussianBlur
                    stdDeviation="3.5"
                    result="coloredBlur"
                  ></feGaussianBlur>
                  <feMerge>
                    <feMergeNode in="coloredBlur"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                  </feMerge>
                </filter>
              </defs>
              {/* קו שמאלי - Teal */}
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 60 128 C 180 50, 280 50, 350 128"
                stroke="#0d9488"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow)"
              />
              {/* קו ימני - Orange */}
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 640 128 C 520 200, 420 200, 350 128"
                stroke="#f97316"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow)"
              />
            </svg>
            <div
              className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 ${isVisible ? 'animate-match-point-appear' : ''}`}
            >
              <div className="flex items-center gap-3 p-3 bg-gradient-to-br from-white to-orange-50 rounded-full shadow-2xl border-2 border-white">
                <div className="relative w-9 h-9">
                  <Image
                    src={getRelativeCloudinaryPath(logoUrl)}
                    alt="NeshamaTech Logo"
                    fill
                    className="object-contain"
                  />
                </div>
                <span className="font-bold text-xl text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                  NeshamaTech
                </span>
              </div>
            </div>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, delay: 0.4 }}
          className="mt-8 flex flex-row items-center justify-center gap-4"
        >
          {/* כפתור ראשי - גרדיאנט חדש */}
          <Link href={`/${locale}/auth/register`}>
            <Button
              size="lg"
              className="text-base md:text-lg px-8 py-6 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group"
            >
              <span className="hidden md:inline">{dict.ctaButton}</span>
              <span className="md:hidden">
                {dict.ctaButtonShort || dict.ctaButton}
              </span>
              {locale === 'he' ? (
                <ArrowLeft className="mr-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              ) : (
                <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              )}
            </Button>
          </Link>
          {/* כפתור משני - צבעים מעודכנים */}
          <Link
            href={`/${locale}/questionnaire`}
            id="onboarding-target-questionnaire-button"
          >
            <Button
              variant="outline"
              size="lg"
              className="text-base md:text-lg px-8 py-6 border-2 border-teal-200 text-teal-700 bg-white/50 hover:bg-white hover:border-teal-300 rounded-full transition-all duration-300"
            >
              <span className="hidden md:inline">{dict.secondaryButton}</span>
              <span className="md:hidden">
                {dict.secondaryButtonShort || dict.secondaryButton}
              </span>{' '}
            </Button>
          </Link>
        </motion.div>

        <div className="mt-12 sm:mt-16 w-full max-w-6xl">
          <div className="md:hidden">
            <MobilePrinciplesTabs
              isVisible={isVisible}
              dict={{
                principlesHeader: dict.principlesHeader,
                principles: dict.principles,
              }}
            />
          </div>
          <div className="hidden md:block">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.7, delay: 0.6 }}
            >
              <div className="text-center mb-8">
                <h3 className="text-2xl font-bold text-gray-800 mb-3">
                  {dict.principlesHeader.title}
                </h3>
                <p className="text-gray-600 max-w-md mx-auto">
                  {dict.principlesHeader.subtitle}
                </p>
                <div className="relative mt-4">
                  {/* מפריד צבעוני מעודכן */}
                  <div className="w-16 h-0.5 bg-gradient-to-r from-teal-400 via-orange-400 to-rose-400 rounded-full mx-auto" />
                  <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rounded-full border-2 border-orange-400" />
                </div>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {dict.principles.map((principle, index) => (
                  <DesktopPrincipleCard
                    key={index}
                    principle={principle}
                    index={index}
                  />
                ))}
              </div>
            </motion.div>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes gradient-slow {
          0%,
          100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .animate-gradient-slow {
          animation: gradient-slow 15s ease infinite;
        }
        @keyframes gradient {
          0%,
          100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .animate-gradient {
          background-size: 200% 200%;
          animation: gradient 4s ease-in-out infinite;
        }
        @keyframes float-slow {
          0%,
          100% {
            transform: translateY(0) translateX(0);
          }
          25% {
            transform: translateY(-15px) translateX(10px);
          }
          50% {
            transform: translateY(-5px) translateX(20px);
          }
          75% {
            transform: translateY(-10px) translateX(5px);
          }
        }
        .animate-float-slow {
          animation: float-slow 12s ease-in-out infinite;
        }
        @keyframes synergy-enter-left {
          from {
            opacity: 0;
            transform: translateY(-50%) translateX(-40px);
          }
          to {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
          }
        }
        .animate-synergy-enter-left {
          animation: synergy-enter-left 0.8s 0.2s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
        @keyframes synergy-enter-right {
          from {
            opacity: 0;
            transform: translateY(-50%) translateX(40px);
          }
          to {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
          }
        }
        .animate-synergy-enter-right {
          animation: synergy-enter-right 0.8s 0.2s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
        @keyframes path-draw-anim {
          to {
            stroke-dashoffset: 0;
          }
        }
        .path-draw {
          stroke-dasharray: 1000;
          stroke-dashoffset: 1000;
          animation: path-draw-anim 1s 0.7s ease-out forwards;
        }
        @keyframes match-point-appear {
          from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
          }
          to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
          }
        }
        .animate-match-point-appear {
          animation: match-point-appear 0.6s 1.4s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
      `}</style>
    </motion.section>
  );
};

export default HeroSection;
--- End of Content for HeroSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\HowItWorksSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/HowItWorksSection.tsx
'use client';

import React, { useRef } from 'react';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import Step from '../components/Step';
import { LiveSuggestionDemo } from '../components/LiveSuggestionDemo';

import { Button } from '@/components/ui/button';
import Link from 'next/link';
import {
  ArrowLeft,
  Sparkles,
  ArrowRight,
  Heart,
  CheckCircle,
  Quote,
  Star,
  Lightbulb,
  TrendingUp,
  Award,
  HeartHandshake,
  Zap,
} from 'lucide-react';
import { motion, useInView } from 'framer-motion';
import type {
  HowItWorksDict,
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary';
import { generateDemoData } from '../components/demo-data';

type DemoData = Awaited<ReturnType<typeof generateDemoData>>;

interface HowItWorksProps {
  dict: HowItWorksDict;
  suggestionsDict: SuggestionsDictionary;
  profileCardDict: ProfileCardDict;
  demoData: DemoData;
  locale: 'he' | 'en';
}

// --- START: Helper Components ---

// 1. רקע דינמי משודרג (מותאם ב-100% לפלטת ה-Hero)
const DynamicBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none select-none">
    <div className="absolute inset-0 bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20" />
    <div className="absolute inset-0 opacity-30">
      {/* Teal Orb */}
      <div className="absolute top-10 left-10 w-72 h-72 bg-teal-300/20 rounded-full blur-3xl animate-float-slow" />
      {/* Orange Orb */}
      <div
        className="absolute top-1/3 right-20 w-64 h-64 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      />
      {/* Rose Orb */}
      <div
        className="absolute bottom-20 left-1/3 w-80 h-80 bg-rose-300/15 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      />
      {/* Amber Orb */}
      <div
        className="absolute bottom-1/4 right-1/4 w-56 h-56 bg-amber-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '6s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:30px_30px]" />
  </div>
);

// 2. כרטיס יתרון עם צבעים מעודכנים (תואם ל-DesktopPrincipleCard מה-Hero)
const KeyBenefit: React.FC<{
  icon: React.ReactNode;
  title: string;
  description: string;
  color: 'teal' | 'rose' | 'amber' | 'orange';
  delay?: number;
}> = ({ icon, title, description, color, delay = 0 }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  const colorClasses = {
    // Teal / Knowledge style
    teal: {
      bg: 'from-teal-400 via-teal-500 to-emerald-500',
      shadow: 'shadow-teal-500/25',
    },
    // Rose / Personal style
    rose: {
      bg: 'from-rose-400 via-pink-500 to-red-500',
      shadow: 'shadow-rose-500/25',
    },
    // Amber style
    amber: {
      bg: 'from-amber-400 via-yellow-500 to-orange-500',
      shadow: 'shadow-amber-500/25',
    },
    // Orange / Privacy style (Updated to match Hero)
    orange: {
      bg: 'from-orange-400 via-amber-500 to-yellow-500',
      shadow: 'shadow-orange-500/25',
    },
  };

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.6, delay }}
      className="text-center group p-6 bg-gradient-to-br from-white via-white to-slate-50 backdrop-blur-md rounded-3xl border border-white/60 shadow-lg hover:shadow-xl transition-all duration-300 h-full"
    >
      <div
        className={`w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br ${colorClasses[color].bg} ${colorClasses[color].shadow} flex items-center justify-center shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-transform duration-300 text-white`}
      >
        {icon}
      </div>
      <h4 className="font-bold text-lg text-gray-800 mb-2">{title}</h4>
      <p className="text-gray-600 text-sm leading-relaxed">{description}</p>
    </motion.div>
  );
};
// --- END: Helper Components ---

const HowItWorksSection: React.FC<HowItWorksProps> = ({
  dict,
  suggestionsDict,
  demoData,
  profileCardDict,
  locale,
}) => {
  const demoRef = useRef(null);
  const isDemoInView = useInView(demoRef, { once: true, amount: 0.1 });

  // מערך צבעים תואם לפלטת ה-Hero (Teal, Amber, Rose, Orange)
  const stepColors = ['teal', 'amber', 'rose', 'orange'] as const;

  const benefitDetails = [
    {
      icon: <TrendingUp className="w-8 h-8" />,
      color: 'teal' as const,
    },
    { icon: <Award className="w-8 h-8" />, color: 'rose' as const },
    {
      icon: <Lightbulb className="w-8 h-8" />,
      color: 'amber' as const,
    },
    {
      icon: <HeartHandshake className="w-8 h-8" />,
      color: 'orange' as const,
    },
  ];

  const ArrowIcon = locale === 'he' ? ArrowLeft : ArrowRight;

  return (
    <section
      id="how-it-works"
      className="relative pb-20 md:pb-28 px-4 overflow-hidden"
    >
      <DynamicBackground />

      <div className="relative max-w-7xl mx-auto pt-16">
        {/* --- Chapter 1: The Promise --- */}
        <motion.div
          initial={{ opacity: 0, y: 50 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.2 }}
          transition={{ duration: 1 }}
          className="text-center mb-20"
        >
          <div className="inline-block mb-6">
            <div className="flex items-center gap-3 bg-white/90 backdrop-blur-sm rounded-full px-6 py-3 shadow-lg border border-teal-100/50">
              <Sparkles className="w-5 h-5 text-teal-500" />
              <span className="text-teal-700 font-bold text-sm tracking-wide">
                {dict.promise.header}
              </span>
            </div>
          </div>
          <h2 className="text-4xl sm:text-5xl md:text-6xl font-extrabold text-gray-800 mb-8 leading-tight tracking-tight">
            {dict.promise.title_line1}
            <br />
            {dict.promise.title_line2_part1}{' '}
            {/* Updated Gradient: Teal -> Orange -> Amber (Matching Hero) */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 animate-gradient">
              {dict.promise.title_line2_part2}
            </span>
          </h2>
          <p className="text-xl md:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed mb-8">
            {dict.promise.subtitle_line1}
            <br />
            <span className="text-teal-700 font-semibold bg-teal-50 px-2 rounded-lg">
              {dict.promise.subtitle_line2}
            </span>
          </p>
        </motion.div>

        {/* --- Chapter 2: The Process --- */}
        <div className="relative mb-24">
          {/* Card Background Updated: White/Teal/Orange Mix */}
          <div className="absolute inset-0 -m-8 bg-gradient-to-br from-white/80 via-teal-50/40 to-orange-50/40 rounded-[3rem] backdrop-blur-xl border border-white/60 shadow-2xl" />
          <div className="relative max-w-5xl mx-auto space-y-12 p-8">
            {dict.process.steps.map((step, index) => (
              <Step
                key={index}
                number={`${index + 1}`}
                title={step.title}
                description={
                  <>
                    {step.description}
                    {step.linkText && (
                      <Link
                        href={`/${locale}/questionnaire`}
                        className="font-bold text-teal-600 hover:text-teal-700 hover:underline decoration-2 underline-offset-4 transition-all"
                      >
                        {' '}
                        {step.linkText}
                      </Link>
                    )}
                  </>
                }
                color={stepColors[index]}
                isLast={index === dict.process.steps.length - 1}
              />
            ))}
          </div>
        </div>

        {/* --- Chapter 3: The Proof --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.02 }}
          transition={{ duration: 0.8 }}
          className="relative mb-24"
        >
          <div className="text-center mb-16">
            <div
              id="suggestion-demo"
              // Badge: Orange -> Rose Gradient
              className="inline-flex items-center gap-3 bg-gradient-to-r from-orange-500 to-rose-500 text-white rounded-full px-6 py-3 shadow-lg mb-6"
            >
              <Star className="w-5 h-5 fill-white" />
              <span className="font-bold tracking-wide">
                {dict.proof.header}
              </span>
            </div>
            <h3 className="text-3xl md:text-4xl font-bold text-gray-800 mb-6">
              {dict.proof.title_part1}
              {/* Gradient: Orange -> Amber -> Red */}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-600 via-amber-500 to-red-600">
                {' '}
                {dict.proof.title_part2}
              </span>
            </h3>
            <p className="text-lg text-gray-600 max-w-4xl mx-auto leading-relaxed">
              {dict.proof.subtitle}
            </p>
          </div>

          <motion.div
            ref={demoRef}
            initial={{ opacity: 0, y: 30 }}
            animate={
              isDemoInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }
            }
            transition={{ duration: 0.8, delay: 0.2 }}
            className="flex flex-col lg:flex-row gap-8 lg:gap-16 justify-center items-center max-w-5xl mx-auto"
          >
            <div className="flex flex-col items-center w-full lg:w-auto group">
              <h4 className="text-lg font-bold text-teal-800 text-center px-6 py-2 bg-teal-100/80 rounded-full mb-6 backdrop-blur-sm">
                {dict.proof.demo_female}
              </h4>
              <div className="relative w-full max-w-xs mx-auto transition-transform duration-500 group-hover:-translate-y-2">
                <div className="absolute -inset-4 bg-gradient-to-tr from-teal-400/30 via-emerald-400/30 to-teal-400/30 rounded-[3rem] blur-2xl opacity-60 group-hover:opacity-100 transition-opacity" />
                <div className="relative">
                  <LiveSuggestionDemo
                    suggestion={demoData.demoSuggestionDataMale}
                    userId="visitor-user-id"
                    demoAiAnalysis={demoData.demoAiAnalysisForDaniel}
                    suggestionsDict={suggestionsDict}
                    profileCardDict={profileCardDict}
                    suggestionDemoDict={dict.suggestionDemo}
                    locale={locale}
                  />
                </div>
              </div>
            </div>

            <div className="flex flex-col items-center w-full lg:w-auto group">
              <h4 className="text-lg font-bold text-orange-800 text-center px-6 py-2 bg-orange-100/80 rounded-full mb-6 backdrop-blur-sm">
                {dict.proof.demo_male}
              </h4>
              <div className="relative w-full max-w-xs mx-auto transition-transform duration-500 group-hover:-translate-y-2">
                <div className="absolute -inset-4 bg-gradient-to-bl from-orange-400/30 via-rose-400/30 to-orange-400/30 rounded-[3rem] blur-2xl opacity-60 group-hover:opacity-100 transition-opacity" />
                <div className="relative">
                  <LiveSuggestionDemo
                    suggestion={demoData.demoSuggestionDataFemale}
                    userId="visitor-user-id"
                    demoAiAnalysis={demoData.demoAiAnalysisForNoa}
                    suggestionsDict={suggestionsDict}
                    profileCardDict={profileCardDict}
                    suggestionDemoDict={dict.suggestionDemo}
                    locale={locale}
                  />
                </div>
              </div>
            </div>
          </motion.div>
        </motion.div>

        {/* --- Key Benefits --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.2 }}
          transition={{ duration: 0.8 }}
          className="mb-24"
        >
          <div className="text-center mb-12">
            <h3 className="text-3xl font-bold text-gray-800 inline-block relative z-10">
              {dict.keyBenefits.title_part1}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500">
                {' '}
                {dict.keyBenefits.title_part2}
              </span>
              <div className="absolute -bottom-2 left-0 right-0 h-3 bg-amber-200/40 -z-10 skew-x-12" />
            </h3>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
            {dict.keyBenefits.benefits.map((benefit, index) => (
              <KeyBenefit
                key={index}
                icon={benefitDetails[index].icon}
                title={benefit.title}
                description={benefit.description}
                color={benefitDetails[index].color}
                delay={0.1 * (index + 1)}
              />
            ))}
          </div>
        </motion.div>

        {/* --- Founder's Testimonial (The Team Component) --- */}
        <div className="mb-24">
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.2 }}
            transition={{ duration: 0.8 }}
            className="text-center mb-12"
          >
            {/* Header Badge: Matching Hero 'Principles' colors */}
            <div className="inline-flex items-center gap-3 bg-gradient-to-r from-teal-50 to-orange-50 backdrop-blur-sm rounded-full px-8 py-3 shadow-lg border border-teal-200/60">
              <Heart className="w-5 h-5 text-rose-500 fill-rose-500" />
              <span className="text-gray-800 font-bold text-lg">
                {dict.testimonial.header}
              </span>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            whileInView={{ opacity: 1, scale: 1 }}
            viewport={{ once: true, amount: 0.2 }}
            transition={{ duration: 0.8, delay: 0.2 }}
            className="max-w-6xl mx-auto"
          >
            {/* Updated Card Gradient to match Hero Cards exactly */}
            <div className="relative bg-gradient-to-br from-white via-teal-50/40 to-orange-50/40 backdrop-blur-xl rounded-[3rem] shadow-2xl border border-white/60 overflow-hidden">
              {/* Subtle mesh background inside */}
              <div className="absolute inset-0 opacity-40">
                <div className="absolute -top-24 -right-24 w-96 h-96 bg-orange-100 rounded-full blur-3xl mix-blend-multiply" />
                <div className="absolute -bottom-24 -left-24 w-96 h-96 bg-teal-100 rounded-full blur-3xl mix-blend-multiply" />
              </div>

              <div className="relative grid md:grid-cols-[auto_1fr] gap-8 md:gap-12 p-10 md:p-14 items-center z-10">
                {/* Left side - Author */}
                <motion.div
                  initial={{ opacity: 0, x: -30 }}
                  whileInView={{ opacity: 1, x: 0 }}
                  viewport={{ once: true }}
                  transition={{ duration: 0.6, delay: 0.3 }}
                  className="flex flex-col items-center md:items-start gap-6"
                >
                  <div className="relative">
                    {/* Decorative elements around image - Updated to Hero Palette */}
                    <div className="absolute -inset-4 bg-gradient-to-br from-teal-400/30 to-orange-400/30 rounded-full blur-xl" />
                    
                    {/* Floating accents */}
                    <div className="absolute -top-3 -right-3 w-8 h-8 bg-gradient-to-br from-teal-400 to-emerald-500 rounded-xl rotate-12 shadow-lg z-20" />
                    <div className="absolute -bottom-3 -left-3 w-6 h-6 bg-gradient-to-br from-orange-400 to-amber-500 rounded-lg -rotate-12 shadow-lg z-20" />

                    <div className="relative w-32 h-32 rounded-[2rem] overflow-hidden shadow-2xl border-4 border-white ring-4 ring-teal-100/50 transform hover:scale-105 transition-transform duration-300">
                      <Image
                        src={getRelativeCloudinaryPath(
                          'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753700884/eitan_h9ylkc.jpg'
                        )}
                        alt={dict.testimonial.author_name}
                        fill
                        sizes="128px"
                        className="object-cover object-center"
                      />
                    </div>
                  </div>

                  <div className="text-center md:text-right rtl:md:text-left">
                    <div className="text-2xl font-bold text-gray-900 mb-2">
                      {dict.testimonial.author_name}
                    </div>
                    {/* Role Badge */}
                    <div className="inline-flex items-center gap-2 px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full border border-teal-200/60 shadow-sm">
                      <Sparkles className="w-4 h-4 text-teal-500" />
                      <span className="text-sm font-semibold text-teal-700 uppercase tracking-wider">
                        {dict.testimonial.author_role}
                      </span>
                    </div>
                  </div>
                </motion.div>

                {/* Right side - Quote */}
                <motion.div
                  initial={{ opacity: 0, x: 30 }}
                  whileInView={{ opacity: 1, x: 0 }}
                  viewport={{ once: true }}
                  transition={{ duration: 0.6, delay: 0.4 }}
                  className="relative"
                >
                  {/* Large decorative quote mark - Teal */}
                  <div className="absolute -top-6 right-4 rtl:left-4 rtl:right-auto opacity-10">
                    <Quote className="w-24 h-24 text-teal-600 transform rotate-180" />
                  </div>

                  <div className="relative bg-white/60 backdrop-blur-sm rounded-3xl p-8 md:p-10 border border-white/80 shadow-lg group hover:shadow-xl transition-shadow duration-300">
                    <p className="text-xl md:text-2xl text-gray-700 leading-relaxed font-medium relative z-10">
                      &quot;{dict.testimonial.quote}&quot;
                    </p>
                  </div>

                  {/* Small decorative quote mark - Orange */}
                  <div className="absolute -bottom-4 left-4 rtl:right-4 rtl:left-auto opacity-10">
                    <Quote className="w-16 h-16 text-orange-600" />
                  </div>
                </motion.div>
              </div>
            </div>
          </motion.div>
        </div>

        {/* --- Final CTA --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.1 }}
          transition={{ duration: 0.8 }}
          className="relative text-center pb-10"
        >
          {/* Background updated to glass/gradient */}
          <div className="relative max-w-4xl mx-auto p-12 bg-gradient-to-br from-white/90 via-teal-50/60 to-orange-50/60 backdrop-blur-xl rounded-[3rem] shadow-2xl border border-white/60">
            <h4 className="text-3xl md:text-5xl font-extrabold text-gray-800 mb-6 leading-tight">
              {dict.finalCta.title_line1}
              <br />
              {/* Gradient Title: Teal -> Orange -> Amber */}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 animate-gradient">
                {dict.finalCta.title_line2}
              </span>
            </h4>
            <p className="text-xl text-gray-600 mb-10 leading-relaxed max-w-2xl mx-auto">
              {dict.finalCta.subtitle_line1}
              <br className="hidden sm:inline" /> {dict.finalCta.subtitle_line2}
            </p>
            <div className="flex flex-col sm:flex-row gap-6 justify-center items-center">
              <Link href={`/${locale}/auth/register`}>
                {/* Button Style copied EXACTLY from HeroSection for perfect match */}
                <Button
                  size="lg"
                  className="text-xl font-bold px-12 py-8 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1"
                >
                  <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/40 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
                  <div className="relative z-10 flex items-center justify-center gap-3">
                    <Zap className="h-6 w-6 group-hover:rotate-12 transition-transform" />
                    <span>{dict.finalCta.button}</span>
                    <ArrowIcon className="h-6 w-6 group-hover:translate-x-1 rtl:group-hover:-translate-x-1 transition-transform" />
                  </div>
                </Button>
              </Link>
            </div>
            <div className="mt-8 flex items-center justify-center gap-2 text-gray-500 font-medium">
              <CheckCircle className="w-5 h-5 text-teal-500" />
              <span>{dict.finalCta.features}</span>
            </div>
          </div>
        </motion.div>
      </div>

      <style>{`
        @keyframes float-slow {
          0%,
          100% {
            transform: translateY(0) translateX(0);
          }
          25% {
            transform: translateY(-25px) translateX(15px);
          }
          50% {
            transform: translateY(-10px) translateX(25px);
          }
          75% {
            transform: translateY(-20px) translateX(10px);
          }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }

        @keyframes shimmer {
          100% {
            transform: translateX(100%);
          }
        }
        .animate-shimmer {
          animation: shimmer 2.5s infinite;
        }

        @keyframes gradient {
          0%,
          100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .animate-gradient {
          background-size: 200% 200%;
          animation: gradient 4s ease-in-out infinite;
        }
      `}</style>
    </section>
  );
};

export default HowItWorksSection;
--- End of Content for HowItWorksSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\MatchmakerTeamSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/MatchmakerTeamSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import Link from 'next/link';
import type { MatchmakerTeamDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface MatchmakerTeamProps {
  dict: MatchmakerTeamDict;
}

// --- START: Re-integrated MatchmakerCard Component ---
// This component now receives all data dynamically
interface MatchmakerCardProps {
  name: string;
  role: string;
  description: string;
  tags: string[];
  color: string;
  imageSrc?: string;
  contactButtonText: string; // New prop for translated text
}

const MatchmakerCard: React.FC<MatchmakerCardProps> = ({
  name,
  role,
  description,
  tags,
  color,
  imageSrc,
  contactButtonText,
}) => {
  // Mapping 'cyan' and 'green' props to the new Hero-based palette (Teal & Orange/Rose)
  const isTealTheme = color === 'cyan'; // 'cyan' prop now maps to the Teal/Tech theme
  
  const getGradientByColor = () => {
    return isTealTheme
      ? 'from-teal-500 to-emerald-600' // Teal theme
      : 'from-orange-500 to-rose-500'; // Orange/Warm theme
  };

  const getBorderColor = () => {
    return isTealTheme ? 'group-hover:border-teal-200' : 'group-hover:border-orange-200';
  };

  const getButtonGradient = () => {
    return isTealTheme
      ? 'bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 shadow-teal-500/20'
      : 'bg-gradient-to-r from-orange-500 to-rose-500 hover:from-orange-600 hover:to-rose-600 shadow-orange-500/20';
  };

  const getTagStyle = () => {
    return isTealTheme
      ? 'bg-teal-50 text-teal-700 border-teal-100'
      : 'bg-orange-50 text-orange-700 border-orange-100';
  };

  const getGlowColor = () => {
    return isTealTheme ? 'bg-teal-400/20' : 'bg-orange-400/20';
  };

  return (
    <div 
      className={`group relative rounded-3xl overflow-hidden bg-white/80 backdrop-blur-sm border border-white/60 flex flex-col h-full transition-all duration-500 hover:shadow-2xl hover:-translate-y-1 ${getBorderColor()}`}
    >
      {/* Subtle colorful glow inside the card */}
      <div className={`absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -z-10 transition-opacity duration-500 opacity-0 group-hover:opacity-100 ${getGlowColor()}`} />

      <div className="p-8 flex flex-col items-center flex-grow relative z-10">
        <motion.div
          className="w-48 h-48 mb-6 overflow-hidden rounded-full border-[6px] border-white shadow-xl relative ring-1 ring-gray-100"
          whileHover={{ scale: 1.05 }}
          transition={{ duration: 0.3 }}
        >
          {imageSrc ? (
            <Image
              src={getRelativeCloudinaryPath(imageSrc)}
              alt={name}
              fill
              sizes="(max-width: 768px) 100vw, 192px"
              className="object-cover object-center"
              priority
            />
          ) : (
            <div
              className={`h-full w-full flex items-center justify-center bg-gradient-to-br ${getGradientByColor()}`}
            >
              <span className="text-white text-6xl font-bold opacity-30">
                {name.charAt(0)}
              </span>
            </div>
          )}
        </motion.div>

        <h3 className="text-2xl font-bold text-gray-800 mb-2 text-center tracking-tight">
          {name}
        </h3>
        <p
          className={`text-lg font-bold mb-5 text-transparent bg-clip-text bg-gradient-to-r ${getGradientByColor()} text-center`}
        >
          {role}
        </p>

        <motion.div
          className="flex flex-wrap gap-2 justify-center mb-6"
          initial="hidden"
          animate="visible"
          variants={{
            hidden: { opacity: 0 },
            visible: {
              opacity: 1,
              transition: { staggerChildren: 0.1, delayChildren: 0.3 },
            },
          }}
        >
          {tags.map((tag) => (
            <motion.span
              key={tag}
              className={`text-sm px-3 py-1 rounded-full border ${getTagStyle()} font-medium shadow-sm`}
              variants={{
                hidden: { opacity: 0, scale: 0.8 },
                visible: {
                  opacity: 1,
                  scale: 1,
                  transition: { duration: 0.3 },
                },
              }}
            >
              {tag}
            </motion.span>
          ))}
        </motion.div>

        <p className="text-gray-600 mb-8 text-center leading-relaxed flex-grow text-base">
          {description}
        </p>

        <div className="mt-auto w-full flex justify-center">
          <Link href={`/contact?matchmaker=${encodeURIComponent(name)}`}>
            <motion.div
              className={`inline-block text-center px-8 py-3.5 rounded-full text-white ${getButtonGradient()} transition-all duration-300 font-semibold cursor-pointer shadow-lg`}
              whileHover={{ scale: 1.05, boxShadow: "0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)" }}
              whileTap={{ scale: 0.95 }}
            >
              {`${contactButtonText} ${name.split(' ')[0]}`}
            </motion.div>
          </Link>
        </div>
      </div>
    </div>
  );
};
// --- END: Re-integrated MatchmakerCard Component ---

const MatchmakerTeamSection: React.FC<MatchmakerTeamProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.3, delayChildren: 0.2 },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const cardContainerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.2 },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, y: 50 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  return (
    <motion.section
      ref={ref}
      id="our-team"
      // Updated background to match HeroSection: Slate via Teal to Orange
      className="py-16 md:py-24 px-4 bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Background Orbs updated to match Hero colors (Teal & Orange/Rose) */}
      <div className="absolute top-0 left-0 w-96 h-96 bg-teal-300/10 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"></div>
      <div className="absolute bottom-0 right-0 w-[30rem] h-[30rem] bg-orange-300/10 rounded-full blur-3xl translate-x-1/3 translate-y-1/3"></div>
      <div className="absolute top-1/2 left-1/2 w-full h-full bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:24px_24px] opacity-[0.03] pointer-events-none"></div>

      <div className="max-w-6xl mx-auto relative z-10">
        <motion.div className="text-center mb-16" variants={headerVariants}>
          <h2 className="text-3xl md:text-5xl font-extrabold text-gray-800 mb-6 tracking-tight">
            {dict.title_part1}
            {/* Updated Gradient Text to match Hero (Teal -> Orange) */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 px-2">
              {dict.title_highlight}
            </span>
            {dict.title_part2}
          </h2>

          <p className="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </motion.div>

        <motion.div
          className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 max-w-5xl mx-auto"
          variants={cardContainerVariants}
        >
          {dict.team.map((member) => (
            <motion.div key={member.name} variants={cardVariants} className="h-full">
              <MatchmakerCard
                name={member.name}
                role={member.role}
                description={member.description}
                color={member.color}
                tags={member.tags}
                imageSrc={member.imageSrc}
                contactButtonText={dict.contact_button_text}
              />
            </motion.div>
          ))}
        </motion.div>
      </div>
    </motion.section>
  );
};

export default MatchmakerTeamSection;
--- End of Content for MatchmakerTeamSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\NeshmaInsightSectionB.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/NeshmaInsightSectionB.tsx

'use client';

import React, { useRef, useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { motion, useInView, AnimatePresence } from 'framer-motion';
import {
  Sparkles,
  Heart,
  Target,
  FileText,
  CheckCheck,
  Lightbulb,
  ArrowLeft,
  Zap,
  TrendingUp,
} from 'lucide-react';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import type { NeshmaInsightDict } from '@/types/dictionary';

// --- Type Definitions ---
interface Message {
  id: number;
  text: string;
  sender: 'friend' | 'user';
  timestamp: string;
  isEureka?: boolean;
}

interface NeshmaInsightProps {
  locale: 'he' | 'en';
  dict: NeshmaInsightDict;
}
// --- End: Type Definitions ---

export default function NeshmaInsightSectionB({
  locale,
  dict,
}: NeshmaInsightProps) {
  const ref = useRef(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const messagesContainerRef = useRef<HTMLDivElement>(null);
  const isInView = useInView(ref, { once: true, amount: 0.15 });
  const isHebrew = locale === 'he';
  const direction = isHebrew ? 'rtl' : 'ltr';

  // --- State Management ---
  const [messages, setMessages] = useState<Message[]>([]);
  const [isTyping, setIsTyping] = useState(false);
  const [showPhone, setShowPhone] = useState(false);
  const [showInsights, setShowInsights] = useState(false);
  const [showTransitionText, setShowTransitionText] = useState(false);
  const [showTransitionCTA, setShowTransitionCTA] = useState(false);
  const [showCTA, setShowCTA] = useState(false);
  const [progressStep, setProgressStep] = useState(0);
  const [showPostConversationTransition, setShowPostConversationTransition] =
    useState(false);

  // --- Memoized Data from Dictionary ---
  const conversation = useMemo(() => {
    const logic = [
      { typingDelay: 1200 },
      { typingDelay: 800 },
      { typingDelay: 1500 },
      { typingDelay: 1000 },
      { typingDelay: 2000 },
      { isEureka: true, typingDelay: 1800 },
      { typingDelay: 1000 },
      { typingDelay: 2500 },
      { typingDelay: 1000 },
      { typingDelay: 1800 },
      { typingDelay: 1200 },
    ];
    return dict.conversation.map((msg, index) => ({
      ...msg,
      ...logic[index],
    }));
  }, [dict.conversation]);

  const insightDetails = useMemo(
    () => [
      {
        icon: Heart,
        // Rose palette (Match Hero)
        gradient: 'from-rose-400 via-pink-500 to-red-500',
        ...dict.insights.items[0],
      },
      {
        icon: Target,
        // Teal palette (Match Hero)
        gradient: 'from-teal-400 via-teal-500 to-emerald-500',
        ...dict.insights.items[1],
      },
      {
        icon: Zap,
        // Orange/Amber palette (Match Hero)
        gradient: 'from-orange-400 via-amber-500 to-yellow-500',
        ...dict.insights.items[2],
      },
    ],
    [dict.insights.items]
  );

  // --- Animation Logic ---
  useEffect(() => {
    const playConversation = (index: number) => {
      if (index >= conversation.length) {
        setIsTyping(false);
        setTimeout(() => setShowTransitionText(true), 800);
        setTimeout(() => setShowInsights(true), 1800);
        setTimeout(() => setShowTransitionCTA(true), 2500);
        setTimeout(() => setShowCTA(true), 3500);
        setTimeout(() => setShowPostConversationTransition(true), 4200);
        setProgressStep(5);
        return;
      }

      const currentMessage = conversation[index];

      if (index === 0) setProgressStep(1);
      if (index === 3) setProgressStep(2);
      if (index === 5) setProgressStep(3);
      if (index === 8) setProgressStep(4);

      setIsTyping(true);

      const baseTypingDuration =
        currentMessage.typingDelay ||
        Math.max(currentMessage.text.length * 40, 1000);
      const typingDuration = currentMessage.isEureka
        ? baseTypingDuration * 1.5
        : baseTypingDuration;

      setTimeout(() => {
        setIsTyping(false);
        const newMessage: Message = {
          id: Date.now() + index,
          text: currentMessage.text,
          sender: currentMessage.sender,
          isEureka: currentMessage.isEureka,
          timestamp: new Date().toLocaleTimeString(
            locale === 'he' ? 'he-IL' : 'en-US',
            {
              hour: '2-digit',
              minute: '2-digit',
            }
          ),
        };
        setMessages((prev) => [...prev, newMessage]);

        const pauseBeforeNext = currentMessage.isEureka ? 1200 : 600;
        setTimeout(() => playConversation(index + 1), pauseBeforeNext);
      }, typingDuration);
    };

    if (isInView && !showPhone) {
      setTimeout(() => setShowPhone(true), 500);
      setTimeout(() => playConversation(0), 1500);
    }
  }, [isInView, showPhone, conversation, locale]);

  // Auto-scroll logic
  useEffect(() => {
    if (messagesContainerRef.current) {
      const container = messagesContainerRef.current;
      const isNearBottom =
        container.scrollHeight - container.scrollTop - container.clientHeight <
        100;

      if (isNearBottom) {
        requestAnimationFrame(() => {
          if (messagesContainerRef.current) {
            messagesContainerRef.current.scrollTop =
              messagesContainerRef.current.scrollHeight;
          }
        });
      }
    }
  }, [messages]);

  // --- Animation Variants ---
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.15 } },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const phoneVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 30 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const messageVariants = {
    hidden: { opacity: 0, y: 8, scale: 0.99 },
    visible: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: { duration: 0.25, ease: [0.25, 0.46, 0.45, 0.94] },
    },
  };
  const typingVariants = {
    initial: { opacity: 0, scale: 0.8 },
    animate: { opacity: 1, scale: 1 },
    exit: { opacity: 0, scale: 0.8, transition: { duration: 0.1 } },
  };

  // --- Render ---
  return (
    <motion.section
      ref={ref}
      // Updated Background to match Hero (Slate -> Teal -> Orange)
      className="relative py-20 md:py-32 bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20 overflow-hidden"
      dir={direction}
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Background Elements - Updated to match Hero Orbs (Teal, Orange, Rose) */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-20 left-10 w-72 h-72 bg-gradient-to-br from-teal-200/20 to-emerald-200/10 rounded-full blur-3xl animate-float-slow"></div>
        <div
          className="absolute bottom-40 right-10 w-96 h-96 bg-gradient-to-br from-orange-200/15 to-amber-200/10 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute top-1/2 left-1/3 w-64 h-64 bg-gradient-to-br from-rose-200/15 to-pink-200/10 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '4s' }}
        ></div>
      </div>

      <div className="container mx-auto px-4 max-w-6xl relative">
        {/* Header */}
        <motion.div className="flex justify-center mb-10" variants={fadeInUp}>
          <div className="inline-flex items-center gap-3 bg-white/90 backdrop-blur-md rounded-full px-8 py-4 shadow-lg border border-teal-100">
            <Sparkles className="w-6 h-6 text-teal-500" />
            <span className="text-teal-700 font-bold text-lg">
              {dict.badge}
            </span>
          </div>
        </motion.div>

        {/* Title - Updated Highlight Gradient to match Hero (Teal-Orange-Amber) */}
        <motion.div variants={fadeInUp} className="text-center mb-12">
          <h2 className="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-gray-800 leading-tight mb-6">
            {dict.title.part1}{' '}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500">
              {dict.title.highlight}
            </span>
            {dict.title.part2}
          </h2>
          <p className="text-base sm:text-lg md:text-xl lg:text-2xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </motion.div>

        {/* Phone Animation */}
        <AnimatePresence>
          {showPhone && (
            <motion.div
              variants={phoneVariants}
              initial="hidden"
              animate="visible"
              className="max-w-md mx-auto mb-20"
            >
              <div className="relative group">
                {/* Updated Glow to Match Hero's Palette */}
                <div className="absolute -inset-2 bg-gradient-to-r from-teal-400/20 via-orange-400/20 to-amber-400/20 rounded-[2.9rem] blur-xl"></div>
                <div className="relative bg-white/80 backdrop-blur-sm rounded-[2.5rem] p-1.5 border border-teal-100 shadow-2xl transition-transform duration-500 group-hover:-rotate-1">
                  <div className="bg-white rounded-[2rem] overflow-hidden">
                    {/* Phone Header */}
                    <div className="px-4 pt-6 pb-3 relative z-10 flex items-center gap-3 border-b border-teal-100/60">
                      <div className="relative">
                        <div className="relative w-10 h-10 rounded-full shadow-md overflow-hidden">
                          <Image
                            src={getRelativeCloudinaryPath(
                              'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967649/IMG-20250731-WA0059_mqskdw.jpg'
                            )}
                            alt={dict.chatHeader.name}
                            fill
                            sizes="40px"
                            className="object-cover"
                          />
                        </div>
                        <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                      </div>
                      <div>
                        <h3 className="text-gray-800 font-bold text-sm">
                          {dict.chatHeader.name}
                        </h3>
                        <p className="text-gray-500 text-xs">
                          {dict.chatHeader.status}
                        </p>
                      </div>
                    </div>

                    {/* Progress Bar - Updated Gradient */}
                    <div className="px-4 py-2 bg-teal-50/50 border-b border-teal-100/40">
                      <div className="flex items-center justify-between gap-1">
                        {dict.progressLabels.map((_, step) => (
                          <div
                            key={step}
                            className={`flex-1 h-1 rounded-full transition-all duration-500 ${progressStep > step ? 'bg-gradient-to-r from-teal-500 to-amber-500' : 'bg-gray-200'}`}
                          />
                        ))}
                      </div>
                    </div>

                    {/* Messages Area */}
                    <div
                      ref={messagesContainerRef}
                      aria-live="polite"
                      className="h-[450px] md:h-[500px] overflow-y-auto p-4 bg-gradient-to-br from-teal-50/20 to-orange-50/20 touch-pan-y"
                      style={{
                        scrollBehavior: 'smooth',
                        WebkitOverflowScrolling: 'touch',
                      }}
                    >
                      <AnimatePresence>
                        {messages.map((message) => (
                          <motion.div
                            key={message.id}
                            layout
                            variants={messageVariants}
                            initial="hidden"
                            animate="visible"
                            className={`flex items-end gap-2 mb-4 ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                          >
                            <div
                              className={`flex flex-col max-w-[80%] ${message.sender === 'user' ? 'items-end' : 'items-start'}`}
                            >
                              <div
                                className={`relative z-10 rounded-2xl px-4 py-2.5 shadow-md flex items-center gap-2 ${
                                  message.sender === 'user'
                                    ? 'bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white rounded-br-lg' // Updated User Bubble
                                    : `bg-white text-gray-800 border border-gray-100 rounded-bl-lg ${message.isEureka ? 'border-amber-400/80 ring-4 ring-amber-400/10 animate-pulse-glow' : ''}`
                                }`}
                              >
                                {message.isEureka && (
                                  <motion.div
                                    animate={{
                                      scale: [1, 1.2, 1],
                                      rotate: [0, 10, -10, 0],
                                    }}
                                    transition={{
                                      duration: 0.6,
                                      repeat: 2,
                                      repeatDelay: 0.3,
                                    }}
                                  >
                                    <Lightbulb className="w-5 h-5 text-amber-400 flex-shrink-0" />
                                  </motion.div>
                                )}
                                <p className="text-[15px] leading-relaxed">
                                  {message.text}
                                </p>
                              </div>
                              <div className="flex items-center gap-1.5 mt-1.5 px-1">
                                <span className="text-[11px] text-gray-400">
                                  {message.timestamp}
                                </span>
                                {message.sender === 'user' && (
                                  <CheckCheck className="w-3.5 h-3.5 text-teal-500" />
                                )}
                              </div>
                            </div>
                          </motion.div>
                        ))}
                      </AnimatePresence>
                      <AnimatePresence>
                        {isTyping && (
                          <motion.div
                            layout
                            {...typingVariants}
                            className="flex items-end gap-2 mb-4 justify-start"
                          >
                            <div className="flex items-center gap-1.5 p-3 rounded-2xl shadow-md bg-white/80 border border-gray-200 rounded-bl-lg">
                              {[0, 0.2, 0.4].map((delay) => (
                                <motion.div
                                  key={delay}
                                  className="w-1.5 h-1.5 bg-gray-400 rounded-full"
                                  animate={{ y: [0, -3, 0] }}
                                  transition={{
                                    duration: 0.9,
                                    repeat: Infinity,
                                    delay,
                                  }}
                                />
                              ))}
                            </div>
                          </motion.div>
                        )}
                      </AnimatePresence>
                      <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="border-t border-gray-200/80 bg-gray-50/50 p-3">
                      <div className="bg-gray-100 rounded-full px-4 py-2 text-gray-400 text-sm cursor-not-allowed text-center">
                        {dict.placeholder}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Transition Text */}
        <AnimatePresence>
          {showTransitionText && !showInsights && (
            <motion.div
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.9 }}
              className="text-center mb-12"
            >
              <div className="inline-block bg-gradient-to-r from-amber-100 to-orange-100 rounded-2xl px-8 py-4 shadow-lg border-2 border-amber-300">
                <p className="text-xl font-bold text-gray-800">
                  {dict.transitionText}
                </p>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Insights Section */}
        <AnimatePresence>
          {showInsights && (
            <motion.div
              initial={{ opacity: 0, y: 30 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.6 }}
              className="mb-20"
            >
              <h3 className="text-2xl sm:text-3xl md:text-4xl font-bold text-center text-gray-800 mb-12">
                {dict.insights.title}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                {insightDetails.map((item, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, y: 30 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true }}
                    transition={{ duration: 0.6, delay: index * 0.15 }}
                    whileHover={{
                      y: -8,
                      scale: 1.02,
                      transition: { duration: 0.3 },
                    }}
                    className="group"
                  >
                    <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-lg border border-gray-100 hover:shadow-2xl hover:border-teal-200 transition-all duration-300 h-full relative overflow-hidden flex flex-col items-center text-center">
                      <div
                        className={`absolute inset-0 bg-gradient-to-br ${item.gradient} opacity-0 group-hover:opacity-10 transition-opacity duration-300`}
                      />
                      <div
                        className={`inline-flex p-4 rounded-2xl bg-gradient-to-br ${item.gradient} text-white mb-6 shadow-md group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 relative z-10`}
                      >
                        <item.icon className="w-8 h-8" />
                      </div>
                      <h4 className="text-xl font-bold text-gray-800 mb-4 relative z-10">
                        {item.title}
                      </h4>
                      <p className="text-gray-600 leading-relaxed relative z-10">
                        {item.description}
                      </p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Transition CTA */}
        <AnimatePresence>
          {showTransitionCTA && !showCTA && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.8 }}
              className="text-center mb-8"
            >
              <div className="inline-flex items-center gap-3 bg-gradient-to-r from-teal-100 to-orange-100 rounded-full px-6 py-3 shadow-md">
                <TrendingUp className="w-5 h-5 text-teal-600" />
                <p className="text-lg font-semibold text-gray-800">
                  {dict.transitionCTA}
                </p>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Final CTA */}
        <AnimatePresence>
          {showCTA && (
            <motion.div
              variants={fadeInUp}
              initial="hidden"
              animate="visible"
              exit={{ opacity: 0 }}
              className="text-center"
            >
              <Link href={`/${locale}/questionnaire`}>
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.98 }}
                  // Updated Gradient to match Hero CTA
                  className="group relative inline-flex items-center gap-4 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white font-bold py-5 px-12 md:px-16 rounded-full text-xl md:text-2xl shadow-2xl hover:shadow-3xl transition-all duration-300"
                >
                  <FileText className="w-7 h-7 group-hover:rotate-6 transition-transform" />
                  <span>{dict.cta.button}</span>
                  <ArrowLeft
                    className={`w-6 h-6 group-hover:${isHebrew ? '-translate-x-1' : 'translate-x-1'} transition-transform ${isHebrew ? '' : 'rotate-180'}`}
                  />
                  <div className="absolute inset-0 rounded-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:translate-x-full transition-transform duration-1000"></div>
                </motion.button>
              </Link>
              <motion.p
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.2 }}
                className="mt-6 text-gray-600 text-lg italic"
              >
                {dict.cta.subtitle}
              </motion.p>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Post-Conversation Transition */}
        <AnimatePresence>
          {showPostConversationTransition && (
            <motion.div
              className="text-center max-w-3xl mx-auto mt-16 md:mt-24 px-4"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8, ease: 'easeOut' }}
            >
              <h3 className="text-2xl md:text-3xl font-bold text-gray-800 leading-tight">
                {dict.postConversationTransition.line1}
                <br />
                {/* Updated Gradient to match Hero Text */}
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-600">
                  {dict.postConversationTransition.line2}
                </span>
              </h3>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Styles */}
      <style>{`
        @keyframes float-slow { 0%, 100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-20px) translateX(10px); } 50% { transform: translateY(0) translateX(20px); } 75% { transform: translateY(20px) translateX(10px); } }
        .animate-float-slow { animation: float-slow 20s ease-in-out infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(251, 191, 36, 0.3); } 50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); } }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        /* Custom scrollbar for messages area */
        .overflow-y-auto::-webkit-scrollbar {
          width: 6px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
          background: rgba(243, 244, 246, 0.5);
          border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
          background: linear-gradient(to bottom, #14b8a6, #f97316);
          border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(to bottom, #0d9488, #ea580c);
        }
      `}</style>
    </motion.section>
  );
}
--- End of Content for NeshmaInsightSectionB.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\OurMethodSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/OurMethodSection.tsx
'use client';

import React, {
  useState,
  useRef,
  useEffect,
  useCallback,
  useMemo,
} from 'react';
import { motion, useInView, AnimatePresence, PanInfo } from 'framer-motion';
import { Button } from '@/components/ui/button';

import {
  Heart,
  User,
  Users,
  Scroll,
  UserCheck,
  Sparkles,
  ArrowRight,
  CheckCircle,
  Pause,
  Play,
} from 'lucide-react';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import { usePathname } from 'next/navigation';
import type { OurMethodDict, WorldDict } from '@/types/dictionary';

interface OurMethodProps {
  dict: OurMethodDict;
}

interface WorldData extends WorldDict {
  id: number;
  icon: React.ReactNode;
  color: string;
  gradientFrom: string;
  gradientTo: string;
  angle: number;
  bgGradient: string; // Added to match Hero card styles
  shadowColor: string; // Added to match Hero card styles
}

const MatchingConstellation: React.FC<{
  dict: OurMethodDict['constellation'];
  locale: string;
}> = ({ dict, locale }) => {
  const [hoveredWorld, setHoveredWorld] = useState<number | null>(null);
  const [selectedWorld, setSelectedWorld] = useState<number>(1);
  const [isAutoPlaying, setIsAutoPlaying] = useState<boolean>(true);
  const [rotationOffset, setRotationOffset] = useState<number>(0);
  const [isDragging, setIsDragging] = useState<boolean>(false);
  const [isMobile, setIsMobile] = useState<boolean>(false);

  const panStartRotation = useRef(0);
  const sectionRef = useRef(null);
  const constellationRef = useRef<HTMLDivElement>(null);
  const isInView = useInView(sectionRef, { once: true, amount: 0.02 });

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // --- UPDATED WORLDS PALETTE (Matched to HeroSection: Teal, Orange, Amber, Rose) ---
  const worlds: WorldData[] = useMemo(
    () => [
      {
        id: 1,
        icon: <User className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[0],
        // Hero "Knowledge" Style (Teal)
        color: 'from-teal-400 via-teal-500 to-emerald-500',
        gradientFrom: '#2dd4bf', // teal-400
        gradientTo: '#10b981',   // emerald-500
        bgGradient: 'from-teal-50 via-white to-emerald-50',
        shadowColor: 'shadow-teal-500/25',
        angle: -72,
      },
      {
        id: 2,
        icon: <Heart className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[1],
        // Hero "Personal" Style (Rose)
        color: 'from-rose-400 via-pink-500 to-red-500',
        gradientFrom: '#fb7185', // rose-400
        gradientTo: '#ef4444',   // red-500
        bgGradient: 'from-rose-50 via-white to-red-50',
        shadowColor: 'shadow-rose-500/25',
        angle: -144,
      },
      {
        id: 3,
        icon: <Users className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[2],
        // Hero "Privacy/Guidance" Style (Orange/Amber)
        color: 'from-orange-400 via-amber-500 to-yellow-500',
        gradientFrom: '#fbbf24', // amber-400
        gradientTo: '#f97316',   // orange-500
        bgGradient: 'from-orange-50 via-white to-amber-50',
        shadowColor: 'shadow-orange-500/25',
        angle: 144,
      },
      {
        id: 4,
        icon: <UserCheck className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[3],
        // Deep Orange/Red (Strong synergy color)
        color: 'from-orange-500 via-red-500 to-red-600',
        gradientFrom: '#f97316', // orange-500
        gradientTo: '#dc2626',   // red-600
        bgGradient: 'from-orange-50 via-white to-red-50',
        shadowColor: 'shadow-orange-600/25',
        angle: 72,
      },
      {
        id: 5,
        icon: <Scroll className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[4],
        // Cyan/Blue (Complementary to Orange, fits "Tech" vibe)
        color: 'from-cyan-400 via-sky-500 to-blue-500',
        gradientFrom: '#22d3ee', // cyan-400
        gradientTo: '#3b82f6',   // blue-500
        bgGradient: 'from-cyan-50 via-white to-blue-50',
        shadowColor: 'shadow-sky-500/25',
        angle: 0,
      },
    ],
    [dict.worlds]
  );

  useEffect(() => {
    if (!isAutoPlaying || isDragging) return;
    const interval = setInterval(() => {
      setSelectedWorld((prev) => (prev ? (prev % worlds.length) + 1 : 1));
    }, 4000);
    return () => clearInterval(interval);
  }, [isAutoPlaying, isDragging, worlds.length]);

  useEffect(() => {
    const targetWorld = worlds.find((w) => w.id === selectedWorld);
    if (targetWorld) {
      setRotationOffset(-targetWorld.angle);
    }
  }, [selectedWorld, worlds]);

  const getDimensions = () => {
    if (isMobile) {
      return {
        size: 350,
        center: 175,
        radius: 120,
        iconSize: 50,
        coreRadius: 20,
      };
    }
    return {
      size: 500,
      center: 250,
      radius: 170,
      iconSize: 70,
      coreRadius: 28,
    };
  };

  const dimensions = getDimensions();

  interface ConstellationLine {
    id: string;
    x1: number;
    y1: number;
    x2: number;
    y2: number;
    opacity: number;
  }

  const generateConstellationLines = (): ConstellationLine[] => {
    const lines: ConstellationLine[] = [];
    const { center, radius } = dimensions;

    worlds.forEach((world, index) => {
      const nextIndex = (index + 1) % worlds.length;
      const nextWorld = worlds[nextIndex];
      const currentAngle = world.angle + rotationOffset;
      const nextAngle = nextWorld.angle + rotationOffset;

      const x1 = center + Math.cos((currentAngle * Math.PI) / 180) * radius;
      const y1 = center + Math.sin((currentAngle * Math.PI) / 180) * radius;
      const x2 = center + Math.cos((nextAngle * Math.PI) / 180) * radius;
      const y2 = center + Math.sin((nextAngle * Math.PI) / 180) * radius;

      lines.push({ id: `line-${index}`, x1, y1, x2, y2, opacity: 0.4 });
    });
    return lines;
  };

  const handleWorldInteraction = (worldId: number) => {
    setIsAutoPlaying(false);
    setSelectedWorld(worldId);
    setHoveredWorld(null);

    setTimeout(() => {
      const infoPanel = document.querySelector('[data-world-info-panel]');
      if (infoPanel) {
        infoPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  };

  const handlePanStart = useCallback(() => {
    setIsAutoPlaying(false);
    setIsDragging(true);
    panStartRotation.current = rotationOffset;
  }, [rotationOffset]);

  const handlePan = useCallback(
    (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
      const sensitivity = 0.5;
      setRotationOffset(panStartRotation.current + info.offset.x * sensitivity);
    },
    []
  );

  const handlePanEnd = useCallback(
    (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
      setIsDragging(false);
      const swipePower = Math.abs(info.velocity.x);
      const swipeDistance = Math.abs(info.offset.x);
      const flickThreshold = 200;

      const currentWorldIndex =
        worlds.findIndex((w) => w.id === selectedWorld) ?? 0;
      let nextWorldIndex = currentWorldIndex;

      if (swipePower > flickThreshold || swipeDistance > dimensions.size / 4) {
        if (info.offset.x < 0) {
          nextWorldIndex = (currentWorldIndex + 1) % worlds.length;
        } else {
          nextWorldIndex =
            (currentWorldIndex - 1 + worlds.length) % worlds.length;
        }
      }
      setSelectedWorld(worlds[nextWorldIndex].id);
    },
    [selectedWorld, worlds, dimensions.size]
  );

  const activeWorld = hoveredWorld || selectedWorld;
  const displayedWorld = worlds.find((w) => w.id === activeWorld) || worlds[0];

  // Helper to determine text color class based on world color (simplified)
  const getAccentTextColor = (id: number) => {
     if (id === 1) return 'text-teal-700';
     if (id === 2) return 'text-rose-700';
     if (id === 3) return 'text-amber-700';
     if (id === 4) return 'text-orange-700';
     return 'text-sky-700';
  }

    // Helper to determine border color class
  const getAccentBorderColor = (id: number) => {
     if (id === 1) return 'border-teal-200';
     if (id === 2) return 'border-rose-200';
     if (id === 3) return 'border-amber-200';
     if (id === 4) return 'border-orange-200';
     return 'border-sky-200';
  }

  return (
    <div
      ref={sectionRef}
      className="relative w-full max-w-7xl mx-auto py-8 md:py-16"
    >
      <motion.div
        initial={{ opacity: 0, y: 30 }}
        animate={isInView ? { opacity: 1, y: 0 } : {}}
        transition={{ duration: 0.8 }}
        className="text-center mb-8 md:mb-16 px-4"
      >
        <div className="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-6 md:px-8 py-3 md:py-4 shadow-md border border-gray-200 mb-6 md:mb-8">
          {/* Icon updated to match Hero synergy (Orange) */}
          <Heart className="w-5 h-5 md:w-6 md:h-6 text-orange-500" />
          <span className="text-gray-700 font-medium text-base md:text-lg">
            {dict.header}
          </span>
        </div>
        <h3 className="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-800 mb-4 md:mb-6 leading-tight px-4">
          {dict.title_part1}
          <br className="sm:hidden" />
          {/* Gradient updated to match Hero Header: Teal -> Orange -> Amber */}
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 mx-2">
            {dict.title_part2}
          </span>
        </h3>
        <p className="text-lg md:text-xl text-gray-600 max-w-4xl mx-auto leading-relaxed px-4">
          {dict.subtitle}
        </p>
      </motion.div>

      <div className="flex flex-col xl:flex-row items-center gap-8 md:gap-16">
        <motion.div
          ref={constellationRef}
          initial={{ opacity: 0, scale: 0.9 }}
          animate={isInView ? { opacity: 1, scale: 1 } : {}}
          transition={{ duration: 1, delay: 0.3 }}
          className="relative flex-1 min-w-0 w-full touch-none cursor-grab active:cursor-grabbing"
          style={{
            width: dimensions.size,
            height: dimensions.size,
            maxWidth: '100vw',
            margin: '0 auto',
          }}
          drag={isMobile ? 'x' : false}
          dragConstraints={{ left: 0, right: 0 }}
          dragElastic={0.1}
          onPanStart={handlePanStart}
          onPan={handlePan}
          onPanEnd={handlePanEnd}
        >
          <div
            className="relative mx-auto flex items-center justify-center"
            style={{
              width: dimensions.size,
              height: dimensions.size,
            }}
          >
            {/* Background glow updated to Hero Palette */}
            <div className="absolute inset-0 bg-gradient-to-br from-teal-50/80 via-orange-50/60 to-rose-50/80 rounded-full blur-3xl" />
            <svg
              viewBox={`0 0 ${dimensions.size} ${dimensions.size}`}
              className="absolute inset-0 w-full h-full pointer-events-none"
            >
              {generateConstellationLines().map((line) => (
                <motion.line
                  key={line.id}
                  x1={line.x1}
                  y1={line.y1}
                  x2={line.x2}
                  y2={line.y2}
                  stroke="url(#lineGradient)"
                  strokeWidth={isMobile ? '1.5' : '2'}
                  opacity={isDragging ? 0.6 : line.opacity}
                  className="transition-opacity duration-300"
                  animate={{
                    x1: line.x1,
                    y1: line.y1,
                    x2: line.x2,
                    y2: line.y2,
                  }}
                  transition={{
                    type: 'spring',
                    stiffness: 100,
                    damping: 20,
                  }}
                />
              ))}

              <defs>
                <linearGradient
                  id="lineGradient"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  {/* Gradient updated: Teal -> Orange -> Rose */}
                  <stop offset="0%" stopColor="#14b8a6" stopOpacity="0.4" />
                  <stop offset="50%" stopColor="#f97316" stopOpacity="0.5" />
                  <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.4" />
                </linearGradient>
                <radialGradient id="coreGradient">
                  <stop offset="0%" stopColor="#ffffff" stopOpacity="1" />
                  <stop offset="50%" stopColor="#f8fafc" stopOpacity="0.98" />
                  <stop offset="80%" stopColor="#f1f5f9" stopOpacity="0.95" />
                  <stop offset="100%" stopColor="#e2e8f0" stopOpacity="0.9" />
                </radialGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2" result="coloredBlur" />
                  <feMerge>
                    <feMergeNode in="coloredBlur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
                {worlds.map((world) => (
                  <radialGradient
                    key={`gradient-${world.id}`}
                    id={`worldGradient-${world.id}`}
                  >
                    <stop
                      offset="0%"
                      stopColor={world.gradientFrom}
                      stopOpacity="0.95"
                    />
                    <stop
                      offset="100%"
                      stopColor={world.gradientTo}
                      stopOpacity="0.85"
                    />
                  </radialGradient>
                ))}
              </defs>

              <motion.circle
                cx={dimensions.center}
                cy={dimensions.center}
                r={dimensions.coreRadius}
                fill="url(#coreGradient)"
                filter="url(#glow)"
                className="drop-shadow-xl"
                animate={{
                  scale: activeWorld ? 1.15 : isDragging ? 1.05 : 1,
                  filter: isDragging
                    ? 'url(#glow) brightness(1.1)'
                    : 'url(#glow)',
                }}
                transition={{ duration: 0.3, type: 'spring', stiffness: 300 }}
              />
              <foreignObject
                x={dimensions.center - (isMobile ? 18 : 24)}
                y={dimensions.center - (isMobile ? 18 : 24)}
                width={isMobile ? 36 : 48}
                height={isMobile ? 36 : 48}
              >
                <div className="flex items-center justify-center w-full h-full">
                  <motion.div
                    className="relative w-full h-full flex items-center justify-center"
                    animate={{
                      rotate: isDragging ? 360 : 0,
                      scale: isDragging ? 1.1 : activeWorld ? 1.05 : 1,
                    }}
                    transition={{
                      rotate: {
                        duration: isDragging ? 3 : 0,
                        repeat: isDragging ? Infinity : 0,
                        ease: 'linear',
                      },
                      scale: { duration: 0.3, type: 'spring', stiffness: 300 },
                    }}
                  >
                    <div
                      className={`relative ${isMobile ? 'w-7 h-7' : 'w-9 h-9'}`}
                    >
                      <Image
                        src={getRelativeCloudinaryPath(
                          'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png'
                        )}
                        alt="NeshamaTech"
                        fill
                        className="object-contain transition-all duration-300"
                        sizes={isMobile ? '28px' : '36px'}
                      />
                    </div>
                    {(activeWorld || isDragging) && (
                      <motion.div
                        className="absolute inset-0 rounded-full"
                        animate={{
                          boxShadow: [
                            '0 0 0 0 rgba(249, 115, 22, 0)', // Orange tint
                            '0 0 0 4px rgba(249, 115, 22, 0.1)',
                            '0 0 0 0 rgba(249, 115, 22, 0)',
                          ],
                        }}
                        transition={{
                          duration: 2,
                          repeat: Infinity,
                          ease: 'easeInOut',
                        }}
                      />
                    )}
                  </motion.div>
                </div>
              </foreignObject>
            </svg>

            {worlds.map((world, index) => {
              const currentAngle = world.angle + rotationOffset;
              const x =
                dimensions.center +
                Math.cos((currentAngle * Math.PI) / 180) * dimensions.radius;
              const y =
                dimensions.center +
                Math.sin((currentAngle * Math.PI) / 180) * dimensions.radius;
              const isActive = activeWorld === world.id;

              return (
                <motion.div
                  key={world.id}
                  className="absolute cursor-pointer group select-none flex flex-col items-center gap-2 md:gap-4"
                  style={{
                    width: dimensions.iconSize * 2.5,
                    transform: 'translate3d(0, 0, 0)',
                  }}
                  initial={{ opacity: 0, scale: 0 }}
                  animate={{
                    opacity: isInView ? 1 : 0,
                    scale: isInView ? 1 : 0,
                    left: x - (dimensions.iconSize * 2.5) / 2,
                    top: y - dimensions.iconSize / 2,
                  }}
                  transition={{
                    type: 'spring',
                    stiffness: 100,
                    damping: 20,
                    delay: 0.7 + index * 0.1,
                  }}
                  onMouseEnter={() => !isMobile && setHoveredWorld(world.id)}
                  onMouseLeave={() => !isMobile && setHoveredWorld(null)}
                  onClick={() =>
                    !isDragging && handleWorldInteraction(world.id)
                  }
                  whileHover={!isMobile ? { scale: 1.05 } : {}}
                  whileTap={{ scale: 0.95 }}
                >
                  <motion.div
                    className={`rounded-full bg-gradient-to-br ${world.color} flex items-center justify-center text-white shadow-xl relative overflow-hidden transition-all duration-300 ${isActive ? 'ring-2 md:ring-4 ring-white/60' : ''} ${isDragging ? 'shadow-2xl' : ''}`}
                    style={{
                      width: dimensions.iconSize,
                      height: dimensions.iconSize,
                      flexShrink: 0,
                    }}
                    animate={{
                      scale: isDragging ? 1.05 : 1,
                    }}
                    transition={{ duration: 0.2 }}
                  >
                    <motion.div
                      className={`absolute inset-0 bg-gradient-to-br ${world.color} rounded-full blur-md`}
                      animate={{
                        scale: isActive ? 1.8 : isDragging ? 1.3 : 1,
                        opacity: isActive ? 0.5 : isDragging ? 0.3 : 0,
                      }}
                      transition={{ duration: 0.3 }}
                    />
                    <motion.div
                      className="relative z-10 transform transition-transform duration-300 group-hover:scale-110"
                      animate={{ rotate: isDragging ? [0, 5, -5, 0] : 0 }}
                      transition={{
                        rotate: {
                          duration: 0.6,
                          repeat: isDragging ? Infinity : 0,
                        },
                      }}
                    >
                      {world.icon}
                    </motion.div>
                    {isActive && (
                      <>
                        <motion.div
                          className="absolute inset-0 border-2 border-white/70 rounded-full"
                          animate={{ scale: [1, 2.5], opacity: [0.8, 0] }}
                          transition={{
                            duration: 2.8,
                            repeat: Infinity,
                            ease: 'easeOut',
                          }}
                        />
                        <motion.div
                          className="absolute inset-0 border-2 border-white/50 rounded-full"
                          animate={{ scale: [1, 2.5], opacity: [0.6, 0] }}
                          transition={{
                            duration: 2.8,
                            repeat: Infinity,
                            ease: 'easeOut',
                            delay: 1,
                          }}
                        />
                      </>
                    )}
                  </motion.div>

                  <motion.div
                    className="whitespace-nowrap text-center"
                    animate={{ scale: isActive ? 1.05 : 1 }}
                    transition={{ scale: { duration: 0.2 } }}
                  >
                    <motion.span
                      className={`font-medium px-2 md:px-3 py-1 rounded-full transition-all duration-300 text-sm ${isActive ? 'bg-white text-gray-800 shadow-lg border border-gray-200' : 'text-gray-600 hover:text-gray-800'}`}
                      animate={{
                        backgroundColor: isActive ? '#ffffff' : 'transparent',
                        boxShadow: isActive
                          ? '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                          : '0 0 0 0 transparent',
                      }}
                    >
                      {world.title}
                    </motion.span>
                  </motion.div>
                </motion.div>
              );
            })}
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, x: 30 }}
          animate={isInView ? { opacity: 1, x: 0 } : {}}
          transition={{ duration: 0.8, delay: 0.6 }}
          className="flex-1 max-w-2xl w-full px-4"
          data-world-info-panel
        >
          <AnimatePresence mode="wait">
            <motion.div
              key={displayedWorld.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              transition={{ duration: 0.4 }}
              // Updated to match Hero Card Background Style
              className={`bg-gradient-to-br ${displayedWorld.bgGradient} rounded-3xl p-6 md:p-10 ${displayedWorld.shadowColor} shadow-2xl border border-white/60 relative overflow-hidden`}
            >
              <div
                className={`absolute inset-0 bg-gradient-to-br ${displayedWorld.color} opacity-5 rounded-3xl`}
              />
              <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/30 to-transparent rounded-full transform translate-x-16 -translate-y-16" />
              <div className="relative z-10">
                <div className="flex items-start gap-4 md:gap-6 mb-6 md:mb-8">
                  <div
                    className={`p-3 md:p-4 rounded-2xl bg-gradient-to-br ${displayedWorld.color} text-white shadow-lg flex-shrink-0`}
                  >
                    {displayedWorld.icon}
                  </div>
                  <div className="flex-1">
                    <div className="flex justify-between items-start">
                      <h4 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
                        {displayedWorld.title}
                      </h4>
                      <Button
                        onClick={() => setIsAutoPlaying((prev) => !prev)}
                        variant="outline"
                        size="icon"
                        className="bg-white/50 hover:bg-white text-gray-500 hover:text-gray-800 border-gray-200 hover:border-gray-300 rounded-full w-10 h-10 -mr-2 -mt-1 flex-shrink-0 shadow-sm hover:shadow-md transition-all duration-300"
                        aria-label={
                          isAutoPlaying ? 'Pause animation' : 'Play animation'
                        }
                      >
                        <AnimatePresence mode="wait">
                          {isAutoPlaying ? (
                            <motion.div
                              key="pause"
                              initial={{ scale: 0.5, opacity: 0 }}
                              animate={{ scale: 1, opacity: 1 }}
                              exit={{ scale: 0.5, opacity: 0 }}
                            >
                              <Pause className="w-5 h-5" />
                            </motion.div>
                          ) : (
                            <motion.div
                              key="play"
                              initial={{ scale: 0.5, opacity: 0 }}
                              animate={{ scale: 1, opacity: 1 }}
                              exit={{ scale: 0.5, opacity: 0 }}
                            >
                              <Play className="w-5 h-5" />
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </Button>
                    </div>
                    <p className="text-base md:text-lg text-gray-600 font-medium">
                      {displayedWorld.shortDesc}
                    </p>
                  </div>
                </div>
                <p className="text-gray-700 leading-relaxed text-base md:text-lg mb-6 md:mb-8">
                  {displayedWorld.fullDescription}
                </p>
                <div className="bg-white/60 rounded-2xl p-4 md:p-6 mb-4 md:mb-6 border border-white/80 shadow-sm">
                  <div className="flex items-start gap-3">
                    <div className={`w-2 h-2 rounded-full bg-gradient-to-r ${displayedWorld.color} mt-3 flex-shrink-0`}></div>
                    <div>
                      <h5 className="font-semibold text-gray-800 mb-2">
                        {dict.example_header}
                      </h5>

                      <p className="text-gray-600 italic text-sm md:text-base">
                        &quot;{displayedWorld.personalExample}&quot;
                      </p>
                    </div>
                  </div>
                </div>
                {/* Updated Insight Box to dynamically match world color */}
                <div className={`bg-white/40 rounded-2xl p-4 md:p-6 border ${getAccentBorderColor(displayedWorld.id)}`}>
                  <div className="flex items-start gap-3">
                    <CheckCircle className={`w-5 h-5 ${getAccentTextColor(displayedWorld.id)} mt-1 flex-shrink-0`} />
                    <div>
                      <h5 className={`font-semibold ${getAccentTextColor(displayedWorld.id)} mb-2`}>
                        {dict.insight_header}
                      </h5>

                      <p className={`${getAccentTextColor(displayedWorld.id)} opacity-90 text-sm md:text-base`}>
                        {displayedWorld.insight}
                      </p>
                    </div>
                  </div>
                </div>
                <div className="mt-6 md:mt-8 flex items-center gap-2">
                  <span className="text-sm text-gray-500 ml-3">
                    {dict.dimension_prefix} {displayedWorld.id}{' '}
                    {dict.dimension_suffix} {worlds.length}
                  </span>
                  {worlds.map((world) => (
                    <button
                      key={world.id}
                      onClick={() => handleWorldInteraction(world.id)}
                      className={`h-2 rounded-full transition-all duration-300 ${world.id === displayedWorld.id ? `bg-gradient-to-r ${displayedWorld.color} flex-1 min-w-[40px] md:min-w-[60px]` : 'bg-gray-200 w-4 md:w-6 hover:bg-gray-300'}`}
                      aria-label={`Select ${world.title}`}
                    />
                  ))}
                </div>
              </div>
            </motion.div>
          </AnimatePresence>
        </motion.div>
      </div>
    </div>
  );
};

const OurMethodSection: React.FC<OurMethodProps> = ({ dict }) => {
  const sectionRef = useRef(null);
  const isInView = useInView(sectionRef, { once: true, amount: 0.02 });
  const pathname = usePathname();
  const locale = (pathname.split('/')[1] as 'he' | 'en') || 'he';

  return (
    <motion.section
      ref={sectionRef}
      id="our-method"
      // Background updated to match HeroSection: Slate-50 base with Teal/Orange tint
      className="relative pt-0 pb-12 md:pb-20 lg:pb-28 px-4 bg-gradient-to-b from-slate-50 via-teal-50/20 to-orange-50/20 overflow-hidden"
      initial={{ opacity: 0 }}
      animate={isInView ? { opacity: 1 } : { opacity: 0 }}
      transition={{ duration: 1 }}
    >
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {/* Floating orbs updated to Hero Palette: Teal, Orange, Rose, Amber */}
        <div className="absolute top-20 left-10 w-32 md:w-40 h-32 md:h-40 bg-teal-300/20 rounded-full blur-3xl animate-soft-float" />
        <div
          className="absolute top-60 right-20 w-24 md:w-32 h-24 md:h-32 bg-orange-300/20 rounded-full blur-2xl animate-soft-float"
          style={{ animationDelay: '2s' }}
        />
        <div
          className="absolute bottom-40 left-1/3 w-36 md:w-48 h-36 md:h-48 bg-rose-300/15 rounded-full blur-3xl animate-soft-float"
          style={{ animationDelay: '4s' }}
        />
        <div
          className="absolute bottom-20 right-10 w-28 md:w-36 h-28 md:h-36 bg-amber-300/20 rounded-full blur-2xl animate-soft-float"
          style={{ animationDelay: '1s' }}
        />
        <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:20px_20px]"></div>
        
        <svg
          className="absolute inset-0 w-full h-full"
          viewBox="0 0 1200 800"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <linearGradient
              id="decorativeGradient"
              x1="0%"
              y1="0%"
              x2="100%"
              y2="100%"
            >
              {/* Decorative Gradient updated: Teal -> Orange -> Rose */}
              <stop offset="0%" stopColor="#14b8a6" stopOpacity="0.08" />
              <stop offset="50%" stopColor="#f97316" stopOpacity="0.06" />
              <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.08" />
            </linearGradient>
          </defs>
          <path
            d="M0,100 C300,50 600,150 1200,100 L1200,0 L0,0 Z"
            fill="url(#decorativeGradient)"
            className="animate-gentle-pulse"
          />
          <path
            d="M0,700 C400,650 800,750 1200,700 L1200,800 L0,800 Z"
            fill="url(#decorativeGradient)"
            className="animate-gentle-pulse"
            style={{ animationDelay: '2s' }}
          />
        </svg>
      </div>

      <div className="relative max-w-8xl mx-auto">
        <MatchingConstellation dict={dict.constellation} locale={locale} />
      </div>

      <style>{`
        @keyframes gentle-pulse {
          0%,
          100% {
            opacity: 0.8;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.02);
          }
        }
        @keyframes soft-float {
          0%,
          100% {
            transform: translateY(0px) rotate(0deg);
          }
          25% {
            transform: translateY(-3px) rotate(0.5deg);
          }
          75% {
            transform: translateY(3px) rotate(-0.5deg);
          }
        }
        .animate-gentle-pulse {
          animation: gentle-pulse 4s ease-in-out infinite;
        }
        .animate-soft-float {
          animation: soft-float 6s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default OurMethodSection;
--- End of Content for OurMethodSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\PrivacyAssuranceSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/PrivacyAssuranceSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { CheckCircle, Lock } from 'lucide-react';
import type { PrivacyAssuranceDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface PrivacyAssuranceProps {
  dict: PrivacyAssuranceDict;
  locale: 'he' | 'en';
}

const PrivacyAssuranceSection: React.FC<PrivacyAssuranceProps> = ({
  dict,
  locale,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.3,
        delayChildren: 0.2,
      },
    },
  };

  const fadeInLeft = {
    hidden: { opacity: 0, x: -60 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };

  const fadeInRight = {
    hidden: { opacity: 0, x: 60 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };

  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.4,
      },
    },
  };

  const listItemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.5, ease: 'easeOut' },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 30 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      // Updated Background: Light theme with Teal/Orange tint
      className="py-16 md:py-20 px-4 bg-gradient-to-b from-slate-50 via-orange-50/20 to-white text-gray-800 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Updated Grid Pattern: Darker dots on light bg */}
      <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#0f172a_1px,transparent_1px)] [background-size:20px_20px]"></div>

      {/* Updated Orbs: Teal and Orange */}
      <div className="absolute top-0 left-0 w-64 h-64 bg-teal-300/20 rounded-full blur-3xl animate-float-slow"></div>
      <div
        className="absolute bottom-0 right-0 w-80 h-80 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      ></div>

      <div className="max-w-5xl mx-auto relative z-10">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
          {/* Left Content */}
          <motion.div variants={fadeInLeft}>
            <div className="mb-8 text-center md:text-right rtl:md:text-right ltr:md:text-left">
              <h2 className="text-3xl sm:text-4xl md:text-5xl font-extrabold mb-4 text-gray-800">
                {dict.title}
              </h2>
              {/* Divider: Gradient Teal to Orange */}
              <div className="w-24 h-1.5 bg-gradient-to-r from-teal-400 to-orange-400 rounded-full mb-6 mx-auto md:mx-0"></div>
              <p className="text-lg md:text-xl text-gray-600 mb-6 mx-auto md:mx-0 max-w-md leading-relaxed">
                {dict.subtitle}
              </p>
            </div>

            <motion.div className="space-y-4" variants={staggeredListVariants}>
              {dict.features.map((feature, index) => (
                <motion.div
                  key={index}
                  className="flex items-start"
                  variants={listItemVariants}
                  whileHover={{ x: 4 }}
                  transition={{ duration: 0.2 }}
                >
                  {/* Icon Container: Soft Teal */}
                  <div className="bg-teal-50 rounded-full p-2 mr-3 rtl:ml-3 rtl:mr-0 mt-1 flex-shrink-0 border border-teal-100 shadow-sm">
                    <CheckCircle className="w-5 h-5 text-teal-600" />
                  </div>
                  <p className="text-gray-700 font-medium pt-1">{feature}</p>
                </motion.div>
              ))}
            </motion.div>
          </motion.div>

          {/* Right Card */}
          <motion.div className="flex justify-center" variants={fadeInRight}>
            <div className="relative max-w-sm w-full">
              {/* Card Glow Effect */}
              <div className="absolute inset-0 bg-gradient-to-br from-teal-400/20 to-orange-400/20 rounded-[2rem] blur-xl transform rotate-6"></div>

              <motion.div
                // Card Body: Glassmorphism Light
                className="relative bg-white/80 backdrop-blur-xl p-8 rounded-[2rem] border border-white/60 shadow-2xl"
                variants={cardVariants}
                whileHover={{
                  scale: 1.02,
                  transition: { duration: 0.2 },
                }}
              >
                <motion.div
                  // Icon Container: Gradient Orange (Privacy/Security focus)
                  className="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-orange-400 via-amber-500 to-yellow-500 rounded-2xl flex items-center justify-center shadow-lg shadow-orange-200 text-white transform -rotate-3"
                  whileHover={{
                    rotate: [0, -10, 10, 0],
                    transition: { duration: 0.6 },
                  }}
                >
                  <Lock className="w-10 h-10 text-white drop-shadow-md" />
                </motion.div>

                <h3 className="text-2xl font-bold mb-4 text-center text-gray-800">
                  {dict.card_title}
                </h3>

                <p className="text-gray-600 text-center mb-8 leading-relaxed">
                  {dict.card_text}
                </p>

                <div className="text-center">
                  <Link href={`/${locale}/legal/privacy-policy`}>
                    <motion.div
                      whileHover={{ scale: 1.05 }}
                      whileTap={{ scale: 0.95 }}
                    >
                      {/* Button: Outline Style (Teal) to match secondary buttons */}
                      <Button
                        variant="outline"
                        size="lg"
                        className="rounded-full border-2 border-teal-200 text-teal-700 bg-teal-50/50 hover:bg-teal-100 hover:border-teal-300 transition-all duration-300 font-semibold px-8"
                      >
                        {dict.card_button}
                      </Button>
                    </motion.div>
                  </Link>
                </div>
              </motion.div>
            </div>
          </motion.div>
        </div>
      </div>

      <style>{`
        @keyframes float-slow {
          0%, 100% { transform: translateY(0) translateX(0); }
          50% { transform: translateY(-20px) translateX(10px); }
        }
        .animate-float-slow {
          animation: float-slow 10s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default PrivacyAssuranceSection;
--- End of Content for PrivacyAssuranceSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\SuccessStoriesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/SuccessStoriesSection.tsx
'use client';

import React, { useRef, useState } from 'react';
import { motion, useInView, AnimatePresence } from 'framer-motion';
import TestimonialCard from '../components/TestimonialCard';
import { Button } from '@/components/ui/button';
import { ArrowLeft, ArrowRight } from 'lucide-react';
import type { SuccessStoriesDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface SuccessStoriesProps {
  dict: SuccessStoriesDict;
  locale: 'he' | 'en';
}

const SuccessStoriesSection: React.FC<SuccessStoriesProps> = ({
  dict,
  locale,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.01 });

  const [showComingSoon, setShowComingSoon] = useState(false);

  const handleMoreStoriesClick = () => {
    setShowComingSoon(true);
    setTimeout(() => {
      setShowComingSoon(false);
    }, 3500);
  };

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.2,
        delayChildren: 0.3,
      },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.8, y: 40 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      id="success-stories"
      // Updated Background: Consistent with Hero/Insight (Subtle Slate/Teal/Orange)
      className="pt-16 md:pt-20 px-4 bg-gradient-to-b from-white via-teal-50/20 to-orange-50/10 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Background Orbs to match other sections */}
      <div className="absolute top-20 left-10 w-72 h-72 bg-teal-200/10 rounded-full blur-3xl animate-float-slow pointer-events-none"></div>
      <div 
        className="absolute bottom-20 right-10 w-80 h-80 bg-orange-200/10 rounded-full blur-3xl animate-float-slow pointer-events-none"
        style={{ animationDelay: '2.5s' }}
      ></div>

      {/* Radial Pattern - Updated color to Teal */}
      <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#0d9488_1px,transparent_1px)] [background-size:20px_20px] pointer-events-none"></div>

      <div className="max-w-6xl mx-auto relative z-10">
        <motion.div
          className="text-center mb-12 md:mb-16"
          variants={headerVariants}
        >
          <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-800 mb-4">
            {dict.title_part1}
            {/* Updated Title Gradient (Teal -> Orange -> Amber) */}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500">
              {' '}
              {dict.title_highlight}
            </span>
          </h2>
          {/* Updated Divider Line */}
          <div className="w-24 h-1.5 bg-gradient-to-r from-teal-400 to-orange-500 mx-auto rounded-full mb-6 shadow-sm" />
          <motion.p
            className="text-lg text-gray-600 max-w-3xl mx-auto"
            variants={headerVariants}
          >
            {dict.subtitle}
          </motion.p>
        </motion.div>

        <motion.div
          className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto"
          variants={containerVariants}
        >
          {dict.stories.map((testimonial) => (
            <motion.div
              key={testimonial.author}
              variants={cardVariants}
              whileHover={{
                y: -8,
                transition: { duration: 0.2 },
              }}
            >
              <TestimonialCard
                text={testimonial.text}
                author={testimonial.author}
                result={testimonial.result}
                color={
                  testimonial.color as 'cyan' | 'green' | 'orange' | 'pink'
                }
              />
            </motion.div>
          ))}
        </motion.div>

        <div className="mt-16 text-center">
          <motion.div
            variants={{
              hidden: { opacity: 0, y: 20 },
              visible: {
                opacity: 1,
                y: 0,
                transition: { duration: 0.6, ease: 'easeOut', delay: 0.4 },
              },
            }}
          >
            <Button
              onClick={handleMoreStoriesClick}
              variant="outline"
              size="lg"
              // Updated Button Styles (Teal/Orange Theme)
              className="border-2 border-teal-200 text-teal-700 hover:bg-white hover:border-teal-400 hover:text-teal-800 hover:shadow-lg hover:shadow-teal-100 transition-all duration-300 rounded-xl group"
            >
              <span>{dict.more_stories_button}</span>
              {locale === 'he' ? (
                <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
              ) : (
                <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              )}{' '}
            </Button>
          </motion.div>

          <div className="mt-4 h-6">
            <AnimatePresence>
              {showComingSoon && (
                <motion.p
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.3 }}
                  // Updated Text Color
                  className="text-teal-600 font-medium bg-teal-50 inline-block px-4 py-1 rounded-full text-sm"
                >
                  {dict.coming_soon_message}
                </motion.p>
              )}
            </AnimatePresence>
          </div>
        </div>

        <motion.div
          className="mt-8 text-center"
          variants={{
            hidden: { opacity: 0, y: 20 },
            visible: {
              opacity: 1,
              y: 0,
              transition: { duration: 0.6, ease: 'easeOut', delay: 0.5 },
            },
          }}
        ></motion.div>
      </div>

      <style>{`
        @keyframes float-slow {
          0%, 100% { transform: translateY(0) translateX(0); }
          50% { transform: translateY(-20px) translateX(10px); }
        }
        .animate-float-slow {
          animation: float-slow 10s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default SuccessStoriesSection;
--- End of Content for SuccessStoriesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\ValuePropositionSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/ValuePropositionSection.tsx

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import ComparisonItem from '../components/ComparisonItem';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // ✨ 1. ייבוא hook נדרש
import type { ValuePropositionDict } from '@/types/dictionary';

interface ValuePropositionProps {
  dict: ValuePropositionDict;
}

const ValuePropositionSection: React.FC<ValuePropositionProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // ✨ 3. קבלת השפה הנוכחית מה-URL
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'he';

  // Animation variants (ללא שינוי)
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.2, delayChildren: 0.3 },
    },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const fadeInLeft = {
    hidden: { opacity: 0, x: -50 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const fadeInRight = {
    hidden: { opacity: 0, x: 50 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const listItemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.4, ease: 'easeOut' },
    },
  };

  return (
    <motion.section
      ref={ref}
      className="py-16 md:py-20 pb-0 px-4 bg-cyan-50 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 bg-gradient-to-br from-cyan-50 to-white opacity-70"></div>

      <div className="max-w-6xl mx-auto relative">
        {/* ✨ 4. שימוש בתרגומים לכותרות */}
        <motion.div className="text-center mb-12" variants={fadeInUp}>
          <h2 className="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-cyan-700">
              {' '}
              {dict.title_brand}{' '}
            </span>
            {dict.title_part2}
          </h2>
          <div className="w-24 h-1 bg-gradient-to-r from-cyan-600 to-cyan-700 mx-auto rounded-full mb-6" />
          <p className="text-lg text-gray-600 max-w-3xl mx-auto">
            {dict.subtitle}
          </p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
          {' '}
          {/* items-start במקום items-center */}
          {/* Left card - Challenge */}
          <motion.div
            className="bg-white rounded-2xl shadow-xl p-8 transform md:translate-x-4 relative overflow-hidden"
            variants={fadeInLeft}
          >
            <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-cyan-100 to-cyan-50 opacity-50 rounded-full transform translate-x-20 -translate-y-20"></div>
            <h3 className="text-xl font-bold mb-4 text-gray-800 relative">
              {dict.challengeCard.title}
            </h3>
            <motion.ul
              className="space-y-3 relative"
              variants={staggeredListVariants}
              initial="hidden"
              animate={isInView ? 'visible' : 'hidden'}
            >
              {/* ✨ 5. רינדור דינמי של רשימת האתגרים */}
              {dict.challengeCard.items.map((item, index) => (
                <motion.div key={index} variants={listItemVariants}>
                  <ComparisonItem isNegative>{item}</ComparisonItem>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
          {/* Right card - Solution */}
          <motion.div
            className="bg-white rounded-2xl shadow-xl p-8 transform md:-translate-x-4 relative overflow-hidden"
            variants={fadeInRight}
          >
            <div className="absolute bottom-0 left-0 w-40 h-40 bg-gradient-to-br from-cyan-100 to-cyan-50 opacity-50 rounded-full transform -translate-x-20 translate-y-20"></div>
            <h3 className="text-xl font-bold mb-4 text-gray-800 relative">
              {dict.solutionCard.title}
            </h3>
            <motion.ul
              className="space-y-3 relative"
              variants={staggeredListVariants}
              initial="hidden"
              animate={isInView ? 'visible' : 'hidden'}
            >
              {/* ✨ 6. רינדור דינמי של רשימת הפתרונות, כולל טיפול בקישור */}
              {dict.solutionCard.items.map((item, index) => (
                <motion.div key={index} variants={listItemVariants}>
                  <ComparisonItem>
                    <strong>{item.bold}</strong>
                    {item.text && <span>{item.text}</span>}
                    {item.textWithLink && (
                      <span>
                        {item.textWithLink.part1}
                        <Link
                          href={`/${locale}/questionnaire`}
                          className="text-cyan-600 hover:underline font-semibold mx-1"
                        >
                          {item.textWithLink.linkText}
                        </Link>
                        {item.textWithLink.part2}
                      </span>
                    )}
                  </ComparisonItem>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
        </div>
      </div>
    </motion.section>
  );
};

export default ValuePropositionSection;
--- End of Content for ValuePropositionSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\sections_contents.txt
--------------------------------------------------------------------------------
Content:
################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections
# Generated on: 2025-11-16 11:43:03
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\CTASection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/CTASection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Sparkles, ArrowRight } from 'lucide-react';
import type { CtaDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface CTAProps {
  dict: CtaDict;
  locale: 'he' | 'en';
}

const CTASection: React.FC<CTAProps> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.2,
        delayChildren: 0.1,
      },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 40 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.8,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  const iconVariants = {
    hidden: { opacity: 0, scale: 0, rotate: -180 },
    visible: {
      opacity: 1,
      scale: 1,
      rotate: 0,
      transition: {
        duration: 0.6,
        delay: 0.3,
        type: 'spring',
        stiffness: 260,
        damping: 15,
      },
    },
  };

  const textVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const buttonVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      className="py-16 md:py-20 px-4 bg-white relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 bg-gradient-to-br from-cyan-50 to-pink-50/50 opacity-70"></div>

      <div className="max-w-4xl mx-auto text-center relative">
        <motion.div
          className="bg-white/80 backdrop-blur-sm rounded-2xl p-8 md:p-12 shadow-xl border border-cyan-100"
          variants={cardVariants}
        >
          <motion.div
            className="inline-block mb-6 p-3 bg-cyan-100 rounded-full text-cyan-600"
            variants={iconVariants}
            whileHover={{
              rotate: [0, -10, 10, 0],
              transition: { duration: 0.6 },
            }}
          >
            <Sparkles className="w-8 h-8" />
          </motion.div>

          <motion.h2
            className="text-3xl sm:text-4xl font-bold text-gray-800 mb-4"
            variants={textVariants}
          >
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-pink-600">
              {' '}
              {dict.title_highlight}
            </span>
          </motion.h2>

          <motion.p
            className="text-lg text-gray-600 mb-8 max-w-2xl mx-auto"
            variants={textVariants}
          >
            {dict.subtitle}
          </motion.p>

          <motion.div variants={buttonVariants}>
            <Link href="/auth/register">
              <motion.div
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
              >
                <Button
                  size="lg"
                  className="bg-gradient-to-r from-cyan-600 to-cyan-700 hover:from-cyan-700 hover:to-cyan-800 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl group"
                >
                  <span className="relative z-10 flex items-center">
                    {dict.button}
                    {locale === 'he' ? (
                      <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                    ) : (
                      <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                    )}{' '}
                  </span>
                </Button>
              </motion.div>
            </Link>
          </motion.div>
        </motion.div>
      </div>
    </motion.section>
  );
};

export default CTASection;
--- End of Content for CTASection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\FAQSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/FAQSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import FAQItem from '../components/FAQItem';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  ArrowLeft,
  Sparkles,
  MessageCircle,
  Shield,
  Clock,
  ArrowRight,
  Users,
  HelpCircle,
  FileText,
} from 'lucide-react';
import type { FaqDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface FAQProps {
  dict: FaqDict;
  locale: 'he' | 'en';
}

const FAQSection: React.FC<FAQProps> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.05 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.2,
      },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const faqContainerVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        staggerChildren: 0.1,
        delayChildren: 0.3,
      },
    },
  };

  const faqItemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.5, ease: 'easeOut' },
    },
  };

  const contactBlockVariants = {
    hidden: { opacity: 0, y: 30, scale: 0.95 },
    visible: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  const faqIcons = [
    {
      icon: <Sparkles className="w-5 h-5" />,
      color: 'from-amber-500 to-orange-500',
    },
    {
      icon: <Users className="w-5 h-5" />,
      color: 'from-purple-500 to-indigo-500',
    },
    {
      icon: <Shield className="w-5 h-5" />,
      color: 'from-cyan-500 to-blue-500',
    },
    {
      icon: <FileText className="w-5 h-5" />,
      color: 'from-pink-500 to-rose-500',
    },
    {
      icon: <Clock className="w-5 h-5" />,
      color: 'from-emerald-500 to-teal-500',
    },
  ];

  return (
    <motion.section
      ref={ref}
      id="faq"
      className="py-16 md:py-20 px-4 bg-gradient-to-br from-slate-50 via-white to-cyan-50/30 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-20 left-10 w-32 h-32 bg-gradient-to-br from-cyan-200/30 to-blue-300/20 rounded-full blur-3xl animate-float-slow"></div>
        <div
          className="absolute top-60 right-20 w-40 h-40 bg-gradient-to-br from-purple-200/25 to-pink-300/15 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute bottom-40 left-1/3 w-36 h-36 bg-gradient-to-br from-emerald-200/20 to-teal-300/15 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '4s' }}
        ></div>
        <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#06b6d4_1px,transparent_1px)] [background-size:30px_30px]"></div>

        <svg
          className="absolute inset-0 w-full h-full"
          viewBox="0 0 1000 1000"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <linearGradient id="waveGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stopColor="#06b6d4" stopOpacity="0.08" />
              <stop offset="100%" stopColor="#8b5cf6" stopOpacity="0.05" />
            </linearGradient>
          </defs>
          <path
            d="M0,200 C300,100 700,300 1000,200 L1000,0 L0,0 Z"
            fill="url(#waveGrad1)"
            className="animate-pulse-slow"
          />
          <path
            d="M0,800 C300,700 700,900 1000,800 L1000,1000 L0,1000 Z"
            fill="url(#waveGrad1)"
            className="animate-pulse-slow"
            style={{ animationDelay: '3s' }}
          />
        </svg>
      </div>

      <div className="max-w-4xl mx-auto relative">
        <motion.div className="text-center mb-16" variants={headerVariants}>
          <div className="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-8 py-4 shadow-lg border border-white/60 mb-8">
            <HelpCircle className="w-6 h-6 text-cyan-600" />
            <span className="text-cyan-700 font-semibold text-lg">
              {dict.header}
            </span>
          </div>

          <h2 className="text-4xl sm:text-5xl md:text-6xl font-bold text-gray-800 mb-6 leading-tight">
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-purple-600">
              {' '}
              {dict.title_highlight}
            </span>
          </h2>

          <div className="flex items-center justify-center gap-2 mb-8">
            <div className="w-16 h-1 bg-gradient-to-r from-cyan-400 to-purple-500 rounded-full"></div>
            <div className="w-3 h-3 bg-gradient-to-r from-cyan-400 to-purple-500 rounded-full"></div>
            <div className="w-16 h-1 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full"></div>
          </div>

          <p className="text-xl md:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </motion.div>

        <motion.div className="relative mb-16" variants={faqContainerVariants}>
          <div className="absolute inset-0 -m-4 bg-white/60 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/40"></div>

          <div className="relative p-8 md:p-12">
            <div className="space-y-1">
              {dict.questions.map((item, index) => (
                <motion.div
                  key={item.question}
                  variants={faqItemVariants}
                  whileHover={{ x: 4 }}
                  transition={{ duration: 0.2 }}
                  className="group"
                >
                  <div className="bg-white/70 backdrop-blur-sm rounded-2xl border border-gray-100/80 hover:border-gray-200 transition-all duration-300 hover:shadow-lg overflow-hidden">
                    <div className="relative">
                      <div
                        className={`h-1 bg-gradient-to-r ${faqIcons[index % faqIcons.length].color} opacity-60 group-hover:opacity-100 transition-opacity duration-300`}
                      ></div>
                      <div className="p-6">
                        <div className="flex items-center gap-4 mb-4">
                          <div
                            className={`p-3 rounded-full bg-gradient-to-r ${faqIcons[index % faqIcons.length].color} text-white shadow-lg group-hover:scale-110 transition-transform duration-300`}
                          >
                            {faqIcons[index % faqIcons.length].icon}
                          </div>
                          <h3 className="text-xl font-bold text-gray-800 flex-1">
                            {item.question}
                          </h3>
                        </div>
                        <div className="relative">
                          {/* Note: Passing empty question to FAQItem as the title is already displayed above */}
                          <FAQItem question="" answer={item.answer} />
                        </div>
                      </div>
                      <div className="absolute bottom-0 right-0 w-32 h-32 opacity-5">
                        <div
                          className={`w-full h-full bg-gradient-to-tl ${faqIcons[index % faqIcons.length].color} rounded-full transform translate-x-16 translate-y-16`}
                        ></div>
                      </div>
                    </div>
                  </div>
                </motion.div>
              ))}
            </div>
          </div>
        </motion.div>

        <motion.div
          className="relative text-center"
          variants={contactBlockVariants}
        >
          <div className="absolute inset-0 -m-8 bg-gradient-to-br from-cyan-500/10 via-purple-500/5 to-pink-500/10 rounded-3xl backdrop-blur-sm border border-white/30"></div>

          <div className="relative max-w-2xl mx-auto p-12">
            <motion.div
              className="inline-block mb-6 p-4 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-full shadow-xl"
              whileHover={{ rotate: [0, -10, 10, 0], scale: 1.1 }}
              transition={{ duration: 0.6 }}
            >
              <MessageCircle className="w-8 h-8 text-white" />
            </motion.div>

            <h3 className="text-3xl font-bold text-gray-800 mb-4">
              {dict.contact_block.title_part1}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-purple-600">
                {' '}
                {dict.contact_block.title_highlight}
              </span>
            </h3>

            <p className="text-lg text-gray-600 mb-8 leading-relaxed">
              {dict.contact_block.subtitle}
            </p>

            <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
              {/* ▼▼▼ כאן השינוי ▼▼▼ */}
              <Link href={`/${locale}/contact`}>
                <motion.div
                  whileHover={{ scale: 1.05, y: -2 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Button
                    size="lg"
                    className="bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl px-8 py-4 text-lg font-semibold group"
                  >
                    <span className="flex items-center gap-3">
                      {dict.contact_block.button}
                      {locale === 'he' ? (
                        <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                      ) : (
                        <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                      )}{' '}
                    </span>
                  </Button>
                </motion.div>
              </Link>
              {/* ▲▲▲ כאן השינוי ▲▲▲ */}

              <div className="flex items-center gap-3 text-gray-600">
                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span className="font-medium">
                  {dict.contact_block.availability}
                </span>
              </div>
            </div>
          </div>
        </motion.div>
      </div>

      <style >{`
        @keyframes float-slow {
          0%,
          100% {
            transform: translateY(0px) rotate(0deg);
          }
          50% {
            transform: translateY(-20px) rotate(2deg);
          }
        }
        @keyframes pulse-slow {
          0%,
          100% {
            opacity: 0.8;
          }
          50% {
            opacity: 1;
          }
        }
        .animate-float-slow {
          animation: float-slow 8s ease-in-out infinite;
        }
        .animate-pulse-slow {
          animation: pulse-slow 4s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default FAQSection;
--- End of Content for FAQSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\FooterSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/FooterSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Heart } from 'lucide-react';
import { FooterLink, FooterItem } from '../components/FooterComponents';
import type { FooterDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface FooterProps {
  dict: FooterDict;
}

const FooterSection: React.FC<FooterProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.2,
      },
    },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const logoVariants = {
    hidden: { opacity: 0, scale: 0.8, y: 20 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };
  const columnVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.05,
      },
    },
  };
  const listItemVariants = {
    hidden: { opacity: 0, x: -10 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.4, ease: 'easeOut' },
    },
  };
  const bottomSectionVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut', delay: 0.5 },
    },
  };
  return (
    <motion.footer
      ref={ref}
      className="bg-gradient-to-br from-gray-900 to-gray-800 text-white py-12 md:py-16 px-4 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwVjB6bTEwIDEwaDIwdjIwSDEwVjEweiIvPjwvZz48L2c+PC9zdmc+')]"></div>

      <div className="max-w-6xl mx-auto relative">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 md:gap-12">
          <motion.div className="md:col-span-1" variants={logoVariants}>
            <motion.div
              whileHover={{ scale: 1.05 }}
              transition={{ duration: 0.2 }}
            >
              <Link href="/" className="flex items-center gap-2 group mb-6">
                <div className="relative overflow-hidden rounded-full p-1 transition-all duration-300 group-hover:scale-110">
                  <Heart
                    className="h-7 w-7 text-cyan-400 transition-all duration-300 group-hover:text-cyan-300"
                    fill="#1e293b"
                  />
                </div>
                <span className="text-xl font-bold text-white group-hover:text-cyan-300 transition-all duration-300">
                  NeshamaTech
                </span>
              </Link>
            </motion.div>
            <motion.p className="text-gray-400 mb-6" variants={fadeInUp}>
              {dict.description}
            </motion.p>
          </motion.div>

          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-cyan-300">
                {dict.columns.navigation.title}
              </span>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-cyan-400/30 to-cyan-300/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.navigation.links.map((link) => (
                <motion.div key={link.href} variants={listItemVariants}>
                  <FooterLink href={link.href}>{link.text}</FooterLink>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>

          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-cyan-300">
                {dict.columns.information.title}
              </span>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-cyan-400/30 to-cyan-300/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.information.links.map((link) => (
                <motion.div key={link.href} variants={listItemVariants}>
                  <FooterLink href={link.href}>{link.text}</FooterLink>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>

          <motion.div variants={columnVariants}>
            <h3 className="font-bold text-xl mb-4 md:mb-6 relative">
              <span className="relative z-10 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-cyan-300">
                {dict.columns.contact.title}
              </span>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-cyan-400/30 to-cyan-300/30" />
            </h3>
            <motion.ul
              className="space-y-3 md:space-y-4"
              variants={staggeredListVariants}
            >
              {dict.columns.contact.items.map((item) => (
                <motion.div key={item.text} variants={listItemVariants}>
                  <FooterItem icon={item.icon} text={item.text} />
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
        </div>

        <motion.div
          className="mt-8 md:mt-12 pt-6 md:pt-8 border-t border-gray-700/50"
          variants={bottomSectionVariants}
        >
          <div className="text-center">
            <motion.div
              className="mb-4"
              whileHover={{ scale: 1.05 }}
              transition={{ duration: 0.2 }}
            >
              <span className="inline-block px-4 py-2 rounded-full bg-gradient-to-r from-cyan-500/10 to-cyan-400/10 text-cyan-400 hover:from-cyan-500/20 hover:to-cyan-400/20 transition-colors duration-300">
                {dict.motto}
              </span>
            </motion.div>
            <p className="text-gray-400">{dict.copyright}</p>
          </div>
        </motion.div>
      </div>
    </motion.footer>
  );
};
export default FooterSection;
--- End of Content for FooterSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\HeroSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/HeroSection.tsx

'use client';

import React, { useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import {
  ArrowLeft,
  ArrowRight,
  Shield,
  User,
  BookOpen,
  Brain,
  Handshake,
} from 'lucide-react';
import { Session } from 'next-auth';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import type { HeroSectionDict, PrincipleDict } from '@/types/dictionary';

interface HeroSectionProps {
  session: Session | null;
  isVisible: boolean;
  dict: HeroSectionDict;
  locale: 'he' | 'en';
}

// --- קומפוננטת מכונת הכתיבה (מעודכנת) ---
const TypewriterText: React.FC<{
  text: string;
  delay?: number;
  speed?: number;
  className?: string;
  locale: 'he' | 'en';
}> = ({ text, delay = 0, speed = 30, className = '', locale }) => {
  const [displayedText, setDisplayedText] = useState('');
  const [isStarted, setIsStarted] = useState(false);
  const [isFinished, setIsFinished] = useState(false); // מצב חדש למעקב אחר סיום הכתיבה

  useEffect(() => {
    const startTimer = setTimeout(() => setIsStarted(true), delay);
    return () => clearTimeout(startTimer);
  }, [delay]);

  useEffect(() => {
    if (!isStarted || displayedText.length >= text.length) return;
    const interval = setInterval(() => {
      setDisplayedText(text.substring(0, displayedText.length + 1));
    }, speed);
    return () => clearInterval(interval);
  }, [displayedText, text, speed, isStarted]);
  useEffect(() => {
    if (!isStarted || isFinished) return; // עצור אם האנימציה הסתיימה
    if (displayedText.length >= text.length) {
      setIsFinished(true); // קבע שהכתיבה הסתיימה
      return;
    }
    const interval = setInterval(() => {
      setDisplayedText(text.substring(0, displayedText.length + 1));
    }, speed);
    return () => clearInterval(interval);
  }, [displayedText, text, speed, isStarted, isFinished]);

  // קביעת סגנון דינמי בהתבסס על השפה ועל מצב הסיום
  const dynamicStyle: React.CSSProperties = {
    direction: locale === 'he' ? 'rtl' : 'ltr',
    textAlign: isFinished ? 'center' : locale === 'he' ? 'right' : 'left',
    width: '100%', // ודא שהאלמנט תופס את כל הרוחב כדי שהיישור יעבוד
  };

  return (
    <div
      className={className}
      aria-label={text}
      aria-live="polite"
      style={dynamicStyle} // החלת הסגנון הדינמי
    >
      {displayedText}
      {!isFinished && (
        <span className="inline-block w-0.5 h-6 bg-gradient-to-b from-cyan-500 via-pink-400 to-cyan-500 animate-pulse ml-1 align-text-top shadow-sm shadow-cyan-400/40 rounded-full"></span>
      )}
    </div>
  );
};

// --- קומפוננטות העקרונות (מעודכנות לקבל props) ---
const principleIcons = [
  <BookOpen
    key="principle-icon-1"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
  <Shield
    key="principle-icon-2"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
  <User
    key="principle-icon-3"
    className="w-9 h-9"
    strokeWidth={2.8}
    fill="none"
    stroke="currentColor"
  />,
];

// --- קומפוננטת כרטיסיית העקרונות עבור דסקטופ ---
interface DesktopPrincipleCardProps {
  principle: PrincipleDict;
  index: number;
}
const DesktopPrincipleCard: React.FC<DesktopPrincipleCardProps> = ({
  principle,
  index,
}) => {
  const getColors = (idx: number) => {
    const colors = [
      {
        gradient: 'from-cyan-400 via-cyan-500 to-blue-500',
        shadowColor: 'shadow-cyan-500/25',
        glowColor: 'shadow-cyan-400/30',
        bgGradient: 'from-cyan-50 via-white to-blue-50',
      },
      {
        gradient: 'from-purple-400 via-purple-500 to-indigo-500',
        shadowColor: 'shadow-purple-500/25',
        glowColor: 'shadow-purple-400/30',
        bgGradient: 'from-purple-50 via-white to-indigo-50',
      },
      {
        gradient: 'from-pink-400 via-pink-500 to-rose-500',
        shadowColor: 'shadow-pink-500/25',
        glowColor: 'shadow-pink-400/30',
        bgGradient: 'from-pink-50 via-white to-rose-50',
      },
    ];
    return colors[idx % colors.length];
  };

  const colors = getColors(index);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5, delay: 0.7 + index * 0.1 }}
      whileHover={{ y: -8, scale: 1.02 }}
      className={`group relative overflow-hidden rounded-3xl bg-gradient-to-br ${colors.bgGradient} p-8 ${colors.shadowColor} shadow-2xl border border-white/50 h-full transition-all duration-500`}
    >
      <div className="absolute top-4 right-4 w-20 h-20 rounded-full bg-gradient-to-br from-white/20 to-transparent blur-xl" />
      <div className="absolute bottom-4 left-4 w-12 h-12 rounded-full bg-gradient-to-br from-white/30 to-transparent blur-lg" />
      <div className="relative z-10 h-full flex flex-col">
        <div className="flex items-center justify-center mb-6">
          <div
            className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${colors.gradient} flex items-center justify-center text-white ${colors.glowColor} shadow-xl transform group-hover:rotate-12 transition-transform duration-500`}
          >
            {principleIcons[index]}
            <div className="absolute inset-0 rounded-2xl bg-white/15 backdrop-blur-sm" />
          </div>
        </div>
        <h4 className="font-bold text-gray-800 text-lg mb-4 text-center leading-tight">
          {principle.title}
        </h4>
        <p className="text-gray-700 text-sm leading-relaxed text-center flex-1">
          {principle.description}
        </p>
        <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
      </div>
    </motion.div>
  );
};

// --- קומפוננטת הטאבים למובייל ---
interface MobilePrinciplesTabsProps {
  isVisible: boolean;
  dict: {
    principlesHeader: { title: string; subtitle: string };
    principles: PrincipleDict[];
  };
}
const MobilePrinciplesTabs: React.FC<MobilePrinciplesTabsProps> = ({
  dict,
}) => {
  const [activeTab, setActiveTab] = useState(0);

  const principlesData = useMemo(
    () =>
      dict.principles.map((p, index) => {
        const colors = [
          {
            gradient: 'from-cyan-400 via-cyan-500 to-blue-500',
            shadowColor: 'shadow-cyan-500/25',
            glowColor: 'shadow-cyan-400/30',
            bgGradient: 'from-cyan-50 via-white to-blue-50',
            accentColor: 'bg-cyan-500',
          },
          {
            gradient: 'from-purple-400 via-purple-500 to-indigo-500',
            shadowColor: 'shadow-purple-500/25',
            glowColor: 'shadow-purple-400/30',
            bgGradient: 'from-purple-50 via-white to-indigo-50',
            accentColor: 'bg-purple-500',
          },
          {
            gradient: 'from-pink-400 via-pink-500 to-rose-500',
            shadowColor: 'shadow-pink-500/25',
            glowColor: 'shadow-pink-400/30',
            bgGradient: 'from-pink-50 via-white to-rose-50',
            accentColor: 'bg-pink-500',
          },
        ];
        return {
          ...p,
          icon: principleIcons[index],
          ...colors[index % colors.length],
        };
      }),
    [dict.principles]
  );

  return (
    <div className="w-full">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.6 }}
        className="text-center mb-8"
      >
        <h3 className="text-2xl font-bold text-gray-800 mb-3">
          {dict.principlesHeader.title}
        </h3>
        <p className="text-gray-600 text-sm max-w-sm mx-auto leading-relaxed">
          {dict.principlesHeader.subtitle}
        </p>
        <div className="relative mt-4">
          <div className="w-16 h-0.5 bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 rounded-full mx-auto" />
          <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rounded-full border-2 border-pink-400" />
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.7 }}
        className="relative mb-6"
      >
        <div className="relative bg-white/90 rounded-2xl p-2 shadow-xl border border-white/30">
          <div className="relative flex">
            {principlesData.map((principle, index) => (
              <button
                key={index}
                className={`flex-1 py-3 px-1 flex flex-col items-center justify-center gap-2 relative z-20 rounded-xl transition-all duration-500 ${activeTab === index ? `bg-gradient-to-r ${principle.gradient} ${principle.shadowColor} shadow-lg` : 'bg-transparent hover:bg-white/40'}`}
                onClick={() => setActiveTab(index)}
              >
                <div
                  className={`flex items-center justify-center mb-2 transition-all duration-300 ${activeTab === index ? 'scale-110' : 'hover:scale-105'}`}
                >
                  <div
                    className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300 ${activeTab === index ? `bg-gradient-to-br ${principle.gradient} shadow-lg` : 'bg-white/60 shadow-sm'}`}
                  >
                 {React.cloneElement(principle.icon as React.ReactElement<{ className?: string; strokeWidth?: number }>, {
  className: `w-5 h-5 ${activeTab === index ? 'text-white' : 'text-gray-700'}`,
  strokeWidth: 2.5,
})}
                  </div>
                </div>
                <div
                  className={`text-xs font-bold text-center leading-tight flex items-center justify-center px-1 transition-all duration-300 ${activeTab === index ? 'text-white [text-shadow:0_1px_2px_rgba(0,0,0,0.3)] transform scale-105' : 'text-gray-900 hover:text-black'}`}
                >
                  <span className="relative">
                    {principle.shortTitle}
                    {activeTab === index && (
                      <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-4 h-0.5 bg-white/60 rounded-full" />
                    )}
                  </span>
                </div>
              </button>
            ))}
          </div>
        </div>
      </motion.div>
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.7, delay: 0.8 }}
        className="relative"
      >
        <AnimatePresence mode="wait">
          {principlesData.map(
            (principle, index) =>
              activeTab === index && (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: 50, scale: 0.95 }}
                  animate={{ opacity: 1, x: 0, scale: 1 }}
                  exit={{ opacity: 0, x: -50, scale: 0.95 }}
                  transition={{ duration: 0.4, ease: 'easeInOut' }}
                  className="absolute inset-0"
                >
                  <div
                    className={`relative overflow-hidden rounded-3xl bg-gradient-to-br ${principle.bgGradient} p-8 ${principle.shadowColor} shadow-2xl border border-white/50`}
                  >
                    <div className="relative z-10">
                      <div className="flex items-center justify-center mb-6">
                        <div
                          className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${principle.gradient} flex items-center justify-center text-white ${principle.glowColor} shadow-xl`}
                        >
                          {principle.icon}
                        </div>
                      </div>
                      <h4 className="font-bold text-gray-800 text-xl mb-4 text-center leading-tight tracking-wide">
                        {principle.title}
                      </h4>
                      <p className="text-gray-700 text-base leading-relaxed text-center px-2 max-w-md mx-auto">
                        {principle.description}
                      </p>
                      <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
                    </div>
                  </div>
                </motion.div>
              )
          )}
        </AnimatePresence>
        <div className="h-80" />
      </motion.div>
    </div>
  );
};

// --- הרכיב הראשי - מעודכן במלואו ---
const HeroSection: React.FC<HeroSectionProps> = ({
  isVisible,
  dict,
  locale,
}) => {
  const logoUrl =
    'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png';

  return (
    <motion.section
      className="relative min-h-screen pt-12 pb-16 md:pt-16 md:pb-20 overflow-hidden flex flex-col items-center justify-center w-full px-4 sm:px-6 lg:px-8"
      initial="hidden"
      animate={isVisible ? 'visible' : 'hidden'}
      transition={{ staggerChildren: 0.2 }}
    >
      <div
        className="absolute inset-0 bg-gradient-to-br from-cyan-50 via-white to-pink-50 animate-gradient-slow"
        style={{ backgroundSize: '400% 400%' }}
      />
      <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#06b6d4_1px,transparent_1px)] [background-size:20px_20px]"></div>
      <div className="absolute top-1/4 left-[10%] w-32 h-32 rounded-full bg-cyan-200/20 blur-2xl animate-float-slow"></div>
      <div
        className="absolute bottom-1/4 right-[10%] w-40 h-40 rounded-full bg-pink-200/20 blur-2xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      ></div>

      <div className="relative z-10 w-full max-w-7xl mx-auto flex flex-col items-center">
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, ease: 'easeOut' }}
          className="text-center"
        >
          <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-extrabold text-gray-800 tracking-tight">
            {dict.titleLine1}
            <br className="sm:hidden" />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-pink-500 animate-gradient mx-3">
              {dict.highlightedWord}
            </span>
          </h1>
          <div className="mt-6 max-w-4xl mx-auto text-lg md:text-xl leading-relaxed min-h-[8rem] md:min-h-[6rem]">
            <div className="relative group">
              <div className="absolute inset-0 bg-gradient-to-br from-white/70 via-cyan-50/40 to-pink-50/40 backdrop-blur-lg rounded-3xl border-2 border-white/70 shadow-2xl group-hover:shadow-cyan-200/30 transition-all duration-500"></div>
              <div className="relative p-8 md:p-10">
                {isVisible && (
                  <TypewriterText
                    text={dict.typewriterText}
                    delay={1200}
                    speed={32}
                    className="block text-center leading-relaxed text-transparent bg-clip-text bg-gradient-to-br from-gray-700 via-gray-600 to-gray-700 font-bold tracking-wide drop-shadow-sm"
                    locale={locale}
                  />
                )}
              </div>
              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-20 h-1.5 bg-gradient-to-r from-cyan-400 via-pink-400 to-cyan-400 rounded-full shadow-lg shadow-pink-300/40"></div>
            </div>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, delay: 0.2 }}
          className="w-full max-w-4xl mt-12 md:mt-16"
          aria-hidden="true"
        >
          {/* START: ויזואליזציית סינרגיה - שוחזר והותאם למובייל */}
          <div className={`md:hidden relative h-64`}>
            {/* SVG של הקווים */}
            <svg
              className="absolute inset-0 w-full h-full overflow-visible"
              viewBox="0 0 320 256"
            >
              <defs>
                <filter id="glow-mobile">
                  <feGaussianBlur
                    stdDeviation="3.5"
                    result="coloredBlur"
                  ></feGaussianBlur>
                  <feMerge>
                    <feMergeNode in="coloredBlur"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                  </feMerge>
                </filter>
              </defs>
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 30 128 C 90 60, 130 60, 160 110"
                stroke="#06b6d4"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow-mobile)"
              />
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 290 128 C 230 196, 190 196, 160 110"
                stroke="#ec4899"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow-mobile)"
              />
            </svg>

            {/* אלמנט שמאל - כלים טכנולוגיים */}
            <div
              className={`absolute top-1/2 left-4 -translate-y-1/2 flex flex-col items-center gap-2 opacity-0 ${isVisible ? 'animate-synergy-enter-left' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Brain className="w-8 h-8 text-cyan-500" />
              </div>
              <span className="font-bold text-gray-700 text-sm text-center">
                {dict.synergy.techTools}
              </span>
            </div>

            {/* אלמנט ימין - ליווי אישי */}
            <div
              className={`absolute top-1/2 right-4 -translate-y-1/2 flex flex-col items-center gap-2 opacity-0 ${isVisible ? 'animate-synergy-enter-right' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Handshake className="w-8 h-8 text-pink-500" />
              </div>
              <span className="font-bold text-gray-700 text-sm text-center">
                {dict.synergy.personalGuidance}
              </span>
            </div>

            {/* לוגו במרכז */}
            <div
              className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 ${isVisible ? 'animate-match-point-appear' : ''}`}
            >
              <div className="p-3 bg-gradient-to-br from-white to-gray-50 rounded-full shadow-2xl border-2 border-white">
                <div className="relative w-9 h-9">
                  <Image
                    src={getRelativeCloudinaryPath(logoUrl)}
                    alt="NeshamaTech Logo"
                    fill
                    className="object-contain"
                  />
                </div>
              </div>
            </div>
          </div>
          {/* END: ויזואליזציית סינרגיה למובייל */}

          <div className={`hidden md:block relative h-64`}>
            <div
              className={`absolute top-1/2 left-0 -translate-y-1/2 flex items-center gap-3 opacity-0 ${isVisible ? 'animate-synergy-enter-left' : ''}`}
            >
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Brain className="w-8 h-8 text-cyan-500" />
              </div>
              <span className="font-bold text-gray-700">
                {dict.synergy.techTools}
              </span>{' '}
            </div>
            <div
              className={`absolute top-1/2 right-0 -translate-y-1/2 flex items-center gap-3 opacity-0 ${isVisible ? 'animate-synergy-enter-right' : ''}`}
            >
              <span className="font-bold text-gray-700">
                {dict.synergy.personalGuidance}
              </span>
              <div className="p-4 bg-white/60 backdrop-blur-md rounded-full shadow-lg border border-white/50">
                <Handshake className="w-8 h-8 text-pink-500" />
              </div>
            </div>
            <svg
              className="absolute inset-0 w-full h-full overflow-visible"
              viewBox="0 0 700 256"
            >
              <defs>
                <filter id="glow">
                  <feGaussianBlur
                    stdDeviation="3.5"
                    result="coloredBlur"
                  ></feGaussianBlur>
                  <feMerge>
                    <feMergeNode in="coloredBlur"></feMergeNode>
                    <feMergeNode in="SourceGraphic"></feMergeNode>
                  </feMerge>
                </filter>
              </defs>
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 60 128 C 180 50, 280 50, 350 128"
                stroke="#06b6d4"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow)"
              />
              <path
                className={`${isVisible ? 'path-draw' : ''}`}
                d="M 640 128 C 520 200, 420 200, 350 128"
                stroke="#ec4899"
                strokeWidth="2.5"
                fill="none"
                strokeLinecap="round"
                filter="url(#glow)"
              />
            </svg>
            <div
              className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 ${isVisible ? 'animate-match-point-appear' : ''}`}
            >
              <div className="flex items-center gap-3 p-3 bg-gradient-to-br from-white to-gray-50 rounded-full shadow-2xl border-2 border-white">
                <div className="relative w-9 h-9">
                  <Image
                    src={getRelativeCloudinaryPath(logoUrl)}
                    alt="NeshamaTech Logo"
                    fill
                    className="object-contain"
                  />
                </div>
                <span className="font-bold text-xl text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-pink-500">
                  NeshamaTech
                </span>
              </div>
            </div>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.7, delay: 0.4 }}
          className="mt-8 flex flex-row items-center justify-center gap-4"
        >
          <Link href={`/${locale}/auth/register`}>
            <Button
              size="lg"
              className="text-base md:text-lg px-8 py-6 bg-gradient-to-r from-cyan-500 to-pink-500 hover:from-cyan-600 hover:to-pink-600 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group"
            >
              <span className="hidden md:inline">{dict.ctaButton}</span>
              <span className="md:hidden">
                {dict.ctaButtonShort || dict.ctaButton}
              </span>
              {locale === 'he' ? (
                <ArrowLeft className="mr-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              ) : (
                <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              )}
            </Button>
          </Link>
          <Link
            href={`/${locale}/questionnaire`}
            id="onboarding-target-questionnaire-button"
          >
            <Button
              variant="outline"
              size="lg"
              className="text-base md:text-lg px-8 py-6 border-2 border-cyan-200 text-cyan-600 bg-white/50 hover:bg-white hover:border-cyan-300 rounded-full transition-all duration-300"
            >
              <span className="hidden md:inline">{dict.secondaryButton}</span>
              <span className="md:hidden">
                {dict.secondaryButtonShort || dict.secondaryButton}
              </span>{' '}
            </Button>
          </Link>
        </motion.div>

        <div className="mt-12 sm:mt-16 w-full max-w-6xl">
          <div className="md:hidden">
            <MobilePrinciplesTabs
              isVisible={isVisible}
              dict={{
                principlesHeader: dict.principlesHeader,
                principles: dict.principles,
              }}
            />
          </div>
          <div className="hidden md:block">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.7, delay: 0.6 }}
            >
              <div className="text-center mb-8">
                <h3 className="text-2xl font-bold text-gray-800 mb-3">
                  {dict.principlesHeader.title}
                </h3>
                <p className="text-gray-600 max-w-md mx-auto">
                  {dict.principlesHeader.subtitle}
                </p>
                <div className="relative mt-4">
                  <div className="w-16 h-0.5 bg-gradient-to-r from-cyan-400 via-pink-400 to-purple-400 rounded-full mx-auto" />
                  <div className="absolute -top-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-white rounded-full border-2 border-pink-400" />
                </div>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {dict.principles.map((principle, index) => (
                  <DesktopPrincipleCard
                    key={index}
                    principle={principle}
                    index={index}
                  />
                ))}
              </div>
            </motion.div>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes gradient-slow {
          0%,
          100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .animate-gradient-slow {
          animation: gradient-slow 15s ease infinite;
        }
        @keyframes gradient {
          0%,
          100% {
            background-position: 0% 50%;
          }
          50% {
            background-position: 100% 50%;
          }
        }
        .animate-gradient {
          background-size: 200% 200%;
          animation: gradient 4s ease-in-out infinite;
        }
        @keyframes float-slow {
          0%,
          100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-20px);
          }
        }
        .animate-float-slow {
          animation: float-slow 8s ease-in-out infinite;
        }
        @keyframes synergy-enter-left {
          from {
            opacity: 0;
            transform: translateY(-50%) translateX(-40px);
          }
          to {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
          }
        }
        .animate-synergy-enter-left {
          animation: synergy-enter-left 0.8s 0.2s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
        @keyframes synergy-enter-right {
          from {
            opacity: 0;
            transform: translateY(-50%) translateX(40px);
          }
          to {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
          }
        }
        .animate-synergy-enter-right {
          animation: synergy-enter-right 0.8s 0.2s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
        @keyframes path-draw-anim {
          to {
            stroke-dashoffset: 0;
          }
        }
        .path-draw {
          stroke-dasharray: 1000;
          stroke-dashoffset: 1000;
          animation: path-draw-anim 1s 0.7s ease-out forwards;
        }
        @keyframes match-point-appear {
          from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
          }
          to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
          }
        }
        .animate-match-point-appear {
          animation: match-point-appear 0.6s 1.4s cubic-bezier(0.25, 1, 0.5, 1)
            forwards;
        }
      `}</style>
    </motion.section>
  );
};

export default HeroSection;
--- End of Content for HeroSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\HowItWorksSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/HowItWorksSection.tsx
'use client';

import React, { useRef } from 'react';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import Step from '../components/Step';
import { LiveSuggestionDemo } from '../components/LiveSuggestionDemo';

import { Button } from '@/components/ui/button';
import Link from 'next/link';
import {
  ArrowLeft,
  Sparkles,
  ArrowRight,
  Heart,
  CheckCircle,
  Quote,
  Star,
  Lightbulb,
  TrendingUp,
  Award,
  HeartHandshake,
} from 'lucide-react';
import { motion, useInView } from 'framer-motion';
import type {
  HowItWorksDict,
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary'; // 1. ייבוא הטיפוס
import { generateDemoData } from '../components/demo-data';

type DemoData = Awaited<ReturnType<typeof generateDemoData>>;

interface HowItWorksProps {
  dict: HowItWorksDict;
  suggestionsDict: SuggestionsDictionary;
  profileCardDict: ProfileCardDict; // 2. הוספת ה-prop לממשק

  demoData: DemoData; // הוסף את זה
  locale: 'he' | 'en'; // <-- ✨ 1. הוסף את locale לממשק ה-props
}
// --- END: Type Definitions ---

// --- START: Helper Components ---
const DynamicBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none">
    <div className="absolute inset-0 opacity-3">
      <div className="absolute top-10 left-10 w-32 h-32 bg-gradient-to-br from-cyan-400/20 to-blue-500/20 rounded-full blur-2xl animate-pulse-slow" />
      <div className="absolute top-40 right-20 w-24 h-24 bg-gradient-to-br from-pink-400/20 to-purple-500/20 rounded-full blur-xl animate-float-slow" />
      <div
        className="absolute bottom-32 left-1/4 w-40 h-40 bg-gradient-to-br from-orange-400/15 to-red-500/15 rounded-full blur-3xl animate-pulse-slow"
        style={{ animationDelay: '2s' }}
      />
      <div
        className="absolute bottom-10 right-10 w-28 h-28 bg-gradient-to-br from-green-400/20 to-teal-500/20 rounded-full blur-2xl animate-float-slow"
        style={{ animationDelay: '1s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#06b6d4_1px,transparent_1px)] [background-size:20px_20px]" />
    <svg
      className="absolute inset-0 w-full h-full"
      viewBox="0 0 1000 1000"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <linearGradient id="dynamicGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#06b6d4" stopOpacity="0.1" />
          <stop offset="100%" stopColor="#ec4899" stopOpacity="0.05" />
        </linearGradient>
      </defs>
      <path
        d="M0,200 C300,100 700,300 1000,200 L1000,0 L0,0 Z"
        fill="url(#dynamicGrad1)"
        className="animate-pulse-slow"
      />
      <path
        d="M0,800 C300,700 700,900 1000,800 L1000,1000 L0,1000 Z"
        fill="url(#dynamicGrad1)"
        className="animate-pulse-slow"
        style={{ animationDelay: '3s' }}
      />
    </svg>
  </div>
);

const KeyBenefit: React.FC<{
  icon: React.ReactNode;
  title: string;
  description: string;
  color: 'cyan' | 'pink' | 'orange' | 'green';
  delay?: number;
}> = ({ icon, title, description, color, delay = 0 }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  const colorClasses = {
    cyan: 'from-cyan-500 to-cyan-600',
    pink: 'from-pink-500 to-pink-600',
    orange: 'from-orange-500 to-orange-600',
    green: 'from-green-500 to-green-600',
  };

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.6, delay }}
      className="text-center group"
    >
      <div
        className={`w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br ${colorClasses[color]} flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300`}
      >
        {icon}
      </div>
      <h4 className="font-bold text-lg text-gray-800 mb-2">{title}</h4>
      <p className="text-gray-600 text-sm leading-relaxed">{description}</p>
    </motion.div>
  );
};
// --- END: Helper Components ---

const HowItWorksSection: React.FC<HowItWorksProps> = ({
  dict,
  suggestionsDict,
  demoData,
  profileCardDict,
  locale, // <-- ✨ 2. קבל את locale
}) => {
  const demoRef = useRef(null);
  const isDemoInView = useInView(demoRef, { once: true, amount: 0.1 });

  const stepColors = ['cyan', 'green', 'orange', 'pink'] as const;

  const benefitDetails = [
    {
      icon: <TrendingUp className="w-8 h-8 text-white" />,
      color: 'cyan' as const,
    },
    { icon: <Award className="w-8 h-8 text-white" />, color: 'pink' as const },
    {
      icon: <Lightbulb className="w-8 h-8 text-white" />,
      color: 'orange' as const,
    },
    {
      icon: <HeartHandshake className="w-8 h-8 text-white" />,
      color: 'green' as const,
    },
  ];

  return (
    <section
      id="how-it-works"
      className="relative pb-20 md:pb-28 px-4 bg-gradient-to-b from-white via-cyan-50/20 to-white overflow-hidden"
    >
      <DynamicBackground />

      <div className="relative max-w-7xl mx-auto">
        {/* --- Chapter 1: The Promise --- */}
        <motion.div
          initial={{ opacity: 0, y: 50 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.2 }}
          transition={{ duration: 1 }}
          className="text-center mb-20"
        >
          <div className="inline-block mb-6">
            <div className="flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-6 py-3 shadow-lg border border-white/60">
              <Sparkles className="w-6 h-6 text-cyan-500" />
              <span className="text-cyan-700 font-semibold">
                {dict.promise.header}
              </span>
            </div>
          </div>
          <h2 className="text-4xl sm:text-5xl md:text-6xl font-bold text-gray-800 mb-8 leading-tight">
            {dict.promise.title_line1}
            <br />
            {dict.promise.title_line2_part1}{' '}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-pink-600">
              {dict.promise.title_line2_part2}
            </span>
          </h2>
          <p className="text-xl md:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed mb-8">
            {dict.promise.subtitle_line1}
            <br />
            <span className="text-cyan-700 font-semibold">
              {dict.promise.subtitle_line2}
            </span>
          </p>
        </motion.div>

        {/* --- Chapter 2: The Process --- */}
        <div className="relative mb-20">
          <div className="absolute inset-0 -m-8 bg-gradient-to-br from-cyan-50/50 via-white/80 to-pink-50/50 rounded-3xl backdrop-blur-sm border border-white/40 shadow-2xl" />
          <div className="relative max-w-5xl mx-auto space-y-12 p-8">
            {dict.process.steps.map((step, index) => (
              <Step
                key={index}
                number={`${index + 1}`}
                title={step.title}
                description={
                  <>
                    {step.description}
                    {step.linkText && (
                      <Link
                        href={`/${locale}/questionnaire`}
                        className="font-bold text-cyan-600 hover:underline"
                      >
                        {' '}
                        {step.linkText}
                      </Link>
                    )}
                  </>
                }
                color={stepColors[index]}
                isLast={index === dict.process.steps.length - 1}
              />
            ))}
          </div>
        </div>

        {/* --- Chapter 3: The Proof --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.02 }}
          transition={{ duration: 0.8 }}
          className="relative mb-20"
        >
          <div className="text-center mb-16">
            <div
              id="suggestion-demo"
              className="inline-flex items-center gap-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full px-6 py-3 shadow-lg mb-6"
            >
              <Star className="w-6 h-6" />
              <span className="font-semibold">{dict.proof.header}</span>
            </div>
            <h3 className="text-3xl md:text-4xl font-bold text-gray-800 mb-6">
              {dict.proof.title_part1}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                {' '}
                {dict.proof.title_part2}
              </span>
            </h3>
            <p className="text-lg text-gray-700 max-w-4xl mx-auto leading-relaxed">
              {dict.proof.subtitle}
            </p>
          </div>

          <motion.div
            ref={demoRef}
            initial={{ opacity: 0, y: 30 }}
            animate={
              isDemoInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }
            }
            transition={{ duration: 0.8, delay: 0.2 }}
            className="flex flex-col lg:flex-row gap-8 lg:gap-12 justify-center items-center max-w-4xl mx-auto"
          >
            <div className="flex flex-col items-center w-full lg:w-auto">
              <h4 className="text-lg font-semibold text-gray-800 text-center px-4 py-2 bg-cyan-100 rounded-full mb-4">
                {dict.proof.demo_female}
              </h4>
              <div className="relative w-full max-w-xs mx-auto">
                <div className="absolute -inset-2 bg-gradient-to-r from-cyan-500/20 via-pink-500/20 to-cyan-500/20 rounded-3xl blur-xl" />
                <div className="relative">
                  <LiveSuggestionDemo
                    suggestion={demoData.demoSuggestionDataMale}
                    userId="visitor-user-id"
                    demoAiAnalysis={demoData.demoAiAnalysisForDaniel}
                    suggestionsDict={suggestionsDict}
                    profileCardDict={profileCardDict}
                    suggestionDemoDict={dict.suggestionDemo}
                    locale={locale} // <-- ✨ 3. העבר את locale לרכיב הבן
                  />
                </div>
              </div>
            </div>
            <div className="flex flex-col items-center w-full lg:w-auto">
              <h4 className="text-lg font-semibold text-gray-800 text-center px-4 py-2 bg-pink-100 rounded-full mb-4">
                {dict.proof.demo_male}
              </h4>
              <div className="relative w-full max-w-xs mx-auto">
                <div className="absolute -inset-2 bg-gradient-to-r from-pink-500/20 via-orange-500/20 to-pink-500/20 rounded-3xl blur-xl" />
                <div className="relative">
                  <LiveSuggestionDemo
                    suggestion={demoData.demoSuggestionDataFemale}
                    userId="visitor-user-id"
                    demoAiAnalysis={demoData.demoAiAnalysisForNoa}
                    suggestionsDict={suggestionsDict}
                    profileCardDict={profileCardDict}
                    suggestionDemoDict={dict.suggestionDemo}
                    locale={locale} // <-- ✨ 3. העבר את locale לרכיב הבן
                  />
                </div>
              </div>
            </div>
          </motion.div>
        </motion.div>

        {/* --- Key Benefits --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.2 }}
          transition={{ duration: 0.8 }}
          className="mb-20"
        >
          <h3 className="text-3xl font-bold text-center text-gray-800 mb-12">
            {dict.keyBenefits.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-pink-600">
              {' '}
              {dict.keyBenefits.title_part2}
            </span>
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-6xl mx-auto">
            {dict.keyBenefits.benefits.map((benefit, index) => (
              <KeyBenefit
                key={index}
                icon={benefitDetails[index].icon}
                title={benefit.title}
                description={benefit.description}
                color={benefitDetails[index].color}
                delay={0.1 * (index + 1)}
              />
            ))}
          </div>
        </motion.div>

        {/* --- Founder's Testimonial --- */}
        <div className="mb-20">
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.2 }}
            transition={{ duration: 0.8 }}
            className="text-center mb-16"
          >
            <div className="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-8 py-4 shadow-lg border border-white/60 mb-8">
              <Heart className="w-6 h-6 text-pink-500" />
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-pink-600 font-bold text-lg">
                {dict.testimonial.header}
              </span>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            whileInView={{ opacity: 1, scale: 1 }}
            viewport={{ once: true, amount: 0.2 }}
            transition={{ duration: 0.8, delay: 0.2 }}
            className="max-w-4xl mx-auto"
          >
            <div className="relative bg-white/95 backdrop-blur-xl rounded-3xl p-12 shadow-2xl border border-white/60">
              <div className="absolute -top-4 right-8 w-12 h-12 bg-gradient-to-br from-cyan-500 to-pink-500 rounded-full flex items-center justify-center shadow-lg">
                <Quote className="w-6 h-6 text-white" />
              </div>
              <div className="text-center mb-10">
                <p className="text-xl md:text-2xl text-gray-700 leading-relaxed mb-6 font-medium">
                  {dict.testimonial.quote}
                </p>
              </div>
              <div className="flex items-center justify-center gap-6 p-6 bg-gradient-to-r from-gray-50/80 to-white/80 rounded-2xl backdrop-blur-sm border border-gray-100">
                <div className="relative w-20 h-20 rounded-full overflow-hidden shadow-lg border-2 border-white">
                  <Image
                    src={getRelativeCloudinaryPath(
                      'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753700884/eitan_h9ylkc.jpg'
                    )}
                    alt={dict.testimonial.author_name}
                    fill
                    sizes="80px"
                    className="object-cover object-center"
                    priority
                  />
                </div>
                <div>
                  <div className="text-2xl font-bold text-gray-800">
                    {dict.testimonial.author_name}
                  </div>
                  <div className="text-lg text-cyan-600 font-semibold">
                    {dict.testimonial.author_role}
                  </div>
                </div>
              </div>
            </div>
          </motion.div>
        </div>

        {/* --- Final CTA --- */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, amount: 0.1 }}
          transition={{ duration: 0.8 }}
          className="relative text-center"
        >
          <div className="absolute inset-0 -m-8 bg-gradient-to-br from-cyan-600/10 via-pink-600/10 to-orange-600/10 rounded-3xl backdrop-blur-sm border border-white/40" />
          <div className="relative max-w-4xl mx-auto p-12">
            <h4 className="text-3xl md:text-4xl font-bold text-gray-800 mb-6 leading-tight">
              {dict.finalCta.title_line1}
              <br />
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-pink-600">
                {dict.finalCta.title_line2}
              </span>
            </h4>
            <p className="text-xl text-gray-600 mb-10 leading-relaxed max-w-3xl mx-auto">
              {dict.finalCta.subtitle_line1}
              <br />
              {dict.finalCta.subtitle_line2}
            </p>
            <div className="flex flex-col sm:flex-row gap-6 justify-center items-center">
              <Link href={`/${locale}/auth/register`}>
                <Button
                  size="lg"
                  className="bg-gradient-to-r from-cyan-500 to-pink-500 hover:from-cyan-600 hover:to-pink-600 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group relative overflow-hidden px-10 py-6 text-lg font-bold"
                >
                  <span className="relative z-10 flex items-center justify-center">
                    {dict.finalCta.button}
                    {locale === 'he' ? (
                      <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
                    ) : (
                      <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
                    )}{' '}
                  </span>
                </Button>
              </Link>
              <div className="flex items-center gap-3 text-gray-600">
                <CheckCircle className="w-5 h-5 text-green-500" />
                <span className="font-medium">{dict.finalCta.features}</span>
              </div>
            </div>
          </div>
        </motion.div>
      </div>
    </section>
  );
};

export default HowItWorksSection;
--- End of Content for HowItWorksSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\MatchmakerTeamSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/MatchmakerTeamSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import Link from 'next/link';
import type { MatchmakerTeamDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface MatchmakerTeamProps {
  dict: MatchmakerTeamDict;
}

// --- START: Re-integrated MatchmakerCard Component ---
// This component now receives all data dynamically
interface MatchmakerCardProps {
  name: string;
  role: string;
  description: string;
  tags: string[];
  color: string;
  imageSrc?: string;
  contactButtonText: string; // New prop for translated text
}

const MatchmakerCard: React.FC<MatchmakerCardProps> = ({
  name,
  role,
  description,
  tags,
  color,
  imageSrc,
  contactButtonText,
}) => {
  const getGradientByColor = () => {
    switch (color) {
      case 'cyan':
        return 'from-cyan-500 to-cyan-700';
      case 'green':
        return 'from-teal-500 to-teal-700';
      default:
        return 'from-cyan-500 to-cyan-700';
    }
  };

  const getButtonColorByColor = () => {
    switch (color) {
      case 'cyan':
        return 'bg-cyan-600 hover:bg-cyan-700';
      case 'green':
        return 'bg-teal-600 hover:bg-teal-700';
      default:
        return 'bg-cyan-600 hover:bg-cyan-700';
    }
  };

  const getTagColorByColor = () => {
    switch (color) {
      case 'cyan':
        return 'bg-cyan-100 text-cyan-800';
      case 'green':
        return 'bg-teal-100 text-teal-800';
      default:
        return 'bg-cyan-100 text-cyan-800';
    }
  };

  return (
    <div className="rounded-xl shadow-lg overflow-hidden bg-white border border-gray-100 flex flex-col h-full transition-all duration-300 hover:shadow-xl">
      <div className="p-8 flex flex-col items-center flex-grow">
        <motion.div
          className="w-48 h-48 mb-6 overflow-hidden rounded-full border-4 border-white shadow-md relative"
          whileHover={{ scale: 1.05 }}
          transition={{ duration: 0.3 }}
        >
          {imageSrc ? (
            <Image
              src={getRelativeCloudinaryPath(imageSrc)}
              alt={name}
              fill
              sizes="(max-width: 768px) 100vw, 192px"
              className="object-cover object-center"
              priority
            />
          ) : (
            <div
              className={`h-full w-full flex items-center justify-center bg-gradient-to-br ${getGradientByColor()}`}
            >
              <span className="text-white text-6xl font-bold opacity-30">
                {name.charAt(0)}
              </span>
            </div>
          )}
        </motion.div>

        <h3 className="text-2xl font-bold text-gray-800 mb-1 text-center">
          {name}
        </h3>
        <p
          className={`text-lg font-medium mb-4 text-transparent bg-clip-text bg-gradient-to-r ${getGradientByColor()} text-center`}
        >
          {role}
        </p>

        <motion.div
          className="flex flex-wrap gap-2 justify-center mb-5"
          initial="hidden"
          animate="visible"
          variants={{
            hidden: { opacity: 0 },
            visible: {
              opacity: 1,
              transition: { staggerChildren: 0.1, delayChildren: 0.3 },
            },
          }}
        >
          {tags.map((tag) => (
            <motion.span
              key={tag}
              className={`text-sm px-3 py-1 rounded-full ${getTagColorByColor()}`}
              variants={{
                hidden: { opacity: 0, scale: 0.8 },
                visible: {
                  opacity: 1,
                  scale: 1,
                  transition: { duration: 0.3 },
                },
              }}
            >
              {tag}
            </motion.span>
          ))}
        </motion.div>

        <p className="text-gray-600 mb-6 text-center leading-relaxed flex-grow">
          {description}
        </p>

        <div className="mt-auto">
          <Link href={`/contact?matchmaker=${encodeURIComponent(name)}`}>
            <motion.div
              className={`inline-block text-center px-8 py-3 rounded-lg text-white ${getButtonColorByColor()} transition-colors duration-300 font-medium cursor-pointer`}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              {`${contactButtonText} ${name.split(' ')[0]}`}
            </motion.div>
          </Link>
        </div>
      </div>
    </div>
  );
};
// --- END: Re-integrated MatchmakerCard Component ---

const MatchmakerTeamSection: React.FC<MatchmakerTeamProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.3, delayChildren: 0.2 },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const cardContainerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.2 },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, y: 50 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  return (
    <motion.section
      ref={ref}
      id="our-team"
      className="py-16 md:py-24 px-4 bg-gradient-to-b from-blue-50 to-white relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute top-0 left-0 w-64 h-64 bg-cyan-100/30 rounded-full blur-3xl"></div>
      <div className="absolute bottom-0 right-0 w-96 h-96 bg-blue-100/30 rounded-full blur-3xl"></div>

      <div className="max-w-6xl mx-auto relative">
        <motion.div className="text-center mb-16" variants={headerVariants}>
          <h2 className="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-teal-600">
              {' '}
              {dict.title_highlight}{' '}
            </span>
            {dict.title_part2}
          </h2>
          <div className="w-32 h-1 bg-gradient-to-r from-cyan-500 to-teal-500 mx-auto rounded-full mb-6" />
          <p className="text-lg text-gray-600 max-w-2xl mx-auto">
            {dict.subtitle}
          </p>
        </motion.div>

        <motion.div
          className="grid grid-cols-1 md:grid-cols-2 gap-10 md:gap-12 max-w-5xl mx-auto"
          variants={cardContainerVariants}
        >
          {dict.team.map((member) => (
            <motion.div key={member.name} variants={cardVariants}>
              <MatchmakerCard
                name={member.name}
                role={member.role}
                description={member.description}
                color={member.color}
                tags={member.tags}
                imageSrc={member.imageSrc}
                contactButtonText={dict.contact_button_text}
              />
            </motion.div>
          ))}
        </motion.div>
      </div>
    </motion.section>
  );
};

export default MatchmakerTeamSection;
--- End of Content for MatchmakerTeamSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\NeshmaInsightSectionB.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/NeshmaInsightSectionB.tsx

'use client';

import React, { useRef, useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { motion, useInView, AnimatePresence } from 'framer-motion';
import {
  Sparkles,
  Heart,
  Target,
  FileText,
  CheckCheck,
  Lightbulb,
  ArrowLeft,
  Zap,
  TrendingUp,
} from 'lucide-react';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import type { NeshmaInsightDict } from '@/types/dictionary';

// --- Type Definitions ---
interface Message {
  id: number;
  text: string;
  sender: 'friend' | 'user';
  timestamp: string;
  isEureka?: boolean;
}

interface NeshmaInsightProps {
  locale: 'he' | 'en';
  dict: NeshmaInsightDict;
}
// --- End: Type Definitions ---

export default function NeshmaInsightSectionB({
  locale,
  dict,
}: NeshmaInsightProps) {
  const ref = useRef(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const isInView = useInView(ref, { once: true, amount: 0.15 });
  const isHebrew = locale === 'he';
  const direction = isHebrew ? 'rtl' : 'ltr';

  // --- State Management ---
  const [messages, setMessages] = useState<Message[]>([]);
  const [isTyping, setIsTyping] = useState(false);
  const [showPhone, setShowPhone] = useState(false);
  const [showInsights, setShowInsights] = useState(false);
  const [showTransitionText, setShowTransitionText] = useState(false);
  const [showTransitionCTA, setShowTransitionCTA] = useState(false);
  const [showCTA, setShowCTA] = useState(false);
  const [progressStep, setProgressStep] = useState(0);
  const [showPostConversationTransition, setShowPostConversationTransition] =
    useState(false);

  // --- Memoized Data from Dictionary ---
  const conversation = useMemo(() => {
    const logic = [
      { typingDelay: 1200 },
      { typingDelay: 800 },
      { typingDelay: 1500 },
      { typingDelay: 1000 },
      { typingDelay: 2000 },
      { isEureka: true, typingDelay: 1800 },
      { typingDelay: 1000 },
      { typingDelay: 2500 },
      { typingDelay: 1000 },
      { typingDelay: 1800 },
      { typingDelay: 1200 },
    ];
    return dict.conversation.map((msg, index) => ({
      ...msg,
      ...logic[index],
    }));
  }, [dict.conversation]);

  const insightDetails = useMemo(
    () => [
      {
        icon: Heart,
        gradient: 'from-rose-400 to-pink-500',
        ...dict.insights.items[0],
      },
      {
        icon: Target,
        gradient: 'from-emerald-400 to-teal-500',
        ...dict.insights.items[1],
      },
      {
        icon: Zap,
        gradient: 'from-amber-400 to-orange-500',
        ...dict.insights.items[2],
      },
    ],
    [dict.insights.items]
  );

  // --- Animation Logic ---
  useEffect(() => {
    const playConversation = (index: number) => {
      if (index >= conversation.length) {
        setIsTyping(false);
        setTimeout(() => setShowTransitionText(true), 1000);
        setTimeout(() => setShowInsights(true), 2500);
        setTimeout(() => setShowTransitionCTA(true), 3500);
        setTimeout(() => setShowCTA(true), 7000);
        setTimeout(() => setShowPostConversationTransition(true), 8000);
        setProgressStep(5);
        return;
      }

      const currentMessage = conversation[index];

      if (index === 0) setProgressStep(1);
      if (index === 3) setProgressStep(2);
      if (index === 5) setProgressStep(3);
      if (index === 8) setProgressStep(4);

      setIsTyping(true);

      const baseTypingDuration =
        currentMessage.typingDelay ||
        Math.max(currentMessage.text.length * 40, 1000);
      const typingDuration = currentMessage.isEureka
        ? baseTypingDuration * 1.5
        : baseTypingDuration;

      setTimeout(() => {
        setIsTyping(false);
        const newMessage: Message = {
          id: Date.now() + index,
          text: currentMessage.text,
          sender: currentMessage.sender,
          isEureka: currentMessage.isEureka,
          timestamp: new Date().toLocaleTimeString(
            locale === 'he' ? 'he-IL' : 'en-US',
            {
              hour: '2-digit',
              minute: '2-digit',
            }
          ),
        };
        setMessages((prev) => [...prev, newMessage]);

        const pauseBeforeNext = currentMessage.isEureka ? 1200 : 600;
        setTimeout(() => playConversation(index + 1), pauseBeforeNext);
      }, typingDuration);
    };

    if (isInView && !showPhone) {
      setTimeout(() => setShowPhone(true), 500);
      setTimeout(() => playConversation(0), 1500);
    }
  }, [isInView, showPhone, conversation, locale]);

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({
        behavior: 'smooth',
        block: 'end',
      });
    }
  }, [messages]);

  // --- Animation Variants ---
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.15 } },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const phoneVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 30 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const messageVariants = {
    hidden: { opacity: 0, y: 15, scale: 0.98 },
    visible: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: { duration: 0.4, ease: [0.25, 1, 0.5, 1] },
    },
  };
  const typingVariants = {
    initial: { opacity: 0, scale: 0.8 },
    animate: { opacity: 1, scale: 1 },
    exit: { opacity: 0, scale: 0.8, transition: { duration: 0.1 } },
  };

  // --- Render ---
  return (
    <motion.section
      ref={ref}
      className="relative py-20 md:py-32 bg-gradient-to-br from-slate-50 via-purple-50/30 to-rose-50/40 overflow-hidden"
      dir={direction}
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      {/* Background Elements */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-20 left-10 w-72 h-72 bg-gradient-to-br from-purple-200/20 to-pink-200/10 rounded-full blur-3xl animate-float-slow"></div>
        <div
          className="absolute bottom-40 right-10 w-96 h-96 bg-gradient-to-br from-cyan-200/15 to-blue-200/10 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute top-1/2 left-1/3 w-64 h-64 bg-gradient-to-br from-rose-200/15 to-orange-200/10 rounded-full blur-3xl animate-float-slow"
          style={{ animationDelay: '4s' }}
        ></div>
      </div>

      <div className="container mx-auto px-4 max-w-6xl relative">
        {/* Header */}
        <motion.div className="flex justify-center mb-10" variants={fadeInUp}>
          <div className="inline-flex items-center gap-3 bg-white/90 backdrop-blur-md rounded-full px-8 py-4 shadow-lg border border-purple-100">
            <Sparkles className="w-6 h-6 text-purple-500" />
            <span className="text-purple-700 font-bold text-lg">
              {dict.badge}
            </span>
          </div>
        </motion.div>

        {/* Title */}
        <motion.div variants={fadeInUp} className="text-center mb-12">
          <h2 className="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-gray-800 leading-tight mb-6">
            {dict.title.part1}{' '}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 via-pink-500 to-rose-500">
              {dict.title.highlight}
            </span>
            {dict.title.part2}
          </h2>
          <p className="text-base sm:text-lg md:text-xl lg:text-2xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </motion.div>

        {/* Phone Animation */}
        <AnimatePresence>
          {showPhone && (
            <motion.div
              variants={phoneVariants}
              initial="hidden"
              animate="visible"
              className="max-w-md mx-auto mb-20"
            >
              <div className="relative group">
                <div className="absolute -inset-2 bg-gradient-to-r from-purple-400/20 via-pink-400/20 to-rose-400/20 rounded-[2.9rem] blur-xl"></div>
                <div className="relative bg-white/80 backdrop-blur-sm rounded-[2.5rem] p-1.5 border border-purple-100 shadow-2xl transition-transform duration-500 group-hover:-rotate-1">
                  <div className="bg-white rounded-[2rem] overflow-hidden">
                    {/* Phone Header */}
                    <div className="px-4 pt-6 pb-3 relative z-10 flex items-center gap-3 border-b border-purple-100/60">
                      <div className="relative">
                        <div className="relative w-10 h-10 rounded-full shadow-md overflow-hidden">
                          <Image
                            src={getRelativeCloudinaryPath(
                              'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753967649/IMG-20250731-WA0059_mqskdw.jpg'
                            )}
                            alt={dict.chatHeader.name}
                            fill
                            sizes="40px"
                            className="object-cover"
                          />
                        </div>
                        <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                      </div>
                      <div>
                        <h3 className="text-gray-800 font-bold text-sm">
                          {dict.chatHeader.name}
                        </h3>
                        <p className="text-gray-500 text-xs">
                          {dict.chatHeader.status}
                        </p>
                      </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="px-4 py-2 bg-purple-50/50 border-b border-purple-100/40">
                      <div className="flex items-center justify-between gap-1">
                        {dict.progressLabels.map((_, step) => (
                          <div
                            key={step}
                            className={`flex-1 h-1 rounded-full transition-all duration-500 ${progressStep > step ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gray-200'}`}
                          />
                        ))}
                      </div>
                    </div>

                    {/* Messages Area */}
                    <div
                      aria-live="polite"
                      className="h-[450px] md:h-[500px] overflow-y-auto p-4 bg-gradient-to-br from-purple-50/20 to-rose-50/20 touch-pan-y"
                      onTouchStart={(e) => e.stopPropagation()}
                      onTouchMove={(e) => e.stopPropagation()}
                      onTouchEnd={(e) => e.stopPropagation()}
                    >
                      <AnimatePresence>
                        {messages.map((message) => (
                          <motion.div
                            key={message.id}
                            layout
                            variants={messageVariants}
                            initial="hidden"
                            animate="visible"
                            className={`flex items-end gap-2 mb-4 ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                          >
                            <div
                              className={`flex flex-col max-w-[80%] ${message.sender === 'user' ? 'items-end' : 'items-start'}`}
                            >
                              <div
                                className={`relative z-10 rounded-2xl px-4 py-2.5 shadow-md flex items-center gap-2 ${message.sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-br-lg' : `bg-white text-gray-800 border border-gray-100 rounded-bl-lg ${message.isEureka ? 'border-amber-400/80 ring-4 ring-amber-400/10 animate-pulse-glow' : ''}`}`}
                              >
                                {message.isEureka && (
                                  <motion.div
                                    animate={{
                                      scale: [1, 1.2, 1],
                                      rotate: [0, 10, -10, 0],
                                    }}
                                    transition={{
                                      duration: 0.6,
                                      repeat: 2,
                                      repeatDelay: 0.3,
                                    }}
                                  >
                                    <Lightbulb className="w-5 h-5 text-amber-400 flex-shrink-0" />
                                  </motion.div>
                                )}
                                <p className="text-[15px] leading-relaxed">
                                  {message.text}
                                </p>
                              </div>
                              <div className="flex items-center gap-1.5 mt-1.5 px-1">
                                <span className="text-[11px] text-gray-400">
                                  {message.timestamp}
                                </span>
                                {message.sender === 'user' && (
                                  <CheckCheck className="w-3.5 h-3.5 text-blue-500" />
                                )}
                              </div>
                            </div>
                          </motion.div>
                        ))}
                      </AnimatePresence>
                      <AnimatePresence>
                        {isTyping && (
                          <motion.div
                            layout
                            {...typingVariants}
                            className="flex items-end gap-2 mb-4 justify-start"
                          >
                            <div className="flex items-center gap-1.5 p-3 rounded-2xl shadow-md bg-white/80 border border-gray-200 rounded-bl-lg">
                              {[0, 0.2, 0.4].map((delay) => (
                                <motion.div
                                  key={delay}
                                  className="w-1.5 h-1.5 bg-gray-400 rounded-full"
                                  animate={{ y: [0, -3, 0] }}
                                  transition={{
                                    duration: 0.9,
                                    repeat: Infinity,
                                    delay,
                                  }}
                                />
                              ))}
                            </div>
                          </motion.div>
                        )}
                      </AnimatePresence>
                      <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="border-t border-gray-200/80 bg-gray-50/50 p-3">
                      <div className="bg-gray-100 rounded-full px-4 py-2 text-gray-400 text-sm cursor-not-allowed text-center">
                        {dict.placeholder}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Transition Text */}
        <AnimatePresence>
          {showTransitionText && !showInsights && (
            <motion.div
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.9 }}
              className="text-center mb-12"
            >
              <div className="inline-block bg-gradient-to-r from-amber-100 to-orange-100 rounded-2xl px-8 py-4 shadow-lg border-2 border-amber-300">
                <p className="text-xl font-bold text-gray-800">
                  {dict.transitionText}
                </p>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Insights Section */}
        <AnimatePresence>
          {showInsights && (
            <motion.div
              initial={{ opacity: 0, y: 30 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.6 }}
              className="mb-20"
            >
              <h3 className="text-2xl sm:text-3xl md:text-4xl font-bold text-center text-gray-800 mb-12">
                {dict.insights.title}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                {insightDetails.map((item, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, y: 30 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    viewport={{ once: true }}
                    transition={{ duration: 0.6, delay: index * 0.15 }}
                    whileHover={{
                      y: -8,
                      scale: 1.02,
                      transition: { duration: 0.3 },
                    }}
                    className="group"
                  >
                    <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-8 shadow-lg border border-gray-100 hover:shadow-2xl hover:border-purple-200 transition-all duration-300 h-full relative overflow-hidden">
                      <div
                        className={`absolute inset-0 bg-gradient-to-br ${item.gradient} opacity-0 group-hover:opacity-10 transition-opacity duration-300`}
                      />
                      <div
                        className={`inline-flex p-4 rounded-2xl bg-gradient-to-br ${item.gradient} text-white mb-6 shadow-md group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 relative z-10`}
                      >
                        <item.icon className="w-8 h-8" />
                      </div>
                      <h4 className="text-xl font-bold text-gray-800 mb-4 relative z-10">
                        {item.title}
                      </h4>
                      <p className="text-gray-600 leading-relaxed relative z-10">
                        {item.description}
                      </p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Transition CTA */}
        <AnimatePresence>
          {showTransitionCTA && !showCTA && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.8 }}
              className="text-center mb-8"
            >
              <div className="inline-flex items-center gap-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-full px-6 py-3 shadow-md">
                <TrendingUp className="w-5 h-5 text-purple-600" />
                <p className="text-lg font-semibold text-gray-800">
                  {dict.transitionCTA}
                </p>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Final CTA */}
        <AnimatePresence>
          {showCTA && (
            <motion.div
              variants={fadeInUp}
              initial="hidden"
              animate="visible"
              exit={{ opacity: 0 }}
              className="text-center"
            >
              <Link href={`/${locale}/questionnaire`}>
                <motion.button
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.98 }}
                  className="group relative inline-flex items-center gap-4 bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 hover:from-purple-700 hover:via-pink-700 hover:to-rose-700 text-white font-bold py-5 px-12 md:px-16 rounded-full text-xl md:text-2xl shadow-2xl hover:shadow-3xl transition-all duration-300"
                >
                  <FileText className="w-7 h-7 group-hover:rotate-6 transition-transform" />
                  <span>{dict.cta.button}</span>
                  <ArrowLeft
                    className={`w-6 h-6 group-hover:${isHebrew ? '-translate-x-1' : 'translate-x-1'} transition-transform ${isHebrew ? '' : 'rotate-180'}`}
                  />
                  <div className="absolute inset-0 rounded-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:translate-x-full transition-transform duration-1000"></div>
                </motion.button>
              </Link>
              <motion.p
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.2 }}
                className="mt-6 text-gray-600 text-lg italic"
              >
                {dict.cta.subtitle}
              </motion.p>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Post-Conversation Transition */}
        <AnimatePresence>
          {showPostConversationTransition && (
            <motion.div
              className="text-center max-w-3xl mx-auto mt-16 md:mt-24 px-4"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8, ease: 'easeOut' }}
            >
              <h3 className="text-2xl md:text-3xl font-bold text-gray-800 leading-tight">
                {dict.postConversationTransition.line1}
                <br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                  {dict.postConversationTransition.line2}
                </span>
              </h3>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Styles */}
      <style>{`
        @keyframes float-slow { 0%, 100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-20px) translateX(10px); } 50% { transform: translateY(0) translateX(20px); } 75% { transform: translateY(20px) translateX(10px); } }
        .animate-float-slow { animation: float-slow 20s ease-in-out infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(251, 191, 36, 0.3); } 50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); } }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
      `}</style>
    </motion.section>
  );
}
--- End of Content for NeshmaInsightSectionB.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\OurMethodSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/OurMethodSection.tsx
'use client';

import React, {
  useState,
  useRef,
  useEffect,
  useCallback,
  useMemo,
} from 'react';
import { motion, useInView, AnimatePresence, PanInfo } from 'framer-motion';
import { Button } from '@/components/ui/button';

import {
  Heart,
  User,
  Users,
  Scroll,
  UserCheck,
  Sparkles,
  ArrowRight,
  CheckCircle,
  Pause,
  Play,
} from 'lucide-react';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import { usePathname } from 'next/navigation';
import type { OurMethodDict, WorldDict } from '@/types/dictionary';

interface OurMethodProps {
  dict: OurMethodDict;
}

interface WorldData extends WorldDict {
  id: number;
  icon: React.ReactNode;
  color: string;
  gradientFrom: string;
  gradientTo: string;
  angle: number;
}
// --- END: Type Definitions ---

const MatchingConstellation: React.FC<{
  dict: OurMethodDict['constellation'];
  locale: string;
}> = ({ dict, locale }) => {
  const [hoveredWorld, setHoveredWorld] = useState<number | null>(null);
  const [selectedWorld, setSelectedWorld] = useState<number>(1);
  const [isAutoPlaying, setIsAutoPlaying] = useState<boolean>(true);
  const [rotationOffset, setRotationOffset] = useState<number>(0);
  const [isDragging, setIsDragging] = useState<boolean>(false);
  const [isMobile, setIsMobile] = useState<boolean>(false);

  const panStartRotation = useRef(0);
  const sectionRef = useRef(null);
  const constellationRef = useRef<HTMLDivElement>(null);
  const isInView = useInView(sectionRef, { once: true, amount: 0.02 });

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  const worlds: WorldData[] = useMemo(
    () => [
      {
        id: 1,
        icon: <User className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[0],
        color: 'from-sky-400 to-blue-500',
        gradientFrom: '#38bdf8',
        gradientTo: '#3b82f6',
        angle: -72,
      },
      {
        id: 2,
        icon: <Heart className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[1],
        color: 'from-rose-400 to-pink-500',
        gradientFrom: '#fb7185',
        gradientTo: '#ec4899',
        angle: -144,
      },
      {
        id: 3,
        icon: <Users className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[2],
        color: 'from-emerald-400 to-teal-500',
        gradientFrom: '#34d399',
        gradientTo: '#14b8a6',
        angle: 144,
      },
      {
        id: 4,
        icon: <UserCheck className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[3],
        color: 'from-violet-400 to-purple-500',
        gradientFrom: '#a78bfa',
        gradientTo: '#8b5cf6',
        angle: 72,
      },
      {
        id: 5,
        icon: <Scroll className="w-6 h-6 md:w-8 md:h-8" />,
        ...dict.worlds[4],
        color: 'from-amber-400 to-orange-500',
        gradientFrom: '#fbbf24',
        gradientTo: '#f97316',
        angle: 0,
      },
    ],
    [dict.worlds]
  );

  useEffect(() => {
    if (!isAutoPlaying || isDragging) return;
    const interval = setInterval(() => {
      setSelectedWorld((prev) => (prev ? (prev % worlds.length) + 1 : 1));
    }, 4000);
    return () => clearInterval(interval);
  }, [isAutoPlaying, isDragging, worlds.length]);

  useEffect(() => {
    const targetWorld = worlds.find((w) => w.id === selectedWorld);
    if (targetWorld) {
      setRotationOffset(-targetWorld.angle);
    }
  }, [selectedWorld, worlds]);

  const getDimensions = () => {
    if (isMobile) {
      return {
        size: 350,
        center: 175,
        radius: 120,
        iconSize: 50,
        coreRadius: 20,
      };
    }
    return {
      size: 500,
      center: 250,
      radius: 170,
      iconSize: 70,
      coreRadius: 28,
    };
  };

  const dimensions = getDimensions();

  interface ConstellationLine {
    id: string;
    x1: number;
    y1: number;
    x2: number;
    y2: number;
    opacity: number;
  }

  const generateConstellationLines = (): ConstellationLine[] => {
    const lines: ConstellationLine[] = [];
    const { center, radius } = dimensions;

    worlds.forEach((world, index) => {
      const nextIndex = (index + 1) % worlds.length;
      const nextWorld = worlds[nextIndex];
      const currentAngle = world.angle + rotationOffset;
      const nextAngle = nextWorld.angle + rotationOffset;

      const x1 = center + Math.cos((currentAngle * Math.PI) / 180) * radius;
      const y1 = center + Math.sin((currentAngle * Math.PI) / 180) * radius;
      const x2 = center + Math.cos((nextAngle * Math.PI) / 180) * radius;
      const y2 = center + Math.sin((nextAngle * Math.PI) / 180) * radius;

      lines.push({ id: `line-${index}`, x1, y1, x2, y2, opacity: 0.4 });
    });
    return lines;
  };

  const handleWorldInteraction = (worldId: number) => {
    setIsAutoPlaying(false);
    setSelectedWorld(worldId);
    setHoveredWorld(null);

    setTimeout(() => {
      const infoPanel = document.querySelector('[data-world-info-panel]');
      if (infoPanel) {
        infoPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  };

  const handlePanStart = useCallback(() => {
    setIsAutoPlaying(false);
    setIsDragging(true);
    panStartRotation.current = rotationOffset;
  }, [rotationOffset]);

  const handlePan = useCallback(
    (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
      const sensitivity = 0.5;
      setRotationOffset(panStartRotation.current + info.offset.x * sensitivity);
    },
    []
  );

  const handlePanEnd = useCallback(
    (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
      setIsDragging(false);
      const swipePower = Math.abs(info.velocity.x);
      const swipeDistance = Math.abs(info.offset.x);
      const flickThreshold = 200;

      const currentWorldIndex =
        worlds.findIndex((w) => w.id === selectedWorld) ?? 0;
      let nextWorldIndex = currentWorldIndex;

      if (swipePower > flickThreshold || swipeDistance > dimensions.size / 4) {
        if (info.offset.x < 0) {
          nextWorldIndex = (currentWorldIndex + 1) % worlds.length;
        } else {
          nextWorldIndex =
            (currentWorldIndex - 1 + worlds.length) % worlds.length;
        }
      }
      setSelectedWorld(worlds[nextWorldIndex].id);
    },
    [selectedWorld, worlds, dimensions.size]
  );

  const activeWorld = hoveredWorld || selectedWorld;
  const displayedWorld = worlds.find((w) => w.id === activeWorld) || worlds[0];

  return (
    <div
      ref={sectionRef}
      className="relative w-full max-w-7xl mx-auto py-8 md:py-16"
    >
      <motion.div
        initial={{ opacity: 0, y: 30 }}
        animate={isInView ? { opacity: 1, y: 0 } : {}}
        transition={{ duration: 0.8 }}
        className="text-center mb-8 md:mb-16 px-4"
      >
        <div className="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm rounded-full px-6 md:px-8 py-3 md:py-4 shadow-md border border-gray-200 mb-6 md:mb-8">
          <Heart className="w-5 h-5 md:w-6 md:h-6 text-rose-500" />
          <span className="text-gray-700 font-medium text-base md:text-lg">
            {dict.header}
          </span>
        </div>
        <h3 className="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-800 mb-4 md:mb-6 leading-tight px-4">
          {dict.title_part1}
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-violet-600">
            {' '}
            {dict.title_part2}{' '}
          </span>
        </h3>
        <p className="text-lg md:text-xl text-gray-600 max-w-4xl mx-auto leading-relaxed px-4">
          {dict.subtitle}
        </p>
      </motion.div>

      <div className="flex flex-col xl:flex-row items-center gap-8 md:gap-16">
        <motion.div
          ref={constellationRef}
          initial={{ opacity: 0, scale: 0.9 }}
          animate={isInView ? { opacity: 1, scale: 1 } : {}}
          transition={{ duration: 1, delay: 0.3 }}
          className="relative flex-1 min-w-0 w-full touch-none cursor-grab active:cursor-grabbing"
          style={{
            width: dimensions.size,
            height: dimensions.size,
            maxWidth: '100vw',
            margin: '0 auto',
          }}
          drag={isMobile ? 'x' : false}
          dragConstraints={{ left: 0, right: 0 }}
          dragElastic={0.1}
          onPanStart={handlePanStart}
          onPan={handlePan}
          onPanEnd={handlePanEnd}
        >
          <div
            className="relative mx-auto flex items-center justify-center"
            style={{
              width: dimensions.size,
              height: dimensions.size,
            }}
          >
            <div className="absolute inset-0 bg-gradient-to-br from-rose-50/80 via-amber-50/60 to-sky-50/80 rounded-full blur-3xl" />
            <svg
              viewBox={`0 0 ${dimensions.size} ${dimensions.size}`}
              className="absolute inset-0 w-full h-full pointer-events-none"
            >
              {generateConstellationLines().map((line) => (
                <motion.line
                  key={line.id}
                  x1={line.x1}
                  y1={line.y1}
                  x2={line.x2}
                  y2={line.y2}
                  stroke="url(#lineGradient)"
                  strokeWidth={isMobile ? '1.5' : '2'}
                  opacity={isDragging ? 0.6 : line.opacity}
                  className="transition-opacity duration-300"
                  animate={{
                    x1: line.x1,
                    y1: line.y1,
                    x2: line.x2,
                    y2: line.y2,
                  }}
                  transition={{
                    type: 'spring',
                    stiffness: 100,
                    damping: 20,
                  }}
                />
              ))}

              <defs>
                <linearGradient
                  id="lineGradient"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  <stop offset="0%" stopColor="#f43f5e" stopOpacity="0.4" />
                  <stop offset="50%" stopColor="#8b5cf6" stopOpacity="0.5" />
                  <stop offset="100%" stopColor="#06b6d4" stopOpacity="0.4" />
                </linearGradient>
                <radialGradient id="coreGradient">
                  <stop offset="0%" stopColor="#ffffff" stopOpacity="1" />
                  <stop offset="50%" stopColor="#f8fafc" stopOpacity="0.98" />
                  <stop offset="80%" stopColor="#f1f5f9" stopOpacity="0.95" />
                  <stop offset="100%" stopColor="#e2e8f0" stopOpacity="0.9" />
                </radialGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2" result="coloredBlur" />
                  <feMerge>
                    <feMergeNode in="coloredBlur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
                {worlds.map((world) => (
                  <radialGradient
                    key={`gradient-${world.id}`}
                    id={`worldGradient-${world.id}`}
                  >
                    <stop
                      offset="0%"
                      stopColor={world.gradientFrom}
                      stopOpacity="0.95"
                    />
                    <stop
                      offset="100%"
                      stopColor={world.gradientTo}
                      stopOpacity="0.85"
                    />
                  </radialGradient>
                ))}
              </defs>

              <motion.circle
                cx={dimensions.center}
                cy={dimensions.center}
                r={dimensions.coreRadius}
                fill="url(#coreGradient)"
                filter="url(#glow)"
                className="drop-shadow-xl"
                animate={{
                  scale: activeWorld ? 1.15 : isDragging ? 1.05 : 1,
                  filter: isDragging
                    ? 'url(#glow) brightness(1.1)'
                    : 'url(#glow)',
                }}
                transition={{ duration: 0.3, type: 'spring', stiffness: 300 }}
              />
              <foreignObject
                x={dimensions.center - (isMobile ? 18 : 24)}
                y={dimensions.center - (isMobile ? 18 : 24)}
                width={isMobile ? 36 : 48}
                height={isMobile ? 36 : 48}
              >
                <div className="flex items-center justify-center w-full h-full">
                  <motion.div
                    className="relative w-full h-full flex items-center justify-center"
                    animate={{
                      rotate: isDragging ? 360 : 0,
                      scale: isDragging ? 1.1 : activeWorld ? 1.05 : 1,
                    }}
                    transition={{
                      rotate: {
                        duration: isDragging ? 3 : 0,
                        repeat: isDragging ? Infinity : 0,
                        ease: 'linear',
                      },
                      scale: { duration: 0.3, type: 'spring', stiffness: 300 },
                    }}
                  >
                    <div
                      className={`relative ${isMobile ? 'w-7 h-7' : 'w-9 h-9'}`}
                    >
                      <Image
                        src={getRelativeCloudinaryPath(
                          'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png'
                        )}
                        alt="NeshamaTech"
                        fill
                        className="object-contain transition-all duration-300"
                        sizes={isMobile ? '28px' : '36px'}
                      />
                    </div>
                    {(activeWorld || isDragging) && (
                      <motion.div
                        className="absolute inset-0 rounded-full"
                        animate={{
                          boxShadow: [
                            '0 0 0 0 rgba(139, 92, 246, 0)',
                            '0 0 0 4px rgba(139, 92, 246, 0.1)',
                            '0 0 0 0 rgba(139, 92, 246, 0)',
                          ],
                        }}
                        transition={{
                          duration: 2,
                          repeat: Infinity,
                          ease: 'easeInOut',
                        }}
                      />
                    )}
                  </motion.div>
                </div>
              </foreignObject>
            </svg>

            {worlds.map((world, index) => {
              const currentAngle = world.angle + rotationOffset;
              const x =
                dimensions.center +
                Math.cos((currentAngle * Math.PI) / 180) * dimensions.radius;
              const y =
                dimensions.center +
                Math.sin((currentAngle * Math.PI) / 180) * dimensions.radius;
              const isActive = activeWorld === world.id;

              return (
                <motion.div
                  key={world.id}
                  className="absolute cursor-pointer group select-none flex flex-col items-center gap-2 md:gap-4"
                  style={{
                    width: dimensions.iconSize * 2.5,
                    transform: 'translate3d(0, 0, 0)',
                  }}
                  initial={{ opacity: 0, scale: 0 }}
                  animate={{
                    opacity: isInView ? 1 : 0,
                    scale: isInView ? 1 : 0,
                    left: x - (dimensions.iconSize * 2.5) / 2,
                    top: y - dimensions.iconSize / 2,
                  }}
                  transition={{
                    type: 'spring',
                    stiffness: 100,
                    damping: 20,
                    delay: 0.7 + index * 0.1,
                  }}
                  onMouseEnter={() => !isMobile && setHoveredWorld(world.id)}
                  onMouseLeave={() => !isMobile && setHoveredWorld(null)}
                  onClick={() =>
                    !isDragging && handleWorldInteraction(world.id)
                  }
                  whileHover={!isMobile ? { scale: 1.05 } : {}}
                  whileTap={{ scale: 0.95 }}
                >
                  <motion.div
                    className={`rounded-full bg-gradient-to-br ${world.color} flex items-center justify-center text-white shadow-xl relative overflow-hidden transition-all duration-300 ${isActive ? 'ring-2 md:ring-4 ring-white/60' : ''} ${isDragging ? 'shadow-2xl' : ''}`}
                    style={{
                      width: dimensions.iconSize,
                      height: dimensions.iconSize,
                      flexShrink: 0,
                    }}
                    animate={{
                      scale: isDragging ? 1.05 : 1,
                    }}
                    transition={{ duration: 0.2 }}
                  >
                    <motion.div
                      className={`absolute inset-0 bg-gradient-to-br ${world.color} rounded-full blur-md`}
                      animate={{
                        scale: isActive ? 1.8 : isDragging ? 1.3 : 1,
                        opacity: isActive ? 0.5 : isDragging ? 0.3 : 0,
                      }}
                      transition={{ duration: 0.3 }}
                    />
                    <motion.div
                      className="relative z-10 transform transition-transform duration-300 group-hover:scale-110"
                      animate={{ rotate: isDragging ? [0, 5, -5, 0] : 0 }}
                      transition={{
                        rotate: {
                          duration: 0.6,
                          repeat: isDragging ? Infinity : 0,
                        },
                      }}
                    >
                      {world.icon}
                    </motion.div>
                    {isActive && (
                      <>
                        <motion.div
                          className="absolute inset-0 border-2 border-white/70 rounded-full"
                          animate={{ scale: [1, 2.5], opacity: [0.8, 0] }}
                          transition={{
                            duration: 2.8,
                            repeat: Infinity,
                            ease: 'easeOut',
                          }}
                        />
                        <motion.div
                          className="absolute inset-0 border-2 border-white/50 rounded-full"
                          animate={{ scale: [1, 2.5], opacity: [0.6, 0] }}
                          transition={{
                            duration: 2.8,
                            repeat: Infinity,
                            ease: 'easeOut',
                            delay: 1,
                          }}
                        />
                      </>
                    )}
                  </motion.div>

                  <motion.div
                    className="whitespace-nowrap text-center"
                    animate={{ scale: isActive ? 1.05 : 1 }}
                    transition={{ scale: { duration: 0.2 } }}
                  >
                    <motion.span
                      className={`font-medium px-2 md:px-3 py-1 rounded-full transition-all duration-300 text-sm ${isActive ? 'bg-white text-gray-800 shadow-lg border border-gray-200' : 'text-gray-600 hover:text-gray-800'}`}
                      animate={{
                        backgroundColor: isActive ? '#ffffff' : 'transparent',
                        boxShadow: isActive
                          ? '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                          : '0 0 0 0 transparent',
                      }}
                    >
                      {world.title}
                    </motion.span>
                  </motion.div>
                </motion.div>
              );
            })}
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, x: 30 }}
          animate={isInView ? { opacity: 1, x: 0 } : {}}
          transition={{ duration: 0.8, delay: 0.6 }}
          className="flex-1 max-w-2xl w-full px-4"
          data-world-info-panel
        >
          <AnimatePresence mode="wait">
            <motion.div
              key={displayedWorld.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              transition={{ duration: 0.4 }}
              className="bg-white/95 backdrop-blur-xl rounded-3xl p-6 md:p-10 shadow-2xl border border-white/60 relative overflow-hidden"
            >
              <div
                className={`absolute inset-0 bg-gradient-to-br ${displayedWorld.color} opacity-5 rounded-3xl`}
              />
              <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/30 to-transparent rounded-full transform translate-x-16 -translate-y-16" />
              <div className="relative z-10">
                <div className="flex items-start gap-4 md:gap-6 mb-6 md:mb-8">
                  <div
                    className={`p-3 md:p-4 rounded-2xl bg-gradient-to-br ${displayedWorld.color} text-white shadow-lg flex-shrink-0`}
                  >
                    {displayedWorld.icon}
                  </div>
                  <div className="flex-1">
                    <div className="flex justify-between items-start">
                      <h4 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
                        {displayedWorld.title}
                      </h4>
                      <Button
                        onClick={() => setIsAutoPlaying((prev) => !prev)}
                        variant="outline"
                        size="icon"
                        className="bg-white/50 hover:bg-white text-gray-500 hover:text-gray-800 border-gray-200 hover:border-gray-300 rounded-full w-10 h-10 -mr-2 -mt-1 flex-shrink-0 shadow-sm hover:shadow-md transition-all duration-300"
                        aria-label={
                          isAutoPlaying ? 'Pause animation' : 'Play animation'
                        }
                      >
                        <AnimatePresence mode="wait">
                          {isAutoPlaying ? (
                            <motion.div
                              key="pause"
                              initial={{ scale: 0.5, opacity: 0 }}
                              animate={{ scale: 1, opacity: 1 }}
                              exit={{ scale: 0.5, opacity: 0 }}
                            >
                              <Pause className="w-5 h-5" />
                            </motion.div>
                          ) : (
                            <motion.div
                              key="play"
                              initial={{ scale: 0.5, opacity: 0 }}
                              animate={{ scale: 1, opacity: 1 }}
                              exit={{ scale: 0.5, opacity: 0 }}
                            >
                              <Play className="w-5 h-5" />
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </Button>
                    </div>
                    <p className="text-base md:text-lg text-gray-600 font-medium">
                      {displayedWorld.shortDesc}
                    </p>
                  </div>
                </div>
                <p className="text-gray-700 leading-relaxed text-base md:text-lg mb-6 md:mb-8">
                  {displayedWorld.fullDescription}
                </p>
                <div className="bg-gradient-to-r from-gray-50 to-white rounded-2xl p-4 md:p-6 mb-4 md:mb-6 border border-gray-100">
                  <div className="flex items-start gap-3">
                    <div className="w-2 h-2 rounded-full bg-gradient-to-r from-gray-400 to-gray-500 mt-3 flex-shrink-0"></div>
                    <div>
                      <h5 className="font-semibold text-gray-800 mb-2">
                        {dict.example_header}
                      </h5>

                      <p className="text-gray-600 italic text-sm md:text-base">
                        &quot;{displayedWorld.personalExample}&quot;
                      </p>
                    </div>
                  </div>
                </div>
                <div className="bg-gradient-to-r from-violet-50 to-rose-50 rounded-2xl p-4 md:p-6 border border-violet-100">
                  <div className="flex items-start gap-3">
                    <CheckCircle className="w-5 h-5 text-violet-600 mt-1 flex-shrink-0" />
                    <div>
                      <h5 className="font-semibold text-violet-800 mb-2">
                        {dict.insight_header}
                      </h5>

                      <p className="text-violet-700 text-sm md:text-base">
                        {displayedWorld.insight}
                      </p>
                    </div>
                  </div>
                </div>
                <div className="mt-6 md:mt-8 flex items-center gap-2">
                  <span className="text-sm text-gray-500 ml-3">
                    {dict.dimension_prefix} {displayedWorld.id}{' '}
                    {dict.dimension_suffix} {worlds.length}
                  </span>
                  {worlds.map((world) => (
                    <button
                      key={world.id}
                      onClick={() => handleWorldInteraction(world.id)}
                      className={`h-2 rounded-full transition-all duration-300 ${world.id === displayedWorld.id ? `bg-gradient-to-r ${displayedWorld.color} flex-1 min-w-[40px] md:min-w-[60px]` : 'bg-gray-200 w-4 md:w-6 hover:bg-gray-300'}`}
                      aria-label={`Select ${world.title}`}
                    />
                  ))}
                </div>
              </div>
            </motion.div>
          </AnimatePresence>
        </motion.div>
      </div>

    </div>
  );
};

const OurMethodSection: React.FC<OurMethodProps> = ({ dict }) => {
  const sectionRef = useRef(null);
  const isInView = useInView(sectionRef, { once: true, amount: 0.02 });
  const pathname = usePathname();
  const locale = (pathname.split('/')[1] as 'he' | 'en') || 'he';

  return (
    <motion.section
      ref={sectionRef}
      id="our-method"
      className="relative pt-0 pb-12 md:pb-20 lg:pb-28 px-4 bg-gradient-to-b from-white via-rose-50/30 to-white overflow-hidden"
      initial={{ opacity: 0 }}
      animate={isInView ? { opacity: 1 } : { opacity: 0 }}
      transition={{ duration: 1 }}
    >
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-20 left-10 w-32 md:w-40 h-32 md:h-40 bg-gradient-to-br from-rose-200/30 to-pink-300/20 rounded-full blur-3xl animate-soft-float" />
        <div
          className="absolute top-60 right-20 w-24 md:w-32 h-24 md:h-32 bg-gradient-to-br from-violet-200/30 to-purple-300/20 rounded-full blur-2xl animate-soft-float"
          style={{ animationDelay: '2s' }}
        />
        <div
          className="absolute bottom-40 left-1/3 w-36 md:w-48 h-36 md:h-48 bg-gradient-to-br from-sky-200/20 to-cyan-300/15 rounded-full blur-3xl animate-soft-float"
          style={{ animationDelay: '4s' }}
        />
        <div
          className="absolute bottom-20 right-10 w-28 md:w-36 h-28 md:h-36 bg-gradient-to-br from-emerald-200/25 to-teal-300/20 rounded-full blur-2xl animate-soft-float"
          style={{ animationDelay: '1s' }}
        />
        <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#8b5cf6_1px,transparent_1px)] [background-size:30px_30px]"></div>
        <svg
          className="absolute inset-0 w-full h-full"
          viewBox="0 0 1200 800"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <linearGradient
              id="decorativeGradient"
              x1="0%"
              y1="0%"
              x2="100%"
              y2="100%"
            >
              <stop offset="0%" stopColor="#f43f5e" stopOpacity="0.08" />
              <stop offset="50%" stopColor="#8b5cf6" stopOpacity="0.06" />
              <stop offset="100%" stopColor="#06b6d4" stopOpacity="0.08" />
            </linearGradient>
          </defs>
          <path
            d="M0,100 C300,50 600,150 1200,100 L1200,0 L0,0 Z"
            fill="url(#decorativeGradient)"
            className="animate-gentle-pulse"
          />
          <path
            d="M0,700 C400,650 800,750 1200,700 L1200,800 L0,800 Z"
            fill="url(#decorativeGradient)"
            className="animate-gentle-pulse"
            style={{ animationDelay: '2s' }}
          />
        </svg>
      </div>

      <div className="relative max-w-8xl mx-auto">
        <MatchingConstellation dict={dict.constellation} locale={locale} />
      </div>

      <style>{`
        @keyframes gentle-pulse {
          0%,
          100% {
            opacity: 0.8;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.02);
          }
        }
        @keyframes soft-float {
          0%,
          100% {
            transform: translateY(0px) rotate(0deg);
          }
          25% {
            transform: translateY(-3px) rotate(0.5deg);
          }
          75% {
            transform: translateY(3px) rotate(-0.5deg);
          }
        }
        .animate-gentle-pulse {
          animation: gentle-pulse 4s ease-in-out infinite;
        }
        .animate-soft-float {
          animation: soft-float 6s ease-in-out infinite;
        }
      `}</style>
    </motion.section>
  );
};

export default OurMethodSection;
--- End of Content for OurMethodSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\PrivacyAssuranceSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/PrivacyAssuranceSection.tsx
'use client';

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { CheckCircle, Lock } from 'lucide-react';
import type { PrivacyAssuranceDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface PrivacyAssuranceProps {
  dict: PrivacyAssuranceDict;
    locale: 'he' | 'en';

}

const PrivacyAssuranceSection: React.FC<PrivacyAssuranceProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.3,
        delayChildren: 0.2,
      },
    },
  };

  const fadeInLeft = {
    hidden: { opacity: 0, x: -60 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };

  const fadeInRight = {
    hidden: { opacity: 0, x: 60 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };

  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.4,
      },
    },
  };

  const listItemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.5, ease: 'easeOut' },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.9, y: 30 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      className="py-16 md:py-20 px-4 bg-gradient-to-br from-gray-800 to-gray-900 text-white relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxIiBmaWxsPSIjZmZmZmZmIi8+PC9zdmc+')]"></div>

      <div className="absolute top-0 left-0 w-40 h-40 bg-cyan-500/10 rounded-full blur-3xl"></div>
      <div className="absolute bottom-0 right-0 w-60 h-60 bg-cyan-500/10 rounded-full blur-3xl"></div>

      <div className="max-w-5xl mx-auto relative">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
          {/* Left Content */}
          <motion.div variants={fadeInLeft}>
            <div className="mb-8 text-center md:text-right">
              <h2 className="text-2xl sm:text-3xl md:text-4xl font-bold mb-4">
                {dict.title}
              </h2>
              <div className="w-24 h-1 bg-cyan-500/50 rounded-full mb-6 mx-auto md:mr-0"></div>
              <p className="text-lg text-white/80 mb-6 mx-auto md:mx-0 max-w-md">
                {dict.subtitle}
              </p>
            </div>

            <motion.div className="space-y-4" variants={staggeredListVariants}>
              {dict.features.map((feature, index) => (
                <motion.div
                  key={index}
                  className="flex items-start"
                  variants={listItemVariants}
                  whileHover={{ x: 4 }}
                  transition={{ duration: 0.2 }}
                >
                  <div className="bg-cyan-500/20 rounded-full p-2 mr-3 mt-1 flex-shrink-0">
                    <CheckCircle className="w-4 h-4 text-cyan-400" />
                  </div>
                  <p className="text-white/90">{feature}</p>
                </motion.div>
              ))}
            </motion.div>
          </motion.div>

          {/* Right Card */}
          <motion.div className="flex justify-center" variants={fadeInRight}>
            <div className="relative max-w-sm w-full">
              <div className="absolute inset-0 bg-white/10 rounded-2xl blur-lg transform rotate-6"></div>

              <motion.div
                className="relative bg-white/10 backdrop-blur-sm p-8 rounded-2xl border border-white/20"
                variants={cardVariants}
                whileHover={{
                  scale: 1.02,
                  transition: { duration: 0.2 },
                }}
              >
                <motion.div
                  className="w-16 h-16 mx-auto mb-6 bg-cyan-500/30 rounded-full flex items-center justify-center border border-cyan-400/50"
                  whileHover={{
                    rotate: [0, -10, 10, 0],
                    transition: { duration: 0.6 },
                  }}
                >
                  <Lock className="w-8 h-8 text-cyan-300" />
                </motion.div>

                <h3 className="text-xl font-bold mb-4 text-center text-white">
                  {dict.card_title}
                </h3>

                <p className="text-white/80 text-center mb-6">
                  {dict.card_text}
                </p>

                <div className="text-center">
                  <Link href="/legal/privacy-policy">
                    <motion.div
                      whileHover={{ scale: 1.05 }}
                      whileTap={{ scale: 0.95 }}
                    >
                      <Button
                        variant="outline"
                        className="border-2 border-cyan-400/50 bg-cyan-500/20 text-white hover:bg-cyan-500/30 transition-all duration-300 rounded-xl"
                      >
                        {dict.card_button}
                      </Button>
                    </motion.div>
                  </Link>
                </div>
              </motion.div>
            </div>
          </motion.div>
        </div>
      </div>
    </motion.section>
  );
};

export default PrivacyAssuranceSection;
--- End of Content for PrivacyAssuranceSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\SuccessStoriesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/SuccessStoriesSection.tsx
'use client';

import React, { useRef, useState } from 'react';
import { motion, useInView, AnimatePresence } from 'framer-motion';
import TestimonialCard from '../components/TestimonialCard';
import { Button } from '@/components/ui/button';
import { ArrowLeft , ArrowRight} from 'lucide-react';
import type { SuccessStoriesDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface SuccessStoriesProps {
  dict: SuccessStoriesDict;
  locale: 'he' | 'en';
}

const SuccessStoriesSection: React.FC<SuccessStoriesProps> = ({
  dict,
  locale,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.01 });

  const [showComingSoon, setShowComingSoon] = useState(false);

  const handleMoreStoriesClick = () => {
    setShowComingSoon(true);
    setTimeout(() => {
      setShowComingSoon(false);
    }, 3500);
  };

  // Animation variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.2,
        delayChildren: 0.3,
      },
    },
  };

  const headerVariants = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const cardVariants = {
    hidden: { opacity: 0, scale: 0.8, y: 40 },
    visible: {
      opacity: 1,
      scale: 1,
      y: 0,
      transition: {
        duration: 0.6,
        ease: 'easeOut',
        scale: {
          type: 'spring',
          stiffness: 260,
          damping: 20,
        },
      },
    },
  };

  return (
    <motion.section
      ref={ref}
      id="success-stories"
      className="pt-16 md:pt-20 px-4 bg-white relative"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 opacity-5 bg-[radial-gradient(#0891b2_1px,transparent_1px)] [background-size:20px_20px]"></div>

      <div className="max-w-6xl mx-auto relative">
        <motion.div
          className="text-center mb-12 md:mb-16"
          variants={headerVariants}
        >
          <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-800 mb-4">
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-teal-600">
              {' '}
              {dict.title_highlight}
            </span>
          </h2>
          <div className="w-24 h-1 bg-gradient-to-r from-cyan-600 to-teal-600 mx-auto rounded-full mb-6" />
          <motion.p
            className="text-lg text-gray-600 max-w-3xl mx-auto"
            variants={headerVariants}
          >
            {dict.subtitle}
          </motion.p>
        </motion.div>

        <motion.div
          className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto"
          variants={containerVariants}
        >
          {dict.stories.map((testimonial) => (
            <motion.div
              key={testimonial.author}
              variants={cardVariants}
              whileHover={{
                y: -8,
                transition: { duration: 0.2 },
              }}
            >
              <TestimonialCard
                text={testimonial.text}
                author={testimonial.author}
                result={testimonial.result}
                color={
                  testimonial.color as 'cyan' | 'green' | 'orange' | 'pink'
                }
              />
            </motion.div>
          ))}
        </motion.div>

        <div className="mt-16 text-center">
          <motion.div
            variants={{
              hidden: { opacity: 0, y: 20 },
              visible: {
                opacity: 1,
                y: 0,
                transition: { duration: 0.6, ease: 'easeOut', delay: 0.4 },
              },
            }}
          >
            <Button
              onClick={handleMoreStoriesClick}
              variant="outline"
              size="lg"
              className="border-2 border-cyan-200 text-cyan-600 hover:bg-cyan-50 hover:border-cyan-300 transition-all duration-300 rounded-xl group"
            >
              <span>{dict.more_stories_button}</span>
              {locale === 'he' ? (
                <ArrowLeft className="mr-2 h-5 w-5 group-hover:-translate-x-1 transition-transform" />
              ) : (
                <ArrowRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform" />
              )}{' '}
            </Button>
          </motion.div>

          <div className="mt-4 h-6">
            <AnimatePresence>
              {showComingSoon && (
                <motion.p
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  transition={{ duration: 0.3 }}
                  className="text-cyan-700 font-medium"
                >
                  {dict.coming_soon_message}
                </motion.p>
              )}
            </AnimatePresence>
          </div>
        </div>

        <motion.div
          className="mt-8 text-center"
          variants={{
            hidden: { opacity: 0, y: 20 },
            visible: {
              opacity: 1,
              y: 0,
              transition: { duration: 0.6, ease: 'easeOut', delay: 0.5 },
            },
          }}
        ></motion.div>
      </div>
    </motion.section>
  );
};

export default SuccessStoriesSection;
--- End of Content for SuccessStoriesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\ValuePropositionSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/HomePage/sections/ValuePropositionSection.tsx

import React, { useRef } from 'react';
import { motion, useInView } from 'framer-motion';
import ComparisonItem from '../components/ComparisonItem';
import Link from 'next/link';
import { usePathname } from 'next/navigation'; // ✨ 1. ייבוא hook נדרש
import type { ValuePropositionDict } from '@/types/dictionary';

interface ValuePropositionProps {
  dict: ValuePropositionDict;
}

const ValuePropositionSection: React.FC<ValuePropositionProps> = ({ dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.1 });

  // ✨ 3. קבלת השפה הנוכחית מה-URL
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'he';

  // Animation variants (ללא שינוי)
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.2, delayChildren: 0.3 },
    },
  };
  const fadeInUp = {
    hidden: { opacity: 0, y: 30 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };
  const fadeInLeft = {
    hidden: { opacity: 0, x: -50 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const fadeInRight = {
    hidden: { opacity: 0, x: 50 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.7, ease: 'easeOut' },
    },
  };
  const staggeredListVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const listItemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.4, ease: 'easeOut' },
    },
  };

  return (
    <motion.section
      ref={ref}
      className="py-16 md:py-20 pb-0 px-4 bg-cyan-50 relative overflow-hidden"
      variants={containerVariants}
      initial="hidden"
      animate={isInView ? 'visible' : 'hidden'}
    >
      <div className="absolute inset-0 bg-gradient-to-br from-cyan-50 to-white opacity-70"></div>

      <div className="max-w-6xl mx-auto relative">
        {/* ✨ 4. שימוש בתרגומים לכותרות */}
        <motion.div className="text-center mb-12" variants={fadeInUp}>
          <h2 className="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            {dict.title_part1}
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-cyan-700">
              {' '}
              {dict.title_brand}{' '}
            </span>
            {dict.title_part2}
          </h2>
          <div className="w-24 h-1 bg-gradient-to-r from-cyan-600 to-cyan-700 mx-auto rounded-full mb-6" />
          <p className="text-lg text-gray-600 max-w-3xl mx-auto">
            {dict.subtitle}
          </p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
          {' '}
          {/* items-start במקום items-center */}
          {/* Left card - Challenge */}
          <motion.div
            className="bg-white rounded-2xl shadow-xl p-8 transform md:translate-x-4 relative overflow-hidden"
            variants={fadeInLeft}
          >
            <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-cyan-100 to-cyan-50 opacity-50 rounded-full transform translate-x-20 -translate-y-20"></div>
            <h3 className="text-xl font-bold mb-4 text-gray-800 relative">
              {dict.challengeCard.title}
            </h3>
            <motion.ul
              className="space-y-3 relative"
              variants={staggeredListVariants}
              initial="hidden"
              animate={isInView ? 'visible' : 'hidden'}
            >
              {/* ✨ 5. רינדור דינמי של רשימת האתגרים */}
              {dict.challengeCard.items.map((item, index) => (
                <motion.div key={index} variants={listItemVariants}>
                  <ComparisonItem isNegative>{item}</ComparisonItem>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
          {/* Right card - Solution */}
          <motion.div
            className="bg-white rounded-2xl shadow-xl p-8 transform md:-translate-x-4 relative overflow-hidden"
            variants={fadeInRight}
          >
            <div className="absolute bottom-0 left-0 w-40 h-40 bg-gradient-to-br from-cyan-100 to-cyan-50 opacity-50 rounded-full transform -translate-x-20 translate-y-20"></div>
            <h3 className="text-xl font-bold mb-4 text-gray-800 relative">
              {dict.solutionCard.title}
            </h3>
            <motion.ul
              className="space-y-3 relative"
              variants={staggeredListVariants}
              initial="hidden"
              animate={isInView ? 'visible' : 'hidden'}
            >
              {/* ✨ 6. רינדור דינמי של רשימת הפתרונות, כולל טיפול בקישור */}
              {dict.solutionCard.items.map((item, index) => (
                <motion.div key={index} variants={listItemVariants}>
                  <ComparisonItem>
                    <strong>{item.bold}</strong>
                    {item.text && <span>{item.text}</span>}
                    {item.textWithLink && (
                      <span>
                        {item.textWithLink.part1}
                        <Link
                          href={`/${locale}/questionnaire`}
                          className="text-cyan-600 hover:underline font-semibold mx-1"
                        >
                          {item.textWithLink.linkText}
                        </Link>
                        {item.textWithLink.part2}
                      </span>
                    )}
                  </ComparisonItem>
                </motion.div>
              ))}
            </motion.ul>
          </motion.div>
        </div>
      </div>
    </motion.section>
  );
};

export default ValuePropositionSection;
--- End of Content for ValuePropositionSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\HomePage\sections\sections_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--- End of Content for sections_contents.txt ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\admin
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\admin\EngagementDashboard.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import { useState, useEffect } from 'react';
import {
  Search,
  Mail,
  Users,
  TrendingUp,
  Clock,
  Send,
  RefreshCw,
  Moon,
} from 'lucide-react';

// ===============================
// Types & Interfaces
// ===============================

interface User {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  profile: {
    city: string | null;
  } | null;
  dripCampaign: {
    lastSentType: string | null;
    updatedAt: Date;
  } | null;
}

interface Stats {
  todayEmails: number;
  weeklyEmails: number;
  activeUsers: number;
  completionDistribution: Array<{
    range: string;
    count: number;
    color: string;
  }>;
  recentActivity: Array<{
    time: string;
    user: string;
    action: string;
    status: 'sent' | 'failed';
  }>;
  emailTypeBreakdown: Array<{
    name: string;
    value: number;
    color: string;
  }>;
}

interface EngagementDashboardProps {
  dict: any;
}

// ===============================
// Main Component
// ===============================

export default function EngagementDashboard({
  dict,
}: EngagementDashboardProps) {
  // ===============================
  // State Management
  // ===============================

  const [users, setUsers] = useState<User[]>([]);
  const [allUsers, setAllUsers] = useState<User[]>([]); // 🎯 שמירת כל היוזרים
  const [stats, setStats] = useState<Stats | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedUsers, setSelectedUsers] = useState<Set<string>>(new Set());
  const [selectedEmailType, setSelectedEmailType] =
    useState('EVENING_FEEDBACK');
  const [isLoading, setIsLoading] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const [isRunningCampaign, setIsRunningCampaign] = useState(false);
  const [isRunningEveningCampaign, setIsRunningEveningCampaign] =
    useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  // ===============================
  // Data Fetching Functions
  // ===============================

  // טעינת כל המשתמשים הזכאים
  const fetchAllUsers = async () => {
    try {
      console.log('🔄 Fetching all eligible users...');
      const response = await fetch('/api/admin/engagement/eligible-users');

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log('✅ Received eligible users:', data);

      if (data.success && data.users) {
        setAllUsers(data.users);
        setUsers(data.users); // 🎯 הצג את כולם בהתחלה
        console.log(`✅ Loaded ${data.users.length} eligible users`);
      } else {
        throw new Error(data.error || 'Failed to fetch users');
      }
    } catch (err) {
      console.error('❌ Error fetching eligible users:', err);
      setError(err instanceof Error ? err.message : 'Unknown error');
    }
  };

  // טעינת סטטיסטיקות
  const fetchStats = async () => {
    try {
      console.log('🔄 Fetching stats...');
      const response = await fetch('/api/admin/engagement/stats');

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log('✅ Received stats:', data);
      setStats(data);
    } catch (err) {
      console.error('❌ Error fetching stats:', err);
    }
  };

  // חיפוש משתמשים
  const searchUsers = async (query: string) => {
    // 🎯 אם אין חיפוש, הצג את כל היוזרים
    if (!query || query.trim().length === 0) {
      console.log('🔍 Empty search query - showing all users');
      setUsers(allUsers);
      return;
    }

    // 🎯 אם החיפוש קצר מדי, סנן מקומית
    if (query.length < 2) {
      const filtered = allUsers.filter(
        (user) =>
          user.firstName.toLowerCase().includes(query.toLowerCase()) ||
          user.lastName.toLowerCase().includes(query.toLowerCase()) ||
          user.email.toLowerCase().includes(query.toLowerCase())
      );
      setUsers(filtered);
      return;
    }

    try {
      console.log('🔍 Searching users with query:', query);
      const response = await fetch(
        `/api/admin/engagement/search-users?q=${encodeURIComponent(query)}`
      );

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log('✅ Search results:', data);

      if (data.users) {
        setUsers(data.users);
      }
    } catch (err) {
      console.error('❌ Error searching users:', err);
    }
  };

  // ===============================
  // Initial Data Loading
  // ===============================

  useEffect(() => {
    const loadInitialData = async () => {
      setIsLoading(true);
      setError(null);

      try {
        await Promise.all([fetchAllUsers(), fetchStats()]);
      } catch (err) {
        console.error('❌ Error loading initial data:', err);
        setError('Failed to load dashboard data');
      } finally {
        setIsLoading(false);
      }
    };

    loadInitialData();
  }, []);

  // ===============================
  // Search Effect
  // ===============================

  useEffect(() => {
    const debounceTimer = setTimeout(() => {
      searchUsers(searchQuery);
    }, 300); // דיליי של 300ms

    return () => clearTimeout(debounceTimer);
  }, [searchQuery, allUsers]); // 🎯 תלות ב-allUsers

  // ===============================
  // Action Handlers
  // ===============================

  // בחירת/ביטול בחירת משתמש
  const toggleUserSelection = (userId: string) => {
    const newSelection = new Set(selectedUsers);
    if (newSelection.has(userId)) {
      newSelection.delete(userId);
    } else {
      newSelection.add(userId);
    }
    setSelectedUsers(newSelection);
  };

  // בחירת כולם
  const selectAll = () => {
    setSelectedUsers(new Set(users.map((u) => u.id)));
  };

  // ביטול בחירת כולם
  const deselectAll = () => {
    setSelectedUsers(new Set());
  };

  // שליחת מייל למשתמש בודד
  const sendEmailToUser = async (userId: string) => {
    setIsSending(true);
    setError(null);
    setSuccessMessage(null);

    try {
      console.log(`📧 Sending ${selectedEmailType} to user ${userId}...`);

      const response = await fetch('/api/admin/engagement/send-manual', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId,
          emailType: selectedEmailType,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.details || data.error || 'Failed to send email');
      }

      console.log('✅ Email sent successfully:', data);
      setSuccessMessage(`Email sent to ${data.recipient}`);

      // רענן את הנתונים
      await Promise.all([fetchAllUsers(), fetchStats()]);
    } catch (err) {
      console.error('❌ Error sending email:', err);
      setError(err instanceof Error ? err.message : 'Failed to send email');
    } finally {
      setIsSending(false);
    }
  };

  // שליחת מיילים למשתמשים נבחרים
  const sendBulkEmails = async () => {
    if (selectedUsers.size === 0) {
      setError('Please select at least one user');
      return;
    }

    setIsSending(true);
    setError(null);
    setSuccessMessage(null);

    try {
      console.log(`📧 Sending bulk emails to ${selectedUsers.size} users...`);

      const promises = Array.from(selectedUsers).map((userId) =>
        fetch('/api/admin/engagement/send-manual', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            emailType: selectedEmailType,
          }),
        })
      );

      const results = await Promise.all(promises);
      const successCount = results.filter((r) => r.ok).length;

      console.log(`✅ Sent ${successCount}/${selectedUsers.size} emails`);
      setSuccessMessage(
        `Sent ${successCount}/${selectedUsers.size} emails successfully`
      );

      // רענן את הנתונים
      await Promise.all([fetchAllUsers(), fetchStats()]);

      // נקה את הבחירה
      setSelectedUsers(new Set());
    } catch (err) {
      console.error('❌ Error sending bulk emails:', err);
      setError(err instanceof Error ? err.message : 'Failed to send emails');
    } finally {
      setIsSending(false);
    }
  };

  // הרצת קמפיין יומי מלא (בוקר)
  const runFullCampaign = async () => {
    setIsRunningCampaign(true);
    setError(null);
    setSuccessMessage(null);

    try {
      console.log('🚀 Running full daily campaign...');

      const response = await fetch('/api/admin/engagement/run-now', {
        method: 'POST',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to run campaign');
      }

      console.log('✅ Daily campaign complete:', data);
      setSuccessMessage(
        `Daily Campaign complete! Processed: ${data.processed}, Sent: ${data.sent}`
      );

      // רענן את הנתונים
      await Promise.all([fetchAllUsers(), fetchStats()]);
    } catch (err) {
      console.error('❌ Error running campaign:', err);
      setError(err instanceof Error ? err.message : 'Failed to run campaign');
    } finally {
      setIsRunningCampaign(false);
    }
  };

  // 🌙 הרצת קמפיין ערב
  const runEveningCampaign = async () => {
    setIsRunningEveningCampaign(true);
    setError(null);
    setSuccessMessage(null);

    try {
      console.log('🌙 Running evening feedback campaign...');

      const response = await fetch('/api/admin/engagement/run-evening', {
        method: 'POST',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to run evening campaign');
      }

      console.log('✅ Evening campaign complete:', data);
      setSuccessMessage(
        `Evening Campaign complete! Processed: ${data.processed}, Sent: ${data.sent}`
      );

      // רענן את הנתונים
      await Promise.all([fetchAllUsers(), fetchStats()]);
    } catch (err) {
      console.error('❌ Error running evening campaign:', err);
      setError(
        err instanceof Error ? err.message : 'Failed to run evening campaign'
      );
    } finally {
      setIsRunningEveningCampaign(false);
    }
  };

  // ===============================
  // Helper Functions
  // ===============================

  const getEmailTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      EVENING_FEEDBACK: '🌙 Evening Feedback',
      AI_SUMMARY: '🤖 AI Summary',
      NUDGE: '👉 Nudge',
      CELEBRATION: '🎉 Celebration',
      VALUE: '💎 Value',
      ONBOARDING: '👋 Onboarding (Generic)',
      ONBOARDING_DAY_1: '👋 Onboarding - Day 1',
      ONBOARDING_PHOTOS: '📸 Onboarding - Photos',
      ONBOARDING_AI_TEASER: '🤖 Onboarding - AI Teaser',
      ONBOARDING_QUESTIONNAIRE_WHY: '❓ Onboarding - Why',
      ONBOARDING_VALUE_ADD: '💎 Onboarding - Value',
    };
    return labels[type] || type;
  };

  const formatDate = (date: Date | string | null) => {
    if (!date) return 'Never';
    try {
      return new Date(date).toLocaleDateString('he-IL', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    } catch {
      return 'Invalid date';
    }
  };

  // ===============================
  // Render
  // ===============================

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <RefreshCw className="w-12 h-12 text-primary-600 animate-spin mx-auto mb-4" />
          <p className="text-gray-600">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8 px-4">
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-8">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Engagement Dashboard
            </h1>
            <p className="text-gray-600">
              Manage and monitor user engagement campaigns
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Clock className="w-5 h-5 text-gray-400" />
            <span className="text-sm text-gray-600">
              Last updated: {new Date().toLocaleTimeString('he-IL')}
            </span>
          </div>
        </div>
      </div>

      {/* Error/Success Messages */}
      {error && (
        <div className="max-w-7xl mx-auto mb-6">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-800 text-sm">{error}</p>
          </div>
        </div>
      )}

      {successMessage && (
        <div className="max-w-7xl mx-auto mb-6">
          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
            <p className="text-green-800 text-sm">{successMessage}</p>
          </div>
        </div>
      )}

      {/* Stats Cards */}
      {stats && (
        <div className="max-w-7xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-white rounded-lg shadow p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-gray-600 text-sm font-medium">
                Today&apos;s Emails
              </h3>
              <Mail className="w-5 h-5 text-blue-500" />
            </div>
            <p className="text-3xl font-bold text-gray-900">
              {stats.todayEmails}
            </p>
          </div>

          <div className="bg-white rounded-lg shadow p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-gray-600 text-sm font-medium">
                Weekly Emails
              </h3>
              <TrendingUp className="w-5 h-5 text-green-500" />
            </div>
            <p className="text-3xl font-bold text-gray-900">
              {stats.weeklyEmails}
            </p>
          </div>

          <div className="bg-white rounded-lg shadow p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-gray-600 text-sm font-medium">
                Active Users
              </h3>
              <Users className="w-5 h-5 text-purple-500" />
            </div>
            <p className="text-3xl font-bold text-gray-900">
              {stats.activeUsers}
            </p>
          </div>
        </div>
      )}

      {/* Main Content */}
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow">
          {/* Toolbar */}
          <div className="p-6 border-b border-gray-200">
            <div className="flex flex-col lg:flex-row gap-4 justify-between">
              {/* Search */}
              <div className="flex-1 max-w-md">
                <div className="relative">
                  <Search className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="text"
                    placeholder="חפש משתמש... (שם, אימייל, ID)"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  />
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  {users.length} משתמשים מוצגים מתוך {allUsers.length}
                </p>
              </div>

              {/* Email Type Selector and Campaign Buttons */}
              <div className="flex gap-2">
                <select
                  value={selectedEmailType}
                  onChange={(e) => setSelectedEmailType(e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                >
                  <optgroup label="Evening Campaign">
                    <option value="EVENING_FEEDBACK">
                      🌙 Evening Feedback
                    </option>
                  </optgroup>
                  <optgroup label="Morning Campaign - Onboarding">
                    <option value="ONBOARDING_DAY_1">
                      👋 Onboarding - Day 1
                    </option>
                    <option value="ONBOARDING_PHOTOS">
                      📸 Onboarding - Photos
                    </option>
                    <option value="ONBOARDING_AI_TEASER">
                      🤖 Onboarding - AI Teaser
                    </option>
                    <option value="ONBOARDING_QUESTIONNAIRE_WHY">
                      ❓ Onboarding - Questionnaire Why
                    </option>
                    <option value="ONBOARDING_VALUE_ADD">
                      💎 Onboarding - Value Add
                    </option>
                  </optgroup>
                  <optgroup label="Morning Campaign - Engagement">
                    <option value="NUDGE">👉 Nudge (Contextual)</option>
                    <option value="CELEBRATION">
                      🎉 Celebration (Almost Done)
                    </option>
                    <option value="AI_SUMMARY">🤖 AI Summary</option>
                    <option value="VALUE">💎 Value (Periodic)</option>
                  </optgroup>
                </select>

                {/* 🌙 Evening Campaign Button */}
                <button
                  onClick={runEveningCampaign}
                  disabled={isRunningEveningCampaign}
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                  title="Run Evening Feedback Campaign"
                >
                  {isRunningEveningCampaign ? (
                    <>
                      <RefreshCw className="w-4 h-4 animate-spin" />
                      Running...
                    </>
                  ) : (
                    <>
                      <Moon className="w-4 h-4" />
                      Evening Campaign
                    </>
                  )}
                </button>

                {/* 🚀 Daily Campaign Button */}
                <button
                  onClick={runFullCampaign}
                  disabled={isRunningCampaign}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                  title="Run Daily Campaign"
                >
                  {isRunningCampaign ? (
                    <>
                      <RefreshCw className="w-4 h-4 animate-spin" />
                      Running...
                    </>
                  ) : (
                    <>
                      <Send className="w-4 h-4" />
                      Daily Campaign
                    </>
                  )}
                </button>
              </div>
            </div>

            {/* Selection Actions */}
            {selectedUsers.size > 0 && (
              <div className="mt-4 flex items-center gap-4 p-4 bg-blue-50 rounded-lg">
                <span className="text-sm font-medium text-blue-900">
                  {selectedUsers.size} נבחרו
                </span>
                <button
                  onClick={sendBulkEmails}
                  disabled={isSending}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm flex items-center gap-2"
                >
                  {isSending ? (
                    <>
                      <RefreshCw className="w-4 h-4 animate-spin" />
                      Sending...
                    </>
                  ) : (
                    <>
                      <Send className="w-4 h-4" />
                      Send to Selected
                    </>
                  )}
                </button>
                <button
                  onClick={deselectAll}
                  className="text-sm text-blue-600 hover:text-blue-800"
                >
                  ביטול בחירה
                </button>
              </div>
            )}
          </div>

          {/* Users Table */}
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    <input
                      type="checkbox"
                      checked={
                        selectedUsers.size === users.length && users.length > 0
                      }
                      onChange={(e) =>
                        e.target.checked ? selectAll() : deselectAll()
                      }
                      className="rounded border-gray-300"
                    />
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    User
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Email
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    City
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Last Contact
                  </th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {users.length === 0 ? (
                  <tr>
                    <td
                      colSpan={6}
                      className="px-6 py-8 text-center text-gray-500"
                    >
                      {searchQuery ? 'לא נמצאו תוצאות' : 'אין משתמשים זכאים'}
                    </td>
                  </tr>
                ) : (
                  users.map((user) => (
                    <tr key={user.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4">
                        <input
                          type="checkbox"
                          checked={selectedUsers.has(user.id)}
                          onChange={() => toggleUserSelection(user.id)}
                          className="rounded border-gray-300"
                        />
                      </td>
                      <td className="px-6 py-4">
                        <div className="text-sm font-medium text-gray-900">
                          {user.firstName} {user.lastName}
                        </div>
                        <div className="text-xs text-gray-500">{user.id}</div>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {user.email}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {user.profile?.city || '-'}
                      </td>
                      <td className="px-6 py-4">
                        {user.dripCampaign ? (
                          <div>
                            <div className="text-xs text-gray-600">
                              {getEmailTypeLabel(
                                user.dripCampaign.lastSentType || ''
                              )}
                            </div>
                            <div className="text-xs text-gray-400">
                              {formatDate(user.dripCampaign.updatedAt)}
                            </div>
                          </div>
                        ) : (
                          <span className="text-xs text-gray-400">Never</span>
                        )}
                      </td>
                      <td className="px-6 py-4">
                        <button
                          onClick={() => sendEmailToUser(user.id)}
                          disabled={isSending}
                          className="px-3 py-1 bg-primary-600 text-white text-sm rounded hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1"
                        >
                          <Mail className="w-3 h-3" />
                          Send
                        </button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
--- End of Content for EngagementDashboard.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\analytics
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\analytics\GoogleAnalytics.tsx
--------------------------------------------------------------------------------
Content:
// src/components/analytics/GoogleAnalytics.tsx (גרסה מעודכנת עם ניהול הסכמה)
'use client'

import { useState, useEffect } from 'react';
import Script from 'next/script';

const GoogleAnalytics = () => {
  const gaId = process.env.NEXT_PUBLIC_GA_ID;
  const [hasConsent, setHasConsent] = useState(false);

  useEffect(() => {
    // נבדוק את ההסכמה השמורה ב-localStorage רק בצד הלקוח
    const storedConsent = localStorage.getItem('cookie_consent');
    if (storedConsent === 'true') {
      setHasConsent(true);
    }
  }, []);

  // אם אין מזהה אנליטיקס או שהמשתמש לא הסכים, אל תטען כלום
  if (!gaId || !hasConsent) {
    return null;
  }

  // רק אם יש הסכמה, נטען את הסקריפטים
  return (
    <>
      <Script
        strategy="afterInteractive"
        src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}
      />
      <Script
        id="google-analytics"
        strategy="afterInteractive"
        dangerouslySetInnerHTML={{
          __html: `
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${gaId}', {
              page_path: window.location.pathname,
            });
          `,
        }}
      />
    </>
  )
}

export default GoogleAnalytics;
--- End of Content for GoogleAnalytics.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\AuthError.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/AuthError.tsx

'use client';

import { useSearchParams, useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

export default function AuthError() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const error = searchParams.get("error");

  const getErrorMessage = (error: string | null) => {
    switch (error) {
      case "CredentialsSignin": return "פרטי ההתחברות שהזנת אינם נכונים. אנא נסה שנית.";
      case "OAuthAccountNotLinked": return "כתובת מייל זו כבר משויכת לספק אחר (למשל, גוגל). אנא התחבר באמצעותו.";
      default: return "אירעה שגיאה לא צפויה בתהליך האימות. אנא נסה שנית.";
    }
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="text-center">
        <AlertTriangle className="mx-auto h-12 w-12 text-red-500" />
        <CardTitle className="text-2xl font-bold text-red-600 mt-4">
          אירעה שגיאה
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 text-center">
        <p className="text-gray-600">{getErrorMessage(error)}</p>
        <Button onClick={() => router.push("/auth/signin")} className="w-full">
          חזרה לדף ההתחברות
        </Button>
      </CardContent>
    </Card>
  );
}
--- End of Content for AuthError.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ConsentCheckbox.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/ConsentCheckbox.tsx
'use client';

import React from 'react';
import Link from 'next/link';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface ConsentCheckboxProps {
  checked: boolean;
  onChange: (isChecked: boolean) => void;
  error?: string | null;
  dict: RegisterStepsDict['consentCheckbox'];
}

const ConsentCheckbox: React.FC<ConsentCheckboxProps> = ({
  checked,
  onChange,
  error,
  dict,
}) => {
  const textParts = dict.text.split(/\{termsLink\}|\{privacyLink\}/);

  return (
    <div className="space-y-2">
      <div className="flex items-start space-x-2 rtl:space-x-reverse">
        <input
          type="checkbox"
          id="termsConsent"
          checked={checked}
          onChange={(e) => onChange(e.target.checked)}
          className={`mt-1 h-4 w-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500 ${error ? 'border-red-500' : ''}`}
        />
        <label htmlFor="termsConsent" className="text-sm text-gray-700">
          {textParts[0]}
          <Link
            href="/legal/terms-of-service"
            target="_blank"
            className="font-medium text-cyan-600 hover:text-cyan-700 underline"
          >
            {dict.termsLink}
          </Link>
          {textParts[1]}
          <Link
            href="/legal/privacy-policy"
            target="_blank"
            className="font-medium text-cyan-600 hover:text-cyan-700 underline"
          >
            {dict.privacyLink}
          </Link>
          {textParts[2]}
        </label>
      </div>
      {error && <p className="text-xs text-red-500">{error}</p>}
    </div>
  );
};

export default ConsentCheckbox;
--- End of Content for ConsentCheckbox.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ForgotPasswordForm.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/ResetPasswordForm.tsx
'use client';

import { useState, FormEvent, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Lock,
  KeySquare,
  Loader2,
  AlertCircle,
  CheckCircle,
  Eye,
  EyeOff,
  Mail,
} from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import Link from 'next/link';

const validatePassword = (value: string): string | null => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  if (!passwordRegex.test(value)) {
    return 'הסיסמה חייבת להכיל לפחות 8 תווים, אות גדולה, אות קטנה ומספר.';
  }
  return null;
};

export default function ResetPasswordForm() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [passwordError, setPasswordError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  useEffect(() => {
    const emailFromQuery = searchParams.get('email');
    const tokenFromQuery = searchParams.get('token');

    if (emailFromQuery) {
      setEmail(emailFromQuery);
    }
    if (tokenFromQuery) {
      setOtp(tokenFromQuery);
    }
  }, [searchParams]);

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setPasswordError(null);
    setSuccessMessage(null);

    if (!email) {
      setError('כתובת המייל חסרה. אנא חזור להתחלה ונסה שנית.');
      setIsLoading(false);
      return;
    }
    if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
      setError('קוד האימות (OTP) חייב להיות בן 6 ספרות.');
      setIsLoading(false);
      return;
    }
    const passValidationError = validatePassword(newPassword);
    if (passValidationError) {
      setPasswordError(passValidationError);
      setIsLoading(false);
      return;
    }
    if (newPassword !== confirmPassword) {
      setError('הסיסמאות אינן תואמות.');
      setIsLoading(false);
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp, newPassword }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'אירעה שגיאה באיפוס הסיסמה.');
      }

      setSuccessMessage(
        data.message || 'הסיסמה אופסה בהצלחה! כעת תוכל להתחבר עם הסיסמה החדשה.'
      );
      setOtp('');
      setNewPassword('');
      setConfirmPassword('');
      setTimeout(() => {
        router.push('/auth/signin?reset=success');
      }, 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'אירעה שגיאה לא צפויה.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative border border-white/50">
      {/* UPDATED: Top Bar Gradient (Teal -> Orange -> Amber) */}
      <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"></div>
      
      <div className="p-6 sm:p-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">איפוס סיסמה</h1>
          <p className="text-gray-600 text-sm">
            הזן את קוד האימות (OTP) שקיבלת במייל ואת הסיסמה החדשה שלך.
          </p>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>שגיאה</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        {passwordError && !error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>שגיאת סיסמה</AlertTitle>
            <AlertDescription id="password-error-message">
              {passwordError}
            </AlertDescription>
          </Alert>
        )}

        {successMessage && (
          // Success message can stay Green as it's a standard status color
          <Alert
            variant="default"
            className="mb-4 bg-green-50 border-green-200 text-green-700"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <AlertTitle>הצלחה!</AlertTitle>
            <AlertDescription>
              {successMessage} אתה מועבר לדף ההתחברות...
            </AlertDescription>
          </Alert>
        )}

        {!successMessage && (
          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1">
              <label
                htmlFor="email-reset"
                className="block text-sm font-medium text-gray-700"
              >
                כתובת מייל (לאימות) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="email"
                  id="email-reset"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@example.com"
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none"
                  disabled={isLoading || !!searchParams.get('email')}
                />
              </div>
            </div>
            <div className="space-y-1">
              <label
                htmlFor="otp-reset"
                className="block text-sm font-medium text-gray-700"
              >
                קוד אימות (OTP) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <KeySquare className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="text"
                  id="otp-reset"
                  value={otp}
                  onChange={(e) =>
                    setOtp(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))
                  }
                  placeholder="xxxxxx"
                  maxLength={6}
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none tracking-widest text-center"
                  disabled={isLoading}
                  inputMode="numeric"
                />
              </div>
            </div>

            <div className="space-y-1">
              <label
                htmlFor="new-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                סיסמה חדשה <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showPassword ? 'text' : 'password'}
                  id="new-password-reset"
                  aria-describedby={
                    passwordError ? 'password-error-message' : 'password-hint'
                  }
                  aria-invalid={!!passwordError}
                  value={newPassword}
                  onChange={(e) => {
                    setNewPassword(e.target.value);
                    const validationErr = validatePassword(e.target.value);
                    if (e.target.value && validationErr)
                      setPasswordError(validationErr);
                    else setPasswordError(null);
                  }}
                  placeholder="לפחות 8 תווים, אות גדולה, קטנה ומספר"
                  required
                  // UPDATED: Focus Ring (Error red, else Teal)
                  className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none ${
                    passwordError
                      ? 'border-red-500 focus:ring-red-200'
                      : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                  }`}
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showPassword ? 'הסתר סיסמה' : 'הצג סיסמה'}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
              {!passwordError && (
                <p id="password-hint" className="mt-1 text-xs text-gray-500">
                  חייבת להכיל לפחות 8 תווים, אות גדולה, אות קטנה ומספר.
                </p>
              )}
            </div>

            <div className="space-y-1">
              <label
                htmlFor="confirm-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                אימות סיסמה חדשה <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showConfirmPassword ? 'text' : 'password'}
                  id="confirm-password-reset"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder="הזן את הסיסמה החדשה שוב"
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none"
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showConfirmPassword ? 'הסתר סיסמה' : 'הצג סיסמה'}
                >
                  {showConfirmPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </div>

            <Button
              type="submit"
              disabled={
                isLoading ||
                !!passwordError ||
                !otp ||
                !newPassword ||
                !confirmPassword ||
                newPassword !== confirmPassword
              }
              // UPDATED: Button Gradient (Teal -> Orange -> Amber)
              className="w-full py-3 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg flex items-center justify-center gap-2"
            >
              {isLoading ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin mr-2" />
                  <span>מאפס סיסמה...</span>
                </>
              ) : (
                'אפס סיסמה'
              )}
            </Button>
          </form>
        )}

        <div className="mt-6 text-center">
          {/* UPDATED: Link Color (Teal) */}
          <Link
            href="/auth/signin"
            className="text-sm text-teal-600 hover:text-teal-700 hover:underline"
          >
            חזרה להתחברות
          </Link>
        </div>
      </div>
    </div>
  );
}
--- End of Content for ForgotPasswordForm.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\PhoneNumberInput.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/PhoneNumberInput.tsx
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { Phone, ChevronDown, Search, X, Edit } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// רשימת מדינות מורחבת עם קהילות יהודיות
const COUNTRIES = [
  // מדינות פופולאריות
  {
    code: 'IL',
    name: 'Israel',
    nameHe: 'ישראל',
    flag: '🇮🇱',
    prefix: '+972',
    popular: true,
    placeholder: '50-123-4567',
  },
  {
    code: 'US',
    name: 'United States',
    nameHe: 'ארצות הברית',
    flag: '🇺🇸',
    prefix: '+1',
    popular: true,
    placeholder: '555-123-4567',
  },
  {
    code: 'GB',
    name: 'United Kingdom',
    nameHe: 'בריטניה',
    flag: '🇬🇧',
    prefix: '+44',
    popular: true,
    placeholder: '7123 456789',
  },
  {
    code: 'CA',
    name: 'Canada',
    nameHe: 'קנדה',
    flag: '🇨🇦',
    prefix: '+1',
    popular: true,
    placeholder: '555-123-4567',
  },
  {
    code: 'FR',
    name: 'France',
    nameHe: 'צרפת',
    flag: '🇫🇷',
    prefix: '+33',
    popular: true,
    placeholder: '06 12 34 56 78',
  },
  // ... שאר המדינות נשארות אותו דבר
  // (קיצרתי כאן כדי לחסוך מקום, הרשימה המלאה קיימת בקוד המקורי שלך)
  {
    code: 'AR',
    name: 'Argentina',
    nameHe: 'ארגנטינה',
    flag: '🇦🇷',
    prefix: '+54',
    popular: false,
    placeholder: '11 1234-5678',
  },
  {
    code: 'AU',
    name: 'Australia',
    nameHe: 'אוסטרליה',
    flag: '🇦🇺',
    prefix: '+61',
    popular: false,
    placeholder: '412 345 678',
  },
  {
    code: 'AT',
    name: 'Austria',
    nameHe: 'אוסטריה',
    flag: '🇦🇹',
    prefix: '+43',
    popular: false,
    placeholder: '664 123456',
  },
  {
    code: 'BE',
    name: 'Belgium',
    nameHe: 'בלגיה',
    flag: '🇧🇪',
    prefix: '+32',
    popular: false,
    placeholder: '470 12 34 56',
  },
  {
    code: 'BR',
    name: 'Brazil',
    nameHe: 'ברזיל',
    flag: '🇧🇷',
    prefix: '+55',
    popular: false,
    placeholder: '11 91234-5678',
  },
  {
    code: 'BG',
    name: 'Bulgaria',
    nameHe: 'בולגריה',
    flag: '🇧🇬',
    prefix: '+359',
    popular: false,
    placeholder: '87 123 4567',
  },
  {
    code: 'CL',
    name: 'Chile',
    nameHe: "צ'ילה",
    flag: '🇨🇱',
    prefix: '+56',
    popular: false,
    placeholder: '9 1234 5678',
  },
  {
    code: 'CO',
    name: 'Colombia',
    nameHe: 'קולומביה',
    flag: '🇨🇴',
    prefix: '+57',
    popular: false,
    placeholder: '300 123 4567',
  },
  {
    code: 'HR',
    name: 'Croatia',
    nameHe: 'קרואטיה',
    flag: '🇭🇷',
    prefix: '+385',
    popular: false,
    placeholder: '91 234 567',
  },
  {
    code: 'CZ',
    name: 'Czech Republic',
    nameHe: "צ'כיה",
    flag: '🇨🇿',
    prefix: '+420',
    popular: false,
    placeholder: '601 123 456',
  },
  {
    code: 'DK',
    name: 'Denmark',
    nameHe: 'דנמרק',
    flag: '🇩🇰',
    prefix: '+45',
    popular: false,
    placeholder: '20 12 34 56',
  },
  {
    code: 'EE',
    name: 'Estonia',
    nameHe: 'אסטוניה',
    flag: '🇪🇪',
    prefix: '+372',
    popular: false,
    placeholder: '5123 4567',
  },
  {
    code: 'FI',
    name: 'Finland',
    nameHe: 'פינלנד',
    flag: '🇫🇮',
    prefix: '+358',
    popular: false,
    placeholder: '40 123 4567',
  },
  {
    code: 'GE',
    name: 'Georgia',
    nameHe: 'גאורגיה',
    flag: '🇬🇪',
    prefix: '+995',
    popular: false,
    placeholder: '555 12 34 56',
  },
  {
    code: 'DE',
    name: 'Germany',
    nameHe: 'גרמניה',
    flag: '🇩🇪',
    prefix: '+49',
    popular: false,
    placeholder: '1512 3456789',
  },
  {
    code: 'GR',
    name: 'Greece',
    nameHe: 'יוון',
    flag: '🇬🇷',
    prefix: '+30',
    popular: false,
    placeholder: '694 123 4567',
  },
  {
    code: 'HU',
    name: 'Hungary',
    nameHe: 'הונגריה',
    flag: '🇭🇺',
    prefix: '+36',
    popular: false,
    placeholder: '20 123 4567',
  },
  {
    code: 'IN',
    name: 'India',
    nameHe: 'הודו',
    flag: '🇮🇳',
    prefix: '+91',
    popular: false,
    placeholder: '91234 56789',
  },
  {
    code: 'IE',
    name: 'Ireland',
    nameHe: 'אירלנד',
    flag: '🇮🇪',
    prefix: '+353',
    popular: false,
    placeholder: '85 123 4567',
  },
  {
    code: 'IT',
    name: 'Italy',
    nameHe: 'איטליה',
    flag: '🇮🇹',
    prefix: '+39',
    popular: false,
    placeholder: '312 345 6789',
  },
  {
    code: 'LV',
    name: 'Latvia',
    nameHe: 'לטביה',
    flag: '🇱🇻',
    prefix: '+371',
    popular: false,
    placeholder: '21 234 567',
  },
  {
    code: 'LT',
    name: 'Lithuania',
    nameHe: 'ליטא',
    flag: '🇱🇹',
    prefix: '+370',
    popular: false,
    placeholder: '612 34567',
  },
  {
    code: 'LU',
    name: 'Luxembourg',
    nameHe: 'לוקסמבורג',
    flag: '🇱🇺',
    prefix: '+352',
    popular: false,
    placeholder: '621 123 456',
  },
  {
    code: 'MX',
    name: 'Mexico',
    nameHe: 'מקסיקו',
    flag: '🇲🇽',
    prefix: '+52',
    popular: false,
    placeholder: '55 1234 5678',
  },
  {
    code: 'MD',
    name: 'Moldova',
    nameHe: 'מולדובה',
    flag: '🇲🇩',
    prefix: '+373',
    popular: false,
    placeholder: '621 12 345',
  },
  {
    code: 'NL',
    name: 'Netherlands',
    nameHe: 'הולנד',
    flag: '🇳🇱',
    prefix: '+31',
    popular: false,
    placeholder: '6 12345678',
  },
  {
    code: 'NZ',
    name: 'New Zealand',
    nameHe: 'ניו זילנד',
    flag: '🇳🇿',
    prefix: '+64',
    popular: false,
    placeholder: '21 123 4567',
  },
  {
    code: 'NO',
    name: 'Norway',
    nameHe: 'נורווגיה',
    flag: '🇳🇴',
    prefix: '+47',
    popular: false,
    placeholder: '412 34 567',
  },
  {
    code: 'PA',
    name: 'Panama',
    nameHe: 'פנמה',
    flag: '🇵🇦',
    prefix: '+507',
    popular: false,
    placeholder: '6123-4567',
  },
  {
    code: 'PE',
    name: 'Peru',
    nameHe: 'פרו',
    flag: '🇵🇪',
    prefix: '+51',
    popular: false,
    placeholder: '912 345 678',
  },
  {
    code: 'PL',
    name: 'Poland',
    nameHe: 'פולין',
    flag: '🇵🇱',
    prefix: '+48',
    popular: false,
    placeholder: '501 234 567',
  },
  {
    code: 'PT',
    name: 'Portugal',
    nameHe: 'פורטוגל',
    flag: '🇵🇹',
    prefix: '+351',
    popular: false,
    placeholder: '912 345 678',
  },
  {
    code: 'RO',
    name: 'Romania',
    nameHe: 'רומניה',
    flag: '🇷🇴',
    prefix: '+40',
    popular: false,
    placeholder: '712 345 678',
  },
  {
    code: 'RU',
    name: 'Russia',
    nameHe: 'רוסיה',
    flag: '🇷🇺',
    prefix: '+7',
    popular: false,
    placeholder: '912 123-45-67',
  },
  {
    code: 'RS',
    name: 'Serbia',
    nameHe: 'סרביה',
    flag: '🇷🇸',
    prefix: '+381',
    popular: false,
    placeholder: '60 1234567',
  },
  {
    code: 'SK',
    name: 'Slovakia',
    nameHe: 'סלובקיה',
    flag: '🇸🇰',
    prefix: '+421',
    popular: false,
    placeholder: '901 123 456',
  },
  {
    code: 'SI',
    name: 'Slovenia',
    nameHe: 'סלובניה',
    flag: '🇸🇮',
    prefix: '+386',
    popular: false,
    placeholder: '31 234 567',
  },
  {
    code: 'ZA',
    name: 'South Africa',
    nameHe: 'דרום אפריקה',
    flag: '🇿🇦',
    prefix: '+27',
    popular: false,
    placeholder: '82 123 4567',
  },
  {
    code: 'ES',
    name: 'Spain',
    nameHe: 'ספרד',
    flag: '🇪🇸',
    prefix: '+34',
    popular: false,
    placeholder: '612 34 56 78',
  },
  {
    code: 'SE',
    name: 'Sweden',
    nameHe: 'שבדיה',
    flag: '🇸🇪',
    prefix: '+46',
    popular: false,
    placeholder: '70 123 45 67',
  },
  {
    code: 'CH',
    name: 'Switzerland',
    nameHe: 'שוויץ',
    flag: '🇨🇭',
    prefix: '+41',
    popular: false,
    placeholder: '78 123 45 67',
  },
  {
    code: 'TR',
    name: 'Turkey',
    nameHe: 'טורקיה',
    flag: '🇹🇷',
    prefix: '+90',
    popular: false,
    placeholder: '531 234 56 78',
  },
  {
    code: 'UA',
    name: 'Ukraine',
    nameHe: 'אוקראינה',
    flag: '🇺🇦',
    prefix: '+380',
    popular: false,
    placeholder: '50 123 4567',
  },
  {
    code: 'UY',
    name: 'Uruguay',
    nameHe: 'אורוגוואי',
    flag: '🇺🇾',
    prefix: '+598',
    popular: false,
    placeholder: '91 123 456',
  },
  {
    code: 'VE',
    name: 'Venezuela',
    nameHe: 'ונצואלה',
    flag: '🇻🇪',
    prefix: '+58',
    popular: false,
    placeholder: '412-1234567',
  },
  {
    code: 'JP',
    name: 'Japan',
    nameHe: 'יפן',
    flag: '🇯🇵',
    prefix: '+81',
    popular: false,
    placeholder: '90-1234-5678',
  },
  {
    code: 'CN',
    name: 'China',
    nameHe: 'סין',
    flag: '🇨🇳',
    prefix: '+86',
    popular: false,
    placeholder: '138 0013 8000',
  },
  {
    code: 'KR',
    name: 'South Korea',
    nameHe: 'דרום קוריאה',
    flag: '🇰🇷',
    prefix: '+82',
    popular: false,
    placeholder: '10-1234-5678',
  },
];

interface PhoneNumberInputProps {
  value: string | undefined;
  onChange: (value: string | undefined) => void;
  disabled?: boolean;
  locale: 'he' | 'en';
  error?: string;
}

const PhoneNumberInput: React.FC<PhoneNumberInputProps> = ({
  value,
  onChange,
  disabled = false,
  locale,
  error,
}) => {
  const [selectedCountry, setSelectedCountry] = useState(COUNTRIES[0]);
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [phoneNumber, setPhoneNumber] = useState('');
  const [isManualPrefix, setIsManualPrefix] = useState(false);
  const [manualPrefix, setManualPrefix] = useState('');

  const dropdownRef = useRef<HTMLDivElement>(null);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  // סינון מדינות לפי חיפוש
  const filteredCountries = COUNTRIES.filter((country) => {
    const searchLower = searchTerm.toLowerCase();
    const name = locale === 'he' ? country.nameHe : country.name;
    return (
      name.toLowerCase().includes(searchLower) ||
      country.prefix.includes(searchTerm) ||
      country.code.toLowerCase().includes(searchLower)
    );
  });

  // מיון: פופולאריות קודם, אחר כך א"ב
  const sortedCountries = filteredCountries.sort((a, b) => {
    if (a.popular && !b.popular) return -1;
    if (!a.popular && b.popular) return 1;
    const nameA = locale === 'he' ? a.nameHe : a.name;
    const nameB = locale === 'he' ? b.nameHe : b.name;
    return nameA.localeCompare(nameB);
  });

  // עדכון הערך המלא
  const updateFullValue = (prefix: string, number: string) => {
    const fullNumber = number ? `${prefix}${number.replace(/\D/g, '')}` : '';
    onChange(fullNumber);
  };

  // טיפול בשינוי מספר טלפון
  const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setPhoneNumber(newValue);

    const currentPrefix = isManualPrefix
      ? manualPrefix
      : selectedCountry.prefix;
    updateFullValue(currentPrefix, newValue);
  };

  // טיפול בשינוי קידומת ידנית
  const handleManualPrefixChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let newPrefix = e.target.value;

    // וידוא שהקידומת מתחילה ב-+
    if (newPrefix && !newPrefix.startsWith('+')) {
      newPrefix = '+' + newPrefix;
    }

    setManualPrefix(newPrefix);
    updateFullValue(newPrefix, phoneNumber);
  };

  // בחירת מדינה
  const handleCountrySelect = (country: (typeof COUNTRIES)[0]) => {
    setSelectedCountry(country);
    setIsOpen(false);
    setSearchTerm('');
    setIsManualPrefix(false);
    setManualPrefix('');
    updateFullValue(country.prefix, phoneNumber);
  };

  // מעבר למצב קידומת ידנית
  const enableManualPrefix = () => {
    setIsManualPrefix(true);
    setManualPrefix(selectedCountry.prefix);
    setIsOpen(false);
  };

  // חזרה למצב בחירת מדינה
  const disableManualPrefix = () => {
    setIsManualPrefix(false);
    setManualPrefix('');
    updateFullValue(selectedCountry.prefix, phoneNumber);
  };

  // פירוק הערך הנכנס לקידומת ומספר
  useEffect(() => {
    if (value && value.startsWith('+')) {
      // נסה למצוא מדינה מתאימה
      const matchingCountry = COUNTRIES.find((country) =>
        value.startsWith(country.prefix)
      );

      if (matchingCountry) {
        setSelectedCountry(matchingCountry);
        setIsManualPrefix(false);
        setManualPrefix('');
        const numberPart = value.substring(matchingCountry.prefix.length);
        setPhoneNumber(numberPart);
      } else {
        // אם לא נמצאה מדינה מתאימה, השתמש בקידומת ידנית
        const prefixMatch = value.match(/^\+\d+/);
        if (prefixMatch) {
          setIsManualPrefix(true);
          setManualPrefix(prefixMatch[0]);
          const numberPart = value.substring(prefixMatch[0].length);
          setPhoneNumber(numberPart);
        }
      }
    } else if (!value) {
      setPhoneNumber('');
      setIsManualPrefix(false);
      setManualPrefix('');
    }
  }, [value]);

  // סגירת dropdown בלחיצה מחוץ
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        containerRef.current &&
        !containerRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
        setSearchTerm('');
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () =>
        document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);

  // פוקוס על חיפוש כשהרשימה נפתחת
  useEffect(() => {
    if (isOpen && searchInputRef.current) {
      setTimeout(() => searchInputRef.current?.focus(), 100);
    }
  }, [isOpen]);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Escape') {
      setIsOpen(false);
      setSearchTerm('');
    }
  };

  return (
    <div
      ref={containerRef}
      className="relative w-full"
      onKeyDown={handleKeyDown}
    >
      {/* 
          שינוי קריטי: הוספנו dir="ltr" כדי לכפות סדר אלמנטים משמאל לימין 
          (קידומת משמאל, שדה קלט מימין) גם כאשר שפת הדף היא עברית.
      */}
      <div className="flex gap-2" dir="ltr">
        {/* בוחר מדינה או קידומת ידנית */}
        <div className="relative">
          {isManualPrefix ? (
            // מצב קידומת ידנית
            <div className="flex items-center gap-1">
              <input
                type="text"
                value={manualPrefix}
                onChange={handleManualPrefixChange}
                placeholder="+1"
                disabled={disabled}
                className={`
                  w-20 px-2 py-3 text-sm border rounded-lg text-center font-mono
                  transition-all duration-200
                  ${
                    disabled
                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                      : 'bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
                  }
                  ${
                    error
                      ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                      : 'border-gray-300'
                  }
                `}
              />
              <button
                type="button"
                onClick={disableManualPrefix}
                disabled={disabled}
                className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                title={
                  locale === 'he'
                    ? 'חזור לבחירת מדינה'
                    : 'Back to country selection'
                }
              >
                <ChevronDown className="w-4 h-4" />
              </button>
            </div>
          ) : (
            // מצב בחירת מדינה
            <button
              type="button"
              onClick={() => !disabled && setIsOpen(!isOpen)}
              disabled={disabled}
              className={`
                flex items-center gap-2 px-3 py-3 border rounded-lg bg-white
                transition-all duration-200 min-w-[140px]
                ${
                  disabled
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    : 'hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
                }
                ${
                  error
                    ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                    : 'border-gray-300'
                }
                ${isOpen ? 'border-blue-500 ring-2 ring-blue-200' : ''}
              `}
              aria-expanded={isOpen}
              aria-haspopup="listbox"
            >
              <span className="text-lg">{selectedCountry.flag}</span>
              <span className="text-sm font-medium truncate">
                {locale === 'he'
                  ? selectedCountry.nameHe
                  : selectedCountry.name}
              </span>
              <span className="text-xs text-gray-500 font-mono">
                ({selectedCountry.prefix})
              </span>
              <ChevronDown
                className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${
                  isOpen ? 'rotate-180' : ''
                }`}
              />
            </button>
          )}

          {/* Dropdown */}
          <AnimatePresence>
            {isOpen && !isManualPrefix && (
              <motion.div
                ref={dropdownRef}
                initial={{ opacity: 0, y: -10, scale: 0.95 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                exit={{ opacity: 0, y: -10, scale: 0.95 }}
                transition={{ duration: 0.2 }}
                className="absolute top-full mt-1 left-0 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96"
              >
                {/* חיפוש - כאן אנחנו מכבדים את כיוון השפה עבור טקסט החיפוש */}
                <div
                  className="p-3 border-b border-gray-100"
                  dir={locale === 'he' ? 'rtl' : 'ltr'}
                >
                  <div className="relative">
                    <Search
                      className={`absolute top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 ${locale === 'he' ? 'right-3' : 'left-3'}`}
                    />
                    <input
                      ref={searchInputRef}
                      type="text"
                      placeholder={
                        locale === 'he' ? 'חפש מדינה...' : 'Search country...'
                      }
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className={`w-full py-2 text-sm border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:border-blue-500 ${locale === 'he' ? 'pr-10 pl-3' : 'pl-10 pr-3'}`}
                    />
                    {searchTerm && (
                      <button
                        type="button"
                        onClick={() => setSearchTerm('')}
                        className={`absolute top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 ${locale === 'he' ? 'left-3' : 'right-3'}`}
                      >
                        <X className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                </div>

                {/* אפשרות לקידומת ידנית */}
                <div
                  className="p-2 border-b border-gray-100"
                  dir={locale === 'he' ? 'rtl' : 'ltr'}
                >
                  <button
                    type="button"
                    onClick={enableManualPrefix}
                    className="w-full flex items-center gap-3 px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                  >
                    <Edit className="w-4 h-4" />
                    <span>
                      {locale === 'he'
                        ? 'הכנס קידומת בעצמך'
                        : 'Enter custom prefix'}
                    </span>
                  </button>
                </div>

                {/* רשימת מדינות */}
                <div className="max-h-60 overflow-y-auto">
                  {sortedCountries.length === 0 ? (
                    <div className="p-4 text-sm text-gray-500 text-center">
                      {locale === 'he'
                        ? 'לא נמצאו מדינות'
                        : 'No countries found'}
                    </div>
                  ) : (
                    sortedCountries.map((country) => (
                      <button
                        key={country.code}
                        type="button"
                        onClick={() => handleCountrySelect(country)}
                        className={`
                          w-full flex items-center gap-3 px-4 py-3 text-sm
                          hover:bg-blue-50 transition-colors duration-150
                          ${selectedCountry.code === country.code ? 'bg-blue-100 text-blue-700' : 'text-gray-700'}
                        `}
                        // כאן אנחנו שומרים על כיוון LTR כדי שהדגלים והמספרים יהיו בצד שמאל והטקסט מימין,
                        // גם בעברית זה נראה טוב ברשימות טלפונים
                        dir="ltr"
                      >
                        <span className="text-lg">{country.flag}</span>
                        <span className="flex-1 text-left">
                          {locale === 'he' ? country.nameHe : country.name}
                        </span>
                        <span className="text-xs text-gray-500 font-mono">
                          {country.prefix}
                        </span>
                        {country.popular && (
                          <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                        )}
                      </button>
                    ))
                  )}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>

        {/* שדה מספר טלפון */}
        <div className="flex-1 relative">
          <input
            type="tel"
            value={phoneNumber}
            onChange={handlePhoneChange}
            disabled={disabled}
            placeholder={
              isManualPrefix
                ? locale === 'he'
                  ? 'מספר טלפון'
                  : 'Phone number'
                : locale === 'he'
                  ? `לדוגמה: ${selectedCountry.placeholder}`
                  : `Example: ${selectedCountry.placeholder}`
            }
            // כיוון שהקונטיינר כולו LTR עכשיו, אנחנו רוצים יישור לשמאל תמיד כדי שזה יהיה צמוד לקידומת
            className={`
              w-full pl-3 pr-10 py-3 border rounded-lg
              transition-all duration-200 text-left
              ${
                disabled
                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                  : 'bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
              }
              ${
                error
                  ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                  : 'border-gray-300'
              }
            `}
            dir="ltr"
          />
          {/* האייקון ממוקם תמיד בימין כי הכל LTR */}
          <Phone className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
        </div>
      </div>

      {/* הודעת שגיאה */}
      {error && (
        <motion.p
          initial={{ opacity: 0, y: -5 }}
          animate={{ opacity: 1, y: 0 }}
          // הודעת השגיאה תמיד מיושרת לפי שפת הממשק
          className={`text-red-500 text-xs mt-2 ${locale === 'he' ? 'text-right' : 'text-left'}`}
        >
          {error}
        </motion.p>
      )}
    </div>
  );
};

export default PhoneNumberInput;
--- End of Content for PhoneNumberInput.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ProgressBar.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/ProgressBar.tsx
"use client";

import React from "react";
import { motion } from "framer-motion";

interface ProgressBarProps {
  currentStep: number;
  totalSteps: number;
  stepLabel: string;
  locale: 'he' | 'en';
}

const ProgressBar: React.FC<ProgressBarProps> = ({
  currentStep,
  totalSteps,
  stepLabel,
  locale,
}) => {
  const percentage = (currentStep / totalSteps) * 100;
  const steps = Array.from({ length: totalSteps }, (_, i) => i + 1);

  return (
    <div className="w-full relative" dir={locale === 'he' ? 'rtl' : 'ltr'}>
      {/* Step labels */}
      <div className="flex justify-between mb-2">
        {steps.map((step) => (
          <div
            key={step}
            className={`text-xs font-medium transition-colors duration-300 ${
              step <= currentStep ? "text-gray-800" : "text-gray-400"
            }`}
          >
            {stepLabel.replace('{{step}}', step.toString())}
          </div>
        ))}
      </div>

      {/* Progress bar track */}
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
        {/* UPDATED: Animated progress fill (Teal -> Orange -> Amber) */}
        <motion.div
          className="h-full bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"
          initial={{ width: `${((currentStep - 1) / totalSteps) * 100}%` }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.5, ease: "easeInOut" }}
        />
      </div>

      {/* Step markers */}
      <div className="relative flex justify-between mt-1">
        {steps.map((step) => (
          <motion.div
            key={step}
            className={`w-6 h-6 rounded-full flex items-center justify-center -mt-4 z-10 transition-all duration-300
              ${
                step <= currentStep
                  // UPDATED: Marker Color
                  ? "bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 shadow-md text-white"
                  : "bg-white border-2 border-gray-300 text-gray-500"
              }`}
            initial={{ scale: step === currentStep ? 0.8 : 1 }}
            animate={{ scale: step === currentStep ? 1.1 : 1 }}
            transition={{ duration: 0.3 }}
          >
            <span className="text-xs font-semibold">{step}</span>
          </motion.div>
        ))}
      </div>
    </div>
  );
};

export default ProgressBar;
--- End of Content for ProgressBar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\RegisterSteps.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/RegisterSteps.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { RegistrationProvider, useRegistration } from './RegistrationContext';
import Link from 'next/link';
import WelcomeStep from './steps/WelcomeStep';
import BasicInfoStep from './steps/BasicInfoStep';
import EmailVerificationCodeStep from './steps/EmailVerificationCodeStep';
import PersonalDetailsStep from './steps/PersonalDetailsStep';
import CompleteStep from './steps/CompleteStep';
import ProgressBar from './ProgressBar';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Info, Loader2 } from 'lucide-react';
import type { User as SessionUserType } from '@/types/next-auth';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface RegisterStepsProps {
  dict: RegisterStepsDict;
  locale: 'he' | 'en';
}

const RegisterStepsContent: React.FC<{
  dict: RegisterStepsDict;
  locale: 'he' | 'en';
}> = ({
  dict,
  locale,
}) => {
  const {
    data: registrationContextData,
    initializeFromSession,
    resetForm,
    goToStep,
  } = useRegistration();
  const router = useRouter();
  const { data: session, status: sessionStatus } = useSession();
  const searchParams = useSearchParams();

  const [showIncompleteProfileMessage, setShowIncompleteProfileMessage] =
    useState(false);
  const [initializationAttempted, setInitializationAttempted] = useState(false);

  useEffect(() => {
    const reasonParam = searchParams.get('reason');
    if (
      (reasonParam === 'complete_profile' || reasonParam === 'verify_phone') &&
      !registrationContextData.isCompletingProfile
    ) {
      setShowIncompleteProfileMessage(true);
    } else {
      setShowIncompleteProfileMessage(false);
    }
  }, [searchParams, registrationContextData.isCompletingProfile]);

  useEffect(() => {
    if (sessionStatus === 'loading') {
      return;
    }
    if (sessionStatus === 'authenticated' && session?.user) {
      const user = session.user as SessionUserType;
      
      if (
        user.isProfileComplete &&
        user.isPhoneVerified &&
        user.termsAndPrivacyAcceptedAt
      ) {
        if (
          typeof window !== 'undefined' &&
          window.location.pathname !== `/${locale}/profile`
        ) {
          router.push(`/${locale}/profile`);
        }
        return;
      }

      const needsSetup =
        !user.termsAndPrivacyAcceptedAt ||
        !user.isProfileComplete ||
        !user.isPhoneVerified;
        
      if (
        needsSetup &&
        (!initializationAttempted ||
          (registrationContextData.step === 0 &&
            !registrationContextData.isVerifyingEmailCode))
      ) {
        initializeFromSession(user);
        setInitializationAttempted(true);
      }
    } else if (sessionStatus === 'unauthenticated') {
      const registrationInProgress =
        registrationContextData.step > 0 ||
        registrationContextData.isVerifyingEmailCode;
      if (registrationInProgress) {
        resetForm();
      }
    }
  }, [
    sessionStatus,
    session,
    router,
    registrationContextData,
    initializeFromSession,
    resetForm,
    goToStep,
    initializationAttempted,
    searchParams,
    locale,
  ]);

  const renderStep = (): React.ReactNode => {
    if (sessionStatus === 'loading') {
      return (
        <div className="flex justify-center p-10">
          {/* UPDATED: Cyan -> Teal */}
          <Loader2 className="h-8 w-8 animate-spin text-teal-600" />
        </div>
      );
    }

    if (
      registrationContextData.isVerifyingEmailCode &&
      !registrationContextData.isCompletingProfile
    ) {
      return (
        <EmailVerificationCodeStep
          dict={dict.steps.emailVerification}
          locale={locale}
        />
      );
    }

    if (registrationContextData.isCompletingProfile) {
      switch (registrationContextData.step) {
        case 2:
          return (
            <PersonalDetailsStep
              personalDetailsDict={dict.steps.personalDetails}
              optionalInfoDict={dict.steps.optionalInfo}
              consentDict={dict.consentCheckbox}
              locale={locale}
            />
          );
        case 4:
          return <CompleteStep dict={dict.steps.complete} />;
        default:
          resetForm();
          return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
      }
    }

    switch (registrationContextData.step) {
      case 0:
        return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
      case 1:
        return (
          <BasicInfoStep
            dict={dict.steps.basicInfo}
            consentDict={dict.consentCheckbox}
            locale={locale}
          />
        );
      default:
        resetForm();
        return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
    }
  };

  let pageTitle = dict.headers.registerTitle;
  let stepDescription = dict.headers.welcomeDescription;
  let currentProgressBarStep = 0;
  const totalProgressBarSteps = 3;
  let showProgressBar = false;

  if (
    registrationContextData.isVerifyingEmailCode &&
    !registrationContextData.isCompletingProfile
  ) {
    pageTitle = dict.headers.verifyEmailTitle;
    stepDescription = dict.headers.verifyEmailDescription.replace(
      '{{email}}',
      registrationContextData.emailForVerification || ''
    );
    showProgressBar = true;
    currentProgressBarStep = 1;

  } else if (registrationContextData.isCompletingProfile) {
    pageTitle = dict.headers.completeProfileTitle;
    showProgressBar = false; 

    if (registrationContextData.step === 2) {
      stepDescription = session?.user?.termsAndPrivacyAcceptedAt
        ? dict.headers.personalDetailsConsentedDescription
        : dict.headers.personalDetailsDescription;
    } else if (registrationContextData.step === 4) {
      stepDescription = session?.user?.isPhoneVerified
        ? dict.headers.completionReadyDescription
        : dict.headers.completionPhoneVerificationDescription;
    } else {
      stepDescription = dict.headers.loadingProfileDescription;
    }

  } else {
    if (registrationContextData.step === 1) {
      pageTitle = dict.headers.registerTitle;
      stepDescription = dict.headers.accountCreationDescription;
      currentProgressBarStep = 1;
      showProgressBar = true;
    }
  }

  return (
    // UPDATED: Background Gradient (Teal/Orange/Slate)
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 via-teal-50/40 to-orange-50/40 p-4 sm:p-8">
      <div className="mb-6 text-center">
        {/* UPDATED: Text Gradient (Teal -> Orange -> Amber) */}
        <h1 className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500 text-3xl font-bold mb-2">
          {pageTitle}
        </h1>
        <p className="text-gray-600 max-w-md mx-auto">{stepDescription}</p>
      </div>

      {showIncompleteProfileMessage && (
        // UPDATED: Yellow/Amber alerts match the new palette well
        <Alert className="mb-6 w-full max-w-md bg-amber-50 border-amber-200 text-amber-800 shadow-md">
          <Info className="h-5 w-5 text-amber-600 flex-shrink-0 mt-1" />
          <div className="ml-3 rtl:mr-3 rtl:ml-0">
            <AlertTitle className="font-semibold mb-1">
              {dict.incompleteProfileAlert.title}
            </AlertTitle>
            <AlertDescription className="text-sm">
              {searchParams.get('reason') === 'verify_phone'
                ? dict.incompleteProfileAlert.verifyPhoneDescription
                : dict.incompleteProfileAlert.description}
            </AlertDescription>
          </div>
        </Alert>
      )}

      {showProgressBar && (
        <div className="w-full max-w-md mb-6">
          <ProgressBar
            currentStep={currentProgressBarStep}
            totalSteps={totalProgressBarSteps}
            stepLabel={dict.progressBar.stepLabel}
            locale={locale}
          />
        </div>
      )}

      <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative border border-white/50">
        <div className="p-6 sm:p-8">{renderStep()}</div>
      </div>

      <div className="mt-8 text-center text-sm text-gray-500">
        {dict.contactSupport}{' '}
        {/* UPDATED: Link Color (Teal) */}
        <Link href="/contact" className="text-teal-600 hover:underline hover:text-teal-700">
          {dict.contactSupportLink}
        </Link>
      </div>
    </div>
  );
};

export default function RegisterSteps({ dict, locale }: RegisterStepsProps) {
  return (
    <RegistrationProvider>
      <RegisterStepsContent dict={dict} locale={locale} />
    </RegistrationProvider>
  );
}
--- End of Content for RegisterSteps.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\RegistrationContext.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/RegistrationContext.tsx

'use client';

import React, {
  createContext,
  useContext,
  useState,
  ReactNode,
  useCallback,
} from 'react';
import { Gender, UserStatus, UserSource } from '@prisma/client';
import type { User as SessionUserType } from '@/types/next-auth';

export interface RegistrationData {
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  phone: string;
  gender: Gender | '';
  birthDate: string;
  maritalStatus: string;
  height?: number;
  occupation?: string;
  education?: string;
  religiousLevel?: string;
  
  // שדות חדשים שהוספו לתיקון השגיאות
  city: string;
  hasChildren: boolean;
  numberOfChildren: string;
  profession: string;
  termsAccepted: boolean;

  // שדות ניהול מצב
  step: number;
  isGoogleSignup: boolean;
  language: 'he' | 'en'; 
  isCompletingProfile: boolean;
  isVerifyingEmailCode: boolean;
  emailForVerification: string | null;
}

const initialRegistrationData: RegistrationData = {
  email: '',
  password: '',
  firstName: '',
  lastName: '',
  phone: '',
  gender: '',
  birthDate: '',
  maritalStatus: '',
  height: undefined,
  occupation: '',
  education: '',
  religiousLevel: '',

  // אתחול שדות חדשים
  city: '',
  hasChildren: false,
  numberOfChildren: '',
  profession: '',
  termsAccepted: false,

  step: 0,
  isGoogleSignup: false,
  language: 'he',
  isCompletingProfile: false,
  isVerifyingEmailCode: false,
  emailForVerification: null,
};

interface RegistrationContextType {
  data: RegistrationData;
  setData: React.Dispatch<React.SetStateAction<RegistrationData>>;
  updateField: <K extends keyof RegistrationData>(
    field: K,
    value: RegistrationData[K]
  ) => void;
  nextStep: () => void;
  prevStep: () => void;
  goToStep: (step: number) => void;
  resetForm: () => void;
  setGoogleSignup: (googleUserData: {
    email: string;
    firstName?: string;
    lastName?: string;
  }) => void;
  initializeFromSession: (sessionUser: SessionUserType) => void;
  proceedToEmailVerification: (email: string) => void;
  completeEmailVerification: () => void;
  exitEmailVerification: () => void;
}

const RegistrationContext = createContext<RegistrationContextType | undefined>(undefined);

export const RegistrationProvider: React.FC<{ children: ReactNode }> = ({
  children,
}) => {
  const [data, setData] = useState<RegistrationData>(initialRegistrationData);

  const updateField = useCallback(
    <K extends keyof RegistrationData>(
      field: K,
      value: RegistrationData[K]
    ) => {
      setData((prev) => ({ ...prev, [field]: value }));
    },
    []
  );

  const nextStep = useCallback(() => {
    setData((prev) => ({ ...prev, step: prev.step + 1 }));
  }, []);

  const prevStep = useCallback(() => {
    setData((prev) => ({ ...prev, step: prev.step > 0 ? prev.step - 1 : 0 }));
  }, []);

  const goToStep = useCallback((stepNum: number) => {
    setData((prev) => ({ ...prev, step: stepNum }));
  }, []);

  const resetForm = useCallback(() => {
    setData(initialRegistrationData);
  }, []);
  
  const setGoogleSignup = useCallback(
    (googleUserData: {
      email: string;
      firstName?: string;
      lastName?: string;
    }) => {
      setData({
        ...initialRegistrationData,
        email: googleUserData.email,
        isGoogleSignup: true,
      });
    },
    []
  );
  
  const initializeFromSession = useCallback((sessionUser: SessionUserType) => {
    setData((prevData) => {
      const isGoogleAcc = !!(
        sessionUser.source === UserSource.REGISTRATION &&
        sessionUser.accounts?.some((acc) => acc.provider === 'google')
      );

      const sessionGender: Gender | '' = sessionUser.profile?.gender || '';

      // המרת נתונים מהסשן למבנה הנתונים של הטופס
      const baseStateFromSession = {
        email: sessionUser.email || '',
        firstName: sessionUser.firstName || '',
        lastName: sessionUser.lastName || '',
        phone: sessionUser.phone || '',
        gender: sessionGender,
        birthDate: sessionUser.profile?.birthDate
          ? new Date(sessionUser.profile.birthDate).toISOString().split('T')[0]
          : '',
        maritalStatus: sessionUser.profile?.maritalStatus || '',
        height: sessionUser.profile?.height ?? undefined,
        occupation: sessionUser.profile?.occupation || '',
        education: sessionUser.profile?.education || '',
        
        // מיפוי שדות חדשים מהפרופיל (אם קיימים בטיפוס של הסשן, אחרת ברירת מחדל)
        city: (sessionUser.profile as any)?.city || '',
        profession: (sessionUser.profile as any)?.profession || '',
        numberOfChildren: (sessionUser.profile as any)?.numberOfChildren || '',
        hasChildren: (sessionUser.profile as any)?.hasChildren || false,
        termsAccepted: !!sessionUser.termsAndPrivacyAcceptedAt,
      };

      // Scenario 1: New user needs to verify email (non-Google)
      if (
        sessionUser.status === UserStatus.PENDING_EMAIL_VERIFICATION &&
        !isGoogleAcc &&
        !sessionUser.isVerified
      ) {
        return {
          ...initialRegistrationData,
          ...baseStateFromSession,
          isVerifyingEmailCode: true,
          emailForVerification: sessionUser.email,
          step: 1,
          isCompletingProfile: false,
          isGoogleSignup: false,
        };
      }

      // Scenario 2: User needs to start the profile completion process.
      if (!sessionUser.isProfileComplete) {
        return {
          ...initialRegistrationData,
          ...baseStateFromSession,
          isCompletingProfile: true,
          isGoogleSignup: isGoogleAcc,
          step: 2, // Always start at the combined personal details step
          isVerifyingEmailCode: false,
        };
      }
      
      // If code reaches here, it means profile is complete.
      return {
        ...prevData,
        ...baseStateFromSession,
        isGoogleSignup: isGoogleAcc,
      };
    });
  }, []);

  const proceedToEmailVerification = useCallback((emailToVerify: string) => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: true,
      emailForVerification: emailToVerify,
    }));
  }, []);

  const completeEmailVerification = useCallback(() => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: false,
      emailForVerification: null,
      isCompletingProfile: true,
      step: 2,
    }));
  }, []);

  const exitEmailVerification = useCallback(() => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: false,
      emailForVerification: null,
      step: 1,
    }));
  }, []);

  const value: RegistrationContextType = {
    data,
    setData,
    updateField,
    nextStep,
    prevStep,
    goToStep,
    resetForm,
    setGoogleSignup,
    initializeFromSession,
    proceedToEmailVerification,
    completeEmailVerification,
    exitEmailVerification,
  };

  return (
    <RegistrationContext.Provider value={value}>
      {children}
    </RegistrationContext.Provider>
  );
};

export const useRegistration = (): RegistrationContextType => {
  const context = useContext(RegistrationContext);
  if (context === undefined) {
    throw new Error(
      'useRegistration must be used within a RegistrationProvider'
    );
  }
  return context;
};
--- End of Content for RegistrationContext.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ResetPasswordForm.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/ResetPasswordForm.tsx
'use client';

import { useState, FormEvent, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Lock,
  KeySquare,
  Loader2,
  AlertCircle,
  CheckCircle,
  Eye,
  EyeOff,
  Mail,
} from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import Link from 'next/link';

// Password validation function (similar to your RegisterForm)
const validatePassword = (value: string): string | null => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  if (!passwordRegex.test(value)) {
    return 'הסיסמה חייבת להכיל לפחות 8 תווים, אות גדולה, אות קטנה ומספר.';
  }
  return null;
};

export default function ResetPasswordForm() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [email, setEmail] = useState(''); // To prefill if passed, or keep empty
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [passwordError, setPasswordError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  useEffect(() => {
    const emailFromQuery = searchParams.get('email');
    const tokenFromQuery = searchParams.get('token'); // If you decide to also prefill OTP via token

    if (emailFromQuery) {
      setEmail(emailFromQuery);
    }
    if (tokenFromQuery) {
      // This 'token' from query is the OTP
      setOtp(tokenFromQuery);
    }
  }, [searchParams]);

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setPasswordError(null);
    setSuccessMessage(null);

    if (!email) {
      setError('כתובת המייל חסרה. אנא חזור להתחלה ונסה שנית.');
      setIsLoading(false);
      return;
    }
    if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
      setError('קוד האימות (OTP) חייב להיות בן 6 ספרות.');
      setIsLoading(false);
      return;
    }
    const passValidationError = validatePassword(newPassword);
    if (passValidationError) {
      setPasswordError(passValidationError);
      setIsLoading(false);
      return;
    }
    if (newPassword !== confirmPassword) {
      setError('הסיסמאות אינן תואמות.');
      setIsLoading(false);
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp, newPassword }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'אירעה שגיאה באיפוס הסיסמה.');
      }

      setSuccessMessage(
        data.message || 'הסיסמה אופסה בהצלחה! כעת תוכל להתחבר עם הסיסמה החדשה.'
      );
      // Clear fields on success
      setOtp('');
      setNewPassword('');
      setConfirmPassword('');
      // Optionally redirect after a delay or with a button
      setTimeout(() => {
        router.push('/auth/signin?reset=success');
      }, 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'אירעה שגיאה לא צפויה.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative">
      <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-cyan-500 to-pink-500"></div>
      <div className="p-6 sm:p-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">איפוס סיסמה</h1>
          <p className="text-gray-600 text-sm">
            הזן את קוד האימות (OTP) שקיבלת במייל ואת הסיסמה החדשה שלך.
          </p>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>שגיאה</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        {passwordError && !error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>שגיאת סיסמה</AlertTitle>
            <AlertDescription id="password-error-message">
              {passwordError}
            </AlertDescription>
          </Alert>
        )}

        {successMessage && (
          <Alert
            variant="default"
            className="mb-4 bg-green-50 border-green-200 text-green-700"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <AlertTitle>הצלחה!</AlertTitle>
            <AlertDescription>
              {successMessage} אתה מועבר לדף ההתחברות...
            </AlertDescription>
          </Alert>
        )}

        {!successMessage && ( // Only show form if no success message
          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1">
              <label
                htmlFor="email-reset"
                className="block text-sm font-medium text-gray-700"
              >
                כתובת מייל (לאימות) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="email"
                  id="email-reset"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@example.com"
                  required
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
                  disabled={isLoading || !!searchParams.get('email')} // Disable if email came from query
                />
              </div>
            </div>
            <div className="space-y-1">
              <label
                htmlFor="otp-reset"
                className="block text-sm font-medium text-gray-700"
              >
                קוד אימות (OTP) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <KeySquare className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="text"
                  id="otp-reset"
                  value={otp}
                  onChange={(e) =>
                    setOtp(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))
                  }
                  placeholder="xxxxxx"
                  maxLength={6}
                  required
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none tracking-widest text-center"
                  disabled={isLoading}
                  inputMode="numeric"
                />
              </div>
            </div>

            <div className="space-y-1">
              <label
                htmlFor="new-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                סיסמה חדשה <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showPassword ? 'text' : 'password'}
                  id="new-password-reset"
                  aria-describedby={
                    passwordError ? 'password-error-message' : 'password-hint'
                  }
                  aria-invalid={!!passwordError}
                  value={newPassword}
                  onChange={(e) => {
                    setNewPassword(e.target.value);
                    const validationErr = validatePassword(e.target.value);
                    if (e.target.value && validationErr)
                      setPasswordError(validationErr);
                    else setPasswordError(null);
                  }}
                  placeholder="לפחות 8 תווים, אות גדולה, קטנה ומספר"
                  required
                  className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none ${
                    passwordError
                      ? 'border-red-500 focus:ring-red-200'
                      : 'border-gray-300 focus:ring-cyan-200 focus:border-cyan-500'
                  }`}
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showPassword ? 'הסתר סיסמה' : 'הצג סיסמה'}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
              {!passwordError && (
                <p id="password-hint" className="mt-1 text-xs text-gray-500">
                  חייבת להכיל לפחות 8 תווים, אות גדולה, אות קטנה ומספר.
                </p>
              )}
            </div>

            <div className="space-y-1">
              <label
                htmlFor="confirm-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                אימות סיסמה חדשה <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showConfirmPassword ? 'text' : 'password'}
                  id="confirm-password-reset"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder="הזן את הסיסמה החדשה שוב"
                  required
                  className="w-full pr-10 pl-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showConfirmPassword ? 'הסתר סיסמה' : 'הצג סיסמה'}
                >
                  {showConfirmPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </div>

            <Button
              type="submit"
              disabled={
                isLoading ||
                !!passwordError ||
                !otp ||
                !newPassword ||
                !confirmPassword ||
                newPassword !== confirmPassword
              }
              className="w-full py-3 bg-gradient-to-r from-cyan-500 to-pink-500 hover:from-cyan-600 hover:to-pink-600 shadow-lg flex items-center justify-center gap-2"
            >
              {isLoading ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin mr-2" />
                  <span>מאפס סיסמה...</span>
                </>
              ) : (
                'אפס סיסמה'
              )}
            </Button>
          </form>
        )}

        <div className="mt-6 text-center">
          <Link
            href="/auth/signin"
            className="text-sm text-cyan-600 hover:text-cyan-700 hover:underline"
          >
            חזרה להתחברות
          </Link>
        </div>
      </div>
    </div>
  );
}
--- End of Content for ResetPasswordForm.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\VerifyEmailClient.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/VerifyEmailClient.tsx
'use client';

import React, {
  useState,
  useRef,
  useEffect,
  KeyboardEvent,
  ClipboardEvent,
} from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Mail,
  CheckCircle,
  AlertCircle,
  Loader2,
  ArrowLeft,
  RefreshCw,
  Sparkles,
  Shield,
  Clock,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

interface VerifyEmailClientProps {
  locale: 'he' | 'en';
}

type VerificationStatus = 'idle' | 'verifying' | 'success' | 'error';

export default function VerifyEmailClient({ locale }: VerifyEmailClientProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const email = searchParams.get('email') || '';
  const isHebrew = locale === 'he';

  // State Management
  const [code, setCode] = useState<string[]>(Array(6).fill(''));
  const [status, setStatus] = useState<VerificationStatus>('idle');
  const [errorMessage, setErrorMessage] = useState<string>('');
  const [canResend, setCanResend] = useState(false);
  const [resendCountdown, setResendCountdown] = useState(60);
  const [isResending, setIsResending] = useState(false);

  // Refs for input boxes
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  // Countdown timer for resend
  useEffect(() => {
    if (resendCountdown > 0) {
      const timer = setTimeout(
        () => setResendCountdown(resendCountdown - 1),
        1000
      );
      return () => clearTimeout(timer);
    } else {
      setCanResend(true);
    }
  }, [resendCountdown]);

  // Auto-submit when all 6 digits are filled
  useEffect(() => {
    const fullCode = code.join('');
    if (fullCode.length === 6 && status === 'idle') {
      handleVerifyCode(fullCode);
    }
  }, [code, status]);

  const handleInputChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value)) return;
    const newCode = [...code];
    newCode[index] = value.slice(-1);
    setCode(newCode);
    if (value && index < 5) {
      inputRefs.current[index + 1]?.focus();
    }
  };

  const handleKeyDown = (index: number, e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Backspace' && !code[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const handlePaste = (e: ClipboardEvent<HTMLInputElement>) => {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text').trim();
    if (/^\d{6}$/.test(pastedData)) {
      const newCode = pastedData.split('');
      setCode(newCode);
      inputRefs.current[5]?.focus();
    }
  };

  const handleVerifyCode = async (verificationCode: string) => {
    setStatus('verifying');
    setErrorMessage('');

    try {
      const response = await fetch('/api/auth/verify-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code: verificationCode }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'אירעה שגיאה באימות הקוד');
      }

      setStatus('success');

      setTimeout(() => {
        router.push(
          `/${locale}/auth/register?step=personal-details&email=${encodeURIComponent(email)}`
        );
      }, 2000);
    } catch (error) {
      setStatus('error');
      setErrorMessage(
        error instanceof Error ? error.message : 'אירעה שגיאה לא צפויה'
      );
      setCode(Array(6).fill(''));
      inputRefs.current[0]?.focus();
    }
  };

  const handleResendCode = async () => {
    setIsResending(true);
    setErrorMessage('');

    try {
      const response = await fetch('/api/auth/resend-verification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'אירעה שגיאה בשליחת הקוד');
      }

      setCanResend(false);
      setResendCountdown(60);
      setCode(Array(6).fill(''));
      inputRefs.current[0]?.focus();
    } catch (error) {
      setErrorMessage(
        error instanceof Error ? error.message : 'אירעה שגיאה בשליחת הקוד'
      );
    } finally {
      setIsResending(false);
    }
  };

  // Dictionary
  const dict = {
    title: isHebrew ? 'אמת את כתובת המייל שלך' : 'Verify Your Email',
    subtitle: isHebrew
      ? 'שלחנו קוד אימות בן 6 ספרות למייל שלך'
      : 'We sent a 6-digit verification code to your email',
    emailSentTo: isHebrew ? 'נשלח אל:' : 'Sent to:',
    enterCode: isHebrew ? 'הזן את הקוד כאן' : 'Enter the code here',
    verifying: isHebrew ? 'מאמת...' : 'Verifying...',
    success: isHebrew ? 'אומת בהצלחה!' : 'Verified Successfully!',
    successMessage: isHebrew
      ? 'המייל שלך אומת. מעביר אותך להמשך התהליך...'
      : 'Your email has been verified. Redirecting...',
    errorTitle: isHebrew ? 'קוד שגוי' : 'Invalid Code',
    resendCode: isHebrew ? 'שלח קוד מחדש' : 'Resend Code',
    resendIn: isHebrew ? 'שלח שוב בעוד' : 'Resend in',
    seconds: isHebrew ? 'שניות' : 'seconds',
    didntReceive: isHebrew ? 'לא קיבלת את הקוד?' : "Didn't receive the code?",
    checkSpam: isHebrew
      ? 'בדוק את תיבת הספאם או שלח שוב'
      : 'Check your spam folder or resend',
    backToRegister: isHebrew ? 'חזרה להרשמה' : 'Back to Registration',
    securityNote: isHebrew
      ? 'הקוד תקף ל-15 דקות מרגע השליחה'
      : 'Code is valid for 15 minutes from sending',
  };

  return (
    // UPDATED: Main Background (Slate/Teal/Orange)
    <div className="min-h-screen w-full bg-gradient-to-br from-slate-50 via-teal-50/40 to-orange-50/40 flex items-center justify-center p-4 relative overflow-hidden">
      {/* UPDATED: Decorative Orbs (Teal/Orange/Rose) */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <motion.div
          animate={{ scale: [1, 1.2, 1], opacity: [0.3, 0.5, 0.3] }}
          transition={{ duration: 8, repeat: Infinity, ease: 'easeInOut' }}
          // Teal Orb
          className="absolute top-20 left-10 w-64 h-64 bg-teal-200/40 rounded-full blur-3xl"
        />
        <motion.div
          animate={{ scale: [1, 1.3, 1], opacity: [0.3, 0.5, 0.3] }}
          transition={{
            duration: 10,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 2,
          }}
          // Orange Orb
          className="absolute bottom-20 right-10 w-72 h-72 bg-orange-200/40 rounded-full blur-3xl"
        />
        <motion.div
          animate={{ scale: [1, 1.15, 1], opacity: [0.2, 0.4, 0.2] }}
          transition={{
            duration: 12,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 4,
          }}
          // Rose/Purple Orb (Center)
          className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-rose-200/30 rounded-full blur-3xl"
        />
      </div>

      {/* Main Card */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6 }}
        className="relative w-full max-w-md"
      >
        <div className="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/60 overflow-hidden">
          {/* UPDATED: Gradient Header (Teal -> Orange -> Amber) */}
          <div className="h-2 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"></div>

          <div className="p-8 sm:p-10">
            {/* Icon & Title Section */}
            <motion.div
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              transition={{ delay: 0.2, duration: 0.5 }}
              className="text-center mb-8"
            >
              <div className="relative inline-block mb-6">
                <motion.div
                  animate={{ rotate: [0, 5, -5, 0] }}
                  transition={{
                    duration: 4,
                    repeat: Infinity,
                    ease: 'easeInOut',
                  }}
                  // UPDATED: Main Icon Background (Teal -> Emerald)
                  className="w-20 h-20 rounded-2xl bg-gradient-to-br from-teal-400 to-emerald-600 flex items-center justify-center shadow-lg shadow-teal-500/20"
                >
                  <Mail className="w-10 h-10 text-white" strokeWidth={2.5} />
                </motion.div>
                <motion.div
                  animate={{ scale: [1, 1.2, 1], opacity: [0.5, 1, 0.5] }}
                  transition={{ duration: 2, repeat: Infinity }}
                  // UPDATED: Sparkle Background (Amber/Orange)
                  className="absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center"
                >
                  <Sparkles className="w-4 h-4 text-white" />
                </motion.div>
              </div>

              <h1 className="text-3xl font-bold text-gray-800 mb-3">
                {dict.title}
              </h1>
              <p className="text-gray-600 text-base mb-4">{dict.subtitle}</p>

              {/* UPDATED: Email Badge (Teal/Gray) */}
              <div className="inline-flex items-center gap-2 px-4 py-2 bg-slate-50 rounded-full border border-slate-200">
                <Mail className="w-4 h-4 text-teal-600" />
                <span className="text-sm font-medium text-gray-700">
                  {dict.emailSentTo}{' '}
                  <span className="text-teal-700 font-bold">{email}</span>
                </span>
              </div>
            </motion.div>

            {/* Code Input Section */}
            <motion.div
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3, duration: 0.5 }}
              className="mb-8"
            >
              <label className="block text-sm font-medium text-gray-700 mb-4 text-center">
                {dict.enterCode}
              </label>

              <div
                className="flex justify-center gap-2 sm:gap-3 mb-6"
                dir="ltr"
              >
                {code.map((digit, index) => (
                  <motion.input
                    key={index}
                    ref={(el) => {
                      inputRefs.current[index] = el;
                    }}
                    type="text"
                    inputMode="numeric"
                    maxLength={1}
                    value={digit}
                    onChange={(e) => handleInputChange(index, e.target.value)}
                    onKeyDown={(e) => handleKeyDown(index, e)}
                    onPaste={index === 0 ? handlePaste : undefined}
                    disabled={status === 'verifying' || status === 'success'}
                    whileFocus={{ scale: 1.05 }}
                    // UPDATED: Input Colors (Teal Focus/Fill)
                    className={`
                      w-12 h-14 sm:w-14 sm:h-16 text-center text-2xl font-bold rounded-xl
                      border-2 transition-all duration-200
                      ${
                        status === 'error'
                          ? 'border-red-400 bg-red-50 text-red-600'
                          : status === 'success'
                            ? 'border-green-400 bg-green-50 text-green-600'
                            : digit
                              ? 'border-teal-400 bg-teal-50 text-gray-800'
                              : 'border-gray-200 bg-white text-gray-800 hover:border-teal-200'
                      }
                      focus:outline-none focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500
                      disabled:opacity-60 disabled:cursor-not-allowed
                    `}
                  />
                ))}
              </div>

              {/* Status Messages */}
              <AnimatePresence mode="wait">
                {status === 'verifying' && (
                  // UPDATED: Text Color (Teal)
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="flex items-center justify-center gap-2 text-teal-600 mb-4"
                  >
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span className="text-sm font-medium">
                      {dict.verifying}
                    </span>
                  </motion.div>
                )}

                {status === 'success' && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="text-center mb-4"
                  >
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      transition={{
                        type: 'spring',
                        stiffness: 200,
                        damping: 15,
                      }}
                      className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-full border-2 border-green-400 mb-2"
                    >
                      <CheckCircle className="w-6 h-6 text-green-600" />
                      <span className="text-green-700 font-bold">
                        {dict.success}
                      </span>
                    </motion.div>
                    <p className="text-sm text-gray-600">
                      {dict.successMessage}
                    </p>
                  </motion.div>
                )}

                {status === 'error' && errorMessage && (
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-200 rounded-xl p-4 mb-4"
                  >
                    <div className="flex items-start gap-3">
                      <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                      <div>
                        <p className="font-semibold text-red-800 text-sm mb-1">
                          {dict.errorTitle}
                        </p>
                        <p className="text-red-600 text-sm">{errorMessage}</p>
                      </div>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>

              {/* Resend Section */}
              {status !== 'success' && (
                <div className="text-center space-y-3">
                  <p className="text-sm text-gray-600">{dict.didntReceive}</p>

                  {canResend ? (
                    <Button
                      onClick={handleResendCode}
                      disabled={isResending}
                      variant="outline"
                      size="sm"
                      // UPDATED: Resend Button (Teal Border/Text)
                      className="border-2 border-teal-200 text-teal-700 hover:bg-teal-50 hover:border-teal-300 rounded-full px-6 py-2 transition-all"
                    >
                      {isResending ? (
                        <>
                          <Loader2 className="w-4 h-4 animate-spin mr-2" />
                          {isHebrew ? 'שולח...' : 'Sending...'}
                        </>
                      ) : (
                        <>
                          <RefreshCw className="w-4 h-4 mr-2" />
                          {dict.resendCode}
                        </>
                      )}
                    </Button>
                  ) : (
                    <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full border border-gray-200">
                      <Clock className="w-4 h-4 text-gray-500" />
                      <span className="text-sm text-gray-600">
                        {dict.resendIn}{' '}
                        <span className="font-bold text-gray-800">
                          {resendCountdown}
                        </span>{' '}
                        {dict.seconds}
                      </span>
                    </div>
                  )}

                  <p className="text-xs text-gray-500 italic">
                    {dict.checkSpam}
                  </p>
                </div>
              )}
            </motion.div>

            {/* UPDATED: Security Note (Warm/Amber background) */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.5, duration: 0.5 }}
              className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100 mb-6"
            >
              <div className="flex items-start gap-3">
                <Shield className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                <p className="text-sm text-amber-800">{dict.securityNote}</p>
              </div>
            </motion.div>

            {/* Back Link */}
            <div className="text-center">
              <Link
                href={`/${locale}/auth/register`}
                // UPDATED: Link Hover (Teal)
                className="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-teal-600 transition-colors group"
              >
                <ArrowLeft
                  className={`w-4 h-4 group-hover:-translate-x-1 transition-transform ${isHebrew ? '' : 'rotate-180'}`}
                />
                <span>{dict.backToRegister}</span>
              </Link>
            </div>
          </div>
        </div>

        {/* Floating Decorative Elements */}
        <motion.div
          animate={{ y: [0, -10, 0], rotate: [0, 5, 0] }}
          transition={{ duration: 6, repeat: Infinity, ease: 'easeInOut' }}
          // Teal Blob
          className="absolute -top-6 -right-6 w-16 h-16 bg-gradient-to-br from-teal-400 to-emerald-500 rounded-2xl opacity-20 blur-xl"
        />
        <motion.div
          animate={{ y: [0, 10, 0], rotate: [0, -5, 0] }}
          transition={{
            duration: 7,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 1,
          }}
          // Orange Blob
          className="absolute -bottom-6 -left-6 w-20 h-20 bg-gradient-to-br from-orange-400 to-amber-500 rounded-2xl opacity-20 blur-xl"
        />
      </motion.div>

      <style>{`
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type='number'] {
          -moz-appearance: textfield;
        }
      `}</style>
    </div>
  );
}
--- End of Content for VerifyEmailClient.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\BasicInfoStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/BasicInfoStep.tsx
'use client';

import { useState, useEffect } from 'react';
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import {
  ArrowLeft,
  ArrowRight,
  User,
  Mail,
  Lock,
  AlertCircle,
  Loader2,
  Eye,
  EyeOff,
} from 'lucide-react';
import { motion } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';
import { Input } from '@/components/ui/input';

interface BasicInfoStepProps {
  dict: RegisterStepsDict['steps']['basicInfo'];
  consentDict: RegisterStepsDict['consentCheckbox']; 
  locale: 'he' | 'en';
}

const isValidEmail = (email: string): boolean => {
  const emailRegex = /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i;
  return email.trim() !== '' && emailRegex.test(email);
};

const isValidPassword = (password: string): boolean => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  return passwordRegex.test(password);
};

const BasicInfoStep: React.FC<BasicInfoStepProps> = ({ dict, consentDict, locale }) => {
  const { data, updateField, prevStep, proceedToEmailVerification } = useRegistration();
  
  // States for validation and UI
  const [passwordError, setPasswordError] = useState('');
  const [emailError, setEmailError] = useState('');
  const [isFormValid, setIsFormValid] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [passwordVisible, setPasswordVisible] = useState(false);

  useEffect(() => {
    const isEmailValid = isValidEmail(data.email);
    const isPasswordValid = isValidPassword(data.password);
    const isNameValid = data.firstName.trim().length > 0 && data.lastName.trim().length > 0;

    setIsFormValid(
      isEmailValid &&
      isPasswordValid &&
      isNameValid &&
      !isLoading
    );
  }, [data.email, data.password, data.firstName, data.lastName, isLoading]);

  const handleRegisterSubmit = async () => {
    if (!isFormValid) {
      setApiError(dict.errors.fillFields);
      return;
    }

    setIsLoading(true);
    setApiError(null);

    try {
      const response = await fetch(`/api/auth/register?locale=${locale}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: data.email,
          password: data.password,
          firstName: data.firstName,
          lastName: data.lastName,
          language: data.language,
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || dict.errors.default);
      }

      proceedToEmailVerification(result.email);
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
    } finally {
      setIsLoading(false);
    }
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-5"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {apiError && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{apiError}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      <motion.h2 className="text-xl font-bold text-gray-800 mb-4" variants={itemVariants}>
        {dict.title}
      </motion.h2>

      <motion.div variants={itemVariants} className="space-y-4">
        <div className="space-y-1">
          <label htmlFor="emailBasic" className="block text-sm font-medium text-gray-700">
            {dict.emailLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="email" id="emailBasic" value={data.email}
              onChange={(e) => updateField('email', e.target.value)}
              onBlur={() => setEmailError(isValidEmail(data.email) ? '' : dict.errors.invalidEmail)}
              placeholder={dict.emailPlaceholder} disabled={isLoading} required
              // UPDATED: Focus Ring (Cyan -> Teal)
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors ${isLoading ? 'bg-gray-100' : ''} ${emailError ? 'border-red-500 focus:ring-red-200' : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'}`}
            />
          </div>
          {emailError && <p role="alert" className="text-red-500 text-xs mt-1">{emailError}</p>}
        </div>
        
        <div className="space-y-1">
          <label htmlFor="passwordBasic" className="block text-sm font-medium text-gray-700">
            {dict.passwordLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5 pointer-events-none" />
            <Input
              type={passwordVisible ? 'text' : 'password'} id="passwordBasic" value={data.password}
              onChange={(e) => updateField('password', e.target.value)}
              onBlur={() => setPasswordError(isValidPassword(data.password) ? '' : dict.errors.invalidPassword)}
              placeholder={dict.passwordPlaceholder} disabled={isLoading} required
              // UPDATED: Focus Ring (Cyan -> Teal)
              className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors ${isLoading ? 'bg-gray-100' : ''} ${passwordError ? 'border-red-500 focus:ring-red-200' : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'}`}
            />
            <button type="button" onClick={() => setPasswordVisible(!passwordVisible)} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" aria-label={passwordVisible ? 'הסתר סיסמה' : 'הצג סיסמה'}>
              {passwordVisible ? <EyeOff className="h-5 w-5" /> : <Eye className="h-5 w-5" />}
            </button>
          </div>
          {passwordError ? <p role="alert" className="text-red-500 text-xs mt-1">{passwordError}</p> : <p className="text-gray-500 text-xs mt-1">{dict.passwordHint}</p>}
        </div>

        <div className="space-y-1">
          <label htmlFor="firstNameBasic" className="block text-sm font-medium text-gray-700">
            {dict.firstNameLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <User className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="text" id="firstNameBasic" value={data.firstName}
              onChange={(e) => updateField('firstName', e.target.value)}
              placeholder={dict.firstNamePlaceholder} disabled={isLoading} required
              // UPDATED: Focus Ring (Cyan -> Teal)
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors ${isLoading ? 'bg-gray-100' : ''} border-gray-300 focus:ring-teal-200 focus:border-teal-500`}
            />
          </div>
        </div>
        
        <div className="space-y-1">
          <label htmlFor="lastNameBasic" className="block text-sm font-medium text-gray-700">
            {dict.lastNameLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <User className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="text" id="lastNameBasic" value={data.lastName}
              onChange={(e) => updateField('lastName', e.target.value)}
              placeholder={dict.lastNamePlaceholder} disabled={isLoading} required
              // UPDATED: Focus Ring (Cyan -> Teal)
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors ${isLoading ? 'bg-gray-100' : ''} border-gray-300 focus:ring-teal-200 focus:border-teal-500`}
            />
          </div>
        </div>
      </motion.div>

      <motion.div variants={itemVariants} className="space-y-1">
        <label htmlFor="language" className="block text-sm font-medium text-gray-700">
          {dict.languageLabel}
        </label>
        <select
          id="language"
          value={data.language}
          onChange={(e) => updateField('language', e.target.value as 'he' | 'en')}
          disabled={isLoading}
          // UPDATED: Focus Ring (Cyan -> Teal)
          className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none bg-white"
        >
          <option value="he">עברית</option>
          <option value="en">English</option>
        </select>
      </motion.div>

      <motion.div
        variants={itemVariants}
        className="pt-4 mt-6 border-t border-gray-200"
      >
        <Button
          type="button"
          onClick={handleRegisterSubmit}
          disabled={!isFormValid || isLoading}
          // UPDATED: Button Gradient (Teal -> Orange -> Amber)
          className={`w-full flex items-center gap-2 justify-center text-white font-medium px-4 py-2.5 rounded-lg transition-opacity ${
            isFormValid && !isLoading
              ? 'bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-md hover:shadow-lg'
              : 'bg-gray-300 cursor-not-allowed'
          }`}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin mr-2" />
              <span>{dict.nextButtonLoading}</span>
            </>
          ) : (
            <>
              <span>{dict.nextButton}</span>
              <ArrowLeft className={`h-4 w-4 mr-2 ${locale === 'en' ? 'transform rotate-180' : ''}`} />{' '}
            </>
          )}
        </Button>

        <p className="text-[10px] text-gray-500 text-center mt-2 px-2">
          {dict.termsDisclaimer}
        </p>
      </motion.div>

      <div className="flex justify-center mt-2">
        <Button type="button" onClick={prevStep} variant="ghost" disabled={isLoading} className="text-xs text-gray-400 hover:text-gray-600">
          <ArrowRight className={`h-3 w-3 ml-1 ${locale === 'en' ? 'transform rotate-180' : ''}`} />{' '}
          {dict.backButton}
        </Button>
      </div>
    </motion.div>
  );
};

export default BasicInfoStep;
--- End of Content for BasicInfoStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\CompleteStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/CompleteStep.tsx
'use client';

import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import {
  CheckCircle,
  Mail,
  User,
  Phone,
  Loader2,
} from 'lucide-react';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { useSession } from 'next-auth/react';
import { UserStatus } from '@prisma/client';
import type { User as SessionUserType } from '@/types/next-auth';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface CompleteStepProps {
  dict: RegisterStepsDict['steps']['complete'];
}

const containerVariants = {
  hidden: { opacity: 0, scale: 0.95 },
  visible: {
    opacity: 1,
    scale: 1,
    transition: { staggerChildren: 0.1, delayChildren: 0.2 },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: { opacity: 1, y: 0, transition: { type: 'spring', stiffness: 100 } },
};

const circleVariants = {
  hidden: { opacity: 0, scale: 0.5 },
  visible: {
    opacity: 1,
    scale: 1,
    transition: { duration: 0.5, ease: 'easeOut' },
  },
};

const CompleteStep: React.FC<CompleteStepProps> = ({ dict }) => {
  const router = useRouter();
  const { data: session, status: sessionStatus } = useSession();

  if (sessionStatus === 'loading') {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-center space-y-4">
        <Loader2 className="h-10 w-10 animate-spin text-cyan-600" />
        <p className="text-lg text-gray-600">{dict.loading}</p>
      </div>
    );
  }

  if (sessionStatus === 'unauthenticated' || !session?.user) {
    // Should be handled by parent, but as a fallback:
    router.push('/auth/signin');
    return null;
  }

  const user = session.user as SessionUserType;

  // Scenario 1: Needs email verification
  if (user.status === UserStatus.PENDING_EMAIL_VERIFICATION) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-cyan-100 flex items-center justify-center">
            <Mail className="h-12 w-12 text-cyan-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.verifyEmailTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.verifyEmailSubtitle}{' '}
          <span className="font-bold text-gray-700">{user.email}</span>.
          <br />
          {dict.verifyEmailPrompt}
        </motion.p>
      </motion.div>
    );
  }

  // Scenario 2: Needs profile completion
  if (!user.isProfileComplete) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center">
            <User className="h-12 w-12 text-indigo-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.completeProfileTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.completeProfileSubtitle}
        </motion.p>
        <motion.div variants={itemVariants}>
          <Button
            onClick={() =>
              router.push('/auth/register?reason=complete_profile')
            }
            className="w-full"
          >
            {dict.completeProfileButton}
          </Button>
        </motion.div>
      </motion.div>
    );
  }

  // Scenario 3: Needs phone verification
  if (!user.isPhoneVerified) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-pink-100 flex items-center justify-center">
            <Phone className="h-12 w-12 text-pink-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.verifyPhoneTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.verifyPhoneSubtitle}
        </motion.p>
        <motion.div variants={itemVariants}>
          <Button
            onClick={() => router.push('/auth/verify-phone')}
            className="w-full"
          >
            {dict.verifyPhoneButton}
          </Button>
        </motion.div>
      </motion.div>
    );
  }

  // Scenario 4: Everything is complete
  return (
    <motion.div
      className="space-y-6 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.div className="flex justify-center" variants={circleVariants}>
        <div className="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center">
          <CheckCircle className="h-12 w-12 text-green-600" />
        </div>
      </motion.div>
      <motion.h2
        className="text-2xl font-bold text-gray-800"
        variants={itemVariants}
      >
        {dict.allDoneTitle}
      </motion.h2>
      <motion.p className="text-gray-600" variants={itemVariants}>
        {dict.allDoneSubtitle}
      </motion.p>
      <motion.div variants={itemVariants} className="flex flex-col gap-4">
        <Button onClick={() => router.push('/profile')} className="w-full">
          <User className="h-4 w-4 ml-2" /> {dict.myProfileButton}
        </Button>
        <Button
          onClick={() => router.push('/questionnaire')}
          variant="outline"
          className="w-full"
        >
          {dict.questionnaireButton}
        </Button>
        <Link href="/" className="text-sm text-gray-500 hover:underline mt-2">
          {dict.backToHomeLink}
        </Link>
      </motion.div>
    </motion.div>
  );
};

export default CompleteStep;
--- End of Content for CompleteStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\EmailVerificationCodeStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/EmailVerificationCodeStep.tsx
'use client';

import { useState, useRef, KeyboardEvent, useEffect, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import { signIn } from 'next-auth/react';
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, AlertCircle, MailCheck, ArrowRight } from 'lucide-react';
import { motion } from 'framer-motion';
import { Input } from '@/components/ui/input';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

const OTP_LENGTH = 6;

interface EmailVerificationCodeStepProps {
  dict: RegisterStepsDict['steps']['emailVerification'];
  locale: 'he' | 'en';
}

const EmailVerificationCodeStep: React.FC<EmailVerificationCodeStepProps> = ({
  dict,
  locale,
}) => {
  const {
    data: registrationData,
    exitEmailVerification: goBackToBasicInfo,
    completeEmailVerification,
  } = useRegistration();
  const router = useRouter();
  const [otp, setOtp] = useState<string[]>(new Array(OTP_LENGTH).fill(''));
  const [isLoading, setIsLoading] = useState(false);
  const [isResending, setIsResending] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [resendMessage, setResendMessage] = useState<string | null>(null);
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  useEffect(() => {
    inputRefs.current[0]?.focus();
  }, []);

  const handleChange = (element: HTMLInputElement, index: number) => {
    const value = element.value.replace(/[^0-9]/g, '');
    const newOtp = [...otp];
    newOtp[index] = value.slice(-1);
    setOtp(newOtp);

    if (value && index < OTP_LENGTH - 1) {
      inputRefs.current[index + 1]?.focus();
    }
  };

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>, index: number) => {
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const handleFormSubmit = async (e: FormEvent) => {
    e.preventDefault();
    const enteredCode = otp.join('');
    if (enteredCode.length !== OTP_LENGTH) {
      setApiError(
        dict.errors.incompleteCode.replace('{{length}}', OTP_LENGTH.toString())
      );
      return;
    }

    setIsLoading(true);
    setApiError(null);
    setResendMessage(null);

    try {
      const response = await fetch(
        `/api/auth/verify-email-code?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: registrationData.emailForVerification,
            code: enteredCode,
          }),
        }
      );
      const result = await response.json();
      if (!response.ok || !result.success || !result.authToken) {
        throw new Error(result.error || dict.errors.default);
      }

      const signInResult = await signIn('email-verified-autologin', {
        authToken: result.authToken,
        redirect: false,
      });

      if (signInResult?.ok) {
        completeEmailVerification();
        router.push('/auth/register');
      } else {
        throw new Error(
          dict.errors.autoSignInFailed.replace(
            '{error}',
            signInResult?.error || 'Unknown error'
          )
        );
      }
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
      setIsLoading(false);
    }
  };

  const handleResendCode = async () => {
    setIsResending(true);
    setApiError(null);
    setResendMessage(null);
    try {
      const response = await fetch('/api/auth/resend-verification-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: registrationData.emailForVerification }),
      });
      const result = await response.json();
      if (!response.ok) throw new Error(result.error);
      setResendMessage(dict.alerts.resent);
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
    } finally {
      setIsResending(false);
    }
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-6 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.div variants={itemVariants}>
        {/* UPDATED: Icon Color (Teal) */}
        <MailCheck className="h-12 w-12 text-teal-500 mx-auto mb-3" />
        <h2 className="text-2xl font-bold text-gray-800">{dict.title}</h2>
        <p className="text-gray-600 mt-2">
          {dict.subtitle.replace('{{length}}', OTP_LENGTH.toString())}{' '}
          <strong className="font-semibold text-gray-700">
            {registrationData.emailForVerification || dict.yourEmail}
          </strong>
          .
        </p>
      </motion.div>

      {apiError && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{apiError}</AlertDescription>
          </Alert>
        </motion.div>
      )}
      {resendMessage && !apiError && (
        <motion.div variants={itemVariants}>
          <Alert
            variant="default"
            className="bg-green-50 border-green-300 text-green-700"
            role="status"
          >
            <MailCheck className="h-4 w-4 text-green-600" />
            <AlertTitle>{dict.alerts.title}</AlertTitle>
            <AlertDescription>{resendMessage}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      <form onSubmit={handleFormSubmit}>
        <motion.div
          variants={itemVariants}
          className="flex justify-center space-x-2 rtl:space-x-reverse"
          dir="ltr"
        >
          {otp.map((digit, index) => (
            <Input
              key={index}
              type="text"
              maxLength={1}
              value={digit}
              onChange={(e) =>
                handleChange(e.target as HTMLInputElement, index)
              }
              onKeyDown={(e) =>
                handleKeyDown(e as KeyboardEvent<HTMLInputElement>, index)
              }
              ref={(el) => {
                inputRefs.current[index] = el;
              }}
              // UPDATED: Input Focus (Teal)
              className="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 rounded-xl"
              disabled={isLoading || isResending}
              aria-label={`OTP digit ${index + 1}`}
              autoComplete="one-time-code"
              inputMode="numeric"
            />
          ))}
        </motion.div>

        <motion.div variants={itemVariants} className="mt-6">
          <Button
            type="submit"
            disabled={
              isLoading || isResending || otp.join('').length !== OTP_LENGTH
            }
            // UPDATED: Main Button Gradient (Teal -> Orange -> Amber)
            className="w-full py-6 text-lg bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg transition-all"
          >
            {isLoading ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin ml-2" />
                <span>{dict.submitButtonLoading}</span>
              </>
            ) : (
              dict.submitButton
            )}
          </Button>
        </motion.div>
      </form>

      <motion.div
        variants={itemVariants}
        className="text-sm text-gray-500 mt-2"
      >
        {dict.resendPrompt}{' '}
        <Button
          type="button"
          variant="link"
          onClick={handleResendCode}
          disabled={isLoading || isResending}
          // UPDATED: Link Color (Teal)
          className="p-0 h-auto text-teal-600 hover:text-teal-700 font-semibold"
        >
          {isResending ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin ml-1" />
              <span>{dict.resendButtonLoading}</span>
            </>
          ) : (
            dict.resendButton
          )}
        </Button>
      </motion.div>

      <motion.div variants={itemVariants} className="mt-6">
        <Button
          type="button"
          onClick={goBackToBasicInfo}
          variant="outline"
          disabled={isLoading || isResending}
          className="hover:bg-gray-50 border-gray-200"
        >
          <ArrowRight
            className={`h-4 w-4 ml-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
          />{' '}
          {dict.backButton}{' '}
        </Button>
      </motion.div>
    </motion.div>
  );
};

export default EmailVerificationCodeStep;
--- End of Content for EmailVerificationCodeStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\OptionalInfoStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/OptionalInfoStep.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
// הסרנו את useSession כי אנחנו לא צריכים אותו יותר כאן
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Input } from '@/components/ui/input';
import {
  ArrowLeft,
  ArrowRight,
  Ruler,
  Briefcase,
  GraduationCap,
  Loader2,
  AlertCircle,
} from 'lucide-react';
import { motion } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface OptionalInfoStepProps {
  dict: RegisterStepsDict['steps']['optionalInfo'];
  locale: 'he' | 'en';
}

const OptionalInfoStep: React.FC<OptionalInfoStepProps> = ({
  dict,
  locale,
}) => {
  const { data, updateField, prevStep } = useRegistration();
  const router = useRouter();

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ============================ התיקון הסופי ============================
  const handleSubmit = async () => {
    // נעל את הכפתורים כדי למנוע לחיצות כפולות
    setIsLoading(true);
    setError(null);

    try {
      const profileData = {
        firstName: data.firstName,
        lastName: data.lastName,
        phone: data.phone,
        gender: data.gender,
        birthDate: data.birthDate,
        maritalStatus: data.maritalStatus,
        height: data.height,
        occupation: data.occupation,
        education: data.education,
      };

      if (
        !profileData.firstName ||
        !profileData.lastName ||
        !profileData.phone
      ) {
        throw new Error(dict.errors.missingData);
      }

      // 1. שמור את הפרופיל. חכה לסיום.
      const profileResponse = await fetch('/api/auth/complete-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData),
      });
      if (!profileResponse.ok) {
        const errorData = await profileResponse.json();
        throw new Error(errorData.error || dict.errors.default);
      }

      // 2. שלח את קוד האימות. חכה לסיום.
      const sendCodeResponse = await fetch('/api/auth/send-phone-code', {
        method: 'POST',
      });
      if (!sendCodeResponse.ok) {
        const errorData = await sendCodeResponse.json();
        throw new Error(errorData.error || dict.errors.default);
      }

      // 3. נווט מיידית לדף הבא. בלי שום דבר באמצע.
      router.push(`/${locale}/auth/verify-phone`);
    } catch (err) {
      // אם משהו נכשל, הצג שגיאה ושחרר את הכפתורים
      setError(err instanceof Error ? err.message : dict.errors.default);
      setIsLoading(false);
    }
  };
  // =====================================================================

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-5"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.h2
        className="text-xl font-bold text-gray-800"
        variants={itemVariants}
      >
        {dict.title}
      </motion.h2>
      <motion.p className="text-gray-600 text-sm" variants={itemVariants}>
        {dict.subtitle}
      </motion.p>

      {error && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      <motion.div variants={itemVariants} className="space-y-4">
        {/* שדות הטופס */}
        <div className="space-y-1">
          <label
            htmlFor="heightOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <Ruler className="h-4 w-4 text-gray-400" />
            {dict.heightLabel}
          </label>
          <Input
            type="number"
            id="heightOptional"
            min="120"
            max="220"
            value={data.height ?? ''}
            onChange={(e) =>
              updateField(
                'height',
                e.target.value ? parseInt(e.target.value, 10) : undefined
              )
            }
            placeholder={dict.heightPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
        <div className="space-y-1">
          <label
            htmlFor="occupationOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <Briefcase className="h-4 w-4 text-gray-400" />
            {dict.occupationLabel}
          </label>
          <Input
            type="text"
            id="occupationOptional"
            value={data.occupation ?? ''}
            onChange={(e) => updateField('occupation', e.target.value)}
            placeholder={dict.occupationPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
        <div className="space-y-1">
          <label
            htmlFor="educationOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <GraduationCap className="h-4 w-4 text-gray-400" />
            {dict.educationLabel}
          </label>
          <Input
            type="text"
            id="educationOptional"
            value={data.education ?? ''}
            onChange={(e) => updateField('education', e.target.value)}
            placeholder={dict.educationPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
      </motion.div>

      <motion.div
        variants={itemVariants}
        className="flex justify-between pt-4 mt-6"
      >
        <Button
          type="button"
          onClick={prevStep}
          variant="outline"
          disabled={isLoading}
        >
          <ArrowRight
            className={`h-4 w-4 ml-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
          />{' '}
          {dict.backButton}
        </Button>
        <Button
          type="button"
          onClick={handleSubmit}
          disabled={isLoading}
          className={`flex items-center gap-2 ${isLoading ? 'bg-gray-400' : 'bg-gradient-to-r from-cyan-500 to-pink-500'}`}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin mr-2" />
              <span></span>
            </>
          ) : (
            <>
              {dict.nextButton}{' '}
              <ArrowLeft
                className={`h-4 w-4 mr-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
              />{' '}
            </>
          )}
        </Button>
      </motion.div>
    </motion.div>
  );
};

export default OptionalInfoStep;
--- End of Content for OptionalInfoStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\PersonalDetailsStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/PersonalDetailsStep.tsx
'use client';

import React, { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import { useSession } from 'next-auth/react';
import { useRegistration } from '../RegistrationContext';
import { Gender } from '@prisma/client';

// Icons
import {
  User,
  Calendar,
  Heart,
  Sparkles,
  CheckCircle2,
  AlertCircle,
  Loader2,
  ArrowLeft,
  ArrowRight,
  Languages,
  Edit3,
  Ruler,
  Briefcase,
  GraduationCap,
  BookOpen,
  Shield,
  Users,
} from 'lucide-react';

// UI Components
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Alert, AlertDescription } from '@/components/ui/alert';

// Custom Components
import PhoneNumberInput from '../PhoneNumberInput';
import ConsentCheckbox from '../ConsentCheckbox';
import SubmissionStatusIndicator, {
  SubmissionStatus,
} from './SubmissionStatusIndicator';

// Types
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

// ============================================================================
// ANIMATION & STYLING VARIANTS
// ============================================================================

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.08,
      delayChildren: 0.1,
    },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 15 },
  visible: {
    opacity: 1,
    y: 0,
    transition: { duration: 0.4, ease: 'easeOut' },
  },
};

// Helper Component: Field Wrapper
interface FieldWrapperProps {
  children: React.ReactNode;
  icon: React.ReactNode;
  hasValue?: boolean;
  className?: string;
}

const FieldWrapper: React.FC<FieldWrapperProps> = ({
  children,
  icon,
  hasValue = false,
  className = '',
}) => (
  <div className={`relative group ${className}`}>
    <div
      className={`absolute right-3 top-1/2 transform -translate-y-1/2 transition-all duration-300 z-10 pointer-events-none ${
        hasValue
          // UPDATED: Active Icon Color (Teal)
          ? 'text-teal-500 scale-110'
          : 'text-gray-400 group-hover:text-gray-500'
      }`}
    >
      {icon}
    </div>
    {children}
  </div>
);

// Helper Component: Section Header
interface SectionHeaderProps {
  icon: React.ReactNode;
  title: string;
  subtitle?: string;
  gradient: string;
}

const SectionHeader: React.FC<SectionHeaderProps> = ({
  icon,
  title,
  subtitle,
  gradient,
}) => (
  <motion.div variants={itemVariants} className="mb-6">
    <div className="flex items-center gap-3 mb-2">
      <div className={`p-2 rounded-xl bg-gradient-to-br ${gradient} shadow-lg`}>
        <div className="text-white">{icon}</div>
      </div>
      <h3 className="text-xl font-bold text-gray-800">{title}</h3>
    </div>
    {subtitle && (
      <p className="text-sm text-gray-600 leading-relaxed mr-12">{subtitle}</p>
    )}
  </motion.div>
);

// ============================================================================
// MAIN COMPONENT
// ============================================================================

interface PersonalDetailsStepProps {
  personalDetailsDict: RegisterStepsDict['steps']['personalDetails'];
  optionalInfoDict: RegisterStepsDict['steps']['optionalInfo'];
  consentDict: RegisterStepsDict['consentCheckbox'];
  locale: 'he' | 'en';
}

const validatePhoneNumber = (phone: string): boolean => {
  if (!phone) return false;
  const cleanPhone = phone.replace(/\D/g, '');
  return (
    cleanPhone.length >= 10 && cleanPhone.length <= 15 && phone.startsWith('+')
  );
};

export default function PersonalDetailsStep({
  personalDetailsDict,
  optionalInfoDict,
  consentDict,
  locale,
}: PersonalDetailsStepProps) {
  const { data: registrationState, updateField, prevStep } = useRegistration();
  const { data: session } = useSession();
  const router = useRouter();

  // States
  const [firstNameError, setFirstNameError] = useState('');
  const [lastNameError, setLastNameError] = useState('');
  const [phoneError, setPhoneError] = useState('');
  const [ageError, setAgeError] = useState('');
  const [religiousLevelError, setReligiousLevelError] = useState('');

  const [isFormValid, setIsFormValid] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [submissionStatus, setSubmissionStatus] =
    useState<SubmissionStatus>('idle');

  // Consent Logic
  const userHasAlreadyConsented = !!session?.user?.termsAndPrivacyAcceptedAt;
  const [consentChecked, setConsentChecked] = useState(userHasAlreadyConsented);
  const [consentError, setConsentError] = useState<string | null>(null);

  const [engagementConsent, setEngagementConsent] = useState(
    session?.user?.engagementEmailsConsent || false
  );
  const [promotionalConsent, setPromotionalConsent] = useState(
    session?.user?.promotionalEmailsConsent || false
  );
  const [engagementConsentError, setEngagementConsentError] = useState<
    string | null
  >(null);

  const isRTL = locale === 'he';

  const religiousLevelOptions = useMemo(() => {
    return Object.entries(personalDetailsDict.religiousLevels).map(
      ([value, label]) => ({
        value,
        label,
      })
    );
  }, [personalDetailsDict.religiousLevels]);

  useEffect(() => {
    router.prefetch(`/${locale}/auth/verify-phone`);
  }, [router, locale]);

  // Validation Functions (Same as before)
  const validateFirstName = (name: string) => {
    if (!name.trim()) {
      setFirstNameError(personalDetailsDict.errors.firstNameRequired);
      return false;
    }
    setFirstNameError('');
    return true;
  };
  const validateLastName = (name: string) => {
    if (!name.trim()) {
      setLastNameError(personalDetailsDict.errors.lastNameRequired);
      return false;
    }
    setLastNameError('');
    return true;
  };
  const validatePhone = (phone: string) => {
    if (!phone) {
      setPhoneError(personalDetailsDict.errors.phoneRequired);
      return false;
    }
    if (!validatePhoneNumber(phone)) {
      setPhoneError(personalDetailsDict.errors.phoneInvalid);
      return false;
    }
    setPhoneError('');
    return true;
  };
  const validateAge = (birthDate: string) => {
    if (!birthDate) {
      setAgeError(personalDetailsDict.errors.birthDateRequired);
      return false;
    }
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birth.getDate())
    ) {
      age--;
    }
    if (age < 18) {
      setAgeError(personalDetailsDict.errors.ageTooLow);
      return false;
    }
    if (age > 120) {
      setAgeError(personalDetailsDict.errors.ageTooHigh);
      return false;
    }
    setAgeError('');
    return true;
  };

  // Form Validity Effect
  useEffect(() => {
    const isFieldsValid =
      registrationState.firstName.trim() &&
      registrationState.lastName.trim() &&
      registrationState.phone &&
      validatePhoneNumber(registrationState.phone) &&
      registrationState.birthDate &&
      registrationState.gender &&
      registrationState.maritalStatus &&
      registrationState.religiousLevel;

    setIsFormValid(!!isFieldsValid && consentChecked && engagementConsent);
  }, [registrationState, consentChecked, engagementConsent]);

  const handleSubmit = async () => {
    setApiError(null);
    setConsentError(null);
    setEngagementConsentError(null);
    setReligiousLevelError('');

    const isFirstNameValid = validateFirstName(registrationState.firstName);
    const isLastNameValid = validateLastName(registrationState.lastName);
    const isPhoneValid = validatePhone(registrationState.phone);
    const isAgeValid = validateAge(registrationState.birthDate);

    if (!consentChecked) {
      setConsentError(personalDetailsDict.errors.consentRequired);
      return;
    }
    if (!engagementConsent) {
      setEngagementConsentError(
        personalDetailsDict.errors.engagementConsentRequired
      );
      return;
    }
    if (!registrationState.religiousLevel) {
      setReligiousLevelError(personalDetailsDict.errors.religiousLevelRequired);
      return;
    }

    if (!isFirstNameValid || !isLastNameValid || !isPhoneValid || !isAgeValid) {
      return;
    }

    setIsLoading(true);
    setSubmissionStatus('savingProfile');

    try {
      if (!userHasAlreadyConsented) {
        const consentResponse = await fetch('/api/user/accept-terms', {
          method: 'POST',
        });
        if (!consentResponse.ok)
          throw new Error(personalDetailsDict.errors.consentApiError);
      }

      const profileData = {
        firstName: registrationState.firstName,
        lastName: registrationState.lastName,
        phone: registrationState.phone,
        gender: registrationState.gender,
        birthDate: registrationState.birthDate,
        maritalStatus: registrationState.maritalStatus,
        religiousLevel: registrationState.religiousLevel,
        height: registrationState.height,
        occupation: registrationState.occupation,
        education: registrationState.education,
        engagementEmailsConsent: engagementConsent,
        promotionalEmailsConsent: promotionalConsent,
      };

      const profileResponse = await fetch('/api/auth/complete-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData),
      });

      if (!profileResponse.ok) {
        const errorData = await profileResponse.json();
        throw new Error(errorData.error || optionalInfoDict.errors.default);
      }

      setSubmissionStatus('sendingCode');

      const sendCodeResponse = await fetch('/api/auth/send-phone-code', {
        method: 'POST',
      });
      if (!sendCodeResponse.ok) {
        const errorData = await sendCodeResponse.json();
        throw new Error(errorData.error || optionalInfoDict.errors.default);
      }

      setSubmissionStatus('redirecting');
      router.push(`/${locale}/auth/verify-phone`);
    } catch (err) {
      setApiError(
        err instanceof Error ? err.message : optionalInfoDict.errors.default
      );
      setIsLoading(false);
      setSubmissionStatus('error');
    }
  };

  const submissionSteps = [
    {
      id: 'savingProfile' as SubmissionStatus,
      text: optionalInfoDict.status.saving,
    },
    {
      id: 'sendingCode' as SubmissionStatus,
      text: optionalInfoDict.status.sendingCode,
    },
    {
      id: 'redirecting' as SubmissionStatus,
      text:
        locale === 'he'
          ? 'מעבירים אותך לאימות...'
          : 'Redirecting to verification...',
    },
  ];

  return (
    <>
      <SubmissionStatusIndicator
        currentStatus={submissionStatus}
        steps={submissionSteps}
        dict={{
          title: locale === 'he' ? 'מאמתים את הפרטים' : 'Verifying details',
          subtitle:
            locale === 'he'
              ? 'זה לוקח רק מספר שניות, נא לא לסגור את החלון.'
              : 'This takes just a few seconds, please do not close the window.',
        }}
      />

      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="space-y-8"
      >
        {/* UPDATED: Welcome Message Box (Teal/Orange/Rose gradient background) */}
        <motion.div
          variants={itemVariants}
          className="text-center p-4 bg-gradient-to-r from-teal-50 via-orange-50 to-rose-50 rounded-2xl border border-teal-100"
        >
          <div className="flex items-center justify-center gap-2 mb-2">
            <Sparkles className="w-5 h-5 text-teal-500" />
            <h2 className="text-lg font-bold text-gray-800">
              {personalDetailsDict.title}
            </h2>
            <Heart className="w-5 h-5 text-rose-500" />
          </div>
          <p className="text-sm text-gray-600 leading-relaxed">
            {personalDetailsDict.subtitle}
          </p>
        </motion.div>

        {/* Error Alert */}
        <AnimatePresence>
          {apiError && (
            <motion.div
              initial={{ opacity: 0, y: -10, height: 0 }}
              animate={{ opacity: 1, y: 0, height: 'auto' }}
              exit={{ opacity: 0, y: -10, height: 0 }}
            >
              <Alert variant="destructive" className="border-2">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-red-100 rounded-lg">
                    <AlertCircle className="h-5 w-5 text-red-600" />
                  </div>
                  <AlertDescription className="text-sm">
                    {apiError}
                  </AlertDescription>
                </div>
              </Alert>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Form Container */}
        <div className="space-y-8">
          {/* --- PERSONAL DETAILS SECTION --- */}
          <div className="space-y-5">
            {/* UPDATED: Section Header Gradient (Teal -> Emerald) */}
            <SectionHeader
              icon={<User className="w-5 h-5" />}
              title={personalDetailsDict.title}
              gradient="from-teal-400 to-emerald-500"
            />

            {/* First Name */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label
                htmlFor="firstNamePersonal"
                className="text-sm font-semibold text-gray-700 flex items-center"
              >
                {personalDetailsDict.firstNameLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <FieldWrapper
                icon={<Edit3 className="h-5 w-5" />}
                hasValue={!!registrationState.firstName}
              >
                <Input
                  id="firstNamePersonal"
                  value={registrationState.firstName}
                  onChange={(e) => updateField('firstName', e.target.value)}
                  onBlur={(e) => validateFirstName(e.target.value)}
                  placeholder={personalDetailsDict.firstNamePlaceholder}
                  required
                  disabled={isLoading}
                  // UPDATED: Focus Ring (Teal)
                  className={`pr-11 py-3 border-2 rounded-xl transition-all bg-white/50 backdrop-blur-sm ${
                    firstNameError
                      ? 'border-red-300 focus:border-red-400'
                      : 'border-gray-200 focus:border-teal-400'
                  } focus:ring-2 focus:ring-teal-200`}
                  dir={isRTL ? 'rtl' : 'ltr'}
                />
              </FieldWrapper>
              {firstNameError && (
                <p className="text-xs text-red-600 flex items-center gap-1">
                  <AlertCircle className="w-3 h-3" /> {firstNameError}
                </p>
              )}
            </motion.div>

            {/* Last Name */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label
                htmlFor="lastNamePersonal"
                className="text-sm font-semibold text-gray-700 flex items-center"
              >
                {personalDetailsDict.lastNameLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <FieldWrapper
                icon={<Edit3 className="h-5 w-5" />}
                hasValue={!!registrationState.lastName}
              >
                <Input
                  id="lastNamePersonal"
                  value={registrationState.lastName}
                  onChange={(e) => updateField('lastName', e.target.value)}
                  onBlur={(e) => validateLastName(e.target.value)}
                  placeholder={personalDetailsDict.lastNamePlaceholder}
                  required
                  disabled={isLoading}
                  // UPDATED: Focus Ring (Teal)
                  className={`pr-11 py-3 border-2 rounded-xl transition-all bg-white/50 backdrop-blur-sm ${
                    lastNameError
                      ? 'border-red-300 focus:border-red-400'
                      : 'border-gray-200 focus:border-teal-400'
                  } focus:ring-2 focus:ring-teal-200`}
                  dir={isRTL ? 'rtl' : 'ltr'}
                />
              </FieldWrapper>
              {lastNameError && (
                <p className="text-xs text-red-600 flex items-center gap-1">
                  <AlertCircle className="w-3 h-3" /> {lastNameError}
                </p>
              )}
            </motion.div>

            {/* Language Selection */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label className="text-sm font-semibold text-gray-700 flex items-center">
                {personalDetailsDict.languageLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <FieldWrapper
                icon={<Languages className="h-5 w-5" />}
                hasValue={!!registrationState.language}
              >
                <Select
                  dir={isRTL ? 'rtl' : 'ltr'}
                  value={registrationState.language}
                  onValueChange={(value) =>
                    updateField('language', value as 'he' | 'en')
                  }
                  disabled={isLoading}
                >
                  <SelectTrigger className="w-full pr-11 pl-3 py-3 h-auto border-2 border-gray-200 rounded-xl transition-all bg-white/50 backdrop-blur-sm hover:border-gray-300 focus:border-teal-400 focus:ring-2 focus:ring-teal-200">
                    <SelectValue
                      placeholder={personalDetailsDict.languagePlaceholder}
                    />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="he">עברית</SelectItem>
                    <SelectItem value="en">English</SelectItem>
                  </SelectContent>
                </Select>
              </FieldWrapper>
            </motion.div>

            {/* Phone */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label className="text-sm font-semibold text-gray-700 flex items-center">
                {personalDetailsDict.phoneLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <div
                className={`rounded-xl ${phoneError ? 'ring-2 ring-red-300' : ''}`}
              >
                <PhoneNumberInput
                  value={registrationState.phone}
                  onChange={(value) => updateField('phone', value || '')}
                  disabled={isLoading}
                  locale={locale}
                  error={phoneError}
                />
              </div>
            </motion.div>

            {/* Gender Selection */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label className="text-sm font-semibold text-gray-700 flex items-center">
                {personalDetailsDict.genderLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <div className="grid grid-cols-2 gap-4">
                {/* Male Button - UPDATED: Teal Theme */}
                <Button
                  type="button"
                  onClick={() => updateField('gender', Gender.MALE)}
                  variant="outline"
                  disabled={isLoading}
                  className={`py-6 rounded-xl border-2 transition-all ${
                    registrationState.gender === Gender.MALE
                      ? 'bg-teal-50 border-teal-400 text-teal-700 ring-2 ring-teal-200'
                      : 'border-gray-200 hover:border-teal-200 text-gray-600'
                  }`}
                >
                  <span className="text-xl mr-2">👨</span>{' '}
                  {personalDetailsDict.male}
                </Button>
                
                {/* Female Button - UPDATED: Rose Theme */}
                <Button
                  type="button"
                  onClick={() => updateField('gender', Gender.FEMALE)}
                  variant="outline"
                  disabled={isLoading}
                  className={`py-6 rounded-xl border-2 transition-all ${
                    registrationState.gender === Gender.FEMALE
                      ? 'bg-rose-50 border-rose-400 text-rose-700 ring-2 ring-rose-200'
                      : 'border-gray-200 hover:border-rose-200 text-gray-600'
                  }`}
                >
                  <span className="text-xl mr-2">👩</span>{' '}
                  {personalDetailsDict.female}
                </Button>
              </div>
            </motion.div>

            {/* Birth Date & Marital Status Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              {/* Birth Date */}
              <motion.div variants={itemVariants} className="space-y-2">
                <Label
                  htmlFor="birthDatePersonal"
                  className="text-sm font-semibold text-gray-700 flex items-center"
                >
                  {personalDetailsDict.birthDateLabel}{' '}
                  <span className="text-red-500 mr-1">*</span>
                </Label>
                <FieldWrapper
                  icon={<Calendar className="h-5 w-5" />}
                  hasValue={!!registrationState.birthDate}
                >
                  <Input
                    id="birthDatePersonal"
                    type="date"
                    value={registrationState.birthDate}
                    onChange={(e) => updateField('birthDate', e.target.value)}
                    onBlur={(e) => validateAge(e.target.value)}
                    required
                    disabled={isLoading}
                    // UPDATED: Focus Ring (Teal)
                    className={`pr-11 py-3 border-2 rounded-xl transition-all bg-white/50 backdrop-blur-sm ${
                      ageError
                        ? 'border-red-300 focus:border-red-400'
                        : 'border-gray-200 focus:border-teal-400'
                    } focus:ring-2 focus:ring-teal-200`}
                  />
                </FieldWrapper>
                {ageError && (
                  <p className="text-xs text-red-600 flex items-center gap-1">
                    <AlertCircle className="w-3 h-3" /> {ageError}
                  </p>
                )}
              </motion.div>

              {/* Marital Status */}
              <motion.div variants={itemVariants} className="space-y-2">
                <Label
                  htmlFor="maritalStatusPersonal"
                  className="text-sm font-semibold text-gray-700 flex items-center"
                >
                  {personalDetailsDict.maritalStatusLabel}{' '}
                  <span className="text-red-500 mr-1">*</span>
                </Label>
                <FieldWrapper
                  icon={<Users className="h-5 w-5" />}
                  hasValue={!!registrationState.maritalStatus}
                >
                  <select
                    id="maritalStatusPersonal"
                    value={registrationState.maritalStatus}
                    onChange={(e) =>
                      updateField('maritalStatus', e.target.value)
                    }
                    required
                    disabled={isLoading}
                    // UPDATED: Focus Ring (Teal)
                    className="w-full pr-11 pl-3 py-3 border-2 border-gray-200 rounded-xl transition-all bg-white/50 backdrop-blur-sm hover:border-gray-300 focus:border-teal-400 focus:ring-2 focus:ring-teal-200 appearance-none text-gray-900"
                  >
                    <option value="" disabled>
                      {personalDetailsDict.maritalStatusPlaceholder}
                    </option>
                    <option value="רווק/ה">
                      {personalDetailsDict.maritalStatuses.single}
                    </option>
                    <option value="גרוש/ה">
                      {personalDetailsDict.maritalStatuses.divorced}
                    </option>
                    <option value="אלמן/ה">
                      {personalDetailsDict.maritalStatuses.widowed}
                    </option>
                  </select>
                </FieldWrapper>
              </motion.div>
            </div>
          </div>

          {/* Divider */}
          <motion.div variants={itemVariants} className="relative py-2">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t-2 border-gray-200" />
            </div>
            <div className="relative flex justify-center">
              <span className="px-4 bg-white text-sm font-medium text-gray-500">
                {optionalInfoDict.title}
              </span>
            </div>
          </motion.div>

          {/* --- OPTIONAL INFO SECTION --- */}
          <div className="space-y-5">
            {/* UPDATED: Section Header Gradient (Orange -> Amber) */}
            <SectionHeader
              icon={<Sparkles className="w-5 h-5" />}
              title={optionalInfoDict.title}
              subtitle={optionalInfoDict.subtitle}
              gradient="from-orange-400 to-amber-500"
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              {/* Height */}
              <motion.div variants={itemVariants} className="space-y-2">
                <Label
                  htmlFor="heightOptional"
                  className="text-sm font-semibold text-gray-700 flex items-center gap-1"
                >
                  {optionalInfoDict.heightLabel}
                </Label>
                <FieldWrapper
                  icon={<Ruler className="h-5 w-5" />}
                  hasValue={!!registrationState.height}
                >
                  <Input
                    type="number"
                    id="heightOptional"
                    min="120"
                    max="220"
                    value={registrationState.height ?? ''}
                    onChange={(e) =>
                      updateField(
                        'height',
                        e.target.value
                          ? parseInt(e.target.value, 10)
                          : undefined
                      )
                    }
                    placeholder={optionalInfoDict.heightPlaceholder}
                    disabled={isLoading}
                    // UPDATED: Focus Ring (Orange)
                    className="pr-11 py-3 border-2 border-gray-200 rounded-xl transition-all bg-white/50 backdrop-blur-sm hover:border-gray-300 focus:border-orange-400 focus:ring-2 focus:ring-orange-200"
                  />
                </FieldWrapper>
              </motion.div>

              {/* Occupation */}
              <motion.div variants={itemVariants} className="space-y-2">
                <Label
                  htmlFor="occupationOptional"
                  className="text-sm font-semibold text-gray-700 flex items-center gap-1"
                >
                  {optionalInfoDict.occupationLabel}
                </Label>
                <FieldWrapper
                  icon={<Briefcase className="h-5 w-5" />}
                  hasValue={!!registrationState.occupation}
                >
                  <Input
                    type="text"
                    id="occupationOptional"
                    value={registrationState.occupation ?? ''}
                    onChange={(e) => updateField('occupation', e.target.value)}
                    placeholder={optionalInfoDict.occupationPlaceholder}
                    disabled={isLoading}
                    // UPDATED: Focus Ring (Orange)
                    className="pr-11 py-3 border-2 border-gray-200 rounded-xl transition-all bg-white/50 backdrop-blur-sm hover:border-gray-300 focus:border-orange-400 focus:ring-2 focus:ring-orange-200"
                  />
                </FieldWrapper>
              </motion.div>
            </div>

            {/* Education */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label
                htmlFor="educationOptional"
                className="text-sm font-semibold text-gray-700 flex items-center gap-1"
              >
                {optionalInfoDict.educationLabel}
              </Label>
              <FieldWrapper
                icon={<GraduationCap className="h-5 w-5" />}
                hasValue={!!registrationState.education}
              >
                <Input
                  type="text"
                  id="educationOptional"
                  value={registrationState.education ?? ''}
                  onChange={(e) => updateField('education', e.target.value)}
                  placeholder={optionalInfoDict.educationPlaceholder}
                  disabled={isLoading}
                  // UPDATED: Focus Ring (Orange)
                  className="pr-11 py-3 border-2 border-gray-200 rounded-xl transition-all bg-white/50 backdrop-blur-sm hover:border-gray-300 focus:border-orange-400 focus:ring-2 focus:ring-orange-200"
                />
              </FieldWrapper>
            </motion.div>

            {/* Religious Level */}
            <motion.div variants={itemVariants} className="space-y-2">
              <Label className="text-sm font-semibold text-gray-700 flex items-center">
                {personalDetailsDict.religiousLevelLabel}{' '}
                <span className="text-red-500 mr-1">*</span>
              </Label>
              <FieldWrapper
                icon={<BookOpen className="h-5 w-5" />}
                hasValue={!!registrationState.religiousLevel}
              >
                <Select
                  dir={isRTL ? 'rtl' : 'ltr'}
                  value={registrationState.religiousLevel || ''}
                  onValueChange={(value) => {
                    updateField('religiousLevel', value);
                    if (value) setReligiousLevelError('');
                  }}
                  disabled={isLoading}
                >
                  <SelectTrigger
                    // UPDATED: Focus Ring (Orange)
                    className={`w-full pr-11 pl-3 py-3 h-auto border-2 rounded-xl transition-all bg-white/50 backdrop-blur-sm ${
                      religiousLevelError
                        ? 'border-red-300 focus:ring-red-200'
                        : 'border-gray-200 hover:border-gray-300 focus:border-orange-400 focus:ring-2 focus:ring-orange-200'
                    }`}
                  >
                    <SelectValue
                      placeholder={
                        personalDetailsDict.religiousLevelPlaceholder
                      }
                    />
                  </SelectTrigger>
                  <SelectContent className="max-h-[200px]">
                    {religiousLevelOptions.map((opt) => (
                      <SelectItem key={opt.value} value={opt.value}>
                        {opt.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </FieldWrapper>
              {religiousLevelError && (
                <p className="text-xs text-red-600 flex items-center gap-1">
                  <AlertCircle className="w-3 h-3" /> {religiousLevelError}
                </p>
              )}
            </motion.div>
          </div>

          {/* --- CONSENTS SECTION --- */}
          <motion.div variants={itemVariants} className="space-y-4">
            {/* UPDATED: Container Style (Warm Amber/Orange background) */}
            <div
              className={`p-4 rounded-2xl border-2 transition-all ${
                consentError
                  ? 'border-red-300 bg-red-50'
                  : 'border-gray-200 bg-gradient-to-r from-amber-50/50 to-orange-50/50'
              }`}
            >
              <ConsentCheckbox
                checked={consentChecked}
                onChange={(isChecked) => {
                  setConsentChecked(isChecked);
                  if (isChecked) setConsentError(null);
                }}
                error={consentError}
                dict={consentDict}
              />
            </div>

            {/* Marketing Consents */}
            <div className="space-y-3 px-2">
              {/* Engagement Consent */}
              <div className="flex items-start space-x-2 rtl:space-x-reverse">
                <Checkbox
                  id="engagementConsent"
                  checked={engagementConsent}
                  onCheckedChange={(checked) => {
                    const isChecked = checked as boolean;
                    setEngagementConsent(isChecked);
                    if (isChecked) setEngagementConsentError(null);
                  }}
                  // UPDATED: Checkbox Color (Teal)
                  className="mt-1 data-[state=checked]:bg-teal-600 data-[state=checked]:border-teal-600"
                />
                <div className="grid gap-1.5 leading-none">
                  <label
                    htmlFor="engagementConsent"
                    className="text-sm font-medium text-gray-700 cursor-pointer"
                  >
                    {personalDetailsDict.engagementConsentLabel}
                    <span className="text-red-500 mr-1">*</span>
                  </label>
                  {engagementConsentError && (
                    <p className="text-xs text-red-500">
                      {engagementConsentError}
                    </p>
                  )}
                </div>
              </div>

              {/* Promotional Consent */}
              <div className="flex items-start space-x-2 rtl:space-x-reverse">
                <Checkbox
                  id="promotionalConsent"
                  checked={promotionalConsent}
                  onCheckedChange={(checked) =>
                    setPromotionalConsent(checked as boolean)
                  }
                  // UPDATED: Checkbox Color (Orange)
                  className="mt-1 data-[state=checked]:bg-orange-500 data-[state=checked]:border-orange-500"
                />
                <div className="grid gap-1.5 leading-none">
                  <label
                    htmlFor="promotionalConsent"
                    className="text-sm text-gray-600 cursor-pointer"
                  >
                    {personalDetailsDict.promotionalConsentLabel}
                  </label>
                </div>
              </div>
            </div>

            {/* Privacy Note */}
            <div className="flex items-start gap-3 p-4 bg-gray-50 rounded-2xl border border-gray-200 mt-2">
              <Shield className="w-5 h-5 text-teal-500 flex-shrink-0 mt-0.5" />
              <p className="text-xs text-gray-600 leading-relaxed">
                {isRTL
                  ? 'הפרטים שלך מאובטחים ומוצפנים.'
                  : 'Your details are secure and encrypted.'}
              </p>
            </div>
          </motion.div>

          {/* --- BUTTONS --- */}
          <motion.div variants={itemVariants} className="flex gap-4 pt-4">
            <Button
              type="button"
              onClick={prevStep}
              variant="outline"
              disabled={isLoading}
              className="px-6 py-6 rounded-xl border-2 hover:bg-gray-50"
            >
              <ArrowRight className={`h-5 w-5 ${isRTL ? '' : 'rotate-180'}`} />
              <span className="sr-only">{personalDetailsDict.backButton}</span>
            </Button>

            <Button
              type="button"
              onClick={handleSubmit}
              disabled={!isFormValid || isLoading}
              // UPDATED: Main Gradient (Teal -> Orange -> Amber)
              className="flex-1 py-6 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 rounded-xl text-base font-semibold group relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {!isLoading && (
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />
              )}

              {isLoading ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin" />
                  <span>{personalDetailsDict.nextButtonLoading}</span>
                </>
              ) : (
                <>
                  <CheckCircle2 className="w-5 h-5" />
                  <span>{personalDetailsDict.nextButton}</span>
                  <ArrowLeft
                    className={`w-5 h-5 group-hover:-translate-x-1 transition-transform ${!isRTL ? 'rotate-180 group-hover:translate-x-1' : ''}`}
                  />
                </>
              )}
            </Button>
          </motion.div>
        </div>
      </motion.div>
    </>
  );
}
--- End of Content for PersonalDetailsStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\SubmissionStatusIndicator.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/SubmissionStatusIndicator.tsx
'use client';

import { CheckCircle, Loader2, ShieldCheck } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// ▼▼▼ 1. הוספת 'redirecting' לטיפוס ▼▼▼
export type SubmissionStatus =
  | 'idle'
  | 'creatingAccount'
  | 'sendingCode'
  | 'savingProfile'
  | 'updatingSession'
  | 'redirecting' // <--- חדש
  | 'error';

interface Step {
  id: SubmissionStatus;
  text: string;
}

interface SubmissionStatusIndicatorProps {
  currentStatus: SubmissionStatus;
  steps: Step[];
  dict: {
    title: string;
    subtitle: string;
  };
}

const SubmissionStatusIndicator: React.FC<SubmissionStatusIndicatorProps> = ({
  currentStatus,
  steps,
  dict,
}) => {
  const getStepStatus = (
    stepId: SubmissionStatus,
    current: SubmissionStatus
  ): 'completed' | 'in-progress' | 'pending' => {
    const stepIndex = steps.findIndex((s) => s.id === stepId);
    const currentIndex = steps.findIndex((s) => s.id === current);

    if (currentIndex === -1 || current === 'idle' || current === 'error') {
      return 'pending';
    }
    if (stepIndex < currentIndex) {
      return 'completed';
    }
    if (stepIndex === currentIndex) {
      return 'in-progress';
    }
    return 'pending';
  };

  const statusIcons = {
    completed: <CheckCircle className="h-6 w-6 text-green-500" />,
    'in-progress': <Loader2 className="h-6 w-6 animate-spin text-cyan-500" />,
    pending: (
      <div className="h-6 w-6 rounded-full border-2 border-gray-300"></div>
    ),
  };

  const isVisible = currentStatus !== 'idle' && currentStatus !== 'error';

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center z-50 p-4"
          aria-modal="true"
          role="dialog"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{ type: 'spring', stiffness: 260, damping: 20 }}
            className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden"
          >
            <div className="h-2 bg-gradient-to-r from-cyan-500 to-pink-500"></div>

            <div className="p-6 text-center">
              <div className="flex justify-center items-center gap-2 mb-4">
                <ShieldCheck className="h-7 w-7 text-cyan-500" />
                <h3 className="text-xl font-bold text-gray-800">
                  {dict.title}
                </h3>
              </div>
              <p className="text-sm text-gray-600 mb-6">{dict.subtitle}</p>

              <div className="space-y-4">
                {steps.map((step) => {
                  const status = getStepStatus(step.id, currentStatus);
                  return (
                    <div
                      key={step.id}
                      className="flex items-center gap-4 text-right p-3 bg-gray-50 rounded-lg"
                    >
                      <div className="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                        {statusIcons[status]}
                      </div>
                      <span
                        className={`text-base font-medium ${status === 'pending' ? 'text-gray-400' : 'text-gray-700'}`}
                      >
                        {step.text}
                      </span>
                    </div>
                  );
                })}
              </div>
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default SubmissionStatusIndicator;
--- End of Content for SubmissionStatusIndicator.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\WelcomeStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/WelcomeStep.tsx
'use client';

import { useState } from 'react';
import { useRegistration } from '../RegistrationContext';
import { signIn } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import { Heart, ArrowLeft, Mail, Loader2, ArrowRight } from 'lucide-react';
import Link from 'next/link';
import { motion } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface WelcomeStepProps {
  dict: RegisterStepsDict['steps']['welcome'];
  locale: 'he' | 'en';
}

const WelcomeStep: React.FC<WelcomeStepProps> = ({ dict, locale }) => {
  const { nextStep } = useRegistration();
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const isRTL = locale === 'he';

  const handleGoogleSignIn = async () => {
    try {
      setIsGoogleLoading(true);
      localStorage.setItem('registration_started', 'true');
      await signIn('google', undefined, { hl: locale });
    } catch (error) {
      console.error('Google sign-in error:', error);
      setIsGoogleLoading(false);
    }
  };

  const handleEmailSignUp = () => {
    nextStep();
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { 
      opacity: 1, 
      transition: { 
        staggerChildren: 0.1,
        delayChildren: 0.2 
      } 
    }
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5, ease: "easeOut" } }
  };

  return (
    <motion.div 
      className="space-y-8 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {/* --- Icon Header --- */}
      <motion.div variants={itemVariants} className="flex justify-center mb-6">
        <div className="relative">
          {/* UPDATED: Glow Effect (Rose/Orange) */}
          <div className="absolute inset-0 bg-rose-200/60 rounded-full blur-xl animate-pulse"></div>
          
          {/* UPDATED: Card Background (White/Rose/Orange) */}
          <div className="relative w-24 h-24 rounded-3xl bg-gradient-to-br from-white to-rose-50 border border-rose-100 flex items-center justify-center shadow-xl transform rotate-3 transition-transform hover:rotate-6 duration-500">
            {/* UPDATED: Icon Color (Rose to match the "Personal" principle) */}
            <Heart className="h-10 w-10 text-rose-500 fill-rose-500 drop-shadow-sm" />
          </div>
          
          {/* UPDATED: Decorative Element (Teal - for contrast) */}
          <motion.div 
            className="absolute -top-3 -right-3 w-10 h-10 rounded-full bg-gradient-to-br from-teal-400 to-emerald-500 flex items-center justify-center text-white text-lg font-bold shadow-lg border-2 border-white"
            animate={{ y: [0, -5, 0] }}
            transition={{ duration: 3, repeat: Infinity, ease: "easeInOut" }}
          >
            👋
          </motion.div>
        </div>
      </motion.div>

      {/* --- Title & Subtitle --- */}
      <motion.div variants={itemVariants} className="space-y-3">
        <h2 className="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
          {dict.title}
        </h2>
        <p className="text-gray-600 max-w-sm mx-auto text-lg leading-relaxed">
          {dict.subtitle}
        </p>
      </motion.div>

      {/* --- Action Buttons --- */}
      <motion.div variants={itemVariants} className="space-y-4 mt-8">
        {/* Google Button */}
        <Button
          onClick={handleGoogleSignIn}
          disabled={isGoogleLoading}
          variant="outline"
          size="lg"
          className="w-full relative z-20 bg-white hover:bg-gray-50 border-2 border-gray-200 hover:border-gray-300 py-7 rounded-2xl flex items-center justify-center gap-3 group transition-all duration-300 shadow-sm hover:shadow-md"
        >
          {isGoogleLoading ? (
            <Loader2 className="animate-spin h-5 w-5 text-gray-500" />
          ) : (
            <>
              {/* Google SVG remains standard colors */}
              <svg className="h-6 w-6 flex-shrink-0 transition-transform group-hover:scale-110 duration-300" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  fill="#4285F4"
                />
                <path
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  fill="#34A853"
                />
                <path
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  fill="#FBBC05"
                />
                <path
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  fill="#EA4335"
                />
              </svg>
              <span className="text-gray-700 font-semibold text-base">
                {dict.googleButton}
              </span>
            </>
          )}
        </Button>

        {/* Email Button */}
        <Button
          onClick={handleEmailSignUp}
          size="lg"
          // UPDATED: Gradient (Teal -> Orange -> Amber)
          className="w-full relative z-20 py-7 rounded-2xl bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-3 group overflow-hidden"
        >
          {/* Shine Effect */}
          <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"></span>
          
          <Mail className="h-5 w-5 text-white" />
          <span className="font-semibold text-base tracking-wide">{dict.emailButton}</span>
          {isRTL ? (
            <ArrowLeft className="h-5 w-5 text-white opacity-70 group-hover:opacity-100 group-hover:-translate-x-1 transition-all duration-300" />
          ) : (
            <ArrowRight className="h-5 w-5 text-white opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-300" />
          )}
        </Button>
      </motion.div>

      {/* --- Footer Links --- */}
      <motion.div 
        variants={itemVariants} 
        className="pt-6 border-t border-gray-100 relative z-20"
      >
        <p className="text-gray-500 text-sm">
          {dict.signInPrompt}{' '}
          {/* UPDATED: Link Gradient (Teal -> Orange) */}
          <Link
            href="/auth/signin"
            className="font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600 hover:from-teal-700 hover:to-orange-700 hover:underline transition-all"
          >
            {dict.signInLink}
          </Link>
        </p>
      </motion.div>

      <style>{`
        @keyframes shimmer {
          100% { transform: translateX(100%); }
        }
      `}</style>
    </motion.div>
  );
};

export default WelcomeStep;
--- End of Content for WelcomeStep.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\layout
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\layout\AvailabilityStatus.tsx
--------------------------------------------------------------------------------
Content:
// src/components/layout/AvailabilityStatus.tsx

'use client';
import React, { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import { AvailabilityStatus as AvailabilityStatusEnum } from '@prisma/client';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Textarea } from '@/components/ui/textarea';
import {
  AlertCircle,
  CheckCircle2,
  PauseCircle,
  Loader2,
  Heart,
  UserMinus,
  XCircle,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import type { Session } from 'next-auth';
import type { AvailabilityStatusDict } from '@/types/dictionary';

// --- עדכון פונקציית הסגנונות לפלטה החדשה (Teal/Rose/Orange) ---
const getStatusStyles = (status: AvailabilityStatusEnum) => {
  switch (status) {
    case AvailabilityStatusEnum.AVAILABLE:
      return {
        // שינוי: Cyan -> Teal
        dotClasses: 'bg-teal-500',
        pulse: true,
        icon: <CheckCircle2 />,
        iconColorClass: 'text-teal-600',
        // גרדיאנט תואם ל-Hero (Knowledge/Growth)
        dialogButtonClasses:
          'bg-gradient-to-r from-teal-500 via-teal-600 to-emerald-600 hover:from-teal-600 hover:via-teal-700 hover:to-emerald-700 text-white',
      };
    case AvailabilityStatusEnum.UNAVAILABLE:
      return {
        dotClasses: 'bg-slate-400', // שינוי ל-Slate למראה נקי יותר
        pulse: false,
        icon: <XCircle />,
        iconColorClass: 'text-slate-500',
        dialogButtonClasses:
          'bg-gradient-to-r from-slate-500 to-gray-600 hover:from-slate-600 hover:to-gray-700 text-white',
      };
    case AvailabilityStatusEnum.DATING:
      return {
        // שינוי: Pink -> Rose (תואם ל-Hero Personal/Emotion)
        dotClasses: 'bg-rose-500',
        pulse: false,
        icon: <Heart />,
        iconColorClass: 'text-rose-600',
        dialogButtonClasses:
          'bg-gradient-to-r from-rose-500 via-pink-500 to-red-500 hover:from-rose-600 hover:via-pink-600 hover:to-red-600 text-white',
      };
    case AvailabilityStatusEnum.PAUSED:
      return {
        // שינוי: Orange -> Orange/Amber (תואם ל-Hero Privacy/Human)
        dotClasses: 'bg-orange-500',
        pulse: false,
        icon: <PauseCircle />,
        iconColorClass: 'text-orange-600',
        dialogButtonClasses:
          'bg-gradient-to-r from-orange-500 via-amber-500 to-yellow-500 hover:from-orange-600 hover:via-amber-600 hover:to-yellow-600 text-white',
      };
    case AvailabilityStatusEnum.ENGAGED:
      return {
        // שינוי: תואם ל-Dating עם Pulse
        dotClasses: 'bg-rose-500',
        pulse: true,
        icon: <Heart fill="currentColor" />,
        iconColorClass: 'text-rose-600',
        dialogButtonClasses:
          'bg-gradient-to-r from-rose-500 via-pink-500 to-red-500 hover:from-rose-600 hover:via-pink-600 hover:to-red-600 text-white',
      };
    case AvailabilityStatusEnum.MARRIED:
      return {
        dotClasses: 'bg-slate-400',
        pulse: false,
        icon: <UserMinus />,
        iconColorClass: 'text-slate-500',
        dialogButtonClasses:
          'bg-gradient-to-r from-slate-500 to-gray-600 hover:from-slate-600 hover:to-gray-700 text-white',
      };
    default:
      return {
        dotClasses: 'bg-gray-400',
        pulse: false,
        icon: <AlertCircle />,
        iconColorClass: 'text-gray-500',
        dialogButtonClasses:
          'bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white',
      };
  }
};

interface AvailabilityStatusProps {
  dict: AvailabilityStatusDict;
}

export default function AvailabilityStatus({ dict }: AvailabilityStatusProps) {
  const { update: updateSession } = useSession();
  const { data: session } = useSession() as { data: Session | null };

  const [showDialog, setShowDialog] = useState(false);
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);

  const initialStatus =
    session?.user?.profile?.availabilityStatus ||
    AvailabilityStatusEnum.AVAILABLE;
  const initialNote = session?.user?.profile?.availabilityNote || '';

  const [status, setStatus] = useState<AvailabilityStatusEnum>(initialStatus);
  const [note, setNote] = useState(initialNote);

  const [isUpdating, setIsUpdating] = useState(false);
  const [error, setError] = useState('');

  // סנכרון עם הסשן כשהוא מתעדכן
  useEffect(() => {
    if (session?.user?.profile) {
      setStatus(
        session.user.profile.availabilityStatus ||
          AvailabilityStatusEnum.AVAILABLE
      );
      setNote(session.user.profile.availabilityNote || '');
    }
  }, [session]);

  const handleUpdate = async () => {
    setIsUpdating(true);
    setError('');

    try {
      const response = await fetch('/api/profile/availability', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          availabilityStatus: status,
          availabilityNote: note || '',
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to update status');
      }

      // כאן הקריאה לשרת לחידוש הסשן. עם התיקון ב-auth.ts זה יחזיר את הסטטוס החדש.
      await updateSession();

      setShowDialog(false);
      setShowSuccessDialog(true);
    } catch (err) {
      console.error('Error in update:', err);
      setError(err instanceof Error ? err.message : dict.updateError);
    } finally {
      setIsUpdating(false);
    }
  };

  const displayStatus =
    session?.user?.profile?.availabilityStatus ||
    AvailabilityStatusEnum.AVAILABLE;
  const currentStatusStyles = getStatusStyles(displayStatus);
  const editingStatusStyles = getStatusStyles(status);

  if (!session?.user) return null;

  return (
    <>
      <Button
        id="onboarding-target-availability-status"
        variant="ghost"
        onClick={() => {
          setStatus(
            session?.user?.profile?.availabilityStatus ||
              AvailabilityStatusEnum.AVAILABLE
          );
          setNote(session?.user?.profile?.availabilityNote || '');
          setError('');
          setShowDialog(true);
        }}
        // שינוי: ריווח פנימי ואפקט hover עדין יותר
        className="flex items-center gap-x-2 px-3 h-10 rounded-full font-medium text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors border border-transparent hover:border-gray-200"
      >
        <span className="relative flex h-2.5 w-2.5">
          {currentStatusStyles.pulse && (
            <span
              className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${currentStatusStyles.dotClasses}`}
            ></span>
          )}
          <span
            className={`relative inline-flex rounded-full h-2.5 w-2.5 ${currentStatusStyles.dotClasses}`}
          ></span>
        </span>
        <span className="text-sm">{dict.status[displayStatus]}</span>
      </Button>

      <Dialog open={showDialog} onOpenChange={setShowDialog}>
        <DialogContent className="sm:max-w-md p-6 bg-white rounded-xl shadow-2xl border-gray-100">
          <DialogHeader className="mb-4 text-right">
            <DialogTitle className="text-2xl font-bold text-gray-800">
              {dict.dialogTitle}
            </DialogTitle>
            <DialogDescription className="text-sm text-gray-600">
              {dict.dialogDescription}
            </DialogDescription>
          </DialogHeader>

          <div className="grid gap-6 py-4">
            <div className="space-y-2">
              <label
                htmlFor="status-select"
                className="text-sm font-medium text-gray-700"
              >
                {dict.statusLabel}
              </label>
              <Select
                value={status}
                onValueChange={(value) =>
                  setStatus(value as AvailabilityStatusEnum)
                }
                disabled={isUpdating}
              >
                {/* שינוי: Focus Ring ל-Teal */}
                <SelectTrigger
                  id="status-select"
                  className="w-full rounded-lg h-12 text-base bg-gray-50 border-gray-200 focus:ring-2 focus:ring-teal-400 focus:border-teal-400 transition-all"
                >
                  <SelectValue placeholder={dict.selectPlaceholder} />
                </SelectTrigger>
                <SelectContent className="rounded-lg">
                  {Object.values(AvailabilityStatusEnum).map((enumKey) => {
                    const itemStyle = getStatusStyles(enumKey);
                    return (
                      <SelectItem
                        key={enumKey}
                        value={enumKey}
                        className="cursor-pointer text-base py-2.5"
                      >
                        <div className="flex items-center gap-3">
                          {React.cloneElement(itemStyle.icon, {
                            className: `w-4 h-4 ${itemStyle.iconColorClass}`,
                          })}
                          <span>{dict.status[enumKey]}</span>
                        </div>
                      </SelectItem>
                    );
                  })}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label
                htmlFor="status-note"
                className="text-sm font-medium text-gray-700"
              >
                {dict.noteLabel}
              </label>
              <Textarea
                id="status-note"
                placeholder={dict.notePlaceholder}
                value={note}
                onChange={(e) => setNote(e.target.value)}
                disabled={isUpdating}
                // שינוי: Focus Ring ל-Teal
                className="rounded-lg min-h-[100px] text-base bg-gray-50 border-gray-200 focus:ring-2 focus:ring-teal-400 focus:border-teal-400 placeholder:text-gray-400 transition-all"
              />
            </div>
          </div>

          {error && (
            <Alert variant="destructive" className="rounded-lg">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          <DialogFooter className="mt-6 sm:justify-between gap-2">
            <Button
              variant="ghost"
              onClick={() => setShowDialog(false)}
              disabled={isUpdating}
              className="rounded-lg text-gray-600 hover:bg-gray-100"
            >
              {dict.cancelButton}
            </Button>
            <Button
              onClick={handleUpdate}
              disabled={isUpdating}
              className={`rounded-lg px-6 h-11 text-base font-medium transition-all shadow-md hover:shadow-lg ${editingStatusStyles.dialogButtonClasses}`}
            >
              {isUpdating ? (
                <Loader2 className="h-5 w-5 animate-spin" />
              ) : (
                dict.updateButton
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <AlertDialog open={showSuccessDialog} onOpenChange={setShowSuccessDialog}>
        <AlertDialogContent className="sm:max-w-md p-6 bg-white rounded-xl shadow-2xl">
          <AlertDialogHeader className="text-center">
            {/* שינוי: רקע האייקון ל-Teal */}
            <div className="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-teal-100 mb-4">
              <CheckCircle2 className="h-8 w-8 text-teal-600" />
            </div>
            <AlertDialogTitle className="text-xl font-bold text-gray-800">
              {dict.successDialogTitle}
            </AlertDialogTitle>
            <AlertDialogDescription className="text-sm text-gray-600 mt-2">
              {dict.successDialogDescription}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogAction
            onClick={() => setShowSuccessDialog(false)}
            // שינוי: כפתור אישור ב-Teal Gradient
            className="w-full mt-4 rounded-lg bg-gradient-to-r from-teal-500 to-emerald-600 text-white text-base h-11 shadow-md hover:shadow-lg transition-all border-none"
          >
            {dict.successDialogAction}
          </AlertDialogAction>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
--- End of Content for AvailabilityStatus.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\layout\FeedbackWidget.tsx
--------------------------------------------------------------------------------
Content:
// src/components/layout/FeedbackWidget.tsx

'use client';

import React, { useState, useRef, useEffect, Fragment } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
  MessageSquare,
  ThumbsUp,
  Bug,
  Lightbulb,
  Loader2,
  Paperclip,
  X,
  Send,
  Sparkles,
} from 'lucide-react';
import type { FeedbackWidgetDict } from '@/types/dictionary';

interface FeedbackWidgetProps {
  dict: FeedbackWidgetDict;
  locale?: string;
}

type FeedbackType = 'SUGGESTION' | 'BUG' | 'POSITIVE';

const FeedbackWidget: React.FC<FeedbackWidgetProps> = ({
  dict,
  locale = 'en',
}) => {
  const isRTL = locale === 'he' || locale === 'ar';

  const [isOpen, setIsOpen] = useState(false);
  const [step, setStep] = useState<'type' | 'form'>('type');
  const [feedbackType, setFeedbackType] = useState<FeedbackType | null>(null);
  const [content, setContent] = useState('');
  const [screenshot, setScreenshot] = useState<File | null>(null);
  const [screenshotPreview, setScreenshotPreview] = useState<string | null>(
    null
  );
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isHovered, setIsHovered] = useState(false);
  const [isPermanentlyHidden, setIsPermanentlyHidden] = useState(false);
  const [touchStart, setTouchStart] = useState<number | null>(null);
  const [touchEnd, setTouchEnd] = useState<number | null>(null);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const tabButtonRef = useRef<HTMLButtonElement>(null);
  const [isProcessingClick, setIsProcessingClick] = useState(false);

  useEffect(() => {
    if (isOpen) {
      setIsTransitioning(true);
      const timer = setTimeout(() => {
        setIsTransitioning(false);
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [isOpen]);

  useEffect(() => {
    const hidden = localStorage.getItem('feedback-widget-hidden');
    if (hidden === 'true') {
      setIsPermanentlyHidden(true);
    }
  }, []);

  const feedbackOptions = [
    {
      type: 'SUGGESTION' as FeedbackType,
      icon: Lightbulb,
      label: dict.types.suggestion.label,
      description: dict.types.suggestion.description,
      // שינוי: גרדיאנט המותג הראשי
      gradient: 'from-teal-400 via-orange-400 to-amber-400',
    },
    {
      type: 'BUG' as FeedbackType,
      icon: Bug,
      label: dict.types.bug.label,
      description: dict.types.bug.description,
      // שינוי: Rose/Red (תואם ל-AvailabilityStatus - Engaged/Error)
      gradient: 'from-rose-500 via-red-500 to-orange-500',
    },
    {
      type: 'POSITIVE' as FeedbackType,
      icon: ThumbsUp,
      label: dict.types.positive.label,
      description: dict.types.positive.description,
      // שינוי: Teal/Emerald (תואם ל-AvailabilityStatus - Available)
      gradient: 'from-teal-400 via-emerald-400 to-teal-500',
    },
  ];

  const minSwipeDistance = 50;

  const onTouchStart = (e: React.TouchEvent) => {
    setTouchEnd(null);
    setTouchStart(e.targetTouches[0].clientX);
    e.preventDefault();
  };

  const onTouchMove = (e: React.TouchEvent) => {
    setTouchEnd(e.targetTouches[0].clientX);
  };

  const onTouchEnd = (e: React.TouchEvent) => {
    if (!touchStart || !touchEnd) {
      if (!isProcessingClick) {
        setIsProcessingClick(true);
        setTimeout(() => {
          setStep('type');
          setIsOpen(true);
          setIsProcessingClick(false);
        }, 50);
      }
      return;
    }

    const distance = touchStart - touchEnd;
    const isRightSwipe = distance < -minSwipeDistance;

    if (isRightSwipe) {
      handleHidePermanently();
    } else {
      if (!isProcessingClick) {
        setIsProcessingClick(true);
        setTimeout(() => {
          setStep('type');
          setIsOpen(true);
          setIsProcessingClick(false);
        }, 50);
      }
    }
  };

  const handleHidePermanently = () => {
    setIsPermanentlyHidden(true);
    localStorage.setItem('feedback-widget-hidden', 'true');
  };

  const handleShowWidget = () => {
    setIsPermanentlyHidden(false);
    localStorage.setItem('feedback-widget-hidden', 'false');
  };

  useEffect(() => {
    if (screenshot) {
      const reader = new FileReader();
      reader.onloadend = () => setScreenshotPreview(reader.result as string);
      reader.readAsDataURL(screenshot);
    } else {
      setScreenshotPreview(null);
    }
  }, [screenshot]);

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (!isOpen || step !== 'form') {
      if (event.target) event.target.value = '';
      return;
    }

    const file = event.target.files?.[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        toast.error(dict.toasts.imageTooLarge);
        return;
      }
      setScreenshot(file);
    }
    if (event.target) event.target.value = '';
  };

  const resetState = (closeWidget: boolean = true) => {
    if (closeWidget) {
      setIsOpen(false);
      setTimeout(() => {
        setStep('type');
        setFeedbackType(null);
        setContent('');
        setScreenshot(null);
        setScreenshotPreview(null);
      }, 300);
    } else {
      setStep('type');
      setFeedbackType(null);
      setContent('');
      setScreenshot(null);
      setScreenshotPreview(null);
    }
  };

  const handleTabClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();

    if (isProcessingClick || isOpen) return;

    setIsProcessingClick(true);
    setTimeout(() => {
      setStep('type');
      setIsOpen(true);
      setIsProcessingClick(false);
    }, 50);
  };

  const handleFileButtonClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();

    if (step === 'form' && isOpen && !isTransitioning) {
      fileInputRef.current?.click();
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!content.trim() || !feedbackType) {
      toast.error(dict.toasts.contentRequired);
      return;
    }

    setIsSubmitting(true);
    const formData = new FormData();
    formData.append('content', content);
    formData.append('feedbackType', feedbackType);
    formData.append('pageUrl', window.location.href);
    if (screenshot) {
      formData.append('screenshot', screenshot);
    }

    try {
      const response = await fetch('/api/feedback', {
        method: 'POST',
        body: formData,
      });
      if (!response.ok) throw new Error('Failed to submit feedback');
      toast.success(dict.toasts.submitSuccess);
      resetState();
    } catch (error) {
      console.error(error);
      toast.error(dict.toasts.submitError);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Fragment>
      {/* Floating Tab Button */}
      <div className="fixed top-1/2 -translate-y-1/2 right-0 z-50">
        <div
          className={`transition-all duration-700 ${
            isOpen || isPermanentlyHidden
              ? 'translate-x-4 opacity-0 scale-95'
              : 'translate-x-0 opacity-100 scale-100'
          }`}
        >
          <div className="relative group">
            <button
              ref={tabButtonRef}
              onClick={handleTabClick}
              onMouseEnter={() => setIsHovered(true)}
              onMouseLeave={() => setIsHovered(false)}
              onTouchStart={onTouchStart}
              onTouchMove={onTouchMove}
              onTouchEnd={onTouchEnd}
              disabled={isProcessingClick}
              // שינוי: גרדיאנט ראשי (Teal -> Orange -> Amber)
              className={`relative text-white px-1.5 sm:px-2 py-4 sm:py-6 shadow-xl hover:shadow-2xl transition-all duration-300 flex flex-col items-center justify-center min-h-[100px] sm:min-h-[120px] hover:scale-105 active:scale-95 overflow-hidden bg-gradient-to-l from-teal-500 via-orange-500 to-amber-500 bg-size-200 hover:bg-pos-100 disabled:opacity-50 disabled:cursor-not-allowed rounded-l-2xl ${
                isHovered ? 'w-20 sm:w-32' : 'w-8 sm:w-12'
              }`}
              style={{
                backgroundSize: '200% 100%',
                backgroundPosition: isHovered ? '100% 0' : '0% 0',
              }}
              aria-label={dict.openAriaLabel}
            >
              <div className="absolute inset-0 bg-white/10 backdrop-blur-sm" />

              <div className="relative z-10 flex flex-col items-center justify-center h-full">
                <MessageSquare className="w-4 h-4 sm:w-5 sm:h-5 transition-all duration-300 mb-2 sm:mb-3 drop-shadow-sm" />

                {!isHovered ? (
                  <span
                    className="text-xs sm:text-sm font-bold tracking-wider transition-all duration-300 ease-in-out drop-shadow-sm"
                    style={{
                      writingMode: 'vertical-rl',
                      textOrientation: 'mixed',
                    }}
                  >
                    {dict.tabLabel}
                  </span>
                ) : (
                  <span className="text-xs sm:text-sm font-bold whitespace-nowrap transition-all duration-300 ease-in-out drop-shadow-sm px-1">
                    {dict.tabLabel}
                  </span>
                )}
              </div>

              {/* שינוי: הילה בצבעי Teal/Orange */}
              <div className="absolute -inset-1 bg-gradient-to-br from-teal-400 via-orange-400 to-amber-400 rounded-2xl blur opacity-30 group-hover:opacity-60 transition-all duration-300" />

              {isHovered && (
                <>
                  <div className="absolute -top-1 -right-1 w-2 h-2 sm:w-3 sm:h-3 bg-amber-400 rounded-full animate-ping shadow-lg" />
                  <div className="absolute -bottom-1 -left-1 w-1.5 h-1.5 sm:w-2 sm:h-2 bg-teal-400 rounded-full animate-bounce delay-300 shadow-lg" />
                  <div className="absolute top-1/2 -left-1 w-1 h-1 sm:w-1.5 sm:h-1.5 bg-orange-400 rounded-full animate-pulse delay-500 shadow-lg" />
                </>
              )}
            </button>

            <button
              onClick={(e) => {
                e.stopPropagation();
                handleHidePermanently();
              }}
              // שינוי: כפתור סגירה ב-Rose
              className="absolute -top-2 -left-2 w-6 h-6 bg-white/90 hover:bg-rose-500 text-gray-600 hover:text-white rounded-full flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 group/close opacity-0 group-hover:opacity-100 backdrop-blur-sm border border-gray-200 z-20"
              aria-label="הסתר כפתור פידבק"
            >
              <X className="w-3 h-3 group-hover/close:rotate-45 transition-all duration-300" />
            </button>
          </div>
        </div>

        {isPermanentlyHidden && (
          <div className="transition-all duration-700 opacity-100 translate-x-0">
            <button
              onClick={handleShowWidget}
              // שינוי: כפתור חזרה ב-Teal/Orange
              className="w-8 h-8 bg-gradient-to-r from-teal-500 to-amber-500 hover:from-teal-600 hover:to-amber-600 text-white rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-110 group/show"
              aria-label="הצג כפתור משוב"
              title="הצג כפתור משוב"
            >
              <MessageSquare className="w-4 h-4 group-hover/show:scale-110 transition-transform duration-300" />
              <div className="absolute inset-0 rounded-full bg-gradient-to-r from-teal-400 to-amber-400 animate-ping opacity-20"></div>
            </button>
          </div>
        )}
      </div>

      {isOpen && (
        <div
          className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 transition-all duration-500"
          onClick={() => resetState()}
        />
      )}

      {/* Main Widget */}
      <div
        className={cn(
          'fixed inset-x-4 top-1/2 -translate-y-1/2 sm:top-1/2 sm:-translate-y-1/2 sm:right-16 sm:left-auto sm:right-24 z-50 w-auto sm:w-96 max-w-lg mx-auto sm:mx-0 transition-all duration-500',
          isOpen
            ? 'opacity-100 translate-x-0 scale-100'
            : 'opacity-0 translate-x-8 scale-95 pointer-events-none',
          isTransitioning && 'pointer-events-none'
        )}
      >
        <div className="bg-white/95 backdrop-blur-xl rounded-2xl sm:rounded-3xl shadow-2xl border border-white/50 overflow-hidden max-h-[85vh] sm:max-h-none overflow-y-auto">
          {/* שינוי: הילת רקע ב-Teal/Orange */}
          <div className="absolute -inset-1 bg-gradient-to-r from-teal-400/20 via-orange-400/20 to-amber-400/20 rounded-2xl sm:rounded-3xl blur-xl" />

          <div className="relative">
            {/* שינוי: כותרת עם רקע Teal עדין */}
            <div className="bg-gradient-to-r from-teal-500/10 via-orange-500/5 to-amber-500/10 p-4 sm:p-6 border-b border-white/30">
              <div
                className={`flex items-center justify-between ${isRTL ? 'flex-row-reverse' : ''}`}
              >
                <div
                  className={`flex items-center gap-2 sm:gap-3 ${isRTL ? 'flex-row-reverse' : ''}`}
                >
                  <div className="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-gradient-to-r from-teal-400 to-amber-400 rounded-full animate-pulse shadow-lg" />
                  <div className={isRTL ? 'text-right' : 'text-left'}>
                    <h3 className="text-lg sm:text-xl font-bold bg-gradient-to-r from-teal-600 via-orange-500 to-amber-400 bg-clip-text text-transparent">
                      {dict.title}
                    </h3>
                    <p className="text-xs sm:text-sm text-gray-600 mt-1">
                      {dict.subtitle}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => resetState()}
                  className="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white/50 hover:bg-white/70 flex items-center justify-center transition-all duration-300 group hover:scale-110"
                  aria-label={dict.closeAriaLabel}
                >
                  <X className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-600 group-hover:text-gray-800 transition-colors" />
                </button>
              </div>
            </div>

            <div className="p-4 sm:p-6">
              {step === 'type' && (
                <div className="space-y-3 sm:space-y-4">
                  <div className="text-center mb-4 sm:mb-6">
                    <Sparkles className="w-6 h-6 sm:w-8 sm:h-8 text-transparent bg-gradient-to-r from-teal-500 to-amber-500 bg-clip-text mx-auto mb-2" />
                    <p className="text-gray-700 font-medium text-sm sm:text-base">
                      {dict.step_type_title}
                    </p>
                  </div>

                  {feedbackOptions.map((option) => (
                    <button
                      key={option.type}
                      onClick={() => {
                        setFeedbackType(option.type);
                        setStep('form');
                      }}
                      // שינוי: בורדר ו-Hover ב-Teal
                      className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl bg-gradient-to-r from-gray-50/80 to-white/80 hover:from-white to-gray-50 border border-gray-100/50 hover:border-teal-200/50 transition-all duration-300 group flex items-center gap-3 sm:gap-4 hover:shadow-md hover:scale-[1.02] ${
                        isRTL ? 'flex-row-reverse' : ''
                      }`}
                    >
                      <div
                        className={`w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-gradient-to-br ${option.gradient} flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300`}
                      >
                        <option.icon className="w-5 h-5 sm:w-6 sm:h-6 text-white drop-shadow-sm" />
                      </div>
                      <div
                        className={`flex-1 ${isRTL ? 'text-right' : 'text-left'}`}
                      >
                        <div className="font-medium text-gray-800 mb-1 text-sm sm:text-base">
                          {option.label}
                        </div>
                        <div className="text-xs sm:text-sm text-gray-500">
                          {option.description}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}

              {step === 'form' && (
                <div className="space-y-4 sm:space-y-6">
                  <button
                    onClick={() => setStep('type')}
                    className={`text-sm text-gray-500 hover:text-teal-600 flex items-center gap-2 transition-colors duration-300 group ${
                      isRTL ? 'flex-row-reverse' : ''
                    }`}
                  >
                    <span
                      className={`transition-transform ${
                        isRTL
                          ? 'group-hover:-translate-x-1'
                          : 'group-hover:translate-x-1'
                      }`}
                    >
                      {isRTL ? '→' : '←'}
                    </span>
                    {dict.cancelButton}
                  </button>

                  <div
                    className={`flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 bg-gradient-to-r from-gray-50/80 to-white/80 rounded-lg sm:rounded-xl border border-gray-100/50 ${
                      isRTL ? 'flex-row-reverse' : ''
                    }`}
                  >
                    {(() => {
                      const selectedOption = feedbackOptions.find(
                        (option) => option.type === feedbackType
                      );
                      return selectedOption ? (
                        <>
                          <div
                            className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-gradient-to-br ${selectedOption.gradient} flex items-center justify-center shadow-md`}
                          >
                            <selectedOption.icon className="w-4 h-4 sm:w-5 sm:h-5 text-white drop-shadow-sm" />
                          </div>
                          <div
                            className={`flex-1 ${isRTL ? 'text-right' : 'text-left'}`}
                          >
                            <div className="font-medium text-gray-800 text-sm sm:text-base">
                              {selectedOption.label}
                            </div>
                            <div className="text-xs sm:text-sm text-gray-500">
                              {selectedOption.description}
                            </div>
                          </div>
                        </>
                      ) : null;
                    })()}
                  </div>

                  <Textarea
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    placeholder={dict.placeholder}
                    // שינוי: Focus ב-Teal
                    className={`min-h-[100px] sm:min-h-[120px] resize-none border-0 bg-gray-50/80 focus:bg-white focus:ring-2 focus:ring-teal-400 rounded-xl sm:rounded-2xl shadow-inner transition-all duration-300 placeholder:text-gray-400 text-sm sm:text-base ${
                      isRTL ? 'text-right' : 'text-left'
                    }`}
                    dir={isRTL ? 'rtl' : 'ltr'}
                    required
                  />

                  <div className="space-y-3 sm:space-y-4">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                      <button
                        type="button"
                        onClick={handleFileButtonClick}
                        disabled={isTransitioning}
                        // שינוי: Border ב-Teal/Orange ב-Hover
                        className="group relative px-3 py-2.5 sm:px-4 sm:py-3 bg-gradient-to-r from-gray-50 to-white border-2 border-gray-200 hover:border-teal-300 rounded-lg sm:rounded-xl transition-all duration-300 flex items-center gap-2 sm:gap-3 hover:shadow-md hover:scale-[1.02] overflow-hidden w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <div className="absolute inset-0 bg-gradient-to-r from-teal-50/50 via-orange-50/30 to-amber-50/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300" />

                        <div className="relative">
                          <Paperclip className="w-4 h-4 text-gray-600 group-hover:text-teal-600 transition-all duration-300 group-hover:rotate-12" />
                          <div className="absolute inset-0 border-2 border-teal-400 rounded-full opacity-0 group-hover:opacity-100 group-hover:animate-ping" />
                        </div>

                        <span className="text-xs sm:text-sm font-medium text-gray-700 group-hover:text-teal-700 transition-colors duration-300 relative z-10">
                          {dict.attachScreenshot}
                        </span>

                        <div className="w-2 h-2 bg-gradient-to-r from-teal-400 to-amber-400 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 animate-pulse" />
                      </button>

                      {screenshotPreview && (
                        <div className="flex items-center justify-center sm:justify-start">
                          <div className="relative group/preview">
                            <div className="relative w-12 h-12 sm:w-16 sm:h-16 rounded-lg sm:rounded-xl overflow-hidden border-2 border-teal-200 shadow-lg bg-white">
                              <img
                                src={screenshotPreview}
                                alt="Screenshot preview"
                                className="w-full h-full object-cover transition-transform duration-300 group-hover/preview:scale-110"
                              />
                              <div className="absolute inset-0 bg-black/0 group-hover/preview:bg-black/20 transition-colors duration-300" />
                            </div>

                            <button
                              type="button"
                              onClick={() => setScreenshot(null)}
                              className="absolute -top-1.5 -right-1.5 sm:-top-2 sm:-right-2 w-5 h-5 sm:w-6 sm:h-6 bg-gradient-to-r from-rose-500 to-red-600 hover:from-rose-600 hover:to-red-700 text-white rounded-full flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 group/remove"
                            >
                              <X className="w-2.5 h-2.5 sm:w-3 sm:h-3 group-hover/remove:rotate-90 transition-transform duration-300" />
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    <div
                      className={`text-xs text-gray-500 flex items-center gap-2 ${
                        isRTL ? 'flex-row-reverse' : ''
                      }`}
                    >
                      <div className="w-1.5 h-1.5 bg-gradient-to-r from-teal-400 to-amber-400 rounded-full" />
                      <span>{dict.fileInstructions}</span>
                    </div>

                    <input
                      type="file"
                      ref={fileInputRef}
                      onChange={handleFileChange}
                      accept="image/png, image/jpeg, image/webp"
                      className="hidden"
                      tabIndex={-1}
                    />
                  </div>

                  <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-3 sm:pt-4">
                    <Button
                      type="button"
                      variant="ghost"
                      onClick={() => resetState()}
                      className="flex-1 hover:bg-gray-100 transition-colors duration-300 text-sm sm:text-base"
                    >
                      {dict.cancelButton}
                    </Button>
                    <Button
                      onClick={handleSubmit}
                      disabled={isSubmitting || !content.trim()}
                      // שינוי: כפתור ראשי ב-Teal/Orange Gradient
                      className="flex-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-lg sm:rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed font-bold text-sm sm:text-base"
                    >
                      {isSubmitting ? (
                        <div
                          className={`flex items-center gap-2 ${isRTL ? 'flex-row-reverse' : ''}`}
                        >
                          <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" />
                          <span>{dict.submittingButton}</span>
                        </div>
                      ) : (
                        <div
                          className={`flex items-center gap-2 ${isRTL ? 'flex-row-reverse' : ''}`}
                        >
                          <Send className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                          <span>{dict.submitButton}</span>
                        </div>
                      )}
                    </Button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </Fragment>
  );
};

export default FeedbackWidget;
--- End of Content for FeedbackWidget.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\layout\Navbar.tsx
--------------------------------------------------------------------------------
Content:
// src/components/layout/Navbar.tsx

'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { useSession, signOut } from 'next-auth/react';
import { usePathname, useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import AvailabilityStatus from './AvailabilityStatus';
import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';
import {
  Users,
  User,
  LogOut,
  LogIn,
  UserPlus,
  MessageCircle,
  Settings,
  Heart,
  Menu,
  X,
  Globe,
  Lightbulb,
  Info,
  Award,
  HelpCircle,
  Mail,
} from 'lucide-react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import UserDropdown from './UserDropdown';
import type { Dictionary } from '@/types/dictionary';
import { useQuestionnaireState } from '@/app/[locale]/contexts/QuestionnaireStateContext';

// --- רכיב לוגו (מעודכן: Teal -> Orange -> Amber) ---
const Logo = ({ locale }: { locale: string }) => (
  <Link
    href={`/${locale}`}
    className="flex items-center gap-x-2 group shrink-0"
    aria-label="NeshamaTech Homepage"
  >
    <div className="relative h-9 w-9">
      <Image
        src={getRelativeCloudinaryPath(
          'https://res.cloudinary.com/dmfxoi6g0/image/upload/v1753713907/ChatGPT_Image_Jul_28_2025_05_45_00_PM_zueqou.png'
        )}
        alt="NeshamaTech Icon"
        fill
        className="object-contain transition-transform duration-300 group-hover:scale-110"
        priority
      />
    </div>
    <span className="text-xl font-bold bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500 text-transparent bg-clip-text bg-size-200 bg-pos-0 group-hover:bg-pos-100 transition-all duration-700 ease-in-out">
      NeshamaTech
    </span>
  </Link>
);

// --- רכיבי ניווט (מעודכנים: Teal/Orange Highlights) ---
const NavItem = ({
  href,
  text,
  badge,
  id,
}: {
  href: string;
  text: string;
  badge?: number;
  id?: string;
}) => {
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'he';
  const fullHref = `/${locale}${href}`;
  const isActive =
    pathname === fullHref || (href !== '/' && pathname.startsWith(fullHref));
  return (
    <Link
      id={id}
      href={fullHref}
      aria-current={isActive ? 'page' : undefined}
      className={cn(
        'relative px-3 py-2 rounded-full text-sm transition-all duration-200',
        isActive
          ? 'font-bold text-teal-700 bg-teal-50'
          : 'font-medium text-gray-600 hover:text-teal-600 hover:bg-teal-50/50'
      )}
    >
      {text}
      {badge !== undefined && badge > 0 && (
        <motion.span
          className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-gradient-to-r from-orange-500 to-amber-500 text-white text-[10px] font-bold shadow-sm border-2 border-white"
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ type: 'spring', stiffness: 500, damping: 30 }}
        >
          <span className="absolute inline-flex h-full w-full animate-ping rounded-full bg-orange-400 opacity-75"></span>
          <span className="relative">{badge}</span>
        </motion.span>
      )}
    </Link>
  );
};

const MobileNavItem = ({
  href,
  text,
  icon,
  badge,
  onClick,
  id,
  isRtl,
}: {
  href: string;
  text: string;
  icon?: React.ReactNode;
  badge?: number;
  onClick: () => void;
  id?: string;
  isRtl: boolean;
}) => {
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'he';
  const fullHref = `/${locale}${href}`;
  const isActive =
    pathname === fullHref || (href !== '/' && pathname.startsWith(fullHref));
  return (
    <Link
      id={id}
      href={fullHref}
      aria-current={isActive ? 'page' : undefined}
      onClick={onClick}
      className={cn(
        'flex items-center px-4 py-3 rounded-xl text-base font-medium transition-colors duration-150 group gap-4 mb-1 touch-manipulation active:bg-gray-100',
        isActive
          ? 'bg-teal-50 text-teal-700 shadow-sm border border-teal-100/50'
          : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
      )}
    >
      {icon && (
        <span
          className={cn(
            'transition-colors',
            isActive
              ? 'text-teal-600'
              : 'text-gray-400 group-hover:text-gray-600'
          )}
        >
          {icon}
        </span>
      )}
      <span className="flex-grow">{text}</span>
      {badge !== undefined && badge > 0 && (
        <span
          className={cn(
            'bg-gradient-to-r from-orange-500 to-amber-500 text-white text-xs px-2 py-0.5 rounded-full flex items-center justify-center font-bold shadow-sm',
            isRtl ? 'mr-auto' : 'ml-auto'
          )}
        >
          {badge}
        </span>
      )}
    </Link>
  );
};

const MobileHomePageLink = ({
  href,
  text,
  icon,
  onClick,
}: {
  href: string;
  text: string;
  icon: React.ReactNode;
  onClick: () => void;
}) => {
  const handleScroll = (
    e: React.MouseEvent<HTMLAnchorElement> | React.TouchEvent<HTMLAnchorElement>
  ) => {
    e.preventDefault();
    const element = document.querySelector(href);
    if (element) {
      const navHeight = 80;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - navHeight;
      window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    }
    onClick();
  };
  return (
    <a
      href={href}
      onClick={handleScroll}
      onTouchEnd={handleScroll}
      className="flex items-center px-4 py-3 rounded-xl text-base font-medium transition-colors duration-150 group text-gray-600 hover:bg-gray-50 hover:text-gray-900 gap-4 touch-manipulation active:bg-gray-100"
    >
      <span className="text-gray-400 group-hover:text-gray-600">{icon}</span>
      <span className="flex-grow">{text}</span>
    </a>
  );
};

interface NavbarProps {
  dict: Dictionary;
}

const Navbar = ({ dict }: NavbarProps) => {
  const { data: session } = useSession();
  const pathname = usePathname();
  const router = useRouter();

  const { isDirty, promptNavigation } = useQuestionnaireState();

  const isMatchmaker =
    session?.user?.role === 'MATCHMAKER' || session?.user?.role === 'ADMIN';
  const { notifications } = useNotifications();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [scrolled, setScrolled] = useState(false);

  const locale = (pathname.split('/')[1] || 'he') as 'he' | 'en';
  const isRtl = locale === 'he';

  const isHomePage = pathname === `/${locale}` || pathname === '/';

  const homePageLinks = dict.stickyNav?.navLinks
    ? [
        {
          id: 'how-it-works',
          text: dict.stickyNav.navLinks.howItWorks,
          icon: <Info className="h-5 w-5" />,
        },
        {
          id: 'suggestion-demo',
          text: dict.stickyNav.navLinks.suggestionDemo,
          icon: <Heart className="h-5 w-5" />,
        },
        {
          id: 'success-stories',
          text: dict.stickyNav.navLinks.successStories,
          icon: <Award className="h-5 w-5" />,
        },
        {
          id: 'our-team',
          text: dict.stickyNav.navLinks.ourTeam,
          icon: <Users className="h-5 w-5" />,
        },
        {
          id: 'faq',
          text: dict.stickyNav.navLinks.faq,
          icon: <HelpCircle className="h-5 w-5" />,
        },
      ]
    : [];

  const handleLanguageChange = () => {
    const changeAction = () => {
      const newLocale = locale === 'he' ? 'en' : 'he';
      const newPathname = pathname.replace(`/${locale}`, `/${newLocale}`);

      if (mobileMenuOpen) {
        setMobileMenuOpen(false);
      }
      router.push(newPathname);
    };

    if (isDirty) {
      promptNavigation(changeAction);
    } else {
      changeAction();
    }
  };

  useEffect(() => {
    const handleScroll = () => setScrolled(window.scrollY > 10);
    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  useEffect(() => {
    return () => {
      if (mobileMenuOpen) {
        document.body.style.overflow = '';
      }
    };
  }, [mobileMenuOpen]);

  const toggleMobileMenu = () => {
    setMobileMenuOpen((prev) => {
      const newState = !prev;
      if (newState) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
      return newState;
    });
  };
  const handleSignOut = () => {
    setMobileMenuOpen(false);
    signOut({ callbackUrl: `/${locale}` });
  };
  const getInitials = () => {
    const fullName = session?.user?.name;
    if (!fullName) return 'P';
    const names = fullName.split(' ');
    return (
      (names[0]?.[0] || '') +
      (names.length > 1 ? names[names.length - 1]?.[0] || '' : '')
    ).toUpperCase();
  };

  const mainProfileImage = session?.user?.image
    ? {
        id: 'session-image',
        url: session.user.image,
        isMain: true,
        userId: session.user.id || '', // הוספתי הגנה למקרה של undefined
        createdAt: new Date(),
        updatedAt: new Date(),
        cloudinaryPublicId: null,
      }
    : null;

  const navbarClasses = scrolled
    ? 'bg-white/90 backdrop-blur-xl shadow-sm border-b border-gray-100'
    : 'bg-transparent border-b border-transparent';
  const profileIconSize = 'w-10 h-10';

  return (
    <>
      <nav
        className={`sticky top-0 z-50 w-full transition-all duration-300 ${navbarClasses}`}
      >
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-20">
            <div className="flex items-center gap-4 md:gap-8">
              <Logo locale={locale} />
              <div
                aria-label="ניווט ראשי"
                className="hidden md:flex items-center gap-1 md:gap-2"
              >
                {session ? (
                  <>
                    {isMatchmaker ? (
                      <>
                        <NavItem
                          href="/matchmaker/suggestions"
                          text={dict.navbar.matchmakerSuggestions}
                        />
                        <NavItem
                          href="/matchmaker/clients"
                          text={dict.navbar.matchmakerClients}
                        />
                        <NavItem
                          href="/admin/engagement"
                          text={
                            dict.navbar.engagementDashboard ||
                            'ניהול Engagement'
                          }
                        />
                      </>
                    ) : (
                      <NavItem
                        id="onboarding-target-matches-link"
                        href="/matches"
                        text={dict.navbar.myMatches}
                      />
                    )}

                    <NavItem
                      href="/profile"
                      text={dict.userDropdown.myProfile}
                    />

                    <NavItem
                      href="/questionnaire"
                      text={dict.navbar.matchmakingQuestionnaire}
                    />
                    <NavItem
                      href="/messages"
                      id="onboarding-target-messages-link"
                      text={dict.navbar.messages}
                      badge={
                        notifications.total > 0
                          ? notifications.total
                          : undefined
                      }
                    />
                  </>
                ) : null}
              </div>
            </div>
            <div className="flex items-center gap-2 md:gap-4">
              <Button
                variant="ghost"
                onClick={handleLanguageChange}
                className="group flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-teal-700 hover:bg-teal-50 rounded-full transition-all duration-300 border border-transparent hover:border-teal-100"
                aria-label={`Switch to ${locale === 'he' ? 'English' : 'Hebrew'}`}
                title={`Switch to ${locale === 'he' ? 'English' : 'Hebrew'}`}
              >
                <div className="relative">
                  <Globe className="h-4 w-4 transition-all duration-300 group-hover:scale-110 group-hover:text-teal-600" />
                  <div className="absolute -top-1.5 -right-1.5 w-3.5 h-3.5 bg-gradient-to-r from-teal-500 to-orange-500 rounded-full flex items-center justify-center shadow-sm border border-white">
                    <span className="text-[8px] font-bold text-white leading-none">
                      {locale === 'he' ? 'ע' : 'E'}
                    </span>
                  </div>
                </div>
                <span className="text-sm font-semibold transition-all duration-300 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-teal-600 group-hover:to-orange-600">
                  {locale === 'he' ? 'EN' : 'HE'}
                </span>
              </Button>

              {session && (
                <div
                  id="onboarding-target-availability-status"
                  className="hidden md:block"
                >
                  <AvailabilityStatus
                    dict={dict.profilePage.availabilityStatus}
                  />
                </div>
              )}
              {session ? (
                <UserDropdown
                  session={session}
                  mainProfileImage={mainProfileImage}
                  getInitials={getInitials}
                  handleSignOut={handleSignOut}
                  profileIconSize={profileIconSize}
                  dict={dict.userDropdown}
                  locale={locale}
                />
              ) : (
                <div className="hidden md:flex items-center gap-2">
                  <NavItem
                    href="/questionnaire"
                    text={dict.navbar.toQuestionnaire}
                  />
                  <NavItem href="/auth/signin" text={dict.navbar.login} />
                  <Link href={`/${locale}/auth/register`}>
                    <Button className="group relative overflow-hidden bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-md hover:shadow-lg transition-all duration-300 px-6 py-2.5">
                      <span className="relative z-10 flex items-center font-bold">
                        <UserPlus
                          className={cn('h-4 w-4', isRtl ? 'ml-2' : 'mr-2')}
                        />
                        {dict.navbar.register}
                      </span>
                    </Button>
                  </Link>
                </div>
              )}
              <Button
                variant="ghost"
                size="icon"
                className="md:hidden text-gray-600 hover:text-teal-600 hover:bg-teal-50 rounded-full touch-manipulation"
                onClick={toggleMobileMenu}
                aria-label="פתח תפריט"
                aria-expanded={mobileMenuOpen}
                aria-controls="mobile-menu-panel"
              >
                <Menu className="h-6 w-6" />
              </Button>
            </div>
          </div>
        </div>
      </nav>
      {mobileMenuOpen && (
        <div
          className="fixed inset-0 bg-black/40 z-40 backdrop-blur-sm md:hidden"
          onClick={toggleMobileMenu}
          style={{ touchAction: 'none' }}
          aria-hidden="true"
        />
      )}
      <div
        className={cn(
          'fixed top-0 z-50 h-full w-4/5 max-w-sm bg-white shadow-2xl transform transition-transform duration-300 ease-in-out md:hidden',
          isRtl ? 'right-0' : 'left-0',
          mobileMenuOpen
            ? 'translate-x-0'
            : isRtl
              ? 'translate-x-full'
              : '-translate-x-full'
        )}
        id="mobile-menu-panel"
        role="dialog"
        aria-modal="true"
        aria-label="תפריט ניווט"
        style={{ touchAction: 'pan-y' }}
      >
        <div className="flex flex-col h-full overflow-hidden">
          <div className="flex justify-between items-center p-5 border-b border-gray-100 shrink-0 bg-gray-50/30">
            <Logo locale={locale} />
            <Button
              variant="ghost"
              size="icon"
              onClick={toggleMobileMenu}
              className="text-gray-400 hover:text-gray-800 rounded-full hover:bg-gray-100 touch-manipulation"
              aria-label="סגור תפריט"
            >
              <X className="h-5 w-5" />
            </Button>
          </div>

          <div
            className="overflow-y-auto flex-grow pb-8 scrollbar-hide min-h-0"
            style={{
              WebkitOverflowScrolling: 'touch',
              touchAction: 'pan-y',
              overscrollBehavior: 'contain',
            }}
          >
            {session?.user && (
              <div className="p-4 space-y-4">
                <Link
                  href={`/${locale}/profile`}
                  onClick={toggleMobileMenu}
                  className="block"
                >
                  <div className="p-4 border border-teal-100/50 rounded-2xl bg-gradient-to-br from-teal-50/50 via-white to-orange-50/50 hover:from-teal-100/50 hover:to-orange-100/50 transition-all duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div className="flex items-center gap-4">
                      <div
                        className={`relative ${profileIconSize} rounded-full flex-shrink-0 flex items-center justify-center shadow-sm overflow-hidden ring-2 ring-white group-hover:ring-teal-200 transition-all`}
                      >
                        {mainProfileImage?.url ? (
                          <Image
                            src={getRelativeCloudinaryPath(
                              mainProfileImage.url
                            )}
                            alt={session.user.name || 'תמונת פרופיל'}
                            fill
                            className="object-cover rounded-full"
                            sizes="40px"
                          />
                        ) : (
                          <span className="font-semibold text-xl text-teal-800 bg-teal-100 w-full h-full flex items-center justify-center rounded-full">
                            {getInitials()}
                          </span>
                        )}
                      </div>
                      <div className="flex-grow min-w-0">
                        <div className="font-bold text-gray-800 truncate group-hover:text-teal-800 transition-colors">
                          {session.user.name}
                        </div>
                        <div className="text-sm text-gray-500 truncate">
                          {session.user.email}
                        </div>
                        <div className="text-xs text-teal-600 font-bold mt-1 group-hover:text-teal-700 flex items-center gap-1">
                          {dict.userDropdown.myProfile}
                          <span className="text-[10px]">
                            {isRtl ? '←' : '→'}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </Link>

                <div id="onboarding-target-availability-status" className="p-1">
                  <AvailabilityStatus
                    dict={dict.profilePage.availabilityStatus}
                  />
                </div>

                <Button
                  variant="outline"
                  onClick={handleLanguageChange}
                  className="w-full border border-gray-200 text-gray-700 hover:bg-teal-50 hover:border-teal-200 flex items-center justify-between py-6 h-auto text-base transition-all duration-300 rounded-xl"
                >
                  <div className="flex items-center gap-3">
                    <div className="relative flex-shrink-0">
                      <Globe className="h-5 w-5 text-teal-600" />
                      <div className="absolute -top-1 -right-1 w-3.5 h-3.5 bg-gradient-to-r from-teal-500 to-orange-500 rounded-full flex items-center justify-center border border-white">
                        <span className="text-[8px] font-bold text-white leading-none">
                          {locale === 'he' ? 'ע' : 'E'}
                        </span>
                      </div>
                    </div>
                    <span className="font-semibold text-gray-700">
                      {locale === 'he' ? 'English' : 'עברית'}
                    </span>
                  </div>
                  <span className="font-bold text-sm bg-gradient-to-r from-teal-600 to-orange-600 bg-clip-text text-transparent">
                    {locale === 'he' ? 'EN' : 'HE'}
                  </span>
                </Button>
              </div>
            )}

            <nav className="space-y-1 p-2 pb-6">
              {session ? (
                <>
                  <div className="px-4 pt-2 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {/* תיקון: טקסט קבוע במקום קריאה למפתח לא קיים */}
                    {isRtl ? 'תפריט ראשי' : 'Main Menu'}
                  </div>
                  {isMatchmaker ? (
                    <>
                      <MobileNavItem
                        href="/matchmaker/suggestions"
                        text={dict.navbar.matchmakerSuggestions}
                        icon={<Heart className="h-5 w-5" />}
                        onClick={toggleMobileMenu}
                        isRtl={isRtl}
                      />
                      <MobileNavItem
                        href="/matchmaker/clients"
                        text={dict.navbar.matchmakerClients}
                        icon={<Users className="h-5 w-5" />}
                        onClick={toggleMobileMenu}
                        isRtl={isRtl}
                      />
                      <MobileNavItem
                        href="/admin/engagement"
                        text={
                          dict.navbar.engagementDashboard || 'ניהול Engagement'
                        }
                        icon={<Mail className="h-5 w-5" />}
                        onClick={toggleMobileMenu}
                        isRtl={isRtl}
                      />
                    </>
                  ) : (
                    <MobileNavItem
                      id="onboarding-target-matches-link"
                      href="/matches"
                      text={dict.navbar.myMatches}
                      icon={<Users className="h-5 w-5" />}
                      onClick={toggleMobileMenu}
                      isRtl={isRtl}
                    />
                  )}
                  <MobileNavItem
                    href="/questionnaire"
                    text={dict.navbar.matchmakingQuestionnaire}
                    icon={<Lightbulb className="h-5 w-5" />}
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />
                  <MobileNavItem
                    id="onboarding-target-messages-link"
                    href="/messages"
                    text={dict.navbar.messages}
                    icon={<MessageCircle className="h-5 w-5" />}
                    badge={
                      notifications.total > 0 ? notifications.total : undefined
                    }
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />

                  {isHomePage && homePageLinks.length > 0 && (
                    <>
                      <div className="my-4 border-t border-gray-100 mx-4" />
                      <div className="px-4 pt-2 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                        {dict.stickyNav.mobileTitle || 'ניווט בדף'}
                      </div>
                      {homePageLinks.map((link) => (
                        <MobileHomePageLink
                          key={link.id}
                          href={`#${link.id}`}
                          text={link.text}
                          icon={link.icon}
                          onClick={toggleMobileMenu}
                        />
                      ))}
                    </>
                  )}

                  <div className="my-4 border-t border-gray-100 mx-4" />

                  <MobileNavItem
                    href="/settings"
                    text={dict.userDropdown.accountSettings}
                    icon={<Settings className="h-5 w-5" />}
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />
                  <button
                    onClick={handleSignOut}
                    className="w-full flex items-center px-4 py-3 rounded-xl text-base font-medium text-gray-600 hover:bg-rose-50 hover:text-rose-600 transition-colors duration-150 gap-4 touch-manipulation active:bg-rose-100"
                  >
                    <LogOut className="h-5 w-5" />
                    <span className="flex-grow text-start">
                      {dict.userDropdown.signOut}
                    </span>
                  </button>
                </>
              ) : (
                <>
                  <div className="p-4">
                    <Button
                      variant="outline"
                      onClick={handleLanguageChange}
                      className="w-full border border-gray-200 text-gray-700 hover:bg-teal-50 hover:border-teal-200 flex items-center justify-between py-6 h-auto text-base transition-all duration-300 rounded-xl"
                    >
                      <div className="flex items-center gap-3">
                        <div className="relative flex-shrink-0">
                          <Globe className="h-5 w-5 text-teal-600" />
                          <div className="absolute -top-1 -right-1 w-3.5 h-3.5 bg-gradient-to-r from-teal-500 to-orange-500 rounded-full flex items-center justify-center border border-white">
                            <span className="text-[8px] font-bold text-white leading-none">
                              {locale === 'he' ? 'ע' : 'E'}
                            </span>
                          </div>
                        </div>
                        <span className="font-semibold text-gray-700">
                          {locale === 'he' ? 'English' : 'עברית'}
                        </span>
                      </div>
                      <span className="font-bold text-sm bg-gradient-to-r from-teal-600 to-orange-600 bg-clip-text text-transparent">
                        {locale === 'he' ? 'EN' : 'HE'}
                      </span>
                    </Button>
                  </div>

                  {isHomePage && homePageLinks.length > 0 && (
                    <>
                      <div className="px-4 pt-2 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                        {dict.stickyNav.mobileTitle || 'ניווט בדף'}
                      </div>
                      {homePageLinks.map((link) => (
                        <MobileHomePageLink
                          key={link.id}
                          href={`#${link.id}`}
                          text={link.text}
                          icon={link.icon}
                          onClick={toggleMobileMenu}
                        />
                      ))}
                      <div className="my-4 border-t border-gray-100 mx-4" />
                    </>
                  )}

                  <MobileNavItem
                    href="/questionnaire"
                    text={dict.navbar.matchmakingQuestionnaire}
                    icon={<Lightbulb className="h-5 w-5" />}
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />
                  <MobileNavItem
                    href="/auth/signin"
                    text={dict.navbar.login}
                    icon={<LogIn className="h-5 w-5" />}
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />
                  <MobileNavItem
                    href="/auth/register"
                    text={dict.navbar.register}
                    icon={<UserPlus className="h-5 w-5" />}
                    onClick={toggleMobileMenu}
                    isRtl={isRtl}
                  />
                </>
              )}
            </nav>
          </div>
        </div>
      </div>
    </>
  );
};

export default Navbar;
--- End of Content for Navbar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\layout\UserDropdown.tsx
--------------------------------------------------------------------------------
Content:
// src/components/layout/UserDropdown.tsx

'use client';

import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { User, LogOut, Settings, Lightbulb } from 'lucide-react';
import type { Session as NextAuthSession } from 'next-auth';
import type { UserImage } from '@/types/next-auth';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import type { UserDropdownDict } from '@/types/dictionary';

interface UserDropdownProps {
  session: NextAuthSession | null;
  mainProfileImage: UserImage | null;
  getInitials: () => string;
  handleSignOut: () => void;
  profileIconSize: string;
  dict?: UserDropdownDict;
  locale: 'he' | 'en';
}

const UserDropdown = ({
  session,
  mainProfileImage,
  getInitials,
  handleSignOut,
  profileIconSize,
  dict,
  locale,
}: UserDropdownProps) => {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const isRtl = locale === 'he';

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const safeDict = dict || {
    openMenuAriaLabel: 'Open user menu',
    profileImageAlt: 'Profile picture',
    myProfile: 'My Profile',
    questionnaire: 'Matching Questionnaire',
    accountSettings: 'Account Settings',
    signOut: 'Sign Out',
  };

  if (!session?.user) {
    return null;
  }

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        id="onboarding-target-profile-dropdown"
        onClick={() => setIsOpen(!isOpen)}
        aria-expanded={isOpen}
        aria-haspopup="menu"
        aria-controls="user-menu"
        aria-label={safeDict.openMenuAriaLabel}
        // שינוי: Cyan -> Teal, הוספת Focus ring בצבע Teal
        className={`relative ${profileIconSize} rounded-full flex items-center justify-center text-sm shadow-md transition-all duration-300 cursor-pointer group overflow-hidden focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400 focus:ring-offset-white`}
      >
        {/* שינוי: Hover Ring בצבע Teal */}
        <div className="absolute inset-0 rounded-full transition-all duration-300 group-hover:ring-2 group-hover:ring-teal-400"></div>
        {mainProfileImage && mainProfileImage.url ? (
          <Image
            src={getRelativeCloudinaryPath(mainProfileImage.url)}
            alt={session.user.name || safeDict.profileImageAlt}
            fill
            className="object-cover rounded-full"
            sizes="(max-width: 768px) 40px, 40px"
          />
        ) : (
          // שינוי: Placeholder עם גרדיאנט עדין (Teal -> Orange) במקום Cyan שטוח
          <span className="font-semibold text-lg text-teal-800 bg-gradient-to-br from-teal-100 to-orange-100 w-full h-full flex items-center justify-center rounded-full">
            {getInitials()}
          </span>
        )}
      </button>

      {isOpen && (
        <div
          id="user-menu"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="onboarding-target-profile-dropdown"
          className={`absolute mt-3 w-56 bg-white rounded-xl shadow-2xl z-20 border border-gray-100 ${
            isRtl ? 'origin-top-left left-0' : 'origin-top-right right-0'
          }`}
        >
          <div className="p-1" role="none">
            {/* Header של התפריט - רקע עדין מאוד */}
            <div className="px-4 py-3 border-b border-gray-100 bg-gray-50/50 rounded-t-lg">
              <p
                className="text-sm font-semibold text-gray-800 truncate"
                role="none"
              >
                {session.user.name}
              </p>
              <p className="text-xs text-gray-500 truncate" role="none">
                {session.user.email}
              </p>
            </div>
            <div className="py-1" role="none">
              {/* שינוי: Hover Links ל-Teal */}
              <Link
                href={`/${locale}/profile`}
                role="menuitem"
                className="flex items-center w-full px-3 py-2 text-sm text-gray-700 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition-colors"
                onClick={() => setIsOpen(false)}
              >
                <User className={`h-4 w-4 ${isRtl ? 'ml-2' : 'mr-2'}`} />
                {safeDict.myProfile}
              </Link>
              <Link
                href={`/${locale}/questionnaire`}
                role="menuitem"
                className="flex items-center w-full px-3 py-2 text-sm text-gray-700 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition-colors"
                onClick={() => setIsOpen(false)}
              >
                <Lightbulb className={`h-4 w-4 ${isRtl ? 'ml-2' : 'mr-2'}`} />
                {safeDict.questionnaire}
              </Link>
              <Link
                href={`/${locale}/settings`}
                role="menuitem"
                className="flex items-center w-full px-3 py-2 text-sm text-gray-700 rounded-lg hover:bg-teal-50 hover:text-teal-700 transition-colors"
                onClick={() => setIsOpen(false)}
              >
                <Settings className={`h-4 w-4 ${isRtl ? 'ml-2' : 'mr-2'}`} />
                {safeDict.accountSettings}
              </Link>
            </div>
            <div className="py-1 border-t border-gray-100" role="none">
              {/* שינוי: יציאה באדום/Rose עדין כדי להתאים ל-Rose ב-Hero */}
              <button
                onClick={() => {
                  setIsOpen(false);
                  handleSignOut();
                }}
                role="menuitem"
                className="w-full flex items-center px-3 py-2 text-sm text-gray-700 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors"
              >
                <LogOut className={`h-4 w-4 ${isRtl ? 'ml-2' : 'mr-2'}`} />
                {safeDict.signOut}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default UserDropdown;
--- End of Content for UserDropdown.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker
================================================================================

(This directory contains subdirectories but no files directly. See subdirectories below.)

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\MatchmakerEditProfile.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/MatchmakerEditProfile.tsx

import React, { useState, useEffect, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { toast } from 'sonner';
import { ProfileSection } from '@/components/profile';
import { PhotosSection } from '@/components/profile';
import { PreferencesSection } from '@/components/profile';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Loader2,
  X,
  UserCog,
  Sparkles,
  Award,
  Image as ImageIcon,
  Sliders,
  Trash2,
  AlertCircle,
  Send,
  Save, // --- הוספה חדשה ---
} from 'lucide-react';
import type { UserProfile, UserImage } from '@/types/next-auth';
import type { Candidate } from './types/candidates';
import { motion } from 'framer-motion';
import { useSession } from 'next-auth/react';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { cn } from '@/lib/utils';
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  CardDescription,
  CardFooter, // --- הוספה חדשה ---
} from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';

interface MatchmakerEditProfileProps {
  isOpen: boolean;
  onClose: () => void;
  candidate: Candidate | null;
  onCandidateDeleted?: (candidateId: string) => void;
  dict: MatchmakerPageDictionary['candidatesManager']['editProfile'];
  profileDict: ProfilePageDictionary;
  locale: string;
}

const MatchmakerEditProfile: React.FC<MatchmakerEditProfileProps> = ({
  isOpen,
  onClose,
  candidate,
  onCandidateDeleted,
  dict,
  profileDict,
  locale,
}) => {
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === 'ADMIN';
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const [activeTab, setActiveTab] = useState('profile');
  const [isEditing, setIsEditing] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [images, setImages] = useState<UserImage[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  const [isDeleteCandidateDialogOpen, setIsDeleteCandidateDialogOpen] =
    useState(false);
  const [deleteCandidateConfirmText, setDeleteCandidateConfirmText] =
    useState('');
  const [isDeletingCandidate, setIsDeletingCandidate] = useState(false);

  const [isSetupInviteOpen, setIsSetupInviteOpen] = useState(false);
  const [inviteEmail, setInviteEmail] = useState('');
  const [isSendingInvite, setIsSendingInvite] = useState(false);
  const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);
  const DELETE_CANDIDATE_CONFIRMATION_PHRASE = dict.deleteConfirmationPhrase;
  const handleGenerateSummary = async () => {
    if (!candidate) return;
    setIsGeneratingSummary(true);
    try {
      const response = await fetch('/api/ai/matchmaker/generate-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ userId: candidate.id, locale: locale }),
      });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Failed to generate summary');
      }

      setProfile((prevProfile) => {
        if (!prevProfile) return null;
        return { ...prevProfile, manualEntryText: result.summary };
      });

      toast.success(dict.toasts.aiSummarySuccess);
    } catch (error) {
      toast.error(
        `${dict.toasts.aiSummaryError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsGeneratingSummary(false);
    }
  };

  const fetchProfileData = useCallback(async () => {
    if (!candidate) return;
    setIsLoading(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}?locale=${locale}`,
      );
      if (!response.ok) throw new Error('Failed to fetch candidate profile');
      const data = await response.json();
      if (data.success) {
        setProfile(data.profile);
        setImages(data.images || []);
        if (
          candidate.email &&
          !candidate.email.endsWith('@shidduch.placeholder.com')
        ) {
          setInviteEmail(candidate.email);
        } else {
          setInviteEmail('');
        }
      } else {
        throw new Error(data.error || 'Failed to load profile data');
      }
    } catch (error) {
      console.error('Error fetching profile:', error);
      toast.error(dict.toasts.loadError);
    } finally {
      setIsLoading(false);
    }
  }, [candidate, dict.toasts.loadError]);

  useEffect(() => {
    if (isOpen && candidate) {
      fetchProfileData();
    } else if (!isOpen) {
      setProfile(null);
      setImages([]);
      setActiveTab('profile');
      setIsLoading(true);
      setDeleteCandidateConfirmText('');
      setIsDeleteCandidateDialogOpen(false);
      setIsSetupInviteOpen(false);
      setInviteEmail('');
      setIsSendingInvite(false);
    }
  }, [isOpen, candidate, fetchProfileData]);

  const handleProfileUpdate = async (updatedProfile: Partial<UserProfile>) => {
    if (!candidate || !profile) return;
    setIsSaving(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedProfile),
        }
      );
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to update profile');
      }
      setProfile(
        (prevProfile) => ({ ...prevProfile, ...updatedProfile }) as UserProfile
      );
      toast.success(dict.toasts.updateSuccess, {
        position: 'top-center',
        duration: 3000,
      });
    } catch (error) {
      console.error('Error updating profile:', error);
      toast.error(
        `${dict.toasts.updateError}: ${error instanceof Error ? error.message : 'Unknown error'}`,
        { duration: 5000 }
      );
    } finally {
      setIsSaving(false);
    }
  };

  const handleImageUpload = async (files: File[]) => {
    if (!candidate) return;
    setIsUploading(true);
    const uploadPromises = files.map(async (file) => {
      const formData = new FormData();
      formData.append('image', file);
      formData.append('userId', candidate.id);
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/images`,
        { method: 'POST', body: formData }
      );
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(
          `שגיאה בהעלאת הקובץ ${file.name}: ${data.error || 'שגיאת שרת'}`
        );
      }
      return data.image;
    });
    try {
      const newImages = await Promise.all(uploadPromises);
      setImages((prev) => [...prev, ...newImages]);
      toast.success(
        newImages.length > 1
          ? dict.toasts.uploadSuccessMultiple.replace(
              '{{count}}',
              String(newImages.length)
            )
          : dict.toasts.uploadSuccessSingle
      );
    } catch (error) {
      console.error('Error uploading images:', error);
      toast.error(
        `${dict.toasts.uploadError}: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    } finally {
      setIsUploading(false);
    }
  };

  const handleSetMainImage = async (imageId: string) => {
    if (!candidate) return;
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/images/${imageId}/main`,
        { method: 'PATCH' }
      );
      const data = await response.json();
      if (!response.ok || !data.success)
        throw new Error(data.error || 'Failed to set main image');
      setImages((prev) =>
        prev.map((img) => ({ ...img, isMain: img.id === imageId }))
      );
      toast.success(dict.toasts.setMainSuccess);
    } catch (error) {
      console.error('Error setting main image:', error);
      toast.error(dict.toasts.setMainError);
    }
  };

  const handleDeleteImage = async (imageIds: string[]) => {
    if (!candidate || imageIds.length === 0) return;
    setIsUploading(true);
    try {
      const currentMainImage = images.find((img) => img.isMain);
      const isMainImageBeingDeleted = currentMainImage
        ? imageIds.includes(currentMainImage.id)
        : false;
      const deletePromises = imageIds.map((id) =>
        fetch(`/api/matchmaker/candidates/${candidate.id}/images/${id}`, {
          method: 'DELETE',
        })
      );
      const responses = await Promise.all(deletePromises);
      for (const response of responses) {
        if (!response.ok && response.status !== 204) {
          const errorData = await response.json().catch(() => null);
          throw new Error(
            errorData?.error ||
              `Error deleting one of the images (status: ${response.status})`
          );
        }
      }
      const remainingImages = images.filter(
        (img) => !imageIds.includes(img.id)
      );
      if (isMainImageBeingDeleted && remainingImages.length > 0) {
        setImages(remainingImages);
        await handleSetMainImage(remainingImages[0].id);
      } else {
        setImages(remainingImages);
      }
      toast.success(
        imageIds.length > 1
          ? dict.toasts.deleteImageSuccessMultiple.replace(
              '{{count}}',
              String(imageIds.length)
            )
          : dict.toasts.deleteImageSuccessSingle,
        { position: 'top-center' }
      );
    } catch (error) {
      console.error('Error deleting image(s):', error);
      toast.error(
        error instanceof Error ? error.message : dict.toasts.deleteImageError
      );
    } finally {
      setIsUploading(false);
    }
  };

  const handleDeleteCandidateRequest = async () => {
    if (!candidate) return;
    if (deleteCandidateConfirmText !== DELETE_CANDIDATE_CONFIRMATION_PHRASE) {
      toast.error(dict.toasts.deleteCandidateErrorConfirmation, {
        description: dict.toasts.deleteCandidateErrorDescription.replace(
          '{{phrase}}',
          DELETE_CANDIDATE_CONFIRMATION_PHRASE
        ),
      });
      return;
    }
    setIsDeletingCandidate(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}`,
        { method: 'DELETE' }
      );
      const data = await response.json();
      if (!response.ok || !data.success)
        throw new Error(data.error || 'Failed to delete candidate profile');
      toast.success(dict.toasts.deleteCandidateSuccess, {
        position: 'top-center',
        duration: 3000,
      });
      if (onCandidateDeleted) onCandidateDeleted(candidate.id);
      setIsDeleteCandidateDialogOpen(false);
      onClose();
    } catch (error) {
      console.error('Error deleting candidate:', error);
      toast.error(
        `${dict.toasts.deleteCandidateError}: ${error instanceof Error ? error.message : 'Unknown error'}`,
        { duration: 5000 }
      );
    } finally {
      setIsDeletingCandidate(false);
    }
  };

  const handleSendSetupInvite = async () => {
    if (!candidate || !inviteEmail) {
      toast.error(dict.toasts.sendInviteErrorEmail);
      return;
    }
    setIsSendingInvite(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/invite-setup`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: inviteEmail }),
        }
      );
      const result = await response.json();
      if (!response.ok || !result.success)
        throw new Error(result.error || dict.toasts.sendInviteErrorGeneral);
      toast.success(dict.toasts.sendInviteSuccess);
      setIsSetupInviteOpen(false);
    } catch (error) {
      console.error('Error sending setup invite:', error);
      toast.error(
        error instanceof Error
          ? error.message
          : dict.toasts.sendInviteErrorGeneral
      );
    } finally {
      setIsSendingInvite(false);
    }
  };

  if (!candidate && isOpen) return null;
  if (!candidate) return null;

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent
          className="max-w-5xl max-h-[90vh] p-0 overflow-hidden"
          dir={direction}
        >
          {isLoading && !profile ? (
            <div className="flex items-center justify-center h-64">
              <Loader2 className="w-10 h-10 animate-spin text-primary" />
            </div>
          ) : (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.3 }}
              className="flex flex-col h-full max-h-[90vh]"
            >
              <DialogHeader className="p-6 border-b">
                <div className="flex items-center justify-between">
                  <div>
                    <DialogTitle
                      className={cn(
                        'text-2xl font-bold text-primary/90',
                        locale === 'he' ? 'text-right' : 'text-left'
                      )}
                    >
                      {dict.header.title
                        .replace('{{firstName}}', candidate.firstName)
                        .replace('{{lastName}}', candidate.lastName)}
                    </DialogTitle>
                    <DialogDescription
                      className={cn(
                        'text-gray-500 mt-1',
                        locale === 'he' ? 'text-right' : 'text-left'
                      )}
                    >
                      {dict.header.description}
                    </DialogDescription>
                  </div>
                  {isSaving && (
                    <div className="flex items-center bg-blue-50 text-blue-700 py-1 px-2 rounded-full text-sm">
                      <Loader2 className="w-3 h-3 animate-spin mr-1" />
                      {dict.header.saving}
                    </div>
                  )}
                </div>
              </DialogHeader>
              <Tabs
                value={activeTab}
                onValueChange={setActiveTab}
                className="flex-1 flex flex-col min-h-0"
              >
                <div className="px-6 pt-4">
                  <TabsList className="w-full bg-muted/30 p-1 rounded-xl shadow-sm">
                    <TabsTrigger
                      value="profile"
                      className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                    >
                      <UserCog className="w-4 h-4" />
                      {dict.tabs.profile}
                    </TabsTrigger>
                    <TabsTrigger
                      value="photos"
                      className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                    >
                      <ImageIcon className="w-4 h-4" />
                      {dict.tabs.photos}
                    </TabsTrigger>
                    <TabsTrigger
                      value="preferences"
                      className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                    >
                      <Sliders className="w-4 h-4" />
                      {dict.tabs.preferences}
                    </TabsTrigger>
                  </TabsList>
                </div>
                <div className="flex-1 overflow-hidden flex flex-col min-h-0">
                  <TabsContent
                    value="profile"
                    className="flex-1 overflow-auto p-4 m-0 pb-16"
                  >
                    {profile ? (
                      <div className="space-y-4">
                        <Card className="bg-white rounded-xl shadow-sm border">
                          <CardHeader>
                            <div className="flex justify-between items-start">
                              <div>
                                <CardTitle className="flex items-center gap-2">
                                  <Award className="w-5 h-5 text-indigo-600" />
                                  {dict.neshamaTechSummary.title}
                                </CardTitle>
                                <CardDescription className="mt-1">
                                  {dict.neshamaTechSummary.description}
                                </CardDescription>
                              </div>
                              <Button
                                size="sm"
                                onClick={handleGenerateSummary}
                                disabled={isGeneratingSummary || isSaving}
                                className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-md hover:scale-105 transition-transform"
                              >
                                {isGeneratingSummary ? (
                                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                ) : (
                                  <Sparkles className="w-4 h-4 mr-2" />
                                )}
                                {isGeneratingSummary
                                  ? dict.neshamaTechSummary.aiButtonLoading
                                  : dict.neshamaTechSummary.aiButton}
                              </Button>
                            </div>
                          </CardHeader>
                          <CardContent>
                            <Textarea
                              value={profile.manualEntryText || ''}
                              onChange={(e) =>
                                setProfile((p) =>
                                  p
                                    ? { ...p, manualEntryText: e.target.value }
                                    : null
                                )
                              }
                              placeholder={dict.neshamaTechSummary.placeholder}
                              rows={8}
                              className="min-h-[150px]"
                            />
                          </CardContent>
                          {/* --- START: כפתור שמירה חדש --- */}
                          <CardFooter className="flex justify-end pt-4">
                            <Button
                              size="sm"
                              onClick={() =>
                                handleProfileUpdate({
                                  manualEntryText:
                                    profile.manualEntryText || null,
                                })
                              }
                              disabled={isSaving || isGeneratingSummary}
                              className="bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-md hover:scale-105 transition-transform"
                            >
                              {isSaving ? (
                                <Loader2 className="w-4 h-4 ml-2 animate-spin" />
                              ) : (
                                <Save className="w-4 h-4 ml-2" />
                              )}
                              {isSaving
                                ? dict.neshamaTechSummary.saveButtonLoading ||
                                  'שומר...'
                                : dict.neshamaTechSummary.saveButton ||
                                  'שמור תקציר'}
                            </Button>
                          </CardFooter>
                          {/* --- END: כפתור שמירה חדש --- */}
                        </Card>
                        <div className="bg-white rounded-xl shadow-sm border">
                          <ProfileSection
                            profile={profile}
                            isEditing={isEditing}
                            setIsEditing={setIsEditing}
                            onSave={handleProfileUpdate}
                            dict={profileDict.profileSection}
                            locale={locale}
                          />
                        </div>
                      </div>
                    ) : (
                      <div className="flex items-center justify-center h-full">
                        <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
                      </div>
                    )}
                  </TabsContent>
                  <TabsContent
                    value="photos"
                    className="flex-1 overflow-auto p-4 m-0 pb-16"
                  >
                    <div className="bg-white rounded-xl shadow-sm border">
                      <PhotosSection
                        images={images}
                        isUploading={isUploading}
                        disabled={isSaving || isDeletingCandidate}
                        onUpload={handleImageUpload}
                        onSetMain={handleSetMainImage}
                        onDelete={handleDeleteImage}
                        maxImages={10}
                        dict={profileDict.photosSection}
                        locale={locale}
                      />
                    </div>
                  </TabsContent>
                  <TabsContent
                    value="preferences"
                    className="flex-1 overflow-auto p-4 m-0 pb-16"
                  >
                    {profile ? (
                      <div className="bg-white rounded-xl shadow-sm border">
                        <PreferencesSection
                          profile={profile}
                          isEditing={isEditing}
                          setIsEditing={setIsEditing}
                          onChange={handleProfileUpdate}
                          dictionary={profileDict.preferencesSection}
                          locale={locale}
                        />
                      </div>
                    ) : (
                      <div className="flex items-center justify-center h-full">
                        <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
                      </div>
                    )}
                  </TabsContent>
                </div>
              </Tabs>
              <div className="p-4 border-t flex justify-between items-center mt-auto bg-white/80 backdrop-blur-sm sticky bottom-0">
                <div>
                  <span className="text-sm text-muted-foreground">
                    {activeTab === 'profile'
                      ? dict.footer.tabInfo.profile
                      : activeTab === 'photos'
                        ? dict.footer.tabInfo.photos
                        : dict.footer.tabInfo.preferences}
                  </span>
                </div>
                <div className="flex items-center gap-3">
                  <Button
                    variant="outline"
                    onClick={() => setIsSetupInviteOpen(true)}
                    disabled={
                      isSaving || isDeletingCandidate || isSendingInvite
                    }
                  >
                    <Send
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-2' : 'mr-2'
                      )}
                    />
                    {dict.footer.buttons.sendInvite}
                  </Button>
                  {isAdmin && (
                    <Button
                      variant="destructive"
                      onClick={() => setIsDeleteCandidateDialogOpen(true)}
                      disabled={isSaving || isUploading || isDeletingCandidate}
                      size="sm"
                    >
                      <Trash2
                        className={cn(
                          'w-4 h-4',
                          locale === 'he' ? 'ml-2' : 'mr-2'
                        )}
                      />
                      {dict.footer.buttons.deleteCandidate}
                    </Button>
                  )}
                  <Button
                    variant="outline"
                    onClick={onClose}
                    disabled={isSaving || isDeletingCandidate}
                    className="bg-white hover:bg-gray-100 transition-colors shadow-sm"
                    size="sm"
                  >
                    <X className="w-4 h-4 mr-2" />
                    {dict.footer.buttons.close}
                  </Button>
                </div>
              </div>
            </motion.div>
          )}
        </DialogContent>
      </Dialog>

      {candidate && (
        <Dialog open={isSetupInviteOpen} onOpenChange={setIsSetupInviteOpen}>
          <DialogContent className="sm:max-w-md" dir={direction}>
            <DialogHeader>
              <DialogTitle>{dict.inviteDialog.title}</DialogTitle>
              <DialogDescription>
                {dict.inviteDialog.description.replace(
                  '{{fullName}}',
                  `${candidate.firstName} ${candidate.lastName}`
                )}
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <Label
                htmlFor="inviteEmail"
                className={cn(locale === 'he' ? 'text-right' : 'text-left')}
              >
                {dict.inviteDialog.emailLabel}
              </Label>
              <Input
                id="inviteEmail"
                type="email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                placeholder={dict.inviteDialog.emailPlaceholder}
                className="col-span-3"
                dir="ltr"
              />
            </div>
            <DialogFooter>
              <DialogClose asChild>
                <Button
                  type="button"
                  variant="secondary"
                  disabled={isSendingInvite}
                >
                  {dict.inviteDialog.buttons.cancel}
                </Button>
              </DialogClose>
              <Button
                type="button"
                onClick={handleSendSetupInvite}
                disabled={isSendingInvite || !inviteEmail}
              >
                {isSendingInvite ? (
                  <Loader2 className="ml-2 h-4 w-4 animate-spin" />
                ) : (
                  <Send // Using Send icon for consistency
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                  />
                )}
                {isSendingInvite
                  ? dict.inviteDialog.buttons.sending
                  : dict.inviteDialog.buttons.send}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}

      {candidate && (
        <Dialog
          open={isDeleteCandidateDialogOpen}
          onOpenChange={(open) =>
            !isDeletingCandidate && setIsDeleteCandidateDialogOpen(open)
          }
        >
          <DialogContent className="sm:max-w-md">
            <DialogHeader>
              <DialogTitle className="text-xl flex items-center gap-2 text-red-600">
                <AlertCircle className="h-5 w-5" />
                {dict.deleteDialog.title}
              </DialogTitle>
              <DialogDescription>
                {dict.deleteDialog.description.replace(
                  '{{fullName}}',
                  `${candidate.firstName} ${candidate.lastName}`
                )}{' '}
                {dict.deleteDialog.irreversible}
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <Label htmlFor="deleteCandidateConfirm" className="text-gray-700">
                {dict.deleteDialog.confirmationLabel.replace(
                  '{{phrase}}',
                  DELETE_CANDIDATE_CONFIRMATION_PHRASE
                )}
              </Label>
              <Input
                id="deleteCandidateConfirm"
                value={deleteCandidateConfirmText}
                onChange={(e) => setDeleteCandidateConfirmText(e.target.value)}
                disabled={isDeletingCandidate}
                className="border-gray-300 focus:border-red-500"
                placeholder={dict.deleteDialog.inputPlaceholder}
                dir="rtl"
              />
              {deleteCandidateConfirmText &&
                deleteCandidateConfirmText !==
                  DELETE_CANDIDATE_CONFIRMATION_PHRASE && (
                  <p className="text-xs text-red-600">
                    {dict.deleteDialog.mismatchError}
                  </p>
                )}
            </div>
            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => {
                  setIsDeleteCandidateDialogOpen(false);
                  setDeleteCandidateConfirmText('');
                }}
                disabled={isDeletingCandidate}
                className="border-gray-300"
              >
                {dict.deleteDialog.buttons.cancel}
              </Button>
              <Button
                variant="destructive"
                onClick={handleDeleteCandidateRequest}
                disabled={
                  isDeletingCandidate ||
                  deleteCandidateConfirmText !==
                    DELETE_CANDIDATE_CONFIRMATION_PHRASE
                }
              >
                {isDeletingCandidate ? (
                  <span className="flex items-center gap-2">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    {dict.deleteDialog.buttons.deleting}
                  </span>
                ) : (
                  <>
                    <Trash2 className="w-4 h-4 mr-2" />
                    {dict.deleteDialog.buttons.delete}
                  </>
                )}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </>
  );
};

export default MatchmakerEditProfile;
--- End of Content for MatchmakerEditProfile.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\Actions.tsx
--------------------------------------------------------------------------------
Content:
// /components/matchmaker/CandidateCard/Actions.tsx

'use client';

import React, {useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  Eye,
  Sparkles,
  Send,
  MessageCircle,
  Calendar,
  Star,
  Zap,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface ActionsProps {
  candidate: Candidate;
  onInvite: (candidate: Candidate) => void;
  onSuggest: (candidate: Candidate) => void;
  onCheckAvailability: (candidate: Candidate) => void;
  onViewProfile: (candidate: Candidate) => void;
  className?: string;
  variant?: 'full' | 'compact' | 'minimal';
  showLabels?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['cardActions'];
}

const Actions: React.FC<ActionsProps> = ({
  candidate,
  onInvite,
  onSuggest,
  onCheckAvailability,
  onViewProfile,
  className,
  variant = 'full',
  showLabels = true,
  dict,
}) => {
  const [isHovered, setIsHovered] = useState(false);
  const [activeAction, setActiveAction] = useState<string | null>(null);

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
  };

  const handleActionClick = (action: string, callback: () => void) => {
    setActiveAction(action);
    callback();
    setTimeout(() => setActiveAction(null), 150);
  };

  const getPriorityBadge = () => {
    if (candidate.profile.availabilityStatus === 'AVAILABLE') {
      return (
        <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-lg animate-pulse">
          <Sparkles className="w-3 h-3 mr-1" />
          {dict.availableNow}
        </Badge>
      );
    }
    return null;
  };

  const actionButtons = [
    {
      id: 'view',
      label: dict.viewProfile,
      icon: Eye,
      onClick: () => onViewProfile(candidate),
      gradient: 'from-blue-500 to-cyan-500',
      hoverGradient: 'from-blue-600 to-cyan-600',
      description: dict.viewProfileTooltip,
      primary: true,
    },
    {
      id: 'suggest',
      label: dict.suggestMatch,
      icon: Heart,
      onClick: () => onSuggest(candidate),
      gradient: 'from-pink-500 to-rose-500',
      hoverGradient: 'from-pink-600 to-rose-600',
      description: dict.suggestMatchTooltip,
      primary: true,
    },
    {
      id: 'invite',
      label: dict.sendInvite,
      icon: Send,
      onClick: () => onInvite(candidate),
      gradient: 'from-purple-500 to-indigo-500',
      hoverGradient: 'from-purple-600 to-indigo-600',
      description: dict.sendInviteTooltip,
      primary: false,
    },
    {
      id: 'availability',
      label: dict.checkAvailability,
      icon: Calendar,
      onClick: () => onCheckAvailability(candidate),
      gradient: 'from-orange-500 to-amber-500',
      hoverGradient: 'from-orange-600 to-amber-600',
      description: dict.checkAvailabilityTooltip,
      primary: false,
    },
  ];

  if (variant === 'minimal') {
    return (
      <div
        className={cn('flex items-center gap-1', className)}
        onClick={handleClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
      >
        <TooltipProvider>
          {actionButtons.slice(0, 2).map((action) => {
            const IconComponent = action.icon;
            return (
              <Tooltip key={action.id}>
                <TooltipTrigger asChild>
                  <Button
                    variant="ghost"
                    size="icon"
                    className={cn(
                      'h-8 w-8 rounded-full transition-all duration-300 transform hover:scale-110',
                      `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                      'text-white shadow-lg hover:shadow-xl',
                      activeAction === action.id && 'scale-95'
                    )}
                    onClick={() => handleActionClick(action.id, action.onClick)}
                  >
                    <IconComponent className="w-4 h-4" />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{action.description}</p>
                </TooltipContent>
              </Tooltip>
            );
          })}
        </TooltipProvider>
      </div>
    );
  }

  if (variant === 'compact') {
    return (
      <div
        className={cn('flex flex-wrap gap-2', className)}
        onClick={handleClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
      >
        {getPriorityBadge()}

        <div className="flex gap-2">
          {actionButtons.map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                variant="outline"
                size="sm"
                className={cn(
                  'transition-all duration-300 transform hover:scale-105 border-0 shadow-lg hover:shadow-xl',
                  `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                  'text-white font-medium',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <IconComponent className="w-4 h-4 mr-2" />
                {showLabels && action.label}
              </Button>
            );
          })}
        </div>
      </div>
    );
  }

  // Full variant
  return (
    <div
      className={cn('space-y-4', className)}
      onClick={handleClick}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <div className="flex justify-center">{getPriorityBadge()}</div>

      <div className="grid grid-cols-2 gap-3">
        {actionButtons
          .filter((a) => a.primary)
          .map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                className={cn(
                  'h-12 transition-all duration-300 transform hover:scale-105 border-0 shadow-xl hover:shadow-2xl font-bold text-sm',
                  `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                  'text-white relative overflow-hidden group',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                <div className="relative z-10 flex items-center justify-center gap-2">
                  <IconComponent className="w-5 h-5" />
                  {showLabels && (
                    <span className="hidden sm:inline">{action.label}</span>
                  )}
                </div>
              </Button>
            );
          })}
      </div>

      <div className="flex gap-2">
        {actionButtons
          .filter((a) => !a.primary)
          .map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                variant="outline"
                size="sm"
                className={cn(
                  'flex-1 transition-all duration-300 transform hover:scale-105 border-2 hover:border-transparent shadow-lg hover:shadow-xl font-medium',
                  `border-gray-200 hover:bg-gradient-to-r hover:${action.gradient}`,
                  'hover:text-white group relative overflow-hidden',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <div
                  className={cn(
                    'absolute inset-0 bg-gradient-to-r transition-all duration-300 opacity-0 group-hover:opacity-100',
                    action.gradient
                  )}
                ></div>
                <div className="relative z-10 flex items-center justify-center gap-2">
                  <IconComponent className="w-4 h-4" />
                  {showLabels && (
                    <span className="text-xs hidden sm:inline">
                      {action.label}
                    </span>
                  )}
                </div>
              </Button>
            );
          })}
      </div>

      <div className="flex justify-center pt-2">
        <Button
          variant="ghost"
          size="sm"
          className={cn(
            'text-red-500 hover:text-red-600 hover:bg-red-50 transition-all duration-300 transform hover:scale-110 group',
            'border border-red-200 hover:border-red-300 shadow-sm hover:shadow-md rounded-full px-4'
          )}
        >
          <Heart
            className={cn(
              'w-4 h-4 transition-all duration-300',
              isHovered && 'fill-current animate-pulse'
            )}
          />
          <span className="mr-2 text-sm font-medium">{dict.addToFavorites}</span>
        </Button>
      </div>

      <div className="pt-3 border-t border-gray-100">
        <div className="flex justify-between items-center text-xs text-gray-500">
          <div className="flex items-center gap-1">
            <Star className="w-3 h-3 text-yellow-500" />
            <span>{dict.rating}: 4.8</span>
          </div>
          <div className="flex items-center gap-1">
            <Zap className="w-3 h-3 text-blue-500" />
            <span>{dict.matchScore}: 95%</span>
          </div>
          <div className="flex items-center gap-1">
            <MessageCircle className="w-3 h-3 text-green-500" />
            <span>{dict.response}: {dict.quickResponse}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Actions;
--- End of Content for Actions.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\MinimalCard.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/CandidateCard/MinimalCard.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { format } from 'date-fns';
import {
  User,
  MapPin,
  Briefcase,
  Calendar,
  Edit2,
  Sparkles,
  Star,
  Heart,
  Clock,
  Users,
  Zap,
  Award,
  MoreHorizontal,
  Mail,
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import type { Candidate } from '../types/candidates';
import { UserSource } from '@prisma/client';
import { motion } from 'framer-motion';
import { Skeleton } from '@/components/ui/skeleton';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface MinimalCandidateCardProps {
  candidate: Candidate;
  onClick: (candidate: Candidate) => void;
  onEdit?: (candidate: Candidate, e: React.MouseEvent) => void;
  onAnalyze?: (candidate: Candidate, e: React.MouseEvent) => void;
  onSendProfileFeedback?: (candidate: Candidate, e: React.MouseEvent) => void;
  isHighlighted?: boolean;
  highlightTerm?: string;
  className?: string;
  aiScore?: number;
  isAiTarget?: boolean;
  onSetAiTarget?: (candidate: Candidate, e: React.MouseEvent) => void;
  isSelectableForComparison?: boolean;
  isSelectedForComparison?: boolean;
  onToggleComparison?: (candidate: Candidate, e: React.MouseEvent) => void;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['minimalCard'];
}

const calculateAge = (birthDate: Date | string): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

const MinimalCandidateCard: React.FC<MinimalCandidateCardProps> = ({
  candidate,
  onClick,
  onEdit,
  onAnalyze,
  onSendProfileFeedback,
  isHighlighted = false,
  highlightTerm = '',
  className,
  aiScore,
  isAiTarget = false,
  onSetAiTarget,
  isSelectableForComparison = false,
  isSelectedForComparison = false,
  onToggleComparison,
  dict,
}) => {
  const mainImage = candidate.images.find((img) => img.isMain);
  const age = calculateAge(candidate.profile.birthDate);
  const [imageLoaded, setImageLoaded] = useState(false);
  const [imageError, setImageError] = useState(false);
  const [isHovered, setIsHovered] = useState(false);

  const highlightText = (text: string | undefined | null): React.ReactNode => {
    if (!highlightTerm || !text) return text;
    const parts = text.split(new RegExp(`(${highlightTerm})`, 'gi'));
    return (
      <>
        {parts.map((part, i) =>
          part.toLowerCase() === highlightTerm.toLowerCase() ? (
            <mark key={i} className="bg-yellow-200 px-0.5 rounded-sm">
              {part}
            </mark>
          ) : (
            part
          )
        )}
      </>
    );
  };

  const getAvailabilityBadge = () => {
    switch (candidate.profile.availabilityStatus) {
      case 'AVAILABLE':
        return {
          label: dict.availability.AVAILABLE,
          className:
            'bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 shadow-lg',
          icon: <Sparkles className="w-3 h-3" />,
        };
      case 'DATING':
        return {
          label: dict.availability.DATING,
          className:
            'bg-gradient-to-r from-amber-500 to-orange-500 text-white border-0 shadow-lg',
          icon: <Heart className="w-3 h-3" />,
        };
      case 'UNAVAILABLE':
        return {
          label: dict.availability.UNAVAILABLE,
          className:
            'bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-lg',
          icon: <Clock className="w-3 h-3" />,
        };
      default:
        return {
          label: dict.availability.UNKNOWN,
          className:
            'bg-gradient-to-r from-gray-500 to-slate-500 text-white border-0 shadow-lg',
          icon: <User className="w-3 h-3" />,
        };
    }
  };

  const getQualityScore = () => {
    let score = 0;
    if (candidate.images.length > 0) score += 25;
    if (candidate.profile.about) score += 25;
    if (candidate.profile.education) score += 25;
    if (candidate.profile.occupation) score += 25;
    return score;
  };

  const availabilityBadge = getAvailabilityBadge();
  const isManualEntry = candidate.source === UserSource.MANUAL_ENTRY;
  const qualityScore = getQualityScore();

  return (
    <motion.div
      whileHover={{ y: -6, scale: 1.02 }}
      whileTap={{ scale: 0.98 }}
      transition={{ type: 'spring', stiffness: 300, damping: 15 }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <Card
        className={cn(
          'relative overflow-hidden cursor-pointer transition-all hover:shadow-2xl duration-500 group border-0 shadow-xl',
          isAiTarget
            ? 'ring-4 ring-green-400 ring-opacity-60 shadow-green-200'
            : isSelectedForComparison
              ? 'ring-4 ring-blue-400 ring-opacity-60 shadow-blue-200'
              : typeof aiScore === 'number'
                ? 'ring-2 ring-teal-300 ring-opacity-50 shadow-teal-100'
                : isHighlighted
                  ? 'ring-2 ring-yellow-400 ring-opacity-60 shadow-yellow-100'
                  : 'shadow-gray-200',
          'bg-gradient-to-br from-white via-gray-50/30 to-white',
          className || ''
        )}
        onClick={() => onClick(candidate)}
      >
        <div className="absolute inset-0 bg-gradient-to-br from-transparent via-white/50 to-transparent opacity-60"></div>

        {typeof aiScore === 'number' && (
          <div className="absolute top-3 left-3 z-30">
            <Badge className="bg-gradient-to-r from-teal-400 via-cyan-500 to-blue-500 text-white border-0 shadow-xl px-3 py-1.5 text-sm font-bold flex items-center gap-2">
              <Sparkles className="w-4 h-4" />
              {dict.aiMatch.replace('{{score}}', aiScore.toString())}
              <Zap className="w-3 h-3" />
            </Badge>
          </div>
        )}

        <div className="absolute top-3 right-3 z-20 flex flex-col gap-2 items-end">
          <Badge
            className={cn(
              'px-3 py-1.5 text-xs font-bold shadow-lg flex items-center gap-1.5 transition-all duration-300 hover:scale-105',
              availabilityBadge.className
            )}
          >
            {availabilityBadge.icon}
            {availabilityBadge.label}
          </Badge>

          {isManualEntry && (
            <Badge className="px-3 py-1.5 text-xs font-bold shadow-lg bg-gradient-to-r from-purple-500 to-indigo-500 text-white border-0 flex items-center gap-1.5">
              <Edit2 className="w-3 h-3" />
              {dict.manualEntry}
            </Badge>
          )}

              {candidate.profile.testimonials && candidate.profile.testimonials.filter(t => t.status === 'APPROVED').length > 0 && (
            <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ delay: 0.2 }}>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger>
                    <Badge className="px-3 py-1.5 text-xs font-bold shadow-lg bg-gradient-to-r from-yellow-400 to-amber-500 text-white border-0 flex items-center gap-1.5">
                      <Users className="w-3 h-3" />
                      {dict.hasTestimonials.replace("{{count}}", String(candidate.profile.testimonials.filter(t => t.status === 'APPROVED').length))}
                    </Badge>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{dict.testimonialsTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </motion.div>
          )}
        </div>

        <div className="relative h-52 sm:h-60 bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100">
          {mainImage && !imageError ? (
            <>
              {!imageLoaded && (
                <Skeleton className="absolute inset-0 h-full w-full" />
              )}
              <Image
                src={getRelativeCloudinaryPath(mainImage.url)}
                alt={`${candidate.firstName} ${candidate.lastName}`}
                fill
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                priority={false}
                className={`object-cover transition-all duration-500 ${
                  imageLoaded ? 'opacity-100 scale-100' : 'opacity-0 scale-105'
                } ${isHovered ? 'scale-110' : 'scale-100'}`}
                onLoad={() => setImageLoaded(true)}
                onError={() => setImageError(true)}
              />
              <div className="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/40 to-transparent opacity-80 group-hover:opacity-90 transition-opacity duration-300" />
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
            </>
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100">
              <div className="text-center">
                <User className="w-16 h-16 text-gray-400 mx-auto mb-2" />
                <p className="text-sm text-gray-500">{dict.noImage}</p>
              </div>
            </div>
          )}

          <div className="absolute bottom-0 w-full p-4 text-right">
            <h3 className="font-bold mb-1 text-white drop-shadow-lg text-xl tracking-wide">
              {highlightText(`${candidate.firstName} ${candidate.lastName}`)}
            </h3>
            <div className="flex items-center justify-end gap-3 text-white/95 text-sm">
              <span className="bg-black/30 px-2 py-1 rounded-full backdrop-blur-sm font-medium">
                {age} {dict.yearsSuffix}
              </span>
              <Calendar className="w-4 h-4" />
            </div>
          </div>
        </div>

        <div className="p-5 relative z-10">
          <div className="space-y-3 text-gray-700">
            {isManualEntry && candidate.profile.manualEntryText ? (
              <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-3 rounded-xl border border-purple-100">
                <p className="line-clamp-3 text-sm leading-relaxed text-purple-800">
                  {highlightText(candidate.profile.manualEntryText)}
                </p>
              </div>
            ) : (
              <div className="space-y-2">
                {candidate.profile.city && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors duration-200">
                    <span className="font-medium text-blue-800">
                      {highlightText(candidate.profile.city)}
                    </span>
                    <MapPin className="w-4 h-4 text-blue-600" />
                  </div>
                )}
                {candidate.profile.occupation && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-green-50 rounded-lg hover:bg-green-100 transition-colors duration-200">
                    <span className="text-green-800 text-sm">
                      {highlightText(candidate.profile.occupation)}
                    </span>
                    <Briefcase className="w-4 h-4 text-green-600" />
                  </div>
                )}
              </div>
            )}

            {candidate.profile.lastActive && (
              <div className="flex items-center justify-end gap-2 mt-3 pt-3 border-t border-gray-100">
                <span className="text-xs text-gray-500">
                  {`${dict.lastActivePrefix} ${format(new Date(candidate.profile.lastActive), 'dd/MM/yyyy')}`}
                </span>
                <Clock className="w-3 h-3 text-gray-400" />
              </div>
            )}
          </div>
        </div>

        {/* ======================= הקוד החדש והמתוקן לפינה השמאלית ======================= */}
        <div className="absolute bottom-3 left-3 z-20 flex items-center gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-all duration-300 transform lg:translate-y-2 group-hover:translate-y-0">
          {/* --- כפתור אימייל --- */}
          {candidate.email &&
            !candidate.email.endsWith('@shidduch.placeholder.com') && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      asChild
                      variant="outline"
                      size="icon"
                      className="h-9 w-9 bg-white/90 backdrop-blur-sm shadow-xl border-0 hover:bg-white hover:scale-110 transition-all duration-300"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <a href={`mailto:${candidate.email}`}>
                        <Mail className="h-4 w-4 text-gray-600" />
                      </a>
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{candidate.email}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}

          {/* --- תפריט פעולות נוספות --- */}
          <DropdownMenu>
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="icon"
                      className="h-9 w-9 bg-white/90 backdrop-blur-sm shadow-xl border-0 hover:bg-white hover:scale-110 transition-all duration-300"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <MoreHorizontal className="h-4 w-4 text-gray-600" />
                    </Button>
                  </DropdownMenuTrigger>
                </TooltipTrigger>
                <TooltipContent>
                  <p>פעולות נוספות</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>

            <DropdownMenuContent
              onClick={(e) => e.stopPropagation()}
              align="start"
            >
              {onEdit && (
                <DropdownMenuItem onClick={(e) => onEdit(candidate, e)}>
                  <Edit2 className="h-4 w-4 ml-2" />
                  <span>{dict.tooltips.editProfile}</span>
                </DropdownMenuItem>
              )}
              {onAnalyze && (
                <DropdownMenuItem onClick={(e) => onAnalyze(candidate, e)}>
                  <Sparkles className="h-4 w-4 ml-2" />
                  <span>{dict.tooltips.aiAnalysis}</span>
                </DropdownMenuItem>
              )}
              {onSendProfileFeedback && (
                <DropdownMenuItem
                  onClick={(e) => onSendProfileFeedback(candidate, e)}
                >
                  <Mail className="h-4 w-4 ml-2" />
                  <span>שלח דוח פרופיל</span>
                </DropdownMenuItem>
              )}
            </DropdownMenuContent>
          </DropdownMenu>

          {/* --- כפתור קביעת מטרה (כוכב) --- */}
          {onSetAiTarget && (
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    size="icon"
                    className={cn(
                      'h-9 w-9 backdrop-blur-sm shadow-xl border-0 hover:scale-110 transition-all duration-300',
                      isAiTarget
                        ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:from-green-600 hover:to-emerald-600'
                        : 'bg-white/90 hover:bg-white text-gray-600'
                    )}
                    onClick={(e) => onSetAiTarget(candidate, e)}
                  >
                    <Star
                      className={cn(
                        'h-4 w-4 transition-all duration-300',
                        isAiTarget ? 'fill-current rotate-12' : ''
                      )}
                    />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>
                    {isAiTarget
                      ? dict.tooltips.clearAiTarget
                      : dict.tooltips.setAsAiTarget}
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          )}
        </div>
        {/* ======================= סוף הקוד החדש ======================= */}

        <div className="absolute top-3 left-1/2 transform -translate-x-1/2 z-20 opacity-0 group-hover:opacity-100 transition-all duration-300">
          <div className="flex items-center gap-1 bg-black/60 text-white px-3 py-1 rounded-full backdrop-blur-sm text-xs font-bold">
            <Award className="w-3 h-3" />
            <span>
              {dict.qualityScore.replace('{{score}}', qualityScore.toString())}
            </span>
          </div>
        </div>

        {isSelectableForComparison && onToggleComparison && (
          <div
            className="absolute bottom-3 right-3 z-20 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-all duration-300 transform lg:translate-y-2 group-hover:translate-y-0"
            onClick={(e) => {
              e.stopPropagation();
              onToggleComparison(candidate, e);
            }}
          >
            <div className="flex items-center space-x-2 bg-white/90 backdrop-blur-sm p-2 rounded-xl shadow-xl cursor-pointer hover:bg-white hover:scale-105 transition-all duration-300 border-0">
              <Checkbox
                id={`compare-${candidate.id}`}
                checked={isSelectedForComparison}
                className="pointer-events-none border-2 border-blue-400 data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-blue-500 data-[state=checked]:to-cyan-500 data-[state=checked]:border-blue-500"
              />
              <label
                htmlFor={`compare-${candidate.id}`}
                className="text-xs font-bold leading-none text-gray-700 cursor-pointer"
              >
                {dict.compare}
              </label>
            </div>
          </div>
        )}

        <div className="absolute inset-0 bg-gradient-to-r from-blue-400/0 via-purple-400/0 to-pink-400/0 group-hover:from-blue-400/10 group-hover:via-purple-400/10 group-hover:to-pink-400/10 transition-all duration-500 pointer-events-none rounded-lg"></div>
      </Card>
    </motion.div>
  );
};

export default MinimalCandidateCard;
--- End of Content for MinimalCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\QuickView.tsx
--------------------------------------------------------------------------------
Content:
// File: src/app/components/matchmaker/new/CandidateCard/QuickView.tsx

'use client';
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,

  Clock,
  Eye,
  Scroll,
  GraduationCap,
  Briefcase,
  MapPin,
  User,
  FileText,
  CalendarClock,
  Edit,
  Info,
  Star,
  Sparkles,
  Send,
  Calendar,
  Zap,
  Award,
  MessageCircle,
  X,
} from 'lucide-react';

import { Separator } from '@/components/ui/separator';
import type { Candidate } from '../types/candidates';
import { UserSource } from '@prisma/client';
import { cn } from '@/lib/utils';
import { motion } from 'framer-motion';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// פונקציה לחישוב גיל
const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

type ActionId = 'view' | 'invite' | 'suggest' | 'contact' | 'favorite' | 'edit';

interface QuickViewProps {
  candidate: Candidate;
  onAction: (action: ActionId) => void;
  onSetAiTarget?: (candidate: Candidate, e: React.MouseEvent) => void;
  isAiTarget?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['quickView'];
}

const QuickView: React.FC<QuickViewProps> = ({
  candidate,
  onAction,
  onSetAiTarget,
  isAiTarget = false,
  dict,
}) => {
  const [isClosing, setIsClosing] = useState(false);
  const [hoveredAction, setHoveredAction] = useState<string | null>(null);

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
  };

  const handleClose = () => {
    setIsClosing(true);
    setTimeout(() => {
      // The parent component will handle the actual closing
    }, 150);
  };

  const profile = candidate.profile;
  const isManualEntry = candidate.source === UserSource.MANUAL_ENTRY;
  const mainImage = candidate.images?.find((img) => img.isMain);

  const getAvailabilityInfo = () => {
    switch (profile.availabilityStatus) {
      case 'AVAILABLE':
        return {
          label: dict.availability.AVAILABLE,
          gradient: 'from-emerald-500 to-green-500',
          icon: <Sparkles className="w-4 h-4" />,
          description: dict.availabilityDescription.AVAILABLE,
        };
      case 'DATING':
        return {
          label: dict.availability.DATING,
          gradient: 'from-amber-500 to-orange-500',
          icon: <Heart className="w-4 h-4" />,
          description: dict.availabilityDescription.DATING,
        };
      case 'UNAVAILABLE':
        return {
          label: dict.availability.UNAVAILABLE,
          gradient: 'from-red-500 to-pink-500',
          icon: <Clock className="w-4 h-4" />,
          description: dict.availabilityDescription.UNAVAILABLE,
        };
      default:
        return {
          label: dict.availability.UNKNOWN,
          gradient: 'from-gray-500 to-slate-500',
          icon: <User className="w-4 h-4" />,
          description: dict.availabilityDescription.UNKNOWN,
        };
    }
  };

  const getQualityScore = () => {
    let score = 0;
    if (candidate.images.length > 0) score += 25;
    if (profile.about) score += 25;
    if (profile.education) score += 25;
    if (profile.occupation) score += 25;
    return score;
  };

  const availabilityInfo = getAvailabilityInfo();
  const qualityScore = getQualityScore();

  const actionButtons: {
    id: 'view' | 'invite' | 'suggest' | 'contact' | 'edit';
    label: string;
    icon: React.ElementType;
    gradient: string;
    description: string;
    primary: boolean;
  }[] = [
    {
      id: 'view',
      label: dict.actions.view,
      icon: Eye,
      gradient: 'from-blue-500 to-cyan-500',
      description: dict.actionsDescription.view,
      primary: true,
    },
    {
      id: 'suggest',
      label: dict.actions.suggest,
      icon: Heart,
      gradient: 'from-pink-500 to-rose-500',
      description: dict.actionsDescription.suggest,
      primary: true,
    },
    {
      id: 'invite',
      label: dict.actions.invite,
      icon: Send,
      gradient: 'from-purple-500 to-indigo-500',
      description: dict.actionsDescription.invite,
      primary: false,
    },
    {
      id: 'contact',
      label: dict.actions.contact,
      icon: Calendar,
      gradient: 'from-orange-500 to-amber-500',
      description: dict.actionsDescription.contact,
      primary: false,
    },
    {
      id: 'edit',
      label: dict.actions.edit,
      icon: Edit,
      gradient: 'from-gray-500 to-slate-500',
      description: dict.actionsDescription.edit,
      primary: false,
    },
  ];

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9, y: 20 }}
      animate={{
        opacity: isClosing ? 0 : 1,
        scale: isClosing ? 0.9 : 1,
        y: isClosing ? 20 : 0,
      }}
      transition={{ type: 'spring', stiffness: 300, damping: 25 }}
      className="bg-white shadow-2xl flex flex-col border-0 overflow-hidden max-w-md sm:max-w-lg w-full rounded-3xl max-h-[85vh]"
      onClick={handleClick}
    >
      <div
        className={cn(
          'relative px-6 py-6 text-white overflow-hidden',
          `bg-gradient-to-br ${availabilityInfo.gradient}`
        )}
      >
        <div className="absolute inset-0">
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/20 rounded-full blur-2xl"></div>
          <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
        </div>
        <div className="relative z-10">
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="relative w-16 h-16 rounded-full overflow-hidden border-3 border-white/30 shadow-xl">
                {mainImage ? (
                  <Image src={getRelativeCloudinaryPath(mainImage.url)} alt={`${candidate.firstName} ${candidate.lastName}`} fill className="object-cover" />
                ) : (
                  <div className="w-full h-full bg-white/20 flex items-center justify-center"><User className="w-8 h-8 text-white/80" /></div>
                )}
              </div>
              <div>
                <h3 className="text-xl font-bold mb-1">{candidate.firstName} {candidate.lastName}</h3>
                <div className="flex items-center gap-2">{availabilityInfo.icon}<span className="text-white/90 font-medium">{availabilityInfo.label}</span></div>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {onSetAiTarget && (
                <Button size="icon" variant="ghost" className="h-8 w-8 text-white hover:bg-white/20 rounded-full" onClick={(e) => onSetAiTarget(candidate, e)} title={isAiTarget ? dict.tooltips.clearAiTarget : dict.tooltips.setAsAiTarget}>
                  <Star className={cn('h-5 w-5', isAiTarget ? 'fill-current text-yellow-300' : 'text-white/80')} />
                </Button>
              )}
              <Button size="icon" variant="ghost" className="h-8 w-8 text-white hover:bg-white/20 rounded-full" onClick={handleClose}><X className="h-5 w-5" /></Button>
            </div>
          </div>
          <div className="flex flex-wrap gap-2">
            <Badge className="bg-white/20 text-white border-white/30 backdrop-blur-sm">{availabilityInfo.description}</Badge>
            {isManualEntry && (<Badge className="bg-purple-500/30 text-white border-purple-300/50 backdrop-blur-sm"><Edit className="w-3 h-3 mr-1" />{dict.manualEntry}</Badge>)}
          </div>
        </div>
      </div>
      <div className="flex-1 p-6 space-y-6 text-right overflow-y-auto bg-gradient-to-br from-white to-gray-50/30">
        <div className="grid grid-cols-2 gap-4">
          {profile.birthDate && (
            <div className="p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-blue-700"><span className="font-bold text-lg">{calculateAge(new Date(profile.birthDate))}</span><CalendarClock className="w-5 h-5" /></div>
              <p className="text-xs text-blue-600 mt-1">{dict.details.years}</p>
            </div>
          )}
          {profile.height && (
            <div className="p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-purple-700"><span className="font-bold text-lg">{profile.height}</span><User className="w-5 h-5" /></div>
              <p className="text-xs text-purple-600 mt-1">{dict.details.heightUnit}</p>
            </div>
          )}
          {profile.maritalStatus && (
            <div className="p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-green-700"><span className="font-medium text-sm">{profile.maritalStatus}</span><Heart className="w-5 h-5" /></div>
              <p className="text-xs text-green-600 mt-1">{dict.details.maritalStatus}</p>
            </div>
          )}
          {profile.religiousLevel && (
            <div className="p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-orange-700"><span className="font-medium text-sm">{profile.religiousLevel}</span><Scroll className="w-5 h-5" /></div>
              <p className="text-xs text-orange-600 mt-1">{dict.details.religiousLevel}</p>
            </div>
          )}
        </div>
        <Separator className="my-6 bg-gradient-to-r from-transparent via-gray-300 to-transparent" />
        {isManualEntry && profile.manualEntryText ? (
          <div className="space-y-4">
            <div className="flex items-center justify-end gap-2"><h4 className="text-lg font-bold text-purple-800">{dict.details.manualDescription}</h4><Info className="w-6 h-6 text-purple-500" /></div>
            <div className="p-5 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-200 shadow-sm"><p className="text-purple-900 leading-relaxed whitespace-pre-wrap font-medium">{profile.manualEntryText}</p></div>
          </div>
        ) : (
          <div className="space-y-4">
            <h4 className="text-lg font-bold text-gray-700 mb-4 flex items-center justify-end gap-2"><span>{dict.details.moreInfo}</span><Sparkles className="w-5 h-5 text-blue-500" /></h4>
            {profile.education && (<div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 hover:shadow-md transition-all duration-300 group"><div className="flex items-center justify-end gap-3"><span className="font-medium text-blue-800 group-hover:text-blue-900 transition-colors">{profile.education}</span><div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg"><GraduationCap className="w-4 h-4" /></div></div><p className="text-xs text-blue-600 mt-1 text-right">{dict.details.education}</p></div>)}
            {profile.occupation && (<div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300 group"><div className="flex items-center justify-end gap-3"><span className="font-medium text-green-800 group-hover:text-green-900 transition-colors">{profile.occupation}</span><div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg"><Briefcase className="w-4 h-4" /></div></div><p className="text-xs text-green-600 mt-1 text-right">{dict.details.occupation}</p></div>)}
            {profile.city && (<div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100 hover:shadow-md transition-all duration-300 group"><div className="flex items-center justify-end gap-3"><span className="font-medium text-purple-800 group-hover:text-purple-900 transition-colors">{profile.city}</span><div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg"><MapPin className="w-4 h-4" /></div></div><p className="text-xs text-purple-600 mt-1 text-right">{dict.details.location}</p></div>)}
          </div>
        )}
        {(!isManualEntry || !profile.manualEntryText) && profile.about && (
          <>
            <Separator className="my-6 bg-gradient-to-r from-transparent via-gray-300 to-transparent" />
            <div className="space-y-4">
              <h4 className="text-lg font-bold text-gray-700 flex items-center justify-end gap-2"><span>{dict.details.about}</span><FileText className="w-5 h-5 text-gray-500" /></h4>
              <div className="p-5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl border border-gray-200 shadow-sm"><p className="text-gray-800 leading-relaxed whitespace-pre-wrap">{profile.about}</p></div>
            </div>
          </>
        )}
      </div>
      <div className="p-6 bg-gradient-to-r from-gray-50 to-white border-t border-gray-100">
        <div className="flex items-center justify-center mb-4">
          <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-cyan-50 px-4 py-2 rounded-full border border-blue-100">
            <Award className="w-4 h-4 text-blue-600" />
            <span className="text-sm font-bold text-blue-800">{dict.qualityScore.replace('{{score}}', String(qualityScore))}</span>
            <div className="flex gap-1">{[...Array(5)].map((_, i) => (<Star key={i} className={cn('w-3 h-3', i < Math.floor(qualityScore / 20) ? 'text-yellow-500 fill-current' : 'text-gray-300')} />))}</div>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 mb-4">
          {actionButtons.filter((a) => a.primary).map((action) => {
            const IconComponent = action.icon;
            return (<Button key={action.id} className={cn('h-12 font-bold text-sm border-0 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 relative overflow-hidden group rounded-2xl', `bg-gradient-to-r ${action.gradient} hover:${action.gradient.replace('500', '600')}`, 'text-white', hoveredAction === action.id && 'scale-105')} onClick={() => onAction(action.id)} onMouseEnter={() => setHoveredAction(action.id)} onMouseLeave={() => setHoveredAction(null)}>
              <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
              <div className="relative z-10 flex items-center justify-center gap-2"><IconComponent className="w-5 h-5" /><span>{action.label}</span></div>
            </Button>);
          })}
        </div>
        <div className="grid grid-cols-3 gap-2">
          {actionButtons.filter((a) => !a.primary).map((action) => {
            const IconComponent = action.icon;
            return (<Button key={action.id} variant="outline" size="sm" className={cn('border-2 border-gray-200 hover:border-transparent shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 group relative overflow-hidden rounded-xl', `hover:bg-gradient-to-r hover:${action.gradient}`, 'hover:text-white font-medium', hoveredAction === action.id && 'scale-105')} onClick={() => onAction(action.id)} onMouseEnter={() => setHoveredAction(action.id)} onMouseLeave={() => setHoveredAction(null)}>
              <div className={cn('absolute inset-0 bg-gradient-to-r transition-all duration-300 opacity-0 group-hover:opacity-100', action.gradient)}></div>
              <div className="relative z-10 flex items-center justify-center gap-1"><IconComponent className="w-3 h-3" /><span className="text-xs">{action.label}</span></div>
            </Button>);
          })}
        </div>
        <div className="mt-4 pt-4 border-t border-gray-200">
          <div className="flex justify-between items-center text-xs">
            <div className="flex items-center gap-1 text-yellow-600"><Star className="w-3 h-3 fill-current" /><span className="font-medium">{dict.stats.rating}: 4.8</span></div>
            <div className="flex items-center gap-1 text-blue-600"><Zap className="w-3 h-3" /><span className="font-medium">{dict.stats.match}: 95%</span></div>
            <div className="flex items-center gap-1 text-green-600"><MessageCircle className="w-3 h-3" /><span className="font-medium">{dict.stats.response}: {dict.stats.quick}</span></div>
          </div>
        </div>
      </div>
    </motion.div>
  );
};

export default QuickView;
--- End of Content for QuickView.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesList.tsx
--------------------------------------------------------------------------------
Content:
// File: src/app/components/matchmaker/new/CandidatesManager/CandidatesList.tsx

import React, {
  useState,
  useCallback,
  useEffect,
  useRef,
  useMemo,
} from 'react';
import { UserX, Edit } from 'lucide-react';
import MinimalCard from '../CandidateCard/MinimalCard';
import QuickView from '../CandidateCard/QuickView';
import { ProfileCard } from '@/components/profile';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { Skeleton } from '@/components/ui/skeleton';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import { ActionDialogs } from '../dialogs/ActionDialogs';
import NewSuggestionForm from '../../suggestions/NewSuggestionForm';
import MatchmakerEditProfile from '../MatchmakerEditProfile';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';

interface CreateSuggestionData {
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
  firstPartyId: string;
  secondPartyId: string;
  status:
    | 'DRAFT'
    | 'PENDING_FIRST_PARTY'
    | 'FIRST_PARTY_APPROVED'
    | 'FIRST_PARTY_DECLINED'
    | string;
  firstPartyNotes?: string;
  secondPartyNotes?: string;
}

interface CandidatesListProps {
  candidates: (Candidate & { aiScore?: number })[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void; // <-- הוסף
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void; // <-- הוספת '?'

  onCandidateClick?: (candidate: Candidate) => void;
  onCandidateAction?: (type: CandidateAction, candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  highlightTerm?: string;
  aiTargetCandidate: Candidate | null;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  quickViewSide?: 'left' | 'right' | 'center';
  isQuickViewEnabled: boolean; // <-- קבלת prop חדש
  locale: string;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

const CandidatesList: React.FC<CandidatesListProps> = ({
  candidates,
  allCandidates,
  locale,
  onCandidateClick,
  onCandidateAction,
  isQuickViewEnabled, // <-- שימוש ב-prop החדש
  onOpenAiAnalysis,
  onSendProfileFeedback, // <-- הוסף את זה

  viewMode,
  mobileView,
  isLoading = false,
  className,
  highlightTerm,
  aiTargetCandidate,
  onSetAiTarget,
  comparisonSelection,
  onToggleComparison,
  quickViewSide = 'center',
  dict,
  profileDict,
}) => {
  // ... (כל הלוגיקה הפנימית נשארת זהה) ...
  // Base states
  const [selectedCandidate, setSelectedCandidate] = useState<Candidate | null>(
    null
  );
  const [questionnaireResponse, setQuestionnaireResponse] =
    useState<QuestionnaireResponse | null>(null);
  const [isMatchmaker, setIsMatchmaker] = useState(false);
  const [hoveredCandidate, setHoveredCandidate] = useState<Candidate | null>(
    null
  );
  const [hoverPosition, setHoverPosition] = useState({ top: 0, left: 0 });
  const hoverTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const quickViewRef = useRef<HTMLDivElement>(null);

  // Dialog states
  const [showInviteDialog, setShowInviteDialog] = useState(false);
  const [showAvailabilityDialog, setShowAvailabilityDialog] = useState(false);
  const [showSuggestDialog, setShowSuggestDialog] = useState(false);
  const [showEditProfileDialog, setShowEditProfileDialog] = useState(false);
  const [dialogCandidate, setDialogCandidate] = useState<Candidate | null>(
    null
  );

  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const checkScreenSize = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => {
      window.removeEventListener('resize', checkScreenSize);
    };
  }, []);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        hoveredCandidate &&
        quickViewRef.current &&
        !quickViewRef.current.contains(event.target as Node)
      ) {
        setHoveredCandidate(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [hoveredCandidate]);

  useEffect(() => {
    return () => {
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
      }
    };
  }, []);

  // --- קוד חדש ומתוקן ---
  useEffect(() => {
    const loadQuestionnaire = async () => {
      if (!selectedCandidate) {
        setQuestionnaireResponse(null);
        return;
      }
      try {
        // ✨ בניית פרמטרים בצורה בטוחה
        const params = new URLSearchParams();
        params.append('userId', selectedCandidate.id);
        params.append('locale', locale); // ✨ הוספת פרמטר השפה החסר

        const response = await fetch(
          `/api/profile/questionnaire?${params.toString()}`
        );

        const data = await response.json();
        if (data.success && data.questionnaireResponse) {
          setQuestionnaireResponse(data.questionnaireResponse);
        } else {
          // טיפול במקרה שהתגובה לא מוצלחת
          console.warn('Could not load questionnaire:', data.message);
          setQuestionnaireResponse(null);
        }
      } catch (error) {
        console.error('Failed to load questionnaire:', error);
        toast.error('שגיאה בטעינת השאלון');
      }
    };
    loadQuestionnaire();
  }, [selectedCandidate, locale]); // ✨ הוספת locale למערך התלויות של ה-hook

  // Action handlers
  const handleInvite = async (candidate: Candidate, email: string) => {
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/invite-setup`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ candidateId: candidate.id, email }),
        }
      );
      if (!response.ok) throw new Error('Failed to send invitation');
      toast.success('ההזמנה נשלחה בהצלחה');
      onCandidateAction?.('invite', candidate);
    } catch (error) {
      console.error('Error sending invite:', error);
      throw error;
    }
  };

  const handleAvailabilityCheck = async (candidate: Candidate) => {
    try {
      const response = await fetch('/api/availability/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId: candidate.id }),
      });
      if (!response.ok) throw new Error('Failed to check availability');
      toast.success('בדיקת הזמינות נשלחה');
      onCandidateAction?.('contact', candidate);
    } catch (error) {
      console.error('Error checking availability:', error);
      throw error;
    }
  };

  const handleCreateSuggestion = async (data: CreateSuggestionData) => {
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        }
      );
      if (!response.ok) throw new Error('Failed to create suggestion');
      toast.success('ההצעה נוצרה בהצלחה');
      onCandidateAction?.('suggest', dialogCandidate!);
    } catch (error) {
      console.error('Error creating suggestion:', error);
      throw error;
    }
  };

  const handleEditProfile = (candidate: Candidate) => {
    setDialogCandidate(candidate);
    setShowEditProfileDialog(true);
  };

  const handleMouseEnter = (candidate: Candidate, e?: React.MouseEvent) => {
    if (isMobile || !e || !isQuickViewEnabled) return; // <-- תנאי חדש

    if (isMobile || !e) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
    }
    const cardElement = e.currentTarget as HTMLElement;
    const cardRect = cardElement.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const padding = 20;
    const quickViewApproxHeight = Math.min(650, viewportHeight * 0.85);
    let top;
    if (cardRect.top + quickViewApproxHeight > viewportHeight - padding) {
      top = cardElement.offsetTop + cardRect.height - quickViewApproxHeight;
    } else {
      top = cardElement.offsetTop;
    }
    const scrollContainer = cardElement.closest('.overflow-y-auto');
    if (scrollContainer) {
      top = Math.max(top, scrollContainer.scrollTop);
    }
    let left;
    const quickViewWidth = 420;
    switch (quickViewSide) {
      case 'left':
        left = window.innerWidth / 4 - quickViewWidth / 2;
        break;
      case 'right':
        left = (window.innerWidth * 3) / 4 - quickViewWidth / 2 - 470;
        break;
      case 'center':
      default:
        left = window.innerWidth / 2 - quickViewWidth / 2;
        break;
    }
    left = Math.max(
      padding,
      Math.min(left, window.innerWidth - quickViewWidth - padding)
    );
    hoverTimeoutRef.current = setTimeout(() => {
      setHoverPosition({ top, left });
      setHoveredCandidate(candidate);
    }, 300);
  };

  const handleMouseLeave = () => {
    if (isMobile) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
      hoverTimeoutRef.current = null;
    }
    setTimeout(() => {
      if (!quickViewRef.current?.matches(':hover')) {
        setHoveredCandidate(null);
      }
    }, 100);
  };

const handleAction = useCallback(
  (action: CandidateAction | 'analyze' | 'sendFeedback', candidate: Candidate) => { // <-- הוסף 'sendFeedback'
    setDialogCandidate(candidate);
    setHoveredCandidate(null);
    switch (action) {
      case 'invite':
        setShowInviteDialog(true);
        break;
      case 'contact':
        setShowAvailabilityDialog(true);
        break;
      case 'suggest':
        setShowSuggestDialog(true);
        break;
      case 'view':
        setSelectedCandidate(candidate);
        onCandidateClick?.(candidate);
        break;
      case 'edit':
        handleEditProfile(candidate);
        break;
      case 'analyze':
        onOpenAiAnalysis(candidate);
        break;
           case 'sendFeedback':
        // פשוט קוראים לפונקציה בלי האירוע המזויף
        if (onSendProfileFeedback) {
          onSendProfileFeedback(candidate); 
        }
        break;

      default:
        onCandidateAction?.(action as CandidateAction, candidate);
    }
  },
  [onCandidateAction, onCandidateClick, onOpenAiAnalysis, onSendProfileFeedback] // <-- הוסף את התלות החדשה
);

  const gridLayoutClass = useMemo(() => {
    if (isMobile) {
      return mobileView === 'double'
        ? 'grid grid-cols-2 gap-2'
        : 'grid grid-cols-1 gap-3';
    }
    return viewMode === 'grid'
      ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-3 gap-y-4'
      : 'space-y-4';
  }, [isMobile, mobileView, viewMode]);

  // ... (החלק של isLoading ו-candidates.length === 0 נשאר זהה) ...
  if (isLoading) {
    return (
      <div
        className={`${viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'space-y-4'} ${className || ''}`}
      >
        {Array.from({ length: 6 }).map((_, i) => (
          <div key={i} className="relative">
            <Skeleton
              className={
                viewMode === 'list' ? 'h-32 w-full' : 'h-[350px] w-full'
              }
            />
            <div className="absolute top-3 right-3">
              <Skeleton className="h-6 w-16 rounded-full" />
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (candidates.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-32 bg-gray-50 rounded-lg border border-dashed border-gray-300 p-4 text-center">
        <UserX className="w-8 h-8 mb-2 text-gray-400" />
        <p className="text-sm font-medium text-gray-500 mb-1">
          {dict.candidatesManager.list.emptyState.title}
        </p>
        <p className="text-xs text-gray-400">
          {dict.candidatesManager.list.emptyState.description}
        </p>
      </div>
    );
  }

  return (
    <>
      <div className={cn(gridLayoutClass, className || '')}>
        {candidates.map((candidate) => (
          <div
            key={candidate.id}
            className="group relative"
            onMouseEnter={(e) => handleMouseEnter(candidate, e)}
            onMouseLeave={handleMouseLeave}
            onClick={() => handleAction('view', candidate)}
          >
            {/********** תיקון #1: העברת המילון הנכון ל-MinimalCard **********/}
            <MinimalCard
              candidate={candidate}
              onClick={() => handleAction('view', candidate)}
                  onAnalyze={(c, e) => { // <-- הוסף את זה
        e.stopPropagation();
        handleAction('analyze', c);
    }}
  onSendProfileFeedback={(c, e) => { // <-- הוסף את כל הבלוק הזה
            e.stopPropagation();
            handleAction('sendFeedback', c);
          }}
              onEdit={(c, e) => {
                e.stopPropagation();
                handleAction('edit', c);
              }}
              className={cn(
                viewMode === 'list' && !isMobile
                  ? 'flex flex-row-reverse gap-4 h-32'
                  : '',
                isMobile && mobileView === 'double' ? 'transform scale-90' : '',
                isMobile && mobileView === 'single' ? 'transform scale-95' : ''
              )}
              highlightTerm={highlightTerm}
              aiScore={candidate.aiScore}
              onSetAiTarget={onSetAiTarget}
              isAiTarget={aiTargetCandidate?.id === candidate.id}
              isSelectableForComparison={
                !!aiTargetCandidate &&
                aiTargetCandidate.profile.gender !== candidate.profile.gender &&
                aiTargetCandidate.id !== candidate.id
              }
              isSelectedForComparison={!!comparisonSelection[candidate.id]}
              onToggleComparison={onToggleComparison}
              dict={dict.candidatesManager.list.minimalCard} // <--- התיקון כאן
            />
            <button
              className="absolute top-2 left-2 bg-primary text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
              onClick={(e) => {
                e.stopPropagation();
                handleAction('edit', candidate);
              }}
              aria-label={dict.candidatesManager.list.editProfileTooltip}
              title={dict.candidatesManager.list.editProfileTooltip}
            >
              <Edit className="w-4 h-4" />
            </button>
          </div>
        ))}
      </div>

      {isQuickViewEnabled &&
        hoveredCandidate &&
        !isMobile && ( // <-- תנאי חדש
          <div
            ref={quickViewRef}
            className="absolute z-[70]"
            style={{
              top: `${hoverPosition.top}px`,
              left: `${hoverPosition.left}px`,
              width: '420px',
            }}
          >
            <div className="drop-shadow-2xl">
              {/********** תיקון #2: העברת המילון הנכון ל-QuickView **********/}
              <QuickView
                candidate={hoveredCandidate}
                // שורה מעודכנת
                onAction={(action) => handleAction(action, hoveredCandidate)}
                onSetAiTarget={(c, e) => onSetAiTarget(c, e)}
                isAiTarget={aiTargetCandidate?.id === hoveredCandidate.id}
                dict={dict.candidatesManager.list.quickView} // <--- התיקון כאן
              />
            </div>
          </div>
        )}

      <Dialog
        open={!!selectedCandidate}
        onOpenChange={(open) => {
          if (!open) {
            setSelectedCandidate(null);
            setQuestionnaireResponse(null);
          }
        }}
      >
        <DialogContent
          className="max-w-6xl max-h-[90vh] overflow-y-auto"
          dir={locale === 'he' ? 'rtl' : 'ltr'}
        >
          <DialogHeader>
            <div className="flex items-center justify-between">
              <DialogTitle>
                {dict.candidatesManager.list.profileDialog.title}
              </DialogTitle>
              <Button
                variant="outline"
                onClick={() => handleAction('edit', selectedCandidate!)}
                className="flex items-center gap-2"
              >
                <Edit className="w-4 h-4" />
                {dict.candidatesManager.list.profileDialog.editButton}
              </Button>
            </div>
            <DialogDescription>
              {dict.candidatesManager.list.profileDialog.description}
            </DialogDescription>
            <Select
              value={isMatchmaker ? 'matchmaker' : 'candidate'}
              onValueChange={(value) => setIsMatchmaker(value === 'matchmaker')}
            >
              <SelectTrigger className="w-full sm:w-48">
                <SelectValue
                  placeholder={
                    dict.candidatesManager.list.profileDialog.viewAsLabel
                  }
                />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="candidate">
                  {dict.candidatesManager.list.profileDialog.candidateView}
                </SelectItem>
                <SelectItem value="matchmaker">
                  {dict.candidatesManager.list.profileDialog.matchmakerView}
                </SelectItem>
              </SelectContent>
            </Select>
          </DialogHeader>
          {selectedCandidate && (
            <div className="space-y-6">
              <ProfileCard
                profile={selectedCandidate.profile}
                images={selectedCandidate.images}
                questionnaire={questionnaireResponse}
                viewMode={isMatchmaker ? 'matchmaker' : 'candidate'}
                isProfileComplete={selectedCandidate.isProfileComplete}
                dict={profileDict.profileCard}
                locale={locale}
              />
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/********** תיקון #3: העברת המילון הנכון ל-ActionDialogs **********/}
      <ActionDialogs
        suggestDialog={{
          isOpen: showSuggestDialog,
          onClose: () => setShowSuggestDialog(false),
          onSubmit: handleCreateSuggestion,
          selectedCandidate: dialogCandidate,
        }}
        availabilityDialog={{
          isOpen: showAvailabilityDialog,
          onClose: () => setShowAvailabilityDialog(false),
          onCheck: handleAvailabilityCheck,
          selectedCandidate: dialogCandidate,
        }}
        inviteDialog={{
          isOpen: showInviteDialog,
          onClose: () => setShowInviteDialog(false),
          onInvite: handleInvite,
          selectedCandidate: dialogCandidate,
        }}
        dict={dict.candidatesManager.actionDialogs} // <--- התיקון כאן
      />

      {/********** תיקון #4: העברת המילון הנכון ל-NewSuggestionForm **********/}
      <NewSuggestionForm
        isOpen={showSuggestDialog}
        onClose={() => setShowSuggestDialog(false)}
        candidates={allCandidates}
        selectedCandidate={dialogCandidate}
        onSubmit={handleCreateSuggestion}
        dict={dict} // <--- התיקון כאן
        locale={locale}
      />

      {/********** תיקון #5: העברת המילונים הנכונים ל-MatchmakerEditProfile **********/}
      <MatchmakerEditProfile
        isOpen={showEditProfileDialog}
        onClose={() => setShowEditProfileDialog(false)}
        candidate={dialogCandidate}
        dict={dict.candidatesManager.editProfile} // <--- התיקון כאן
        profileDict={profileDict}
        locale={locale}
      />
    </>
  );
};

export default CandidatesList;
--- End of Content for CandidatesList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesStats.tsx
--------------------------------------------------------------------------------
Content:
// /CandidatesManager/CandidatesStats.tsx

'use client';

import React from 'react';

import { Card, CardContent } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import {
  Users,
  UserCheck,
  Clock,
  MapPin,
  CheckCircle,
  Image as ImageIcon,
  TrendingUp,
  ArrowUp,
  ArrowDown,
  Activity,
  Heart,
  Star,
  Award,
  Sparkles,
  Target,
  Crown,
  Zap,
} from 'lucide-react';
import { useStatistics } from '../hooks/useStatistics';
import type { Candidate } from '../types/candidates';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface StatCardProps {
  title: string;
  value: string | number;
  description?: string;
  icon: React.ReactNode;
  trend?: {
    value: number;
    isPositive: boolean;
  };
  className?: string;
  gradient: string;
  iconColor: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats']['mainStats']['trend'];
}

interface CandidatesStatsProps {
  candidates: Candidate[];
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats'];
}

const CHART_COLORS = [
  '#3B82F6', // כחול
  '#EF4444', // אדום
  '#10B981', // ירוק
  '#F59E0B', // כתום
  '#8B5CF6', // סגול
  '#EC4899', // ורוד
  '#06B6D4', // ציאן
  '#84CC16', // ליים
];

const StatCard: React.FC<StatCardProps> = ({
  title,
  value,
  description,
  icon,
  trend,
  className,
  gradient,
  iconColor,
  dict,
}) => (
  <Card
    className={cn(
      'border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden group hover:shadow-2xl transition-all duration-300 transform hover:scale-105',
      className
    )}
  >
    <CardContent className="p-6 relative">
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl opacity-50"></div>

      <div className="flex items-start justify-between relative z-10">
        <div className="space-y-3 flex-1">
          <p className="text-sm font-medium text-gray-600">{title}</p>
          <div className="flex items-baseline gap-2">
            <p className="text-3xl font-bold text-gray-800">{value}</p>
            {trend && (
              <div
                className={cn(
                  'flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold',
                  trend.isPositive
                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-700'
                    : 'bg-gradient-to-r from-red-100 to-pink-100 text-red-700'
                )}
              >
                {trend.isPositive ? (
                  <ArrowUp className="w-3 h-3" />
                ) : (
                  <ArrowDown className="w-3 h-3" />
                )}
                <span>{Math.abs(trend.value)}%</span>
              </div>
            )}
          </div>
          {description && (
            <p className="text-sm text-gray-500 leading-relaxed">
              {description}
            </p>
          )}
          {trend && (
            <p className="text-xs text-gray-400">
              {trend.isPositive ? dict.increase : dict.decrease} {dict.period}
            </p>
          )}
        </div>

        <div
          className={cn(
            'p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform duration-300',
            `bg-gradient-to-r ${gradient}`
          )}
        >
          <div className={iconColor}>{icon}</div>
        </div>
      </div>
    </CardContent>
  </Card>
);

const EnhancedChartCard: React.FC<{
  title: string;
  children: React.ReactNode;
  description?: string;
  gradient?: string;
  icon?: React.ReactNode;
}> = ({
  title,
  children,
  description,
  gradient = 'from-blue-500 to-cyan-500',
  icon,
}) => (
  <Card className="border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden hover:shadow-2xl transition-all duration-300">
    <CardContent className="p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          {icon && (
            <div
              className={cn(
                'p-3 rounded-full shadow-lg',
                `bg-gradient-to-r ${gradient}`
              )}
            >
              <div className="text-white">{icon}</div>
            </div>
          )}
          <div>
            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
            {description && (
              <p className="text-sm text-gray-500 mt-1">{description}</p>
            )}
          </div>
        </div>
      </div>
      {children}
    </CardContent>
  </Card>
);

const CandidatesStats: React.FC<CandidatesStatsProps> = ({
  candidates,
  className,
  dict,
}) => {
  const {
    stats,
    getGenderRatio,
    getTopCities,
    getActiveUsersPercent,
    getAgeGroupDistribution,
    getReligiousDistribution,
    getActivityTrend,
    getProfileCompletionStats,
  } = useStatistics(candidates);

  const genderRatio = getGenderRatio();
  const activeUsers = getActiveUsersPercent();
  const completionStats = getProfileCompletionStats();
  const ageDistribution = getAgeGroupDistribution();
  const religiousDistribution = getReligiousDistribution();
  const activityTrend = getActivityTrend();
  const topCities = getTopCities(5);

  return (
    <div className={cn('space-y-8', className)}>
      <div className="relative min-h-[200px] bg-gradient-to-br from-purple-50 via-cyan-50/30 to-emerald-50/20 overflow-hidden rounded-3xl shadow-2xl p-8">
        <div className="absolute inset-0">
          <div className="absolute top-10 right-10 w-64 h-64 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-3xl animate-float"></div>
          <div
            className="absolute bottom-10 left-10 w-48 h-48 bg-gradient-to-br from-cyan-200/30 to-blue-200/30 rounded-full blur-2xl animate-float"
            style={{ animationDelay: '2s' }}
          ></div>
        </div>

        <div className="relative z-10 text-center">
          <div className="inline-flex items-center gap-3 mb-6">
            <div className="p-4 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
              <Activity className="w-10 h-10" />
            </div>
          </div>
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4">
            {dict.hero.title}
          </h1>
          <p className="text-xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
            {dict.hero.subtitle}
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title={dict.mainStats.total.title}
          value={stats.gender.total}
          icon={<Users className="w-8 h-8" />}
          description={dict.mainStats.total.description}
          gradient="from-blue-500 to-cyan-500"
          iconColor="text-white"
          trend={{ value: 12, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.ratio.title}
          value={genderRatio.formattedRatio}
          icon={<UserCheck className="w-8 h-8" />}
          description={dict.mainStats.ratio.description}
          gradient="from-purple-500 to-pink-500"
          iconColor="text-white"
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.activity.title}
          value={`${activeUsers}%`}
          icon={<Clock className="w-8 h-8" />}
          gradient="from-green-500 to-emerald-500"
          iconColor="text-white"
          trend={{ value: 8, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.completion.title}
          value={`${completionStats.percentage}%`}
          icon={<CheckCircle className="w-8 h-8" />}
          description={dict.mainStats.completion.description
            .replace('{{completed}}', completionStats.completed.toString())
            .replace('{{total}}', stats.gender.total.toString())}
          gradient="from-orange-500 to-amber-500"
          iconColor="text-white"
          trend={{ value: 5, isPositive: true }}
          dict={dict.mainStats.trend}
        />
      </div>

      <Tabs defaultValue="demographics" className="w-full">
        <TabsList className="bg-purple-50/50 rounded-2xl p-1.5 h-auto shadow-lg border border-white/50 grid w-full grid-cols-3">
          <TabsTrigger
            value="demographics"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Users className="w-5 h-5" />
            {dict.tabs.demographics}
          </TabsTrigger>
          <TabsTrigger
            value="activity"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Activity className="w-5 h-5" />
            {dict.tabs.activity}
          </TabsTrigger>
          <TabsTrigger
            value="completion"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Target className="w-5 h-5" />
            {dict.tabs.completion}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="demographics" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.ageDistribution.title}
              description={dict.charts.ageDistribution.description}
              gradient="from-blue-500 to-cyan-500"
              icon={<Users className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={ageDistribution}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                  <XAxis
                    dataKey="range"
                    tick={{ fontSize: 12 }}
                    stroke="#666"
                  />
                  <YAxis tick={{ fontSize: 12 }} stroke="#666" />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                  <Bar
                    dataKey="count"
                    fill="url(#blueGradient)"
                    radius={[4, 4, 0, 0]}
                  />
                  <defs>
                    <linearGradient
                      id="blueGradient"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.8} />
                      <stop
                        offset="95%"
                        stopColor="#06B6D4"
                        stopOpacity={0.6}
                      />
                    </linearGradient>
                  </defs>
                </BarChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.religiousDistribution.title}
              description={dict.charts.religiousDistribution.description}
              gradient="from-purple-500 to-pink-500"
              icon={<Heart className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={religiousDistribution}
                    dataKey="count"
                    nameKey="level"
                    cx="50%"
                    cy="50%"
                    outerRadius={100}
                    innerRadius={40}
                    paddingAngle={2}
                    label={({ name, percent }) =>
                      `${name} ${(percent * 100).toFixed(0)}%`
                    }
                  >
                    {religiousDistribution.map((_, index) => (
                      <Cell
                        key={`cell-${index}`}
                        fill={CHART_COLORS[index % CHART_COLORS.length]}
                      />
                    ))}
                  </Pie>
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.topCities.title}
              description={dict.charts.topCities.description}
              gradient="from-green-500 to-emerald-500"
              icon={<MapPin className="w-6 h-6" />}
            >
              <div className="space-y-4">
                {topCities.map((city, index) => (
                  <div
                    key={city.city}
                    className="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300"
                  >
                    <div className="flex items-center gap-3">
                      <div
                        className={cn(
                          'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg',
                          index === 0
                            ? 'bg-gradient-to-r from-yellow-400 to-orange-500'
                            : index === 1
                              ? 'bg-gradient-to-r from-gray-400 to-gray-500'
                              : index === 2
                                ? 'bg-gradient-to-r from-orange-400 to-red-500'
                                : 'bg-gradient-to-r from-green-400 to-emerald-500'
                        )}
                      >
                        {index + 1}
                      </div>
                      <div className="flex items-center gap-2">
                        <MapPin className="w-4 h-4 text-green-600" />
                        <span className="font-medium text-gray-800">
                          {city.city}
                        </span>
                      </div>
                    </div>
                    <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {city.count}
                    </Badge>
                  </div>
                ))}
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="activity" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.userActivity.title}
              description={dict.charts.userActivity.description}
              gradient="from-orange-500 to-amber-500"
              icon={<Activity className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-orange-800">
                        {dict.charts.userActivity.weeklyActive}
                      </span>
                      <TrendingUp className="w-4 h-4 text-orange-600" />
                    </div>
                    <span className="text-2xl font-bold text-orange-900">
                      {activityTrend.weekly}
                    </span>
                  </div>
                  <div className="p-4 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl border border-amber-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-amber-800">
                        {dict.charts.userActivity.monthlyActive}
                      </span>
                      <Activity className="w-4 h-4 text-amber-600" />
                    </div>
                    <span className="text-2xl font-bold text-amber-900">
                      {activityTrend.monthly}
                    </span>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-100">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-yellow-800">
                      {dict.charts.userActivity.avgLogin}
                    </span>
                    <Clock className="w-4 h-4 text-yellow-600" />
                  </div>
                  <span className="text-2xl font-bold text-yellow-900">
                    {activityTrend.average} {dict.charts.userActivity.days}
                  </span>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.activityTrend.title}
              description={dict.charts.activityTrend.description}
              gradient="from-indigo-500 to-purple-500"
              icon={<Star className="w-6 h-6" />}
            >
              <div className="flex items-center justify-center h-64 text-gray-500">
                <div className="text-center">
                  <Sparkles className="w-12 h-12 mx-auto mb-4 text-indigo-400" />
                  <p>{dict.charts.activityTrend.comingSoon}</p>
                  <p className="text-sm">
                    {dict.charts.activityTrend.subtitle}
                  </p>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="completion" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.profileCompletion.title}
              description={dict.charts.profileCompletion.description}
              gradient="from-red-500 to-pink-500"
              icon={<Target className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg">
                        <ImageIcon className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasPhotos}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasPhotos}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl border border-pink-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg">
                        <CheckCircle className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.isVerified}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-pink-500 to-rose-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.isVerified}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-rose-50 to-red-50 rounded-xl border border-rose-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-rose-500 to-red-500 text-white shadow-lg">
                        <Users className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasReferences}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-rose-500 to-red-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasReferences}%
                    </Badge>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.performance.title}
              description={dict.charts.performance.description}
              gradient="from-emerald-500 to-green-500"
              icon={<Award className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="text-center p-4 bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl border border-emerald-100">
                    <Crown className="w-8 h-8 mx-auto mb-2 text-emerald-600" />
                    <div className="text-2xl font-bold text-emerald-800">
                      A+
                    </div>
                    <div className="text-sm text-emerald-600">
                      {dict.charts.performance.qualityRating}
                    </div>
                  </div>
                  <div className="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                    <Zap className="w-8 h-8 mx-auto mb-2 text-green-600" />
                    <div className="text-2xl font-bold text-green-800">95%</div>
                    <div className="text-sm text-green-600">
                      {dict.charts.performance.satisfaction}
                    </div>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                  <div className="flex items-center justify-between mb-3">
                    <span className="font-medium text-blue-800">
                      {dict.charts.performance.monthlyProgress}
                    </span>
                    <TrendingUp className="w-4 h-4 text-blue-600" />
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.newCandidates}
                      </span>
                      <span className="font-bold text-blue-800">+12%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.activity}
                      </span>
                      <span className="font-bold text-blue-800">+8%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.profileCompletion}
                      </span>
                      <span className="font-bold text-blue-800">+5%</span>
                    </div>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default CandidatesStats;
--- End of Content for CandidatesStats.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\SplitView.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/SplitView.tsx
'use client';

import React, { useMemo, useEffect, useState } from 'react';
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from '@/components/ui/resizable';
import CandidatesList from './CandidatesList';
import { Badge } from '@/components/ui/badge';
import {
  Sparkles,
  XCircle,
  Target,
  Crown,
  Zap,
  Search,
  Loader2,
  Star,
  X,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card } from '@/components/ui/card';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { FilterState } from '../types/filters';
import SearchBar from '../Filters/SearchBar';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { Gender } from '@prisma/client';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { motion, AnimatePresence } from 'framer-motion';

// ============================================================================
// TYPES & INTERFACES
// ============================================================================

interface AiMatch {
  userId: string;
  score: number;
}

interface SplitViewProps {
  isQuickViewEnabled: boolean;
  maleCandidates: Candidate[];
  femaleCandidates: Candidate[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void;
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void;
  onCandidateAction: (type: CandidateAction, candidate: Candidate) => void;
  onCandidateClick: (candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  locale: string;
  aiTargetCandidate: Candidate | null;
  aiMatches: AiMatch[];
  isAiLoading: boolean;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  onClearAiTarget: (e: React.MouseEvent) => void;
  setAiMatches: React.Dispatch<React.SetStateAction<AiMatch[]>>;
  setIsAiLoading: React.Dispatch<React.SetStateAction<boolean>>;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  separateFiltering: boolean;
  maleFilters?: Partial<FilterState>;
  femaleFilters?: Partial<FilterState>;
  onMaleFiltersChange: (filters: Partial<FilterState>) => void;
  onFemaleFiltersChange: (filters: Partial<FilterState>) => void;
  onCopyFilters: (source: 'male' | 'female', target: 'male' | 'female') => void;
  maleSearchQuery?: string;
  femaleSearchQuery?: string;
  onMaleSearchChange?: (query: string) => void;
  onFemaleSearchChange?: (query: string) => void;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

// ============================================================================
// HELPER COMPONENTS
// ============================================================================

/**
 * דגש 1: קומפוננטת כותרת פאנל משופרת עם אנימציות ומצבי UI שונים
 */
const PanelHeaderComponent: React.FC<{
  gender: 'male' | 'female';
  count: number;
  aiTargetCandidate: Candidate | null;
  isSearchPanel: boolean;
  isTargetPanel: boolean;
  onClearAiTarget: (e: React.MouseEvent) => void;
  onFindAiMatches: (e: React.MouseEvent) => void;
  isAiLoading: boolean;
  isMobileView?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['splitView']['panelHeaders'];
}> = ({
  gender,
  count,
  aiTargetCandidate,
  isSearchPanel,
  isTargetPanel,
  onClearAiTarget,
  onFindAiMatches,
  isAiLoading,
  isMobileView = false,
  dict,
}) => {
  const genderConfig = {
    male: {
      title: dict.male.title,
      subtitle: dict.male.subtitle.replace('{{count}}', count.toString()),
      icon: Target,
      colors: {
        gradient: 'from-blue-500 to-cyan-500',
        bg: 'from-blue-50 to-cyan-50',
        text: 'text-blue-800',
        badge: 'bg-blue-500',
      },
    },
    female: {
      title: dict.female.title,
      subtitle: dict.female.subtitle.replace('{{count}}', count.toString()),
      icon: Crown,
      colors: {
        gradient: 'from-purple-500 to-pink-500',
        bg: 'from-purple-50 to-pink-50',
        text: 'text-purple-800',
        badge: 'bg-purple-500',
      },
    },
  };

  const config = genderConfig[gender];
  const IconComponent = config.icon;

  return (
    <div
      className={cn(
        'flex justify-between items-center p-4 rounded-t-2xl',
        !isMobileView &&
          `bg-gradient-to-r ${config.colors.bg} border-b border-gray-100/50`
      )}
    >
      <div className="flex items-center gap-3">
        <motion.div
          whileHover={{ scale: 1.1, rotate: 5 }}
          className={cn(
            'p-3 rounded-full shadow-lg text-white transition-transform',
            `bg-gradient-to-r ${config.colors.gradient}`
          )}
        >
          <IconComponent className="w-6 h-6" />
        </motion.div>
        <div>
          <h2 className={cn('text-xl font-bold', config.colors.text)}>
            {config.title}
          </h2>
          <p className="text-sm text-gray-600">{config.subtitle}</p>
        </div>
        <Badge
          className={cn(
            'text-white border-0 shadow-lg px-3 py-1 font-bold',
            config.colors.badge
          )}
        >
          {count}
        </Badge>
      </div>

      {/* דגש 2: תצוגת סטטוס AI מתקדמת */}
      <div className="flex items-center gap-2">
        {isTargetPanel && aiTargetCandidate && (
          <motion.div
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0, opacity: 0 }}
            className="flex items-center gap-2 bg-green-100 p-2 rounded-full shadow-lg"
          >
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
            <span className="text-sm font-medium text-green-800 px-2">
              {dict.targetLabel.replace('{{name}}', aiTargetCandidate.firstName)}
            </span>
            <Button
              size="icon"
              variant="ghost"
              className="h-6 w-6 text-green-700 hover:bg-green-200 rounded-full"
              onClick={onClearAiTarget}
            >
              <XCircle className="h-4 w-4" />
            </Button>
          </motion.div>
        )}

        {isSearchPanel && (
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            <Button
              size="sm"
              onClick={onFindAiMatches}
              disabled={isAiLoading}
              className={cn(
                'relative overflow-hidden shadow-lg font-bold transition-all duration-300',
                `bg-gradient-to-r ${config.colors.gradient} hover:opacity-90 text-white`,
                'disabled:opacity-50 disabled:cursor-not-allowed'
              )}
            >
              <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700" />
              <Sparkles
                className={cn('ml-2 h-4 w-4 relative z-10', isAiLoading && 'animate-spin')}
              />
              <span className="relative z-10">
                {isAiLoading ? dict.searchingButton : dict.findMatchesButton}
              </span>
              {!isAiLoading && <Zap className="w-3 h-3 mr-1 relative z-10" />}
            </Button>
          </motion.div>
        )}
      </div>
    </div>
  );
};

/**
 * דגש 3: קומפוננטת טעינה אלגנטית עם אנימציות
 */
const LoadingComponent: React.FC<{ gender: 'male' | 'female' }> = ({ gender }) => {
  const config =
    gender === 'male'
      ? {
          gradient: 'from-blue-200 to-cyan-200',
          icon: Target,
          title: 'טוען מועמדים...',
          subtitle: 'אנא המתן בזמן שאנו מביאים את הנתונים',
        }
      : {
          gradient: 'from-purple-200 to-pink-200',
          icon: Crown,
          title: 'טוענת מועמדות...',
          subtitle: 'אנא המתיני בזמן שאנו מביאות את הנתונים',
        };

  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <motion.div
        animate={{
          scale: [1, 1.2, 1],
          rotate: [0, 360],
        }}
        transition={{
          duration: 2,
          repeat: Infinity,
          ease: 'easeInOut',
        }}
        className={cn('p-6 rounded-full mb-4', `bg-gradient-to-r ${config.gradient}`)}
      >
        <IconComponent className="w-12 h-12 text-white" />
      </motion.div>
      <div className="text-center">
        <h3 className="text-lg font-bold text-gray-700 mb-2">{config.title}</h3>
        <p className="text-gray-500">{config.subtitle}</p>
      </div>
    </motion.div>
  );
};

/**
 * דגש 4: קומפוננטת מצב ריק משופרת עם הצעות פעולה
 */
const EmptyStateComponent: React.FC<{
  gender: 'male' | 'female';
  searchQuery?: string;
  onClearSearch?: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['emptyState'];
}> = ({ gender, searchQuery, onClearSearch, dict }) => {
  const config =
    gender === 'male'
      ? { gradient: 'from-blue-100 to-cyan-100', icon: Target }
      : { gradient: 'from-purple-100 to-pink-100', icon: Crown };

  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <div
        className={cn(
          'w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-lg',
          `bg-gradient-to-br ${config.gradient}`
        )}
      >
        <IconComponent className="w-12 h-12 text-gray-400" />
      </div>
      <h3 className="text-xl font-bold text-gray-800 mb-2">{dict.title}</h3>
      <p className="text-gray-600 text-center mb-4 max-w-sm">
        {searchQuery
          ? `לא נמצאו תוצאות עבור "${searchQuery}"`
          : dict.description}
      </p>
      {searchQuery && onClearSearch && (
        <Button
          variant="outline"
          onClick={onClearSearch}
          className="border-2 border-gray-300 hover:border-gray-400"
        >
          <Search className="w-4 h-4 ml-2" />
          נקה חיפוש
        </Button>
      )}
    </motion.div>
  );
};



// ============================================================================
// MAIN COMPONENT
// ============================================================================

const SplitView: React.FC<SplitViewProps> = ({
  dict,
  onOpenAiAnalysis,
  onSendProfileFeedback,
  profileDict,
  isQuickViewEnabled,
  locale,
  ...props
}) => {
  const {
    maleCandidates,
    femaleCandidates,
    allCandidates,
    onCandidateAction,
    onCandidateClick,
    viewMode,
    mobileView,
    isLoading = false,
    className,
    maleSearchQuery = '',
    femaleSearchQuery = '',
    onMaleSearchChange,
    onFemaleSearchChange,
    aiTargetCandidate,
    aiMatches,
    isAiLoading,
    onSetAiTarget,
    onClearAiTarget,
    setAiMatches,
    setIsAiLoading,
    comparisonSelection,
    onToggleComparison,
    separateFiltering,
  } = props;

  const [isMobile, setIsMobile] = useState(false);

  // דגש 6: זיהוי רספונסיבי משופר
  useEffect(() => {
    const checkScreenSize = () => setIsMobile(window.innerWidth < 768);
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => window.removeEventListener('resize', checkScreenSize);
  }, []);

  /**
   * דגש 7: לוגיקת חיפוש AI מרוכזת ומשופרת עם טיפול בשגיאות
   */
  const handleFindAiMatches = async (e: React.MouseEvent) => {
    e.stopPropagation();
    
    if (!aiTargetCandidate) {
      toast.error('אנא בחר מועמד/ת מטרה תחילה', {
        position: 'top-center',
        icon: '⚠️',
      });
      return;
    }

    setIsAiLoading(true);
    setAiMatches([]);

    const targetGender = aiTargetCandidate.profile.gender;
    const candidatePool = targetGender === Gender.MALE ? femaleCandidates : maleCandidates;
    const candidatePoolIds = candidatePool.map((c) => c.id);

    if (candidatePoolIds.length === 0) {
      toast.error('אין מועמדים במאגר לחיפוש התאמות.', {
        position: 'top-center',
        description: 'נסה לשנות את הפילטרים או להוסיף מועמדים נוספים',
      });
      setIsAiLoading(false);
      return;
    }

    try {
      const response = await fetch('/api/ai/find-matches', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetUserId: aiTargetCandidate.id,
          candidatePoolIds,
        }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to fetch AI matches');
      }

      setAiMatches(data.matches);
      
      toast.success(`נמצאו ${data.matches.length} התאמות AI פוטנציאליות! 🎉`, {
        position: 'top-center',
        description: 'המועמדים הממולצים מסומנים ומיוינו לראש הרשימה.',
        duration: 5000,
      });
    } catch (error) {
      console.error('Error finding AI matches:', error);
      toast.error('שגיאה במציאת התאמות AI.', {
        description: error instanceof Error ? error.message : 'נסה שוב מאוחר יותר.',
      });
    } finally {
      setIsAiLoading(false);
    }
  };

  /**
   * דגש 8: ציון מועמדים עם ניקוד AI
   */
  const maleCandidatesWithScores = useMemo(() => {
    if (aiMatches.length === 0) return maleCandidates;
    const scoreMap = new Map(aiMatches.map((m) => [m.userId, m.score]));
    return maleCandidates
      .map((c) => ({ ...c, aiScore: scoreMap.get(c.id) }))
      .sort((a, b) => (b.aiScore ?? -1) - (a.aiScore ?? -1));
  }, [maleCandidates, aiMatches]);

  const femaleCandidatesWithScores = useMemo(() => {
    if (aiMatches.length === 0) return femaleCandidates;
    const scoreMap = new Map(aiMatches.map((m) => [m.userId, m.score]));
    return femaleCandidates
      .map((c) => ({ ...c, aiScore: scoreMap.get(c.id) }))
      .sort((a, b) => (b.aiScore ?? -1) - (a.aiScore ?? -1));
  }, [femaleCandidates, aiMatches]);

  const renderPanelHeader = (gender: 'male' | 'female', isMobileView: boolean = false) => {
    const panelGenderEnum = gender === 'male' ? Gender.MALE : Gender.FEMALE;
    const isTargetPanel = aiTargetCandidate?.profile.gender === panelGenderEnum;
    const isSearchPanel = !!(aiTargetCandidate && aiTargetCandidate.profile.gender !== panelGenderEnum);
    const count = gender === 'male' ? maleCandidates.length : femaleCandidates.length;

    return (
      <PanelHeaderComponent
        gender={gender}
        count={count}
        aiTargetCandidate={aiTargetCandidate}
        isSearchPanel={isSearchPanel}
        isTargetPanel={isTargetPanel}
        onClearAiTarget={onClearAiTarget}
        onFindAiMatches={handleFindAiMatches}
        isAiLoading={isAiLoading}
        isMobileView={isMobileView}
        dict={dict.candidatesManager.splitView.panelHeaders}
      />
    );
  };

  const renderCandidatesListForMobile = (
    candidates: (Candidate & { aiScore?: number })[],
    gender: 'male' | 'female',
    searchQuery: string,
    onSearchChange?: (query: string) => void
  ) => {
    if (isLoading) {
      return <LoadingComponent gender={gender} />;
    }
    if (candidates.length === 0) {
      return (
        <EmptyStateComponent
          gender={gender}
          searchQuery={searchQuery}
          onClearSearch={() => onSearchChange?.('')}
          dict={dict.candidatesManager.list.emptyState}
        />
      );
    }
    return (
      <CandidatesList
        candidates={candidates}
        allCandidates={allCandidates}
        onOpenAiAnalysis={onOpenAiAnalysis}
        onCandidateClick={onCandidateClick}
        onSendProfileFeedback={onSendProfileFeedback}
        onCandidateAction={onCandidateAction}
        viewMode={viewMode}
        mobileView={mobileView}
        isLoading={isLoading}
        highlightTerm={searchQuery}
        aiTargetCandidate={aiTargetCandidate}
        onSetAiTarget={onSetAiTarget}
        comparisonSelection={comparisonSelection}
        onToggleComparison={onToggleComparison}
        isQuickViewEnabled={isQuickViewEnabled}
        dict={dict}
        profileDict={profileDict}
        locale={locale}
      />
    );
  };

  // ============================================================================
  // MOBILE VIEW RENDERING
  // ============================================================================

  /**
   * דגש 9: תצוגת מובייל מתקדמת עם UI/UX משופר
   */
  if (isMobile) {
    // Split view for mobile
    if (mobileView === 'split') {
      return (
        <div className="grid grid-cols-2 gap-3 h-full p-3">
          <Card className="flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-blue-50/30 overflow-hidden rounded-2xl">
            <div className="p-3 text-center bg-gradient-to-r from-blue-500 to-cyan-500 text-white">
              <h2 className="text-sm font-bold flex items-center justify-center gap-1">
                <Target className="w-4 h-4" />
                {dict.candidatesManager.splitView.mobile.splitLabels.male}
                <Badge variant="secondary" className="bg-white/20 text-white border-0 ml-1">
                  {maleCandidates.length}
                </Badge>
              </h2>
            </div>
            <div className="flex-grow min-h-0 overflow-y-auto p-2">
              {renderCandidatesListForMobile(
                maleCandidatesWithScores,
                'male',
                maleSearchQuery,
                onMaleSearchChange
              )}
            </div>
          </Card>

          <Card className="flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-purple-50/30 overflow-hidden rounded-2xl">
            <div className="p-3 text-center bg-gradient-to-r from-purple-500 to-pink-500 text-white">
              <h2 className="text-sm font-bold flex items-center justify-center gap-1">
                <Crown className="w-4 h-4" />
                {dict.candidatesManager.splitView.mobile.splitLabels.female}
                <Badge variant="secondary" className="bg-white/20 text-white border-0 ml-1">
                  {femaleCandidates.length}
                </Badge>
              </h2>
            </div>
            <div className="flex-grow min-h-0 overflow-y-auto p-2">
              {renderCandidatesListForMobile(
                femaleCandidatesWithScores,
                'female',
                femaleSearchQuery,
                onFemaleSearchChange
              )}
            </div>
          </Card>
        </div>
      );
    }

    // Tabs view for mobile
    return (
      <div className={cn('w-full h-full', className)}>
        <Tabs defaultValue="male" className="w-full h-full flex flex-col">
          {/* דגש 10: באנר סטטוס AI גלובלי למובייל */}
          <AnimatePresence>
            {aiTargetCandidate && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="flex-shrink-0 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-200 p-3 shadow-sm"
              >
                <div className="flex items-center gap-2">
                  <div className="p-2 rounded-full bg-green-500 shadow-lg">
                    <Star className="w-4 h-4 text-white fill-current" />
                  </div>
                  <div className="flex-1">
                    <p className="text-sm font-bold text-green-900">
                      מטרה נבחרה: {aiTargetCandidate.firstName} {aiTargetCandidate.lastName}
                    </p>
                    <p className="text-xs text-green-600">
                      {aiTargetCandidate.profile.gender === 'MALE' ? '👨 גברים' : '👩 נשים'} •{' '}
                      {aiTargetCandidate.profile.city || 'לא צוין'}
                    </p>
                  </div>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={onClearAiTarget}
                    className="h-8 w-8 rounded-full hover:bg-white/50"
                  >
                    <X className="w-4 h-4 text-green-600" />
                  </Button>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          <TabsList className="grid w-full grid-cols-2 flex-shrink-0 bg-gradient-to-r from-indigo-50 to-purple-50 p-1 rounded-2xl shadow-lg">
            <TabsTrigger
              value="male"
              className="flex items-center gap-2 rounded-xl data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-lg transition-all duration-300"
            >
              <Target className="h-4 w-4" />
              {dict.candidatesManager.splitView.mobile.tabs.male}
              <Badge variant="secondary" className="bg-blue-100 text-blue-800 border-0">
                {maleCandidates.length}
              </Badge>
            </TabsTrigger>
            <TabsTrigger
              value="female"
              className="flex items-center gap-2 rounded-xl data-[state=active]:bg-gradient-to-r data-[state=active]:from-purple-500 data-[state=active]:to-pink-500 data-[state=active]:text-white data-[state=active]:shadow-lg transition-all duration-300"
            >
              <Crown className="h-4 w-4" />
              {dict.candidatesManager.splitView.mobile.tabs.female}
              <Badge variant="secondary" className="bg-purple-100 text-purple-800 border-0">
                {femaleCandidates.length}
              </Badge>
            </TabsTrigger>
          </TabsList>

          {/* Male Tab Content */}
          <TabsContent value="male" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-blue-50/30 rounded-2xl">
              {/* AI Action Button for Male Tab */}
              {aiTargetCandidate && aiTargetCandidate.profile.gender === 'FEMALE' && (
                <motion.div
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="mb-4"
                >
                  <Button
                    onClick={handleFindAiMatches}
                    disabled={isAiLoading}
                    className="w-full h-12 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 text-white shadow-lg font-bold rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 disabled:scale-100 relative overflow-hidden group"
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700" />
                    {isAiLoading ? (
                      <>
                        <Loader2 className="w-5 h-5 animate-spin ml-2 relative z-10" />
                        <span className="relative z-10">מחפש התאמות AI...</span>
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-5 h-5 ml-2 relative z-10" />
                        <span className="relative z-10">מצא התאמות AI ({maleCandidates.length})</span>
                        <Zap className="w-4 h-4 mr-2 relative z-10" />
                      </>
                    )}
                  </Button>
                </motion.div>
              )}

            
              {/* Search Bar */}
              {separateFiltering && onMaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={maleSearchQuery}
                    onChange={onMaleSearchChange}
                    placeholder={dict.candidatesManager.searchBar.malePlaceholder}
                    genderTarget="male"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}

              {/* Candidates List */}
              <div className="flex-grow min-h-0 overflow-y-auto">
                {renderCandidatesListForMobile(
                  maleCandidatesWithScores,
                  'male',
                  maleSearchQuery,
                  onMaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>

          {/* Female Tab Content */}
          <TabsContent value="female" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-purple-50/30 rounded-2xl">
              {/* AI Action Button for Female Tab */}
              {aiTargetCandidate && aiTargetCandidate.profile.gender === 'MALE' && (
                <motion.div
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="mb-4"
                >
                  <Button
                    onClick={handleFindAiMatches}
                    disabled={isAiLoading}
                    className="w-full h-12 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-gray-400 disabled:to-gray-500 text-white shadow-lg font-bold rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 disabled:scale-100 relative overflow-hidden group"
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700" />
                    {isAiLoading ? (
                      <>
                        <Loader2 className="w-5 h-5 animate-spin ml-2 relative z-10" />
                        <span className="relative z-10">מחפש התאמות AI...</span>
                      </>
                    ) : (
                      <>
                        <Sparkles className="w-5 h-5 ml-2 relative z-10" />
                        <span className="relative z-10">מצא התאמות AI ({femaleCandidates.length})</span>
                        <Zap className="w-4 h-4 mr-2 relative z-10" />
                      </>
                    )}
                  </Button>
                </motion.div>
              )}

              {/* Search Bar */}
              {separateFiltering && onFemaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={femaleSearchQuery}
                    onChange={onFemaleSearchChange}
                    placeholder={dict.candidatesManager.searchBar.femalePlaceholder}
                    genderTarget="female"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}

              {/* Candidates List */}
              <div className="flex-grow min-h-0 overflow-y-auto">
                {renderCandidatesListForMobile(
                  femaleCandidatesWithScores,
                  'female',
                  femaleSearchQuery,
                  onFemaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    );
  }

  // ============================================================================
  // DESKTOP VIEW RENDERING
  // ============================================================================

  return (
    <div className={cn('h-full', className)}>
      <ResizablePanelGroup
        direction="horizontal"
        className="h-full rounded-2xl bg-white shadow-2xl border-0 overflow-hidden"
      >
        {/* Male Panel */}
        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-blue-50/20">
            {renderPanelHeader('male')}

            {/* Search Bar */}
            {separateFiltering && onMaleSearchChange && (
              <div className="p-4 bg-blue-50/30 w-full">
                <SearchBar
                  value={maleSearchQuery}
                  onChange={onMaleSearchChange}
                  placeholder={dict.candidatesManager.searchBar.malePlaceholder}
                  genderTarget="male"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}

        

            {/* Candidates List */}
            <div className="flex-grow min-h-0 overflow-y-auto p-4">
              <CandidatesList
                candidates={maleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={maleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="right"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>

        {/* Resizable Handle */}
        <ResizableHandle
          withHandle
          className="bg-gradient-to-b from-indigo-300 to-purple-300 hover:from-indigo-400 hover:to-purple-400 transition-colors w-2"
        />

        {/* Female Panel */}
        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-purple-50/20">
            {renderPanelHeader('female')}

            {/* Search Bar */}
            {separateFiltering && onFemaleSearchChange && (
              <div className="p-4 bg-purple-50/30 w-full">
                <SearchBar
                  value={femaleSearchQuery}
                  onChange={onFemaleSearchChange}
                  placeholder={dict.candidatesManager.searchBar.femalePlaceholder}
                  genderTarget="female"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}


            {/* Candidates List */}
            <div className="flex-grow min-h-0 overflow-y-auto p-4">
              <CandidatesList
                candidates={femaleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={femaleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="left"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>
      </ResizablePanelGroup>
    </div>
  );
};

export default SplitView;
--- End of Content for SplitView.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\StatsCard.tsx
--------------------------------------------------------------------------------
Content:
"use client";

import React from "react";

import { Card } from "@/components/ui/card";
import { cn } from "@/lib/utils";

interface StatsCardProps {
  icon: React.ElementType;
  title: string;
  value: string | number;
  trend?: {
    value: number;
    label: string;
    isPositive?: boolean;
  };
  variant?: "default" | "success" | "warning" | "destructive";
  bgGradient?: string;
  iconColor?: string;
  className?: string;
}

const StatsCard: React.FC<StatsCardProps> = ({
  icon: Icon,
  title,
  value,
  trend,
  variant = "default",
  bgGradient,
  iconColor = "text-primary",
  className,
}) => {
  const getVariantStyles = () => {
    switch (variant) {
      case "success":
        return "border-emerald-200";
      case "warning":
        return "border-amber-200";
      case "destructive":
        return "border-red-200";
      default:
        return "border-gray-200";
    }
  };

  return (
    <Card
      className={cn(
        "hover:shadow-md transition-all duration-300 p-4 overflow-hidden",
        bgGradient ? `bg-gradient-to-br ${bgGradient}` : "bg-card",
        getVariantStyles(),
        className
      )}
    >
      <div className="flex items-start justify-between">
        <div className="mr-4 flex-shrink-0">
          <div className={`p-2.5 rounded-full bg-white/60 backdrop-blur-sm shadow-sm`}>
            <Icon className={`w-4 h-4 ${iconColor}`} />
          </div>
        </div>

        <div className="flex-1 text-right">
          <p className="text-xs text-muted-foreground mb-1">{title}</p>
          <h3 className="text-xl font-bold">{value}</h3>

          {trend && (
            <div className="flex items-center justify-end gap-1 mt-1">
              <span
                className={cn(
                  "text-sm font-medium flex items-center gap-0.5",
                  trend.isPositive ? "text-emerald-600" : "text-red-600"
                )}
              >
                {trend.isPositive ? "+" : "-"}{trend.value}%
                <span className={`${trend.isPositive ? "rotate-0" : "rotate-180"} transition-transform`}>
                  ↑
                </span>
              </span>
              <span className="text-[11px] text-muted-foreground">
                {trend.label}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Animated background pattern for more visual appeal */}
      <div className="absolute right-0 bottom-0 opacity-10 pointer-events-none">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="60" cy="60" r="40" fill="currentColor" />
        </svg>
      </div>
    </Card>
  );
};

export default StatsCard;
--- End of Content for StatsCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\index.tsx
--------------------------------------------------------------------------------
Content:
// File: src/app/components/matchmaker/new/CandidatesManager/index.tsx

'use client';

// --- React & Next.js Imports ---
import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { ProfileFeedbackDialog } from '../dialogs/ProfileFeedbackDialog';
import { useSession } from 'next-auth/react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import { AiMatchmakerProfileAdvisorDialog } from '../dialogs/AiMatchmakerProfileAdvisorDialog';
// --- Third-party Libraries ---
import {
  UserPlus,
  Filter,
  LayoutGrid,
  List,
  ArrowUpDown,
  RotateCw,

  Bot,
  Loader2,
  Columns,
  View,
  Users,
  Sparkles,
  TrendingUp,
  TrendingDown,
  Eye, // הוספת אייקון
  EyeOff, // הוספת אייקון
  GitCompare, // <--- הוסף את זה
  X,
} from 'lucide-react';
import { toast } from 'sonner';
import { useParams } from 'next/navigation';

import Image from 'next/image'; // <--- הוסף את השורה הזו
import { motion, AnimatePresence } from 'framer-motion'; // <--- הוסף את השורה הזו

// --- UI Components ---
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';

// --- Custom Hooks ---
import { useCandidates } from '../hooks/useCandidates';
import { useFilterLogic } from '../hooks/useFilterLogic';

// --- Internal Components ---
import SplitView from './SplitView';
import FilterPanel from '../Filters/FilterPanel';
import ActiveFilters from '../Filters/ActiveFilters';
import SearchBar from '../Filters/SearchBar';
import { LoadingContainer } from '../shared/LoadingStates';
import { AddManualCandidateDialog } from '../dialogs/AddManualCandidateDialog';
import { AiMatchAnalysisDialog } from '../dialogs/AiMatchAnalysisDialog';

// --- Types, Constants & Utils ---
import type {
  Candidate,
  ViewMode,
  CandidatesFilter,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import { SORT_OPTIONS, VIEW_OPTIONS } from '../constants/filterOptions';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';

// --- Local Types ---
interface AiMatch {
  userId: string;
  score: number;
}

// ============================================================================
// Minimal Compact Header Component
// ============================================================================
const MinimalHeader: React.FC<{
  stats: {
    total: number;
    male: number;
    female: number;
    verified: number;
    activeToday: number;
    profilesComplete: number;
  };
  onAddCandidate: () => void;
  onRefresh: () => void;
  isRefreshing: boolean;
  onBulkUpdate?: () => void;
  isBulkUpdating?: boolean;
  isAdmin?: boolean;
  isCompact: boolean;
  onToggleCompact: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['header'];
}> = ({
  stats,
  onAddCandidate,
  onRefresh,
  isRefreshing,
  onBulkUpdate,
  isBulkUpdating,
  isAdmin,
  isCompact,
  onToggleCompact,
  dict,
}) => {
  return (
    <header
      className={cn(
        'sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm transition-all duration-300',
        isCompact ? 'h-16' : 'h-32'
      )}
    >
      <div className="container mx-auto px-6 h-full">
        {isCompact ? (
          // --- COMPACT MODE ---
          <div className="flex items-center justify-between h-full">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <div className="p-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                  <Users className="w-4 h-4" />
                </div>
                <h1 className="text-lg font-bold text-gray-800">
                  {dict.title}
                </h1>
              </div>
              <div className="hidden md:flex items-center gap-2">
                <Badge
                  variant="outline"
                  className="bg-blue-50 text-blue-700 border-blue-200"
                >
                  {stats.total} {dict.totalLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-emerald-50 text-emerald-700 border-emerald-200"
                >
                  {stats.verified} {dict.verifiedLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-orange-50 text-orange-700 border-orange-200"
                >
                  {stats.profilesComplete}
                  {dict.profilesCompleteLabel}
                </Badge>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button
                onClick={onAddCandidate}
                size="sm"
                className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-md"
              >
                <UserPlus className="w-4 h-4 ml-1" />
                {dict.addButton}
              </Button>
              <Button
                onClick={onRefresh}
                variant="outline"
                size="sm"
                disabled={isRefreshing}
                className="border-gray-300 hover:bg-gray-50"
              >
                <RotateCw
                  className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                />
              </Button>
              {isAdmin && onBulkUpdate && (
                <Button
                  onClick={onBulkUpdate}
                  variant="secondary"
                  size="sm"
                  disabled={isBulkUpdating}
                  className="bg-amber-500 hover:bg-amber-600 text-white"
                >
                  {isBulkUpdating ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Bot className="w-4 h-4" />
                  )}
                </Button>
              )}
              <Button
                onClick={onToggleCompact}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
                title={dict.expandTooltip}
              >
                <TrendingUp className="w-4 h-4" />
              </Button>
            </div>
          </div>
        ) : (
          // --- EXPANDED MODE ---
          <div className="flex flex-col justify-center h-full py-3">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                  <Users className="w-5 h-5" />
                </div>
                <div>
                  <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    {dict.advancedTitle}
                  </h1>
                  <p className="text-sm text-gray-600">
                    {dict.advancedSubtitle}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  onClick={onAddCandidate}
                  size="sm"
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg"
                >
                  <UserPlus className="w-4 h-4 ml-2" />
                  {dict.addCandidateButton}
                  <Sparkles className="w-3 h-3 mr-1" />
                </Button>
                <Button
                  onClick={onRefresh}
                  variant="outline"
                  size="sm"
                  disabled={isRefreshing}
                  className="border-indigo-300 text-indigo-600 hover:bg-indigo-50"
                >
                  <RotateCw
                    className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                  />
                </Button>
                {isAdmin && onBulkUpdate && (
                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button
                        variant="secondary"
                        size="sm"
                        disabled={isBulkUpdating}
                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white"
                      >
                        {isBulkUpdating ? (
                          <Loader2 className="w-4 h-4 animate-spin" />
                        ) : (
                          <Bot className="w-4 h-4" />
                        )}
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent dir="rtl">
                      <AlertDialogHeader>
                        <AlertDialogTitle>
                          {dict.bulkUpdateDialog.title}
                        </AlertDialogTitle>
                        <AlertDialogDescription>
                          {dict.bulkUpdateDialog.description}
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel>
                          {dict.bulkUpdateDialog.cancel}
                        </AlertDialogCancel>
                        <AlertDialogAction onClick={onBulkUpdate}>
                          {dict.bulkUpdateDialog.confirm}
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                )}
                <Button
                  onClick={onToggleCompact}
                  variant="ghost"
                  size="sm"
                  className="text-gray-500 hover:text-gray-700"
                  title={dict.collapseTooltip}
                >
                  <TrendingDown className="w-4 h-4" />
                </Button>
              </div>
            </div>
            <div className="grid grid-cols-6 gap-3">
              <div className="text-center bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-blue-100">
                <div className="text-lg font-bold text-blue-700">
                  {stats.total}
                </div>
                <div className="text-xs text-blue-600">{dict.stats.total}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-2 shadow-sm border border-indigo-100">
                <div className="text-lg font-bold text-indigo-700">
                  {stats.male}
                </div>
                <div className="text-xs text-indigo-600">{dict.stats.male}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-2 shadow-sm border border-purple-100">
                <div className="text-lg font-bold text-purple-700">
                  {stats.female}
                </div>
                <div className="text-xs text-purple-600">
                  {dict.stats.female}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-2 shadow-sm border border-emerald-100">
                <div className="text-lg font-bold text-emerald-700">
                  {stats.verified}
                </div>
                <div className="text-xs text-emerald-600">
                  {dict.stats.verified}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-2 shadow-sm border border-orange-100">
                <div className="text-lg font-bold text-orange-700">
                  {stats.activeToday}
                </div>
                <div className="text-xs text-orange-600">
                  {dict.stats.active}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-teal-100">
                <div className="text-lg font-bold text-teal-700">
                  {stats.profilesComplete}%
                </div>
                <div className="text-xs text-teal-600">
                  {dict.stats.complete}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </header>
  );
};

// ============================================================================
// Main Candidates Manager Component
// ============================================================================
interface CandidatesManagerProps {
  matchmakerDict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
  locale: string;
}

const CandidatesManager: React.FC<CandidatesManagerProps> = ({
  matchmakerDict,
  profileDict,
  locale,
}) => {
  // --- State Management ---
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [mobileView, setMobileView] = useState<MobileView>('double');
  const [isMobile, setIsMobile] = useState(false);
  const [showFiltersPanel, setShowFiltersPanel] = useState(false);
  const [showFiltersMobile, setShowFiltersMobile] = useState(false);
  const [showManualAddDialog, setShowManualAddDialog] = useState(false);
  const [isHeaderCompact, setIsHeaderCompact] = useState(true);
  const [isQuickViewEnabled, setIsQuickViewEnabled] = useState(false); // <-- הוספת state חדש

  // --- AI State ---
  const [aiTargetCandidate, setAiTargetCandidate] = useState<Candidate | null>(
    null
  );
  const [comparisonSelection, setComparisonSelection] = useState<
    Record<string, Candidate>
  >({});
  const [aiMatches, setAiMatches] = useState<AiMatch[]>([]);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isAnalysisDialogOpen, setIsAnalysisDialogOpen] = useState(false);
  const [isBulkUpdating, setIsBulkUpdating] = useState(false);
  const [feedbackCandidate, setFeedbackCandidate] = useState<Candidate | null>(
    null
  );
  // --- Session & Permissions ---
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === 'ADMIN';
  const [analyzedCandidate, setAnalyzedCandidate] = useState<Candidate | null>(
    null
  );

  const handleOpenAiAnalysis = useCallback((candidate: Candidate) => {
    setAnalyzedCandidate(candidate);
  }, []);
  const handleOpenProfileFeedback = useCallback((candidate: Candidate) => {
    setFeedbackCandidate(candidate);
  }, []);

  const handleCloseAiAnalysis = () => {
    setAnalyzedCandidate(null);
  };
  // --- Custom Hooks ---
  const {
    loading,
    candidates,
    maleCandidates,
    femaleCandidates,
    setSorting,
    setFilters: setCandidatesFilters,
    refresh,
  } = useCandidates();
  const {
    filters,
    setFilters,
    savedFilters,
    recentSearches,
    popularFilters,
    activeFilters,
    saveFilter,
    resetFilters,
    clearRecentSearches,
    toggleSeparateFiltering,
    updateMaleFilters,
    updateFemaleFilters,
    copyFilters,
    updateMaleSearchQuery,
    updateFemaleSearchQuery,
    removeFilter,
  } = useFilterLogic({ onFilterChange: setCandidatesFilters });

  // --- Derived State ---
  const activeFilterCount = useMemo(
    () => activeFilters.length,
    [activeFilters]
  );
  const heroStats = useMemo(() => {
    const total = candidates.length;
    const male = candidates.filter((c) => c.profile.gender === 'MALE').length;
    const female = candidates.filter(
      (c) => c.profile.gender === 'FEMALE'
    ).length;
    const verified = candidates.filter((c) => c.isVerified).length;
    const activeToday = candidates.filter((c) => {
      const lastActive = new Date(c.createdAt);
      const today = new Date();

      return (
        (today.getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24) <= 7
      );
    }).length;
    const profilesComplete =
      total > 0
        ? Math.round(
            (candidates.filter((c) => c.isProfileComplete).length / total) * 100
          )
        : 0;
    return { total, male, female, verified, activeToday, profilesComplete };
  }, [candidates]);

  // --- Effects ---
  useEffect(() => {
    const checkScreen = () => {
      setShowFiltersPanel(window.innerWidth >= 1024);
      setIsMobile(window.innerWidth < 768);
    };
    checkScreen();
    window.addEventListener('resize', checkScreen);
    return () => window.removeEventListener('resize', checkScreen);
  }, []);

  // --- Event Handlers ---
  const handleCandidateAdded = useCallback(() => {
    refresh();
    toast.success('מועמד חדש נוסף בהצלחה!');
  }, [refresh]);

  const handleSearch = useCallback(
    (value: string) => {
      setFilters({ searchQuery: value });
    },
    [setFilters]
  );
  const handleRemoveFilter = useCallback(
    (key: keyof CandidatesFilter, value?: string) => {
      removeFilter(key, value);
    },
    [removeFilter]
  );
  const handleCandidateAction = useCallback(
    async (type: CandidateAction, candidate: Candidate) => {
      console.log(
        `Action '${type}' triggered for candidate: ${candidate.firstName}`
      );
    },
    []
  );

  const handleFilterSave = useCallback(
    async (name: string) => {
      try {
        await saveFilter(name, filters);
        toast.success('הפילטר נשמר בהצלחה');
      } catch {
        toast.error('שגיאה בשמירת הפילטר');
      }
    },
    [filters, saveFilter]
  );

  const handleSetAiTarget = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      if (aiTargetCandidate?.id === candidate.id) {
        handleClearAiTarget(e);
        return;
      }
      setAiTargetCandidate(candidate);
      setAiMatches([]);
      setComparisonSelection({});
      toast.info(`מועמד מטרה נבחר: ${candidate.firstName}.`, {
        position: 'bottom-center',
      });
    },
    [aiTargetCandidate]
  );

  const handleClearAiTarget = (e: React.MouseEvent) => {
    e.stopPropagation();
    setAiTargetCandidate(null);
    setAiMatches([]);
    setComparisonSelection({});
    toast.info('בחירת מועמד מטרה בוטלה.', { position: 'bottom-center' });
  };

  const handleToggleComparison = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      setComparisonSelection((prev) => {
        const newSelection = { ...prev };
        if (newSelection[candidate.id]) delete newSelection[candidate.id];
        else newSelection[candidate.id] = candidate;
        return newSelection;
      });
    },
    []
  );

  const handleUpdateAllProfiles = async () => {
    setIsBulkUpdating(true);
    toast.info('מתחיל תהליך עדכון פרופילי AI...');
    try {
      const response = await fetch('/api/ai/update-all-profiles', {
        method: 'POST',
      });
      const data = await response.json();
      if (!response.ok)
        throw new Error(data.error || 'שגיאה בהפעלת העדכון הכללי.');
      toast.success('העדכון הכללי הופעל בהצלחה!');
    } catch (error) {
      console.error('Failed to initiate bulk AI profile update:', error);
      toast.error('שגיאה בהפעלת העדכון', {
        description:
          error instanceof Error ? error.message : 'אנא נסה שוב מאוחר יותר.',
      });
    } finally {
      setIsBulkUpdating(false);
    }
  };
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- Render ---
  return (
    <div
      className="min-h-screen flex flex-col bg-gradient-to-br from-slate-50 via-indigo-50/10 to-purple-50/5"
      dir={direction}
    >
      <MinimalHeader
        stats={heroStats}
        onAddCandidate={() => setShowManualAddDialog(true)}
        onRefresh={refresh}
        isRefreshing={loading}
        onBulkUpdate={handleUpdateAllProfiles}
        isBulkUpdating={isBulkUpdating}
        isAdmin={isAdmin}
        isCompact={isHeaderCompact}
        onToggleCompact={() => setIsHeaderCompact(!isHeaderCompact)}
        dict={matchmakerDict.candidatesManager.header}
      />

      {isHeaderCompact && (
        <div className="flex-shrink-0 bg-white/80 backdrop-blur-sm border-b border-gray-100 py-3 px-4 mt-16">
          <div className="container mx-auto px-2">
            <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
              {!filters.separateFiltering && (
                <div className="w-full md:flex-1 md:max-w-md">
                  <SearchBar
                    value={filters.searchQuery || ''}
                    onChange={handleSearch}
                    placeholder={
                      matchmakerDict.candidatesManager.searchBar
                        .generalPlaceholder
                    }
                    recentSearches={recentSearches}
                    onClearRecentSearches={clearRecentSearches}
                    dict={matchmakerDict.candidatesManager.searchBar}
                  />
                </div>
              )}

              <div className="flex items-center justify-between w-full md:w-auto md:justify-start gap-2 flex-wrap">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="bg-white/90 shadow-sm border border-gray-200"
                    >
                      <ArrowUpDown
                        className={cn(
                          'w-4 h-4',
                          locale === 'he' ? 'ml-1' : 'mr-1'
                        )}
                      />
                      {matchmakerDict.candidatesManager.controls.sort}
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuLabel>
                      {matchmakerDict.candidatesManager.controls.sortBy}
                    </DropdownMenuLabel>
                    <DropdownMenuSeparator />
                    {SORT_OPTIONS.map((option) => (
                      <DropdownMenuItem
                        key={option.value}
                        onClick={() =>
                          setSorting(
                            option.value,
                            option.defaultOrder as 'asc' | 'desc'
                          )
                        }
                      >
                        {
                          matchmakerDict.candidatesManager.sortOptions[
                            option.value as keyof typeof matchmakerDict.candidatesManager.sortOptions
                          ]
                        }
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>

                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsQuickViewEnabled(!isQuickViewEnabled)}
                  className="bg-white/90 shadow-sm border border-gray-200"
                >
                  {isQuickViewEnabled ? (
                    <EyeOff
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  ) : (
                    <Eye
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  )}

                  {isQuickViewEnabled
                    ? matchmakerDict.candidatesManager.controls.disableQuickView
                    : matchmakerDict.candidatesManager.controls.enableQuickView}
                </Button>

                <div className="hidden lg:flex">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowFiltersPanel(!showFiltersPanel)}
                    className="bg-white/90 shadow-sm border border-gray-200"
                  >
                    <Filter className="w-4 h-4 ml-1" />
                    {showFiltersPanel
                      ? matchmakerDict.candidatesManager.controls.hideFilters
                      : matchmakerDict.candidatesManager.controls.filters}
                  </Button>
                </div>

                <Sheet
                  open={showFiltersMobile}
                  onOpenChange={setShowFiltersMobile}
                >
                  <SheetTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="lg:hidden relative bg-white/90 shadow-sm border border-gray-200"
                    >
                      <Filter className="w-4 h-4 ml-1" />
                      {matchmakerDict.candidatesManager.controls.filters}
                      {activeFilterCount > 0 && (
                        <Badge className="absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center bg-indigo-500 border-0 text-xs">
                          {activeFilterCount}
                        </Badge>
                      )}
                    </Button>
                  </SheetTrigger>
                  <SheetContent>
                    <FilterPanel
                      filters={filters}
                      onFiltersChange={setFilters}
                      onSavePreset={handleFilterSave}
                      onReset={resetFilters}
                      savedFilters={savedFilters.map((f) => ({
                        id: f.id,
                        name: f.name,
                        isDefault: f.isDefault,
                      }))}
                      popularFilters={popularFilters}
                      separateFiltering={filters.separateFiltering}
                      onToggleSeparateFiltering={toggleSeparateFiltering}
                      onMaleFiltersChange={updateMaleFilters}
                      onFemaleFiltersChange={updateFemaleFilters}
                      onCopyFilters={copyFilters}
                      dict={matchmakerDict.candidatesManager.filterPanel}
                    />
                  </SheetContent>
                </Sheet>

                <div className="flex gap-1 bg-white/90 p-1 rounded-lg shadow-sm border border-gray-200">
                  {isMobile ? (
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button
                          variant="outline"
                          size="sm"
                          className="w-24 justify-between px-2 border-0"
                        >
                          {mobileView === 'split' && (
                            <Users className="w-4 h-4" />
                          )}
                          {mobileView === 'single' && (
                            <View className="w-4 h-4" />
                          )}
                          {mobileView === 'double' && (
                            <Columns className="w-4 h-4" />
                          )}
                          <ArrowUpDown className="w-3 h-3 opacity-50 ml-1" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuRadioGroup
                          value={mobileView}
                          onValueChange={(value) =>
                            setMobileView(value as MobileView)
                          }
                        >
                          <DropdownMenuRadioItem value="split">
                            <Users className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .split
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="single">
                            <View className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .singleCol
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="double">
                            <Columns className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .doubleCol
                            }
                          </DropdownMenuRadioItem>
                        </DropdownMenuRadioGroup>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  ) : (
                    VIEW_OPTIONS.map((option) => (
                      <Button
                        key={option.value}
                        variant={
                          viewMode === option.value ? 'default' : 'ghost'
                        }
                        size="icon"
                        onClick={() => setViewMode(option.value as ViewMode)}
                        className={cn(
                          'h-8 w-8',
                          viewMode === option.value &&
                            'bg-indigo-500 text-white'
                        )}
                      >
                        {option.value === 'grid' ? (
                          <LayoutGrid className="w-4 h-4" />
                        ) : (
                          <List className="w-4 h-4" />
                        )}
                      </Button>
                    ))
                  )}
                </div>
              </div>
            </div>
            <div className="mt-2">
              <ActiveFilters
                filters={filters}
                onRemoveFilter={handleRemoveFilter}
                onResetAll={resetFilters}
                dict={matchmakerDict.candidatesManager.activeFilters}
              />
            </div>
          </div>
        </div>
      )}

      <main
        className={cn(
          'flex-1 min-h-0 container mx-auto px-6 pb-4 pt-4',
          !isHeaderCompact && 'mt-32'
        )}
      >
        <div className="flex gap-4 h-full">
          {showFiltersPanel && (
            <aside className="hidden lg:block w-72 flex-shrink-0">
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 h-full flex flex-col">
                <FilterPanel
                  filters={filters}
                  onFiltersChange={setFilters}
                  onSavePreset={handleFilterSave}
                  onReset={resetFilters}
                  savedFilters={savedFilters.map((f) => ({
                    id: f.id,
                    name: f.name,
                    isDefault: f.isDefault,
                  }))}
                  popularFilters={popularFilters}
                  separateFiltering={filters.separateFiltering}
                  onToggleSeparateFiltering={toggleSeparateFiltering}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  className="flex-1 overflow-y-auto"
                  dict={matchmakerDict.candidatesManager.filterPanel}
                />
              </div>
            </aside>
          )}

          <div className="flex-1 min-w-0 h-full">
            {loading ? (
              <LoadingContainer>
                <div className="h-full bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl animate-pulse shadow-lg"></div>
              </LoadingContainer>
            ) : (
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 overflow-hidden h-full">
                <SplitView
                  onOpenAiAnalysis={handleOpenAiAnalysis}
                  onSendProfileFeedback={handleOpenProfileFeedback} // <--- הוסף את השורה הזו
                  maleCandidates={maleCandidates}
                  femaleCandidates={femaleCandidates}
                  allCandidates={candidates}
                  onCandidateAction={handleCandidateAction}
                  onCandidateClick={() => {}}
                  viewMode={viewMode}
                  mobileView={mobileView}
                  isLoading={loading || isAiLoading}
                  className="flex-1 overflow-hidden"
                  aiTargetCandidate={aiTargetCandidate}
                  aiMatches={aiMatches}
                  isAiLoading={isAiLoading}
                  onSetAiTarget={handleSetAiTarget}
                  onClearAiTarget={handleClearAiTarget}
                  setAiMatches={setAiMatches}
                  setIsAiLoading={setIsAiLoading}
                  comparisonSelection={comparisonSelection}
                  onToggleComparison={handleToggleComparison}
                  separateFiltering={filters.separateFiltering ?? false}
                  maleFilters={filters.maleFilters}
                  femaleFilters={filters.femaleFilters}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  maleSearchQuery={filters.maleSearchQuery}
                  femaleSearchQuery={filters.femaleSearchQuery}
                  onMaleSearchChange={updateMaleSearchQuery}
                  onFemaleSearchChange={updateFemaleSearchQuery}
                  dict={matchmakerDict}
                  profileDict={profileDict}
                  isQuickViewEnabled={isQuickViewEnabled} // <-- העברת prop חדש
                  locale={locale} // <--- הוסף את השורה הזו
                />
              </div>
            )}
          </div>
        </div>
      </main>
      <AnimatePresence>
        {aiTargetCandidate && Object.keys(comparisonSelection).length > 0 && (
          <motion.div
            initial={{ y: 100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 100, opacity: 0 }}
            className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"
          >
            <div className="bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-2xl border flex items-center gap-4">
              <div className="flex items-center -space-x-4">
                {Object.values(comparisonSelection)
                  .slice(0, 3)
                  .map((c) => (
                    <div
                      key={c.id}
                      className="w-10 h-10 rounded-full overflow-hidden border-2 border-white bg-gray-200 flex items-center justify-center text-gray-500 font-bold"
                    >
                      {c.images?.find((img) => img.isMain) ? (
                        <Image
                          src={getRelativeCloudinaryPath(
                            c.images.find((img) => img.isMain)!.url
                          )}
                          alt={c.firstName}
                          width={40}
                          height={40}
                          className="object-cover"
                        />
                      ) : (
                        <span>
                          {c.firstName.charAt(0)}
                          {c.lastName.charAt(0)}
                        </span>
                      )}
                    </div>
                  ))}
                {Object.keys(comparisonSelection).length > 3 && (
                  <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold text-gray-600 border-2 border-white">
                    +{Object.keys(comparisonSelection).length - 3}
                  </div>
                )}
              </div>
              <Button
                onClick={() => setIsAnalysisDialogOpen(true)}
                className="bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold shadow-lg"
              >
                <GitCompare
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {matchmakerDict.candidatesManager.controls.compareButton.replace(
                  '{{count}}',
                  String(Object.keys(comparisonSelection).length)
                )}
              </Button>
              <Button
                variant="ghost"
                size="icon"
                className="h-8 w-8 rounded-full"
                onClick={() => setComparisonSelection({})}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
      <AiMatchmakerProfileAdvisorDialog
        isOpen={!!analyzedCandidate}
        onClose={handleCloseAiAnalysis}
        candidate={analyzedCandidate}
        dict={matchmakerDict.candidatesManager.aiProfileAdvisor}
        locale={locale}
      />
      <ProfileFeedbackDialog
        isOpen={!!feedbackCandidate}
        onClose={() => setFeedbackCandidate(null)}
        candidate={feedbackCandidate}
        locale={locale}
        dict={matchmakerDict.candidatesManager.profileFeedbackDialog}
      />
      {/* --- Dialogs --- */}
      <AddManualCandidateDialog
        isOpen={showManualAddDialog}
        onClose={() => setShowManualAddDialog(false)}
        onCandidateAdded={handleCandidateAdded}
        dict={matchmakerDict.candidatesManager.addManualCandidateDialog} // <--- הוספת השורה הזו
        locale={locale}
      />
      <AiMatchAnalysisDialog
        isOpen={isAnalysisDialogOpen}
        onClose={() => setIsAnalysisDialogOpen(false)}
        targetCandidate={aiTargetCandidate}
        comparisonCandidates={Object.values(comparisonSelection)}
        dict={matchmakerDict.candidatesManager.aiAnalysis}
        locale={locale} // <--- הוסף את השורה הזו
      />
    </div>
  );
};

export default CandidatesManager;
--- End of Content for index.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\ActiveFilters.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React from 'react';
import { X, RefreshCw, Sparkles, Filter, Star, Zap, Crown } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import type { CandidatesFilter } from '../types/candidates';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface ActiveFiltersProps {
  filters: CandidatesFilter;
  onRemoveFilter: (key: keyof CandidatesFilter, value?: string) => void;
  onResetAll: () => void;
  onSuggestFilter?: () => void;
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['activeFilters'];
}

interface ActiveFilter {
  key: keyof CandidatesFilter;
  label: string;
  value?: string;
  color?: string;
  icon?: React.ReactNode;
  priority?: 'high' | 'medium' | 'low';
}

const ActiveFilters: React.FC<ActiveFiltersProps> = ({
  filters,
  onRemoveFilter,
  onResetAll,
  onSuggestFilter,
  className,
  dict,
}) => {
  const getActiveFilters = (): ActiveFilter[] => {
    const activeFilters: ActiveFilter[] = [];

    if (!filters.separateFiltering && filters.searchQuery) {
      activeFilters.push({
        key: 'searchQuery',
        label: dict.labels.search.replace('{{query}}', filters.searchQuery),
        color: 'primary',
        icon: <Sparkles className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering && filters.maleSearchQuery) {
      activeFilters.push({
        key: 'maleSearchQuery',
        label: dict.labels.maleSearch.replace(
          '{{query}}',
          filters.maleSearchQuery
        ),
        color: 'male',
        icon: <Star className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering && filters.femaleSearchQuery) {
      activeFilters.push({
        key: 'femaleSearchQuery',
        label: dict.labels.femaleSearch.replace(
          '{{query}}',
          filters.femaleSearchQuery
        ),
        color: 'female',
        icon: <Crown className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering) {
      activeFilters.push({
        key: 'separateFiltering',
        label: dict.labels.separateFiltering,
        color: 'special',
        icon: <Zap className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.gender) {
      const genderLabel =
        filters.gender === 'MALE'
          ? dict.labels.genders.MALE
          : dict.labels.genders.FEMALE;
      activeFilters.push({
        key: 'gender',
        label: dict.labels.gender.replace('{{gender}}', genderLabel),
        color: filters.gender === 'MALE' ? 'male' : 'female',
        priority: 'high',
      });
    }

    if (filters.ageRange) {
      const isDefaultMin = filters.ageRange.min === 18;
      const isDefaultMax = filters.ageRange.max === 99;

      if (!isDefaultMin || !isDefaultMax) {
        let label = '';
        if (!isDefaultMin && !isDefaultMax) {
          label = dict.labels.age
            .replace('{{min}}', String(filters.ageRange.min))
            .replace('{{max}}', String(filters.ageRange.max));
        } else if (!isDefaultMin) {
          label = dict.labels.ageAbove.replace(
            '{{min}}',
            String(filters.ageRange.min)
          );
        } else if (!isDefaultMax) {
          label = dict.labels.ageBelow.replace(
            '{{max}}',
            String(filters.ageRange.max)
          );
        }
        activeFilters.push({
          key: 'ageRange',
          label,
          color: 'primary',
          priority: 'high',
        });
      }
    }

    if (filters.heightRange) {
      const isDefaultMin = filters.heightRange.min === 140;
      const isDefaultMax = filters.heightRange.max === 210;

      if (!isDefaultMin || !isDefaultMax) {
        let label = '';
        if (!isDefaultMin && !isDefaultMax) {
          label = dict.labels.height
            .replace('{{min}}', String(filters.heightRange.min))
            .replace('{{max}}', String(filters.heightRange.max));
        } else if (!isDefaultMin) {
          label = dict.labels.heightAbove.replace(
            '{{min}}',
            String(filters.heightRange.min)
          );
        } else if (!isDefaultMax) {
          label = dict.labels.heightBelow.replace(
            '{{max}}',
            String(filters.heightRange.max)
          );
        }
        activeFilters.push({
          key: 'heightRange',
          label,
          color: 'secondary',
          priority: 'medium',
        });
      }
    }

    if (filters.religiousLevel) {
      activeFilters.push({
        key: 'religiousLevel',
        label: dict.labels.religiousLevel.replace(
          '{{level}}',
          filters.religiousLevel
        ),
        color: 'warning',
        priority: 'medium',
      });
    }

    if (filters.educationLevel) {
      activeFilters.push({
        key: 'educationLevel',
        label: dict.labels.educationLevel.replace(
          '{{level}}',
          filters.educationLevel
        ),
        color: 'secondary',
        priority: 'medium',
      });
    }

    filters.cities?.forEach((city) => {
      activeFilters.push({
        key: 'cities',
        value: city,
        label: dict.labels.city.replace('{{city}}', city),
        color: 'success',
        priority: 'medium',
      });
    });

    filters.occupations?.forEach((occupation) => {
      activeFilters.push({
        key: 'occupations',
        value: occupation,
        label: dict.labels.occupation.replace('{{occupation}}', occupation),
        color: 'primary',
        priority: 'medium',
      });
    });

    if (filters.availabilityStatus) {
      const status =
        filters.availabilityStatus as keyof typeof dict.labels.availability;
      const statusLabel =
        dict.labels.availability[status] || filters.availabilityStatus;
      activeFilters.push({
        key: 'availabilityStatus',
        label: dict.labels.status.replace('{{status}}', statusLabel),
        color:
          filters.availabilityStatus === 'AVAILABLE' ? 'success' : 'warning',
        priority: 'high',
      });
    }

    if (filters.maritalStatus) {
      activeFilters.push({
        key: 'maritalStatus',
        label: dict.labels.maritalStatus.replace(
          '{{status}}',
          filters.maritalStatus
        ),
        color: 'secondary',
        priority: 'medium',
      });
    }

    if (filters.isVerified) {
      activeFilters.push({
        key: 'isVerified',
        label: dict.labels.verifiedOnly,
        color: 'primary',
        icon: <Star className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.hasReferences) {
      activeFilters.push({
        key: 'hasReferences',
        label: dict.labels.withRecommendations,
        color: 'success',
        priority: 'medium',
      });
    }

    if (filters.isProfileComplete) {
      activeFilters.push({
        key: 'isProfileComplete',
        label: dict.labels.fullProfile,
        color: 'primary',
        priority: 'medium',
      });
    }

    if (filters.lastActiveDays) {
      let label: string;
      switch (filters.lastActiveDays) {
        case 1:
          label = dict.labels.activeToday;
          break;
        case 3:
          label = dict.labels.activeLast3Days;
          break;
        case 7:
          label = dict.labels.activeLast7Days;
          break;
        case 30:
          label = dict.labels.activeLast30Days;
          break;
        default:
          label = dict.labels.activeInDays.replace(
            '{{days}}',
            String(filters.lastActiveDays)
          );
      }
      activeFilters.push({
        key: 'lastActiveDays',
        label,
        color: 'special',
        priority: 'medium',
      });
    }

    return activeFilters;
  };

  const getFilterColors = (color?: string) => {
    const colorSchemes = {
      primary: {
        badge:
          'bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 shadow-lg',
        hover: 'hover:from-blue-600 hover:to-cyan-600',
      },
      secondary: {
        badge:
          'bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 shadow-lg',
        hover: 'hover:from-purple-600 hover:to-pink-600',
      },
      success: {
        badge:
          'bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 shadow-lg',
        hover: 'hover:from-emerald-600 hover:to-green-600',
      },
      warning: {
        badge:
          'bg-gradient-to-r from-amber-500 to-orange-500 text-white border-0 shadow-lg',
        hover: 'hover:from-amber-600 hover:to-orange-600',
      },
      male: {
        badge:
          'bg-gradient-to-r from-blue-600 to-indigo-600 text-white border-0 shadow-lg',
        hover: 'hover:from-blue-700 hover:to-indigo-700',
      },
      female: {
        badge:
          'bg-gradient-to-r from-purple-600 to-pink-600 text-white border-0 shadow-lg',
        hover: 'hover:from-purple-700 hover:to-pink-700',
      },
      special: {
        badge:
          'bg-gradient-to-r from-indigo-500 to-purple-500 text-white border-0 shadow-lg',
        hover: 'hover:from-indigo-600 hover:to-purple-600',
      },
    };
    return (
      colorSchemes[color as keyof typeof colorSchemes] || colorSchemes.primary
    );
  };

  const activeFilters = getActiveFilters();
  const sortedFilters = activeFilters.sort((a, b) => {
    const priorityOrder = { high: 3, medium: 2, low: 1 };
    return (
      priorityOrder[b.priority || 'low'] - priorityOrder[a.priority || 'low']
    );
  });

  if (activeFilters.length === 0) {
    return null;
  }

  return (
    <div className={cn('relative', className)}>
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-200/20 to-cyan-200/20 rounded-full blur-2xl"></div>
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-xl"></div>
      </div>
      <div className="relative z-10 bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 backdrop-blur-sm rounded-2xl p-6 shadow-xl border-0">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg">
              <Filter className="w-6 h-6" />
            </div>
            <div>
              <h3 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
                {dict.title}
              </h3>
              <p className="text-sm text-gray-600 mt-1">
                {activeFilters.length === 1
                  ? dict.filterActive
                  : dict.filtersActive.replace(
                      '{{count}}',
                      String(activeFilters.length)
                    )}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            {onSuggestFilter && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={onSuggestFilter}
                      className="bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 text-emerald-700 border border-emerald-200 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg"
                    >
                      <Sparkles className="w-4 h-4 mr-2" />
                      {dict.suggestButton}
                      <Zap className="w-3 h-3 ml-1" />
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{dict.suggestTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={onResetAll}
                    className="bg-gradient-to-r from-red-50 to-pink-50 hover:from-red-100 hover:to-pink-100 text-red-700 border border-red-200 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg"
                  >
                    <RefreshCw className="w-4 h-4 mr-2" />
                    {dict.clearAllButton}
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{dict.clearAllTooltip}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>
        </div>
        <div className="flex flex-wrap gap-3">
          <AnimatePresence mode="popLayout">
            {sortedFilters.map((filter, index) => {
              const colors = getFilterColors(filter.color);
              return (
                <motion.div
                  key={`${filter.key}-${filter.value || index}`}
                  initial={{ opacity: 0, scale: 0.8, y: 20 }}
                  animate={{ opacity: 1, scale: 1, y: 0 }}
                  exit={{ opacity: 0, scale: 0.8, y: -20 }}
                  transition={{
                    duration: 0.3,
                    delay: index * 0.05,
                    type: 'spring',
                    stiffness: 300,
                    damping: 25,
                  }}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Badge
                    className={cn(
                      'px-4 py-2.5 whitespace-nowrap font-bold text-sm rounded-xl transition-all duration-300 group cursor-pointer shadow-lg hover:shadow-xl',
                      colors.badge,
                      colors.hover,
                      filter.priority === 'high' && 'ring-2 ring-white/50'
                    )}
                  >
                    <div className="flex items-center gap-2">
                      {filter.icon && (
                        <span className="opacity-90 group-hover:opacity-100 transition-opacity">
                          {filter.icon}
                        </span>
                      )}
                      <span className="max-w-[200px] truncate font-medium">
                        {filter.label}
                      </span>
                      <button
                        className="ml-2 hover:bg-white/20 rounded-full p-1 transition-all duration-200 hover:scale-110 group-hover:bg-white/30"
                        onClick={(e) => {
                          e.stopPropagation();
                          onRemoveFilter(filter.key, filter.value);
                        }}
                        aria-label={`הסר פילטר ${filter.label}`}
                      >
                        <X className="w-3.5 h-3.5" />
                      </button>
                    </div>
                  </Badge>
                </motion.div>
              );
            })}
          </AnimatePresence>
        </div>
        {activeFilters.length > 3 && (
          <div className="mt-6 pt-4 border-t border-gray-200/50">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <Sparkles className="w-4 h-4 text-blue-500" />
                <span>
                  {dict.summary.title.replace(
                    '{{count}}',
                    String(activeFilters.length)
                  )}
                </span>
              </div>
              <div className="flex items-center gap-1">
                {activeFilters.filter((f) => f.priority === 'high').length >
                  0 && (
                  <Badge
                    variant="outline"
                    className="bg-red-50 text-red-700 border-red-200 text-xs"
                  >
                    {dict.summary.highPriority.replace(
                      '{{count}}',
                      String(
                        activeFilters.filter((f) => f.priority === 'high')
                          .length
                      )
                    )}
                  </Badge>
                )}
                {activeFilters.filter((f) => f.priority === 'medium').length >
                  0 && (
                  <Badge
                    variant="outline"
                    className="bg-yellow-50 text-yellow-700 border-yellow-200 text-xs"
                  >
                    {dict.summary.mediumPriority.replace(
                      '{{count}}',
                      String(
                        activeFilters.filter((f) => f.priority === 'medium')
                          .length
                      )
                    )}
                  </Badge>
                )}
              </div>
            </div>
          </div>
        )}
        <div className="absolute inset-0 bg-gradient-to-r from-blue-400/5 via-purple-400/5 to-pink-400/5 rounded-2xl pointer-events-none"></div>
      </div>
    </div>
  );
};

export default ActiveFilters;
--- End of Content for ActiveFilters.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\FilterPanel.tsx
--------------------------------------------------------------------------------
Content:
// /Filters/FilterPanel.tsx - גרסה מתורגמת, מלאה ומעודכנת
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

// Lucide React Icons
import {
  Activity,
  Award,
  Bookmark,
  Calendar,
  ChevronDown,
  Copy,
  Crown,
  Filter as FilterIcon,
  Heart,
  MapPin,
  RefreshCw,
  Ruler,
  Save,
  Scroll,
  Shield,
  Sparkles,
  Star,
  Target,
  User,
  Zap,
} from 'lucide-react';

// Utility Functions
import { cn } from '@/lib/utils';

// UI Components
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';

// Local Components, Types & Constants
import SavedFilters from './SavedFilters';
import {
  AGE_RANGE,
  HEIGHT_RANGE,
  POPULAR_CITIES,
  RELIGIOUS_LEVELS,
} from '../constants/filterOptions';
import type { CandidatesFilter } from '../types/candidates';
import type { FilterState } from '../types/filters';
import type { FilterPanelDict } from '@/types/dictionaries/matchmaker';
import { DEFAULT_FILTER_STATE } from '../types/filters';

// Interfaces
interface PopularFilterOption {
  id: keyof FilterPanelDict['popularFilters'];
  label: string;
  icon: React.ReactNode;
  filter: Partial<CandidatesFilter>;
  gradient: string;
}

interface FilterPanelProps {
  filters: CandidatesFilter;
  onFiltersChange: (filters: CandidatesFilter) => void;
  onSavePreset?: (name: string) => void;
  onReset: () => void;
  onApplySavedFilter?: (id: string) => void;
  savedFilters?: Array<{ id: string; name: string; isDefault?: boolean }>;
  popularFilters?: string[];
  className?: string;
  compactMode?: boolean;
  separateFiltering?: boolean;
  onToggleSeparateFiltering?: () => void;
  onMaleFiltersChange?: (filters: Partial<FilterState>) => void;
  onFemaleFiltersChange?: (filters: Partial<FilterState>) => void;
  onCopyFilters?: (
    source: 'male' | 'female',
    target: 'male' | 'female'
  ) => void;
  dict: FilterPanelDict;
}

interface FilterSectionProps {
  title: string;
  icon: React.ReactNode;
  children: React.ReactNode;
  defaultOpen?: boolean;
  badge?: number;
  gradient?: string;
}

// Helper Components
const FilterSection: React.FC<FilterSectionProps> = ({
  title,
  icon,
  children,
  defaultOpen = false,
  badge,
  gradient = 'from-blue-500 to-cyan-500',
}) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="mb-4"
    >
      <Collapsible
        open={isOpen}
        onOpenChange={setIsOpen}
        className="rounded-2xl overflow-hidden shadow-xl border-0 bg-gradient-to-br from-white via-gray-50/30 to-white"
      >
        <CollapsibleTrigger asChild>
          <motion.div
            className={cn(
              'flex items-center justify-between p-4 cursor-pointer transition-all duration-300',
              'bg-gradient-to-r',
              gradient,
              'text-white hover:shadow-lg'
            )}
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                {icon}
              </div>
              <span className="font-bold text-lg">{title}</span>
              {badge !== undefined && (
                <Badge className="bg-white/20 text-white border-white/30 shadow-lg">
                  {badge}
                </Badge>
              )}
            </div>
            <motion.div
              animate={{ rotate: isOpen ? 180 : 0 }}
              transition={{ duration: 0.3 }}
            >
              <ChevronDown size={20} className="text-white/80" />
            </motion.div>
          </motion.div>
        </CollapsibleTrigger>
        <CollapsibleContent className="data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-top-1 data-[state=open]:slide-in-from-top-1">
          <div className="p-6 bg-gradient-to-br from-white via-gray-50/20 to-white">
            {children}
          </div>
        </CollapsibleContent>
      </Collapsible>
    </motion.div>
  );
};

const GenderFilterPanel = ({
  gender,
  filters,
  onFiltersChange,
  className,
  copyTarget,
  onCopyFilters,
  dict,
}: {
  gender: 'male' | 'female';
  filters: Partial<FilterState>;
  onFiltersChange: (filters: Partial<FilterState>) => void;
  className?: string;
  copyTarget: 'male' | 'female';
  onCopyFilters?: (
    source: 'male' | 'female',
    target: 'male' | 'female'
  ) => void;
  dict: FilterPanelDict['genderFilterPanel'];
}) => {
  const genderConfig = {
    male: {
      gradient: 'from-blue-500 to-cyan-500',
      bg: 'from-blue-50/50 to-cyan-50/30',
      text: 'text-blue-800',
      icon: <Target className="w-5 h-5" />,
      title: dict.maleTitle,
      copyLabel: dict.copyToFemale,
    },
    female: {
      gradient: 'from-purple-500 to-pink-500',
      bg: 'from-purple-50/50 to-pink-50/30',
      text: 'text-purple-800',
      icon: <Crown className="w-5 h-5" />,
      title: dict.femaleTitle,
      copyLabel: dict.copyToMale,
    },
  };
  const config = genderConfig[gender];

  const handleAgeChange = (type: 'min' | 'max', value: string) => {
    const numericValue = parseInt(value);
    if (
      isNaN(numericValue) ||
      numericValue < AGE_RANGE.min ||
      numericValue > AGE_RANGE.max
    )
      return;
    const currentMin = filters.ageRange?.min || AGE_RANGE.default.min;
    const currentMax = filters.ageRange?.max || AGE_RANGE.default.max;
    onFiltersChange({
      ...filters,
      ageRange: {
        min: type === 'min' ? Math.min(numericValue, currentMax) : currentMin,
        max: type === 'max' ? Math.max(numericValue, currentMin) : currentMax,
      },
    });
  };

  const handleHeightChange = (type: 'min' | 'max', value: string) => {
    const numericValue = parseInt(value);
    if (
      isNaN(numericValue) ||
      numericValue < HEIGHT_RANGE.min ||
      numericValue > HEIGHT_RANGE.max
    )
      return;
    const currentMin = filters.heightRange?.min || HEIGHT_RANGE.default.min;
    const currentMax = filters.heightRange?.max || HEIGHT_RANGE.default.max;
    onFiltersChange({
      ...filters,
      heightRange: {
        min: type === 'min' ? Math.min(numericValue, currentMax) : currentMin,
        max: type === 'max' ? Math.max(numericValue, currentMin) : currentMax,
      },
    });
  };

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      className={cn(
        'mb-6 rounded-2xl overflow-hidden shadow-xl border-0',
        className
      )}
    >
      <div
        className={cn(
          'flex justify-between items-center px-6 py-4',
          'bg-gradient-to-r',
          config.gradient,
          'text-white'
        )}
      >
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-white/20 backdrop-blur-sm">
            {config.icon}
          </div>
          <h3 className="text-lg font-bold">{config.title}</h3>
        </div>
        {onCopyFilters && (
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onCopyFilters(gender, copyTarget)}
                  className="text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-105"
                >
                  <Copy className="w-4 h-4 mr-2" />
                  {config.copyLabel}
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>
                  {dict.copyTooltip.replace(
                    '{{gender}}',
                    copyTarget === 'male' ? dict.maleTitle : dict.femaleTitle
                  )}
                </p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        )}
      </div>
      <div className={cn('p-6 space-y-6 bg-gradient-to-br', config.bg)}>
        <div className="space-y-4">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <Calendar className="w-5 h-5 text-blue-600" />
            {dict.ageLabel}
          </Label>
          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-100/50">
            <div className="flex justify-between items-center mb-4">
              <div className="text-center bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-blue-600 mb-1 font-medium">
                  {dict.minLabel}
                </p>
                <input
                  type="number"
                  min={AGE_RANGE.min}
                  max={AGE_RANGE.max}
                  value={filters?.ageRange?.min || AGE_RANGE.default.min}
                  onChange={(e) => handleAgeChange('min', e.target.value)}
                  className="w-16 text-center text-lg font-bold text-blue-700 focus:outline-none bg-transparent"
                />
              </div>
              <span className="text-xl font-bold text-gray-400">-</span>
              <div className="text-center bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-blue-600 mb-1 font-medium">
                  {dict.maxLabel}
                </p>
                <input
                  type="number"
                  min={AGE_RANGE.min}
                  max={AGE_RANGE.max}
                  value={filters?.ageRange?.max || AGE_RANGE.default.max}
                  onChange={(e) => handleAgeChange('max', e.target.value)}
                  className="w-16 text-center text-lg font-bold text-blue-700 focus:outline-none bg-transparent"
                />
              </div>
            </div>
            <div className="px-2">
              <Slider
                value={[
                  filters?.ageRange?.min || AGE_RANGE.default.min,
                  filters?.ageRange?.max || AGE_RANGE.default.max,
                ]}
                min={AGE_RANGE.min}
                max={AGE_RANGE.max}
                step={1}
                onValueChange={(value) =>
                  onFiltersChange({
                    ...filters,
                    ageRange: { min: value[0], max: value[1] },
                  })
                }
                className="h-5 [&>span]:bg-gradient-to-r [&>span]:from-blue-500 [&>span]:to-cyan-500"
                dir="rtl"
              />
              <div className="flex justify-between mt-3 px-2 text-xs text-gray-500">
                <span>{AGE_RANGE.min}</span>
                <span>{AGE_RANGE.max}</span>
              </div>
            </div>
          </div>
        </div>
        <div className="space-y-4">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <Ruler className="w-5 h-5 text-purple-600" />
            {dict.heightLabel}
          </Label>
          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-100/50">
            <div className="flex justify-between items-center mb-4">
              <div className="text-center bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-purple-600 mb-1 font-medium">
                  {dict.minLabel}
                </p>
                <input
                  type="number"
                  min={HEIGHT_RANGE.min}
                  max={HEIGHT_RANGE.max}
                  value={filters?.heightRange?.min || HEIGHT_RANGE.default.min}
                  onChange={(e) => handleHeightChange('min', e.target.value)}
                  className="w-16 text-center text-lg font-bold text-purple-700 focus:outline-none bg-transparent"
                />
              </div>
              <span className="text-xl font-bold text-gray-400">-</span>
              <div className="text-center bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-purple-600 mb-1 font-medium">
                  {dict.maxLabel}
                </p>
                <input
                  type="number"
                  min={HEIGHT_RANGE.min}
                  max={HEIGHT_RANGE.max}
                  value={filters?.heightRange?.max || HEIGHT_RANGE.default.max}
                  onChange={(e) => handleHeightChange('max', e.target.value)}
                  className="w-16 text-center text-lg font-bold text-purple-700 focus:outline-none bg-transparent"
                />
              </div>
            </div>
            <div className="px-2">
              <Slider
                value={[
                  filters?.heightRange?.min || HEIGHT_RANGE.default.min,
                  filters?.heightRange?.max || HEIGHT_RANGE.default.max,
                ]}
                min={HEIGHT_RANGE.min}
                max={HEIGHT_RANGE.max}
                step={1}
                onValueChange={(value) =>
                  onFiltersChange({
                    ...filters,
                    heightRange: { min: value[0], max: value[1] },
                  })
                }
                className="h-5 [&>span]:bg-gradient-to-r [&>span]:from-purple-500 [&>span]:to-pink-500"
                dir="rtl"
              />
              <div className="flex justify-between mt-3 px-2 text-xs text-gray-500">
                <span>{HEIGHT_RANGE.min}</span>
                <span>{HEIGHT_RANGE.max}</span>
              </div>
            </div>
          </div>
        </div>
        {[
          {
            label: dict.religiousLevelLabel,
            icon: <Scroll className="w-5 h-5 text-amber-600" />,
            filterKey: 'religiousLevel',
            options: RELIGIOUS_LEVELS,
            placeholder: dict.placeholders.selectReligious,
            hoverColor: 'amber',
          },
          {
            label: dict.cityLabel,
            icon: <MapPin className="w-5 h-5 text-emerald-600" />,
            filterKey: 'cities',
            options: POPULAR_CITIES.map((c) => ({ label: c, value: c })),
            placeholder: dict.placeholders.selectCity,
            hoverColor: 'emerald',
          },
        ].map(
          ({ label, icon, filterKey, options, placeholder, hoverColor }) => (
            <div key={filterKey} className="space-y-3">
              <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
                {icon}
                {label}
              </Label>
              <div className="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-gray-100/50">
                <Select
                  value={
                    filterKey === 'cities'
                      ? filters.cities?.[0] || ''
                      : (filters[filterKey as keyof FilterState] as string) ||
                        ''
                  }
                  onValueChange={(value) => {
                    const newValue = value === 'all' ? undefined : value;
                    if (filterKey === 'cities') {
                      onFiltersChange({
                        ...filters,
                        cities: newValue ? [newValue] : [],
                      });
                    } else {
                      onFiltersChange({ ...filters, [filterKey]: newValue });
                    }
                  }}
                >
                  <SelectTrigger
                    className={`w-full border-0 bg-transparent focus:ring-2 focus:ring-${hoverColor}-200 rounded-xl`}
                  >
                    <SelectValue placeholder={placeholder} />
                  </SelectTrigger>
                  <SelectContent className="bg-white/95 backdrop-blur-sm border-0 shadow-2xl rounded-xl">
                    <SelectItem
                      value="all"
                      className={`hover:bg-${hoverColor}-50`}
                    >
                      {dict.options.all}
                    </SelectItem>
                    {options.map((opt) => (
                      <SelectItem
                        key={opt.value}
                        value={opt.value}
                        className={`hover:bg-${hoverColor}-50`}
                      >
                        {opt.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          )
        )}
        <div className="space-y-4 pt-4 border-t border-gray-200/50">
          {[
            {
              key: 'isVerified',
              label: dict.verifiedOnlyLabel,
              icon: <Shield className="w-4 h-4" />,
              gradient: 'from-emerald-500 to-green-500',
            },
            {
              key: 'hasReferences',
              label: dict.withRecommendationsLabel,
              icon: <Award className="w-4 h-4" />,
              gradient: 'from-amber-500 to-orange-500',
            },
            {
              key: 'isProfileComplete',
              label: dict.fullProfileLabel,
              icon: <Star className="w-4 h-4" />,
              gradient: 'from-purple-500 to-indigo-500',
            },
          ].map((item) => (
            <div
              key={item.key}
              className="flex items-center justify-between p-4 bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100/50 hover:bg-white/80 transition-all duration-300"
            >
              <div className="flex items-center gap-3">
                <div
                  className={cn(
                    'p-2 rounded-lg bg-gradient-to-r text-white',
                    item.gradient
                  )}
                >
                  {item.icon}
                </div>
                <span className="font-medium text-gray-800">{item.label}</span>
              </div>
              <Switch
                checked={
                  (filters?.[item.key as keyof typeof filters] as boolean) ||
                  false
                }
                onCheckedChange={(checked) =>
                  onFiltersChange({
                    ...filters,
                    [item.key]: checked || undefined,
                  })
                }
                className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-emerald-500 data-[state=checked]:to-green-500"
              />
            </div>
          ))}
        </div>
      </div>
    </motion.div>
  );
};

// Main Component
const FilterPanel: React.FC<FilterPanelProps> = ({
  filters,
  onFiltersChange,
  onSavePreset,
  onReset,
  onApplySavedFilter,
  savedFilters = [],
  className,
  compactMode = false,
  separateFiltering = false,
  onToggleSeparateFiltering,
  onMaleFiltersChange,
  onFemaleFiltersChange,
  onCopyFilters,
  dict,
}) => {
  const [showSavePreset, setShowSavePreset] = useState(false);
  const [presetName, setPresetName] = useState('');
  const [activeTab, setActiveTab] = useState<string>('basic');
  const [activeGenderFilter, setActiveGenderFilter] = useState<
    'male' | 'female'
  >('male');

  const POPULAR_FILTERS: PopularFilterOption[] = [
    {
      id: 'activeRecently',
      label: dict.popularFilters.activeRecently,
      icon: <Activity className="w-4 h-4" />,
      filter: { lastActiveDays: 7 },
      gradient: 'from-blue-500 to-cyan-500',
    },
    {
      id: 'verifiedOnly',
      label: dict.popularFilters.verifiedOnly,
      icon: <Shield className="w-4 h-4" />,
      filter: { isVerified: true },
      gradient: 'from-emerald-500 to-green-500',
    },
    {
      id: 'withRecommendations',
      label: dict.popularFilters.withRecommendations,
      icon: <Award className="w-4 h-4" />,
      filter: { hasReferences: true },
      gradient: 'from-amber-500 to-orange-500',
    },
    {
      id: 'availableOnly',
      label: dict.popularFilters.availableOnly,
      icon: <Heart className="w-4 h-4" />,
      filter: { availabilityStatus: 'AVAILABLE' },
      gradient: 'from-pink-500 to-rose-500',
    },
    {
      id: 'completeProfiles',
      label: dict.popularFilters.completeProfiles,
      icon: <Star className="w-4 h-4" />,
      filter: { isProfileComplete: true },
      gradient: 'from-purple-500 to-indigo-500',
    },
  ];

  const handleSavePreset = () => {
    if (presetName && onSavePreset) {
      onSavePreset(presetName);
      setPresetName('');
      setShowSavePreset(false);
    }
  };
  const handleAgeRangeChange = (value: number[]) => {
    onFiltersChange({ ...filters, ageRange: { min: value[0], max: value[1] } });
  };
  const handleHeightRangeChange = (value: number[]) => {
    onFiltersChange({
      ...filters,
      heightRange: { min: value[0], max: value[1] },
    });
  };
  const handleApplyPopularFilter = (filter: Partial<CandidatesFilter>) => {
    onFiltersChange({ ...filters, ...filter });
  };

  const countActiveFilters = (category: string): number => {
    let count = 0;
    const defaultFilters = DEFAULT_FILTER_STATE;
  
    switch (category) {
      case 'basic':
        if (filters.gender) count++;
        if (
          filters.ageRange &&
          (filters.ageRange.min !== defaultFilters.ageRange?.min ||
            filters.ageRange.max !== defaultFilters.ageRange?.max)
        )
          count++;
        if (filters.cities && filters.cities.length > 0) count++;
        if (filters.religiousLevel) count++;
        break;
  
      case 'advanced':
        if (
          filters.heightRange &&
          (filters.heightRange.min !== defaultFilters.heightRange?.min ||
            filters.heightRange.max !== defaultFilters.heightRange?.max)
        )
          count++;
        if (filters.occupations && filters.occupations.length > 0) count++;
        if (filters.educationLevel) count++;
        if (filters.maritalStatus) count++;
        break;
  
      case 'status':
        if (filters.availabilityStatus) count++;
        if (filters.isVerified) count++;
        if (filters.hasReferences) count++;
        if (filters.lastActiveDays) count++;
        if (filters.isProfileComplete) count++;
        if (filters.userStatus) count++;
        break;
    }
    return count;
  };

  return (
    <Card
      className={cn(
        'shadow-2xl border-0 bg-gradient-to-br from-white via-purple-50/20 to-pink-50/10 backdrop-blur-sm rounded-3xl overflow-hidden',
        className
      )}
    >
      <div className="absolute inset-0 -z-10">
        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-3xl"></div>
        <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-blue-200/20 to-cyan-200/20 rounded-full blur-2xl"></div>
      </div>
      <div className="relative">
        {!compactMode && (
          <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                  <FilterIcon className="w-8 h-8 text-white" />
                </div>
                <div>
                  <h3 className="text-2xl font-bold text-white">
                    {dict.header.title}
                  </h3>
                  <p className="text-white/80 mt-1">{dict.header.subtitle}</p>
                </div>
              </div>
              <div className="flex gap-3">
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={onReset}
                        className="h-10 w-10 p-0 text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-110"
                      >
                        <RefreshCw className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>{dict.header.resetTooltip}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setShowSavePreset(!showSavePreset)}
                        className="h-10 w-10 p-0 text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-110"
                      >
                        <Bookmark className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>{dict.header.saveTooltip}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
            </div>
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
              {POPULAR_FILTERS.map((option) => (
                <motion.div
                  key={option.id}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => handleApplyPopularFilter(option.filter)}
                    className={cn(
                      'w-full h-auto min-h-24 p-3 bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-xl transition-all duration-300 text-white flex flex-col items-center gap-2'
                    )}
                  >
                    <div
                      className={cn(
                        'p-2 rounded-lg bg-gradient-to-r',
                        option.gradient,
                        'text-white shadow-lg'
                      )}
                    >
                      {option.icon}
                    </div>
                    <span className="text-xs font-medium text-center leading-tight whitespace-normal">
                      {option.label}
                    </span>
                  </Button>
                </motion.div>
              ))}
            </div>
          </div>
        )}
        <AnimatePresence>
          {showSavePreset && !compactMode && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="bg-gradient-to-r from-blue-50 via-purple-50 to-pink-50 border-b border-purple-100"
            >
              <div className="p-6">
                <Label className="text-lg font-bold text-gray-800 mb-3 block">
                  {dict.savePreset.title}
                </Label>
                <div className="flex gap-3">
                  <Input
                    value={presetName}
                    onChange={(e) => setPresetName(e.target.value)}
                    placeholder={dict.savePreset.placeholder}
                    className="flex-1 border-0 bg-white/80 backdrop-blur-sm shadow-lg rounded-xl focus:ring-2 focus:ring-purple-300"
                  />
                  <Button
                    size="sm"
                    onClick={handleSavePreset}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg rounded-xl px-6"
                  >
                    <Save className="w-4 h-4 mr-2" />
                    {dict.savePreset.button}
                  </Button>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
        <div className="p-6 bg-gradient-to-r from-indigo-50/50 via-purple-50/30 to-pink-50/50 border-b border-purple-100/50">
          <motion.div
            className="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/50"
            whileHover={{ scale: 1.02 }}
          >
            <div className="flex items-center justify-between">
              <div className="space-y-2">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                    <Zap className="w-5 h-5" />
                  </div>
                  <div className="font-bold text-lg bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    {dict.separateFiltering.title}
                  </div>
                </div>
                <p className="text-sm text-gray-600 mr-10">
                  {dict.separateFiltering.description}
                </p>
              </div>
              <div className="flex items-center gap-3">
                <Switch
                  checked={separateFiltering}
                  onCheckedChange={onToggleSeparateFiltering}
                  className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-indigo-500 data-[state=checked]:to-purple-500"
                />
              </div>
            </div>
          </motion.div>
        </div>
        <div className="p-6">
          {separateFiltering ? (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-white via-gray-50/30 to-white rounded-2xl p-2 shadow-lg border border-gray-100/50">
                <div className="grid grid-cols-2 gap-1">
                  <Button
                    type="button"
                    variant={
                      activeGenderFilter === 'male' ? 'default' : 'ghost'
                    }
                    onClick={() => setActiveGenderFilter('male')}
                    className={cn(
                      'rounded-xl py-3 transition-all duration-300',
                      activeGenderFilter === 'male'
                        ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-blue-50'
                    )}
                  >
                    <Target className="w-5 h-5 mr-2" />
                    {dict.genderFilterPanel.maleTitle}
                  </Button>
                  <Button
                    type="button"
                    variant={
                      activeGenderFilter === 'female' ? 'default' : 'ghost'
                    }
                    onClick={() => setActiveGenderFilter('female')}
                    className={cn(
                      'rounded-xl py-3 transition-all duration-300',
                      activeGenderFilter === 'female'
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-purple-50'
                    )}
                  >
                    <Crown className="w-5 h-5 mr-2" />
                    {dict.genderFilterPanel.femaleTitle}
                  </Button>
                </div>
              </div>
              <AnimatePresence mode="wait">
                {activeGenderFilter === 'male' ? (
                  <motion.div
                    key="male"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.3 }}
                  >
                    <GenderFilterPanel
                      gender="male"
                      filters={filters.maleFilters || {}}
                      onFiltersChange={onMaleFiltersChange || (() => {})}
                      copyTarget="female"
                      onCopyFilters={onCopyFilters}
                      dict={dict.genderFilterPanel}
                    />
                  </motion.div>
                ) : (
                  <motion.div
                    key="female"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                    transition={{ duration: 0.3 }}
                  >
                    <GenderFilterPanel
                      gender="female"
                      filters={filters.femaleFilters || {}}
                      onFiltersChange={onFemaleFiltersChange || (() => {})}
                      copyTarget="male"
                      onCopyFilters={onCopyFilters}
                      dict={dict.genderFilterPanel}
                    />
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          ) : (
            <Tabs
              value={activeTab}
              onValueChange={setActiveTab}
              className="w-full"
            >
              <TabsList className="grid grid-cols-4 w-full bg-gradient-to-r from-indigo-50 to-purple-50 p-2 rounded-2xl shadow-lg border border-white/50 h-auto">
                {[
                  {
                    value: 'basic',
                    label: dict.tabs.basic,
                    icon: User,
                    gradient: 'from-blue-500 to-cyan-500',
                  },
                  {
                    value: 'advanced',
                    label: dict.tabs.advanced,
                    icon: Sparkles,
                    gradient: 'from-purple-500 to-pink-500',
                  },
                  {
                    value: 'status',
                    label: dict.tabs.status,
                    icon: Activity,
                    gradient: 'from-emerald-500 to-green-500',
                  },
                  {
                    value: 'saved',
                    label: dict.tabs.saved,
                    icon: Bookmark,
                    gradient: 'from-amber-500 to-orange-500',
                  },
                ].map((tab) => {
                  const IconComponent = tab.icon;
                  const count = countActiveFilters(tab.value);
                  return (
                    <TabsTrigger
                      key={tab.value}
                      value={tab.value}
                      className={cn(
                        'flex flex-col items-center justify-center gap-2 rounded-xl text-sm font-bold transition-all duration-300 py-3 hover:scale-105 relative overflow-hidden group data-[state=active]:shadow-lg',
                        activeTab === tab.value
                          ? `bg-gradient-to-r ${tab.gradient} text-white`
                          : 'text-gray-600 hover:bg-white/50'
                      )}
                    >
                      <IconComponent className="w-5 h-5" />
                      <span>{tab.label}</span>
                      {count > 0 && (
                        <Badge className="absolute -top-1 -right-1 h-6 w-6 p-0 flex items-center justify-center bg-red-500 text-white text-xs font-bold rounded-full border-2 border-white">
                          {count}
                        </Badge>
                      )}
                    </TabsTrigger>
                  );
                })}
              </TabsList>
              <div className="mt-6 space-y-6">
                <TabsContent value="basic" className="space-y-6 m-0">
                  <FilterSection
                    title={dict.sections.gender}
                    icon={<User className="w-5 h-5" />}
                    defaultOpen={true}
                    gradient="from-blue-500 to-cyan-500"
                  >
                    <div className="grid grid-cols-2 gap-4">
                      {[
                        {
                          value: 'MALE',
                          label: dict.buttons.male,
                          gradient: 'from-blue-500 to-cyan-500',
                        },
                        {
                          value: 'FEMALE',
                          label: dict.buttons.female,
                          gradient: 'from-purple-500 to-pink-500',
                        },
                      ].map((option) => (
                        <Button
                          key={option.value}
                          type="button"
                          variant={
                            filters.gender === option.value
                              ? 'default'
                              : 'outline'
                          }
                          onClick={() =>
                            onFiltersChange({
                              ...filters,
                              gender: option.value as 'MALE' | 'FEMALE',
                            })
                          }
                          className={cn(
                            'h-12 rounded-xl font-bold transition-all duration-300 hover:scale-105',
                            filters.gender === option.value
                              ? `bg-gradient-to-r ${option.gradient} text-white shadow-lg hover:shadow-xl`
                              : 'bg-white/80 backdrop-blur-sm border-2 border-gray-200 hover:border-gray-300'
                          )}
                        >
                          {option.label}
                        </Button>
                      ))}
                    </div>
                    {filters.gender && (
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() =>
                          onFiltersChange({ ...filters, gender: undefined })
                        }
                        className="w-full mt-3 text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-xl"
                      >
                        {dict.buttons.removeSelection}
                      </Button>
                    )}
                  </FilterSection>
                  <FilterSection
                    title={dict.sections.age}
                    icon={<Calendar className="w-5 h-5" />}
                    defaultOpen={true}
                    gradient="from-emerald-500 to-green-500"
                    badge={
                      filters.ageRange &&
                      (filters.ageRange.min !== AGE_RANGE.default.min ||
                        filters.ageRange.max !== AGE_RANGE.default.max)
                        ? 1
                        : undefined
                    }
                  >
                    <div className="space-y-6">
                      <div className="flex justify-between items-center">
                        <div className="text-center bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-emerald-600 mb-1 font-medium">
                            {dict.genderFilterPanel.minLabel}
                          </p>
                          <input
                            type="number"
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={
                              filters.ageRange?.min || AGE_RANGE.default.min
                            }
                            onChange={(e) => {
                              const newMin = parseInt(e.target.value);
                              if (
                                !isNaN(newMin) &&
                                newMin >= AGE_RANGE.min &&
                                newMin <= AGE_RANGE.max
                              ) {
                                const currentMax =
                                  filters.ageRange?.max ||
                                  AGE_RANGE.default.max;
                                onFiltersChange({
                                  ...filters,
                                  ageRange: {
                                    min: Math.min(newMin, currentMax),
                                    max: currentMax,
                                  },
                                });
                              }
                            }}
                            className="w-16 text-center text-lg font-bold text-emerald-700 focus:outline-none bg-transparent"
                          />
                        </div>
                        <span className="text-xl font-bold text-gray-400">
                          -
                        </span>
                        <div className="text-center bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-emerald-600 mb-1 font-medium">
                            {dict.genderFilterPanel.maxLabel}
                          </p>
                          <input
                            type="number"
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={
                              filters.ageRange?.max || AGE_RANGE.default.max
                            }
                            onChange={(e) => {
                              const newMax = parseInt(e.target.value);
                              if (
                                !isNaN(newMax) &&
                                newMax >= AGE_RANGE.min &&
                                newMax <= AGE_RANGE.max
                              ) {
                                const currentMin =
                                  filters.ageRange?.min ||
                                  AGE_RANGE.default.min;
                                onFiltersChange({
                                  ...filters,
                                  ageRange: {
                                    min: currentMin,
                                    max: Math.max(currentMin, newMax),
                                  },
                                });
                              }
                            }}
                            className="w-16 text-center text-lg font-bold text-emerald-700 focus:outline-none bg-transparent"
                          />
                        </div>
                      </div>
                      <div className="px-3">
                        <Slider
                          value={[
                            filters.ageRange?.min || AGE_RANGE.default.min,
                            filters.ageRange?.max || AGE_RANGE.default.max,
                          ]}
                          min={AGE_RANGE.min}
                          max={AGE_RANGE.max}
                          step={1}
                          onValueChange={handleAgeRangeChange}
                          className="h-6 [&>span]:bg-gradient-to-r [&>span]:from-emerald-500 [&>span]:to-green-500"
                          dir="rtl"
                        />
                        <div className="flex justify-between mt-2 px-1 text-xs text-gray-500">
                          <span>{AGE_RANGE.min}</span>
                          <span>{AGE_RANGE.max}</span>
                        </div>
                      </div>
                    </div>
                  </FilterSection>
                </TabsContent>
                <TabsContent value="advanced" className="space-y-6 m-0">
                  <FilterSection
                    title={dict.sections.height}
                    icon={<Ruler className="w-5 h-5" />}
                    gradient="from-indigo-500 to-purple-500"
                    badge={
                      filters.heightRange &&
                      (filters.heightRange.min !== HEIGHT_RANGE.default.min ||
                        filters.heightRange.max !== HEIGHT_RANGE.default.max)
                        ? 1
                        : undefined
                    }
                  >
                    <div className="space-y-6">
                      <div className="flex justify-between items-center">
                        <div className="text-center bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-indigo-600 mb-1 font-medium">
                            {dict.genderFilterPanel.minLabel}
                          </p>
                          <input
                            type="number"
                            min={HEIGHT_RANGE.min}
                            max={HEIGHT_RANGE.max}
                            value={
                              filters.heightRange?.min ||
                              HEIGHT_RANGE.default.min
                            }
                            onChange={(e) => {
                              const newMin = parseInt(e.target.value);
                              if (
                                !isNaN(newMin) &&
                                newMin >= HEIGHT_RANGE.min &&
                                newMin <= HEIGHT_RANGE.max
                              ) {
                                const currentMax =
                                  filters.heightRange?.max ||
                                  HEIGHT_RANGE.default.max;
                                onFiltersChange({
                                  ...filters,
                                  heightRange: {
                                    min: Math.min(newMin, currentMax),
                                    max: currentMax,
                                  },
                                });
                              }
                            }}
                            className="w-16 text-center text-lg font-bold text-indigo-700 focus:outline-none bg-transparent"
                          />
                        </div>
                        <span className="text-xl font-bold text-gray-400">
                          -
                        </span>
                        <div className="text-center bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-indigo-600 mb-1 font-medium">
                            {dict.genderFilterPanel.maxLabel}
                          </p>
                          <input
                            type="number"
                            min={HEIGHT_RANGE.min}
                            max={HEIGHT_RANGE.max}
                            value={
                              filters.heightRange?.max ||
                              HEIGHT_RANGE.default.max
                            }
                            onChange={(e) => {
                              const newMax = parseInt(e.target.value);
                              if (
                                !isNaN(newMax) &&
                                newMax >= HEIGHT_RANGE.min &&
                                newMax <= HEIGHT_RANGE.max
                              ) {
                                const currentMin =
                                  filters.heightRange?.min ||
                                  HEIGHT_RANGE.default.min;
                                onFiltersChange({
                                  ...filters,
                                  heightRange: {
                                    min: currentMin,
                                    max: Math.max(currentMin, newMax),
                                  },
                                });
                              }
                            }}
                            className="w-16 text-center text-lg font-bold text-indigo-700 focus:outline-none bg-transparent"
                          />
                        </div>
                      </div>
                      <div className="px-3">
                        <Slider
                          value={[
                            filters.heightRange?.min ||
                              HEIGHT_RANGE.default.min,
                            filters.heightRange?.max ||
                              HEIGHT_RANGE.default.max,
                          ]}
                          min={HEIGHT_RANGE.min}
                          max={HEIGHT_RANGE.max}
                          step={1}
                          onValueChange={handleHeightRangeChange}
                          className="h-6 [&>span]:bg-gradient-to-r [&>span]:from-indigo-500 [&>span]:to-purple-500"
                          dir="rtl"
                        />
                    <div className="flex justify-between mt-2 px-1 text-xs text-gray-500">
  <span>{HEIGHT_RANGE.min} ס&quot;מ</span>
  <span>{HEIGHT_RANGE.max} ס&quot;מ</span>
</div>
                      </div>
                    </div>
                  </FilterSection>
                </TabsContent>
                <TabsContent value="saved" className="space-y-6 m-0">
                  {savedFilters.length === 0 ? (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="text-center py-12 bg-gradient-to-br from-white via-gray-50/30 to-white rounded-2xl shadow-xl border border-gray-100/50"
                    >
                      <div className="w-20 h-20 rounded-full bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center mx-auto mb-6">
                        <Bookmark className="w-10 h-10 text-amber-500" />
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 mb-3">
                        {dict.savedFilters.emptyState.title}
                      </h3>
                      <p className="text-gray-600 mb-6 max-w-sm mx-auto">
                        {dict.savedFilters.emptyState.description}
                      </p>
                      <Button
                        onClick={() => setShowSavePreset(true)}
                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white shadow-lg rounded-xl px-6"
                      >
                        <Save className="w-4 h-4 mr-2" />
                        {dict.savedFilters.emptyState.saveCurrentButton}
                      </Button>
                    </motion.div>
                  ) : (
                    <SavedFilters
                      filters={savedFilters.map((filter) => ({
                        id: filter.id,
                        name: filter.name,
                        filter: {},
                        isDefault: filter.isDefault,
                        createdAt: new Date(),
                      }))}
                      activeFilterId={filters.savedFilterId}
                      onSelect={(filter) => onApplySavedFilter?.(filter.id)}
                      onDelete={() => {}}
                      onEdit={() => {}}
                      onSetDefault={() => {}}
                      dict={dict.savedFilters}
                    />
                  )}
                </TabsContent>
              </div>
            </Tabs>
          )}
        </div>
        <div className="px-6 pb-6">
          <div className="flex justify-between items-center pt-6 border-t border-gray-200/50">
            <Button
              variant="outline"
              size={compactMode ? 'sm' : 'default'}
              onClick={onReset}
              className="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 text-red-600 hover:from-red-100 hover:to-pink-100 rounded-xl transition-all duration-300 hover:scale-105"
            >
              <RefreshCw className="w-4 h-4 mr-2" />
              {dict.buttons.reset}
            </Button>
            {!compactMode && (
              <Button
                onClick={() => setShowSavePreset(true)}
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg rounded-xl px-6 transition-all duration-300 hover:scale-105"
              >
                <Save className="w-4 h-4 mr-2" />
                {dict.buttons.save}
                <Sparkles className="w-3 h-3 ml-1" />
              </Button>
            )}
          </div>
        </div>
      </div>
    </Card>
  );
};
export default FilterPanel;
--- End of Content for FilterPanel.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\SavedFilters.tsx
--------------------------------------------------------------------------------
Content:
// SavedFilters.tsx - This file is correct. The issue lies in the UI component definitions.
'use client';
import React from 'react';
import {
  Star,
  MoreVertical,
  Edit,
  Trash,
  Crown,
  Bookmark,
  Calendar,
  Sparkles,
  Zap,
  Award,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { motion, AnimatePresence } from 'framer-motion';
import type { CandidatesFilter } from '../types/candidates';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface SavedFilter {
  id: string;
  name: string;
  filter: CandidatesFilter;
  isDefault?: boolean;
  createdAt: Date;
}

interface SavedFiltersProps {
  filters: SavedFilter[];
  activeFilterId?: string;
  onSelect: (filter: SavedFilter) => void;
  onDelete: (filterId: string) => void;
  onEdit: (filter: SavedFilter) => void;
  onSetDefault: (filterId: string) => void;
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['filterPanel']['savedFilters'];
}

// Enhanced filter summary function outside component for performance
const formatFilterSummary = (
  filter: CandidatesFilter,
  dict: SavedFiltersProps['dict']['filterCard']['summary']
): string => {
  const parts: string[] = [];

  if (filter.searchQuery) {
    parts.push(dict.search.replace('{{query}}', filter.searchQuery));
  }
  if (filter.gender) {
    parts.push(dict.gender.replace('{{gender}}', filter.gender));
  }
  if (filter.ageRange) {
    parts.push(
      `${dict.age} ${dict.ageValue.replace('{{min}}', String(filter.ageRange.min)).replace('{{max}}', String(filter.ageRange.max))}`
    );
  }
  if (filter.heightRange) {
    parts.push(
      `${dict.height} ${dict.heightValue.replace('{{min}}', String(filter.heightRange.min)).replace('{{max}}', String(filter.heightRange.max))}`
    );
  }
  if (filter.cities?.length) {
    if (filter.cities.length === 1) {
      parts.push(dict.city.replace('{{city}}', filter.cities[0]));
    } else {
      parts.push(
        dict.cities.replace('{{count}}', String(filter.cities.length))
      );
    }
  }
  if (filter.religiousLevel) {
    parts.push(dict.religiousLevel.replace('{{level}}', filter.religiousLevel));
  }
  if (filter.educationLevel) {
    parts.push(dict.educationLevel.replace('{{level}}', filter.educationLevel));
  }
  if (filter.maritalStatus) {
    parts.push(dict.maritalStatus.replace('{{status}}', filter.maritalStatus));
  }
  if (filter.occupations?.length) {
    if (filter.occupations.length === 1) {
      parts.push(
        dict.occupation.replace('{{occupation}}', filter.occupations[0])
      );
    } else {
      parts.push(
        dict.occupations.replace('{{count}}', String(filter.occupations.length))
      );
    }
  }
  if (filter.availabilityStatus) {
    const statusKey = filter.availabilityStatus as keyof typeof dict.statuses;
    parts.push(dict.status.replace('{{status}}', dict.statuses[statusKey]));
  }
  if (filter.isVerified) {
    parts.push(dict.verifiedOnly);
  }
  if (filter.hasReferences) {
    parts.push(dict.withRecommendations);
  }
  if (filter.isProfileComplete) {
    parts.push(dict.fullProfile);
  }
  if (filter.lastActiveDays) {
    let label;
    switch (filter.lastActiveDays) {
      case 1:
        label = dict.activeToday;
        break;
      case 7:
        label = dict.activeLastWeek;
        break;
      case 30:
        label = dict.activeLastMonth;
        break;
      default:
        label = dict.activeInDays.replace(
          '{{days}}',
          String(filter.lastActiveDays)
        );
    }
    parts.push(label);
  }
  if (filter.separateFiltering) {
    parts.push(dict.separateFiltering);
  }

  if (parts.length === 0) {
    return dict.noCriteria;
  }
  if (parts.length <= 3) {
    return parts.join(' • ');
  } else {
    return `${parts.slice(0, 2).join(' • ')} ${dict.andMore.replace('{{count}}', String(parts.length - 2))}`;
  }
};

const SavedFilters: React.FC<SavedFiltersProps> = ({
  filters,
  activeFilterId,
  onSelect,
  onDelete,
  onEdit,
  onSetDefault,
  className,
  dict,
}) => {
  const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat('he-IL', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
    }).format(date);
  };

  const getFilterComplexity = (
    filter: CandidatesFilter
  ): { score: number; label: string; color: string } => {
    const score = Object.keys(filter).filter(
      (key) => filter[key as keyof CandidatesFilter] !== undefined
    ).length;

    if (score <= 2)
      return {
        score,
        label: dict.filterCard.complexity.basic,
        color: 'from-green-500 to-emerald-500',
      };
    if (score <= 5)
      return {
        score,
        label: dict.filterCard.complexity.advanced,
        color: 'from-blue-500 to-cyan-500',
      };
    if (score <= 8)
      return {
        score,
        label: dict.filterCard.complexity.complex,
        color: 'from-purple-500 to-pink-500',
      };
    return {
      score,
      label: dict.filterCard.complexity.expert,
      color: 'from-amber-500 to-orange-500',
    };
  };

  return (
    <div className={cn('space-y-4', className)}>
      <div className="flex items-center justify-between p-4 bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 rounded-2xl shadow-lg border border-gray-100/50">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
            <Bookmark className="w-5 h-5" />
          </div>
          <div>
            <h3 className="text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
              {dict.header.title}
            </h3>
            <p className="text-sm text-gray-600">
              {dict.header.subtitle
                .replace('{{count}}', String(filters.length))
                .replace(
                  '{{label}}',
                  filters.length === 1
                    ? dict.header.singleFilter
                    : dict.header.multipleFilters
                )}
            </p>
          </div>
        </div>
        <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 shadow-lg px-3 py-1 font-bold">
          {filters.length}
        </Badge>
      </div>

      <ScrollArea className="h-[400px] rounded-2xl">
        <div className="space-y-3 p-1">
          <AnimatePresence>
            {filters.map((filter, index) => {
              const complexity = getFilterComplexity(filter.filter);
              const isActive = activeFilterId === filter.id;
              return (
                <motion.div
                  key={filter.id}
                  initial={{ opacity: 0, y: 20, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, y: -20, scale: 0.95 }}
                  transition={{
                    delay: index * 0.05,
                    type: 'spring',
                    stiffness: 300,
                    damping: 25,
                  }}
                  whileHover={{ scale: 1.02, y: -2 }}
                  className={cn(
                    'relative group cursor-pointer rounded-2xl overflow-hidden shadow-xl border-0 transition-all duration-300',
                    isActive
                      ? 'ring-4 ring-purple-400 ring-opacity-60 shadow-purple-200'
                      : 'shadow-gray-200 hover:shadow-2xl'
                  )}
                  onClick={() => onSelect(filter)}
                >
                  <div
                    className={cn(
                      'absolute inset-0 bg-gradient-to-br transition-opacity duration-300',
                      isActive
                        ? 'from-purple-50 via-pink-50/50 to-purple-50 opacity-90'
                        : 'from-white via-gray-50/30 to-white opacity-95 group-hover:opacity-100'
                    )}
                  />
                  <div className="relative z-10 p-5">
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        {filter.isDefault && (
                          <motion.div
                            initial={{ scale: 0 }}
                            animate={{ scale: 1 }}
                            className="p-2 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white shadow-lg"
                          >
                            <Crown className="w-4 h-4" />
                          </motion.div>
                        )}
                        <div
                          className={cn(
                            'p-2 rounded-full text-white shadow-lg bg-gradient-to-r',
                            complexity.color
                          )}
                        >
                          {complexity.score <= 2 ? (
                            <Star className="w-4 h-4" />
                          ) : complexity.score <= 5 ? (
                            <Sparkles className="w-4 h-4" />
                          ) : complexity.score <= 8 ? (
                            <Zap className="w-4 h-4" />
                          ) : (
                            <Award className="w-4 h-4" />
                          )}
                        </div>
                        <div className="flex-1">
                          <h4 className="font-bold text-lg text-gray-800 group-hover:text-purple-700 transition-colors">
                            {filter.name}
                          </h4>
                          <p className="text-sm text-gray-500 mt-1">
                            {formatFilterSummary(
                              filter.filter,
                              dict.filterCard.summary
                            )}
                          </p>
                        </div>
                      </div>
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button
                            variant="ghost"
                            size="sm"
                            className="h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-purple-100 rounded-full"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <MoreVertical className="h-4 w-4 text-gray-600" />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent
                          align="end"
                          className="bg-white/95 backdrop-blur-sm border-0 shadow-2xl rounded-xl"
                        >
                          <DropdownMenuItem
                            onClick={() => onEdit(filter)}
                            className="hover:bg-blue-50 rounded-lg"
                          >
                            <Edit className="mr-2 h-4 w-4 text-blue-600" />
                            <span className="text-blue-700">
                              {dict.filterCard.actions.edit}
                            </span>
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={() => onSetDefault(filter.id)}
                            disabled={filter.isDefault}
                            className="hover:bg-yellow-50 rounded-lg"
                          >
                            <Crown className="mr-2 h-4 w-4 text-yellow-600" />
                            <span className="text-yellow-700">
                              {filter.isDefault
                                ? dict.filterCard.actions.isDefault
                                : dict.filterCard.actions.setDefault}
                            </span>
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={() => onDelete(filter.id)}
                            className="hover:bg-red-50 rounded-lg"
                          >
                            <Trash className="mr-2 h-4 w-4 text-red-600" />
                            <span className="text-red-700">
                              {dict.filterCard.actions.delete}
                            </span>
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </div>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <Badge
                          className={cn(
                            'text-white border-0 shadow-lg font-bold px-3 py-1 bg-gradient-to-r',
                            complexity.color
                          )}
                        >
                          {complexity.label} •{' '}
                          {dict.filterCard.criteria.replace(
                            '{{count}}',
                            String(complexity.score)
                          )}
                        </Badge>
                        <div className="flex items-center gap-2 text-xs text-gray-500">
                          <Calendar className="w-3 h-3" />
                          <span>{formatDate(filter.createdAt)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="absolute inset-0 bg-gradient-to-r from-purple-400/0 via-pink-400/0 to-purple-400/0 group-hover:from-purple-400/10 group-hover:via-pink-400/10 group-hover:to-purple-400/10 transition-all duration-500 pointer-events-none rounded-2xl"></div>
                  {isActive && (
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      className="absolute top-3 left-3 w-3 h-3 bg-purple-500 rounded-full shadow-lg"
                    >
                      <div className="w-full h-full bg-purple-400 rounded-full animate-ping"></div>
                    </motion.div>
                  )}
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000 rounded-2xl"></div>
                </motion.div>
              );
            })}
          </AnimatePresence>
        </div>
      </ScrollArea>

      {filters.length === 0 && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center py-12 bg-gradient-to-br from-white via-gray-50/30 to-white rounded-2xl shadow-xl border border-gray-100/50"
        >
          <div className="w-20 h-20 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center mx-auto mb-6">
            <Bookmark className="w-10 h-10 text-purple-400" />
          </div>
          <h3 className="text-xl font-bold text-gray-800 mb-3">
            {dict.emptyState.title}
          </h3>
          <p className="text-gray-600 mb-6 max-w-sm mx-auto">
            {dict.emptyState.description}
          </p>
          <div className="flex flex-wrap gap-2 justify-center">
            <Badge
              variant="outline"
              className="bg-blue-50 text-blue-600 border-blue-200"
            >
              <Star className="w-3 h-3 mr-1" />
              {dict.emptyState.fastSearches}
            </Badge>
            <Badge
              variant="outline"
              className="bg-purple-50 text-purple-600 border-purple-200"
            >
              <Sparkles className="w-3 h-3 mr-1" />
              {dict.emptyState.advancedFiltering}
            </Badge>
            <Badge
              variant="outline"
              className="bg-green-50 text-green-600 border-green-200"
            >
              <Award className="w-3 h-3 mr-1" />
              {dict.emptyState.quickAccess}
            </Badge>
          </div>
        </motion.div>
      )}

      {filters.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-4 shadow-lg border border-gray-100/50"
        >
          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <div className="text-lg font-bold text-indigo-600">
                {filters.filter((f) => f.isDefault).length}
              </div>
              <div className="text-xs text-gray-600">{dict.stats.default}</div>
            </div>
            <div>
              <div className="text-lg font-bold text-purple-600">
                {
                  filters.filter((f) => getFilterComplexity(f.filter).score > 5)
                    .length
                }
              </div>
              <div className="text-xs text-gray-600">{dict.stats.advanced}</div>
            </div>
            <div>
              <div className="text-lg font-bold text-pink-600">
                {Math.round(
                  filters.reduce(
                    (acc, f) => acc + getFilterComplexity(f.filter).score,
                    0
                  ) / (filters.length || 1)
                )}
              </div>
              <div className="text-xs text-gray-600">
                {dict.stats.avgCriteria}
              </div>
            </div>
          </div>
        </motion.div>
      )}
    </div>
  );
};

export default SavedFilters;
--- End of Content for SavedFilters.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\SearchBar.tsx
--------------------------------------------------------------------------------
Content:
// SearchBar.tsx - גרסה סופית ומתקדמת עם תיקון z-index ו-RTL
'use client';

import React, { useState, useEffect, useRef } from 'react';
import {
  Search,
  X,
  History,
  Sparkles,
  Target,
  Crown,
  Star,
  TrendingUp,
  Zap,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { motion, AnimatePresence } from 'framer-motion';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Popover,
  PopoverContent,
  PopoverAnchor,
} from '@/components/ui/popover';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface SearchBarProps {
  value: string;
  onChange: (value: string) => void;
  onSelect?: (candidate: Candidate) => void;
  recentSearches?: string[];
  onSaveSearch?: (value: string) => void;
  onClearRecentSearches?: () => void;
  suggestions?: Candidate[];
  loading?: boolean;
  className?: string;
  placeholder?: string;
  autoFocus?: boolean;
  genderTarget?: 'male' | 'female' | 'all';
  separateMode?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['searchBar'];
}

const SearchBar: React.FC<SearchBarProps> = ({
  value,
  onChange,
  onSelect,
  recentSearches = [],
  onSaveSearch,
  onClearRecentSearches,
  suggestions = [],
  loading = false,
  className = '',
  placeholder, // We will now primarily use the placeholder from dict
  autoFocus = false,
  genderTarget = 'all',
  separateMode = false,
  dict,
}) => {
  const [inputValue, setInputValue] = useState(value);
  const [showDropdown, setShowDropdown] = useState(false);
  const [isHovered, setIsHovered] = useState(false);
  const [isFocused, setIsFocused] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    setInputValue(value);
  }, [value]);
  
  const searchCategories = [
    { id: 'name', label: dict.categories.name, icon: <Star className="w-3 h-3" />, gradient: 'from-blue-500 to-cyan-500' },
    { id: 'city', label: dict.categories.city, icon: <Target className="w-3 h-3" />, gradient: 'from-emerald-500 to-green-500' },
    { id: 'occupation', label: dict.categories.occupation, icon: <Zap className="w-3 h-3" />, gradient: 'from-purple-500 to-pink-500' },
    { id: 'all', label: dict.categories.all, icon: <Sparkles className="w-3 h-3" />, gradient: 'from-indigo-500 to-purple-500' },
  ];
  const [searchCategory, setSearchCategory] = useState<string>('all');


  const getSearchPlaceholder = () => {
    if (placeholder) return placeholder; // Allow override
    if (separateMode) {
      if (genderTarget === 'male') return dict.malePlaceholder;
      if (genderTarget === 'female') return dict.femalePlaceholder;
    }
    return dict.generalPlaceholder;
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setInputValue(newValue);
    onChange(newValue);
    if (!showDropdown) {
      setShowDropdown(true);
    }
  };

  const handleSearch = (searchValue: string) => {
    if (searchValue.trim()) {
      onChange(searchValue.trim());
      if (onSaveSearch) {
        onSaveSearch(searchValue.trim());
      }
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && inputValue.trim()) {
      handleSearch(inputValue);
      setShowDropdown(false);
    } else if (e.key === 'Escape') {
      setShowDropdown(false);
    }
  };

  const handleClear = () => {
    setInputValue('');
    onChange('');
    inputRef.current?.focus();
  };

  const handleSuggestionSelect = (candidate: Candidate) => {
    if (onSelect) {
      onSelect(candidate);
    } else {
      const searchText = `${candidate.firstName} ${candidate.lastName}`;
      setInputValue(searchText);
      onChange(searchText);
    }
    setShowDropdown(false);
  };

  const getStyling = () => {
    if (!separateMode || genderTarget === 'all') {
      return { gradient: 'from-indigo-500 via-purple-500 to-pink-500', ring: 'focus:ring-purple-200', badge: 'bg-gradient-to-r from-indigo-500 to-purple-500' };
    }
    if (genderTarget === 'male') {
      return { gradient: 'from-blue-500 to-cyan-500', ring: 'focus:ring-blue-200', badge: 'bg-gradient-to-r from-blue-500 to-cyan-500' };
    }
    return { gradient: 'from-purple-500 to-pink-500', ring: 'focus:ring-purple-200', badge: 'bg-gradient-to-r from-purple-500 to-pink-500' };
  };

  const styling = getStyling();

  return (
    <Popover open={showDropdown} onOpenChange={setShowDropdown}>
      <div className={cn('relative group', className)}>
        <PopoverAnchor asChild>
          <motion.div
            className={cn('relative flex items-center rounded-2xl shadow-xl transition-all duration-300 backdrop-blur-sm border-0', `bg-gradient-to-r from-white via-gray-50/30 to-white`, isFocused || isHovered ? 'shadow-2xl scale-[1.02]' : 'shadow-lg', isFocused && `ring-2 ${styling.ring}`)}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            whileHover={{ y: -2 }}
            transition={{ type: 'spring', stiffness: 400, damping: 25 }}
          >
            <div className={cn('absolute inset-0 bg-gradient-to-r opacity-5 rounded-2xl', styling.gradient)} />

            {separateMode && genderTarget !== 'all' && (
              <motion.div className="absolute left-4 top-1/2 -translate-y-1/2 z-10" initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ type: 'spring', stiffness: 500, damping: 25 }}>
                <Badge className={cn('text-white border-0 shadow-lg font-bold px-3 py-1.5 rounded-xl', styling.badge)}>
                  <div className="flex items-center gap-2">
                    {genderTarget === 'male' ? <Target className="w-4 h-4" /> : <Crown className="w-4 h-4" />}
                    {genderTarget === 'male' ? dict.tooltips.maleTarget : dict.tooltips.femaleTarget}
                  </div>
                </Badge>
              </motion.div>
            )}

            <input
              ref={inputRef}
              type="text"
              value={inputValue}
              onChange={handleInputChange}
              onKeyDown={handleKeyDown}
              onFocus={() => { setShowDropdown(true); setIsFocused(true); }}
              onBlur={() => setIsFocused(false)}
              placeholder={getSearchPlaceholder()}
              className={cn('w-full h-14 bg-transparent border-0 rounded-2xl text-lg font-medium relative z-10', 'placeholder:text-gray-500 text-gray-800', 'focus:outline-none transition-all duration-200', separateMode ? 'pl-32 pr-16' : 'pl-6 pr-16')}
              autoFocus={autoFocus}
              autoComplete="off"
              spellCheck="false"
            />

            <div className="absolute right-4 top-1/2 -translate-y-1/2 z-10">
              <motion.div
                animate={{ rotate: loading ? 360 : 0, scale: isHovered || isFocused ? 1.1 : 1 }}
                transition={{ rotate: { duration: 1, repeat: loading ? Infinity : 0, ease: 'linear' }, scale: { duration: 0.2 } }}
                className={cn('p-2.5 rounded-full text-white shadow-lg', `bg-gradient-to-r ${styling.gradient}`)}
              >
                <Search className="w-5 h-5" />
              </motion.div>
            </div>

            <AnimatePresence>
              {inputValue && (
                <motion.div initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.8 }} className={cn('absolute top-1/2 -translate-y-1/2 z-10', separateMode ? 'left-32' : 'left-4')}>
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <button type="button" onClick={handleClear} className="w-7 h-7 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-md">
                          <X className="w-4 h-4 text-gray-600" />
                        </button>
                      </TooltipTrigger>
                      <TooltipContent><p>{dict.clearTooltip}</p></TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </motion.div>
              )}
            </AnimatePresence>

            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000 rounded-2xl pointer-events-none"></div>
          </motion.div>
        </PopoverAnchor>
      </div>

      <PopoverContent onOpenAutoFocus={(e) => e.preventDefault()} className="w-[--radix-popover-trigger-width] p-0 mt-2 z-[99] border-0 shadow-2xl rounded-2xl overflow-hidden bg-white/95 backdrop-blur-xl">
        <div className={cn('p-4 bg-gradient-to-r text-white', styling.gradient)}>
          <div className="flex items-center justify-between mb-3 text-right">
            <div className="text-sm opacity-90">{dict.resultsCount.replace('{{count}}', String(suggestions.length))}</div>
            <div className="flex items-center gap-2">
              <span className="font-bold">{dict.smartSearch}</span>
              <Sparkles className="w-5 h-5" />
            </div>
          </div>
          <div className="relative">
            <Search className="absolute right-3 top-2.5 h-4 w-4 text-white/70" />
            <input
              type="text"
              value={inputValue}
              onChange={handleInputChange}
              className="w-full bg-white/20 backdrop-blur-sm border border-white/30 rounded-xl px-4 pr-10 py-2 text-sm text-white placeholder:text-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-right"
              placeholder={dict.filterResultsPlaceholder}
            />
          </div>
        </div>

        <div className="max-h-96 overflow-y-auto">
          {loading === false && suggestions.length === 0 && recentSearches.length === 0 && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="p-8 text-center">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4"><Search className="w-8 h-8 text-gray-400" /></div>
              <h3 className="font-bold text-gray-800 mb-2">{dict.noResultsTitle}</h3>
              <p className="text-sm text-gray-500">{dict.noResultsDescription}</p>
            </motion.div>
          )}

          {loading === true && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="p-8 text-center">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4"><Search className="w-8 h-8 text-gray-400 animate-pulse" /></div>
              <h3 className="font-bold text-gray-800 mb-2">מחפש...</h3>
              <p className="text-sm text-gray-500">אנא המתן...</p>
            </motion.div>
          )}

          {recentSearches.length > 0 && (
            <div className="border-b border-gray-100">
              <div className="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100/50">
                <div className="flex justify-between items-center">
                  {onClearRecentSearches && (<Button variant="ghost" size="sm" onClick={(e) => { e.stopPropagation(); onClearRecentSearches(); }} className="h-6 text-xs text-gray-500 hover:text-gray-700 px-2">{dict.clearHistory}</Button>)}
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-gray-700">{dict.recentSearches}</span>
                    <History className="w-4 h-4 text-gray-500" />
                  </div>
                </div>
              </div>
              <div className="p-2">
                {recentSearches.slice(0, 5).map((search, index) => (
                  <motion.div key={`recent-${index}`} initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: index * 0.05 }} className="flex items-center gap-3 px-3 py-2.5 hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 rounded-xl cursor-pointer transition-all duration-200 group" onClick={() => { handleSearch(search); setShowDropdown(false); }}>
                    <div className="ml-auto opacity-0 group-hover:opacity-100 transition-opacity"><Zap className="w-3 h-3 text-blue-500" /></div>
                    <span className="text-sm font-medium text-gray-700 group-hover:text-blue-700">{search}</span>
                    <div className="p-1.5 rounded-lg bg-gradient-to-r from-blue-100 to-cyan-100 group-hover:from-blue-200 group-hover:to-cyan-200 transition-all duration-200"><History className="h-3 w-3 text-blue-600" /></div>
                  </motion.div>
                ))}
              </div>
            </div>
          )}

          {suggestions.length > 0 && (
            <div>
              <div className="px-4 py-3 bg-gradient-to-r from-emerald-50 to-green-50 border-b border-gray-100">
                <div className="flex items-center justify-end gap-2">
                  <span className="text-sm font-medium text-emerald-800">{dict.matchingResults.replace('{{count}}', String(suggestions.length))}</span>
                  <Star className="w-4 h-4 text-emerald-600" />
                </div>
              </div>
              <div className="p-2 space-y-1">
                {suggestions.map((candidate, index) => (
                  <motion.div key={candidate.id} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: index * 0.05 }} className="flex items-center gap-3 px-3 py-3 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 rounded-xl cursor-pointer transition-all duration-200 group" onClick={() => handleSuggestionSelect(candidate)}>
                    <div className="opacity-0 group-hover:opacity-100 transition-opacity"><div className="p-1.5 rounded-lg bg-gradient-to-r from-purple-100 to-pink-100"><Sparkles className="w-3 h-3 text-purple-600" /></div></div>
                    <div className="flex-1 min-w-0 text-right">
                      <div className="font-medium text-gray-800 group-hover:text-purple-700 transition-colors">{`${candidate.firstName} ${candidate.lastName}`}</div>
                      <div className="text-xs text-gray-500 truncate mt-0.5">{[candidate.profile.city, candidate.profile.occupation, candidate.profile.religiousLevel].filter(Boolean).join(' • ')}</div>
                    </div>
                    <div className="relative">
                      <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
                        <span className="text-sm font-bold text-purple-600">{candidate.firstName.charAt(0)}{candidate.lastName.charAt(0)}</span>
                      </div>
                      {candidate.isVerified && (<div className="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-emerald-500 to-green-500 rounded-full flex items-center justify-center"><Star className="w-2 h-2 text-white" /></div>)}
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          )}

          <div className="md:hidden border-t border-gray-100">
            <div className="px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50">
              <div className="flex items-center justify-end gap-2 mb-3">
                <span className="text-sm font-medium text-indigo-800">חפש לפי קטגוריה</span>
                <TrendingUp className="w-4 h-4 text-indigo-600" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                {searchCategories.map((category) => (
                  <motion.div key={category.id} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                    <Button variant={searchCategory === category.id ? 'default' : 'outline'} size="sm" className={cn('w-full justify-start gap-2 rounded-xl transition-all duration-200', searchCategory === category.id ? `bg-gradient-to-r ${category.gradient} text-white shadow-lg border-0` : 'bg-white/80 hover:bg-white border border-gray-200 hover:border-gray-300')} onClick={() => setSearchCategory(category.id)}>
                      {category.icon}
                      <span className="text-xs">{category.label}</span>
                    </Button>
                  </motion.div>
                ))}
              </div>
            </div>
          </div>

          <div className="p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 border-t border-gray-100">
            <div className="flex items-start gap-2 text-right">
              <Sparkles className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
              <div className="text-xs text-gray-600 leading-relaxed"><span className="font-medium">{dict.tip}</span> {dict.tipContent}</div>
            </div>
          </div>
        </div>
      </PopoverContent>
    </Popover>
  );
};

export default SearchBar;
--- End of Content for SearchBar.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants\filterOptions.ts
--------------------------------------------------------------------------------
Content:
// /constants/filterOptions.ts
import { AvailabilityStatus } from '@prisma/client';

export const AGE_RANGE = {
  min: 18,
  max: 99,
  default: {
    min: 20,
    max: 35
  }
};

export const HEIGHT_RANGE = {
  min: 140,
  max: 210,
  default: {
    min: 150,
    max: 190
  }
};

export const RELIGIOUS_LEVELS = [
  { value: "charedi", label: "חרדי/ת" },
  { value: "charedi_modern", label: "חרדי/ת מודרני/ת" },
  { value: "dati_leumi_torani", label: "דתי/ה לאומי/ת תורני/ת" },
  { value: "dati_leumi_liberal", label: "דתי/ה לאומי/ת ליברלי/ת" },
  { value: "dati_leumi_standard", label: "דתי/ה לאומי/ת (סטנדרטי)" },
  { value: "masorti_strong", label: "מסורתי/ת (קרוב/ה לדת)" },
  { value: "masorti_light", label: "מסורתי/ת (קשר קל למסורת)" },
  {
    value: "secular_traditional_connection",
    label: "חילוני/ת עם זיקה למסורת",
  },
  { value: "secular", label: "חילוני/ת" },
  { value: "spiritual_not_religious", label: "רוחני/ת (לאו דווקא דתי/ה)" },
  { value: "other", label: "אחר (נא לפרט ב'אודות')" },
];

export const EDUCATION_LEVELS = [
  { value: 'תיכונית', label: 'השכלה תיכונית' },
  { value: 'ישיבה', label: 'ישיבה' },
  { value: 'סמינר', label: 'סמינר' },
  { value: 'תואר ראשון', label: 'תואר ראשון' },
  { value: 'תואר שני', label: 'תואר שני' },
  { value: 'דוקטורט', label: 'דוקטורט' }
];

export const MARITAL_STATUS = [
  { value: 'רווק/ה', label: 'רווק/ה' },
  { value: 'גרוש/ה', label: 'גרוש/ה' },
  { value: 'אלמן/ה', label: 'אלמן/ה' }
];

export const OCCUPATION_CATEGORIES = [
  { value: 'חינוך', label: 'חינוך והוראה' },
  { value: 'הייטק', label: 'הייטק ותוכנה' },
  { value: 'רפואה', label: 'רפואה ובריאות' },
  { value: 'משפטים', label: 'משפטים' },
  { value: 'עסקים', label: 'עסקים וכלכלה' },
  { value: 'שירותים', label: 'שירותים' },
  { value: 'אחר', label: 'אחר' }
];

export const REGIONS = [
  { value: 'ירושלים', label: 'ירושלים והסביבה' },
  { value: 'תל אביב', label: 'תל אביב והמרכז' },
  { value: 'חיפה', label: 'חיפה והצפון' },
  { value: 'באר שבע', label: 'באר שבע והדרום' },
  { value: 'יהודה ושומרון', label: 'יהודה ושומרון' }
];

export const POPULAR_CITIES = [
  'ירושלים',
  'תל אביב',
  'חיפה',
  'בני ברק',
  'פתח תקווה',
  'אשדוד',
  'נתניה',
  'באר שבע',
  'חולון',
  'רמת גן',
  'בית שמש',
  'מודיעין עילית',
  'אלעד',
  'ביתר עילית'
];

export const AVAILABILITY_STATUS_OPTIONS = [
  { 
    value: AvailabilityStatus.AVAILABLE, 
    label: 'פנוי/ה',
    description: 'מועמד/ת פנוי/ה להצעות'
  },
  { 
    value: AvailabilityStatus.DATING, 
    label: 'בתהליך הכרות',
    description: 'נמצא/ת בתהליך הכרות'
  },
  { 
    value: AvailabilityStatus.UNAVAILABLE, 
    label: 'לא פנוי/ה',
    description: 'לא פנוי/ה להצעות כרגע'
  }
];

export const SORT_OPTIONS = [
  { 
    value: 'lastActive',
    label: 'פעילות אחרונה',
    defaultOrder: 'desc'
  },
  { 
    value: 'age',
    label: 'גיל',
    defaultOrder: 'asc'
  },
  { 
    value: 'name',
    label: 'שם',
    defaultOrder: 'asc'
  },
  { 
    value: 'city',
    label: 'עיר',
    defaultOrder: 'asc'
  },
  { 
    value: 'religiousLevel',
    label: 'רמת דתיות',
    defaultOrder: 'asc'
  },
  { 
    value: 'height',
    label: 'גובה',
    defaultOrder: 'desc'
  },
  { 
    value: 'registrationDate',
    label: 'תאריך הרשמה',
    defaultOrder: 'desc'
  }
];

export const VIEW_OPTIONS = [
  {
    value: 'grid',
    label: 'תצוגת גריד',
    icon: 'LayoutGrid'
  },
  {
    value: 'list',
    label: 'תצוגת רשימה',
    icon: 'List'
  }
];

export const CARD_SIZES = [
  {
    value: 'sm',
    label: 'קטן',
    dimensions: {
      grid: 'h-64',
      list: 'h-24'
    }
  },
  {
    value: 'md',
    label: 'בינוני',
    dimensions: {
      grid: 'h-80',
      list: 'h-32'
    }
  },
  {
    value: 'lg',
    label: 'גדול',
    dimensions: {
      grid: 'h-96',
      list: 'h-40'
    }
  }
];

export const GROUP_BY_OPTIONS = [
  {
    value: 'none',
    label: 'ללא קיבוץ'
  },
  {
    value: 'city',
    label: 'עיר'
  },
  {
    value: 'religiousLevel',
    label: 'רמת דתיות'
  },
  {
    value: 'ageGroup',
    label: 'קבוצת גיל'
  },
  {
    value: 'availability',
    label: 'סטטוס זמינות'
  }
];

export const DEFAULT_FILTERS = {
  gender: undefined,
  ageRange: AGE_RANGE.default,
  heightRange: HEIGHT_RANGE.default,
  cities: [],
  religiousLevel: undefined,
  occupations: [],
  availability: undefined,
  searchQuery: '',
  isVerified: undefined,
  hasReferences: undefined,
  lastActiveDays: undefined
};

export const FILTER_CATEGORIES = [
  {
    id: 'basic',
    label: 'פילטרים בסיסיים',
    filters: ['gender', 'ageRange', 'cities', 'religiousLevel']
  },
  {
    id: 'advanced',
    label: 'פילטרים מתקדמים',
    filters: ['heightRange', 'occupations', 'education', 'maritalStatus']
  },
  {
    id: 'status',
    label: 'סטטוס ואימות',
    filters: ['availability', 'isVerified', 'hasReferences', 'lastActiveDays']
  }
];
--- End of Content for filterOptions.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants\matchingCriteria.ts
--------------------------------------------------------------------------------
Content:
// /constants/matchingCriteria.ts

export const CRITERIA_WEIGHTS = {
    // קריטריונים בסיסיים
    age: {
      weight: 15,
      description: 'התאמת גיל',
      thresholds: {
        perfect: 2,  // הפרש של עד שנתיים
        good: 5,     // הפרש של עד 5 שנים
        fair: 8      // הפרש של עד 8 שנים
      }
    },
    
    religiousLevel: {
      weight: 20,
      description: 'התאמה דתית',
      bonusPoints: {
        exactMatch: 1.0,        // התאמה מדויקת
        adjacentLevel: 0.8,     // רמה דתית סמוכה
        twoLevelsApart: 0.4     // הפרש של שתי רמות
      }
    },
  
    location: {
      weight: 10,
      description: 'מיקום גיאוגרפי',
      bonusPoints: {
        sameCity: 1.0,          // אותה עיר
        sameRegion: 0.8,        // אותו אזור
        preferredCity: 0.7,     // עיר מועדפת
        differentRegion: 0.4    // אזור אחר
      }
    },
  
    // קריטריונים מקצועיים והשכלתיים
    education: {
      weight: 8,
      description: 'רמת השכלה',
      bonusPoints: {
        sameLevel: 1.0,         // רמת השכלה זהה
        adjacentLevel: 0.8,     // רמת השכלה סמוכה
        meetPreferences: 0.7    // עומד בהעדפות
      }
    },
  
    occupation: {
      weight: 7,
      description: 'תחום עיסוק',
      bonusPoints: {
        sameField: 1.0,         // אותו תחום
        relatedField: 0.8,      // תחום קרוב
        meetPreferences: 0.7    // עומד בהעדפות
      }
    },
  
    // קריטריונים אישיים
    familyBackground: {
      weight: 12,
      description: 'רקע משפחתי',
      factors: {
        origin: 0.4,            // מוצא
        parentStatus: 0.3,      // מצב הורים
        familyType: 0.3         // סוג משפחה
      }
    },
  
    personalityMatch: {
      weight: 15,
      description: 'התאמה אישיותית',
      factors: {
        hobbies: 0.3,           // תחביבים משותפים
        lifestyle: 0.4,         // סגנון חיים
        values: 0.3             // ערכים משותפים
      }
    },
  
    // גורמים נוספים
    preferences: {
      weight: 8,
      description: 'העדפות אישיות',
      factors: {
        agePreference: 0.3,     // העדפות גיל
        locationPreference: 0.3, // העדפות מיקום
        otherPreferences: 0.4   // העדפות נוספות
      }
    },
  
    compatibility: {
      weight: 5,
      description: 'תאימות כללית',
      factors: {
        language: 0.3,          // שפה משותפת
        culture: 0.4,           // תרבות
        lifestyle: 0.3          // סגנון חיים
      }
    }
  };
  
  // סף ציון להתאמה טובה
  export const MATCH_THRESHOLDS = {
    EXCELLENT: 85,  // התאמה מצוינת
    GOOD: 75,       // התאמה טובה
    FAIR: 65,       // התאמה סבירה
    POOR: 50        // התאמה חלשה
  };
  
  // משקלים יחסיים לפי סוג התאמה
  export const MATCH_TYPE_WEIGHTS = {
    PRECISE: {     // התאמה מדויקת
      exact: 1.0,
      similar: 0.8,
      partial: 0.5
    },
    FLEXIBLE: {    // התאמה גמישה
      exact: 0.8,
      similar: 1.0,
      partial: 0.7
    },
    OPEN: {        // התאמה פתוחה
      exact: 0.7,
      similar: 0.9,
      partial: 1.0
    }
  };
  
  // הגדרת קטגוריות להתאמה
  export const MATCH_CATEGORIES = {
    IMMEDIATE: {
      minScore: 90,
      label: 'התאמה מיידית',
      description: 'התאמה גבוהה מאוד, מומלץ ליצור קשר בהקדם'
    },
    HIGH: {
      minScore: 80,
      label: 'התאמה גבוהה',
      description: 'התאמה טובה מאוד, שווה לבדוק'
    },
    GOOD: {
      minScore: 70,
      label: 'התאמה טובה',
      description: 'יש פוטנציאל טוב להתאמה'
    },
    MODERATE: {
      minScore: 60,
      label: 'התאמה בינונית',
      description: 'יש נקודות משותפות, אבל גם הבדלים'
    },
    LOW: {
      minScore: 50,
      label: 'התאמה נמוכה',
      description: 'יש פערים משמעותיים בין המועמדים'
    }
  };
--- End of Content for matchingCriteria.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\ActionDialogs.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Clock,
  Mail,
  Loader2,
  Send,
  Sparkles,
  CheckCircle,
  Heart,
  MessageCircle,
  Calendar,
  AlertCircle,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { getRelativeCloudinaryPath, getInitials } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface NewSuggestionFormData {
  firstPartyId: string;
  secondPartyId: string;
  priority: Priority;
  status: MatchSuggestionStatus;
}

interface ActionDialogsProps {
  suggestDialog: {
    isOpen: boolean;
    onClose: () => void;
    onSubmit: (data: NewSuggestionFormData) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  availabilityDialog: {
    isOpen: boolean;
    onClose: () => void;
    onCheck: (candidate: Candidate) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  inviteDialog: {
    isOpen: boolean;
    onClose: () => void;
    onInvite: (candidate: Candidate, email: string) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  dict: MatchmakerPageDictionary['candidatesManager']['actionDialogs'];
}

// Enhanced Dialog Header Component
const EnhancedDialogHeader: React.FC<{
  title: string;
  description: string;
  candidate: Candidate | null;
  icon: React.ReactNode;
  gradient: string;
}> = ({ title, description, candidate, icon, gradient }) => {
  const mainImage = candidate?.images?.find((img) => img.isMain);

  return (
    <div
      className={cn(
        'relative bg-gradient-to-br overflow-hidden rounded-t-3xl -mx-6 -mt-6 mb-6',
        gradient
      )}
    >
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white/20 rounded-full blur-2xl"></div>
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
      </div>
      <div className="relative z-10 p-6 text-white">
        <div className="flex items-center gap-4 mb-4">
          <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
            {icon}
          </div>
          <div>
            <DialogTitle className="text-2xl font-bold text-white mb-1">
              {title}
            </DialogTitle>
            <DialogDescription className="text-white/90 text-lg">
              {description}
            </DialogDescription>
          </div>
        </div>
        {candidate && (
          <div className="flex items-center gap-3 p-3 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20">
            <Avatar className="w-12 h-12 border-2 border-white/30 shadow-lg">
              {mainImage ? (
                <AvatarImage
                  src={getRelativeCloudinaryPath(mainImage.url)}
                  alt={`${candidate.firstName} ${candidate.lastName}`}
                />
              ) : (
                <AvatarFallback className="bg-white/20 text-white font-bold">
                  {getInitials(`${candidate.firstName} ${candidate.lastName}`)}
                </AvatarFallback>
              )}
            </Avatar>
            <div>
              <h3 className="font-bold text-white text-lg">
                {candidate.firstName} {candidate.lastName}
              </h3>
              <div className="flex items-center gap-2 mt-1">
                <Badge className="bg-white/20 text-white border-white/30 text-xs">
                  {candidate.profile.city || 'לא צוין'}
                </Badge>
                <Badge className="bg-white/20 text-white border-white/30 text-xs">
                  {candidate.profile.availabilityStatus === 'AVAILABLE'
                    ? 'זמין/ה'
                    : 'לא זמין/ה'}
                </Badge>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export const ActionDialogs: React.FC<ActionDialogsProps> = ({
  suggestDialog,
  availabilityDialog,
  inviteDialog,
  dict,
}) => {
  const [inviteEmail, setInviteEmail] = useState('');
  const [isInviting, setIsInviting] = useState(false);
  const [inviteError, setInviteError] = useState<string | null>(null);
  const [inviteSuccess, setInviteSuccess] = useState(false);

  const [isChecking, setIsChecking] = useState(false);
  const [availabilityError, setAvailabilityError] = useState<string | null>(
    null
  );
  const [availabilitySuccess, setAvailabilitySuccess] = useState(false);

  useEffect(() => {
    if (inviteDialog.isOpen && inviteDialog.selectedCandidate) {
      setInviteEmail(inviteDialog.selectedCandidate.email || '');
      setInviteError(null);
      setInviteSuccess(false);
    }
  }, [inviteDialog.isOpen, inviteDialog.selectedCandidate]);

  useEffect(() => {
    if (availabilityDialog.isOpen) {
      setAvailabilityError(null);
      setAvailabilitySuccess(false);
    }
  }, [availabilityDialog.isOpen]);

  const handleInviteSubmit = async () => {
    if (!inviteDialog.selectedCandidate || !inviteEmail) return;
    try {
      setIsInviting(true);
      setInviteError(null);
      await inviteDialog.onInvite(inviteDialog.selectedCandidate, inviteEmail);
      setInviteSuccess(true);
      setTimeout(() => inviteDialog.onClose(), 2000);
    } catch (error) {
      setInviteError(
        error instanceof Error ? error.message : dict.invite.submissionError
      );
    } finally {
      setIsInviting(false);
    }
  };

  const handleAvailabilityCheck = async () => {
    if (!availabilityDialog.selectedCandidate) return;
    try {
      setIsChecking(true);
      setAvailabilityError(null);
      await availabilityDialog.onCheck(availabilityDialog.selectedCandidate);
      setAvailabilitySuccess(true);
      setTimeout(() => availabilityDialog.onClose(), 2000);
    } catch (error) {
      setAvailabilityError(
        error instanceof Error
          ? error.message
          : dict.availability.submissionError
      );
    } finally {
      setIsChecking(false);
    }
  };

  const validateEmail = (email: string) =>
    /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  return (
    <>
      <Dialog open={inviteDialog.isOpen} onOpenChange={inviteDialog.onClose}>
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.invite.title}
            description={dict.invite.description}
            candidate={inviteDialog.selectedCandidate}
            icon={<Send className="w-8 h-8" />}
            gradient="from-purple-500 to-indigo-500"
          />
          <div className="space-y-6 p-6 -mt-6">
            {inviteSuccess ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <CheckCircle className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold text-green-800 mb-2">
                  {dict.invite.successMessage}
                </h3>
                <p className="text-green-600">
                  {dict.invite.successDescription}
                </p>
              </div>
            ) : (
              <>
                <div className="space-y-3">
                  <Label className="text-sm font-bold text-gray-700 flex items-center gap-2">
                    <Mail className="w-4 h-4 text-purple-500" />
                    {dict.invite.emailLabel}
                  </Label>
                  <div className="relative">
                    <Input
                      type="email"
                      value={inviteEmail}
                      onChange={(e) => {
                        setInviteEmail(e.target.value);
                        setInviteError(null);
                      }}
                      placeholder={dict.invite.emailPlaceholder}
                      className={cn(
                        'pr-12 h-12 bg-gray-50 border-2 border-gray-200 focus:border-purple-400 focus:ring-purple-200 rounded-xl transition-all duration-300',
                        !validateEmail(inviteEmail) &&
                          inviteEmail.length > 0 &&
                          'border-red-300 focus:border-red-400'
                      )}
                      dir="ltr"
                    />
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2">
                      <Mail className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                  {inviteEmail && !validateEmail(inviteEmail) && (
                    <p className="text-red-500 text-sm flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {dict.invite.invalidEmailError}
                    </p>
                  )}
                </div>
                {inviteError && (
                  <Alert className="border-red-200 bg-red-50">
                    <AlertCircle className="h-4 w-4 text-red-600" />
                    <AlertDescription className="text-red-700 font-medium">
                      {inviteError}
                    </AlertDescription>
                  </Alert>
                )}
                <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-100">
                  <h4 className="font-bold text-purple-800 mb-2 flex items-center gap-2">
                    <Sparkles className="w-4 h-4" />
                    {dict.invite.whatsNextTitle}
                  </h4>
                  <ul className="text-sm text-purple-700 space-y-1">
                    {dict.invite.whatsNextItems.map((item, i) => (
                      <li key={i}>• {item}</li>
                    ))}
                  </ul>
                </div>
              </>
            )}
          </div>
          {!inviteSuccess && (
            <DialogFooter className="p-6 pt-0 gap-3">
              <Button
                variant="outline"
                onClick={inviteDialog.onClose}
                disabled={isInviting}
                className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
              >
                {dict.invite.buttons.cancel}
              </Button>
              <Button
                onClick={handleInviteSubmit}
                disabled={
                  isInviting || !inviteEmail || !validateEmail(inviteEmail)
                }
                className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
              >
                {isInviting ? (
                  <Loader2 className="ml-2 h-5 w-5 animate-spin" />
                ) : (
                  <Send className="ml-2 h-5 w-5" />
                )}
                {isInviting
                  ? dict.invite.buttons.sending
                  : dict.invite.buttons.send}
              </Button>
            </DialogFooter>
          )}
        </DialogContent>
      </Dialog>

      <Dialog
        open={availabilityDialog.isOpen}
        onOpenChange={availabilityDialog.onClose}
      >
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.availability.title}
            description={dict.availability.description}
            candidate={availabilityDialog.selectedCandidate}
            icon={<Calendar className="w-8 h-8" />}
            gradient="from-orange-500 to-amber-500"
          />
          <div className="space-y-6 p-6 -mt-6">
            {availabilitySuccess ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <CheckCircle className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold text-green-800 mb-2">
                  {dict.availability.successMessage}
                </h3>
                <p className="text-green-600">
                  {dict.availability.successDescription}
                </p>
              </div>
            ) : (
              <>
                <div className="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                  <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2">
                    <Clock className="w-4 h-4" />
                    {dict.availability.whatsNextTitle}
                  </h4>
                  <ul className="text-sm text-orange-700 space-y-1">
                    {dict.availability.whatsNextItems.map((item, i) => (
                      <li key={i}>• {item}</li>
                    ))}
                  </ul>
                </div>
                {availabilityError && (
                  <Alert className="border-red-200 bg-red-50">
                    <AlertCircle className="h-4 w-4 text-red-600" />
                    <AlertDescription className="text-red-700 font-medium">
                      {availabilityError}
                    </AlertDescription>
                  </Alert>
                )}
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                  <div className="flex items-center gap-3 mb-3">
                    <MessageCircle className="w-5 h-5 text-blue-500" />
                    <span className="font-medium text-gray-800">
                      {dict.availability.messageToSendTitle}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 bg-white p-3 rounded-lg border italic">
                    {dict.availability.messageContent.replace(
                      '{{firstName}}',
                      availabilityDialog.selectedCandidate?.firstName || ''
                    )}
                  </p>
                </div>
              </>
            )}
          </div>
          {!availabilitySuccess && (
            <DialogFooter className="p-6 pt-0 gap-3">
              <Button
                variant="outline"
                onClick={availabilityDialog.onClose}
                disabled={isChecking}
                className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
              >
                {dict.availability.buttons.cancel}
              </Button>
              <Button
                onClick={handleAvailabilityCheck}
                disabled={isChecking}
                className="bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
              >
                {isChecking ? (
                  <Loader2 className="ml-2 h-5 w-5 animate-spin" />
                ) : (
                  <Clock className="ml-2 h-5 w-5" />
                )}
                {isChecking
                  ? dict.availability.buttons.checking
                  : dict.availability.buttons.check}
              </Button>
            </DialogFooter>
          )}
        </DialogContent>
      </Dialog>

      <Dialog open={suggestDialog.isOpen} onOpenChange={suggestDialog.onClose}>
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.suggest.title}
            description={dict.suggest.description}
            candidate={suggestDialog.selectedCandidate}
            icon={<Heart className="w-8 h-8" />}
            gradient="from-pink-500 to-rose-500"
          />
          <div className="p-6 -mt-6">
            <div className="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-xl border border-pink-100">
              <h4 className="font-bold text-pink-800 mb-2 flex items-center gap-2">
                <Sparkles className="w-4 h-4" />
                {dict.suggest.whatsNextTitle}
              </h4>
              <p className="text-sm text-pink-700">
                {dict.suggest.whatsNextDescription}
              </p>
            </div>
          </div>
          <DialogFooter className="p-6 pt-0 gap-3">
            <Button
              variant="outline"
              onClick={suggestDialog.onClose}
              className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
            >
              {dict.suggest.buttons.cancel}
            </Button>
            <Button
              onClick={suggestDialog.onClose}
              className="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
            >
              <Heart className="ml-2 h-5 w-5" />
              {dict.suggest.buttons.continue}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
};

export default ActionDialogs;
--- End of Content for ActionDialogs.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AddManualCandidateDialog.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { Loader2, UserPlus, X, UploadCloud, Trash2 } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';
import Image from 'next/image';
import { Gender } from '@prisma/client';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { DatePicker } from '@/components/ui/date-picker';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface AddManualCandidateDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onCandidateAdded: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['addManualCandidateDialog'];
  locale: string;
}

const MAX_IMAGES = 5;
const MAX_IMAGE_SIZE_MB = 5;

export const AddManualCandidateDialog: React.FC<
  AddManualCandidateDialogProps
> = ({ isOpen, onClose, onCandidateAdded, dict }) => {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [email, setEmail] = useState('');
  const [gender, setGender] = useState<Gender | undefined>(undefined);
  const [birthDate, setBirthDate] = useState<Date | undefined>(undefined);
  const [manualEntryText, setManualEntryText] = useState('');
  const [images, setImages] = useState<File[]>([]);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  const [sendInvite, setSendInvite] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [birthDateInputMode, setBirthDateInputMode] = useState<'date' | 'age'>(
    'date'
  );
  const [ageInput, setAgeInput] = useState<string>('');

  const resetForm = useCallback(() => {
    setFirstName('');
    setLastName('');
    setEmail('');
    setGender(undefined);
    setBirthDate(undefined);
    setManualEntryText('');
    setImages([]);
    setImagePreviews([]);
    setSendInvite(false);
    setIsSaving(false);
    setBirthDateInputMode('date');
    setAgeInput('');
  }, []);

  const handleClose = () => {
    resetForm();
    onClose();
  };

  const handleImageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files) {
      const newFiles = Array.from(event.target.files);
      const validFiles: File[] = [];
      const validPreviews: string[] = [];

      newFiles.forEach((file) => {
        if (images.length + validFiles.length < MAX_IMAGES) {
          if (file.size <= MAX_IMAGE_SIZE_MB * 1024 * 1024) {
            validFiles.push(file);
            validPreviews.push(URL.createObjectURL(file));
          } else {
            toast.error(
              dict.fields.photos.fileTooLargeError
                .replace('{{fileName}}', file.name)
                .replace('{{maxSize}}', String(MAX_IMAGE_SIZE_MB))
            );
          }
        } else {
          toast.warning(
            dict.fields.photos.maxFilesWarning.replace(
              '{{max}}',
              String(MAX_IMAGES)
            )
          );
        }
      });

      setImages((prev) => [...prev, ...validFiles]);
      setImagePreviews((prev) => [...prev, ...validPreviews]);
    }
  };

  const removeImage = (index: number) => {
    setImages(images.filter((_, i) => i !== index));
    setImagePreviews(imagePreviews.filter((_, i) => i !== index));
  };

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    setIsSaving(true);

    if (!firstName || !lastName || !gender || !manualEntryText) {
      toast.error(dict.toasts.error.missingFields);
      setIsSaving(false);
      return;
    }

    let finalBirthDate: Date | undefined;
    let isBirthDateApproximate = false;

    if (birthDateInputMode === 'date') {
      if (!birthDate) {
        toast.error(dict.toasts.error.invalidBirthDate);
        setIsSaving(false);
        return;
      }
      finalBirthDate = birthDate;
    } else {
      const ageNum = parseInt(ageInput, 10);
      if (isNaN(ageNum) || ageNum <= 0 || ageNum > 120) {
        toast.error(dict.toasts.error.invalidAge);
        setIsSaving(false);
        return;
      }
      const birthYear = new Date().getFullYear() - ageNum;
      finalBirthDate = new Date(birthYear, 0, 1);
      isBirthDateApproximate = true;
    }

    const formData = new FormData();
    formData.append('firstName', firstName);
    formData.append('lastName', lastName);
    if (email) formData.append('email', email);
    formData.append('gender', gender);
    formData.append('birthDate', finalBirthDate.toISOString());
    formData.append('birthDateIsApproximate', String(isBirthDateApproximate));
    formData.append('manualEntryText', manualEntryText);
    images.forEach((image) => formData.append('images', image));

    try {
      const response = await fetch('/api/matchmaker/candidates/manual', {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      if (!response.ok || !result.success)
        throw new Error(result.error || dict.toasts.error.general);

      if (sendInvite && email && result.candidate?.id) {
        const promise = fetch(
          `/api/matchmaker/candidates/${result.candidate.id}/invite-setup`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
          }
        ).then(async (inviteResponse) => {
          if (!inviteResponse.ok) {
            const errorData = await inviteResponse.json().catch(() => ({}));
            throw new Error(errorData.error || 'Invitation failed');
          }
          return inviteResponse.json();
        });
        toast.promise(promise, {
          loading: dict.toasts.success.inviteLoading,
          success: dict.toasts.success.inviteSent,
          error: (err: Error) =>
            dict.toasts.success.inviteError.replace('{{error}}', err.message),
        });
      } else {
        toast.success(dict.toasts.success.candidateAdded);
      }
      onCandidateAdded();
      handleClose();
    } catch (error) {
      console.error('Error adding manual candidate:', error);
      toast.error(
        `${dict.toasts.error.general}: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <Dialog
      open={isOpen}
      onOpenChange={(open) => {
        if (!open) handleClose();
      }}
    >
      <DialogContent className="max-w-2xl">
        <DialogClose asChild>
          <button className="absolute right-4 top-4 p-1 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
            <X className="h-4 w-4" />
            <span className="sr-only">{dict.close}</span>
          </button>
        </DialogClose>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-right">
            <UserPlus className="w-6 h-6 text-primary" />
            {dict.title}
          </DialogTitle>
          <DialogDescription className="text-right">
            {dict.description}
          </DialogDescription>
        </DialogHeader>
        <form
          onSubmit={handleSubmit}
          className="space-y-6 py-4 max-h-[70vh] overflow-y-auto pr-2 pl-1"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <Label htmlFor="firstName" className="text-right block">
                {dict.fields.firstName.label}{' '}
                <span className="text-red-500">*</span>
              </Label>
              <Input
                id="firstName"
                value={firstName}
                onChange={(e) => setFirstName(e.target.value)}
                placeholder={dict.fields.firstName.placeholder}
                required
                dir="rtl"
              />
            </div>
            <div>
              <Label htmlFor="lastName" className="text-right block">
                {dict.fields.lastName.label}{' '}
                <span className="text-red-500">*</span>
              </Label>
              <Input
                id="lastName"
                value={lastName}
                onChange={(e) => setLastName(e.target.value)}
                placeholder={dict.fields.lastName.placeholder}
                required
                dir="rtl"
              />
            </div>
          </div>
          <div>
            <Label htmlFor="email" className="text-right block">
              {dict.fields.email.label}
            </Label>
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder={dict.fields.email.placeholder}
              dir="ltr"
            />
            <p className="text-xs text-gray-500 mt-1 text-right">
              {dict.fields.email.description}
            </p>
          </div>
          <div className="flex items-center space-x-2 rtl:space-x-reverse pt-2">
            <Checkbox
              id="sendInvite"
              checked={sendInvite}
              onCheckedChange={(checked) => setSendInvite(Boolean(checked))}
              disabled={!email || isSaving}
            />
            <Label
              htmlFor="sendInvite"
              className={`cursor-pointer transition-colors ${!email ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700'}`}
            >
              {dict.fields.sendInvite.label}
            </Label>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <Label htmlFor="gender" className="text-right block">
                {dict.fields.gender.label}{' '}
                <span className="text-red-500">*</span>
              </Label>
              <Select
                value={gender}
                onValueChange={(value) => setGender(value as Gender)}
              >
                <SelectTrigger id="gender" dir="rtl">
                  <SelectValue placeholder={dict.fields.gender.placeholder} />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value={Gender.MALE}>
                    {dict.fields.gender.male}
                  </SelectItem>
                  <SelectItem value={Gender.FEMALE}>
                    {dict.fields.gender.female}
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <div>
                <Label className="text-right block mb-2">
                  {dict.fields.birthDate.modeLabel}{' '}
                  <span className="text-red-500">*</span>
                </Label>
                <RadioGroup
                  dir="rtl"
                  value={birthDateInputMode}
                  onValueChange={(value: 'date' | 'age') =>
                    setBirthDateInputMode(value)
                  }
                  className="flex space-x-4 rtl:space-x-reverse mb-3"
                >
                  <div className="flex items-center space-x-2 rtl:space-x-reverse">
                    <RadioGroupItem value="date" id="r-date" />
                    <Label htmlFor="r-date" className="cursor-pointer">
                      {dict.fields.birthDate.dateMode}
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2 rtl:space-x-reverse">
                    <RadioGroupItem value="age" id="r-age" />
                    <Label htmlFor="r-age" className="cursor-pointer">
                      {dict.fields.birthDate.ageMode}
                    </Label>
                  </div>
                </RadioGroup>
              </div>
              {birthDateInputMode === 'date' ? (
                <div>
                  <Label htmlFor="birthDate" className="text-right block">
                    {dict.fields.birthDate.dateLabel}{' '}
                    <span className="text-red-500">*</span>
                  </Label>
                  <DatePicker
                    value={birthDate ? { from: birthDate } : undefined}
                    onChange={({ from }) => setBirthDate(from)}
                    isRange={false}
                    placeholder={dict.fields.birthDate.datePlaceholder}
                    className="w-full"
                  />
                </div>
              ) : (
                <div>
                  <Label htmlFor="ageInput" className="text-right block">
                    {dict.fields.birthDate.ageLabel}{' '}
                    <span className="text-red-500">*</span>
                  </Label>
                  <Input
                    id="ageInput"
                    type="number"
                    value={ageInput}
                    onChange={(e) => setAgeInput(e.target.value)}
                    placeholder={dict.fields.birthDate.agePlaceholder}
                    required={birthDateInputMode === 'age'}
                    dir="rtl"
                    min="1"
                    max="120"
                  />
                  <p className="text-xs text-gray-500 mt-1 text-right">
                    {dict.fields.birthDate.ageDescription}
                  </p>
                </div>
              )}
            </div>
          </div>
          <div>
            <Label htmlFor="manualEntryText" className="text-right block">
              {dict.fields.notes.label} <span className="text-red-500">*</span>
            </Label>
            <Textarea
              id="manualEntryText"
              value={manualEntryText}
              onChange={(e) => setManualEntryText(e.target.value)}
              placeholder={dict.fields.notes.placeholder}
              rows={6}
              required
              className="min-h-[100px]"
              dir="rtl"
            />
          </div>
          <div>
            <Label htmlFor="image-upload" className="text-right block">
              {dict.fields.photos.label.replace('{{max}}', String(MAX_IMAGES))}
            </Label>
            <div className="mt-2 flex items-center justify-center w-full">
              <label
                htmlFor="image-upload"
                className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100"
              >
                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                  <UploadCloud className="w-8 h-8 mb-2 text-gray-500" />
                  <p className="mb-2 text-sm text-gray-500 text-center">
                    {dict.fields.photos.cta}
                  </p>
                  <p className="text-xs text-gray-500">
                    {dict.fields.photos.description.replace(
                      '{{maxSize}}',
                      String(MAX_IMAGE_SIZE_MB)
                    )}
                  </p>
                </div>
                <Input
                  id="image-upload"
                  type="file"
                  multiple
                  accept="image/png, image/jpeg, image/webp"
                  className="hidden"
                  onChange={handleImageChange}
                  disabled={images.length >= MAX_IMAGES}
                />
              </label>
            </div>
            {imagePreviews.length > 0 && (
              <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {imagePreviews.map((preview, index) => (
                  <div key={index} className="relative group">
                    <Image
                      src={preview}
                      alt={dict.fields.photos.previewAlt.replace(
                        '{{index}}',
                        String(index + 1)
                      )}
                      width={100}
                      height={100}
                      className="rounded-md object-cover w-full aspect-square"
                      onLoad={() => URL.revokeObjectURL(preview)}
                    />
                    <Button
                      type="button"
                      variant="destructive"
                      size="icon"
                      className="absolute top-1 right-1 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity p-0"
                      onClick={() => removeImage(index)}
                    >
                      <Trash2 className="h-3 w-3" />
                      <span className="sr-only">
                        {dict.fields.photos.removeLabel}
                      </span>
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
          <DialogFooter className="pt-4 sm:justify-start">
            <Button
              type="submit"
              disabled={isSaving}
              className="w-full sm:w-auto"
            >
              {isSaving ? (
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              ) : (
                <UserPlus className="w-4 h-4 mr-2" />
              )}
              {isSaving ? dict.buttons.adding : dict.buttons.add}
            </Button>
            <DialogClose asChild>
              <Button
                variant="outline"
                type="button"
                className="w-full sm:w-auto mt-2 sm:mt-0"
              >
                <X className="w-4 h-4 mr-2" />
                {dict.buttons.cancel}
              </Button>
            </DialogClose>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for AddManualCandidateDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AiMatchAnalysisDialog.tsx
--------------------------------------------------------------------------------
Content:
// File: src/app/components/matchmaker/new/dialogs/AiMatchAnalysisDialog.tsx
'use client';
import React, { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  X,
  Sparkles,
  CheckCircle,
  AlertTriangle,
  MessageSquare,
  Info,
  XCircle,
  Star,
  Cake,
  MapPin,
  BookMarked,
  Users,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// --- Interfaces ---
interface AiAnalysis {
  overallScore: number;
  matchSummary: string;
  compatibilityPoints: {
    area: string;
    explanation: string;
    strength: 'HIGH' | 'MEDIUM' | 'LOW';
  }[];
  potentialChallenges: {
    area: string;
    explanation: string;
    severity: 'HIGH' | 'MEDIUM' | 'LOW';
  }[];
  suggestedConversationStarters: string[];
}
interface AiMatchAnalysisDialogProps {
  isOpen: boolean;
  onClose: () => void;
  targetCandidate: Candidate | null;
  comparisonCandidates: Candidate[];
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis'];
  locale: string; // <--- הוסף את השורה הזו
}

// --- Helper Functions ---
const getInitials = (firstName?: string, lastName?: string): string => {
  let initials = '';
  if (firstName && firstName.length > 0) initials += firstName[0];
  if (lastName && lastName.length > 0) initials += lastName[0];
  return initials.toUpperCase() || '?';
};
const calculateAge = (birthDate: Date | string): number => {
  if (!birthDate) return 0;
  const today = new Date();
  const birth = new Date(birthDate);
  if (isNaN(birth.getTime())) return 0;
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate()))
    age--;
  return age > 0 ? age : 0;
};

// --- Sub-components ---
const MiniProfileHeader: React.FC<{
  candidate: Candidate;
  score?: number;
  isTarget?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis']['miniProfile'];
}> = ({ candidate, score, isTarget = false, dict }) => {
  const mainImage = candidate.images?.find((img) => img.isMain);
  const age = calculateAge(candidate.profile.birthDate);
  const initials = getInitials(candidate.firstName, candidate.lastName);
  return (
    <div className="p-4 rounded-t-lg bg-gradient-to-b from-slate-50 to-slate-100 border-b border-slate-200 text-center relative">
      <div className="relative w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-white shadow-lg ring-2 ring-offset-2 ring-cyan-400">
        {mainImage?.url ? (
          <Image
            src={getRelativeCloudinaryPath(mainImage.url)}
            alt={`Profile picture of ${candidate.firstName}`}
            layout="fill"
            className="object-cover"
            sizes="96px"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-slate-200 to-slate-300">
            <span className="text-4xl font-medium text-slate-500">
              {initials}
            </span>
          </div>
        )}
      </div>
      {!isTarget && typeof score === 'number' && (
        <Badge className="absolute top-4 left-4 bg-gradient-to-r from-teal-400 to-cyan-500 text-white border-0 shadow-lg px-3 py-1.5 text-sm font-bold flex items-center gap-1.5">
          <Sparkles className="w-4 h-4" />
          {dict.matchBadge.replace('{{score}}', String(score))}
        </Badge>
      )}
      {isTarget && (
        <Badge className="absolute top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white border-0 shadow-lg px-3 py-1.5 text-sm font-bold flex items-center gap-1.5">
          <Star className="w-4 h-4" />
          {dict.targetBadge}
        </Badge>
      )}
      <h3 className="mt-3 text-lg font-bold text-slate-800">
        {candidate.firstName} {candidate.lastName}
      </h3>
      <div className="mt-2 flex justify-center items-center flex-wrap gap-x-3 gap-y-1 text-xs text-slate-600">
        <div className="flex items-center gap-1">
          <Cake className="w-3.5 h-3.5 text-slate-400" /> {age} {dict.years}
        </div>
        <div className="flex items-center gap-1">
          <MapPin className="w-3.5 h-3.5 text-slate-400" />{' '}
          {candidate.profile.city || dict.notSpecified}
        </div>
        <div className="flex items-center gap-1">
          <BookMarked className="w-3.5 h-3.5 text-slate-400" />{' '}
          {candidate.profile.religiousLevel || dict.notSpecified}
        </div>
      </div>
    </div>
  );
};
const AnalysisItem: React.FC<{
  icon: React.ElementType;
  iconColor: string;
  area: string;
  explanation: string;
}> = ({ icon: Icon, iconColor, area, explanation }) => (
  <div className="flex items-start gap-4 p-3 rounded-lg hover:bg-slate-50/70 transition-colors">
    <div
      className={cn(
        'mt-1 flex-shrink-0 rounded-full p-2 bg-opacity-10',
        iconColor.replace('text-', 'bg-')
      )}
    >
      <Icon className={cn('h-5 w-5', iconColor)} />
    </div>
    <div>
      <h4 className="font-semibold text-gray-800">{area}</h4>
      <p className="text-sm text-gray-600 leading-relaxed">{explanation}</p>
    </div>
  </div>
);
const ComparisonTable: React.FC<{
  target: Candidate;
  comparison: Candidate;
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis']['comparisonTable'];
  language: 'he' | 'en';
}> = ({ target, comparison, dict, language }) => {
  const fieldsToCompare = [
    {
      key: 'age',
      label: dict.fields.age,
      formatter: (c: Candidate) =>
        `${calculateAge(c.profile.birthDate)}${
          c.profile.birthDateIsApproximate ? ` ${dict.fields.ageApprox}` : ''
        }`,
    },
    {
      key: 'city',
      label: dict.fields.city,
      formatter: (c: Candidate) => c.profile.city || 'לא צוין',
    },
    {
      key: 'maritalStatus',
      label: dict.fields.maritalStatus,
      formatter: (c: Candidate) => c.profile.maritalStatus || 'לא צוין',
    },
    {
      key: 'religiousLevel',
      label: dict.fields.religiousLevel,
      formatter: (c: Candidate) => c.profile.religiousLevel || 'לא צוין',
    },
    {
      key: 'occupation',
      label: dict.fields.occupation,
      formatter: (c: Candidate) => c.profile.occupation || 'לא צוין',
    },
    {
      key: 'education',
      label: dict.fields.education,
      formatter: (c: Candidate) => c.profile.education || 'לא צוין',
    },
  ];
  return (
    <div className="overflow-x-auto border rounded-lg">
      <table
        className={cn(
          'w-full text-sm border-collapse',
          language === 'he' ? 'text-right' : 'text-left'
        )}
      >
        <thead>
          <tr className="bg-slate-50">
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200">
              {dict.criterion}
            </th>
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200 text-center">
              {target.firstName}
            </th>
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200 text-center">
              {comparison.firstName}
            </th>
          </tr>
        </thead>
        <tbody>
          {fieldsToCompare.map((field, index) => (
            <tr
              key={field.key}
              className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}
            >
              <td className="p-3 font-medium text-slate-500 border-b border-slate-200">
                {field.label}
              </td>
              <td className="p-3 text-slate-700 border-b border-slate-200 text-center">
                {field.formatter(target)}
              </td>
              <td className="p-3 text-slate-700 border-b border-slate-200 text-center">
                {field.formatter(comparison)}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};
const AnalysisSkeleton: React.FC = () => (
  <div className="space-y-6 p-4 animate-pulse">
    <div className="p-4 bg-gray-100 rounded-lg">
      <div className="h-20 bg-gray-200 rounded-md"></div>
    </div>
    <div className="space-y-4">
      <div className="h-5 bg-gray-200 rounded-md w-1/3"></div>
      <div className="flex gap-4">
        <div className="rounded-full bg-gray-200 h-10 w-10"></div>
        <div className="flex-1 space-y-2 py-1">
          <div className="h-4 bg-gray-200 rounded w-full"></div>
          <div className="h-3 bg-gray-300 rounded w-5/6"></div>
        </div>
      </div>
      <div className="flex gap-4">
        <div className="rounded-full bg-gray-200 h-10 w-10"></div>
        <div className="flex-1 space-y-2 py-1">
          <div className="h-4 bg-gray-200 rounded w-full"></div>
          <div className="h-3 bg-gray-300 rounded w-4/6"></div>
        </div>
      </div>
    </div>
  </div>
);
const DialogBody: React.FC<AiMatchAnalysisDialogProps> = ({
  isOpen,
  locale,
  targetCandidate,
  comparisonCandidates,
  dict,
}) => {
  const [activeComparisonId, setActiveComparisonId] = useState<string | null>(
    null
  );
  const [analyses, setAnalyses] = useState<
    Record<string, AiAnalysis | 'error' | 'loading'>
  >({});
  const [language, setLanguage] = useState<'he' | 'en'>(
    locale === 'he' ? 'he' : 'en'
  );
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  const activeComparisonCandidate = useMemo(
    () => comparisonCandidates.find((c) => c.id === activeComparisonId),
    [activeComparisonId, comparisonCandidates]
  );
  const activeAnalysis = useMemo(
    () => (activeComparisonId ? analyses[activeComparisonId] || null : null),
    [activeComparisonId, analyses]
  );
  useEffect(() => {
    if (
      isOpen &&
      comparisonCandidates.length > 0 &&
      !comparisonCandidates.some((c) => c.id === activeComparisonId)
    ) {
      setActiveComparisonId(comparisonCandidates[0].id);
    }
  }, [isOpen, comparisonCandidates, activeComparisonId]);
  useEffect(() => {
    if (
      isOpen &&
      targetCandidate &&
      activeComparisonId &&
      analyses[activeComparisonId] === undefined
    ) {
      const fetchAnalysis = async () => {
        setAnalyses((prev) => ({ ...prev, [activeComparisonId]: 'loading' }));
        try {
          const response = await fetch('/api/ai/generate-rationale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId1: targetCandidate.id,
              userId2: activeComparisonId,
              language: language,
            }),
          });
          const data = await response.json();
          if (response.ok && data.success) {
            setAnalyses((prev) => ({
              ...prev,
              [activeComparisonId]: data.analysis,
            }));
          } else {
            throw new Error(data.error || 'Failed to fetch analysis');
          }
        } catch (e) {
          console.error(`Failed to get analysis for ${activeComparisonId}:`, e);
          setAnalyses((prev) => ({ ...prev, [activeComparisonId]: 'error' }));
        }
      };
      fetchAnalysis();
    }
  }, [isOpen, targetCandidate, activeComparisonId, language, analyses]);

  if (!targetCandidate) return null;
  return (
    <DialogContent
      className="max-w-6xl w-full h-[95vh] flex flex-col p-0 overflow-hidden"
      dir={language === 'he' ? 'rtl' : 'ltr'}
    >
      <DialogClose
        asChild
        className={cn(
          'absolute top-3 z-50',
          language === 'he' ? 'left-3' : 'right-3'
        )}
      >
        <Button variant="ghost" size="icon" className="rounded-full">
          <X className="h-5 w-5" />
        </Button>
      </DialogClose>
      <div className="flex-1 flex flex-col md:flex-row min-h-0">
        {isMobile ? (
          <div className="p-4 border-b md:hidden">
            <Select
              value={activeComparisonId || ''}
              onValueChange={setActiveComparisonId}
            >
              <SelectTrigger className="w-full">
                <SelectValue
                  placeholder={dict.header.languageSelectPlaceholder}
                />
              </SelectTrigger>
              <SelectContent>
                {comparisonCandidates.map((c) => (
                  <SelectItem key={c.id} value={c.id}>
                    {c.firstName} {c.lastName}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        ) : (
          <aside
            className={cn(
              'w-1/4 bg-slate-50/50 flex flex-col flex-shrink-0',
              language === 'he' ? 'border-l' : 'border-r'
            )}
          >
            <h3 className="p-3 text-sm font-semibold text-slate-600 border-b">
              {dict.sidebar.title.replace(
                '{{count}}',
                String(comparisonCandidates.length)
              )}
            </h3>
            <ScrollArea className="flex-1">
              {comparisonCandidates.map((candidate) => {
                const mainImageUrl = candidate.images?.find(
                  (img) => img.isMain
                )?.url;
                return (
                  <button
                    key={candidate.id}
                    onClick={() => setActiveComparisonId(candidate.id)}
                    className={cn(
                      'w-full p-3 flex items-center gap-3 border-b border-slate-200/60 hover:bg-slate-100 transition-colors',
                      language === 'he' ? 'text-right' : 'text-left',
                      activeComparisonId === candidate.id &&
                        'bg-cyan-50 border-cyan-500 font-semibold',
                      activeComparisonId === candidate.id &&
                        (language === 'he' ? 'border-r-4' : 'border-l-4')
                    )}
                  >
                    <div className="relative w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-200">
                      {mainImageUrl ? (
                        <Image
                          src={getRelativeCloudinaryPath(mainImageUrl)}
                          alt={candidate.firstName}
                          layout="fill"
                          className="object-cover"
                          sizes="40px"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center">
                          <span className="text-sm font-bold text-gray-500">
                            {getInitials(
                              candidate.firstName,
                              candidate.lastName
                            )}
                          </span>
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="truncate text-sm text-slate-800">
                        {candidate.firstName} {candidate.lastName}
                      </p>
                      <p className="text-xs text-slate-500">
                        {calculateAge(candidate.profile.birthDate)} |{' '}
                        {candidate.profile.city}
                      </p>
                    </div>
                    {analyses[candidate.id] &&
                      analyses[candidate.id] !== 'error' &&
                      analyses[candidate.id] !== 'loading' && (
                        <Badge
                          variant="secondary"
                          className="bg-teal-100 text-teal-800"
                        >
                          {(analyses[candidate.id] as AiAnalysis).overallScore}%
                        </Badge>
                      )}
                  </button>
                );
              })}
            </ScrollArea>
          </aside>
        )}
        <main className="flex-1 flex flex-col min-h-0 bg-white">
          {!activeComparisonCandidate ? (
            <div className="flex-1 flex flex-col items-center justify-center text-center p-6 text-gray-500">
              <Users className="w-16 h-16 text-gray-300 mb-4" />
              <h3 className="text-lg font-semibold">
                {dict.main.selectCandidate.title}
              </h3>
              <p className="max-w-xs">
                {dict.main.selectCandidate.description}
              </p>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 flex-shrink-0">
                <MiniProfileHeader
                  candidate={targetCandidate}
                  isTarget
                  dict={dict.miniProfile}
                />
                <MiniProfileHeader
                  candidate={activeComparisonCandidate}
                  score={(activeAnalysis as AiAnalysis)?.overallScore}
                  dict={dict.miniProfile}
                />
              </div>
              <Tabs
                defaultValue="summary"
                className="flex-1 flex flex-col min-h-0"
              >
                <TabsList className="mx-4 mt-4 bg-slate-100 p-1 rounded-lg">
                  <TabsTrigger value="summary">{dict.tabs.summary}</TabsTrigger>
                  <TabsTrigger value="challenges">
                    {dict.tabs.challenges}
                  </TabsTrigger>
                  <TabsTrigger value="comparison">
                    {dict.tabs.comparison}
                  </TabsTrigger>
                  <TabsTrigger value="conversation">
                    {dict.tabs.conversation}
                  </TabsTrigger>
                </TabsList>
                <ScrollArea className="flex-1">
                  <AnimatePresence mode="wait">
                    <motion.div
                      key={activeComparisonId}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: -10 }}
                      transition={{ duration: 0.2 }}
                      className="p-4 md:p-6"
                    >
                      {activeAnalysis === 'loading' && <AnalysisSkeleton />}
                      {activeAnalysis === 'error' && (
                        <div className="text-center py-10">
                          <XCircle className="w-12 h-12 text-red-400 mx-auto mb-4" />
                          <h3 className="font-semibold text-xl text-red-600">
                            {dict.main.error.title}
                          </h3>
                          <p className="text-gray-500 mt-2">
                            {dict.main.error.description}
                          </p>
                        </div>
                      )}
                      {activeAnalysis &&
                        activeAnalysis !== 'error' &&
                        activeAnalysis !== 'loading' && (
                          <>
                            <TabsContent
                              value="summary"
                              className="space-y-6 mt-0"
                            >
                              <div className="p-4 bg-slate-50/70 rounded-lg border border-slate-200">
                                <h3 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                  <Info className="w-5 h-5 text-blue-500" />
                                  {dict.analysis.summaryTitle}
                                </h3>
                                <p className="text-sm text-gray-600 leading-relaxed">
                                  {(activeAnalysis as AiAnalysis).matchSummary}
                                </p>
                              </div>
                              <div>
                                <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                  <CheckCircle className="w-5 h-5 text-green-500" />
                                  {dict.analysis.strengthsTitle}
                                </h3>
                                <div className="space-y-4">
                                  {(
                                    activeAnalysis as AiAnalysis
                                  ).compatibilityPoints.map((point) => (
                                    <AnalysisItem
                                      key={point.area}
                                      icon={CheckCircle}
                                      iconColor="text-green-500"
                                      {...point}
                                    />
                                  ))}
                                </div>
                              </div>
                            </TabsContent>
                            <TabsContent
                              value="challenges"
                              className="space-y-6 mt-0"
                            >
                              <div>
                                <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                  <AlertTriangle className="w-5 h-5 text-amber-500" />
                                  {dict.analysis.challengesTitle}
                                </h3>
                                <div className="space-y-4">
                                  {(
                                    activeAnalysis as AiAnalysis
                                  ).potentialChallenges.map((challenge) => (
                                    <AnalysisItem
                                      key={challenge.area}
                                      icon={AlertTriangle}
                                      iconColor="text-amber-500"
                                      {...challenge}
                                    />
                                  ))}
                                </div>
                              </div>
                            </TabsContent>
                            <TabsContent value="comparison" className="mt-0">
                              <ComparisonTable
                                target={targetCandidate}
                                comparison={activeComparisonCandidate}
                                dict={dict.comparisonTable}
                                language={language}
                              />
                            </TabsContent>
                            <TabsContent
                              value="conversation"
                              className="space-y-4 mt-0"
                            >
                              <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <MessageSquare className="w-5 h-5 text-indigo-500" />
                                {dict.analysis.conversationStartersTitle}
                              </h3>
                              <ul className="space-y-3 list-inside">
                                {(
                                  activeAnalysis as AiAnalysis
                                ).suggestedConversationStarters.map(
                                  (starter, index) => (
                                    <li
                                      key={index}
                                      className="flex items-start gap-2 p-2 rounded-md hover:bg-indigo-50/50"
                                    >
                                      <MessageSquare className="w-4 h-4 text-indigo-400 mt-1 flex-shrink-0" />
                                      <span className="text-sm text-gray-700">
                                        {starter}
                                      </span>
                                    </li>
                                  )
                                )}
                              </ul>
                            </TabsContent>
                          </>
                        )}
                    </motion.div>
                  </AnimatePresence>
                </ScrollArea>
              </Tabs>
            </>
          )}
        </main>
      </div>
    </DialogContent>
  );
};
export const AiMatchAnalysisDialog = (props: AiMatchAnalysisDialogProps) => {
  const { isOpen, onClose } = props;
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      {isOpen && <DialogBody {...props} />}
    </Dialog>
  );
};
--- End of Content for AiMatchAnalysisDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AiMatchmakerProfileAdvisorDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/dialogs/AiMatchmakerProfileAdvisorDialog.tsx
'use client';

import React, { useState, useEffect, useCallback } from 'react'; // הוספנו useCallback
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogClose,
} from '@/components/ui/dialog';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, AlertTriangle, X, Bot, RefreshCw } from 'lucide-react'; // הוספנו אייקון לרענון
import { toast } from 'sonner';
import type { Candidate } from '../types/candidates';
import type { AiProfileAnalysisResult } from '@/lib/services/aiService';
import AnalysisResultDisplay from '@/components/profile/sections/AnalysisResultDisplay';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import { Button } from '@/components/ui/button'; // הוספנו ייבוא לכפתור

interface AiMatchmakerProfileAdvisorDialogProps {
  candidate: Candidate | null;
  isOpen: boolean;
  onClose: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['aiProfileAdvisor'];
  locale: string;
}

export const AiMatchmakerProfileAdvisorDialog: React.FC<
  AiMatchmakerProfileAdvisorDialogProps
> = ({ candidate, isOpen, onClose, dict, locale }) => {
  const [analysis, setAnalysis] = useState<AiProfileAnalysisResult | null>(
    null
  );
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // 1. הוספנו פונקציה ייעודית לאחזור הנתונים, בדומה לקובץ שהצגת.
  // השימוש ב-useCallback מונע יצירה מחדש של הפונקציה בכל רינדור.
  const getAnalysis = useCallback(
    async (forceRefresh = false) => {
      // אם אין מועמד או שאנחנו כבר טוענים, אין מה להמשיך
      if (!candidate || isLoading) return;

      // אם יש כבר ניתוח ולא ביקשנו לרענן בכוח, אל תעשה כלום
      if (analysis && !forceRefresh) return;

      setIsLoading(true);
      setError(null);
      if (!forceRefresh) {
        setAnalysis(null); // אפס רק אם זו לא טעינה חוזרת
      }

      try {
        const response = await fetch('/api/ai/matchmaker/analyze-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: candidate.id }),
        });
        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Error getting profile analysis.');
        }
        setAnalysis(result.data);
      } catch (err) {
        const errorMessage =
          err instanceof Error ? err.message : 'An unexpected error occurred.';
        setError(errorMessage);
        toast.error(dict.toast.errorTitle, {
          description: dict.toast.errorDescription.replace(
            '{{error}}',
            errorMessage
          ),
        });
      } finally {
        setIsLoading(false);
      }
    },
    [candidate, isLoading, analysis, dict.toast]
  ); // התלויות של הפונקציה

  // 2. useEffect חדש וחכם שמפעיל את האחזור רק פעם אחת כשהדיאלוג נפתח
  useEffect(() => {
    if (isOpen) {
      getAnalysis();
    } else {
      // 3. איפוס ה-State כשהדיאלוג נסגר, כדי שתמיד יטען מחדש עבור מועמד חדש
      setAnalysis(null);
      setError(null);
      setIsLoading(false);
    }
  }, [isOpen, getAnalysis]);

  const handleOpenChange = (open: boolean) => {
    if (!open) {
      onClose();
    }
  };

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogContent
        className="max-w-4xl w-[95vw] h-[90vh] flex flex-col p-0"
        dir={direction}
      >
        <DialogHeader className="p-4 border-b">
          <div className="flex justify-between items-center">
            <DialogTitle className="flex items-center gap-2 text-xl">
              <Bot className="w-6 h-6 text-indigo-500" />
              <span>
                {dict.dialogTitle} {candidate?.firstName} {candidate?.lastName}
              </span>
            </DialogTitle>
            <DialogClose asChild>
              <button className="rounded-full p-1.5 text-gray-500 hover:text-gray-800 transition-colors">
                <X className="h-5 w-5" />
              </button>
            </DialogClose>
          </div>
          <DialogDescription>{dict.dialogDescription}</DialogDescription>
        </DialogHeader>

        <div className="flex-grow overflow-y-auto p-4 md:p-6 bg-slate-50/50">
          {isLoading && (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <Loader2 className="w-12 h-12 text-indigo-500 animate-spin mb-4" />
              <p className="text-lg font-semibold text-gray-700">
                {dict.loadingTitle}
              </p>
              <p className="text-sm text-gray-500 mt-2">
                {dict.loadingDescription}
              </p>
            </div>
          )}
          {error && !isLoading && (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <Alert variant="destructive" className="max-w-md">
                <AlertTriangle className="h-5 w-5" />
                <AlertTitle>{dict.errorAlertTitle}</AlertTitle>
                <AlertDescription>
                  <p>{dict.errorAlertDescription}</p>
                  <p className="text-xs mt-2">{error}</p>
                </AlertDescription>
              </Alert>
              {/* כפתור לניסיון חוזר */}
              <Button
                onClick={() => getAnalysis(true)}
                variant="outline"
                className="mt-4"
              >
                <RefreshCw className="w-4 h-4 ml-2" />
                {dict.retryButton || 'נסה שוב'}
              </Button>
            </div>
          )}
          {analysis && !isLoading && (
            <AnalysisResultDisplay
              analysis={analysis}
              dict={dict.analysisResult}
              locale={locale}
            />
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for AiMatchmakerProfileAdvisorDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\ProfileFeedbackDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/dialogs/ProfileFeedbackDialog.tsx
'use client';

import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { Loader2, Send, MailPlus, Eye, Edit } from 'lucide-react';
import ReactQuill from 'react-quill-new';
import 'react-quill-new/dist/quill.snow.css';
import type { Candidate } from '../types/candidates';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface ProfileFeedbackDialogProps {
  isOpen: boolean;
  onClose: () => void;
  candidate: Candidate | null;
  locale: string;
  dict: MatchmakerPageDictionary['candidatesManager']['profileFeedbackDialog'];
}

export const ProfileFeedbackDialog: React.FC<ProfileFeedbackDialogProps> = ({
  isOpen,
  onClose,
  candidate,
  locale,
  dict,
}) => {
  const [htmlContent, setHtmlContent] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [viewMode, setViewMode] = useState<'preview' | 'edit'>('preview');

  const isRtl = locale === 'he';
  const direction = isRtl ? 'rtl' : 'ltr';

  useEffect(() => {
    const prepareEmail = async () => {
      if (isOpen && candidate) {
        setIsLoading(true);
        setHtmlContent('');
        setViewMode('preview'); // התחל במצב תצוגה מקדימה
        try {
          const response = await fetch(
            '/api/ai/matchmaker/prepare-feedback-email',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: candidate.id,
                locale,
                isAutomated: false,
              }),
            }
          );
          const data = await response.json();
          if (data.success) {
            setHtmlContent(data.htmlContent);
          } else {
            throw new Error(data.error || 'Failed to prepare email content');
          }
        } catch (error) {
          toast.error(dict.toasts.loadError);
          console.error(error);
          onClose();
        } finally {
          setIsLoading(false);
        }
      }
    };
    prepareEmail();
  }, [isOpen, candidate, locale, dict, onClose]);

  const handleSendEmail = async () => {
    if (!candidate) return;
    setIsSending(true);
    try {
      const response = await fetch('/api/ai/matchmaker/send-feedback-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userEmail: candidate.email,
          subject: dict.emailSubject.replace('{{name}}', candidate.firstName),
          htmlContent: htmlContent,
        }),
      });
      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error || 'Failed to send email');
      }
      toast.success(dict.toasts.sendSuccess);
      onClose();
    } catch (error) {
      toast.error(dict.toasts.sendError);
      console.error(error);
    } finally {
      setIsSending(false);
    }
  };

  // ReactQuill modules עם תמיכה ב-RTL
  const quillModules = {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ color: [] }, { background: [] }],
      [{ list: 'ordered' }, { list: 'bullet' }],
      [{ align: [] }],
      ['link'],
      ['clean'],
    ],
  };

  const quillFormats = [
    'header',
    'bold', 'italic', 'underline',
    'color', 'background',
    'list', 'bullet',
    'align',
    'link'
  ];

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent 
        className="max-w-6xl w-[95vw] h-[90vh] flex flex-col p-0"
        dir={direction}
      >
        <DialogHeader className="p-6 border-b">
          <div className="flex justify-between items-center">
            <DialogTitle className="flex items-center gap-2">
              <MailPlus className="w-5 h-5" />
              {dict.title.replace(
                '{{name}}',
                `${candidate?.firstName} ${candidate?.lastName}`
              )}
            </DialogTitle>
            <div className="flex gap-2">
              <Button
                variant={viewMode === 'preview' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setViewMode('preview')}
                disabled={isLoading}
              >
                <Eye className="w-4 h-4 mr-1" />
                תצוגה מקדימה
              </Button>
              <Button
                variant={viewMode === 'edit' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setViewMode('edit')}
                disabled={isLoading}
              >
                <Edit className="w-4 h-4 mr-1" />
                עריכה
              </Button>
            </div>
          </div>
          <DialogDescription>
            {viewMode === 'preview' ? 
              'תצוגה מקדימה של המייל כפי שיתקבל אצל המשתמש' : 
              dict.editPrompt
            }
          </DialogDescription>
        </DialogHeader>

        <div className="flex-grow overflow-y-auto" dir={direction}>
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <Loader2 className="w-8 h-8 animate-spin" />
              <p className="ml-4">{dict.preparingEmail}</p>
            </div>
          ) : viewMode === 'preview' ? (
            // תצוגה מקדימה - HTML מלא עם כיוון נכון
            <div 
              className="p-4"
              dir={direction}
              style={{ 
                direction: direction,
                textAlign: isRtl ? 'right' : 'left'
              }}
            >
              <div 
                dangerouslySetInnerHTML={{ __html: htmlContent }}
                style={{
                  fontFamily: isRtl ? 'Arial, sans-serif' : 'inherit',
                  direction: direction,
                  textAlign: isRtl ? 'right' : 'left'
                }}
              />
            </div>
          ) : (
            // מצב עריכה
            <div className="p-1" dir={direction}>
              <style>
                {`
                  .ql-editor {
                    direction: ${direction} !important;
                    text-align: ${isRtl ? 'right' : 'left'} !important;
                    font-family: ${isRtl ? 'Arial, sans-serif' : 'inherit'} !important;
                  }
                  .ql-toolbar {
                    direction: ${direction} !important;
                  }
                  ${isRtl ? `
                    .ql-toolbar .ql-formats {
                      margin-left: 15px;
                      margin-right: 0;
                    }
                    .ql-toolbar .ql-formats:first-child {
                      margin-left: 0;
                    }
                  ` : ''}
                `}
              </style>
              <ReactQuill
                theme="snow"
                value={htmlContent}
                onChange={setHtmlContent}
                modules={quillModules}
                formats={quillFormats}
                style={{ 
                  height: 'calc(100vh - 200px)', 
                  direction: direction,
                }}
                placeholder={isRtl ? 'הקלד כאן את תוכן המייל...' : 'Type your email content here...'}
              />
            </div>
          )}
        </div>

        <DialogFooter className="p-4 border-t bg-gray-50" dir={direction}>
          <div className={`flex gap-2 ${isRtl ? 'flex-row-reverse' : ''}`}>
            <Button variant="outline" onClick={onClose} disabled={isSending}>
              {dict.buttons.cancel}
            </Button>
            <Button onClick={handleSendEmail} disabled={isLoading || isSending}>
              {isSending ? (
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              ) : (
                <Send className="w-4 h-4 mr-2" />
              )}
              {isSending ? dict.buttons.sending : dict.buttons.send}
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for ProfileFeedbackDialog.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\filterUtils
--------------------------------------------------------------------------------
Content:
--- End of Content for filterUtils ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useCandidates.ts
--------------------------------------------------------------------------------
Content:
import { useState, useEffect, useMemo, useCallback } from 'react';
import Papa from 'papaparse';
import type { Candidate, CandidatesFilter } from '../types/candidates';
import type { CandidateProfile } from '../types/candidates';
import { Dispatch, SetStateAction } from 'react';

export interface UseCandidatesReturn {
  loading: boolean;
  error: string | null;
  candidates: Candidate[];
  maleCandidates: Candidate[];
  femaleCandidates: Candidate[];
  filteredCandidates: Candidate[];
  filters: CandidatesFilter;
  setFilters: Dispatch<SetStateAction<CandidatesFilter>>;
  refresh: () => Promise<void>;
  totalCount: number;
  filteredCount: number;
  maleCount: number;
  femaleCount: number;
  searchResults: {
    term: string;
    count: number;
    male: number;
    female: number;
  } | null;
  exportCandidates: (candidates: Candidate[], filters: CandidatesFilter) => Promise<void>;
  updateCandidate: (id: string, updates: Partial<CandidateProfile>) => Promise<void>;
  sorting: {
    field: string;
    direction: 'asc' | 'desc';
  };
  setSorting: (field: string, direction: 'asc' | 'desc') => void;
  searchSuggestions: (term: string) => Promise<Candidate[]>;
}

export const useCandidates = (initialFilters: CandidatesFilter = {}): UseCandidatesReturn => {
  // Base states
  const [candidates, setCandidates] = useState<Candidate[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [filters, setFilters] = useState<CandidatesFilter>(initialFilters);
  const [searchResults, setSearchResults] = useState<{
    term: string;
    count: number;
    male: number;
    female: number;
  } | null>(null);
  const [sorting, setSortingState] = useState<{
    field: string;
    direction: 'asc' | 'desc';
  }>({
    field: 'lastActive',
    direction: 'desc',
  });

  // Helper function to calculate age
  const calculateAge = useCallback((birthDate: Date): number => {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  }, []);

  // Fetch candidates data
  const fetchCandidates = async () => {
    try {
      setLoading(true);
      setError(null);
      
      const response = await fetch('/api/matchmaker/candidates');
      if (!response.ok) {
        throw new Error(await response.text());
      }
      
      const data = await response.json();
     
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to load candidates');
      }
  
      setCandidates(data.clients);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An unexpected error occurred');
      console.error('Error fetching candidates:', err);
    } finally {
      setLoading(false);
    }
  };

  // Set sorting field and direction
  const setSorting = useCallback((field: string, direction: 'asc' | 'desc') => {
    setSortingState({ field, direction });
  }, []);

  // Search suggestions based on a term
  const searchSuggestions = useCallback(async (term: string): Promise<Candidate[]> => {
    if (!term || term.length < 2) return [];
    
    // Local search implementation for quick response
    const searchTerm = term.toLowerCase();
    return candidates.filter(candidate => {
      const searchableText = `
        ${candidate.firstName} 
        ${candidate.lastName} 
        ${candidate.profile.occupation || ''} 
        ${candidate.profile.city || ''}
        ${candidate.profile.religiousLevel || ''}
      `.toLowerCase();
      
      return searchableText.includes(searchTerm);
    }).slice(0, 10);
    
    // Alternatively, you can implement an API call for server-side search
    // if the dataset is very large
  }, [candidates]);

  const sortCandidates = useCallback((candidatesList: Candidate[], field: string, direction: 'asc' | 'desc') => {
    return [...candidatesList].sort((a, b) => {
      let valueA, valueB;
      
      switch (field) {
        case 'name':
          valueA = `${a.firstName} ${a.lastName}`.toLowerCase();
          valueB = `${b.firstName} ${b.lastName}`.toLowerCase();
          break;
        case 'age':
          valueA = calculateAge(a.profile.birthDate);
          valueB = calculateAge(b.profile.birthDate);
          break;
        case 'city':
          valueA = (a.profile.city || '').toLowerCase();
          valueB = (b.profile.city || '').toLowerCase();
          break;
        case 'religiousLevel':
          valueA = (a.profile.religiousLevel || '').toLowerCase();
          valueB = (b.profile.religiousLevel || '').toLowerCase();
          break;
        case 'lastActive':
          valueA = a.profile.lastActive ? new Date(a.profile.lastActive).getTime() : 0;
          valueB = b.profile.lastActive ? new Date(b.profile.lastActive).getTime() : 0;
          break;
        case 'registrationDate':
          valueA = new Date(a.createdAt).getTime();
          valueB = new Date(b.createdAt).getTime();
          break;
        case 'height':
          valueA = a.profile.height || 0;
          valueB = b.profile.height || 0;
          break;
        default:
          valueA = 0;
          valueB = 0;
      }
      
      if (valueA < valueB) return direction === 'asc' ? -1 : 1;
      if (valueA > valueB) return direction === 'asc' ? 1 : -1;
      return 0;
    });
  }, [calculateAge]);
  
  // פונקציה לבדיקה אם מועמד עומד בקריטריוני חיפוש
  const checkSearchMatch = useCallback((candidate: Candidate, searchTerm: string): boolean => {
    if (!searchTerm) return true;
    
    // נרמול החיפוש
    const normalizedTerm = searchTerm.toLowerCase().trim();
    if (!normalizedTerm) return true;
    
    // בדיקת התאמה בשדות השונים
    const fullName = `${candidate.firstName} ${candidate.lastName}`.toLowerCase();
    const city = (candidate.profile.city || '').toLowerCase();
    const occupation = (candidate.profile.occupation || '').toLowerCase();
    const religiousLevel = (candidate.profile.religiousLevel || '').toLowerCase();
    
    return (
      fullName.includes(normalizedTerm) || 
      city.includes(normalizedTerm) || 
      occupation.includes(normalizedTerm) || 
      religiousLevel.includes(normalizedTerm)
    );
  }, []);

  // בקובץ useCandidates.ts - לעדכן את החלק של filteredCandidates
  const filteredCandidates = useMemo(() => {
    console.log("Filtering candidates with filters:", filters);
    
    // אם הסינון הנפרד מופעל, נשתמש בפילטרים הכלליים בלבד ללא מגדר
    const currentFilters = filters.separateFiltering 
      ? { ...filters, gender: undefined }
      : filters;

    let results = candidates.filter(candidate => {
      // סינון לפי מגדר רק אם הסינון הנפרד כבוי
      if (!filters.separateFiltering && currentFilters.gender && candidate.profile.gender !== currentFilters.gender) {
        return false;
      }
      if (currentFilters.source && candidate.source !== currentFilters.source) {
    return false;
}
      // בדיקת גיל מותאמת
      if (currentFilters.ageRange) {
        try {
          const age = calculateAge(candidate.profile.birthDate);
          if (age < currentFilters.ageRange.min || age > currentFilters.ageRange.max) {
            return false;
          }
        } catch (err) {
          console.error("Error calculating age for candidate:", candidate.id, err);
        }
      }
      
      // סינון סטטוס משתמש
      if (filters.userStatus && candidate.status !== filters.userStatus) {
        return false;
      }
   // סינון סטטוס משתמש
      if (filters.userStatus && candidate.status !== filters.userStatus) {
        return false;
      }
      // סינון סטטוס זמינות - ודא המרה נכונה של הטיפוס
      if (filters.availabilityStatus && 
          candidate.profile.availabilityStatus !== filters.availabilityStatus) {
        return false;
      }
      
      // בדיקת גובה
      if (filters.heightRange && candidate.profile.height) {
        if (
          candidate.profile.height < filters.heightRange.min || 
          candidate.profile.height > filters.heightRange.max
        ) {
          return false;
        }
      }

      // בדיקת רמת דתיות
      if (filters.religiousLevel && candidate.profile.religiousLevel !== filters.religiousLevel) {
        return false;
      }

      // בדיקת ערים
      if (filters.cities?.length && candidate.profile.city) {
        if (!filters.cities.includes(candidate.profile.city)) {
          return false;
        }
      }

      // בדיקת תחומי עיסוק
      if (filters.occupations?.length && candidate.profile.occupation) {
        if (!filters.occupations.includes(candidate.profile.occupation)) {
          return false;
        }
      }

      // בדיקת השכלה
      if (filters.educationLevel && candidate.profile.education !== filters.educationLevel) {
        return false;
      }

      // בדיקת מצב משפחתי
      if (filters.maritalStatus && candidate.profile.maritalStatus !== filters.maritalStatus) {
        return false;
      }

      // בדיקת אימות
      if (filters.isVerified !== undefined && candidate.isVerified !== filters.isVerified) {
        return false;
      }

      // בדיקת המלצות
   
      // בדיקת פעילות אחרונה
      if (filters.lastActiveDays && candidate.profile.lastActive) {
        const lastActive = new Date(candidate.profile.lastActive);
        const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
        if (daysDiff > filters.lastActiveDays) {
          return false;
        }
      }

      // בדיקת שלמות פרופיל
      if (filters.isProfileComplete !== undefined && 
          candidate.isProfileComplete !== filters.isProfileComplete) {
        return false;
      }

      // בדיקת חיפוש כללי - רק אם אין סינון נפרד
      if (!filters.separateFiltering && currentFilters.searchQuery) {
        return checkSearchMatch(candidate, currentFilters.searchQuery);
      }

      return true;
    });

    // מיון התוצאות
    if (sorting.field && sorting.direction) {
      results = sortCandidates(results, sorting.field, sorting.direction);
    }

    return results;
  }, [candidates, filters, calculateAge, sorting.field, sorting.direction, sortCandidates, checkSearchMatch]);

  // חלוקה למועמדים ומועמדות עם תמיכה בחיפוש נפרד
  const maleCandidates = useMemo(() => {
    // בסינון נפרד, נבדוק גם את החיפוש הספציפי לגברים
      return filteredCandidates
        .filter(c => c.profile.gender === 'MALE')
        .filter(candidate => {
          // בדיקת פילטרים ספציפיים לגברים
          if (filters.maleFilters) {
            // בדיקת גיל
            if (filters.maleFilters.ageRange) {
              const age = calculateAge(candidate.profile.birthDate);
              if (age < filters.maleFilters.ageRange.min || age > filters.maleFilters.ageRange.max) {
                return false;
              }
            }
            
            // בדיקת גובה
            if (filters.maleFilters.heightRange && candidate.profile.height) {
              if (
                candidate.profile.height < filters.maleFilters.heightRange.min || 
                candidate.profile.height > filters.maleFilters.heightRange.max
              ) {
                return false;
              }
            }

            // בדיקת רמת דתיות
            if (filters.maleFilters.religiousLevel && candidate.profile.religiousLevel !== filters.maleFilters.religiousLevel) {
              return false;
            }

            // בדיקת ערים
            if (filters.maleFilters.cities?.length && candidate.profile.city) {
              if (!filters.maleFilters.cities.includes(candidate.profile.city)) {
                return false;
              }
            }

            // בדיקת תחומי עיסוק
            if (filters.maleFilters.occupations?.length && candidate.profile.occupation) {
              if (!filters.maleFilters.occupations.includes(candidate.profile.occupation)) {
                return false;
              }
            }

            // בדיקת השכלה
            if (filters.maleFilters.educationLevel && candidate.profile.education !== filters.maleFilters.educationLevel) {
              return false;
            }

            // בדיקת מצב משפחתי
            if (filters.maleFilters.maritalStatus && candidate.profile.maritalStatus !== filters.maleFilters.maritalStatus) {
              return false;
            }

            // בדיקת אימות
            if (filters.maleFilters.isVerified !== undefined && candidate.isVerified !== filters.maleFilters.isVerified) {
              return false;
            }

    

            // בדיקת פעילות אחרונה
            if (filters.maleFilters.lastActiveDays && candidate.profile.lastActive) {
              const lastActive = new Date(candidate.profile.lastActive);
              const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff > filters.maleFilters.lastActiveDays) {
                return false;
              }
            }

            // בדיקת שלמות פרופיל
            if (filters.maleFilters.isProfileComplete !== undefined && 
                candidate.isProfileComplete !== filters.maleFilters.isProfileComplete) {
              return false;
            }

            // בדיקת חיפוש ספציפי לפילטרים של הגברים
            if (filters.maleFilters.searchQuery) {
              return checkSearchMatch(candidate, filters.maleFilters.searchQuery);
            }
          }
          
          // בדיקת חיפוש נפרד לגברים
          if (filters.maleSearchQuery) {
            return checkSearchMatch(candidate, filters.maleSearchQuery);
          }
          
          return true;
        });
    
      }, [filteredCandidates, filters.maleFilters, filters.maleSearchQuery, calculateAge, checkSearchMatch]);
  const femaleCandidates = useMemo(() => {
    // בסינון נפרד, נבדוק גם את החיפוש הספציפי לנשים

      return filteredCandidates
        .filter(c => c.profile.gender === 'FEMALE')
        .filter(candidate => {
          // בדיקת פילטרים ספציפיים לנשים
          if (filters.femaleFilters) {
            // בדיקת גיל
            if (filters.femaleFilters.ageRange) {
              const age = calculateAge(candidate.profile.birthDate);
              if (age < filters.femaleFilters.ageRange.min || age > filters.femaleFilters.ageRange.max) {
                return false;
              }
            }
            
            // בדיקת גובה
            if (filters.femaleFilters.heightRange && candidate.profile.height) {
              if (
                candidate.profile.height < filters.femaleFilters.heightRange.min || 
                candidate.profile.height > filters.femaleFilters.heightRange.max
              ) {
                return false;
              }
            }

            // בדיקת רמת דתיות
            if (filters.femaleFilters.religiousLevel && candidate.profile.religiousLevel !== filters.femaleFilters.religiousLevel) {
              return false;
            }

            // בדיקת ערים
            if (filters.femaleFilters.cities?.length && candidate.profile.city) {
              if (!filters.femaleFilters.cities.includes(candidate.profile.city)) {
                return false;
              }
            }

            // בדיקת תחומי עיסוק
            if (filters.femaleFilters.occupations?.length && candidate.profile.occupation) {
              if (!filters.femaleFilters.occupations.includes(candidate.profile.occupation)) {
                return false;
              }
            }

            // בדיקת השכלה
            if (filters.femaleFilters.educationLevel && candidate.profile.education !== filters.femaleFilters.educationLevel) {
              return false;
            }

            // בדיקת מצב משפחתי
            if (filters.femaleFilters.maritalStatus && candidate.profile.maritalStatus !== filters.femaleFilters.maritalStatus) {
              return false;
            }

            // בדיקת אימות
            if (filters.femaleFilters.isVerified !== undefined && candidate.isVerified !== filters.femaleFilters.isVerified) {
              return false;
            }

       

            // בדיקת פעילות אחרונה
            if (filters.femaleFilters.lastActiveDays && candidate.profile.lastActive) {
              const lastActive = new Date(candidate.profile.lastActive);
              const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff > filters.femaleFilters.lastActiveDays) {
                return false;
              }
            }

            // בדיקת שלמות פרופיל
            if (filters.femaleFilters.isProfileComplete !== undefined && 
                candidate.isProfileComplete !== filters.femaleFilters.isProfileComplete) {
              return false;
            }

            // בדיקת חיפוש ספציפי לפילטרים של הנשים
            if (filters.femaleFilters.searchQuery) {
              return checkSearchMatch(candidate, filters.femaleFilters.searchQuery);
            }
          }
          
          // בדיקת חיפוש נפרד לנשים
          if (filters.femaleSearchQuery) {
            return checkSearchMatch(candidate, filters.femaleSearchQuery);
          }
          
          return true;
        });
      }, [filteredCandidates, filters.femaleFilters, filters.femaleSearchQuery, calculateAge, checkSearchMatch]);
  // עדכון תוצאות החיפוש
  useEffect(() => {
    if (!filters.separateFiltering && filters.searchQuery) {
      // מצב חיפוש רגיל
      setSearchResults({
        term: filters.searchQuery,
        count: filteredCandidates.length,
        male: maleCandidates.length,
        female: femaleCandidates.length
      });
    } else if (filters.separateFiltering) {
      // במצב חיפוש נפרד, לא מציגים תוצאות חיפוש מאוחדות
      setSearchResults(null);
    } else {
      setSearchResults(null);
    }
  }, [filteredCandidates, maleCandidates, femaleCandidates, filters.searchQuery, filters.separateFiltering]);

  // Export candidates to CSV
  const exportCandidates = async (
    candidates: Candidate[], 
    filters: CandidatesFilter
  ): Promise<void> => {
    try {
      // Prepare data for export
      const exportData = candidates.map(candidate => ({
        'שם פרטי': candidate.firstName,
        'שם משפחה': candidate.lastName,
        'גיל': calculateAge(candidate.profile.birthDate),
        'מגדר': candidate.profile.gender === 'MALE' ? 'זכר' : 'נקבה',
        'עיר': candidate.profile.city || '',
        'גובה': candidate.profile.height || '',
        'רמת דתיות': candidate.profile.religiousLevel || '',
        'תעסוקה': candidate.profile.occupation || '',
        'השכלה': candidate.profile.education || '',
        'מצב משפחתי': candidate.profile.maritalStatus || '',
        'סטטוס זמינות': candidate.profile.availabilityStatus || '',
        'מאומת': candidate.isVerified ? 'כן' : 'לא',
        'פעילות אחרונה': candidate.profile.lastActive 
          ? new Date(candidate.profile.lastActive).toLocaleDateString('he-IL')
          : ''
      }));

      // Add filter info to filename
      const filenameSegments = ['candidates'];
      
      if (filters.gender) {
        filenameSegments.push(filters.gender === 'MALE' ? 'male' : 'female');
      }
      
      if (filters.religiousLevel) {
        filenameSegments.push(filters.religiousLevel.replace(/ /g, '-'));
      }
      
      if (filters.cities?.length === 1) {
        filenameSegments.push(filters.cities[0].replace(/ /g, '-'));
      }
      
      // Convert to CSV
      const csv = Papa.unparse(exportData);
      
      // Create and download file
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const timestamp = new Date().toISOString().split('T')[0];
      
      link.setAttribute('href', url);
      link.setAttribute('download', `${filenameSegments.join('_')}_${timestamp}.csv`);
      document.body.appendChild(link);
      
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('Error exporting candidates:', error);
      throw new Error('Failed to export candidates');
    }
  };

  // Update candidate
  const updateCandidate = async (
    id: string, 
    updates: Partial<CandidateProfile>
  ): Promise<void> => {
    try {
      const response = await fetch(`/api/matchmaker/candidates/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      });
      
      if (!response.ok) {
        throw new Error('Failed to update candidate');
      }
      
      // Refresh candidates list after update
      await fetchCandidates();
    } catch (error) {
      console.error('Error updating candidate:', error);
      throw error;
    }
  };

  // Load candidates on mount
  useEffect(() => {
    fetchCandidates();
  }, []);

  // Return interface
  return {
    loading,
    error,
    candidates,
    filteredCandidates,
    maleCandidates,
    femaleCandidates,
    filters,
    setFilters,
    refresh: fetchCandidates,
    totalCount: candidates.length,
    filteredCount: filteredCandidates.length,
    maleCount: maleCandidates.length,
    femaleCount: femaleCandidates.length,
    searchResults,
    exportCandidates,
    updateCandidate,
    sorting,
    setSorting,
    searchSuggestions
  };
};
--- End of Content for useCandidates.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useFilterLogic.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/hooks/useFilterLogic.ts - גרסה משופרת

import { useState, useEffect, useMemo, useCallback } from 'react';
import type {
  FilterState,
  SavedFilter,
  FilterOption,
  FilterChangeHandler,  
} from '../types/filters';
import { DEFAULT_FILTER_STATE } from '../types/filters'; 

type SavedFilterFromStorage = Omit<SavedFilter, 'createdAt'> & {
  createdAt: string;
};

interface SearchHistoryItemFromStorage {
  query: string;
  timestamp: string;
}
interface UseFilterLogicProps {
  onFilterChange?: FilterChangeHandler;
  defaultFilters?: Partial<FilterState>;
  localStorageKey?: string;
}

export const useFilterLogic = ({
  onFilterChange,
  defaultFilters = {},
  localStorageKey = 'candidateFilters'
}: UseFilterLogicProps = {}) => {
  // States
  const [filters, setFilters] = useState<FilterState>({
    ...DEFAULT_FILTER_STATE,
    ...defaultFilters
  });
  
  const [savedFilters, setSavedFilters] = useState<SavedFilter[]>([]);
  const [recentSearches, setRecentSearches] = useState<string[]>([]);
  const [searchHistory, setSearchHistory] = useState<{query: string, timestamp: Date}[]>([]);
  const [lastAppliedFilter, setLastAppliedFilter] = useState<string | null>(null);

  // Load saved filters and history from localStorage
  useEffect(() => {
    try {
      // Load saved filters
      const savedPrefs = localStorage.getItem(localStorageKey);
      if (savedPrefs) {
        const parsed = JSON.parse(savedPrefs);
        setSavedFilters(parsed.map((filter: SavedFilterFromStorage) => ({
          ...filter,
          createdAt: new Date(filter.createdAt)
        })));
      }

      // Load recent searches
      const searches = localStorage.getItem(`${localStorageKey}_recent_searches`);
      if (searches) {
        setRecentSearches(JSON.parse(searches));
      }

      // Load search history
      const history = localStorage.getItem(`${localStorageKey}_search_history`);
      if (history) {
        setSearchHistory(JSON.parse(history).map((item: SearchHistoryItemFromStorage) => ({
          ...item,
          timestamp: new Date(item.timestamp)
        })));
      }
    } catch (error) {
      console.error('Error loading saved filters:', error);
    }
  }, [localStorageKey]);

  // עדכון פילטרים כללי
  const updateFilters = useCallback((newFilters: Partial<FilterState>) => {
    console.log("updateFilters called with:", newFilters);
    
    setFilters(prev => {
      const updated = { ...prev, ...newFilters };
      console.log("Updated filters:", updated);
      
      // אם יש מחרוזת חיפוש חדשה, עדכן את היסטורית החיפוש
      if (newFilters.searchQuery && newFilters.searchQuery !== prev.searchQuery) {
        const newQuery = newFilters.searchQuery;
        console.log("New search query detected:", newQuery);
        
        // עדכון היסטוריית החיפוש
        const updatedHistory = [
          { query: newQuery, timestamp: new Date() },
          ...searchHistory.filter(item => item.query !== newQuery).slice(0, 9)
        ];
        
        setSearchHistory(updatedHistory);
        setRecentSearches(updatedHistory.map(item => item.query));
        
        // שמירה ב-localStorage
        try {
          localStorage.setItem(
            `${localStorageKey}_recent_searches`, 
            JSON.stringify(updatedHistory.map(item => item.query))
          );
          localStorage.setItem(
            `${localStorageKey}_search_history`,
            JSON.stringify(updatedHistory.map(item => ({
              query: item.query,
              timestamp: item.timestamp.toISOString()
            })))
          );
        } catch (e) {
          console.error("Error saving search history:", e);
        }
      }
      
      // טיפול בחיפוש נפרד לגברים
      if (newFilters.maleSearchQuery && newFilters.maleSearchQuery !== prev.maleSearchQuery) {
        // כאן אפשר לייצר היסטוריה נפרדת לחיפושי גברים או לשמור בהיסטוריה הכללית
        console.log("New male search query:", newFilters.maleSearchQuery);
      }
      
      // טיפול בחיפוש נפרד לנשים
      if (newFilters.femaleSearchQuery && newFilters.femaleSearchQuery !== prev.femaleSearchQuery) {
        // כאן אפשר לייצר היסטוריה נפרדת לחיפושי נשים או לשמור בהיסטוריה הכללית
        console.log("New female search query:", newFilters.femaleSearchQuery);
      }

      // קריאה לפונקציית callback
      if (onFilterChange) {
        console.log("Calling onFilterChange with updated filters");
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange, searchHistory, localStorageKey, setRecentSearches, setSearchHistory]);

  // Reset filters
  const resetFilters = useCallback(() => {
    const defaultState: FilterState = {
      ...DEFAULT_FILTER_STATE,
      ...defaultFilters
    };

    setFilters(defaultState);
    setLastAppliedFilter(null);
    onFilterChange?.(defaultState);
  }, [defaultFilters, onFilterChange]);

  // Clear recent searches
  const clearRecentSearches = useCallback(() => {
    setRecentSearches([]);
    localStorage.removeItem(`${localStorageKey}_recent_searches`);
  }, [localStorageKey]);

  // Save new filter
  const saveFilter = useCallback(async (name: string, filters: FilterState) => {
    const newFilter: SavedFilter = {
      id: Date.now().toString(),
      name,
      filters,
      isDefault: false,
      createdAt: new Date()
    };

    setSavedFilters(prev => {
      const updated = [...prev, newFilter];
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });

    return newFilter;
  }, [localStorageKey]);

  // פונקציה משופרת להחלפת מצב הסינון הנפרד
  const toggleSeparateFiltering = useCallback(() => {
    console.log("toggleSeparateFiltering called");
    
    setFilters(prev => {
      const newState = {
        ...prev,
        separateFiltering: !prev.separateFiltering
      };
      
      console.log(`Changing separateFiltering from ${prev.separateFiltering} to ${newState.separateFiltering}`);
      
      return newState;
    });
  }, []);

  // פונקציה משופרת לעדכון סינון גברים
  const updateMaleFilters = useCallback((maleFilters: Partial<FilterState>) => {
    setFilters(prev => {
      const updatedMaleFilters = {
        ...prev.maleFilters,
        ...maleFilters
      };
      
      // אם יש עדכון של מחרוזת חיפוש ספציפית לגברים
      if (maleFilters.searchQuery !== undefined) {
        const updated = {
          ...prev,
          maleFilters: updatedMaleFilters,
          maleSearchQuery: maleFilters.searchQuery // שמירת החיפוש גם בשדה הנפרד
        };
        
        // קריאה לפונקציית callback אם קיימת
        if (onFilterChange) {
          onFilterChange(updated);
        }
        
        return updated;
      }
      
      const updated = {
        ...prev,
        maleFilters: updatedMaleFilters
      };
      
      // קריאה לפונקציית callback אם קיימת
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // פונקציה משופרת לעדכון סינון נשים
  const updateFemaleFilters = useCallback((femaleFilters: Partial<FilterState>) => {
    setFilters(prev => {
      const updatedFemaleFilters = {
        ...prev.femaleFilters,
        ...femaleFilters
      };
      
      // אם יש עדכון של מחרוזת חיפוש ספציפית לנשים
      if (femaleFilters.searchQuery !== undefined) {
        const updated = {
          ...prev,
          femaleFilters: updatedFemaleFilters,
          femaleSearchQuery: femaleFilters.searchQuery // שמירת החיפוש גם בשדה הנפרד
        };
        
        // קריאה לפונקציית callback אם קיימת
        if (onFilterChange) {
          onFilterChange(updated);
        }
        
        return updated;
      }
      
      const updated = {
        ...prev,
        femaleFilters: updatedFemaleFilters
      };
      
      // קריאה לפונקציית callback אם קיימת
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  const updateMaleSearchQuery = useCallback((query: string) => {
    setFilters(prev => {
      // שומרים את החיפוש בשדה הייעודי
      const updated = {
        ...prev,
        maleSearchQuery: query
      };
      
      // מעדכנים גם את הפילטרים הספציפיים לגברים אם פעיל סינון נפרד
      if (prev.separateFiltering) {
        updated.maleFilters = {
          ...prev.maleFilters,
          searchQuery: query
        };
      }
      
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);
  
  // פונקציה חדשה לעדכון חיפוש נפרד לנשים
  const updateFemaleSearchQuery = useCallback((query: string) => {
    setFilters(prev => {
      // שומרים את החיפוש בשדה הייעודי
      const updated = {
        ...prev,
        femaleSearchQuery: query
      };
      
      // מעדכנים גם את הפילטרים הספציפיים לנשים אם פעיל סינון נפרד
      if (prev.separateFiltering) {
        updated.femaleFilters = {
          ...prev.femaleFilters,
          searchQuery: query
        };
      }
      
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // פונקציה משופרת להעתקת סינון מצד אחד לשני
  const copyFilters = useCallback((source: 'male' | 'female', target: 'male' | 'female') => {
    setFilters(prev => {
      const sourceFilters = source === 'male' ? prev.maleFilters : prev.femaleFilters;
      
      if (!sourceFilters) {
        return prev;
      }
      
      const updated = { ...prev };
      
      if (target === 'male') {
        updated.maleFilters = { ...sourceFilters };
      } else {
        updated.femaleFilters = { ...sourceFilters };
      }
      
      // קריאה לפונקציית callback אם קיימת
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // Update existing filter
  const updateSavedFilter = useCallback((id: string, updates: Partial<SavedFilter>) => {
    setSavedFilters(prev => {
      const updated = prev.map(filter => 
        filter.id === id ? { ...filter, ...updates } : filter
      );
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });
  }, [localStorageKey]);

  // Delete filter
  const deleteFilter = useCallback((id: string) => {
    setSavedFilters(prev => {
      const updated = prev.filter(f => f.id !== id);
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      
      if (lastAppliedFilter === id) {
        setLastAppliedFilter(null);
      }
      
      return updated;
    });
  }, [localStorageKey, lastAppliedFilter]);

  // Set default filter
  const setDefaultFilter = useCallback((id: string) => {
    setSavedFilters(prev => {
      const updated = prev.map(f => ({
        ...f,
        isDefault: f.id === id
      }));
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });
  }, [localStorageKey]);

  // Load saved filter - תמיכה בסינון נפרד
  const loadSavedFilter = useCallback((id: string) => {
    const filter = savedFilters.find(f => f.id === id);
    if (filter) {
      // בדוק אם יש בפילטר השמור מידע לגבי סינון נפרד
      setFilters({ 
        ...filter.filters, 
        savedFilterId: id,
        // וודא שיש תמיד את המאפיינים האלה, גם אם אינם מוגדרים בפילטר המקורי
        separateFiltering: true as boolean,        maleFilters: filter.filters.maleFilters || {},
        femaleFilters: filter.filters.femaleFilters || {}
      });
      
      setLastAppliedFilter(id);
      onFilterChange?.({ 
        ...filter.filters, 
        savedFilterId: id,
        separateFiltering: true as boolean,        maleFilters: filter.filters.maleFilters || {},
        femaleFilters: filter.filters.femaleFilters || {} 
      });
    }
  }, [savedFilters, onFilterChange]);

  // Apply popular filter
  const applyPopularFilter = useCallback((filterConfig: Partial<FilterState>) => {
    const updatedFilters = {
      ...DEFAULT_FILTER_STATE,
      ...filterConfig
    };
    setFilters(updatedFilters);
    onFilterChange?.(updatedFilters);
  }, [onFilterChange]);

  // Check for active filters
  const hasActiveFilters = useMemo(() => {
    return (
      filters.searchQuery ||
      filters.gender !== undefined ||
      (filters.cities?.length ?? 0) > 0 ||  // בדיקה בטוחה למערך
      (filters.occupations?.length ?? 0) > 0 ||  // בדיקה בטוחה למערך
      filters.religiousLevel ||
      filters.educationLevel ||
      filters.maritalStatus ||
      filters.availabilityStatus ||
      filters.userStatus ||
      filters.isVerified ||
      filters.hasReferences ||
      filters.lastActiveDays ||
      filters.isProfileComplete ||
      (filters.ageRange && (
        filters.ageRange.min !== DEFAULT_FILTER_STATE.ageRange?.min ||
        filters.ageRange.max !== DEFAULT_FILTER_STATE.ageRange?.max
      )) ||
      (filters.heightRange && (
        filters.heightRange.min !== DEFAULT_FILTER_STATE.heightRange?.min ||
        filters.heightRange.max !== DEFAULT_FILTER_STATE.heightRange?.max
      )) ||
      // בדיקת פילטרים נפרדים פעילים
      filters.separateFiltering
    );
  }, [filters]);

  // Get active filters in formatted array
  const activeFilters = useMemo((): FilterOption[] => {
    const active: FilterOption[] = [];

    if (filters.searchQuery) {
      active.push({
        key: 'searchQuery',
        value: filters.searchQuery,
        label: `חיפוש: ${filters.searchQuery}`,
        category: 'חיפוש'
      });
    }

    if (filters.gender) {
      active.push({
        key: 'gender',
        value: filters.gender,
        label: `מגדר: ${filters.gender === 'MALE' ? 'זכר' : 'נקבה'}`,
        category: 'מידע בסיסי'
      });
    }

    if (filters.separateFiltering) {
      active.push({
        key: 'separateFiltering',
        value: true,
        label: 'סינון נפרד לפי מגדר',
        category: 'מידע בסיסי'
      });
    }

    // גיל
    if (filters.ageRange && (
      filters.ageRange.min !== DEFAULT_FILTER_STATE.ageRange?.min || 
      filters.ageRange.max !== DEFAULT_FILTER_STATE.ageRange?.max
    )) {
      active.push({
        key: 'ageRange',
        value: filters.ageRange,
        label: `גיל: ${filters.ageRange.min}-${filters.ageRange.max}`,
        category: 'מידע בסיסי'
      });
    }

    // גובה
    if (filters.heightRange && (
      filters.heightRange.min !== DEFAULT_FILTER_STATE.heightRange?.min || 
      filters.heightRange.max !== DEFAULT_FILTER_STATE.heightRange?.max
    )) {
      active.push({
        key: 'heightRange',
        value: filters.heightRange,
        label: `גובה: ${filters.heightRange.min}-${filters.heightRange.max} ס"מ`,
        category: 'מידע בסיסי'
      });
    }

    // ערים
    if (filters.cities?.length) {
      if (filters.cities.length === 1) {
        active.push({
          key: 'cities',
          value: filters.cities[0],
          label: `עיר: ${filters.cities[0]}`,
          category: 'מיקום'
        });
      } else {
        active.push({
          key: 'cities',
          value: filters.cities,
          label: `ערים: ${filters.cities.length} נבחרו`,
          category: 'מיקום'
        });
      }
    }

    // תחומי עיסוק
    if (filters.occupations?.length) {
      if (filters.occupations.length === 1) {
        active.push({
          key: 'occupations',
          value: filters.occupations[0],
          label: `תחום עיסוק: ${filters.occupations[0]}`,
          category: 'תעסוקה'
        });
      } else {
        active.push({
          key: 'occupations',
          value: filters.occupations,
          label: `תחומי עיסוק: ${filters.occupations.length} נבחרו`,
          category: 'תעסוקה'
        });
      }
    }

    // רמת דתיות
    if (filters.religiousLevel) {
      active.push({
        key: 'religiousLevel',
        value: filters.religiousLevel,
        label: `רמת דתיות: ${filters.religiousLevel}`,
        category: 'דת'
      });
    }

    // השכלה
    if (filters.educationLevel) {
      active.push({
        key: 'educationLevel',
        value: filters.educationLevel,
        label: `השכלה: ${filters.educationLevel}`,
        category: 'השכלה'
      });
    }

    // מצב משפחתי
    if (filters.maritalStatus) {
      active.push({
        key: 'maritalStatus',
        value: filters.maritalStatus,
        label: `מצב משפחתי: ${filters.maritalStatus}`,
        category: 'מידע אישי'
      });
    }

    // סטטוס זמינות
    if (filters.availabilityStatus) {
      const statusLabel = 
        filters.availabilityStatus === "AVAILABLE" ? "פנוי/ה" :
        filters.availabilityStatus === "DATING" ? "בתהליך הכרות" :
        filters.availabilityStatus === "UNAVAILABLE" ? "לא פנוי/ה" :
        filters.availabilityStatus;
      
      active.push({
        key: 'availabilityStatus',
        value: filters.availabilityStatus,
        label: `סטטוס זמינות: ${statusLabel}`,
        category: 'זמינות'
      });
    }

    // סטטוס משתמש
    if (filters.userStatus) {
      active.push({
        key: 'userStatus',
        value: filters.userStatus,
        label: `סטטוס משתמש: ${filters.userStatus}`,
        category: 'סטטוס'
      });
    }

    // משתמש מאומת
    if (filters.isVerified !== undefined) {
      active.push({
        key: 'isVerified',
        value: filters.isVerified,
        label: `משתמש מאומת: ${filters.isVerified ? 'כן' : 'לא'}`,
        category: 'אימות'
      });
    }

    // יש המלצות
    if (filters.hasReferences !== undefined) {
      active.push({
        key: 'hasReferences',
        value: filters.hasReferences,
        label: `יש המלצות: ${filters.hasReferences ? 'כן' : 'לא'}`,
        category: 'המלצות'
      });
    }

    // פעילות אחרונה
    if (filters.lastActiveDays !== undefined) {
      active.push({
        key: 'lastActiveDays',
        value: filters.lastActiveDays,
        label: `פעיל ב-${filters.lastActiveDays} הימים האחרונים`,
        category: 'פעילות'
      });
    }

    // פרופיל מלא
    if (filters.isProfileComplete !== undefined) {
      active.push({
        key: 'isProfileComplete',
        value: filters.isProfileComplete,
        label: `פרופיל מלא: ${filters.isProfileComplete ? 'כן' : 'לא'}`,
        category: 'שלמות פרופיל'
      });
    }

    return active;
  }, [filters]);

  // Remove single filter
  const removeFilter = useCallback((key: keyof FilterState, value?: string) => {
    setFilters(prev => {
      const updated = { ...prev };

      if (key === 'separateFiltering') {
        updated.separateFiltering = false;
      } else if (Array.isArray(updated[key]) && value !== undefined) {
        if (key === 'cities' || key === 'occupations') {
          updated[key] = (updated[key] as string[]).filter(v => v !== value);
        }
      } else {
        delete updated[key];
      }

      onFilterChange?.(updated);
      return updated;
    });
  }, [onFilterChange]);
  
  // Calculate popular filters based on search history
  const popularFilters = useMemo(() => {
    // Group searches by frequency
    const searchFrequency: Record<string, number> = {};
    searchHistory.forEach(item => {
      searchFrequency[item.query] = (searchFrequency[item.query] || 0) + 1;
    });
    
    // Sort by frequency
    return Object.entries(searchFrequency)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([query]) => query);
  }, [searchHistory]);

  return {
    // Current state
    filters,
    savedFilters,
    recentSearches,
    searchHistory,
    activeFilters,
    hasActiveFilters,
    popularFilters,
    lastAppliedFilter,
    
    // Separate filtering functions
    toggleSeparateFiltering,
    updateMaleFilters,
    updateFemaleFilters,
    copyFilters,
    
    // חיפוש נפרד פונקציות חדשות
    updateMaleSearchQuery,
    updateFemaleSearchQuery,
    
    // Actions
    setFilters: updateFilters,
    removeFilter,
    resetFilters,
    clearRecentSearches,
    applyPopularFilter,

    // Saved filters management
    saveFilter,
    updateSavedFilter,
    deleteFilter,
    setDefaultFilter,
    loadSavedFilter,
};
};
export default useFilterLogic;
--- End of Content for useFilterLogic.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useStatistics.ts
--------------------------------------------------------------------------------
Content:
// /hooks/useStatistics.ts

import { useMemo } from 'react';
import type { Candidate } from '../types/candidates';
import {
  calculateAgeDistribution,
  calculateLocationDistribution,
  calculateReligiousDistribution,
  calculateActivityStats,
  calculateGenderStats,
  calculateAvailabilityStats,
  calculateCompletionStats
} from '../../suggestions/utils/statisticsCalculator';

export interface Statistics {
  gender: {
    maleCount: number;
    femaleCount: number;
    ratio: number;
    total: number;
    percentages: {
      male: number;
      female: number;
    };
  };
  age: {
    ageGroups: Record<string, number>;
    averageAge: number;
    medianAge: number;
  };
  location: {
    cities: Record<string, number>;
    topCities: Array<{ city: string; count: number }>;
  };
  religious: {
    levels: Record<string, number>;
    percentages: Record<string, number>;
  };
  activity: {
    activeLastWeek: number;
    activeLastMonth: number;
    averageLoginFrequency: number;
    completedProfiles: number;
  };
  availability: {
    counts: Record<string, number>;
    percentages: Record<string, number>;
  };
  completion: {
    counts: {
      hasPhotos: number;
      hasAbout: number;
      hasReferences: number;
      hasPreferences: number;
      isVerified: number;
      fullyCompleted: number;
    };
    percentages: {
      hasPhotos: number;
      hasAbout: number;
      hasReferences: number;
      hasPreferences: number;
      isVerified: number;
      fullyCompleted: number;
    };
  };
}

export const useStatistics = (candidates: Candidate[]) => {
  const stats = useMemo<Statistics>(() => {
    return {
      gender: calculateGenderStats(candidates),
      age: calculateAgeDistribution(candidates),
      location: calculateLocationDistribution(candidates),
      religious: calculateReligiousDistribution(candidates),
      activity: calculateActivityStats(candidates),
      availability: calculateAvailabilityStats(candidates),
      completion: calculateCompletionStats(candidates)
    };
  }, [candidates]);

  // פונקציות עזר לשליפת נתונים ספציפיים
  const getGenderRatio = () => {
    return {
      ratio: stats.gender.ratio,
      formattedRatio: `${stats.gender.maleCount}:${stats.gender.femaleCount}`
    };
  };

  const getTopCities = (limit: number = 5) => {
    return stats.location.topCities.slice(0, limit);
  };

  const getActiveUsersPercent = () => {
    return Math.round((stats.activity.activeLastWeek / stats.gender.total) * 100);
  };

  const getCompletionRate = () => {
    return stats.completion.percentages.fullyCompleted;
  };

  const getAgeGroupDistribution = () => {
    return Object.entries(stats.age.ageGroups)
      .map(([range, count]) => ({
        range,
        count,
        percentage: Math.round((count / stats.gender.total) * 100)
      }))
      .sort((a, b) => {
        const [aMin] = a.range.split('-').map(Number);
        const [bMin] = b.range.split('-').map(Number);
        return aMin - bMin;
      });
  };

  const getReligiousDistribution = () => {
    return Object.entries(stats.religious.levels)
      .map(([level, count]) => ({
        level,
        count,
        percentage: stats.religious.percentages[level]
      }))
      .sort((a, b) => b.count - a.count);
  };

  const getActivityTrend = () => {
    return {
      weekly: stats.activity.activeLastWeek,
      monthly: stats.activity.activeLastMonth,
      average: stats.activity.averageLoginFrequency
    };
  };

  const getProfileCompletionStats = () => {
    return {
      completed: stats.completion.counts.fullyCompleted,
      partial: stats.gender.total - stats.completion.counts.fullyCompleted,
      percentage: stats.completion.percentages.fullyCompleted
    };
  };

  return {
    stats,
    getGenderRatio,
    getTopCities,
    getActiveUsersPercent,
    getCompletionRate,
    getAgeGroupDistribution,
    getReligiousDistribution,
    getActivityTrend,
    getProfileCompletionStats
  };
};

export default useStatistics;
--- End of Content for useStatistics.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\LoadingStates.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React from 'react';
import { Loader2, AlertCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface LoadingContainerProps {
  children: React.ReactNode;
  className?: string;
}

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

interface LoadingCardProps {
  count?: number;
  layout?: 'grid' | 'list';
  className?: string;
}

interface LoadingTextProps {
  lines?: number;
  className?: string;
}

interface LoadingErrorProps {
  message: string;
  onRetry?: () => void;
  className?: string;
  dict: MatchmakerPageDictionary['loadingStates'];
}

export const LoadingContainer: React.FC<LoadingContainerProps> = ({
  children,
  className,
}) => {
  return (
    <div className={cn('relative min-h-[200px]', className)}>
      <div className="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
      </div>
      <div className="opacity-50 pointer-events-none">{children}</div>
    </div>
  );
};

export const LoadingSpinner: React.FC<LoadingSpinnerProps> = ({
  size = 'md',
  className,
}) => {
  const sizeClasses = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' };
  return (
    <div className={cn('flex items-center justify-center', className)}>
      <Loader2
        className={cn('animate-spin text-blue-600', sizeClasses[size])}
      />
    </div>
  );
};

export const LoadingCard: React.FC<LoadingCardProps> = ({
  count = 1,
  layout = 'grid',
  className,
}) => {
  return (
    <div
      className={cn(
        layout === 'grid'
          ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
          : 'space-y-4',
        className
      )}
    >
      {Array.from({ length: count }).map((_, index) => (
        <div
          key={index}
          className={cn(
            'bg-white rounded-lg overflow-hidden shadow-sm',
            layout === 'list' ? 'flex gap-4' : ''
          )}
        >
          <Skeleton
            className={cn(
              'bg-gray-200',
              layout === 'list' ? 'w-32 h-32' : 'w-full h-48'
            )}
          />
          <div className="p-4 flex-1">
            <div className="flex items-center justify-between mb-4">
              <Skeleton className="h-6 w-1/3" />
              <Skeleton className="h-6 w-16" />
            </div>
            <div className="space-y-2">
              <Skeleton className="h-4 w-2/3" />
              <Skeleton className="h-4 w-1/2" />
              <Skeleton className="h-4 w-3/4" />
            </div>
            <div className="flex gap-2 mt-4">
              <Skeleton className="h-9 w-24" />
              <Skeleton className="h-9 w-24" />
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};

export const LoadingText: React.FC<LoadingTextProps> = ({
  lines = 3,
  className,
}) => {
  return (
    <div className={cn('space-y-2', className)}>
      {Array.from({ length: lines }).map((_, index) => (
        <Skeleton
          key={index}
          className={cn('h-4', index === lines - 1 ? 'w-3/4' : 'w-full')}
        />
      ))}
    </div>
  );
};

export const LoadingError: React.FC<LoadingErrorProps> = ({
  message,
  onRetry,
  className,
  dict,
}) => {
  return (
    <Alert variant="destructive" className={cn('border-red-500', className)}>
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>{dict.errorTitle}</AlertTitle>
      <AlertDescription className="flex items-center justify-between">
        <span>{message}</span>
        {onRetry && (
          <Button
            variant="outline"
            size="sm"
            onClick={onRetry}
            className="ml-4"
          >
            {dict.retryButton}
          </Button>
        )}
      </AlertDescription>
    </Alert>
  );
};

export const LoadingStats: React.FC<{ className?: string }> = ({
  className,
}) => {
  return (
    <div className={cn('grid grid-cols-2 md:grid-cols-4 gap-4', className)}>
      {Array.from({ length: 4 }).map((_, index) => (
        <div key={index} className="bg-white p-4 rounded-lg shadow-sm">
          <Skeleton className="h-4 w-16 mb-2" />
          <Skeleton className="h-8 w-24" />
        </div>
      ))}
    </div>
  );
};

export const LoadingFilters: React.FC<{ className?: string }> = ({
  className,
}) => {
  return (
    <div className={cn('space-y-4', className)}>
      <Skeleton className="h-10 w-full" />
      <div className="flex flex-wrap gap-2">
        {Array.from({ length: 4 }).map((_, index) => (
          <Skeleton key={index} className="h-8 w-24" />
        ))}
      </div>
    </div>
  );
};

const LoadingComponents = {
  LoadingContainer,
  LoadingSpinner,
  LoadingCard,
  LoadingText,
  LoadingError,
  LoadingStats,
  LoadingFilters,
};

export default LoadingComponents;
--- End of Content for LoadingStates.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\Pagination.tsx
--------------------------------------------------------------------------------
Content:
// /shared/Pagination.tsx
'use client';

import React from 'react';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  ChevronRight,
  ChevronLeft,
  ChevronsLeft,
  ChevronsRight,
} from 'lucide-react';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface PaginationProps {
  currentPage: number;
  totalPages: number;
  pageSize: number;
  totalItems: number;
  onPageChange: (page: number) => void;
  onPageSizeChange: (size: number) => void;
  className?: string;
  dict: MatchmakerPageDictionary['pagination'];
}

const pageSizeOptions = [10, 20, 50, 100];

const Pagination: React.FC<PaginationProps> = ({
  currentPage,
  totalPages,
  pageSize,
  totalItems,
  onPageChange,
  onPageSizeChange,
  className,
  dict,
}) => {
  // Helper to generate page numbers array
  const getPageNumbers = () => {
    const pages: (number | string)[] = [];
    const maxVisiblePages = 5;

    if (totalPages <= maxVisiblePages) {
      return Array.from({ length: totalPages }, (_, i) => i + 1);
    }

    // Always show first page
    pages.push(1);

    // Calculate start and end of visible pages
    let start = Math.max(currentPage - 1, 2);
    let end = Math.min(currentPage + 1, totalPages - 1);

    // Adjust for edge cases
    if (currentPage <= 3) {
      end = Math.min(maxVisiblePages - 1, totalPages - 1);
    } else if (currentPage >= totalPages - 2) {
      start = Math.max(totalPages - maxVisiblePages + 2, 2);
    }

    // Add ellipsis and numbers
    if (start > 2) pages.push('...');
    for (let i = start; i <= end; i++) {
      pages.push(i);
    }
    if (end < totalPages - 1) pages.push('...');

    // Always show last page
    if (totalPages > 1) pages.push(totalPages);

    // --- התיקון כאן ---
    return pages;
  };

  const startItem = (currentPage - 1) * pageSize + 1;
  const endItem = Math.min(currentPage * pageSize, totalItems);
  const resultsText = dict.results
    .replace('{{start}}', String(startItem))
    .replace('{{end}}', String(endItem))
    .replace('{{total}}', String(totalItems));

  return (
    <div
      className={`flex flex-col sm:flex-row items-center justify-between gap-4 ${className}`}
    >
      <div className="flex items-center gap-2 text-sm text-gray-600">
        <span>{dict.show}</span>
        <Select
          value={pageSize.toString()}
          onValueChange={(value) => onPageSizeChange(Number(value))}
        >
          <SelectTrigger className="w-[70px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {pageSizeOptions.map((size) => (
              <SelectItem key={size} value={size.toString()}>
                {size}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
        <span>{dict.rows}</span>
      </div>

      <div className="text-sm text-gray-600">{resultsText}</div>

      <div className="flex items-center gap-1">
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(1)}
          disabled={currentPage === 1}
        >
          <ChevronsRight className="h-4 w-4" />
        </Button>
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage === 1}
        >
          <ChevronRight className="h-4 w-4" />
        </Button>
        {getPageNumbers().map((page, index) =>
          typeof page === 'number' ? (
            <Button
              key={index}
              variant={currentPage === page ? 'default' : 'outline'}
              size="sm"
              onClick={() => onPageChange(page)}
              className="hidden sm:inline-flex min-w-[32px]"
            >
              {page}
            </Button>
          ) : (
            <span key={index} className="px-2">
              {page}
            </span>
          )
        )}
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage === totalPages}
        >
          <ChevronLeft className="h-4 w-4" />
        </Button>
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(totalPages)}
          disabled={currentPage === totalPages}
        >
          <ChevronsLeft className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
};

export default Pagination;
--- End of Content for Pagination.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\StatusBadge.tsx
--------------------------------------------------------------------------------
Content:
import React from 'react';
import { Badge } from '@/components/ui/badge';
import {
  Circle,
  CheckCircle,
  XCircle,
  Clock,
  AlertTriangle,
} from 'lucide-react';
import { MatchSuggestionStatus, VerificationStatus } from '@prisma/client';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

type StatusType = 'suggestion' | 'verification' | 'profile';
type StatusSize = 'sm' | 'md' | 'lg';

interface StatusConfig {
  label: string;
  color: 'destructive' | 'outline' | 'secondary' | 'success' | 'warning';
  icon:
    | typeof Circle
    | typeof CheckCircle
    | typeof XCircle
    | typeof Clock
    | typeof AlertTriangle;
}

interface StatusBadgeProps {
  type: StatusType;
  status: string;
  size?: StatusSize;
  dict: MatchmakerPageDictionary['statusBadges'];
}

// Presentation logic remains in the component
const statusStyling = {
  // Suggestion Statuses Styling
  DRAFT: { color: 'secondary', icon: Circle },
  PENDING_FIRST_PARTY: { color: 'warning', icon: Clock },
  FIRST_PARTY_APPROVED: { color: 'success', icon: CheckCircle },
  FIRST_PARTY_DECLINED: { color: 'destructive', icon: XCircle },
  PENDING_SECOND_PARTY: { color: 'warning', icon: Clock },
  SECOND_PARTY_APPROVED: { color: 'success', icon: CheckCircle },
  SECOND_PARTY_DECLINED: { color: 'destructive', icon: XCircle },
  AWAITING_MATCHMAKER_APPROVAL: { color: 'warning', icon: Clock },
  CONTACT_DETAILS_SHARED: { color: 'success', icon: CheckCircle },
  AWAITING_FIRST_DATE_FEEDBACK: { color: 'warning', icon: Clock },
  THINKING_AFTER_DATE: { color: 'warning', icon: Clock },
  PROCEEDING_TO_SECOND_DATE: { color: 'success', icon: CheckCircle },
  ENDED_AFTER_FIRST_DATE: { color: 'destructive', icon: XCircle },
  MEETING_PENDING: { color: 'warning', icon: Clock },
  MEETING_SCHEDULED: { color: 'success', icon: CheckCircle },
  MATCH_APPROVED: { color: 'success', icon: CheckCircle },
  MATCH_DECLINED: { color: 'destructive', icon: XCircle },
  DATING: { color: 'secondary', icon: Circle },
  ENGAGED: { color: 'success', icon: CheckCircle },
  MARRIED: { color: 'success', icon: CheckCircle },
  EXPIRED: { color: 'destructive', icon: XCircle },
  CLOSED: { color: 'destructive', icon: XCircle },
  CANCELLED: { color: 'destructive', icon: XCircle },

  // Verification Statuses Styling
  PENDING: { color: 'warning', icon: Clock },
  COMPLETED: { color: 'success', icon: CheckCircle },
  FAILED: { color: 'destructive', icon: XCircle },

  // Profile Statuses Styling
  INCOMPLETE: { color: 'warning', icon: AlertTriangle },
  PENDING_VERIFICATION: { color: 'warning', icon: Clock },
  VERIFIED: { color: 'success', icon: CheckCircle },
  BLOCKED: { color: 'destructive', icon: XCircle },
};

const defaultStyling = {
  color: 'secondary' as const,
  icon: Circle,
};

const getStatusConfig = (
  type: StatusType,
  status: string,
  dict: StatusBadgeProps['dict']
): StatusConfig => {
  let label: string;
  let style;

  switch (type) {
    case 'suggestion':
      label = dict.suggestion[status as MatchSuggestionStatus] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    case 'verification':
      label = dict.verification[status as VerificationStatus] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    case 'profile':
      label = dict.profile[status as keyof typeof dict.profile] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    default:
      label = dict.unknown;
      style = defaultStyling;
  }

  return { label, ...style };
};

const StatusBadge: React.FC<StatusBadgeProps> = ({
  type,
  status,
  size = 'md',
  dict,
}) => {
  const config = getStatusConfig(type, status, dict);
  const Icon = config.icon;

  const sizeClasses = {
    sm: 'text-xs px-2 py-0.5',
    md: 'text-sm px-2.5 py-1',
    lg: 'text-base px-3 py-1.5',
  };

  return (
    <Badge
      variant={config.color}
      className={`flex items-center gap-1.5 ${sizeClasses[size]}`}
    >
      <Icon className={size === 'sm' ? 'w-3 h-3' : 'w-4 h-4'} />
      <span>{config.label}</span>
    </Badge>
  );
};

export default StatusBadge;
--- End of Content for StatusBadge.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types\candidates.ts
--------------------------------------------------------------------------------
Content:
// candidates.ts
import { Gender, AvailabilityStatus, UserStatus, UserSource  } from '@prisma/client';
import type { UserProfile, UserImage, QuestionnaireResponse} from '@/types/next-auth';

// Base API Response Type
export interface APIResponse<T> {
  success: boolean;
  clients: T[];
  count: number;
  error?: string;
}

// Base Types
export type CandidateImage = UserImage;

export type CandidateProfile = UserProfile;

export type MobileView = 'split' | 'single' | 'double';

export interface Candidate {
  id: string;
  email: string;
  firstName: string;
  createdAt: Date;
  lastName: string;
  status: UserStatus;
  isVerified: boolean;
  images: CandidateImage[];
  isProfileComplete: boolean;
  source: UserSource; // Add new field
  addedByMatchmakerId?: string | null; // Add new field
  profile: CandidateProfile; // Ensure this uses the updated CandidateProfile
    suggestionStatus?: {
    status: 'BLOCKED' | 'PENDING';
    suggestionId: string;
    withCandidateName: string;
  } | null;

}
export interface CandidatesFilter {
   source?: UserSource;
  gender?: Gender;
  ageRange?: {
    min: number;
    max: number;
  };
  heightRange?: {
    min: number;
    max: number;
  };
  cities?: string[];
  religiousLevel?: string;
  occupations?: string[];
  educationLevel?: string;
  maritalStatus?: string;
  availabilityStatus?: AvailabilityStatus | string;
  isVerified?: boolean;
  hasReferences?: boolean;
  lastActiveDays?: number;
  isProfileComplete?: boolean;
  searchQuery?: string;
  savedFilterId?: string;
  separateFiltering?: boolean;
  
  // הוספת שדות חיפוש נפרדים
  maleSearchQuery?: string;
  femaleSearchQuery?: string;
  
  maleFilters?: Partial<CandidatesFilter>;
  femaleFilters?: Partial<CandidatesFilter>;
  userStatus?: UserStatus;
}

// ViewMode and Action Types - אלה נשארים כמו שהם
export type ViewMode = 'grid' | 'list';
export type CardSize = 'sm' | 'md' | 'lg';
export type CandidateAction = 'suggest' | 'invite' | 'contact' | 'favorite' | 'view' | 'edit';

// Profile Card Types
export interface ProfileCardData {
  profile: CandidateProfile;
  images: CandidateImage[];
  questionnaire?: QuestionnaireResponse;
}

/**
 * ממפה את אובייקט המועמד מהשרת למבנה הנדרש עבור ProfileCard
 */
export const mapCandidateToProfileCard = (candidate: Candidate): ProfileCardData => {
  return {
    profile: candidate.profile,
    images: candidate.images,
    questionnaire: undefined // יש להוסיף לוגיקה לטעינת השאלון בנפרד
  };
};

/**
 * מפריד מועמדים לפי מגדר
 */
export const separateCandidatesByGender = (candidates: Candidate[]) => {
  return {
    maleCandidates: candidates.filter(c => c.profile.gender === 'MALE'),
    femaleCandidates: candidates.filter(c => c.profile.gender === 'FEMALE')
  };
};

/**
 * בודק האם הפרופיל מלא
 */
export const isProfileComplete = (profile: CandidateProfile): boolean => {
  const requiredFields: Array<keyof CandidateProfile> = [
    'birthDate',
    'city',
    'religiousLevel',
    'about',
    'occupation',
    'education'
  ];

  return requiredFields.every(field => Boolean(profile[field]));
};

const candidateUtils = {
  mapCandidateToProfileCard,
  separateCandidatesByGender,
  isProfileComplete
};

export default candidateUtils;
--- End of Content for candidates.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types\filters.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/types/filters.ts

import { Gender, AvailabilityStatus, UserStatus, UserSource  } from '@prisma/client';

// הגדרת טווח ערכים מספריים
export interface RangeFilter {
  min: number;
  max: number;
}

// הגדרת פילטר שמור
export interface SavedFilter {
  id: string;
  name: string;
  filters: FilterState;
  isDefault?: boolean;
  createdAt: Date;
}

export interface FilterState {
  // הוספת מצב תצוגה נפרדת
  separateFiltering: boolean;
    source?: UserSource | undefined;
  // הוספת שדות חיפוש נפרדים
  maleSearchQuery?: string;
  femaleSearchQuery?: string;

  // פילטרים נפרדים לגברים
  maleFilters?: Omit<FilterState, 'gender' | 'maleFilters' | 'femaleFilters' | 
    'separateFiltering' | 'maleSearchQuery' | 'femaleSearchQuery'>;
  
  // פילטרים נפרדים לנשים
  femaleFilters?: Omit<FilterState, 'gender' | 'maleFilters' | 'femaleFilters' | 
    'separateFiltering' | 'maleSearchQuery' | 'femaleSearchQuery'>;

  searchQuery?: string;
  savedFilterId?: string;
  gender?: Gender | undefined;
  ageRange?: RangeFilter;
  heightRange?: RangeFilter;
  cities?: string[];
  occupations?: string[];
  religiousLevel?: string;
  educationLevel?: string;
  maritalStatus?: string;
  availabilityStatus?: AvailabilityStatus | string;
  userStatus?: UserStatus;
  isVerified?: boolean;
  hasReferences?: boolean;
  lastActiveDays?: number;
  isProfileComplete?: boolean;
}

// הגדרת אפשרות פילטר
export interface FilterOption {
  key: keyof (FilterState & { education: string });
  value: Gender | AvailabilityStatus | UserStatus | RangeFilter | string[] | string | number | boolean | undefined;
  label: string;
  category?: string;
}

// הגדרת קטגוריית פילטר
export interface FilterCategory {
  id: string;
  label: string;
  filters: Array<keyof (FilterState & { education: string })>;
}

// הגדרת פרופ לקומפוננטת הפילטרים
export interface FilterProps {
  filters: FilterState;
  onFiltersChange: (filters: FilterState) => void;
  onReset?: () => void;
  className?: string;
}

// הגדרת אפשרויות הפילטר
export interface FilterOptions {
  ages: RangeFilter;
  heights: RangeFilter;
  cities: string[];
  religiousLevels: string[];
  educationLevels: string[];
  occupations: string[];
  maritalStatuses: string[];
  availabilityStatuses: AvailabilityStatus[];
}

// הגדרת מצב הממשק של הפילטרים
export interface FilterUIState {
  isOpen: boolean;
  activeCategory?: string;
  showSaveDialog: boolean;
  presetName: string;
}

// הגדרה של אירועי שינוי בפילטרים
export type FilterChangeHandler = (filters: FilterState) => void;

// הגדרת אירועי שמירת פילטר
export interface SaveFilterHandler {
  (name: string, filters: FilterState): Promise<SavedFilter>;
}

// הגדרת אירועי טעינת פילטר
export interface LoadFilterHandler {
  (id: string): void;
}

// הגדרת הגדרות הפילטרים
export interface FilterSettings {
  localStorageKey?: string;
  defaultFilters?: Partial<FilterState>;
  onFilterChange?: FilterChangeHandler;
}

// הגדרת תוצאות הפילטר
export interface FilterResults {
  totalResults: number;
  filteredResults: number;
  categories: Record<string, number>;
}

// קונסטנטות של הפילטרים
export const DEFAULT_FILTER_STATE: FilterState = {
  separateFiltering: false,
  maleFilters: {},
  femaleFilters: {},
  maleSearchQuery: '',
  femaleSearchQuery: '',
  gender: undefined,
  ageRange: { min: 18, max: 99 },
  heightRange: { min: 140, max: 210 },
  cities: [],
  occupations: [],
  religiousLevel: undefined,
  educationLevel: undefined,
  maritalStatus: undefined,
  availabilityStatus: undefined,
    source: undefined,
  userStatus: undefined,
  isVerified: undefined,
  hasReferences: undefined,
  lastActiveDays: undefined,
  isProfileComplete: undefined,
  searchQuery: '',
  savedFilterId: undefined
};

// קטגוריות פילטרים מוגדרות מראש
export const FILTER_CATEGORIES: FilterCategory[] = [
  {
    id: 'basic',
    label: 'פילטרים בסיסיים',
    filters: ['gender', 'ageRange', 'cities', 'religiousLevel']
  },
  {
    id: 'advanced',
    label: 'פילטרים מתקדמים',
    filters: ['heightRange', 'occupations', 'educationLevel', 'maritalStatus']
  },
  {
    id: 'status',
    label: 'סטטוס ואימות',
    filters: ['availabilityStatus', 'isVerified', 'hasReferences', 'lastActiveDays']
  }
];

// טיפוסי מיון
export type SortDirection = 'asc' | 'desc';

export interface SortOption {
  field: keyof FilterState;
  direction: SortDirection;
  label: string;
}

// הגדרות קיבוץ
export interface GroupOption {
  field: keyof FilterState;
  label: string;
}

export const filterConstants = {
  DEFAULT_FILTER_STATE,
  FILTER_CATEGORIES
};

export default filterConstants;
--- End of Content for filters.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\EditSuggestionForm.tsx
--------------------------------------------------------------------------------
Content:
// EditSuggestionForm.tsx - גרסה מתורגמת ומלאה

import React, { useState } from 'react';
import {useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import { DatePicker } from '@/components/ui/date-picker';
import type { Suggestion } from '@/types/suggestions';
import {
  RefreshCw,
  AlertTriangle,
  Calendar,
  Clock,
  User,
  MessageCircle,
  CheckCircle,
  Sparkles,
  Heart,
  Save,
  X,
  Star,
  Flame,
  Target,
  Shield,
  Crown,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface EditSuggestionFormProps {
  dict: MatchmakerPageDictionary['suggestionsDashboard']['editSuggestionForm'];
  isOpen: boolean;
  onClose: () => void;
  suggestion: Suggestion | null;
  onSave: (data: {
    suggestionId: string;
    updates: {
      priority?: Priority;
      status?: MatchSuggestionStatus;
      statusNotes?: string;
      matchingReason?: string;
      firstPartyNotes?: string;
      secondPartyNotes?: string;
      internalNotes?: string;
      decisionDeadline?: Date;
    };
  }) => Promise<void>;
}

const EditSuggestionForm: React.FC<EditSuggestionFormProps> = ({
  dict,
  isOpen,
  onClose,
  suggestion,
  onSave,
}) => {
  const [priority, setPriority] = useState<Priority>(Priority.MEDIUM);
  const [selectedStatus, setSelectedStatus] =
    useState<MatchSuggestionStatus | null>(null);
  const [statusNotes, setStatusNotes] = useState('');
  const [matchingReason, setMatchingReason] = useState('');
  const [firstPartyNotes, setFirstPartyNotes] = useState('');
  const [secondPartyNotes, setSecondPartyNotes] = useState('');
  const [internalNotes, setInternalNotes] = useState('');
  const [decisionDeadline, setDecisionDeadline] = useState<Date | undefined>(
    undefined
  );
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showStatusChange, setShowStatusChange] = useState(false);

  useEffect(() => {
    if (suggestion) {
      setPriority(suggestion.priority as Priority);
      setMatchingReason(suggestion.matchingReason || '');
      setFirstPartyNotes(suggestion.firstPartyNotes || '');
      setSecondPartyNotes(suggestion.secondPartyNotes || '');
      setInternalNotes(suggestion.internalNotes || '');

      setSelectedStatus(null);
      setStatusNotes('');
      setShowStatusChange(false);

      if (suggestion.decisionDeadline) {
        const deadlineDate = new Date(suggestion.decisionDeadline);
        if (!isNaN(deadlineDate.getTime())) {
          setDecisionDeadline(deadlineDate);
        }
      } else {
        setDecisionDeadline(undefined);
      }
    }
  }, [suggestion]);

  const getStatusLabel = (statusValue: MatchSuggestionStatus): string => {
    return dict.statusLabels[statusValue] || statusValue;
  };

  const getAvailableStatuses = (): MatchSuggestionStatus[] => {
    if (!suggestion) return [];
    return Object.keys(dict.statusLabels) as MatchSuggestionStatus[];
  };

  const handleSubmit = async () => {
    if (!suggestion) {
      toast.error(dict.toasts.noSuggestionData);
      return;
    }

    setIsSubmitting(true);

    try {
      const updateData: {
        priority: Priority;
        status?: MatchSuggestionStatus;
        statusNotes?: string;
        matchingReason: string;
        firstPartyNotes: string;
        secondPartyNotes: string;
        internalNotes: string;
        decisionDeadline?: Date;
      } = {
        priority,
        matchingReason,
        firstPartyNotes,
        secondPartyNotes,
        internalNotes,
        decisionDeadline,
      };

      if (selectedStatus && selectedStatus !== suggestion.status) {
        updateData.status = selectedStatus;
        updateData.statusNotes =
          statusNotes ||
          `סטטוס שונה מ-${getStatusLabel(suggestion.status)} ל-${getStatusLabel(selectedStatus)}`; // Note: This internal-facing string may not need translation
      }

      await onSave({
        suggestionId: suggestion.id,
        updates: updateData,
      });

      toast.success(dict.toasts.updateSuccess);
      onClose();
    } catch (error) {
      console.error('Error updating suggestion:', error);
      toast.error(dict.toasts.updateError);
    } finally {
      setIsSubmitting(false);
    }
  };

  const getPriorityInfo = (p: Priority) => {
    const infoMap = {
      URGENT: { color: 'from-red-500 to-pink-500', icon: Flame, textColor: 'text-red-600' },
      HIGH: { color: 'from-orange-500 to-amber-500', icon: Star, textColor: 'text-orange-600' },
      MEDIUM: { color: 'from-blue-500 to-cyan-500', icon: Target, textColor: 'text-blue-600' },
      LOW: { color: 'from-gray-500 to-slate-500', icon: Shield, textColor: 'text-gray-600' },
    };
    return {
      label: dict.priorityLabels[p],
      ...infoMap[p],
    };
  };

  const getStatusInfo = (status: MatchSuggestionStatus) => {
    switch (status) {
      case 'PENDING_FIRST_PARTY':
      case 'PENDING_SECOND_PARTY':
        return { icon: Clock, color: 'text-yellow-600', bg: 'from-yellow-50 to-amber-50' };
      case 'FIRST_PARTY_APPROVED':
      case 'SECOND_PARTY_APPROVED':
        return { icon: CheckCircle, color: 'text-green-600', bg: 'from-green-50 to-emerald-50' };
      case 'DATING':
        return { icon: Heart, color: 'text-pink-600', bg: 'from-pink-50 to-rose-50' };
      case 'ENGAGED':
        return { icon: Crown, color: 'text-yellow-600', bg: 'from-yellow-50 to-orange-50' };
      case 'MARRIED':
        return { icon: Sparkles, color: 'text-purple-600', bg: 'from-purple-50 to-pink-50' };
      default:
        return { icon: RefreshCw, color: 'text-gray-600', bg: 'from-gray-50 to-slate-50' };
    }
  };

  if (!suggestion) return null;

  const currentPriorityInfo = getPriorityInfo(priority);
  const currentStatusInfo = getStatusInfo(suggestion.status);
  const CurrentStatusIcon = currentStatusInfo.icon;
  const CurrentPriorityIcon = currentPriorityInfo.icon;
  const fullParty1Name = `${suggestion.firstParty.firstName} ${suggestion.firstParty.lastName}`;
  const fullParty2Name = `${suggestion.secondParty.firstName} ${suggestion.secondParty.lastName}`;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-6xl max-h-[95vh] overflow-y-auto border-0 shadow-2xl rounded-3xl p-0" dir="rtl">
        <div className={cn('relative overflow-hidden bg-gradient-to-br', currentStatusInfo.bg, 'border-b border-gray-100')}>
          <div className="absolute inset-0">
            <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-white/30 to-transparent rounded-full blur-3xl"></div>
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl"></div>
          </div>
          <div className="relative z-10 p-8">
            <DialogHeader>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-4">
                  <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                    <CurrentStatusIcon className={cn('w-8 h-8', currentStatusInfo.color)} />
                  </div>
                  <div>
                    <DialogTitle className="text-3xl font-bold text-gray-800">{dict.header.title.replace('{{id}}', suggestion.id.slice(-8))}</DialogTitle>
                    <DialogDescription className="text-lg text-gray-600 mt-1">
                      {dict.header.description.replace('{{party1}}', fullParty1Name).replace('{{party2}}', fullParty2Name)}
                    </DialogDescription>
                  </div>
                </div>
                <Button variant="ghost" size="icon" onClick={onClose} className="rounded-full h-12 w-12 text-gray-500 hover:text-gray-700 hover:bg-white/50 backdrop-blur-sm">
                  <X className="w-6 h-6" />
                </Button>
              </div>
              <div className="flex items-center gap-4">
                <Badge className={cn('px-4 py-2 font-bold shadow-lg bg-gradient-to-r text-white', currentPriorityInfo.color)}>
                  <CurrentPriorityIcon className="w-4 h-4 ml-2" />
                  {dict.header.priorityLabel.replace('{{priority}}', currentPriorityInfo.label)}
                </Badge>
                <Badge className="px-4 py-2 bg-white/20 backdrop-blur-sm text-gray-700 border border-white/30">
                  {dict.header.currentStatusLabel.replace('{{status}}', getStatusLabel(suggestion.status))}
                </Badge>
              </div>
            </DialogHeader>
          </div>
        </div>
        <div className="p-8 space-y-8">
          <Alert className="border-0 bg-gradient-to-r from-blue-50 to-cyan-50 shadow-lg rounded-2xl">
            <AlertTriangle className="h-5 w-5 text-blue-500" />
            <AlertDescription className="text-blue-800 font-medium">
              <strong>{dict.infoAlert.title}</strong> {dict.infoAlert.createdFor.replace('{{party1}}', fullParty1Name).replace('{{party2}}', fullParty2Name)}
              <br />
              <strong>{dict.infoAlert.status.replace('{{status}}', getStatusLabel(suggestion.status))}</strong> •{' '}
              <strong>{dict.infoAlert.priority.replace('{{priority}}', currentPriorityInfo.label)}</strong>
            </AlertDescription>
          </Alert>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-4 p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center gap-3 mb-4">
                <div className={cn('p-2 rounded-full bg-gradient-to-r text-white shadow-lg', currentPriorityInfo.color)}><Star className="w-5 h-5" /></div>
                <Label className="text-lg font-bold text-gray-800">{dict.sections.priority.title}</Label>
              </div>
              <Select value={priority} onValueChange={(value) => setPriority(value as Priority)}>
                <SelectTrigger className="h-12 border-2 border-gray-200 hover:border-purple-300 focus:border-purple-500 rounded-xl transition-all">
                  <SelectValue placeholder={dict.sections.priority.placeholder} />
                </SelectTrigger>
                <SelectContent>
                  {Object.keys(dict.priorityLabels).map((p) => {
                    const info = getPriorityInfo(p as Priority);
                    const Icon = info.icon;
                    return (
                      <SelectItem key={p} value={p}>
                        <div className="flex items-center gap-2"><Icon className={cn('w-4 h-4', info.textColor)} />{info.label}</div>
                      </SelectItem>
                    );
                  })}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-4 p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg"><RefreshCw className="w-5 h-5" /></div>
                  <Label className="text-lg font-bold text-gray-800">{dict.sections.statusChange.title}</Label>
                </div>
                <Button type="button" variant={showStatusChange ? 'default' : 'outline'} size="sm" onClick={() => setShowStatusChange(!showStatusChange)} className={cn('rounded-xl transition-all duration-300', showStatusChange ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'border-2 border-purple-200 text-purple-600 hover:bg-purple-50')}>
                  <RefreshCw className="w-4 h-4 ml-2" />{showStatusChange ? dict.sections.statusChange.cancelChangeButton : dict.sections.statusChange.changeButton}
                </Button>
              </div>
              {showStatusChange && (
                <div className="space-y-4 p-4 border-2 border-purple-100 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50">
                  <Select value={selectedStatus || ''} onValueChange={(value) => setSelectedStatus(value && value !== 'NO_CHANGE' ? value as MatchSuggestionStatus : null)}>
                    <SelectTrigger className="h-12 border-2 border-purple-200 bg-white"><SelectValue placeholder={dict.sections.statusChange.placeholder} /></SelectTrigger>
                    <SelectContent>
                      <SelectItem value="NO_CHANGE">{dict.sections.statusChange.noChangeOption}</SelectItem>
                      {getAvailableStatuses().map((status) => (<SelectItem key={status} value={status}>{getStatusLabel(status)}</SelectItem>))}
                    </SelectContent>
                  </Select>
                  {selectedStatus && (
                    <div>
                      <Label className="text-sm font-medium text-purple-800">{dict.sections.statusChange.notesLabel}</Label>
                      <Textarea value={statusNotes} onChange={(e) => setStatusNotes(e.target.value)} placeholder={dict.sections.statusChange.notesPlaceholder} className="mt-2 h-20 border-2 border-purple-200 focus:border-purple-400 rounded-xl" />
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
          <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 rounded-full bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg"><Calendar className="w-5 h-5" /></div>
              <Label className="text-lg font-bold text-gray-800">{dict.sections.decisionDeadline.title}</Label>
            </div>
            <DatePicker value={{ from: decisionDeadline, to: undefined }} onChange={({ from }) => setDecisionDeadline(from)} />
          </div>
          <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 rounded-full bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-lg"><Heart className="w-5 h-5" /></div>
              <Label className="text-lg font-bold text-gray-800">{dict.sections.matchingReason.title}</Label>
            </div>
            <Textarea value={matchingReason} onChange={(e) => setMatchingReason(e.target.value)} placeholder={dict.sections.matchingReason.placeholder} className="h-32 border-2 border-gray-200 focus:border-emerald-400 rounded-xl transition-all resize-none" />
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg"><User className="w-5 h-5" /></div>
                <Label className="text-lg font-bold text-gray-800">{dict.sections.firstPartyNotes.title.replace('{{name}}', suggestion.firstParty.firstName)}</Label>
              </div>
              <Textarea value={firstPartyNotes} onChange={(e) => setFirstPartyNotes(e.target.value)} placeholder={dict.sections.firstPartyNotes.placeholder} className="h-32 border-2 border-gray-200 focus:border-blue-400 rounded-xl transition-all resize-none" />
            </div>
            <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg"><User className="w-5 h-5" /></div>
                <Label className="text-lg font-bold text-gray-800">{dict.sections.secondPartyNotes.title.replace('{{name}}', suggestion.secondParty.firstName)}</Label>
              </div>
              <Textarea value={secondPartyNotes} onChange={(e) => setSecondPartyNotes(e.target.value)} placeholder={dict.sections.secondPartyNotes.placeholder} className="h-32 border-2 border-gray-200 focus:border-purple-400 rounded-xl transition-all resize-none" />
            </div>
          </div>
          <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg"><MessageCircle className="w-5 h-5" /></div>
              <Label className="text-lg font-bold text-gray-800">{dict.sections.internalNotes.title}</Label>
            </div>
            <Textarea value={internalNotes} onChange={(e) => setInternalNotes(e.target.value)} placeholder={dict.sections.internalNotes.placeholder} className="h-32 border-2 border-gray-200 focus:border-amber-400 rounded-xl transition-all resize-none" />
          </div>
        </div>
        <DialogFooter className="p-8 border-t border-gray-100 bg-gradient-to-r from-gray-50 to-slate-50">
          <div className="flex justify-between w-full items-center">
            <span className="text-sm text-gray-500 font-medium">{dict.footer.info}</span>
            <div className="flex gap-4">
              <Button variant="outline" onClick={onClose} disabled={isSubmitting} className="px-8 py-3 border-2 border-gray-300 hover:bg-gray-50 rounded-xl transition-all">{dict.footer.cancelButton}</Button>
              <Button onClick={handleSubmit} disabled={isSubmitting} className="px-8 py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-xl transform hover:scale-105">
                {isSubmitting ? (<><RefreshCw className="w-5 h-5 ml-2 animate-spin" />{dict.footer.savingButton}</>) : (<><Save className="w-5 h-5 ml-2" />{dict.footer.saveButton}</>)}
              </Button>
            </div>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};

export default EditSuggestionForm;
--- End of Content for EditSuggestionForm.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\MessageForm.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/MessageForm.tsx

import React, { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import {
  MessageCircle,
  Send,
  Users,
  User,
  Clock,
  Sparkles,
  X,
  Mail,
  Bell,
  Info,
  Heart,
  Zap,
} from 'lucide-react';
import type { Suggestion } from '@/types/suggestions';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface MessageFormProps {
  isOpen: boolean;
  onClose: () => void;
  suggestion: Suggestion | null;
  onSend: (data: {
    suggestionId: string;
    partyType: 'first' | 'second' | 'both';
    messageType: 'message' | 'reminder' | 'update';
    messageContent: string;
  }) => Promise<void>;
  dict: MatchmakerPageDictionary['suggestionsDashboard']['messageForm'];
}

const MessageForm: React.FC<MessageFormProps> = ({
  isOpen,
  onClose,
  suggestion,
  onSend,
  dict,
}) => {
  const [partyType, setPartyType] = useState<'first' | 'second' | 'both'>(
    'both'
  );
  const [messageType, setMessageType] = useState<
    'message' | 'reminder' | 'update'
  >('message');
  const [messageContent, setMessageContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    if (!suggestion || !messageContent.trim()) return;

    try {
      setIsSubmitting(true);
      await onSend({
        suggestionId: suggestion.id,
        partyType,
        messageType,
        messageContent,
      });

      let recipientText = '';
      if (partyType === 'first') {
        recipientText = dict.toasts.successRecipients.first.replace(
          '{{name}}',
          suggestion.firstParty.firstName
        );
      } else if (partyType === 'second') {
        recipientText = dict.toasts.successRecipients.second.replace(
          '{{name}}',
          suggestion.secondParty.firstName
        );
      } else {
        recipientText = dict.toasts.successRecipients.both;
      }
      toast.success(
        dict.toasts.success.replace('{{recipient}}', recipientText)
      );

      setMessageContent('');
      setPartyType('both');
      setMessageType('message');
      onClose();
    } catch (error) {
      toast.error(dict.toasts.error);
      console.error('Error sending message:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const getMessageTypeInfo = (type: 'message' | 'reminder' | 'update') => {
    const infoMap = {
      message: {
        icon: MessageCircle,
        color: 'from-purple-500 to-pink-500',
        bgColor: 'from-purple-50 to-pink-50',
      },
      reminder: {
        icon: Clock,
        color: 'from-yellow-500 to-amber-500',
        bgColor: 'from-yellow-50 to-amber-50',
      },
      update: {
        icon: Info,
        color: 'from-blue-500 to-cyan-500',
        bgColor: 'from-blue-50 to-cyan-50',
      },
    };
    return {
      label: dict.messageTypes[type].label,
      description: dict.messageTypes[type].description,
      placeholder: dict.messageTypes[type].placeholder,
      ...infoMap[type],
    };
  };

  const getPartyTypeInfo = (type: 'first' | 'second' | 'both') => {
    const infoMap = {
      first: { icon: User, color: 'from-green-500 to-emerald-500' },
      second: { icon: User, color: 'from-blue-500 to-cyan-500' },
      both: { icon: Users, color: 'from-purple-500 to-pink-500' },
    };
    const labels = {
      first: dict.partyTypes.first
        .replace('{{firstName}}', suggestion?.firstParty.firstName || '')
        .replace('{{lastName}}', suggestion?.firstParty.lastName || ''),
      second: dict.partyTypes.second
        .replace('{{firstName}}', suggestion?.secondParty.firstName || '')
        .replace('{{lastName}}', suggestion?.secondParty.lastName || ''),
      both: dict.partyTypes.both,
    };
    return {
      label: labels[type],
      ...infoMap[type],
    };
  };

  if (!suggestion) return null;

  const currentMessageTypeInfo = getMessageTypeInfo(messageType);
  const currentPartyTypeInfo = getPartyTypeInfo(partyType);
  const MessageTypeIcon = currentMessageTypeInfo.icon;
  const PartyTypeIcon = currentPartyTypeInfo.icon;
  const fullParty1Name = `${suggestion.firstParty.firstName} ${suggestion.firstParty.lastName}`;
  const fullParty2Name = `${suggestion.secondParty.firstName} ${suggestion.secondParty.lastName}`;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent
        className="max-w-4xl border-0 shadow-2xl rounded-3xl p-0 overflow-hidden"
        dir="rtl"
      >
        <div
          className={cn(
            'relative overflow-hidden bg-gradient-to-br',
            currentMessageTypeInfo.bgColor,
            'border-b border-gray-100'
          )}
        >
          <div className="absolute inset-0">
            <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-white/30 to-transparent rounded-full blur-3xl"></div>
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl"></div>
          </div>
          <div className="relative z-10 p-8">
            <DialogHeader>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-4">
                  <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                    <Send className="w-8 h-8 text-purple-600" />
                  </div>
                  <div>
                    <DialogTitle className="text-3xl font-bold text-gray-800">
                      {dict.header.title}
                    </DialogTitle>
                    <DialogDescription className="text-lg text-gray-600 mt-1">
                      {dict.header.description
                        .replace('{{party1}}', fullParty1Name)
                        .replace('{{party2}}', fullParty2Name)}
                    </DialogDescription>
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={onClose}
                  className="rounded-full h-12 w-12 text-gray-500 hover:text-gray-700 hover:bg-white/50 backdrop-blur-sm"
                >
                  <X className="w-6 h-6" />
                </Button>
              </div>
              <div className="flex items-center gap-4">
                <Badge
                  className={cn(
                    'px-4 py-2 font-bold shadow-lg bg-gradient-to-r text-white',
                    currentMessageTypeInfo.color
                  )}
                >
                  <MessageTypeIcon className="w-4 h-4 ml-2" />
                  {currentMessageTypeInfo.label}
                </Badge>
                <Badge
                  className={cn(
                    'px-4 py-2 font-bold shadow-lg bg-gradient-to-r text-white',
                    currentPartyTypeInfo.color
                  )}
                >
                  <PartyTypeIcon className="w-4 h-4 ml-2" />
                  {currentPartyTypeInfo.label}
                </Badge>
              </div>
            </DialogHeader>
          </div>
        </div>
        <div className="p-8 space-y-8">
          <Alert className="border-0 bg-gradient-to-r from-indigo-50 to-purple-50 shadow-lg rounded-2xl">
            <Heart className="h-5 w-5 text-indigo-500" />
            <AlertDescription className="text-indigo-800 font-medium">
              <strong>
                {dict.infoAlert.suggestionPrefix}
                {suggestion.id.slice(-8)}:
              </strong>{' '}
              {dict.infoAlert.body}
              <br />
              <strong>{dict.infoAlert.statusLabel}</strong> {suggestion.status}{' '}
              • <strong>{dict.infoAlert.priorityLabel}</strong>{' '}
              {suggestion.priority}
            </AlertDescription>
          </Alert>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
                  <Users className="w-5 h-5" />
                </div>
                <Label className="text-lg font-bold text-gray-800">
                  {dict.form.recipientLabel}
                </Label>
              </div>
              <Select
                value={partyType}
                onValueChange={(value) =>
                  setPartyType(value as 'first' | 'second' | 'both')
                }
              >
                <SelectTrigger className="h-12 border-2 border-gray-200 hover:border-green-300 focus:border-green-500 rounded-xl transition-all">
                  <SelectValue placeholder={dict.form.recipientPlaceholder} />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="first">
                    <div className="flex items-center gap-3">
                      <User className="w-4 h-4 text-green-500" />
                      {getPartyTypeInfo('first').label}
                    </div>
                  </SelectItem>
                  <SelectItem value="second">
                    <div className="flex items-center gap-3">
                      <User className="w-4 h-4 text-blue-500" />
                      {getPartyTypeInfo('second').label}
                    </div>
                  </SelectItem>
                  <SelectItem value="both">
                    <div className="flex items-center gap-3">
                      <Users className="w-4 h-4 text-purple-500" />
                      {getPartyTypeInfo('both').label}
                    </div>
                  </SelectItem>
                </SelectContent>
              </Select>
              <div className="mt-3 p-3 bg-green-50 rounded-xl">
                <p className="text-sm text-green-700">
                  <PartyTypeIcon className="w-4 h-4 inline ml-1" />
                  {dict.form.recipientSelectedPrefix}{' '}
                  {currentPartyTypeInfo.label}
                </p>
              </div>
            </div>
            <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
              <div className="flex items-center gap-3 mb-4">
                <div
                  className={cn(
                    'p-2 rounded-full bg-gradient-to-r text-white shadow-lg',
                    currentMessageTypeInfo.color
                  )}
                >
                  <MessageTypeIcon className="w-5 h-5" />
                </div>
                <Label className="text-lg font-bold text-gray-800">
                  {dict.form.messageTypeLabel}
                </Label>
              </div>
              <Select
                value={messageType}
                onValueChange={(value) =>
                  setMessageType(value as 'message' | 'reminder' | 'update')
                }
              >
                <SelectTrigger className="h-12 border-2 border-gray-200 hover:border-purple-300 focus:border-purple-500 rounded-xl transition-all">
                  <SelectValue placeholder={dict.form.messageTypePlaceholder} />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="message">
                    <div className="flex items-center gap-3">
                      <MessageCircle className="w-4 h-4 text-purple-500" />
                      {dict.messageTypes.message.label}
                    </div>
                  </SelectItem>
                  <SelectItem value="reminder">
                    <div className="flex items-center gap-3">
                      <Clock className="w-4 h-4 text-yellow-500" />
                      {dict.messageTypes.reminder.label}
                    </div>
                  </SelectItem>
                  <SelectItem value="update">
                    <div className="flex items-center gap-3">
                      <Info className="w-4 h-4 text-blue-500" />
                      {dict.messageTypes.update.label}
                    </div>
                  </SelectItem>
                </SelectContent>
              </Select>
              <div
                className={cn(
                  'mt-3 p-3 rounded-xl bg-gradient-to-r',
                  currentMessageTypeInfo.bgColor
                )}
              >
                <p
                  className="text-sm font-medium"
                  style={{ color: currentMessageTypeInfo.color.split(' ')[1] }}
                >
                  <MessageTypeIcon className="w-4 h-4 inline ml-1" />
                  {currentMessageTypeInfo.description}
                </p>
              </div>
            </div>
          </div>
          <div className="p-6 bg-white rounded-2xl shadow-xl border-0 hover:shadow-2xl transition-all duration-300">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                <Mail className="w-5 h-5" />
              </div>
              <Label className="text-lg font-bold text-gray-800">
                {dict.form.messageContentLabel}
              </Label>
            </div>
            <Textarea
              value={messageContent}
              onChange={(e) => setMessageContent(e.target.value)}
              placeholder={currentMessageTypeInfo.placeholder}
              className="h-48 border-2 border-gray-200 focus:border-indigo-400 rounded-xl transition-all resize-none text-lg"
              dir="rtl"
            />
            <div className="mt-3 flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Sparkles className="w-4 h-4" />
                <span>{dict.form.signatureNotice}</span>
              </div>
              <div className="text-sm text-gray-500">
                {dict.form.charsCount.replace(
                  '{{count}}',
                  messageContent.length.toString()
                )}
              </div>
            </div>
          </div>
          {messageContent.trim() && (
            <div className="p-6 bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl border-2 border-gray-200">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 rounded-full bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-lg">
                  <Zap className="w-5 h-5" />
                </div>
                <h3 className="text-lg font-bold text-gray-800">
                  {dict.preview.title}
                </h3>
              </div>
              <div className="bg-white p-4 rounded-xl border-2 border-gray-100 shadow-inner">
                <div className="text-sm text-gray-600 mb-2">
                  {dict.preview.recipientLabel} {currentPartyTypeInfo.label} •{' '}
                  {dict.preview.typeLabel} {currentMessageTypeInfo.label}
                </div>
                <div className="text-gray-800 leading-relaxed whitespace-pre-wrap">
                  {messageContent}
                </div>
                <div className="mt-4 pt-3 border-t border-gray-100 text-xs text-gray-500">
                  {dict.preview.signature.greeting}
                  <br />
                  {dict.preview.signature.team}
                </div>
              </div>
            </div>
          )}
        </div>
        <DialogFooter className="p-8 border-t border-gray-100 bg-gradient-to-r from-gray-50 to-slate-50">
          <div className="flex justify-between w-full items-center">
            <div className="flex items-center gap-2 text-sm text-gray-500">
              <Bell className="w-4 h-4" />
              <span>{dict.footer.notificationNotice}</span>
            </div>
            <div className="flex gap-4">
              <Button
                variant="outline"
                onClick={onClose}
                disabled={isSubmitting}
                className="px-8 py-3 border-2 border-gray-300 hover:bg-gray-50 rounded-xl transition-all"
              >
                {dict.footer.cancelButton}
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isSubmitting || !messageContent.trim()}
                className="px-8 py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-xl transform hover:scale-105"
              >
                {isSubmitting ? (
                  <>
                    <Send className="w-5 h-5 ml-2 animate-pulse" />
                    {dict.footer.sendingButton}
                  </>
                ) : (
                  <>
                    <Send className="w-5 h-5 ml-2" />
                    {dict.footer.sendButton}
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};

export default MessageForm;
--- End of Content for MessageForm.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\CandidateSelector.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/CandidateSelector.tsx

import React, { useState, useCallback, KeyboardEvent } from 'react';
import {
  Search,
  AlertTriangle,
  Clock,
  User,
  Crown,
  Star,
  Heart,
  Sparkles,
  MapPin,
  Award,
  Zap,
  Shield,
} from 'lucide-react';
import { Input } from '@/components/ui/input';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import {
  Command,
  CommandGroup,
  CommandInput,
  CommandList,
} from '@/components/ui/command';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import {
  calculateAge,
  cn,
  getRelativeCloudinaryPath,
  getInitials,
} from '@/lib/utils';
import type { Candidate } from '../../new/types/candidates';
import { toast } from 'sonner';
import type { CandidateSelectorDict } from '@/types/dictionaries/matchmaker'; // <--- ייבוא הטיפוס של המילון

// ===> עדכון Props <===
interface CandidateSelectorProps {
  dict: CandidateSelectorDict; // <-- הוספת המילון כ-prop
  value: Candidate | null;
  onChange: (candidate: Candidate | null) => void;
  otherParty?: Candidate | null;
  label: string;
  candidates: Candidate[];
  className?: string;
  fieldName: string;
  error?: string;
}

const EnhancedCandidateCard: React.FC<{
  dict: CandidateSelectorDict; // <-- קבלת המילון
  candidate: Candidate;
  onClick: () => void;
  isActive: boolean;
  isBlocked: boolean;
}> = ({ dict, candidate, onClick, isActive, isBlocked }) => {
  const age = calculateAge(new Date(candidate.profile.birthDate));
  const mainImage = candidate.images.find((img) => img.isMain)?.url;

  const getStatusInfo = () => {
    if (isBlocked) {
      return {
        icon: Shield,
        label: dict.status.blocked,
        className:
          'bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse',
        description: dict.status.blockedDescription.replace(
          '{{name}}',
          candidate.suggestionStatus?.withCandidateName || ''
        ),
      };
    }

    if (candidate.suggestionStatus?.status === 'PENDING') {
      return {
        icon: Clock,
        label: dict.status.pending,
        className: 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white',
        description: dict.status.pendingDescription.replace(
          '{{name}}',
          candidate.suggestionStatus.withCandidateName
        ),
      };
    }

    return {
      icon: Star,
      label: dict.status.available,
      className: 'bg-gradient-to-r from-green-500 to-emerald-500 text-white',
      description: dict.status.availableDescription,
    };
  };

  const statusInfo = getStatusInfo();
  const StatusIcon = statusInfo.icon;

  return (
    <div
      className={cn(
        'group relative overflow-hidden rounded-2xl transition-all duration-300 cursor-pointer',
        'bg-gradient-to-br from-white via-gray-50/30 to-white border-2 shadow-lg hover:shadow-2xl',
        isActive && 'ring-4 ring-purple-500 ring-opacity-50 border-purple-300',
        isBlocked && 'opacity-60 cursor-not-allowed',
        !isBlocked && 'hover:scale-105 hover:border-purple-300'
      )}
      onClick={!isBlocked ? onClick : undefined}
    >
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div className="absolute bottom-0 left-0 w-16 h-16 bg-gradient-to-br from-cyan-200/20 to-blue-200/20 rounded-full blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      </div>
      <div className="relative z-10 p-4 space-y-4">
        <div className="flex items-center justify-between">
          <Badge className={cn('shadow-lg font-bold', statusInfo.className)}>
            <StatusIcon className="w-3 h-3 ml-1" />
            {statusInfo.label}
          </Badge>
          {candidate.profile.religiousLevel && (
            <Badge className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
              <Crown className="w-3 h-3 ml-1" />
              {candidate.profile.religiousLevel}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-4">
          <div className="relative">
            <Avatar className="w-16 h-16 border-4 border-white shadow-xl ring-2 ring-purple-200 group-hover:ring-purple-400 transition-all duration-300">
              {mainImage ? (
                <AvatarImage
                  src={getRelativeCloudinaryPath(mainImage)}
                  alt={`${candidate.firstName} ${candidate.lastName}`}
                  className="object-cover"
                />
              ) : (
                <AvatarFallback className="bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold text-lg">
                  {getInitials(`${candidate.firstName} ${candidate.lastName}`)}
                </AvatarFallback>
              )}
            </Avatar>
            <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-r from-green-400 to-emerald-400 border-2 border-white rounded-full shadow-lg animate-pulse"></div>
          </div>
          <div className="flex-1 min-w-0">
            <h3 className="text-lg font-bold text-gray-800 truncate group-hover:text-purple-700 transition-colors">
              {candidate.firstName} {candidate.lastName}
            </h3>
            <div className="flex items-center gap-2 mt-1">
              <div className="flex items-center gap-1 text-sm text-gray-600">
                <User className="w-4 h-4 text-blue-500" />
                <span className="font-medium">
                  {age} {dict.card.years}
                </span>
              </div>
              {candidate.profile.city && (
                <div className="flex items-center gap-1 text-sm text-gray-600">
                  <MapPin className="w-4 h-4 text-green-500" />
                  <span className="truncate">{candidate.profile.city}</span>
                </div>
              )}
            </div>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3">
          {candidate.profile.occupation && (
            <div className="flex items-center gap-2 p-2 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-100 shadow-sm">
              <Award className="w-4 h-4 text-blue-500 flex-shrink-0" />
              <span className="text-sm font-medium text-blue-700 truncate">
                {candidate.profile.occupation}
              </span>
            </div>
          )}
          {candidate.profile.education && (
            <div className="flex items-center gap-2 p-2 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-100 shadow-sm">
              <Sparkles className="w-4 h-4 text-purple-500 flex-shrink-0" />
              <span className="text-sm font-medium text-purple-700 truncate">
                {candidate.profile.education}
              </span>
            </div>
          )}
        </div>
        {isBlocked && (
          <div className="p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border border-red-200">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-red-700">
                <p className="font-medium">{dict.card.cannotSelect}</p>
                <p className="text-xs">{statusInfo.description}</p>
              </div>
            </div>
          </div>
        )}
      </div>
      <div className="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
    </div>
  );
};

const CandidateSelector: React.FC<CandidateSelectorProps> = ({
  dict,
  value,
  onChange,
  otherParty,
  label,
  candidates,
  className,
  error,
}) => {
  const [open, setOpen] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [activeIndex, setActiveIndex] = useState(-1);

  const filteredCandidates = candidates.filter((candidate) => {
    if (otherParty && candidate.id === otherParty.id) return false;
    if (inputValue) {
      const searchTerm = inputValue.toLowerCase();
      return (
        candidate.firstName.toLowerCase().includes(searchTerm) ||
        candidate.lastName.toLowerCase().includes(searchTerm) ||
        candidate.profile.city?.toLowerCase().includes(searchTerm) ||
        candidate.profile.occupation?.toLowerCase().includes(searchTerm)
      );
    }
    return true;
  });

  const formatCandidateDisplay = useCallback((candidate: Candidate) => {
    const age = calculateAge(new Date(candidate.profile.birthDate));
    return `${candidate.firstName} ${candidate.lastName}, ${age}${
      candidate.profile.city ? `, ${candidate.profile.city}` : ''
    }`;
  }, []);

  const handleSelect = useCallback(
    (candidate: Candidate) => {
      if (candidate.suggestionStatus?.status === 'BLOCKED') {
        toast.error(dict.toasts.cannotSelectError.title, {
          description: dict.toasts.cannotSelectError.description
            .replace('{{name}}', `${candidate.firstName} ${candidate.lastName}`)
            .replace(
              '{{withName}}',
              candidate.suggestionStatus.withCandidateName
            ),
        });
        return;
      }
      onChange(candidate);
      setOpen(false);
      setInputValue('');
      setActiveIndex(-1);
    },
    [onChange, dict]
  );

  const handleKeyDown = (e: KeyboardEvent) => {
    if (!open) return;
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setActiveIndex((prev) =>
          prev < filteredCandidates.length - 1 ? prev + 1 : prev
        );
        break;
      case 'ArrowUp':
        e.preventDefault();
        setActiveIndex((prev) => (prev > 0 ? prev - 1 : prev));
        break;
      case 'Enter':
        e.preventDefault();
        if (activeIndex >= 0 && activeIndex < filteredCandidates.length) {
          handleSelect(filteredCandidates[activeIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        setOpen(false);
        setActiveIndex(-1);
        break;
    }
  };

  return (
    <div className={className}>
      <div className="space-y-3">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
            <User className="w-5 h-5" />
          </div>
          <label className="text-lg font-bold text-gray-800">{label}</label>
        </div>
        <Popover open={open} onOpenChange={setOpen}>
          <PopoverTrigger asChild>
            <div className="relative group">
              <div className="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-2xl blur opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              <div className="relative">
                <Search className="absolute right-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-purple-400 group-hover:text-purple-600 transition-colors" />
                <Input
                  value={value ? formatCandidateDisplay(value) : inputValue}
                  onChange={(e) => {
                    setInputValue(e.target.value);
                    if (!open) setOpen(true);
                    setActiveIndex(-1);
                  }}
                  onKeyDown={handleKeyDown}
                  onClick={() => !open && setOpen(true)}
                  placeholder={dict.searchPlaceholder}
                  className={cn(
                    'h-14 pr-14 text-right text-lg border-2 transition-all duration-300 rounded-2xl shadow-lg',
                    'bg-white/80 backdrop-blur-sm',
                    'border-purple-200 hover:border-purple-300 focus:border-purple-500 focus:ring-purple-200',
                    'placeholder:text-gray-400',
                    error &&
                      'border-red-300 focus:border-red-500 focus:ring-red-200'
                  )}
                  role="combobox"
                  aria-expanded={open}
                  aria-controls="candidate-listbox"
                  aria-activedescendant={
                    activeIndex >= 0
                      ? `candidate-${filteredCandidates[activeIndex]?.id}`
                      : undefined
                  }
                />
                <div className="absolute left-4 top-1/2 transform -translate-y-1/2">
                  <Sparkles className="h-4 w-4 text-purple-400" />
                </div>
              </div>
            </div>
          </PopoverTrigger>
          <PopoverContent
            className="p-0 w-[500px] border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm"
            align="start"
            side="bottom"
            sideOffset={8}
          >
            <Command shouldFilter={false}>
              <div className="relative">
                <CommandInput
                  placeholder={dict.commandInputPlaceholder}
                  value={inputValue}
                  onValueChange={setInputValue}
                  className="h-12 border-0 text-right text-lg bg-gradient-to-r from-purple-50 to-pink-50"
                />
                <div className="absolute right-4 top-1/2 transform -translate-y-1/2">
                  <Search className="h-4 w-4 text-purple-400" />
                </div>
              </div>
              <CommandList
                className="max-h-[400px] overflow-auto p-2"
                id="candidate-listbox"
                role="listbox"
              >
                {filteredCandidates.length === 0 ? (
                  <div className="text-center p-8">
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4">
                      <Search className="w-8 h-8 text-gray-400" />
                    </div>
                    <h3 className="text-lg font-bold text-gray-800 mb-2">
                      {dict.noResults.title}
                    </h3>
                    <p className="text-gray-600">
                      {dict.noResults.description}
                    </p>
                  </div>
                ) : (
                  <CommandGroup>
                    <div className="grid gap-3">
                      {filteredCandidates.map((candidate, index) => (
                        <EnhancedCandidateCard
                          key={candidate.id}
                          dict={dict}
                          candidate={candidate}
                          onClick={() => handleSelect(candidate)}
                          isActive={index === activeIndex}
                          isBlocked={
                            candidate.suggestionStatus?.status === 'BLOCKED'
                          }
                        />
                      ))}
                    </div>
                  </CommandGroup>
                )}
              </CommandList>
            </Command>
          </PopoverContent>
        </Popover>
        {error && (
          <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
            <AlertTriangle className="w-4 h-4 text-red-500" />
            <p className="text-sm text-red-600 font-medium">{error}</p>
          </div>
        )}
      </div>
      {value && (
        <Card className="mt-4 border-0 shadow-xl bg-gradient-to-br from-white via-purple-50/30 to-pink-50/30 rounded-2xl overflow-hidden">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
                  <Heart className="w-5 h-5" />
                </div>
                <h4 className="text-lg font-bold text-gray-800">
                  {dict.selectedDisplay.title}
                </h4>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onChange(null)}
                className="text-red-600 hover:text-red-700 hover:bg-red-50 rounded-xl transition-all duration-300"
              >
                <Zap className="w-4 h-4 ml-1" />
                {dict.selectedDisplay.removeButton}
              </Button>
            </div>
            <EnhancedCandidateCard
              dict={dict}
              candidate={value}
              onClick={() => {}}
              isActive={true}
              isBlocked={false}
            />
            <div className="flex gap-3 mt-4">
              <Button
                variant="outline"
                size="sm"
                onClick={() => {}}
                className="flex-1 border-2 border-purple-200 text-purple-600 hover:bg-purple-50 rounded-xl transition-all duration-300"
              >
                <User className="w-4 h-4 ml-2" />
                {dict.selectedDisplay.viewProfileButton}
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default CandidateSelector;
--- End of Content for CandidateSelector.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\MatchPreview.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/NewSuggestionForm/MatchPreview.tsx

import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  AlertCircle,
  Heart,
  Star,
  Sparkles,
  TrendingUp,
  Award,
  Crown,
  Gem,
  Zap,
  Target,
  Trophy,
  Gift,
} from 'lucide-react';
import { calculateMatchScore } from '../utils/matchingAlgorithm';
import type { Candidate } from '../../new/types/candidates';
import type { MatchScore } from '../utils/matchingAlgorithm';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface MatchPreviewProps {
  dict: MatchmakerPageDictionary['suggestionsDashboard']['newSuggestionForm']['matchPreview'];
  firstParty: Candidate;
  secondParty: Candidate;
  className?: string;
}

/**
 * Helper function to dynamically access nested dictionary properties using a dot-notation key.
 * @param dict - The dictionary object to search within.
 * @param key - The dot-separated key (e.g., "age.reasons.ideal").
 * @returns The translated string or the key itself as a fallback.
 */
const getTranslatedReason = (dict: any, key: string): string => {
  try {
    const keys = key.split('.');
    let result = dict;
    for (const k of keys) {
      if (result[k] === undefined) {
        // If any part of the path is missing, return the original key
        return key;
      }
      result = result[k];
    }
    return typeof result === 'string' ? result : key;
  } catch (error) {
    console.warn(`Translation key not found: ${key}`, error);
    return key; // Fallback to the key itself if an error occurs
  }
};

const MatchCriteriaCard: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['newSuggestionForm']['matchPreview'];
  criterion: {
    name: string;
    score: number;
    reason?: string;
  };
  index: number;
}> = ({ dict, criterion, index }) => {
  const getCriterionInfo = (name: string) => {
    switch (name) {
      case 'age':
        return {
          icon: Target,
          label: dict.criteria.age,
          color: 'from-blue-500 to-cyan-500',
          bgColor: 'from-blue-50 to-cyan-50',
        };
      case 'location':
        return {
          icon: Crown,
          label: dict.criteria.location,
          color: 'from-green-500 to-emerald-500',
          bgColor: 'from-green-50 to-emerald-50',
        };
      case 'religious':
        return {
          icon: Sparkles,
          label: dict.criteria.religious,
          color: 'from-purple-500 to-pink-500',
          bgColor: 'from-purple-50 to-pink-50',
        };
      default:
        return {
          icon: Star,
          label: name,
          color: 'from-gray-500 to-slate-500',
          bgColor: 'from-gray-50 to-slate-50',
        };
    }
  };

  const info = getCriterionInfo(criterion.name);
  const IconComponent = info.icon;
  const scorePercentage = Math.round(criterion.score * 100);
  const translatedReason = criterion.reason
    ? getTranslatedReason(dict.criteria, criterion.reason)
    : '';

  const getScoreCategory = (score: number) => {
    if (score >= 0.9)
      return {
        label: dict.scoreCategories.perfect,
        color: 'text-emerald-600',
        bgColor: 'bg-emerald-100',
      };
    if (score >= 0.8)
      return {
        label: dict.scoreCategories.excellent,
        color: 'text-green-600',
        bgColor: 'bg-green-100',
      };
    if (score >= 0.7)
      return {
        label: dict.scoreCategories.good,
        color: 'text-blue-600',
        bgColor: 'bg-blue-100',
      };
    if (score >= 0.5)
      return {
        label: dict.scoreCategories.medium,
        color: 'text-yellow-600',
        bgColor: 'bg-yellow-100',
      };
    return {
      label: dict.scoreCategories.low,
      color: 'text-red-600',
      bgColor: 'bg-red-100',
    };
  };

  const scoreCategory = getScoreCategory(criterion.score);

  return (
    <div
      className={cn(
        'relative overflow-hidden rounded-2xl transition-all duration-500 group hover:scale-105',
        'bg-gradient-to-br',
        info.bgColor,
        'border border-white/50 shadow-lg hover:shadow-2xl'
      )}
      style={{
        animationDelay: `${index * 150}ms`,
        animationFillMode: 'both',
      }}
    >
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-white/30 to-transparent rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div className="absolute bottom-0 left-0 w-12 h-12 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      </div>
      <div className="relative z-10 p-6 space-y-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div
              className={cn(
                'p-3 rounded-full shadow-lg group-hover:scale-110 transition-transform bg-gradient-to-r text-white',
                info.color
              )}
            >
              <IconComponent className="w-5 h-5" />
            </div>
            <h4 className="text-lg font-bold text-gray-800">{info.label}</h4>
          </div>
          <Badge
            className={cn(
              'px-3 py-1 font-bold shadow-lg',
              scoreCategory.bgColor,
              scoreCategory.color
            )}
          >
            {scoreCategory.label}
          </Badge>
        </div>
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-600">
              {dict.scoreLabel}
            </span>
            <span className="text-2xl font-bold text-gray-800">
              {scorePercentage}%
            </span>
          </div>
          <div className="relative">
            <Progress
              value={scorePercentage}
              className="h-3 bg-white/50 shadow-inner"
            />
            <div className="absolute inset-0 rounded-full bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          </div>
        </div>
        {translatedReason && (
          <div className="p-3 bg-white/60 backdrop-blur-sm rounded-xl border border-white/50 shadow-inner">
            <p className="text-sm text-gray-700 leading-relaxed font-medium">
              {translatedReason}
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

const MatchPreview: React.FC<MatchPreviewProps> = ({
  dict,
  firstParty,
  secondParty,
  className,
}) => {
  const matchScore: MatchScore | null = calculateMatchScore(
    firstParty.profile,
    secondParty.profile
  );

  if (!matchScore) {
    return (
      <Card
        className={cn(
          'border-0 shadow-xl rounded-3xl overflow-hidden',
          className
        )}
      >
        <CardContent className="p-8">
          <div className="text-center space-y-6">
            <div className="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-100 to-amber-100 flex items-center justify-center mx-auto shadow-xl">
              <AlertCircle className="w-12 h-12 text-yellow-500" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                {dict.errorState.title}
              </h3>
              <p className="text-gray-600">{dict.errorState.description}</p>
            </div>
            <div className="p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-2xl border border-yellow-200">
              <p className="text-sm text-yellow-800 font-medium">
                {dict.errorState.suggestion}
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  const getMatchQuality = (score: number) => {
    const qualityMap = {
      perfect: {
        icon: Crown,
        bgGradient: 'from-purple-500 to-pink-500',
        bgColor: 'from-purple-50 to-pink-50',
        animation: 'animate-pulse',
      },
      excellent: {
        icon: Gem,
        bgGradient: 'from-emerald-500 to-green-500',
        bgColor: 'from-emerald-50 to-green-50',
        animation: '',
      },
      good: {
        icon: Trophy,
        bgGradient: 'from-blue-500 to-cyan-500',
        bgColor: 'from-blue-50 to-cyan-50',
        animation: '',
      },
      medium: {
        icon: Star,
        bgGradient: 'from-yellow-500 to-amber-500',
        bgColor: 'from-yellow-50 to-amber-50',
        animation: '',
      },
      low: {
        icon: AlertCircle,
        bgGradient: 'from-red-500 to-pink-500',
        bgColor: 'from-red-50 to-pink-50',
        animation: '',
      },
    };

    if (score >= 95)
      return { ...dict.qualityLevels.perfect, ...qualityMap.perfect };
    if (score >= 85)
      return { ...dict.qualityLevels.excellent, ...qualityMap.excellent };
    if (score >= 75) return { ...dict.qualityLevels.good, ...qualityMap.good };
    if (score >= 60)
      return { ...dict.qualityLevels.medium, ...qualityMap.medium };
    return { ...dict.qualityLevels.low, ...qualityMap.low };
  };

  const quality = getMatchQuality(matchScore.score);
  const Icon = quality.icon;

  return (
    <Card
      className={cn(
        'border-0 shadow-2xl rounded-3xl overflow-hidden transition-all duration-500 hover:shadow-3xl',
        'bg-gradient-to-br',
        quality.bgColor,
        className
      )}
    >
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-3xl animate-float"></div>
        <div
          className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-white/10 to-transparent rounded-full blur-2xl animate-float"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-gradient-to-br from-white/5 to-transparent rounded-full blur-3xl animate-float"
          style={{ animationDelay: '4s' }}
        ></div>
      </div>
      <CardContent className="relative z-10 p-8 space-y-8">
        <div className="text-center space-y-6">
          <div className="flex items-center justify-center">
            <div
              className={cn(
                'p-6 rounded-full shadow-2xl bg-gradient-to-r text-white transform hover:scale-110 transition-transform duration-300',
                quality.bgGradient,
                quality.animation
              )}
            >
              <Icon className="w-12 h-12" />
            </div>
          </div>
          <div className="space-y-2">
            <h2 className="text-3xl font-bold text-gray-800">{quality.text}</h2>
            <p className="text-lg text-gray-600 leading-relaxed">
              {quality.description}
            </p>
          </div>
          <div className="relative">
            <div className="flex items-center justify-center gap-4 mb-4">
              <div className="text-center">
                <div className="text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                  {Math.round(matchScore.score)}%
                </div>
                <p className="text-sm font-medium text-gray-600 mt-1">
                  {dict.generalScoreLabel}
                </p>
              </div>
            </div>
            <div className="relative w-32 h-32 mx-auto">
              <svg
                className="w-32 h-32 transform -rotate-90"
                viewBox="0 0 100 100"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke="currentColor"
                  strokeWidth="8"
                  fill="transparent"
                  className="text-gray-200"
                />
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke="url(#gradient)"
                  strokeWidth="8"
                  fill="transparent"
                  strokeDasharray={`${2 * Math.PI * 40}`}
                  strokeDashoffset={`${2 * Math.PI * 40 * (1 - matchScore.score / 100)}`}
                  className="transition-all duration-1000 ease-out"
                  strokeLinecap="round"
                />
                <defs>
                  <linearGradient
                    id="gradient"
                    x1="0%"
                    y1="0%"
                    x2="100%"
                    y2="0%"
                  >
                    <stop offset="0%" stopColor="#8B5CF6" />
                    <stop offset="50%" stopColor="#EC4899" />
                    <stop offset="100%" stopColor="#3B82F6" />
                  </linearGradient>
                </defs>
              </svg>
              <div className="absolute inset-0 flex items-center justify-center">
                <Sparkles className="w-8 h-8 text-purple-500 animate-pulse" />
              </div>
            </div>
          </div>
        </div>
        <div className="space-y-6">
          <div className="text-center">
            <h3 className="text-2xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
              <TrendingUp className="w-6 h-6 text-purple-500" />
              {dict.criteriaSection.title}
            </h3>
            <p className="text-gray-600">{dict.criteriaSection.description}</p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {matchScore.criteria.map((criterion, index) => (
              <div key={criterion.name} className="animate-fade-in-up">
                <MatchCriteriaCard
                  dict={dict}
                  criterion={criterion}
                  index={index}
                />
              </div>
            ))}
          </div>
        </div>
        {matchScore.reasons.length > 0 && (
          <div className="space-y-4">
            <div className="text-center">
              <h4 className="text-xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                <Heart className="w-5 h-5 text-red-500" />
                {dict.reasonsSection.title}
              </h4>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {matchScore.reasons.map((reasonKey, index) => (
                <div
                  key={index}
                  className="flex items-start gap-3 p-4 bg-white/60 backdrop-blur-sm rounded-2xl border border-white/50 shadow-lg hover:shadow-xl transition-all duration-300 group"
                  style={{
                    animationDelay: `${(index + 3) * 150}ms`,
                    animationFillMode: 'both',
                  }}
                >
                  <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                    <Gift className="w-4 h-4" />
                  </div>
                  <p className="text-gray-700 leading-relaxed font-medium flex-1">
                    {getTranslatedReason(dict.criteria, reasonKey)}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}
        <div className="p-6 bg-white/70 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                <Award className="w-6 h-6" />
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-800">
                  {dict.summary.title}
                </h4>
                <p className="text-gray-600">{dict.summary.description}</p>
              </div>
            </div>
            <div className="text-right">
              <div className="flex items-center gap-2">
                {matchScore.score >= 80 ? (
                  <>
                    <Zap className="w-5 h-5 text-green-500" />
                    <span className="font-bold text-green-600">
                      {dict.summary.recommendations.high}
                    </span>
                  </>
                ) : matchScore.score >= 60 ? (
                  <>
                    <Star className="w-5 h-5 text-blue-500" />
                    <span className="font-bold text-blue-600">
                      {dict.summary.recommendations.medium}
                    </span>
                  </>
                ) : (
                  <>
                    <AlertCircle className="w-5 h-5 text-yellow-500" />
                    <span className="font-bold text-yellow-600">
                      {dict.summary.recommendations.low}
                    </span>
                  </>
                )}
              </div>
              <p className="text-sm text-gray-500 mt-1">
                {dict.summary.basedOn.replace(
                  '{{count}}',
                  matchScore.criteria.length.toString()
                )}
              </p>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default MatchPreview;
--- End of Content for MatchPreview.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\NewSuggestionForm_contents.txt
--------------------------------------------------------------------------------
Content:
################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm
# Generated on: 2025-08-18 14:36:43
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\CandidateSelector.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/CandidateSelector.tsx

import React, { useState, useCallback, KeyboardEvent } from 'react';
import {
  Search,
  AlertTriangle,
  Clock,
  User,
  Crown,
  Star,
  Heart,
  Sparkles,
  MapPin,
  Award,
  Zap,
  Shield,
} from 'lucide-react';
import { Input } from '@/components/ui/input';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandList,
} from '@/components/ui/command';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import {
  calculateAge,
  cn,
  getRelativeCloudinaryPath,
  getInitials,
} from '@/lib/utils';
import type { Candidate } from '../../new/types/candidates';
import { toast } from 'sonner';

interface CandidateSelectorProps {
  value: Candidate | null;
  onChange: (candidate: Candidate | null) => void;
  otherParty?: Candidate | null;
  label: string;
  candidates: Candidate[];
  className?: string;
  fieldName: string;
  error?: string;
}

const EnhancedCandidateCard: React.FC<{
  candidate: Candidate;
  onClick: () => void;
  isActive: boolean;
  isBlocked: boolean;
}> = ({ candidate, onClick, isActive, isBlocked }) => {
  const age = calculateAge(new Date(candidate.profile.birthDate));
  const mainImage = candidate.images.find((img) => img.isMain)?.url;

  const getStatusInfo = () => {
    if (isBlocked) {
      return {
        icon: Shield,
        label: 'חסום',
        className:
          'bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse',
        description: `בהצעה פעילה עם ${candidate.suggestionStatus?.withCandidateName}`,
      };
    }

    if (candidate.suggestionStatus?.status === 'PENDING') {
      return {
        icon: Clock,
        label: 'ממתין',
        className: 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white',
        description: `הצעה ממתינה עם ${candidate.suggestionStatus.withCandidateName}`,
      };
    }

    return {
      icon: Star,
      label: 'זמין',
      className: 'bg-gradient-to-r from-green-500 to-emerald-500 text-white',
      description: 'זמין להצעה חדשה',
    };
  };

  const statusInfo = getStatusInfo();
  const StatusIcon = statusInfo.icon;

  return (
    <div
      className={cn(
        'group relative overflow-hidden rounded-2xl transition-all duration-300 cursor-pointer',
        'bg-gradient-to-br from-white via-gray-50/30 to-white border-2 shadow-lg hover:shadow-2xl',
        isActive && 'ring-4 ring-purple-500 ring-opacity-50 border-purple-300',
        isBlocked && 'opacity-60 cursor-not-allowed',
        !isBlocked && 'hover:scale-105 hover:border-purple-300'
      )}
      onClick={!isBlocked ? onClick : undefined}
    >
      {/* Background decorative elements */}
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div className="absolute bottom-0 left-0 w-16 h-16 bg-gradient-to-br from-cyan-200/20 to-blue-200/20 rounded-full blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      </div>

      <div className="relative z-10 p-4 space-y-4">
        {/* Header with status */}
        <div className="flex items-center justify-between">
          <Badge className={cn('shadow-lg font-bold', statusInfo.className)}>
            <StatusIcon className="w-3 h-3 ml-1" />
            {statusInfo.label}
          </Badge>

          {candidate.profile.religiousLevel && (
            <Badge className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
              <Crown className="w-3 h-3 ml-1" />
              {candidate.profile.religiousLevel}
            </Badge>
          )}
        </div>

        {/* Profile section */}
        <div className="flex items-center gap-4">
          <div className="relative">
            <Avatar className="w-16 h-16 border-4 border-white shadow-xl ring-2 ring-purple-200 group-hover:ring-purple-400 transition-all duration-300">
              {mainImage ? (
                <AvatarImage
                  src={getRelativeCloudinaryPath(mainImage)}
                  alt={`${candidate.firstName} ${candidate.lastName}`}
                  className="object-cover"
                />
              ) : (
                <AvatarFallback className="bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold text-lg">
                  {getInitials(`${candidate.firstName} ${candidate.lastName}`)}
                </AvatarFallback>
              )}
            </Avatar>

            {/* Online indicator */}
            <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-r from-green-400 to-emerald-400 border-2 border-white rounded-full shadow-lg animate-pulse"></div>
          </div>

          <div className="flex-1 min-w-0">
            <h3 className="text-lg font-bold text-gray-800 truncate group-hover:text-purple-700 transition-colors">
              {candidate.firstName} {candidate.lastName}
            </h3>

            <div className="flex items-center gap-2 mt-1">
              <div className="flex items-center gap-1 text-sm text-gray-600">
                <User className="w-4 h-4 text-blue-500" />
                <span className="font-medium">{age} שנים</span>
              </div>

              {candidate.profile.city && (
                <div className="flex items-center gap-1 text-sm text-gray-600">
                  <MapPin className="w-4 h-4 text-green-500" />
                  <span className="truncate">{candidate.profile.city}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Details grid */}
        <div className="grid grid-cols-2 gap-3">
          {candidate.profile.occupation && (
            <div className="flex items-center gap-2 p-2 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-100 shadow-sm">
              <Award className="w-4 h-4 text-blue-500 flex-shrink-0" />
              <span className="text-sm font-medium text-blue-700 truncate">
                {candidate.profile.occupation}
              </span>
            </div>
          )}

          {candidate.profile.education && (
            <div className="flex items-center gap-2 p-2 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-100 shadow-sm">
              <Sparkles className="w-4 h-4 text-purple-500 flex-shrink-0" />
              <span className="text-sm font-medium text-purple-700 truncate">
                {candidate.profile.education}
              </span>
            </div>
          )}
        </div>

        {/* Status description */}
        {isBlocked && (
          <div className="p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border border-red-200">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-red-700">
                <p className="font-medium">לא ניתן לבחור</p>
                <p className="text-xs">{statusInfo.description}</p>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Hover overlay */}
      <div className="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
    </div>
  );
};

const CandidateSelector: React.FC<CandidateSelectorProps> = ({
  value,
  onChange,
  otherParty,
  label,
  candidates,
  className,
  error,
}) => {
  const [open, setOpen] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [activeIndex, setActiveIndex] = useState(-1);

  const filteredCandidates = candidates.filter((candidate) => {
    if (otherParty && candidate.id === otherParty.id) return false;

    if (inputValue) {
      const searchTerm = inputValue.toLowerCase();
      return (
        candidate.firstName.toLowerCase().includes(searchTerm) ||
        candidate.lastName.toLowerCase().includes(searchTerm) ||
        candidate.profile.city?.toLowerCase().includes(searchTerm) ||
        candidate.profile.occupation?.toLowerCase().includes(searchTerm)
      );
    }
    return true;
  });

  const formatCandidateDisplay = useCallback((candidate: Candidate) => {
    const age = calculateAge(new Date(candidate.profile.birthDate));
    return `${candidate.firstName} ${candidate.lastName}, ${age}${
      candidate.profile.city ? `, ${candidate.profile.city}` : ''
    }`;
  }, []);

  const handleSelect = useCallback(
    (candidate: Candidate) => {
      if (candidate.suggestionStatus?.status === 'BLOCKED') {
        toast.error('לא ניתן לבחור מועמד זה', {
          description: `${candidate.firstName} ${candidate.lastName} כבר נמצא/ת בהצעה פעילה עם ${candidate.suggestionStatus.withCandidateName}.`,
        });
        return;
      }

      onChange(candidate);
      setOpen(false);
      setInputValue('');
      setActiveIndex(-1);
    },
    [onChange]
  );

  const handleKeyDown = (e: KeyboardEvent) => {
    if (!open) return;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setActiveIndex((prev) =>
          prev < filteredCandidates.length - 1 ? prev + 1 : prev
        );
        break;
      case 'ArrowUp':
        e.preventDefault();
        setActiveIndex((prev) => (prev > 0 ? prev - 1 : prev));
        break;
      case 'Enter':
        e.preventDefault();
        if (activeIndex >= 0 && activeIndex < filteredCandidates.length) {
          handleSelect(filteredCandidates[activeIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        setOpen(false);
        setActiveIndex(-1);
        break;
    }
  };

  return (
    <div className={className}>
      <div className="space-y-3">
        {/* Enhanced Label */}
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
            <User className="w-5 h-5" />
          </div>
          <label className="text-lg font-bold text-gray-800">{label}</label>
        </div>

        {/* Enhanced Search Input */}
        <Popover open={open} onOpenChange={setOpen}>
          <PopoverTrigger asChild>
            <div className="relative group">
              <div className="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-2xl blur opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              <div className="relative">
                <Search className="absolute right-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-purple-400 group-hover:text-purple-600 transition-colors" />
                <Input
                  value={value ? formatCandidateDisplay(value) : inputValue}
                  onChange={(e) => {
                    setInputValue(e.target.value);
                    if (!open) setOpen(true);
                    setActiveIndex(-1);
                  }}
                  onKeyDown={handleKeyDown}
                  onClick={() => !open && setOpen(true)}
                  placeholder="חפש/י מועמד/ת..."
                  className={cn(
                    'h-14 pr-14 text-right text-lg border-2 transition-all duration-300 rounded-2xl shadow-lg',
                    'bg-white/80 backdrop-blur-sm',
                    'border-purple-200 hover:border-purple-300 focus:border-purple-500 focus:ring-purple-200',
                    'placeholder:text-gray-400',
                    error &&
                      'border-red-300 focus:border-red-500 focus:ring-red-200'
                  )}
                  role="combobox"
                  aria-expanded={open}
                  aria-controls="candidate-listbox"
                  aria-activedescendant={
                    activeIndex >= 0
                      ? `candidate-${filteredCandidates[activeIndex]?.id}`
                      : undefined
                  }
                />
                <div className="absolute left-4 top-1/2 transform -translate-y-1/2">
                  <Sparkles className="h-4 w-4 text-purple-400" />
                </div>
              </div>
            </div>
          </PopoverTrigger>

          <PopoverContent
            className="p-0 w-[500px] border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm"
            align="start"
            side="bottom"
            sideOffset={8}
          >
            <Command shouldFilter={false}>
              <div className="relative">
                <CommandInput
                  placeholder="חיפוש מועמדים..."
                  value={inputValue}
                  onValueChange={setInputValue}
                  className="h-12 border-0 text-right text-lg bg-gradient-to-r from-purple-50 to-pink-50"
                />
                <div className="absolute right-4 top-1/2 transform -translate-y-1/2">
                  <Search className="h-4 w-4 text-purple-400" />
                </div>
              </div>

              <CommandList
                className="max-h-[400px] overflow-auto p-2"
                id="candidate-listbox"
                role="listbox"
              >
                <CommandEmpty>
                  <div className="text-center p-8">
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4">
                      <Search className="w-8 h-8 text-gray-400" />
                    </div>
                    <h3 className="text-lg font-bold text-gray-800 mb-2">
                      לא נמצאו תוצאות
                    </h3>
                    <p className="text-gray-600">נסה לשנות את מונחי החיפוש</p>
                  </div>
                </CommandEmpty>

                <CommandGroup>
                  <div className="grid gap-3">
                    {filteredCandidates.map((candidate, index) => {
                      const isBlocked =
                        candidate.suggestionStatus?.status === 'BLOCKED';
                      return (
                        <EnhancedCandidateCard
                          key={candidate.id}
                          candidate={candidate}
                          onClick={() => handleSelect(candidate)}
                          isActive={index === activeIndex}
                          isBlocked={isBlocked}
                        />
                      );
                    })}
                  </div>
                </CommandGroup>
              </CommandList>
            </Command>
          </PopoverContent>
        </Popover>

        {error && (
          <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
            <AlertTriangle className="w-4 h-4 text-red-500" />
            <p className="text-sm text-red-600 font-medium">{error}</p>
          </div>
        )}
      </div>

      {/* Selected Candidate Display */}
      {value && (
        <Card className="mt-4 border-0 shadow-xl bg-gradient-to-br from-white via-purple-50/30 to-pink-50/30 rounded-2xl overflow-hidden">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
                  <Heart className="w-5 h-5" />
                </div>
                <h4 className="text-lg font-bold text-gray-800">
                  מועמד/ת נבחר/ת
                </h4>
              </div>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => onChange(null)}
                className="text-red-600 hover:text-red-700 hover:bg-red-50 rounded-xl transition-all duration-300"
              >
                <Zap className="w-4 h-4 ml-1" />
                הסר בחירה
              </Button>
            </div>

            <EnhancedCandidateCard
              candidate={value}
              onClick={() => {}}
              isActive={true}
              isBlocked={false}
            />

            <div className="flex gap-3 mt-4">
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  /* Implement view profile handler */
                }}
                className="flex-1 border-2 border-purple-200 text-purple-600 hover:bg-purple-50 rounded-xl transition-all duration-300"
              >
                <User className="w-4 h-4 ml-2" />
                צפה בפרופיל מלא
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default CandidateSelector;
--- End of Content for CandidateSelector.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\MatchPreview.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/MatchPreview.tsx

import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  CheckCircle,
  AlertCircle,
  XCircle,
  Heart,
  Star,
  Sparkles,
  TrendingUp,
  Award,
  Crown,
  Gem,
  Zap,
  Target,
  Trophy,
  Flame,
  Gift,
} from 'lucide-react';
import { calculateMatchScore } from '../utils/matchingAlgorithm';
import type { Candidate } from '../../new/types/candidates';
import type { MatchScore } from '../utils/matchingAlgorithm';
import { cn } from '@/lib/utils';

interface MatchPreviewProps {
  firstParty: Candidate;
  secondParty: Candidate;
  className?: string;
}

const MatchCriteriaCard: React.FC<{
  criterion: {
    name: string;
    score: number;
    reason?: string;
  };
  index: number;
}> = ({ criterion, index }) => {
  const getCriterionInfo = (name: string) => {
    switch (name) {
      case 'age':
        return {
          icon: Target,
          label: 'גיל',
          color: 'from-blue-500 to-cyan-500',
          bgColor: 'from-blue-50 to-cyan-50',
        };
      case 'location':
        return {
          icon: Crown,
          label: 'מיקום',
          color: 'from-green-500 to-emerald-500',
          bgColor: 'from-green-50 to-emerald-50',
        };
      case 'religious':
        return {
          icon: Sparkles,
          label: 'רמה דתית',
          color: 'from-purple-500 to-pink-500',
          bgColor: 'from-purple-50 to-pink-50',
        };
      default:
        return {
          icon: Star,
          label: name,
          color: 'from-gray-500 to-slate-500',
          bgColor: 'from-gray-50 to-slate-50',
        };
    }
  };

  const info = getCriterionInfo(criterion.name);
  const IconComponent = info.icon;
  const scorePercentage = Math.round(criterion.score * 100);

  const getScoreCategory = (score: number) => {
    if (score >= 0.9)
      return {
        label: 'מושלם',
        color: 'text-emerald-600',
        bgColor: 'bg-emerald-100',
      };
    if (score >= 0.8)
      return {
        label: 'מצוין',
        color: 'text-green-600',
        bgColor: 'bg-green-100',
      };
    if (score >= 0.7)
      return { label: 'טוב', color: 'text-blue-600', bgColor: 'bg-blue-100' };
    if (score >= 0.5)
      return {
        label: 'בינוני',
        color: 'text-yellow-600',
        bgColor: 'bg-yellow-100',
      };
    return { label: 'נמוך', color: 'text-red-600', bgColor: 'bg-red-100' };
  };

  const scoreCategory = getScoreCategory(criterion.score);

  return (
    <div
      className={cn(
        'relative overflow-hidden rounded-2xl transition-all duration-500 group hover:scale-105',
        'bg-gradient-to-br',
        info.bgColor,
        'border border-white/50 shadow-lg hover:shadow-2xl'
      )}
      style={{
        animationDelay: `${index * 150}ms`,
        animationFillMode: 'both',
      }}
    >
      {/* Background decoration */}
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-white/30 to-transparent rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
        <div className="absolute bottom-0 left-0 w-12 h-12 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      </div>

      <div className="relative z-10 p-6 space-y-4">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div
              className={cn(
                'p-3 rounded-full shadow-lg group-hover:scale-110 transition-transform bg-gradient-to-r text-white',
                info.color
              )}
            >
              <IconComponent className="w-5 h-5" />
            </div>
            <h4 className="text-lg font-bold text-gray-800">{info.label}</h4>
          </div>

          <Badge
            className={cn(
              'px-3 py-1 font-bold shadow-lg',
              scoreCategory.bgColor,
              scoreCategory.color
            )}
          >
            {scoreCategory.label}
          </Badge>
        </div>

        {/* Score visualization */}
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-600">התאמה</span>
            <span className="text-2xl font-bold text-gray-800">
              {scorePercentage}%
            </span>
          </div>

          <div className="relative">
            <Progress
              value={scorePercentage}
              className="h-3 bg-white/50 shadow-inner"
            />
            <div className="absolute inset-0 rounded-full bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          </div>
        </div>

        {/* Reason */}
        {criterion.reason && (
          <div className="p-3 bg-white/60 backdrop-blur-sm rounded-xl border border-white/50 shadow-inner">
            <p className="text-sm text-gray-700 leading-relaxed font-medium">
              {criterion.reason}
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

const MatchPreview: React.FC<MatchPreviewProps> = ({
  firstParty,
  secondParty,
  className,
}) => {
  // Calculate match score using the existing algorithm
  const matchScore: MatchScore | null = calculateMatchScore(
    firstParty.profile,
    secondParty.profile
  );

  if (!matchScore) {
    return (
      <Card
        className={cn(
          'border-0 shadow-xl rounded-3xl overflow-hidden',
          className
        )}
      >
        <CardContent className="p-8">
          <div className="text-center space-y-6">
            <div className="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-100 to-amber-100 flex items-center justify-center mx-auto shadow-xl">
              <AlertCircle className="w-12 h-12 text-yellow-500" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                לא ניתן לחשב התאמה
              </h3>
              <p className="text-gray-600">
                חסרים נתונים חיוניים לחישוב ההתאמה
              </p>
            </div>
            <div className="p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-2xl border border-yellow-200">
              <p className="text-sm text-yellow-800 font-medium">
                אנא ודא שלשני המועמדים יש פרופיל מלא עם תאריך לידה, עיר מגורים
                ורמה דתית
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  // Determine match quality with enhanced categories
  const getMatchQuality = (score: number) => {
    if (score >= 95)
      return {
        icon: Crown,
        color: 'text-purple-600',
        bgGradient: 'from-purple-500 to-pink-500',
        bgColor: 'from-purple-50 to-pink-50',
        text: 'התאמה מושלמת',
        description: 'זוג אידיאלי עם התאמה יוצאת דופן!',
        animation: 'animate-pulse',
      };
    if (score >= 85)
      return {
        icon: Gem,
        color: 'text-emerald-600',
        bgGradient: 'from-emerald-500 to-green-500',
        bgColor: 'from-emerald-50 to-green-50',
        text: 'התאמה מעולה',
        description: 'זוג עם פוטנציאל גבוה להצלחה',
        animation: '',
      };
    if (score >= 75)
      return {
        icon: Trophy,
        color: 'text-blue-600',
        bgGradient: 'from-blue-500 to-cyan-500',
        bgColor: 'from-blue-50 to-cyan-50',
        text: 'התאמה טובה',
        description: 'התאמה איכותית עם סיכויים טובים',
        animation: '',
      };
    if (score >= 60)
      return {
        icon: Star,
        color: 'text-yellow-600',
        bgGradient: 'from-yellow-500 to-amber-500',
        bgColor: 'from-yellow-50 to-amber-50',
        text: 'התאמה בינונית',
        description: 'יש פוטנציאל, שווה לבדוק',
        animation: '',
      };
    return {
      icon: AlertCircle,
      color: 'text-red-600',
      bgGradient: 'from-red-500 to-pink-500',
      bgColor: 'from-red-50 to-pink-50',
      text: 'התאמה נמוכה',
      description: 'התאמה מוגבלת, יש לשקול בזהירות',
      animation: '',
    };
  };

  const quality = getMatchQuality(matchScore.score);
  const Icon = quality.icon;

  return (
    <Card
      className={cn(
        'border-0 shadow-2xl rounded-3xl overflow-hidden transition-all duration-500 hover:shadow-3xl',
        'bg-gradient-to-br',
        quality.bgColor,
        className
      )}
    >
      {/* Animated background */}
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-3xl animate-float"></div>
        <div
          className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-white/10 to-transparent rounded-full blur-2xl animate-float"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-gradient-to-br from-white/5 to-transparent rounded-full blur-3xl animate-float"
          style={{ animationDelay: '4s' }}
        ></div>
      </div>

      <CardContent className="relative z-10 p-8 space-y-8">
        {/* Header Section */}
        <div className="text-center space-y-6">
          <div className="flex items-center justify-center">
            <div
              className={cn(
                'p-6 rounded-full shadow-2xl bg-gradient-to-r text-white transform hover:scale-110 transition-transform duration-300',
                quality.bgGradient,
                quality.animation
              )}
            >
              <Icon className="w-12 h-12" />
            </div>
          </div>

          <div className="space-y-2">
            <h2 className="text-3xl font-bold text-gray-800">{quality.text}</h2>
            <p className="text-lg text-gray-600 leading-relaxed">
              {quality.description}
            </p>
          </div>

          {/* Score display */}
          <div className="relative">
            <div className="flex items-center justify-center gap-4 mb-4">
              <div className="text-center">
                <div className="text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                  {Math.round(matchScore.score)}%
                </div>
                <p className="text-sm font-medium text-gray-600 mt-1">
                  ציון התאמה כללי
                </p>
              </div>
            </div>

            {/* Progress Ring */}
            <div className="relative w-32 h-32 mx-auto">
              <svg
                className="w-32 h-32 transform -rotate-90"
                viewBox="0 0 100 100"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke="currentColor"
                  strokeWidth="8"
                  fill="transparent"
                  className="text-gray-200"
                />
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke="url(#gradient)"
                  strokeWidth="8"
                  fill="transparent"
                  strokeDasharray={`${2 * Math.PI * 40}`}
                  strokeDashoffset={`${2 * Math.PI * 40 * (1 - matchScore.score / 100)}`}
                  className="transition-all duration-1000 ease-out"
                  strokeLinecap="round"
                />
                <defs>
                  <linearGradient
                    id="gradient"
                    x1="0%"
                    y1="0%"
                    x2="100%"
                    y2="0%"
                  >
                    <stop offset="0%" stopColor="#8B5CF6" />
                    <stop offset="50%" stopColor="#EC4899" />
                    <stop offset="100%" stopColor="#3B82F6" />
                  </linearGradient>
                </defs>
              </svg>
              <div className="absolute inset-0 flex items-center justify-center">
                <Sparkles className="w-8 h-8 text-purple-500 animate-pulse" />
              </div>
            </div>
          </div>
        </div>

        {/* Match Criteria Section */}
        <div className="space-y-6">
          <div className="text-center">
            <h3 className="text-2xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
              <TrendingUp className="w-6 h-6 text-purple-500" />
              פירוט קריטריונים
            </h3>
            <p className="text-gray-600">ניתוח מפורט של רמות ההתאמה השונות</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {matchScore.criteria.map((criterion, index) => (
              <div key={criterion.name} className="animate-fade-in-up">
                <MatchCriteriaCard criterion={criterion} index={index} />
              </div>
            ))}
          </div>
        </div>

        {/* Match Reasons Section */}
        {matchScore.reasons.length > 0 && (
          <div className="space-y-4">
            <div className="text-center">
              <h4 className="text-xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                <Heart className="w-5 h-5 text-red-500" />
                סיבות להתאמה
              </h4>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {matchScore.reasons.map((reason, index) => (
                <div
                  key={index}
                  className="flex items-start gap-3 p-4 bg-white/60 backdrop-blur-sm rounded-2xl border border-white/50 shadow-lg hover:shadow-xl transition-all duration-300 group"
                  style={{
                    animationDelay: `${(index + 3) * 150}ms`,
                    animationFillMode: 'both',
                  }}
                >
                  <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                    <Gift className="w-4 h-4" />
                  </div>
                  <p className="text-gray-700 leading-relaxed font-medium flex-1">
                    {reason}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Summary Card */}
        <div className="p-6 bg-white/70 backdrop-blur-sm rounded-2xl border border-white/50 shadow-xl">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                <Award className="w-6 h-6" />
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-800">סיכום התאמה</h4>
                <p className="text-gray-600">המלצה מבוססת ניתוח</p>
              </div>
            </div>

            <div className="text-right">
              <div className="flex items-center gap-2">
                {matchScore.score >= 80 ? (
                  <>
                    <Zap className="w-5 h-5 text-green-500" />
                    <span className="font-bold text-green-600">
                      מומלץ בחום!
                    </span>
                  </>
                ) : matchScore.score >= 60 ? (
                  <>
                    <Star className="w-5 h-5 text-blue-500" />
                    <span className="font-bold text-blue-600">שווה לנסות</span>
                  </>
                ) : (
                  <>
                    <AlertCircle className="w-5 h-5 text-yellow-500" />
                    <span className="font-bold text-yellow-600">
                      צריך שיקול
                    </span>
                  </>
                )}
              </div>
              <p className="text-sm text-gray-500 mt-1">
                מבוסס על {matchScore.criteria.length} קריטריונים
              </p>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default MatchPreview;
--- End of Content for MatchPreview.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\NewSuggestionForm_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\SuggestionDetails.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/SuggestionDetails.tsx

'use client';
import React, { useState } from 'react';
import { useFormContext } from 'react-hook-form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent } from '@/components/ui/card';
import { Priority } from '@prisma/client';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import {
  Loader2,
  Sparkles,
  AlertTriangle,
  Star,
  Flame,
  Target,
  Shield,
  Heart,
  MessageCircle,
  User,
  Calendar,
  Zap,
  Crown,
  Award,
  Gift,
  Clock,
  Wand2,
  Brain,
  Eye,
  Users,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import type { NewSuggestionFormData } from './schema';
import type { Candidate } from '../../new/types/candidates';
import { cn } from '@/lib/utils';

interface SuggestionDetailsProps {
  firstParty: Candidate;
  secondParty: Candidate;
}

const EnhancedSection: React.FC<{
  icon: React.ElementType;
  title: string;
  description?: string;
  gradient: string;
  children: React.ReactNode;
  className?: string;
}> = ({ icon: Icon, title, description, gradient, children, className }) => (
  <Card
    className={cn(
      'border-0 shadow-xl hover:shadow-2xl transition-all duration-500 group overflow-hidden rounded-3xl',
      'bg-gradient-to-br from-white via-gray-50/30 to-white',
      className
    )}
  >
    {/* Background decoration */}
    <div className="absolute inset-0">
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-cyan-200/20 to-blue-200/20 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-900"></div>
    </div>

    <CardContent className="relative z-10 p-8 space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <div
          className={cn(
            'p-4 rounded-2xl shadow-xl group-hover:scale-110 transition-transform duration-300 bg-gradient-to-r text-white',
            gradient
          )}
        >
          <Icon className="w-8 h-8" />
        </div>
        <div className="flex-1">
          <h3
            className="text-2xl font-bold text-gray-800 group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:bg-clip-text transition-all duration-300"
            style={{
              backgroundImage: `linear-gradient(to right, ${gradient.replace('from-', '').replace('to-', ', ')})`,
            }}
          >
            {title}
          </h3>
          {description && (
            <p className="text-gray-600 mt-1 leading-relaxed">{description}</p>
          )}
        </div>
      </div>

      {children}
    </CardContent>
  </Card>
);

const PriorityBadge: React.FC<{ priority: Priority }> = ({ priority }) => {
  const getPriorityInfo = (p: Priority) => {
    switch (p) {
      case Priority.URGENT:
        return {
          label: 'דחוף',
          icon: Flame,
          className:
            'bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse shadow-xl',
          description: 'דורש טיפול מיידי!',
        };
      case Priority.HIGH:
        return {
          label: 'גבוהה',
          icon: Star,
          className:
            'bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-xl',
          description: 'עדיפות גבוהה',
        };
      case Priority.MEDIUM:
        return {
          label: 'רגילה',
          icon: Target,
          className:
            'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-xl',
          description: 'עדיפות רגילה',
        };
      case Priority.LOW:
        return {
          label: 'נמוכה',
          icon: Shield,
          className:
            'bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-xl',
          description: 'עדיפות נמוכה',
        };
      default:
        return {
          label: 'רגילה',
          icon: Target,
          className:
            'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-xl',
          description: 'עדיפות רגילה',
        };
    }
  };

  const info = getPriorityInfo(priority);
  const IconComponent = info.icon;

  return (
    <div
      className={cn(
        'flex items-center gap-2 px-4 py-2 rounded-xl font-bold',
        info.className
      )}
    >
      <IconComponent className="w-4 h-4" />
      <span>{info.label}</span>
    </div>
  );
};

const SuggestionDetails: React.FC<SuggestionDetailsProps> = ({
  firstParty,
  secondParty,
}) => {
  const {
    register,
    formState: { errors },
    setValue,
    watch,
  } = useFormContext<NewSuggestionFormData>();
  const [isGeneratingRationale, setIsGeneratingRationale] = useState(false);

  const priority = watch('priority', Priority.MEDIUM);

  const handleGenerateRationale = async () => {
    setIsGeneratingRationale(true);
    toast.info('ה-AI מנסח את חבילת הנימוקים...', {
      description: 'זה יכול לקחת כמה שניות',
      duration: 3000,
    });

    try {
      const response = await fetch('/api/ai/generate-suggestion-rationale', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId1: firstParty.id,
          userId2: secondParty.id,
        }),
      });

      const data = await response.json();

      if (!response.ok || !data.success || !data.rationales) {
        throw new Error(data.error || 'שגיאה ביצור הנימוקים');
      }

      const { generalRationale, rationaleForParty1, rationaleForParty2 } =
        data.rationales;

      setValue('matchingReason', generalRationale, {
        shouldValidate: true,
        shouldDirty: true,
      });
      setValue('firstPartyNotes', rationaleForParty1, {
        shouldValidate: true,
        shouldDirty: true,
      });
      setValue('secondPartyNotes', rationaleForParty2, {
        shouldValidate: true,
        shouldDirty: true,
      });

      toast.success('הנימוקים נוצרו בהצלחה!', {
        description: 'כל השדות מולאו באופן אוטומטי עם תוכן מותאם אישית',
        duration: 5000,
      });
    } catch (error) {
      console.error('Failed to generate rationales:', error);
      toast.error(error instanceof Error ? error.message : 'שגיאה לא צפויה', {
        description: 'נסה שוב או מלא את השדות ידנית',
      });
    } finally {
      setIsGeneratingRationale(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Priority Section */}
      <EnhancedSection
        icon={Crown}
        title="עדיפות ההצעה"
        description="קבע את רמת החשיבות והדחיפות של ההצעה"
        gradient="from-purple-500 to-pink-500"
      >
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <Label className="text-lg font-semibold text-gray-700">
              בחר רמת עדיפות
            </Label>
            <PriorityBadge priority={priority} />
          </div>

          <Select
            onValueChange={(value: Priority) =>
              setValue('priority', value, { shouldValidate: true })
            }
            defaultValue={priority}
            name="priority"
          >
            <SelectTrigger className="h-14 border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg">
              <SelectValue placeholder="בחר/י עדיפות" />
            </SelectTrigger>
            <SelectContent className="border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
              <SelectItem value={Priority.URGENT}>
                <div className="flex items-center gap-3 py-2">
                  <Flame className="w-5 h-5 text-red-500" />
                  <div>
                    <div className="font-bold text-red-600">דחופה</div>
                    <div className="text-xs text-red-500">דורש טיפול מיידי</div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.HIGH}>
                <div className="flex items-center gap-3 py-2">
                  <Star className="w-5 h-5 text-orange-500" />
                  <div>
                    <div className="font-bold text-orange-600">גבוהה</div>
                    <div className="text-xs text-orange-500">עדיפות מוגברת</div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.MEDIUM}>
                <div className="flex items-center gap-3 py-2">
                  <Target className="w-5 h-5 text-blue-500" />
                  <div>
                    <div className="font-bold text-blue-600">רגילה</div>
                    <div className="text-xs text-blue-500">עדיפות סטנדרטית</div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.LOW}>
                <div className="flex items-center gap-3 py-2">
                  <Shield className="w-5 h-5 text-gray-500" />
                  <div>
                    <div className="font-bold text-gray-600">נמוכה</div>
                    <div className="text-xs text-gray-500">ללא דחיפות</div>
                  </div>
                </div>
              </SelectItem>
            </SelectContent>
          </Select>

          {errors.priority && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.priority.message}
              </p>
            </div>
          )}
        </div>
      </EnhancedSection>

      {/* AI-Generated Matching Reason */}
      <EnhancedSection
        icon={Brain}
        title="סיבת ההתאמה הכללית"
        description="נימוק מפורט המסביר מדוע יש התאמה בין הצדדים"
        gradient="from-emerald-500 to-green-500"
      >
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <Label className="text-lg font-semibold text-gray-700">
              תוכן יוצג לצדדים
            </Label>
            <Button
              type="button"
              onClick={handleGenerateRationale}
              disabled={isGeneratingRationale}
              className="bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl px-6 py-3 font-bold"
            >
              {isGeneratingRationale ? (
                <>
                  <Loader2 className="w-5 h-5 ml-2 animate-spin" />
                  <span>מנסח...</span>
                </>
              ) : (
                <>
                  <Wand2 className="w-5 h-5 ml-2 text-yellow-300" />
                  <span>צור נימוקים (AI)</span>
                </>
              )}
            </Button>
          </div>

          <Textarea
            id="matchingReason"
            {...register('matchingReason')}
            placeholder="נימוק כללי המסביר מדוע יש התאמה בין הצדדים..."
            className="min-h-[140px] border-2 border-emerald-200 hover:border-emerald-300 focus:border-emerald-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
          />

          {errors.matchingReason && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.matchingReason.message}
              </p>
            </div>
          )}

          <Alert className="border-0 bg-gradient-to-r from-blue-50 to-cyan-50 shadow-lg rounded-2xl">
            <Sparkles className="h-5 w-5 text-blue-500" />
            <AlertDescription className="text-blue-800 font-medium leading-relaxed">
              💡 <strong>טיפ חכם:</strong> לחיצה על כפתור ה-AI תמלא אוטומטית את
              שדה זה וגם את שדות ההערות האישיות לכל צד עם תוכן מותאם ומקצועי.
            </AlertDescription>
          </Alert>
        </div>
      </EnhancedSection>

      {/* Personal Notes for Each Party */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* First Party Notes */}
        <EnhancedSection
          icon={User}
          title={`הערות אישיות ל${firstParty.firstName}`}
          description="טקסט אישי המדגיש את היתרונות של הצד השני עבורו"
          gradient="from-blue-500 to-cyan-500"
          className="lg:col-span-1"
        >
          <div className="space-y-4">
            <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-2xl border border-blue-100">
              <div className="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold shadow-lg">
                {firstParty.firstName[0]}
              </div>
              <div>
                <div className="font-bold text-blue-800">
                  {firstParty.firstName} {firstParty.lastName}
                </div>
                <div className="text-sm text-blue-600">צד א' בהצעה</div>
              </div>
            </div>

            <Textarea
              id="firstPartyNotes"
              {...register('firstPartyNotes')}
              placeholder={`טקסט אישי המדגיש את היתרונות של ${secondParty.firstName} עבור ${firstParty.firstName}...`}
              className="min-h-[160px] border-2 border-blue-200 hover:border-blue-300 focus:border-blue-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
            />

            {errors.firstPartyNotes && (
              <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
                <AlertTriangle className="w-4 h-4 text-red-500" />
                <p className="text-sm text-red-600 font-medium">
                  {errors.firstPartyNotes.message}
                </p>
              </div>
            )}
          </div>
        </EnhancedSection>

        {/* Second Party Notes */}
        <EnhancedSection
          icon={User}
          title={`הערות אישיות ל${secondParty.firstName}`}
          description="טקסט אישי המדגיש את היתרונות של הצד השני עבורה"
          gradient="from-purple-500 to-pink-500"
          className="lg:col-span-1"
        >
          <div className="space-y-4">
            <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-100">
              <div className="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold shadow-lg">
                {secondParty.firstName[0]}
              </div>
              <div>
                <div className="font-bold text-purple-800">
                  {secondParty.firstName} {secondParty.lastName}
                </div>
                <div className="text-sm text-purple-600">צד ב' בהצעה</div>
              </div>
            </div>

            <Textarea
              id="secondPartyNotes"
              {...register('secondPartyNotes')}
              placeholder={`טקסט אישי המדגיש את היתרונות של ${firstParty.firstName} עבור ${secondParty.firstName}...`}
              className="min-h-[160px] border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
            />

            {errors.secondPartyNotes && (
              <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
                <AlertTriangle className="w-4 h-4 text-red-500" />
                <p className="text-sm text-red-600 font-medium">
                  {errors.secondPartyNotes.message}
                </p>
              </div>
            )}
          </div>
        </EnhancedSection>
      </div>

      {/* Internal Notes */}
      <EnhancedSection
        icon={MessageCircle}
        title="הערות פנימיות"
        description="הערות והנחיות לשימוש צוות השדכנים בלבד"
        gradient="from-amber-500 to-orange-500"
      >
        <div className="space-y-4">
          <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl border border-amber-100">
            <div className="p-3 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg">
              <Eye className="w-5 h-5" />
            </div>
            <div>
              <div className="font-bold text-amber-800">מידע סודי</div>
              <div className="text-sm text-amber-600">
                נראה רק לצוות השדכנים
              </div>
            </div>
          </div>

          <Textarea
            id="internalNotes"
            {...register('internalNotes')}
            placeholder="הערות והנחיות לשימוש פנימי בלבד..."
            className="min-h-[120px] border-2 border-amber-200 hover:border-amber-300 focus:border-amber-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
          />

          {errors.internalNotes && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.internalNotes.message}
              </p>
            </div>
          )}
        </div>
      </EnhancedSection>

      {/* Decision Deadline */}
      <EnhancedSection
        icon={Clock}
        title="תאריך יעד להחלטה"
        description="קבע את המועד האחרון למתן תגובה מהצדדים"
        gradient="from-indigo-500 to-purple-500"
      >
        <div className="space-y-4">
          <Label className="text-lg font-semibold text-gray-700">
            בחר תקופת זמן למענה
          </Label>

          <Select
            onValueChange={(value) => {
              const days = parseInt(value, 10);
              const deadline = new Date();
              deadline.setDate(deadline.getDate() + days);
              setValue('decisionDeadline', deadline, { shouldValidate: true });
            }}
            defaultValue="14"
          >
            <SelectTrigger className="h-14 border-2 border-indigo-200 hover:border-indigo-300 focus:border-indigo-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg">
              <SelectValue />
            </SelectTrigger>
            <SelectContent className="border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
              <SelectItem value="3">
                <div className="flex items-center gap-3 py-2">
                  <Zap className="w-5 h-5 text-red-500" />
                  <div>
                    <div className="font-bold text-red-600">3 ימים</div>
                    <div className="text-xs text-red-500">מהיר וזריז</div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="7">
                <div className="flex items-center gap-3 py-2">
                  <Award className="w-5 h-5 text-orange-500" />
                  <div>
                    <div className="font-bold text-orange-600">7 ימים</div>
                    <div className="text-xs text-orange-500">תקופה קצרה</div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="14">
                <div className="flex items-center gap-3 py-2">
                  <Target className="w-5 h-5 text-blue-500" />
                  <div>
                    <div className="font-bold text-blue-600">14 ימים</div>
                    <div className="text-xs text-blue-500">
                      תקופה סטנדרטית (מומלץ)
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="30">
                <div className="flex items-center gap-3 py-2">
                  <Shield className="w-5 h-5 text-green-500" />
                  <div>
                    <div className="font-bold text-green-600">30 ימים</div>
                    <div className="text-xs text-green-500">תקופה מורחבת</div>
                  </div>
                </div>
              </SelectItem>
            </SelectContent>
          </Select>

          {errors.decisionDeadline && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.decisionDeadline.message}
              </p>
            </div>
          )}

          <div className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl border border-indigo-100">
            <div className="flex items-start gap-3">
              <Calendar className="w-5 h-5 text-indigo-500 mt-1" />
              <div>
                <div className="font-bold text-indigo-800 mb-1">מידע חשוב</div>
                <p className="text-sm text-indigo-700 leading-relaxed">
                  לאחר תקופת הזמן שנבחרה, אם לא התקבלה תגובה מאחד הצדדים, ההצעה
                  תועבר אוטומטית לסטטוס "פג תוקף".
                </p>
              </div>
            </div>
          </div>
        </div>
      </EnhancedSection>

      {/* Summary Card */}
      <Card className="border-0 shadow-2xl bg-gradient-to-br from-gray-50 via-white to-gray-50 rounded-3xl overflow-hidden">
        <CardContent className="p-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-4 rounded-2xl bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-xl">
                <Users className="w-8 h-8" />
              </div>
              <div>
                <h3 className="text-2xl font-bold text-gray-800">
                  סיכום ההצעה
                </h3>
                <p className="text-gray-600 leading-relaxed">
                  כל הפרטים מוכנים ליצירת ההצעה
                </p>
              </div>
            </div>

            <div className="text-center">
              <div className="flex items-center gap-2 mb-2">
                <Gift className="w-5 h-5 text-purple-500" />
                <span className="font-bold text-purple-600">מוכן ליצירה!</span>
              </div>
              <p className="text-sm text-gray-500">
                לאחר יצירת ההצעה, היא תישלח אוטומטי לצד הראשון
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default SuggestionDetails;
--- End of Content for SuggestionDetails.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\index.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/index.tsx

'use client';
import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { useForm, FormProvider } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import { Separator } from '@/components/ui/separator';
import {
  UserPlus,
  Sparkles,
  Loader2,
  BarChart2,
  CheckCircle,
  Users,
  Heart,
  Crown,
  Zap,
  Star,
  Award,
  Gem,
  Target,
  ArrowRight,
  ArrowLeft,
  Eye,
  X,
  Wand2,
  Gift,
} from 'lucide-react';

// Types
import type { Candidate } from '../../new/types/candidates';
import { newSuggestionSchema, type NewSuggestionFormData } from './schema';

// Components
import SuggestionDetails from './SuggestionDetails';
import MatchPreview from './MatchPreview';
import CandidateSelector from './CandidateSelector';
import { AiMatchAnalysisDialog } from '../../new/dialogs/AiMatchAnalysisDialog';
import { cn } from '@/lib/utils';

interface NewSuggestionFormProps {
  isOpen: boolean;
  onClose: () => void;
  candidates: Candidate[];
  selectedCandidate?: Candidate | null;
  onSubmit: (data: NewSuggestionFormData) => Promise<void>;
}

const StepIndicator: React.FC<{
  currentStep: number;
  totalSteps: number;
  steps: Array<{ label: string; icon: React.ElementType; description: string }>;
}> = ({ currentStep, totalSteps, steps }) => (
  <div className="flex items-center justify-center mb-8">
    <div className="flex items-center gap-4">
      {steps.map((step, index) => {
        const isActive = index === currentStep;
        const isCompleted = index < currentStep;
        const StepIcon = step.icon;

        return (
          <React.Fragment key={index}>
            <div className="flex flex-col items-center">
              <div
                className={cn(
                  'flex items-center justify-center w-16 h-16 rounded-full transition-all duration-500 shadow-lg',
                  isActive &&
                    'bg-gradient-to-r from-purple-600 to-pink-600 text-white scale-110 shadow-2xl',
                  isCompleted &&
                    'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-xl',
                  !isActive &&
                    !isCompleted &&
                    'bg-gray-100 text-gray-400 shadow-md'
                )}
              >
                <StepIcon className="w-8 h-8" />
              </div>
              <div className="mt-3 text-center">
                <div
                  className={cn(
                    'text-sm font-bold transition-colors',
                    isActive && 'text-purple-600',
                    isCompleted && 'text-green-600',
                    !isActive && !isCompleted && 'text-gray-400'
                  )}
                >
                  {step.label}
                </div>
                <div className="text-xs text-gray-500 mt-1 max-w-[120px]">
                  {step.description}
                </div>
              </div>
            </div>

            {index < totalSteps - 1 && (
              <div
                className={cn(
                  'w-16 h-1 rounded-full transition-all duration-500 mt-2',
                  index < currentStep
                    ? 'bg-gradient-to-r from-green-500 to-emerald-500'
                    : 'bg-gray-200'
                )}
              />
            )}
          </React.Fragment>
        );
      })}
    </div>
  </div>
);

const NewSuggestionForm: React.FC<NewSuggestionFormProps> = ({
  isOpen,
  onClose,
  candidates,
  selectedCandidate,
  onSubmit,
}) => {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [firstParty, setFirstParty] = useState<Candidate | null>(null);
  const [secondParty, setSecondParty] = useState<Candidate | null>(null);
  const [showAnalysisDialog, setShowAnalysisDialog] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);

  const steps = [
    {
      label: 'בחירת מועמדים',
      icon: Users,
      description: 'בחר את שני הצדדים להצעה',
    },
    {
      label: 'ניתוח התאמה',
      icon: BarChart2,
      description: 'בדוק את רמת ההתאמה',
    },
    {
      label: 'פרטי ההצעה',
      icon: Heart,
      description: 'הוסף נימוקים ופרטים',
    },
  ];

  const form = useForm<NewSuggestionFormData>({
    resolver: zodResolver(newSuggestionSchema),
    defaultValues: {
      priority: Priority.MEDIUM,
      status: MatchSuggestionStatus.DRAFT,
      decisionDeadline: new Date(new Date().setDate(new Date().getDate() + 14)),
    },
  });

  // Reset form and state when dialog opens or selectedCandidate changes
  useEffect(() => {
    if (isOpen) {
      form.reset({
        priority: Priority.MEDIUM,
        status: MatchSuggestionStatus.DRAFT,
        decisionDeadline: new Date(
          new Date().setDate(new Date().getDate() + 14)
        ),
        firstPartyId: selectedCandidate?.id || '',
        secondPartyId: '',
      });
      setFirstParty(selectedCandidate || null);
      setSecondParty(null);
      setCurrentStep(0);
    }
  }, [isOpen, selectedCandidate, form]);

  const handleCandidateSelect =
    (type: 'first' | 'second') => (candidate: Candidate | null) => {
      const setter = type === 'first' ? setFirstParty : setSecondParty;
      const fieldName = type === 'first' ? 'firstPartyId' : 'secondPartyId';
      setter(candidate);
      form.setValue(fieldName, candidate?.id || '', {
        shouldValidate: true,
        shouldDirty: true,
      });
    };

  const handleNext = () => {
    if (currentStep === 0 && (!firstParty || !secondParty)) {
      toast.error('יש לבחור את שני הצדדים להצעה.');
      return;
    }
    setCurrentStep((prev) => Math.min(prev + 1, steps.length - 1));
  };

  const handlePrevious = () => {
    setCurrentStep((prev) => Math.max(prev - 1, 0));
  };

  const handleSubmit = form.handleSubmit(async (data) => {
    if (!firstParty || !secondParty) {
      toast.error('יש לבחור את שני הצדדים להצעה.');
      return;
    }

    setIsSubmitting(true);
    try {
      await onSubmit(data);
      toast.success('ההצעה נוצרה בהצלחה!', {
        description: 'ההצעה נשלחה אוטומטית לצד הראשון',
        duration: 5000,
      });
      onClose();
    } catch (error) {
      toast.error(
        'שגיאה ביצירת ההצעה: ' +
          (error instanceof Error ? error.message : 'שגיאה לא ידועה')
      );
    } finally {
      setIsSubmitting(false);
    }
  });

  const maleCandidates = candidates.filter((c) => c.profile.gender === 'MALE');
  const femaleCandidates = candidates.filter(
    (c) => c.profile.gender === 'FEMALE'
  );

  const canProceedToNextStep = () => {
    switch (currentStep) {
      case 0:
        return firstParty && secondParty;
      case 1:
        return firstParty && secondParty;
      case 2:
        return true;
      default:
        return false;
    }
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <CandidateSelector
              label="צד א' (גבר)"
              value={firstParty}
              onChange={handleCandidateSelect('first')}
              candidates={maleCandidates}
              otherParty={secondParty}
              fieldName="firstPartyId"
              error={form.formState.errors.firstPartyId?.message}
            />

            <CandidateSelector
              label="צד ב' (אישה)"
              value={secondParty}
              onChange={handleCandidateSelect('second')}
              candidates={femaleCandidates}
              otherParty={firstParty}
              fieldName="secondPartyId"
              error={form.formState.errors.secondPartyId?.message}
            />
          </div>
        );

      case 1:
        if (!firstParty || !secondParty) {
          return (
            <div className="flex items-center justify-center h-64">
              <div className="text-center text-gray-500">
                <Users className="mx-auto h-16 w-16 text-gray-300 mb-4" />
                <p className="text-lg font-medium">
                  יש לבחור תחילה את שני המועמדים
                </p>
              </div>
            </div>
          );
        }

        return (
          <div className="space-y-8">
            <MatchPreview firstParty={firstParty} secondParty={secondParty} />

            <div className="flex justify-center">
              <Button
                type="button"
                variant="outline"
                onClick={() => setShowAnalysisDialog(true)}
                className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 text-indigo-700 hover:bg-gradient-to-r hover:from-indigo-100 hover:to-purple-100 hover:border-indigo-300 rounded-2xl px-8 py-4 font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300"
              >
                <BarChart2 className="w-6 h-6 ml-3" />
                ניתוח התאמה מלא (AI)
                <Sparkles className="w-5 h-5 mr-2 text-purple-500" />
              </Button>
            </div>
          </div>
        );

      case 2:
        if (!firstParty || !secondParty) {
          return (
            <div className="flex items-center justify-center h-64">
              <div className="text-center text-gray-500">
                <Users className="mx-auto h-16 w-16 text-gray-300 mb-4" />
                <p className="text-lg font-medium">
                  יש לבחור תחילה את שני המועמדים
                </p>
              </div>
            </div>
          );
        }

        return (
          <SuggestionDetails
            firstParty={firstParty}
            secondParty={secondParty}
          />
        );

      default:
        return null;
    }
  };

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent
          className="max-w-7xl w-full min-h-[90vh] flex flex-col p-0 border-0 shadow-2xl rounded-3xl overflow-hidden bg-gradient-to-br from-white via-purple-50/20 to-pink-50/20"
          dir="rtl"
        >
          {/* Enhanced Header */}
          <div className="relative bg-gradient-to-r from-purple-50 via-cyan-50/30 to-emerald-50/20 border-b border-purple-100/50 p-8 flex-shrink-0">
            {/* Background decoration */}
            <div className="absolute inset-0">
              <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-3xl"></div>
              <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-cyan-200/30 to-blue-200/30 rounded-full blur-2xl"></div>
            </div>

            <div className="relative z-10">
              <DialogHeader className="text-center mb-8">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-4">
                    <div className="p-4 rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl">
                      <UserPlus className="w-10 h-10" />
                    </div>
                    <div className="text-right">
                      <DialogTitle className="text-3xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                        יצירת הצעת שידוך חדשה
                      </DialogTitle>
                      <DialogDescription className="text-lg text-gray-600 mt-2">
                        בחר שני מועמדים, נתח את ההתאמה והגדר את פרטי ההצעה
                      </DialogDescription>
                    </div>
                  </div>

                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={onClose}
                    className="rounded-full h-12 w-12 text-gray-500 hover:text-gray-700 hover:bg-white/50 backdrop-blur-sm"
                  >
                    <X className="w-6 h-6" />
                  </Button>
                </div>

                <StepIndicator
                  currentStep={currentStep}
                  totalSteps={steps.length}
                  steps={steps}
                />
              </DialogHeader>
            </div>
          </div>

          {/* Content Area */}
          <div className="flex-1 overflow-y-auto p-8">
            <FormProvider {...form}>
              <form onSubmit={handleSubmit} className="h-full">
                <div className="animate-fade-in-up">{renderStepContent()}</div>
              </form>
            </FormProvider>
          </div>

          {/* Enhanced Footer */}
          <div className="border-t border-purple-100 bg-gradient-to-r from-gray-50 to-slate-50 p-6 flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                {currentStep > 0 && (
                  <Button
                    type="button"
                    variant="outline"
                    onClick={handlePrevious}
                    className="px-6 py-3 border-2 border-gray-300 hover:bg-gray-50 rounded-xl transition-all duration-300 font-bold"
                  >
                    <ArrowRight className="w-5 h-5 ml-2" />
                    חזור
                  </Button>
                )}

                {currentStep < steps.length - 1 ? (
                  <Button
                    type="button"
                    onClick={handleNext}
                    disabled={!canProceedToNextStep()}
                    className="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    המשך
                    <ArrowLeft className="w-5 h-5 mr-2" />
                  </Button>
                ) : (
                  <Button
                    type="submit"
                    onClick={handleSubmit}
                    disabled={isSubmitting || !firstParty || !secondParty}
                    className="px-8 py-3 bg-gradient-to-r from-emerald-600 via-green-600 to-emerald-600 hover:from-emerald-700 hover:via-green-700 hover:to-emerald-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isSubmitting ? (
                      <>
                        <Loader2 className="w-5 h-5 ml-2 animate-spin" />
                        יוצר הצעה...
                      </>
                    ) : (
                      <>
                        <Gift className="w-5 h-5 ml-2" />
                        צור הצעה
                        <Sparkles className="w-4 h-4 mr-2" />
                      </>
                    )}
                  </Button>
                )}
              </div>

              <div className="text-sm text-gray-500 space-y-1">
                <div className="flex items-center gap-2">
                  <Crown className="w-4 h-4 text-purple-500" />
                  <span>
                    שלב {currentStep + 1} מתוך {steps.length}
                  </span>
                </div>
                <p className="text-xs">
                  לאחר יצירת ההצעה, היא תופיע בסטטוס טיוטה.
                </p>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {firstParty && secondParty && (
        <AiMatchAnalysisDialog
          isOpen={showAnalysisDialog}
          onClose={() => setShowAnalysisDialog(false)}
          targetCandidate={firstParty}
          comparisonCandidates={[secondParty]}
        />
      )}
    </>
  );
};

export default NewSuggestionForm;
--- End of Content for index.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\app\components\matchmaker\suggestions\NewSuggestionForm\schema.ts
--------------------------------------------------------------------------------
Content:
import { z } from "zod";
import { addDays, isBefore } from 'date-fns';

// Validation rules

const MIN_DECISION_DAYS = 1;
const MAX_DECISION_DAYS = 30;

// Helper function to validate dates
const isValidDeadlineDate = (date: Date | null | undefined, minDays: number, maxDays: number) => {
  if (!date) return false;
  
  const today = new Date();
  const minDate = addDays(today, minDays);
  const maxDate = addDays(today, maxDays);
  
  return !isBefore(date, minDate) && !isBefore(maxDate, date);
};

// Schema for new suggestion
export const newSuggestionSchema = z.object({
  firstPartyId: z.string({
    required_error: "יש לבחור מועמד/ת ראשון/ה",
  }),
  
  secondPartyId: z.string({
    required_error: "יש לבחור מועמד/ת שני/ה",
  }),
  
  priority: z.enum(['LOW', 'MEDIUM', 'HIGH', 'URGENT'] as const, {
    required_error: "יש לבחור רמת עדיפות",
  }),

  status: z.enum([
    'DRAFT',
    'PENDING_FIRST_PARTY',
    'FIRST_PARTY_APPROVED',
    'FIRST_PARTY_DECLINED',
    'PENDING_SECOND_PARTY',
    'SECOND_PARTY_APPROVED',
    'SECOND_PARTY_DECLINED',
    'AWAITING_MATCHMAKER_APPROVAL',
    'CONTACT_DETAILS_SHARED',
    'AWAITING_FIRST_DATE_FEEDBACK',
    'THINKING_AFTER_DATE',
    'PROCEEDING_TO_SECOND_DATE',
    'ENDED_AFTER_FIRST_DATE',
    'MEETING_PENDING',
    'MEETING_SCHEDULED',
    'MATCH_APPROVED',
    'MATCH_DECLINED',
    'DATING',
    'ENGAGED',
    'MARRIED',
    'EXPIRED',
    'CLOSED',
    'CANCELLED'
  ] as const, {
    required_error: "יש לבחור סטטוס",
  }).default('DRAFT'),

  matchingReason: z.string()
    .max(500, "סיבת ההתאמה לא יכולה להכיל יותר מ-500 תווים")
    .optional(),

  internalNotes: z.string()
    .max(1000, "ההערות הפנימיות לא יכולות להכיל יותר מ-1000 תווים")
    .optional(),

  firstPartyNotes: z.string()
    .max(500, "ההערות לצד א' לא יכולות להכיל יותר מ-500 תווים")
    .optional(),

  secondPartyNotes: z.string()
    .max(500, "ההערות לצד ב' לא יכולות להכיל יותר מ-500 תווים")
    .optional(),


  decisionDeadline: z.date({
    required_error: "יש לבחור תאריך יעד להחלטה ",
  })
}).refine(
  (data) => data.firstPartyId !== data.secondPartyId,
  {
    message: "לא ניתן ליצור הצעה עבור אותו מועמד",
    path: ["secondPartyId"]
  }

).refine(
  (data) => isValidDeadlineDate(data.decisionDeadline, MIN_DECISION_DAYS, MAX_DECISION_DAYS),
  {
    message: `תאריך היעד להחלטה סופית חייב להיות בין ${MIN_DECISION_DAYS} ל-${MAX_DECISION_DAYS} ימים מהיום`,
    path: ["decisionDeadline"]
  }
);

export type NewSuggestionFormData = z.infer<typeof newSuggestionSchema>;

// Status mapping for display
export const suggestionStatusMap = {
  DRAFT: "טיוטה",
  PENDING_FIRST_PARTY: "ממתין לתשובת צד א'",
  FIRST_PARTY_APPROVED: "צד א' אישר",
  FIRST_PARTY_DECLINED: "צד א' דחה",
  PENDING_SECOND_PARTY: "ממתין לתשובת צד ב'",
  SECOND_PARTY_APPROVED: "צד ב' אישר",
  SECOND_PARTY_DECLINED: "צד ב' דחה",
  AWAITING_MATCHMAKER_APPROVAL: "ממתין לאישור שדכן",
  CONTACT_DETAILS_SHARED: "פרטי קשר הועברו",
  AWAITING_FIRST_DATE_FEEDBACK: "ממתין למשוב פגישה ראשונה",
  THINKING_AFTER_DATE: "בשלב מחשבה אחרי פגישה",
  PROCEEDING_TO_SECOND_DATE: "ממשיכים לפגישה שנייה",
  ENDED_AFTER_FIRST_DATE: "הסתיים אחרי פגישה ראשונה",
  MEETING_PENDING: "ממתין לקביעת פגישה",
  MEETING_SCHEDULED: "פגישה נקבעה",
  MATCH_APPROVED: "ההצעה אושרה",
  MATCH_DECLINED: "ההצעה נדחתה",
  DATING: "בתהליך היכרות",
  ENGAGED: "מאורסים",
  MARRIED: "נישאו",
  EXPIRED: "פג תוקף",
  CLOSED: "ההצעה נסגרה",
  CANCELLED: "ההצעה בוטלה"
} as const;

// Priority mapping for display
export const priorityMap = {
  LOW: { label: "נמוכה", color: "text-gray-500" },
  MEDIUM: { label: "רגילה", color: "text-blue-500" },
  HIGH: { label: "גבוהה", color: "text-yellow-500" },
  URGENT: { label: "דחופה", color: "text-red-500" }
} as const;
--- End of Content for schema.ts ---

--- End of Content for NewSuggestionForm_contents.txt ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\SuggestionDetails.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/SuggestionDetails.tsx

'use client';
import React, { useState } from 'react';
import { useFormContext } from 'react-hook-form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent } from '@/components/ui/card';
import { Priority } from '@prisma/client';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import {
  Loader2,
  Sparkles,
  AlertTriangle,
  Star,
  Flame,
  Target,
  Shield,
  MessageCircle,
  User,
  Calendar,
  Zap,
  Crown,
  Award,
  Gift,
  Clock,
  Wand2,
  Brain,
  Eye,
  Users,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import type { NewSuggestionFormData } from './schema';
import type { Candidate } from '../../new/types/candidates';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface SuggestionDetailsProps {
  dict: MatchmakerPageDictionary['suggestionsDashboard']['newSuggestionForm']['suggestionDetails'];
  firstParty: Candidate;
  secondParty: Candidate;
}

const EnhancedSection: React.FC<{
  icon: React.ElementType;
  title: string;
  description?: string;
  gradient: string;
  children: React.ReactNode;
  className?: string;
}> = ({ icon: Icon, title, description, gradient, children, className }) => (
  <Card
    className={cn(
      'border-0 shadow-xl hover:shadow-2xl transition-all duration-500 group overflow-hidden rounded-3xl',
      'bg-gradient-to-br from-white via-gray-50/30 to-white',
      className
    )}
  >
    <div className="absolute inset-0">
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-cyan-200/20 to-blue-200/20 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-900"></div>
    </div>
    <CardContent className="relative z-10 p-8 space-y-6">
      <div className="flex items-center gap-4 mb-6">
        <div
          className={cn(
            'p-4 rounded-2xl shadow-xl group-hover:scale-110 transition-transform duration-300 bg-gradient-to-r text-white',
            gradient
          )}
        >
          <Icon className="w-8 h-8" />
        </div>
        <div className="flex-1">
          <h3
            className="text-2xl font-bold text-gray-800 group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:bg-clip-text transition-all duration-300"
            style={{
              backgroundImage: `linear-gradient(to right, ${gradient.replace('from-', '').replace('to-', ', ')})`,
            }}
          >
            {title}
          </h3>
          {description && (
            <p className="text-gray-600 mt-1 leading-relaxed">{description}</p>
          )}
        </div>
      </div>
      {children}
    </CardContent>
  </Card>
);

const PriorityBadge: React.FC<{
  priority: Priority;
  dict: MatchmakerPageDictionary['suggestionsDashboard']['newSuggestionForm']['suggestionDetails']['priority'];
}> = ({ priority, dict }) => {
  const getPriorityInfo = (p: Priority) => {
    switch (p) {
      case Priority.URGENT:
        return {
          label: dict.options.URGENT.title,
          icon: Flame,
          className:
            'bg-gradient-to-r from-red-500 to-pink-500 text-white animate-pulse shadow-xl',
        };
      case Priority.HIGH:
        return {
          label: dict.options.HIGH.title,
          icon: Star,
          className:
            'bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-xl',
        };
      case Priority.MEDIUM:
        return {
          label: dict.options.MEDIUM.title,
          icon: Target,
          className:
            'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-xl',
        };
      case Priority.LOW:
        return {
          label: dict.options.LOW.title,
          icon: Shield,
          className:
            'bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-xl',
        };
      default:
        return {
          label: dict.options.MEDIUM.title,
          icon: Target,
          className:
            'bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-xl',
        };
    }
  };

  const info = getPriorityInfo(priority);
  const IconComponent = info.icon;

  return (
    <div
      className={cn(
        'flex items-center gap-2 px-4 py-2 rounded-xl font-bold',
        info.className
      )}
    >
      <IconComponent className="w-4 h-4" />
      <span>{info.label}</span>
    </div>
  );
};

const SuggestionDetails: React.FC<SuggestionDetailsProps> = ({
  dict,
  firstParty,
  secondParty,
}) => {
  const {
    register,
    formState: { errors },
    setValue,
    watch,
  } = useFormContext<NewSuggestionFormData>();
  const [isGeneratingRationale, setIsGeneratingRationale] = useState(false);
  const priority = watch('priority', Priority.MEDIUM);

  const handleGenerateRationale = async () => {
    setIsGeneratingRationale(true);
    toast.info(dict.toasts.aiLoading.title, {
      description: dict.toasts.aiLoading.description,
      duration: 3000,
    });
    try {
      const response = await fetch('/api/ai/generate-suggestion-rationale', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId1: firstParty.id,
          userId2: secondParty.id,
        }),
      });
      const data = await response.json();
      if (!response.ok || !data.success || !data.rationales) {
        throw new Error(data.error || 'Error generating rationale');
      }
      const { generalRationale, rationaleForParty1, rationaleForParty2 } =
        data.rationales;
      setValue('matchingReason', generalRationale, {
        shouldValidate: true,
        shouldDirty: true,
      });
      setValue('firstPartyNotes', rationaleForParty1, {
        shouldValidate: true,
        shouldDirty: true,
      });
      setValue('secondPartyNotes', rationaleForParty2, {
        shouldValidate: true,
        shouldDirty: true,
      });
      toast.success(dict.toasts.aiSuccess.title, {
        description: dict.toasts.aiSuccess.description,
        duration: 5000,
      });
    } catch (error) {
      console.error('Failed to generate rationales:', error);
      toast.error(dict.toasts.aiError.title, {
        description: dict.toasts.aiError.description,
      });
    } finally {
      setIsGeneratingRationale(false);
    }
  };

  return (
    <div className="space-y-8">
      <EnhancedSection
        icon={Crown}
        title={dict.priority.title}
        description={dict.priority.description}
        gradient="from-purple-500 to-pink-500"
      >
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <Label className="text-lg font-semibold text-gray-700">
              {dict.priority.label}
            </Label>
            <PriorityBadge priority={priority} dict={dict.priority} />
          </div>
          <Select
            onValueChange={(value: Priority) =>
              setValue('priority', value, { shouldValidate: true })
            }
            defaultValue={priority}
            name="priority"
          >
            <SelectTrigger className="h-14 border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg">
              <SelectValue placeholder={dict.priority.placeholder} />
            </SelectTrigger>
            <SelectContent className="border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
              <SelectItem value={Priority.URGENT}>
                <div className="flex items-center gap-3 py-2">
                  <Flame className="w-5 h-5 text-red-500" />
                  <div>
                    <div className="font-bold text-red-600">
                      {dict.priority.options.URGENT.title}
                    </div>
                    <div className="text-xs text-red-500">
                      {dict.priority.options.URGENT.description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.HIGH}>
                <div className="flex items-center gap-3 py-2">
                  <Star className="w-5 h-5 text-orange-500" />
                  <div>
                    <div className="font-bold text-orange-600">
                      {dict.priority.options.HIGH.title}
                    </div>
                    <div className="text-xs text-orange-500">
                      {dict.priority.options.HIGH.description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.MEDIUM}>
                <div className="flex items-center gap-3 py-2">
                  <Target className="w-5 h-5 text-blue-500" />
                  <div>
                    <div className="font-bold text-blue-600">
                      {dict.priority.options.MEDIUM.title}
                    </div>
                    <div className="text-xs text-blue-500">
                      {dict.priority.options.MEDIUM.description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value={Priority.LOW}>
                <div className="flex items-center gap-3 py-2">
                  <Shield className="w-5 h-5 text-gray-500" />
                  <div>
                    <div className="font-bold text-gray-600">
                      {dict.priority.options.LOW.title}
                    </div>
                    <div className="text-xs text-gray-500">
                      {dict.priority.options.LOW.description}
                    </div>
                  </div>
                </div>
              </SelectItem>
            </SelectContent>
          </Select>
          {errors.priority && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.priority.message}
              </p>
            </div>
          )}
        </div>
      </EnhancedSection>

      <EnhancedSection
        icon={Brain}
        title={dict.rationale.title}
        description={dict.rationale.description}
        gradient="from-emerald-500 to-green-500"
      >
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <Label className="text-lg font-semibold text-gray-700">
              {dict.rationale.label}
            </Label>
            <Button
              type="button"
              onClick={handleGenerateRationale}
              disabled={isGeneratingRationale}
              className="bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl px-6 py-3 font-bold"
            >
              {isGeneratingRationale ? (
                <>
                  <Loader2 className="w-5 h-5 ml-2 animate-spin" />
                  <span>{dict.rationale.aiButtonLoading}</span>
                </>
              ) : (
                <>
                  <Wand2 className="w-5 h-5 ml-2 text-yellow-300" />
                  <span>{dict.rationale.aiButton}</span>
                </>
              )}
            </Button>
          </div>
          <Textarea
            id="matchingReason"
            {...register('matchingReason')}
            placeholder={dict.rationale.placeholder}
            className="min-h-[140px] border-2 border-emerald-200 hover:border-emerald-300 focus:border-emerald-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
          />
          {errors.matchingReason && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.matchingReason.message}
              </p>
            </div>
          )}
          <Alert className="border-0 bg-gradient-to-r from-blue-50 to-cyan-50 shadow-lg rounded-2xl">
            <Sparkles className="h-5 w-5 text-blue-500" />
            <AlertDescription
              className="text-blue-800 font-medium leading-relaxed"
              dangerouslySetInnerHTML={{ __html: dict.rationale.aiTip }}
            />
          </Alert>
        </div>
      </EnhancedSection>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <EnhancedSection
          icon={User}
          title={dict.notes.party1Title.replace(
            '{{name}}',
            firstParty.firstName
          )}
          description={dict.notes.description}
          gradient="from-blue-500 to-cyan-500"
          className="lg:col-span-1"
        >
          <div className="space-y-4">
            <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-2xl border border-blue-100">
              <div className="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold shadow-lg">
                {firstParty.firstName[0]}
              </div>
              <div>
                <div className="font-bold text-blue-800">
                  {firstParty.firstName} {firstParty.lastName}
                </div>
                <div className="text-sm text-blue-600">
                  {dict.notes.party1Label}
                </div>
              </div>
            </div>
            <Textarea
              id="firstPartyNotes"
              {...register('firstPartyNotes')}
              placeholder={dict.notes.party1Placeholder
                .replace('{{otherName}}', secondParty.firstName)
                .replace('{{name}}', firstParty.firstName)}
              className="min-h-[160px] border-2 border-blue-200 hover:border-blue-300 focus:border-blue-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
            />
            {errors.firstPartyNotes && (
              <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
                <AlertTriangle className="w-4 h-4 text-red-500" />
                <p className="text-sm text-red-600 font-medium">
                  {errors.firstPartyNotes.message}
                </p>
              </div>
            )}
          </div>
        </EnhancedSection>
        <EnhancedSection
          icon={User}
          title={dict.notes.party2Title.replace(
            '{{name}}',
            secondParty.firstName
          )}
          description={dict.notes.description}
          gradient="from-purple-500 to-pink-500"
          className="lg:col-span-1"
        >
          <div className="space-y-4">
            <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-100">
              <div className="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold shadow-lg">
                {secondParty.firstName[0]}
              </div>
              <div>
                <div className="font-bold text-purple-800">
                  {secondParty.firstName} {secondParty.lastName}
                </div>
                <div className="text-sm text-purple-600">
                  {dict.notes.party2Label}
                </div>
              </div>
            </div>
            <Textarea
              id="secondPartyNotes"
              {...register('secondPartyNotes')}
              placeholder={dict.notes.party2Placeholder
                .replace('{{otherName}}', firstParty.firstName)
                .replace('{{name}}', secondParty.firstName)}
              className="min-h-[160px] border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
            />
            {errors.secondPartyNotes && (
              <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
                <AlertTriangle className="w-4 h-4 text-red-500" />
                <p className="text-sm text-red-600 font-medium">
                  {errors.secondPartyNotes.message}
                </p>
              </div>
            )}
          </div>
        </EnhancedSection>
      </div>

      <EnhancedSection
        icon={MessageCircle}
        title={dict.internalNotes.title}
        description={dict.internalNotes.description}
        gradient="from-amber-500 to-orange-500"
      >
        <div className="space-y-4">
          <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl border border-amber-100">
            <div className="p-3 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg">
              <Eye className="w-5 h-5" />
            </div>
            <div>
              <div className="font-bold text-amber-800">
                {dict.internalNotes.secretInfo}
              </div>
              <div className="text-sm text-amber-600">
                {dict.internalNotes.visibleTo}
              </div>
            </div>
          </div>
          <Textarea
            id="internalNotes"
            {...register('internalNotes')}
            placeholder={dict.internalNotes.placeholder}
            className="min-h-[120px] border-2 border-amber-200 hover:border-amber-300 focus:border-amber-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg resize-none"
          />
          {errors.internalNotes && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.internalNotes.message}
              </p>
            </div>
          )}
        </div>
      </EnhancedSection>

      <EnhancedSection
        icon={Clock}
        title={dict.deadline.title}
        description={dict.deadline.description}
        gradient="from-indigo-500 to-purple-500"
      >
        <div className="space-y-4">
          <Label className="text-lg font-semibold text-gray-700">
            {dict.deadline.label}
          </Label>
          <Select
            onValueChange={(value) => {
              const days = parseInt(value, 10);
              const deadline = new Date();
              deadline.setDate(deadline.getDate() + days);
              setValue('decisionDeadline', deadline, { shouldValidate: true });
            }}
            defaultValue="14"
          >
            <SelectTrigger className="h-14 border-2 border-indigo-200 hover:border-indigo-300 focus:border-indigo-500 rounded-2xl bg-white/80 backdrop-blur-sm shadow-lg transition-all text-lg">
              <SelectValue />
            </SelectTrigger>
            <SelectContent className="border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm">
              <SelectItem value="3">
                <div className="flex items-center gap-3 py-2">
                  <Zap className="w-5 h-5 text-red-500" />
                  <div>
                    <div className="font-bold text-red-600">
                      {dict.deadline.options['3'].title}
                    </div>
                    <div className="text-xs text-red-500">
                      {dict.deadline.options['3'].description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="7">
                <div className="flex items-center gap-3 py-2">
                  <Award className="w-5 h-5 text-orange-500" />
                  <div>
                    <div className="font-bold text-orange-600">
                      {dict.deadline.options['7'].title}
                    </div>
                    <div className="text-xs text-orange-500">
                      {dict.deadline.options['7'].description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="14">
                <div className="flex items-center gap-3 py-2">
                  <Target className="w-5 h-5 text-blue-500" />
                  <div>
                    <div className="font-bold text-blue-600">
                      {dict.deadline.options['14'].title}
                    </div>
                    <div className="text-xs text-blue-500">
                      {dict.deadline.options['14'].description}
                    </div>
                  </div>
                </div>
              </SelectItem>
              <SelectItem value="30">
                <div className="flex items-center gap-3 py-2">
                  <Shield className="w-5 h-5 text-green-500" />
                  <div>
                    <div className="font-bold text-green-600">
                      {dict.deadline.options['30'].title}
                    </div>
                    <div className="text-xs text-green-500">
                      {dict.deadline.options['30'].description}
                    </div>
                  </div>
                </div>
              </SelectItem>
            </SelectContent>
          </Select>
          {errors.decisionDeadline && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
              <AlertTriangle className="w-4 h-4 text-red-500" />
              <p className="text-sm text-red-600 font-medium">
                {errors.decisionDeadline.message}
              </p>
            </div>
          )}
          <div className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl border border-indigo-100">
            <div className="flex items-start gap-3">
              <Calendar className="w-5 h-5 text-indigo-500 mt-1" />
              <div>
                <div className="font-bold text-indigo-800 mb-1">
                  {dict.deadline.infoBox.title}
                </div>
                <p className="text-sm text-indigo-700 leading-relaxed">
                  {dict.deadline.infoBox.body}
                </p>
              </div>
            </div>
          </div>
        </div>
      </EnhancedSection>

      <Card className="border-0 shadow-2xl bg-gradient-to-br from-gray-50 via-white to-gray-50 rounded-3xl overflow-hidden">
        <CardContent className="p-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-4 rounded-2xl bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-xl">
                <Users className="w-8 h-8" />
              </div>
              <div>
                <h3 className="text-2xl font-bold text-gray-800">
                  {dict.summary.title}
                </h3>
                <p className="text-gray-600 leading-relaxed">
                  {dict.summary.description}
                </p>
              </div>
            </div>
            <div className="text-center">
              <div className="flex items-center gap-2 mb-2">
                <Gift className="w-5 h-5 text-purple-500" />
                <span className="font-bold text-purple-600">
                  {dict.summary.ready}
                </span>
              </div>
              <p className="text-sm text-gray-500">{dict.summary.info}</p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default SuggestionDetails;
--- End of Content for SuggestionDetails.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\index.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/NewSuggestionForm/index.tsx

'use client';
import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { useForm, FormProvider } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import {
  UserPlus,
  Sparkles,
  Loader2,
  BarChart2,
  Users,
  Heart,
  ArrowRight,
  ArrowLeft,
  X,
  Gift,
  Check,
  Crown,
} from 'lucide-react';

// Types
import type { Candidate } from '../../new/types/candidates';
import { newSuggestionSchema, type NewSuggestionFormData } from './schema';
// <=== שינוי 1: עדכון הטיפוס של המילון שמתקבל ===>
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// Components
import SuggestionDetails from './SuggestionDetails';
import MatchPreview from './MatchPreview';
import CandidateSelector from './CandidateSelector';
import { AiMatchAnalysisDialog } from '../../new/dialogs/AiMatchAnalysisDialog';
import { cn } from '@/lib/utils';

interface NewSuggestionFormProps {
  locale: string;
  dict: MatchmakerPageDictionary;
  isOpen: boolean;
  onClose: () => void;
  candidates: Candidate[];
  selectedCandidate?: Candidate | null;
  onSubmit: (data: NewSuggestionFormData) => Promise<void>;
}

const StepIndicator: React.FC<{
  currentStep: number;
  steps: Array<{ label: string; icon: React.ElementType }>;
}> = ({ currentStep, steps }) => (
  <div className="flex items-center justify-center">
    {steps.map((step, index) => {
      const isActive = index === currentStep;
      const isCompleted = index < currentStep;
      const StepIcon = step.icon;

      return (
        <React.Fragment key={index}>
          <div className="flex flex-col items-center text-center">
            <div
              className={cn(
                'flex items-center justify-center w-12 h-12 rounded-full transition-all duration-300 shadow-md',
                isActive &&
                  'bg-gradient-to-r from-purple-600 to-pink-600 text-white scale-110 shadow-lg',
                isCompleted &&
                  'bg-gradient-to-r from-green-500 to-emerald-500 text-white',
                !isActive && !isCompleted && 'bg-gray-200 text-gray-500'
              )}
            >
              {isCompleted ? (
                <Check className="w-6 h-6" />
              ) : (
                <StepIcon className="w-6 h-6" />
              )}
            </div>
            <p
              className={cn(
                'mt-2 text-xs font-semibold w-24',
                isActive && 'text-purple-600',
                isCompleted && 'text-green-600',
                !isActive && !isCompleted && 'text-gray-500'
              )}
            >
              {step.label}
            </p>
          </div>

          {index < steps.length - 1 && (
            <div
              className={cn(
                'w-16 h-1 mx-2 rounded-full transition-colors duration-300',
                isCompleted ? 'bg-green-500' : 'bg-gray-200'
              )}
            />
          )}
        </React.Fragment>
      );
    })}
  </div>
);

const NewSuggestionForm: React.FC<NewSuggestionFormProps> = ({
  dict,
  isOpen,
  onClose,
  candidates,
  selectedCandidate,
  locale, // <--- הוסף את זה

  onSubmit,
}) => {
  // <=== שינוי 3: שימוש בנתיב הנכון והמלא לאובייקט המילון של הטופס ===>
  const formDict = dict.suggestionsDashboard.newSuggestionForm;

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [firstParty, setFirstParty] = useState<Candidate | null>(null);
  const [secondParty, setSecondParty] = useState<Candidate | null>(null);
  const [showAnalysisDialog, setShowAnalysisDialog] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);

  // <=== שינוי 4: בניית מערך השלבים מתוך המילון ===>
  const steps = [
    { label: formDict.steps.select.label, icon: Users },
    { label: formDict.steps.analyze.label, icon: BarChart2 },
    { label: formDict.steps.details.label, icon: Heart },
  ];

  const form = useForm<NewSuggestionFormData>({
    resolver: zodResolver(newSuggestionSchema),
    defaultValues: {
      priority: Priority.MEDIUM,
      status: MatchSuggestionStatus.DRAFT,
      decisionDeadline: new Date(new Date().setDate(new Date().getDate() + 14)),
    },
  });

  useEffect(() => {
    if (isOpen) {
      form.reset({
        priority: Priority.MEDIUM,
        status: MatchSuggestionStatus.DRAFT,
        decisionDeadline: new Date(
          new Date().setDate(new Date().getDate() + 14)
        ),
        firstPartyId: selectedCandidate?.id || '',
        secondPartyId: '',
      });
      setFirstParty(selectedCandidate || null);
      setSecondParty(null);
      setCurrentStep(0);
    }
  }, [isOpen, selectedCandidate, form]);

  const handleCandidateSelect =
    (type: 'first' | 'second') => (candidate: Candidate | null) => {
      const setter = type === 'first' ? setFirstParty : setSecondParty;
      const fieldName = type === 'first' ? 'firstPartyId' : 'secondPartyId';
      setter(candidate);
      form.setValue(fieldName, candidate?.id || '', {
        shouldValidate: true,
        shouldDirty: true,
      });
    };

  const handleNext = () => {
    if (currentStep === 0 && (!firstParty || !secondParty)) {
      toast.error(formDict.toasts.selectParties);
      return;
    }
    setCurrentStep((prev) => Math.min(prev + 1, steps.length - 1));
  };

  const handlePrevious = () => {
    setCurrentStep((prev) => Math.max(prev - 1, 0));
  };

  const handleSubmit = form.handleSubmit(async (data) => {
    if (!firstParty || !secondParty) {
      toast.error(formDict.toasts.selectParties);
      return;
    }

    setIsSubmitting(true);
    try {
      await onSubmit(data);
      toast.success(formDict.toasts.createSuccess, {
        duration: 5000,
      });
      onClose();
    } catch (error) {
      toast.error(
        `${formDict.toasts.createError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsSubmitting(false);
    }
  });

  const maleCandidates = candidates.filter((c) => c.profile.gender === 'MALE');
  const femaleCandidates = candidates.filter(
    (c) => c.profile.gender === 'FEMALE'
  );

  const canProceedToNextStep = () => {
    switch (currentStep) {
      case 0:
        return firstParty && secondParty;
      case 1:
        return firstParty && secondParty;
      case 2:
        return true;
      default:
        return false;
    }
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <CandidateSelector
              dict={formDict.candidateSelector}
              label={formDict.party1Label}
              value={firstParty}
              onChange={handleCandidateSelect('first')}
              candidates={maleCandidates}
              otherParty={secondParty}
              fieldName="firstPartyId"
              error={form.formState.errors.firstPartyId?.message}
            />
            <CandidateSelector
              dict={formDict.candidateSelector}
              label={formDict.party2Label}
              value={secondParty}
              onChange={handleCandidateSelect('second')}
              candidates={femaleCandidates}
              otherParty={firstParty}
              fieldName="secondPartyId"
              error={form.formState.errors.secondPartyId?.message}
            />
          </div>
        );

      case 1:
        if (!firstParty || !secondParty) {
          return (
            <div className="flex items-center justify-center h-full">
              <div className="text-center text-gray-500">
                <Users className="mx-auto h-16 w-16 text-gray-300 mb-4" />
                <p className="text-lg font-medium">
                  {formDict.emptyState.title}
                </p>
              </div>
            </div>
          );
        }
        return (
          <div className="space-y-8">
            {/* <=== שינוי 5: העברת החלק הנכון במילון לקומפוננטת הילד ===> */}
            <MatchPreview
              dict={formDict.matchPreview}
              firstParty={firstParty}
              secondParty={secondParty}
            />
            <div className="flex justify-center">
              <Button
                type="button"
                variant="outline"
                onClick={() => setShowAnalysisDialog(true)}
                className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 text-indigo-700 hover:bg-gradient-to-r hover:from-indigo-100 hover:to-purple-100 hover:border-indigo-300 rounded-2xl px-8 py-4 font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300"
              >
                <BarChart2 className="w-6 h-6 ml-3" />
                {formDict.buttons.fullAnalysis}
                <Sparkles className="w-5 h-5 mr-2 text-purple-500" />
              </Button>
            </div>
          </div>
        );

      case 2:
        if (!firstParty || !secondParty) {
          return (
            <div className="flex items-center justify-center h-full">
              <div className="text-center text-gray-500">
                <Users className="mx-auto h-16 w-16 text-gray-300 mb-4" />
                <p className="text-lg font-medium">
                  {formDict.emptyState.title}
                </p>
              </div>
            </div>
          );
        }
        return (
          // <=== שינוי 6: העברת החלק הנכון במילון לקומפוננטת הילד ===>
          <SuggestionDetails
            dict={formDict.suggestionDetails}
            firstParty={firstParty}
            secondParty={secondParty}
          />
        );

      default:
        return null;
    }
  };

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent
          className="max-w-7xl w-full h-[95vh] flex flex-col p-0 border-0 shadow-2xl rounded-3xl bg-gray-50"
          dir="rtl"
        >
          <div className="relative border-b p-4 flex-shrink-0 bg-white">
            <div className="flex justify-between items-center w-full">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
                  <UserPlus className="w-8 h-8" />
                </div>
                <div className="text-right">
                  <DialogTitle className="text-2xl font-bold text-gray-800">
                    {formDict.header.title}
                  </DialogTitle>
                  <DialogDescription className="text-md text-gray-500 mt-1">
                    {formDict.header.description
                      .replace('{{current}}', (currentStep + 1).toString())
                      .replace('{{total}}', steps.length.toString())
                      .replace('{{label}}', steps[currentStep].label)}
                  </DialogDescription>
                </div>
              </div>

              <div className="flex-1 flex justify-center">
                <StepIndicator currentStep={currentStep} steps={steps} />
              </div>

              <Button
                variant="ghost"
                size="icon"
                onClick={onClose}
                className="rounded-full h-10 w-10 text-gray-500 hover:text-gray-700 hover:bg-gray-100"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-6 lg:p-8 bg-gradient-to-br from-white via-purple-50/20 to-pink-50/20">
            <FormProvider {...form}>
              <form onSubmit={handleSubmit} className="h-full">
                <div className="animate-fade-in-up">{renderStepContent()}</div>
              </form>
            </FormProvider>
          </div>

          <div className="border-t bg-white p-4 flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                {currentStep > 0 && (
                  <Button
                    type="button"
                    variant="outline"
                    onClick={handlePrevious}
                    className="px-6 py-3 border-2 border-gray-300 hover:bg-gray-50 rounded-xl transition-all duration-300 font-bold"
                  >
                    <ArrowRight className="w-5 h-5 ml-2" />
                    {formDict.buttons.back}
                  </Button>
                )}
                {currentStep < steps.length - 1 ? (
                  <Button
                    type="button"
                    onClick={handleNext}
                    disabled={!canProceedToNextStep()}
                    className="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {formDict.buttons.continue}
                    <ArrowLeft className="w-5 h-5 mr-2" />
                  </Button>
                ) : (
                  <Button
                    type="submit"
                    onClick={handleSubmit}
                    disabled={isSubmitting || !firstParty || !secondParty}
                    className="px-8 py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isSubmitting ? (
                      <>
                        <Loader2 className="w-5 h-5 ml-2 animate-spin" />
                        {formDict.buttons.creating}
                      </>
                    ) : (
                      <>
                        <Gift className="w-5 h-5 ml-2" />
                        {formDict.buttons.create}
                        <Sparkles className="w-4 h-4 mr-2" />
                      </>
                    )}
                  </Button>
                )}
              </div>
              <div className="text-sm text-gray-500 flex items-center gap-2">
                <Crown className="w-4 h-4 text-purple-500" />
                <span>{formDict.footer.info}</span>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {firstParty && secondParty && (
        <AiMatchAnalysisDialog
          isOpen={showAnalysisDialog}
          onClose={() => setShowAnalysisDialog(false)}
          targetCandidate={firstParty}
          comparisonCandidates={[secondParty]}
          // <=== שינוי 7: העברת החלק הנכון של המילון לדיאלוג ה-AI ===>
          dict={dict.candidatesManager.aiAnalysis}
          locale={locale} // <--- הוסף את השורה הזו
        />
      )}
    </>
  );
};

export default NewSuggestionForm;
--- End of Content for index.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\NewSuggestionForm\schema.ts
--------------------------------------------------------------------------------
Content:
import { z } from "zod";
import { addDays, isBefore } from 'date-fns';

// Validation rules

const MIN_DECISION_DAYS = 1;
const MAX_DECISION_DAYS = 30;

// Helper function to validate dates
const isValidDeadlineDate = (date: Date | null | undefined, minDays: number, maxDays: number) => {
  if (!date) return false;
  
  const today = new Date();
  const minDate = addDays(today, minDays);
  const maxDate = addDays(today, maxDays);
  
  return !isBefore(date, minDate) && !isBefore(maxDate, date);
};

// Schema for new suggestion
export const newSuggestionSchema = z.object({
  firstPartyId: z.string({
    required_error: "יש לבחור מועמד/ת ראשון/ה",
  }),
  
  secondPartyId: z.string({
    required_error: "יש לבחור מועמד/ת שני/ה",
  }),
  
  priority: z.enum(['LOW', 'MEDIUM', 'HIGH', 'URGENT'] as const, {
    required_error: "יש לבחור רמת עדיפות",
  }),

  status: z.enum([
    'DRAFT',
    'PENDING_FIRST_PARTY',
    'FIRST_PARTY_APPROVED',
    'FIRST_PARTY_DECLINED',
    'PENDING_SECOND_PARTY',
    'SECOND_PARTY_APPROVED',
    'SECOND_PARTY_DECLINED',
    'AWAITING_MATCHMAKER_APPROVAL',
    'CONTACT_DETAILS_SHARED',
    'AWAITING_FIRST_DATE_FEEDBACK',
    'THINKING_AFTER_DATE',
    'PROCEEDING_TO_SECOND_DATE',
    'ENDED_AFTER_FIRST_DATE',
    'MEETING_PENDING',
    'MEETING_SCHEDULED',
    'MATCH_APPROVED',
    'MATCH_DECLINED',
    'DATING',
    'ENGAGED',
    'MARRIED',
    'EXPIRED',
    'CLOSED',
    'CANCELLED'
  ] as const, {
    required_error: "יש לבחור סטטוס",
  }).default('DRAFT'),

  matchingReason: z.string()
    .max(500, "סיבת ההתאמה לא יכולה להכיל יותר מ-500 תווים")
    .optional(),

  internalNotes: z.string()
    .max(1000, "ההערות הפנימיות לא יכולות להכיל יותר מ-1000 תווים")
    .optional(),

  firstPartyNotes: z.string()
    .max(500, "ההערות לצד א' לא יכולות להכיל יותר מ-500 תווים")
    .optional(),

  secondPartyNotes: z.string()
    .max(500, "ההערות לצד ב' לא יכולות להכיל יותר מ-500 תווים")
    .optional(),


  decisionDeadline: z.date({
    required_error: "יש לבחור תאריך יעד להחלטה ",
  })
}).refine(
  (data) => data.firstPartyId !== data.secondPartyId,
  {
    message: "לא ניתן ליצור הצעה עבור אותו מועמד",
    path: ["secondPartyId"]
  }

).refine(
  (data) => isValidDeadlineDate(data.decisionDeadline, MIN_DECISION_DAYS, MAX_DECISION_DAYS),
  {
    message: `תאריך היעד להחלטה סופית חייב להיות בין ${MIN_DECISION_DAYS} ל-${MAX_DECISION_DAYS} ימים מהיום`,
    path: ["decisionDeadline"]
  }
);

export type NewSuggestionFormData = z.infer<typeof newSuggestionSchema>;

// Status mapping for display
export const suggestionStatusMap = {
  DRAFT: "טיוטה",
  PENDING_FIRST_PARTY: "ממתין לתשובת צד א'",
  FIRST_PARTY_APPROVED: "צד א' אישר",
  FIRST_PARTY_DECLINED: "צד א' דחה",
  PENDING_SECOND_PARTY: "ממתין לתשובת צד ב'",
  SECOND_PARTY_APPROVED: "צד ב' אישר",
  SECOND_PARTY_DECLINED: "צד ב' דחה",
  AWAITING_MATCHMAKER_APPROVAL: "ממתין לאישור שדכן",
  CONTACT_DETAILS_SHARED: "פרטי קשר הועברו",
  AWAITING_FIRST_DATE_FEEDBACK: "ממתין למשוב פגישה ראשונה",
  THINKING_AFTER_DATE: "בשלב מחשבה אחרי פגישה",
  PROCEEDING_TO_SECOND_DATE: "ממשיכים לפגישה שנייה",
  ENDED_AFTER_FIRST_DATE: "הסתיים אחרי פגישה ראשונה",
  MEETING_PENDING: "ממתין לקביעת פגישה",
  MEETING_SCHEDULED: "פגישה נקבעה",
  MATCH_APPROVED: "ההצעה אושרה",
  MATCH_DECLINED: "ההצעה נדחתה",
  DATING: "בתהליך היכרות",
  ENGAGED: "מאורסים",
  MARRIED: "נישאו",
  EXPIRED: "פג תוקף",
  CLOSED: "ההצעה נסגרה",
  CANCELLED: "ההצעה בוטלה"
} as const;

// Priority mapping for display
export const priorityMap = {
  LOW: { label: "נמוכה", color: "text-gray-500" },
  MEDIUM: { label: "רגילה", color: "text-blue-500" },
  HIGH: { label: "גבוהה", color: "text-yellow-500" },
  URGENT: { label: "דחופה", color: "text-red-500" }
} as const;
--- End of Content for schema.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\cards
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\cards\SuggestionCard.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/cards/SuggestionCard.tsx

import React, { useState, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import Image from 'next/image';
import {
  Clock,
  MessageCircle,
  Eye,
  AlertCircle,
  MoreHorizontal,
  Send,
  RefreshCw,
  Trash2,
  Edit,
  CheckCircle,
  XCircle,
  CalendarClock,
  Heart,
  MapPin,

  Star,
  Sparkles,
  Crown,
  Target,

  Quote,
  Briefcase,
  GraduationCap,
  ArrowRight,

  Flame,
  TrendingUp,
  Shield,
  Gem,
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import type {
  MatchSuggestionStatus,
  Priority,
  UserImage,
} from '@prisma/client';
import type {
  Suggestion,
  ActionAdditionalData,
  SuggestionParty,
} from '@/types/suggestions';
import { Progress } from '@/components/ui/progress';
import { cn, getRelativeCloudinaryPath, getInitials } from '@/lib/utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import {
  TooltipProvider,
} from '@/components/ui/tooltip';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

// Media query hook
const useMediaQuery = (query: string) => {
  const [matches, setMatches] = useState(false);
  useEffect(() => {
    const media = window.matchMedia(query);
    if (media.matches !== matches) {
      setMatches(media.matches);
    }
    const listener = () => setMatches(media.matches);
    window.addEventListener('resize', listener);
    return () => window.removeEventListener('resize', listener);
  }, [matches, query]);
  return matches;
};

interface SuggestionCardProps {
  suggestion: Suggestion;
  onAction: (
    type:
      | 'view'
      | 'contact'
      | 'message'
      | 'edit'
      | 'delete'
      | 'resend'
      | 'changeStatus'
      | 'reminder',
    suggestion: Suggestion,
    additionalData?: ActionAdditionalData
  ) => void;
  dict: MatchmakerPageDictionary['suggestionsDashboard']['suggestionCard'];
  className?: string;
  variant?: 'full' | 'compact';
}

const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

const getEnhancedStatusInfo = (status: MatchSuggestionStatus) => {
  const defaults = {
    icon: RefreshCw,
    progress: 30,
    pulse: false,
    color: 'text-gray-600',
    bgColor: 'from-gray-50 to-slate-50',
  };
  const statusMap: Partial<
    Record<MatchSuggestionStatus, Partial<typeof defaults>>
  > = {
    PENDING_FIRST_PARTY: {
      color: 'text-yellow-600',
      bgColor: 'from-yellow-50 to-amber-50',
      icon: Clock,
      progress: 25,
      pulse: true,
    },
    PENDING_SECOND_PARTY: {
      color: 'text-blue-600',
      bgColor: 'from-blue-50 to-cyan-50',
      icon: Clock,
      progress: 50,
      pulse: true,
    },
    FIRST_PARTY_APPROVED: {
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      icon: CheckCircle,
      progress: 40,
    },
    SECOND_PARTY_APPROVED: {
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      icon: CheckCircle,
      progress: 60,
    },
    FIRST_PARTY_DECLINED: {
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      icon: XCircle,
      progress: 100,
    },
    SECOND_PARTY_DECLINED: {
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      icon: XCircle,
      progress: 100,
    },
    CONTACT_DETAILS_SHARED: {
      color: 'text-purple-600',
      bgColor: 'from-purple-50 to-pink-50',
      icon: Send,
      progress: 70,
    },
    DATING: {
      color: 'text-pink-600',
      bgColor: 'from-pink-50 to-rose-50',
      icon: Heart,
      progress: 80,
    },
    ENGAGED: {
      color: 'text-yellow-600',
      bgColor: 'from-yellow-50 to-orange-50',
      icon: Gem,
      progress: 95,
    },
    MARRIED: {
      color: 'text-emerald-600',
      bgColor: 'from-emerald-50 to-green-50',
      icon: Crown,
      progress: 100,
    },
    AWAITING_FIRST_DATE_FEEDBACK: {
      color: 'text-orange-600',
      bgColor: 'from-orange-50 to-amber-50',
      icon: AlertCircle,
      progress: 75,
      pulse: true,
    },
    EXPIRED: {
      color: 'text-gray-600',
      bgColor: 'from-gray-50 to-slate-50',
      icon: Clock,
      progress: 100,
    },
  };
  return { ...defaults, ...(statusMap[status] || {}) };
};

const getEnhancedPriorityInfo = (priority: Priority) => {
  const priorityMap = {
    URGENT: {
      icon: Flame,
      borderColor: 'border-red-500',
      bgGradient: 'from-red-50 to-pink-50',
      badgeClass:
        'bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-xl animate-pulse',
    },
    HIGH: {
      icon: Star,
      borderColor: 'border-orange-500',
      bgGradient: 'from-orange-50 to-amber-50',
      badgeClass:
        'bg-gradient-to-r from-orange-500 to-amber-500 text-white border-0 shadow-lg',
    },
    MEDIUM: {
      icon: Target,
      borderColor: 'border-blue-500',
      bgGradient: 'from-blue-50 to-cyan-50',
      badgeClass:
        'bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 shadow-lg',
    },
    LOW: {
      icon: Shield,
      borderColor: 'border-gray-400',
      bgGradient: 'from-gray-50 to-slate-50',
      badgeClass:
        'bg-gradient-to-r from-gray-500 to-slate-500 text-white border-0 shadow-lg',
    },
  };
  return priorityMap[priority] || priorityMap.MEDIUM;
};

const getDaysLeft = (decisionDeadline?: Date | string | null) => {
  if (!decisionDeadline) return null;
  const deadline = new Date(decisionDeadline);
  const today = new Date();
  const diffTime = deadline.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays > 0 ? diffDays : 0;
};

const HighlightPill: React.FC<{
  icon: React.ElementType;
  text: string;
  color?: string;
}> = ({ icon: Icon, text, color = 'from-blue-500 to-cyan-500' }) => (
  <div
    className={cn(
      'flex items-center gap-2 rounded-full bg-white/80 backdrop-blur-sm border-2 px-3 py-1.5 text-xs font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105',
      'border-transparent bg-gradient-to-r text-white',
      color
    )}
  >
    <Icon className="w-3 h-3" />
    <span>{text}</span>
  </div>
);

const MatchmakerInfo: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['suggestionCard']['matchmakerInfo'];
  matchmaker: { firstName: string; lastName: string } | undefined;
  className?: string;
}> = ({ dict, matchmaker, className }) => {
  if (!matchmaker) {
    return (
      <div
        className={cn(
          'flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-100 shadow-sm',
          className
        )}
      >
        <div className="text-center text-gray-500">
          <p className="text-sm">{dict.noInfo}</p>
        </div>
      </div>
    );
  }
  return (
    <div
      className={cn(
        'flex items-center gap-3 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100 shadow-sm',
        className
      )}
    >
      <Avatar className="w-10 h-10 border-2 border-white shadow-lg">
        <AvatarFallback className="bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold text-sm">
          {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
        </AvatarFallback>
      </Avatar>
      <div>
        <p className="text-xs font-medium text-purple-600">{dict.label}</p>
        <p className="text-sm font-bold text-gray-800">
          {matchmaker.firstName} {matchmaker.lastName}
        </p>
      </div>
    </div>
  );
};

const PartyDisplay: React.FC<{
  party: SuggestionParty;
  isCompact?: boolean;
}> = ({ party, isCompact = false }) => {
  const imageUrl =
    party.images.find((img: UserImage) => img.isMain)?.url ||
    '/placeholders/user.png';
  return (
    <div className="flex flex-col items-center gap-3">
      <div
        className={cn(
          'relative rounded-full overflow-hidden shadow-xl border-3 border-white',
          isCompact ? 'h-12 w-12' : 'h-16 w-16'
        )}
      >
        <Image
          src={getRelativeCloudinaryPath(imageUrl)}
          alt={party.firstName}
          fill
          className="object-cover"
          sizes={isCompact ? '3rem' : '4rem'}
        />
      </div>
      <div className="text-center">
        <h4
          className={cn(
            'font-bold text-gray-800',
            isCompact ? 'text-sm' : 'text-base'
          )}
        >
          {party.firstName} {party.lastName}
        </h4>
        {party.profile?.city && (
          <div
            className={cn(
              'flex items-center justify-center gap-1 text-gray-600',
              isCompact ? 'text-xs' : 'text-sm'
            )}
          >
            <MapPin className="w-3 h-3 text-green-500" />
            <span>{party.profile.city}</span>
          </div>
        )}
      </div>
    </div>
  );
};

const SuggestionCard: React.FC<SuggestionCardProps> = ({
  suggestion,
  onAction,
  dict,
  className,
  variant = 'full',
}) => {
  const isMobile = useMediaQuery('(max-width: 768px)');

  const { firstParty, secondParty, matchmaker } = suggestion;
  const statusInfo = getEnhancedStatusInfo(suggestion.status);
  const priorityInfo = getEnhancedPriorityInfo(suggestion.priority);
  const statusText = dict.statuses[suggestion.status] || dict.statuses.DEFAULT;
  const priorityText =
    dict.priorities[suggestion.priority] || dict.priorities.MEDIUM;
  const daysLeft = getDaysLeft(suggestion.decisionDeadline);
  const firstPartyAge = calculateAge(firstParty.profile.birthDate);
  const secondPartyAge = calculateAge(secondParty.profile.birthDate);

  const highlights = [
    {
      text: dict.highlights.familyValues,
      icon: Heart,
      color: 'from-pink-500 to-rose-500',
    },
    {
      text: dict.highlights.religiousView,
      icon: Sparkles,
      color: 'from-purple-500 to-indigo-500',
    },
    {
      text: dict.highlights.location,
      icon: MapPin,
      color: 'from-green-500 to-emerald-500',
    },
  ].slice(0, 3);

  if (isMobile && variant === 'compact') {
    const StatusIcon = statusInfo.icon;
    return (
      <Card
        className={cn(
          'w-full cursor-pointer hover:shadow-xl transition-all duration-300 group overflow-hidden',
          'border-l-4 bg-gradient-to-br from-white to-gray-50/50',
          priorityInfo.borderColor,
          className
        )}
        onClick={() => onAction('view', suggestion)}
      >
        <CardContent className="p-4">
          <div className="flex justify-between items-start mb-3">
            <div className="flex-1">
              <h4 className="font-bold text-gray-800 mb-2 text-sm leading-tight">
                {firstParty.firstName} ו{secondParty.firstName}
              </h4>
              <div className="flex items-center gap-2 mb-2">
                <div className="flex -space-x-2">
                  <Image
                    src={getRelativeCloudinaryPath(
                      firstParty.images.find((img) => img.isMain)?.url ||
                        '/placeholders/user.png'
                    )}
                    alt={firstParty.firstName}
                    width={24}
                    height={24}
                    className="rounded-full border-2 border-white shadow-md"
                  />
                  <Image
                    src={getRelativeCloudinaryPath(
                      secondParty.images.find((img) => img.isMain)?.url ||
                        '/placeholders/user.png'
                    )}
                    alt={secondParty.firstName}
                    width={24}
                    height={24}
                    className="rounded-full border-2 border-white shadow-md"
                  />
                </div>
                <span className="text-xs text-gray-500 font-medium">
                  {firstPartyAge}, {secondPartyAge}
                </span>
              </div>
            </div>
            <div
              className={cn(
                'p-2 rounded-full shadow-lg group-hover:scale-110 transition-transform bg-gradient-to-r',
                statusInfo.bgColor
              )}
            >
              <StatusIcon className={cn('w-4 h-4', statusInfo.color)} />
            </div>
          </div>
          <Badge
            className={cn(
              'text-xs font-bold bg-opacity-20 border',
              priorityInfo.borderColor,
              statusInfo.color
            )}
          >
            {statusText.shortLabel}
          </Badge>
        </CardContent>
      </Card>
    );
  }

  if (isMobile && variant === 'full') {
    return (
      <Card
        className={cn(
          'overflow-hidden shadow-xl border-0 bg-gradient-to-br from-white via-purple-50/20 to-pink-50/20 hover:shadow-2xl transition-all duration-500 group',
          className
        )}
      >
        <CardContent className="p-6 space-y-6">
          <div className="relative">
            <div className="relative z-10 flex justify-between items-center">
              <h3 className="text-2xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                {dict.mobile.title}
              </h3>
              <Badge
                className={cn(
                  'text-sm font-bold shadow-xl',
                  priorityInfo.badgeClass
                )}
              >
                <statusInfo.icon className="w-4 h-4 ml-2" />
                {statusText.label}
              </Badge>
            </div>
          </div>
          {suggestion.priority === 'URGENT' && (
            <div className="flex items-center gap-2 p-3 bg-gradient-to-r from-red-100 to-pink-100 border border-red-200 rounded-xl shadow-lg">
              <Flame className="w-5 h-5 text-red-500 animate-pulse" />
              <span className="text-red-700 font-bold text-sm">
                {dict.mobile.urgentTitle}
              </span>
            </div>
          )}
          <MatchmakerInfo dict={dict.matchmakerInfo} matchmaker={matchmaker} />
          <div>
            <h4 className="font-bold text-lg mb-3 text-center text-gray-700 flex items-center justify-center gap-2">
              <Sparkles className="w-5 h-5 text-purple-500" />
              {dict.mobile.connectionPoints}
            </h4>
            <div className="flex flex-wrap justify-center gap-2">
              {highlights.map((highlight, index) => (
                <HighlightPill
                  key={index}
                  icon={highlight.icon}
                  text={highlight.text}
                  color={highlight.color}
                />
              ))}
            </div>
          </div>
          <div className="space-y-6">
            <PartyDisplay party={firstParty} />
            <div className="flex justify-center">
              <div className="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl">
                <Heart className="w-6 h-6" />
              </div>
            </div>
            <PartyDisplay party={secondParty} />
          </div>
          {suggestion.matchingReason && (
            <div className="p-4 bg-gradient-to-r from-cyan-50 to-blue-50 border border-cyan-200 rounded-xl shadow-inner">
              <div className="flex items-start gap-3">
                <Quote className="w-5 h-5 text-cyan-500 mt-1 flex-shrink-0" />
                <div>
                  <h4 className="font-bold text-cyan-800 mb-2">
                    {dict.mobile.matchReasonTitle}
                  </h4>
                  <p className="text-cyan-900 leading-relaxed italic font-medium text-sm">
                    &quot;{suggestion.matchingReason}&quot;
                  </p>
                </div>
              </div>
            </div>
          )}
          <div className="space-y-2">
            <div className="flex justify-between text-sm text-gray-600">
              <span>{statusText.description}</span>
              <span>{statusInfo.progress}%</span>
            </div>
            <Progress
              value={statusInfo.progress}
              className="h-2 bg-gray-100 shadow-inner"
            />
          </div>
          <div className="pt-4 border-t border-purple-100 space-y-4">
            <Button
              size="lg"
              className="w-full bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl h-14 font-bold text-lg transform hover:scale-105"
              onClick={() => onAction('view', suggestion)}
            >
              <Eye className="w-6 h-6 ml-3" />
              {dict.mobile.viewDetailsButton}
              <ArrowRight className="w-5 h-5 mr-2" />
            </Button>
            <div className="flex justify-between items-center">
              <span className="text-xs text-gray-500 font-medium">
                {dict.mobile.sentTime.replace(
                  '{{timeAgo}}',
                  formatDistanceToNow(new Date(suggestion.createdAt), {
                    addSuffix: true,
                    locale: he,
                  })
                )}
              </span>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    size="sm"
                    variant="ghost"
                    className="text-gray-500 hover:bg-purple-50 rounded-full"
                  >
                    <MoreHorizontal className="w-5 h-5" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end" className="w-48">
                  <DropdownMenuItem
                    onClick={() => onAction('edit', suggestion)}
                  >
                    <Edit className="w-4 h-4 ml-2" />
                    <span>{dict.actions.edit}</span>
                  </DropdownMenuItem>
                  <DropdownMenuItem
                    onClick={() => onAction('message', suggestion)}
                  >
                    <MessageCircle className="w-4 h-4 ml-2" />
                    <span>{dict.actions.sendMessage}</span>
                  </DropdownMenuItem>
                  <DropdownMenuItem
                    onClick={() => onAction('delete', suggestion)}
                    className="text-red-600 focus:text-red-600"
                  >
                    <Trash2 className="w-4 h-4 ml-2" />
                    <span>{dict.actions.delete}</span>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  const StatusIcon = statusInfo.icon;
  const PriorityIcon = priorityInfo.icon;
  const canBeResent = [
    'EXPIRED',
    'FIRST_PARTY_DECLINED',
    'SECOND_PARTY_DECLINED',
  ].includes(suggestion.status);

  return (
    <TooltipProvider>
      <Card
        className={cn(
          'overflow-hidden hover:shadow-2xl transition-all duration-500 group border-0 bg-gradient-to-br from-white via-gray-50/30 to-purple-50/20',
          className
        )}
      >
        <div
          className={cn(
            'p-6 border-b relative overflow-hidden bg-gradient-to-r shadow-lg',
            statusInfo.bgColor
          )}
        >
          <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl"></div>
          <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-white/10 to-transparent rounded-full blur-xl"></div>
          <div className="relative z-10">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3">
                <div
                  className={cn(
                    'p-3 rounded-full shadow-lg group-hover:scale-110 transition-transform bg-white/20 backdrop-blur-sm'
                  )}
                >
                  <StatusIcon className={cn('w-6 h-6', statusInfo.color)} />
                </div>
                <div>
                  <span className="font-bold text-gray-900 text-lg">
                    {statusText.label}
                  </span>
                  <p className="text-sm text-gray-600 mt-1">
                    {statusText.description}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <Badge className={priorityInfo.badgeClass}>
                  <PriorityIcon className="w-4 h-4 ml-2" />
                  {priorityText.label}
                </Badge>
                {daysLeft !== null &&
                  daysLeft <= 3 &&
                  suggestion.status !== 'EXPIRED' && (
                    <Badge className="bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-xl animate-pulse">
                      <Clock className="w-3 h-3 ml-1" />
                      {daysLeft === 0
                        ? dict.deadline.lastDay
                        : dict.deadline.daysLeft.replace(
                            '{{count}}',
                            daysLeft.toString()
                          )}
                    </Badge>
                  )}
              </div>
            </div>
            <Progress
              value={statusInfo.progress}
              className="h-3 bg-white/30 shadow-inner"
            />
          </div>
        </div>
        <div className="p-6 space-y-6">
          <MatchmakerInfo dict={dict.matchmakerInfo} matchmaker={matchmaker} />
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-4 p-5 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl border border-blue-100 shadow-lg hover:shadow-xl transition-all duration-300">
              <PartyDisplay party={firstParty} />
              <div className="flex flex-wrap items-stretch gap-3 text-sm">
                {firstParty.profile?.occupation && (
                  <div className="flex-1 min-w-[120px] flex items-start gap-2 p-2 bg-white/70 rounded-lg shadow-sm">
                    <Briefcase className="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0" />
                    <span className="font-medium text-gray-700">
                      {firstParty.profile.occupation}
                    </span>
                  </div>
                )}
                {firstParty.profile?.education && (
                  <div className="flex-1 min-w-[120px] flex items-start gap-2 p-2 bg-white/70 rounded-lg shadow-sm">
                    <GraduationCap className="w-4 h-4 text-purple-500 mt-0.5 flex-shrink-0" />
                    <span className="font-medium text-gray-700">
                      {firstParty.profile.education}
                    </span>
                  </div>
                )}
              </div>
              {(suggestion.status === 'FIRST_PARTY_APPROVED' ||
                suggestion.status === 'FIRST_PARTY_DECLINED') && (
                <Badge
                  className={
                    suggestion.status === 'FIRST_PARTY_APPROVED'
                      ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-lg'
                      : 'bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-lg'
                  }
                >
                  {suggestion.status === 'FIRST_PARTY_APPROVED' ? (
                    <>
                      <CheckCircle className="w-4 h-4 ml-2" />
                      {dict.desktop.partyStatus.approved}
                    </>
                  ) : (
                    <>
                      <XCircle className="w-4 h-4 ml-2" />
                      {dict.desktop.partyStatus.declined}
                    </>
                  )}
                </Badge>
              )}
            </div>
            <div className="space-y-4 p-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl border border-purple-100 shadow-lg hover:shadow-xl transition-all duration-300">
              <PartyDisplay party={secondParty} />
              <div className="flex flex-wrap items-stretch gap-3 text-sm">
                {secondParty.profile?.occupation && (
                  <div className="flex-1 min-w-[120px] flex items-start gap-2 p-2 bg-white/70 rounded-lg shadow-sm">
                    <Briefcase className="w-4 h-4 text-purple-500 mt-0.5 flex-shrink-0" />
                    <span className="font-medium text-gray-700">
                      {secondParty.profile.occupation}
                    </span>
                  </div>
                )}
                {secondParty.profile?.education && (
                  <div className="flex-1 min-w-[120px] flex items-start gap-2 p-2 bg-white/70 rounded-lg shadow-sm">
                    <GraduationCap className="w-4 h-4 text-pink-500 mt-0.5 flex-shrink-0" />
                    <span className="font-medium text-gray-700">
                      {secondParty.profile.education}
                    </span>
                  </div>
                )}
              </div>
              {(suggestion.status === 'SECOND_PARTY_APPROVED' ||
                suggestion.status === 'SECOND_PARTY_DECLINED') && (
                <Badge
                  className={
                    suggestion.status === 'SECOND_PARTY_APPROVED'
                      ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-lg'
                      : 'bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-lg'
                  }
                >
                  {suggestion.status === 'SECOND_PARTY_APPROVED' ? (
                    <>
                      <CheckCircle className="w-4 h-4 ml-2" />
                      {dict.desktop.partyStatus.approved}
                    </>
                  ) : (
                    <>
                      <XCircle className="w-4 h-4 ml-2" />
                      {dict.desktop.partyStatus.declined}
                    </>
                  )}
                </Badge>
              )}
            </div>
          </div>
          <div className="p-5 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-2xl border border-cyan-100 shadow-lg">
            <h4 className="font-bold text-lg mb-3 text-cyan-800 flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-cyan-500" />
              {dict.desktop.connectionPoints}
            </h4>
            <div className="flex flex-wrap gap-2">
              {highlights.map((highlight, index) => (
                <HighlightPill
                  key={index}
                  icon={highlight.icon}
                  text={highlight.text}
                  color={highlight.color}
                />
              ))}
            </div>
          </div>
          {suggestion.matchingReason && (
            <div className="p-5 bg-gradient-to-r from-emerald-50 to-green-50 rounded-2xl border border-emerald-100 shadow-lg">
              <h5 className="text-sm font-bold text-emerald-700 mb-2 flex items-center gap-2">
                <Quote className="w-4 h-4" />
                {dict.desktop.matchReasonTitle}
              </h5>
              <p className="text-emerald-800 leading-relaxed font-medium">
                {suggestion.matchingReason}
              </p>
            </div>
          )}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div className="flex items-center gap-2 p-3 bg-gray-50 rounded-xl shadow-sm">
              <Clock className="w-4 h-4 text-gray-500" />
              <div>
                <p className="font-medium text-gray-600">
                  {dict.desktop.timeline.created}
                </p>
                <p className="text-gray-800">
                  {formatDistanceToNow(new Date(suggestion.createdAt), {
                    addSuffix: true,
                    locale: he,
                  })}
                </p>
              </div>
            </div>
            {suggestion.decisionDeadline && (
              <div className="flex items-center gap-2 p-3 bg-orange-50 rounded-xl shadow-sm">
                <CalendarClock className="w-4 h-4 text-orange-500" />
                <div>
                  <p className="font-medium text-orange-600">
                    {dict.desktop.timeline.deadline}
                  </p>
                  <p className="text-orange-800">
                    {daysLeft !== null
                      ? daysLeft === 0
                        ? dict.deadline.today
                        : dict.deadline.decisionInDays.replace(
                            '{{count}}',
                            daysLeft.toString()
                          )
                      : dict.deadline.noDeadline}
                  </p>
                </div>
              </div>
            )}
            <div className="flex items-center gap-2 p-3 bg-blue-50 rounded-xl shadow-sm">
              <TrendingUp className="w-4 h-4 text-blue-500" />
              <div>
                <p className="font-medium text-blue-600">
                  {dict.desktop.timeline.progress}
                </p>
                <p className="text-blue-800">
                  {dict.desktop.timeline.progressCompleted.replace(
                    '{{percent}}',
                    statusInfo.progress.toString()
                  )}
                </p>
              </div>
            </div>
          </div>
          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
            <div className="flex items-center gap-2">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onAction('message', suggestion)}
                className="text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-xl font-medium"
              >
                <MessageCircle className="w-4 h-4 ml-2" />
                {dict.actions.sendMessage}
              </Button>
              {canBeResent && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onAction('resend', suggestion)}
                  className="text-green-600 hover:text-green-700 hover:bg-green-50 rounded-xl font-medium"
                >
                  <RefreshCw className="w-4 h-4 ml-2" />
                  {dict.actions.resend}
                </Button>
              )}
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="default"
                size="sm"
                onClick={() => onAction('view', suggestion)}
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-medium"
              >
                <Eye className="w-4 h-4 ml-2" />
                {dict.actions.viewDetails}
              </Button>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    size="sm"
                    variant="ghost"
                    className="px-2 hover:bg-gray-100 rounded-xl"
                  >
                    <MoreHorizontal className="w-4 h-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end" className="w-48">
                  <DropdownMenuItem
                    onClick={() => onAction('edit', suggestion)}
                  >
                    <Edit className="w-4 h-4 ml-2" />
                    <span>{dict.actions.edit}</span>
                  </DropdownMenuItem>
                  {canBeResent && (
                    <DropdownMenuItem
                      onClick={() => onAction('resend', suggestion)}
                    >
                      <RefreshCw className="w-4 h-4 ml-2" />
                      <span>{dict.actions.resend}</span>
                    </DropdownMenuItem>
                  )}
                  <DropdownMenuItem
                    onClick={() => onAction('delete', suggestion)}
                    className="text-red-600 focus:text-red-600 focus:bg-red-50"
                  >
                    <Trash2 className="w-4 h-4 ml-2" />
                    <span>{dict.actions.delete}</span>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </div>
      </Card>
    </TooltipProvider>
  );
};

export default SuggestionCard;
--- End of Content for SuggestionCard.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\container
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\container\MatchmakerDashboard.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { useSession } from 'next-auth/react';
import { useParams } from 'next/navigation';
import type {
  SuggestionsDictionary,
  MatchmakerPageDictionary,
  ProfilePageDictionary,
} from '@/types/dictionary';
import {
  Plus,
  RefreshCw,
  BarChart,
  Loader2,
  List,
  Archive,
  LayoutGrid,
  Filter,
  Search,
  TrendingUp,
  Users,
  Clock,
  Heart,
  Sparkles,
  Target,
  Crown,
  MessageCircle,
} from 'lucide-react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';
import { toast } from 'sonner';
import { MatchSuggestionStatus, Priority } from '@prisma/client';
import { cn } from '@/lib/utils';

// Type imports
import type {
  Suggestion,
  SuggestionFilters,
  ActionAdditionalData,
} from '@/types/suggestions';
import type { NewSuggestionFormData } from '../../suggestions/NewSuggestionForm/schema';

// Hooks
import { useCandidates } from '../../new/hooks/useCandidates';

// Components
import NewSuggestionForm from '../../suggestions/NewSuggestionForm';
import SuggestionActionBar from './SuggestionActionBar';
import SuggestionDetailsDialog from '../details/SuggestionDetailsDialog';
import SuggestionCard from '../cards/SuggestionCard';
import EditSuggestionForm from '../EditSuggestionForm';
import MessageForm from '../MessageForm';
import MonthlyTrendModal from './MonthlyTrendModal';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Input } from '@/components/ui/input';

// Media query hook
const useMediaQuery = (query: string) => {
  const [matches, setMatches] = useState(false);
  useEffect(() => {
    if (typeof window === 'undefined') return;
    const media = window.matchMedia(query);
    if (media.matches !== matches) {
      setMatches(media.matches);
    }
    const listener = () => setMatches(media.matches);
    window.addEventListener('resize', listener);
    return () => window.removeEventListener('resize', listener);
  }, [matches, query]);
  return matches;
};

// Enhanced Hero Section Component
const MatchmakerHeroSection: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['heroSection'];
  onNewSuggestion: () => void;
  onRefresh: () => void;
  isRefreshing: boolean;
  stats: {
    total: number;
    pending: number;
    active: number;
    success: number;
    thisMonth: number;
    successRate: number;
  };
}> = ({ dict, onNewSuggestion, onRefresh, isRefreshing, stats }) => {
  return (
    <div className="relative min-h-[400px] bg-gradient-to-br from-purple-50 via-cyan-50/30 to-emerald-50/20 overflow-hidden rounded-3xl shadow-2xl mb-8">
      <div className="absolute inset-0">
        <div className="absolute top-10 right-10 w-64 h-64 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-3xl animate-float"></div>
        <div
          className="absolute bottom-10 left-10 w-48 h-48 bg-gradient-to-br from-cyan-200/30 to-blue-200/30 rounded-full blur-2xl animate-float"
          style={{ animationDelay: '2s' }}
        ></div>
        <div
          className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-gradient-to-br from-emerald-200/20 to-green-200/20 rounded-full blur-3xl animate-float"
          style={{ animationDelay: '4s' }}
        ></div>
      </div>

      <div className="relative z-10 p-8 lg:p-12">
        <div className="text-center mb-8">
          <div className="inline-flex items-center gap-3 mb-6">
            <div className="p-4 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
              <Crown className="w-10 h-10" />
            </div>
          </div>
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4">
            {dict.title}
          </h1>
          <p className="text-xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
            {dict.subtitle}
          </p>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <Card className="border-0 shadow-lg bg-white/80 backdrop-blur-sm hover:shadow-xl transition-all duration-300 group">
            <CardContent className="p-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                  <Users className="w-5 h-5" />
                </div>
                <span className="text-2xl font-bold text-blue-600">
                  {stats.total}
                </span>
              </div>
              <p className="text-sm text-gray-600 font-medium">
                {dict.totalSuggestions}
              </p>
            </CardContent>
          </Card>
          <Card className="border-0 shadow-lg bg-white/80 backdrop-blur-sm hover:shadow-xl transition-all duration-300 group">
            <CardContent className="p-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <div className="p-2 rounded-full bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                  <Clock className="w-5 h-5" />
                </div>
                <span className="text-2xl font-bold text-orange-600">
                  {stats.pending}
                </span>
              </div>
              <p className="text-sm text-gray-600 font-medium">
                {dict.pendingResponse}
              </p>
            </CardContent>
          </Card>
          <Card className="border-0 shadow-lg bg-white/80 backdrop-blur-sm hover:shadow-xl transition-all duration-300 group">
            <CardContent className="p-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                  <Heart className="w-5 h-5" />
                </div>
                <span className="text-2xl font-bold text-green-600">
                  {stats.success}
                </span>
              </div>
              <p className="text-sm text-gray-600 font-medium">
                {dict.successfulMatches}
              </p>
            </CardContent>
          </Card>
          <Card className="border-0 shadow-lg bg-white/80 backdrop-blur-sm hover:shadow-xl transition-all duration-300 group">
            <CardContent className="p-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg group-hover:scale-110 transition-transform">
                  <TrendingUp className="w-5 h-5" />
                </div>
                <span className="text-2xl font-bold text-purple-600">
                  {stats.successRate}%
                </span>
              </div>
              <p className="text-sm text-gray-600 font-medium">
                {dict.successRate}
              </p>
            </CardContent>
          </Card>
        </div>
        <div className="flex flex-col md:flex-row items-center justify-center gap-4">
          <Button
            onClick={onNewSuggestion}
            size="lg"
            className="bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 hover:from-purple-700 hover:via-pink-700 hover:to-blue-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-2xl px-8 py-4 font-bold text-lg transform hover:scale-105"
          >
            <Plus className="w-6 h-6 ml-3" />
            {dict.newSuggestionButton}
            <Sparkles className="w-5 h-5 mr-2" />
          </Button>
          <Button
            variant="outline"
            size="lg"
            onClick={onRefresh}
            disabled={isRefreshing}
            className="border-2 border-purple-300 text-purple-600 hover:bg-purple-50 shadow-lg hover:shadow-xl transition-all duration-300 rounded-2xl px-6 py-4 font-bold text-lg transform hover:scale-105"
          >
            <RefreshCw
              className={cn('w-5 h-5 ml-2', isRefreshing && 'animate-spin')}
            />
            {isRefreshing ? dict.refreshingButton : dict.refreshButton}
          </Button>
        </div>
      </div>
    </div>
  );
};

// Payload types
interface SuggestionUpdatePayload {
  suggestionId: string;
  updates: {
    priority?: Priority;
    status?: MatchSuggestionStatus;
    statusNotes?: string;
    matchingReason?: string;
    firstPartyNotes?: string;
    secondPartyNotes?: string;
    internalNotes?: string;
    decisionDeadline?: Date;
  };
}

interface SendMessagePayload {
  suggestionId: string;
  partyType: 'first' | 'second' | 'both';
  messageType: 'message' | 'reminder' | 'update';
  messageContent: string;
}

type DialogActionData = {
  suggestionId?: string;
  newStatus?: MatchSuggestionStatus;
  notes?: string;
  suggestion?: Suggestion;
  partyType?: 'first' | 'second' | 'both';
  type?: string;
};

type ConfirmActionData = {
  suggestionId: string;
  partyType?: 'first' | 'second' | 'both';
  type?: string;
};

type SuggestionCardActionType =
  | 'view'
  | 'contact'
  | 'message'
  | 'edit'
  | 'delete'
  | 'resend'
  | 'changeStatus'
  | 'reminder';

type SuggestionDetailsActionType =
  | SuggestionCardActionType
  | 'sendReminder'
  | 'shareContacts'
  | 'scheduleMeeting'
  | 'viewMeetings'
  | 'exportHistory'
  | 'export'
  | 'resendToAll';

interface MatchmakerDashboardProps {
  suggestionsDict: SuggestionsDictionary;
  matchmakerDict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

export default function MatchmakerDashboard({
  suggestionsDict,
  matchmakerDict,
  profileDict,
}: MatchmakerDashboardProps) {
  const params = useParams();
  const locale = (
    Array.isArray(params.lang) ? params.lang[0] : params.lang || 'en'
  ) as 'he' | 'en';

  const dashboardDict = matchmakerDict.suggestionsDashboard;
  const toastsDict = dashboardDict.toasts;

  const isMobile = useMediaQuery('(max-width: 768px)');
  const [mobileView, setMobileView] = useState<'list' | 'kanban'>('list');
  const [showMobileFilters, setShowMobileFilters] = useState(false);
  const { data: session } = useSession();

  const [activeTab, setActiveTab] = useState('pending');
  const [showNewSuggestion, setShowNewSuggestion] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filters, setFilters] = useState<SuggestionFilters>({});
  const [suggestions, setSuggestions] = useState<Suggestion[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [selectedSuggestion, setSelectedSuggestion] =
    useState<Suggestion | null>(null);
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [confirmAction, setConfirmAction] = useState<{
    type: string;
    data: ConfirmActionData;
  } | null>(null);
  const [showEditForm, setShowEditForm] = useState(false);
  const [showMessageForm, setShowMessageForm] = useState(false);
  const [showMonthlyTrendDialog, setShowMonthlyTrendDialog] = useState(false);

  const { candidates: allCandidates } = useCandidates();

  const fetchSuggestions = useCallback(async () => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/matchmaker/suggestions');
      if (!response.ok) throw new Error('Failed to fetch suggestions');
      const data = await response.json();
      setSuggestions(data);
    } catch (error: unknown) {
      console.error('Error fetching suggestions:', error);
      toast.error(toastsDict.loadError);
    } finally {
      setIsLoading(false);
    }
  }, [toastsDict.loadError]);

  useEffect(() => {
    fetchSuggestions();
  }, [fetchSuggestions]);

  const filteredSuggestions = useMemo(() => {
    return suggestions.filter((s) => {
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        const match =
          (s.firstParty.firstName + ' ' + s.firstParty.lastName)
            .toLowerCase()
            .includes(query) ||
          (s.secondParty.firstName + ' ' + s.secondParty.lastName)
            .toLowerCase()
            .includes(query) ||
          (s.firstParty.profile?.city &&
            s.firstParty.profile.city.toLowerCase().includes(query)) ||
          (s.secondParty.profile?.city &&
            s.secondParty.profile.city.toLowerCase().includes(query));
        if (!match) return false;
      }
      if (filters.priority?.length && !filters.priority.includes(s.priority))
        return false;
      if (filters.status?.length && !filters.status.includes(s.status))
        return false;
      if (filters.dateRange) {
        const createdAt = new Date(s.createdAt);
        if (
          createdAt < filters.dateRange.start ||
          (filters.dateRange.end && createdAt > filters.dateRange.end)
        )
          return false;
      }
      return true;
    });
  }, [suggestions, searchQuery, filters]);

  const pendingSuggestions = useMemo(
    () => filteredSuggestions.filter((s) => s.category === 'PENDING'),
    [filteredSuggestions]
  );
  const activeSuggestions = useMemo(
    () => filteredSuggestions.filter((s) => s.category === 'ACTIVE'),
    [filteredSuggestions]
  );
  const historySuggestions = useMemo(
    () => filteredSuggestions.filter((s) => s.category === 'HISTORY'),
    [filteredSuggestions]
  );

  const pendingCount = pendingSuggestions.length;
  const activeCount = activeSuggestions.length;
  const historyCount = historySuggestions.length;

  const handleRefresh = async () => {
    setIsRefreshing(true);
    await fetchSuggestions();
    setIsRefreshing(false);
    toast.success(toastsDict.refreshSuccess);
  };

  const handleNewSuggestion = async (data: NewSuggestionFormData) => {
    setIsSubmitting(true);
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        }
      );

      if (!response.ok)
        throw new Error(
          (await response.json()).error || 'Failed to create suggestion'
        );
      setShowNewSuggestion(false);
      toast.success(toastsDict.createSuccess);
      await fetchSuggestions();
    } catch (error: unknown) {
      console.error('Error creating suggestion:', error);
      toast.error(
        `${toastsDict.createError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSuggestionDeleted = useCallback(
    (deletedId: string) => {
      setSuggestions((prev) => prev.filter((s) => s.id !== deletedId));
      if (selectedSuggestion?.id === deletedId) setSelectedSuggestion(null);
    },
    [selectedSuggestion]
  );

  const handleConfirmAction = async () => {
    if (!confirmAction) return;
    try {
      if (confirmAction.type === 'delete') {
        const response = await fetch(
          `/api/matchmaker/suggestions/${confirmAction.data.suggestionId}/delete`,
          { method: 'DELETE' }
        );
        if (!response.ok) throw new Error('Failed to delete suggestion');
        handleSuggestionDeleted(confirmAction.data.suggestionId);
        toast.success(toastsDict.deleteSuccess);
      }
    } catch (error: unknown) {
      console.error('Error: ', error);
      toast.error(toastsDict.deleteError);
    } finally {
      setShowConfirmDialog(false);
      setConfirmAction(null);
    }
  };

  const handleStatusChange = async (
    suggestionId: string,
    newStatus: MatchSuggestionStatus,
    notes?: string
  ) => {
    setIsSubmitting(true);
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions/${suggestionId}/status`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            status: newStatus,
            notes: notes || `סטטוס שונה מממשק ניהול`,
          }),
        }
      );
      if (!response.ok)
        throw new Error(
          (await response.json()).error || 'Failed to update status'
        );
      toast.success(toastsDict.statusUpdateSuccess);
      fetchSuggestions();
    } catch (error: unknown) {
      console.error('Error updating suggestion status:', error);
      toast.error(
        `${toastsDict.statusUpdateError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleUpdateSuggestion = async ({
    suggestionId,
    updates,
  }: SuggestionUpdatePayload) => {
    setIsSubmitting(true);
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions/${suggestionId}`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to update suggestion');
      }

      toast.success(toastsDict.updateSuccess);
      setShowEditForm(false);
      await fetchSuggestions();
    } catch (error) {
      console.error('Error updating suggestion:', error);
      toast.error(
        `${toastsDict.updateError}: ${
          error instanceof Error ? error.message : 'שגיאה לא ידועה'
        }`
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSendMessage = async (data: SendMessagePayload) => {
    setIsSubmitting(true);
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions/${data.suggestionId}/message?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            partyType: data.partyType,
            customMessage: data.messageContent,
            channels: ['email', 'whatsapp'],
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to send message');
      }

      toast.success(toastsDict.messageSentSuccess);
      setShowMessageForm(false);
    } catch (error: unknown) {
      console.error('Error sending message:', error);
      toast.error(
        `${toastsDict.messageSentError}: ${
          error instanceof Error ? error.message : 'שגיאה לא ידועה'
        }`
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDialogAction = (
    action: SuggestionDetailsActionType,
    data?: DialogActionData
  ) => {
    setSelectedSuggestion(data?.suggestion || null);
    if (action === 'view' && data?.suggestion) {
      setSelectedSuggestion(data.suggestion);
    } else if (action === 'delete' && data?.suggestionId) {
      setConfirmAction({
        type: 'delete',
        data: { suggestionId: data.suggestionId },
      });
      setShowConfirmDialog(true);
    } else if (action === 'edit' && data?.suggestion) {
      setShowEditForm(true);
    } else if (action === 'message' && data?.suggestion) {
      setShowMessageForm(true);
    } else if (
      action === 'changeStatus' &&
      data?.suggestionId &&
      data.newStatus
    ) {
      handleStatusChange(data.suggestionId, data.newStatus, data.notes);
    }
  };

  const handleSuggestionAction = (
    type: SuggestionCardActionType,
    suggestion: Suggestion,
    additionalData?: ActionAdditionalData
  ) => {
    handleDialogAction(type, {
      ...additionalData,
      suggestionId: suggestion.id,
      suggestion,
    });
  };

  const kanbanColumns = useMemo(() => {
    const columns: {
      [key: string]: {
        title: string;
        suggestions: Suggestion[];
        color: string;
        icon: React.ElementType;
      };
    } = {
      requiresAction: {
        title: dashboardDict.kanban.requiresAction,
        suggestions: [],
        color: 'from-red-500 to-orange-500',
        icon: Clock,
      },
      pendingResponse: {
        title: dashboardDict.kanban.pendingResponse,
        suggestions: [],
        color: 'from-yellow-500 to-amber-500',
        icon: MessageCircle,
      },
      inProgress: {
        title: dashboardDict.kanban.inProgress,
        suggestions: [],
        color: 'from-green-500 to-emerald-500',
        icon: Target,
      },
      history: {
        title: dashboardDict.kanban.history,
        suggestions: [],
        color: 'from-gray-500 to-slate-500',
        icon: Archive,
      },
    };

    for (const suggestion of filteredSuggestions) {
      if (suggestion.category === 'HISTORY') {
        columns.history.suggestions.push(suggestion);
      } else if (
        ['PENDING_FIRST_PARTY', 'PENDING_SECOND_PARTY'].includes(
          suggestion.status
        )
      ) {
        columns.requiresAction.suggestions.push(suggestion);
      } else if (suggestion.status.includes('APPROVED')) {
        columns.pendingResponse.suggestions.push(suggestion);
      } else if (suggestion.category === 'ACTIVE') {
        columns.inProgress.suggestions.push(suggestion);
      }
    }

    return Object.values(columns);
  }, [filteredSuggestions, dashboardDict.kanban]);

  const heroStats = useMemo(() => {
    const total = suggestions.length;
    const pending = suggestions.filter(
      (s) =>
        s.status === 'PENDING_FIRST_PARTY' ||
        s.status === 'PENDING_SECOND_PARTY'
    ).length;
    const active = suggestions.filter(
      (s) =>
        !['CLOSED', 'CANCELLED', 'EXPIRED', 'MARRIED', 'ENGAGED'].includes(
          s.status
        )
    ).length;
    const success = suggestions.filter((s) =>
      ['MARRIED', 'ENGAGED', 'DATING'].includes(s.status)
    ).length;
    const thisMonth = suggestions.filter((s) => {
      const created = new Date(s.createdAt);
      const now = new Date();
      return (
        created.getMonth() === now.getMonth() &&
        created.getFullYear() === now.getFullYear()
      );
    }).length;
    const successRate = total > 0 ? Math.round((success / total) * 100) : 0;
    return { total, pending, active, success, thisMonth, successRate };
  }, [suggestions]);

  const renderMobileFilters = () => (
    <Sheet open={showMobileFilters} onOpenChange={setShowMobileFilters}>
      <SheetTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="bg-white/80 backdrop-blur-sm shadow-lg"
        >
          <Filter className="w-4 h-4 mr-2" />
          {dashboardDict.mobile.filter}
        </Button>
      </SheetTrigger>
      <SheetContent className="w-full">
        <SheetHeader>
          <SheetTitle>{dashboardDict.mobile.filter}</SheetTitle>
        </SheetHeader>
        <div className="py-4">
          <SuggestionActionBar
            searchQuery={searchQuery}
            onSearchChange={setSearchQuery}
            filters={filters}
            onFiltersChange={setFilters}
            totalCount={suggestions.length}
            activeCount={activeCount}
            pendingCount={pendingCount}
            historyCount={historyCount}
            dict={dashboardDict.actionBar}
          />
        </div>
      </SheetContent>
    </Sheet>
  );

  const renderMobileView = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50/20 to-emerald-50/20 flex flex-col">
      <div className="p-4">
        <MatchmakerHeroSection
          dict={dashboardDict.heroSection}
          onNewSuggestion={() => setShowNewSuggestion(true)}
          onRefresh={handleRefresh}
          isRefreshing={isRefreshing}
          stats={heroStats}
        />
      </div>
      <div className="flex items-center justify-between p-4 bg-white/80 backdrop-blur-sm border-b sticky top-0 z-10 shadow-lg">
        <div className="relative flex-1">
          <Search className="absolute right-3 top-2.5 h-4 w-4 text-gray-400" />
          <Input
            placeholder={dashboardDict.mobile.searchPlaceholder}
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="pl-10 text-right pr-10 bg-white/90 shadow-sm border-purple-200 focus:border-purple-400"
          />
        </div>
        <div className="mr-2">{renderMobileFilters()}</div>
        <ToggleGroup
          type="single"
          value={mobileView}
          onValueChange={(value: 'list' | 'kanban') =>
            value && setMobileView(value)
          }
          className="mr-2"
        >
          <ToggleGroupItem
            value="list"
            aria-label={dashboardDict.mobile.list}
            className="data-[state=on]:bg-purple-100 data-[state=on]:text-purple-700"
          >
            <List className="h-4 w-4" />
          </ToggleGroupItem>
          <ToggleGroupItem
            value="kanban"
            aria-label={dashboardDict.mobile.kanban}
            className="data-[state=on]:bg-purple-100 data-[state=on]:text-purple-700"
          >
            <LayoutGrid className="h-4 w-4" />
          </ToggleGroupItem>
        </ToggleGroup>
      </div>
      {isLoading ? (
        <div className="flex-1 flex items-center justify-center p-8">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin text-purple-600 mx-auto mb-4" />
            <p className="text-lg font-semibold text-gray-700">
              {dashboardDict.mainContent.loadingText}
            </p>
          </div>
        </div>
      ) : mobileView === 'kanban' ? (
        <ScrollArea className="w-full whitespace-nowrap flex-1">
          <div className="flex gap-4 p-4 h-full">
            {kanbanColumns.map((col, idx) => {
              const IconComponent = col.icon;
              return (
                <div
                  key={idx}
                  className="w-72 flex-shrink-0 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl flex flex-col border border-gray-200"
                >
                  <div
                    className={cn(
                      'p-4 font-semibold text-sm border-b sticky top-0 bg-gradient-to-r text-white rounded-t-2xl z-10 shadow-lg',
                      col.color
                    )}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <IconComponent className="w-5 h-5" />
                        <span>{col.title}</span>
                      </div>
                      <Badge
                        variant="secondary"
                        className="bg-white/20 text-white border-white/30"
                      >
                        {col.suggestions.length}
                      </Badge>
                    </div>
                  </div>
                  <ScrollArea className="flex-1 p-3">
                    <div className="space-y-3">
                      {col.suggestions.length > 0 ? (
                        col.suggestions.map((s) => (
                          <SuggestionCard
                            key={s.id}
                            suggestion={s}
                            onAction={handleSuggestionAction}
                            variant="compact"
                            className="shadow-lg hover:shadow-xl transition-all duration-300"
                            dict={dashboardDict.suggestionCard}
                          />
                        ))
                      ) : (
                        <div className="p-6 text-center text-sm text-gray-500 bg-gray-50 rounded-xl">
                          <IconComponent className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                          <p>{dashboardDict.kanban.noSuggestions}</p>
                        </div>
                      )}
                    </div>
                  </ScrollArea>
                </div>
              );
            })}
          </div>
        </ScrollArea>
      ) : (
        <ScrollArea className="flex-1">
          <div className="p-4 space-y-4">
            {filteredSuggestions.map((s) => (
              <SuggestionCard
                key={s.id}
                suggestion={s}
                onAction={handleSuggestionAction}
                variant="full"
                className="shadow-lg hover:shadow-xl transition-all duration-300"
                dict={dashboardDict.suggestionCard}
              />
            ))}
            {filteredSuggestions.length === 0 && (
              <div className="text-center p-12">
                <div className="w-24 h-24 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center mx-auto mb-6">
                  <Users className="w-12 h-12 text-purple-400" />
                </div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">
                  {dashboardDict.mobile.noMatches.title}
                </h3>
                <p className="text-gray-600">
                  {dashboardDict.mobile.noMatches.description}
                </p>
              </div>
            )}
          </div>
        </ScrollArea>
      )}
      <div className="p-4 bg-white/80 backdrop-blur-sm border-t sticky bottom-0">
        <Button
          onClick={() => setShowNewSuggestion(true)}
          className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-xl text-lg py-6 rounded-2xl"
        >
          <Plus className="w-6 h-6 mr-3" />
          {dashboardDict.mobile.newSuggestionButton}
          <Sparkles className="w-5 h-5 ml-2" />
        </Button>
      </div>
    </div>
  );

  const renderDesktopView = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50/20 to-emerald-50/20">
      <div className="container mx-auto p-6 space-y-8">
        <MatchmakerHeroSection
          dict={dashboardDict.heroSection}
          onNewSuggestion={() => setShowNewSuggestion(true)}
          onRefresh={handleRefresh}
          isRefreshing={isRefreshing}
          stats={heroStats}
        />
        <Card className="shadow-2xl border-0 bg-white/95 backdrop-blur-sm overflow-hidden rounded-3xl">
          <div className="bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 border-b border-purple-100 p-6">
            <Tabs value={activeTab} onValueChange={setActiveTab}>
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-3">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowMonthlyTrendDialog(true)}
                    className="border-purple-200 hover:bg-purple-50 text-purple-600"
                  >
                    <BarChart className="w-4 h-4 mr-2" />
                    {dashboardDict.mainContent.monthlyTrendButton}
                  </Button>
                </div>
                <TabsList className="bg-purple-50/50 rounded-2xl p-1 h-14">
                  <TabsTrigger
                    value="pending"
                    className="flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                  >
                    <Clock className="w-5 h-5 text-orange-500" />
                    <span>{dashboardDict.mainContent.tabs.pending}</span>
                    {pendingCount > 0 && (
                      <Badge className="bg-orange-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6">
                        {pendingCount}
                      </Badge>
                    )}
                  </TabsTrigger>
                  <TabsTrigger
                    value="active"
                    className="flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                  >
                    <Target className="w-5 h-5 text-green-500" />
                    <span>{dashboardDict.mainContent.tabs.active}</span>
                    {activeCount > 0 && (
                      <Badge className="bg-green-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6">
                        {activeCount}
                      </Badge>
                    )}
                  </TabsTrigger>
                  <TabsTrigger
                    value="history"
                    className="flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                  >
                    <Archive className="w-5 h-5 text-gray-500" />
                    <span>{dashboardDict.mainContent.tabs.history}</span>
                    {historyCount > 0 && (
                      <Badge className="bg-gray-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6">
                        {historyCount}
                      </Badge>
                    )}
                  </TabsTrigger>
                </TabsList>
              </div>
              <SuggestionActionBar
                searchQuery={searchQuery}
                onSearchChange={setSearchQuery}
                filters={filters}
                onFiltersChange={setFilters}
                totalCount={suggestions.length}
                activeCount={activeCount}
                pendingCount={pendingCount}
                historyCount={historyCount}
                dict={dashboardDict.actionBar}
              />
              {isLoading ? (
                <div className="flex items-center justify-center h-64">
                  <div className="text-center">
                    <Loader2 className="w-12 h-12 animate-spin text-purple-600 mx-auto mb-4" />
                    <p className="text-lg font-semibold text-gray-700">
                      {dashboardDict.mainContent.loadingText}
                    </p>
                  </div>
                </div>
              ) : (
                <>
                  <TabsContent value="pending" className="mt-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {pendingSuggestions.map((suggestion) => (
                        <div key={suggestion.id} className="animate-fade-in-up">
                          <SuggestionCard
                            suggestion={suggestion}
                            onAction={handleSuggestionAction}
                            className="shadow-lg hover:shadow-xl transition-all duration-300"
                            dict={dashboardDict.suggestionCard}
                          />
                        </div>
                      ))}
                    </div>
                    {pendingSuggestions.length === 0 && (
                      <div className="text-center p-12">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center mx-auto mb-6">
                          <Clock className="w-12 h-12 text-orange-400" />
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          {dashboardDict.mainContent.emptyStates.pending.title}
                        </h3>
                        <p className="text-gray-600">
                          {
                            dashboardDict.mainContent.emptyStates.pending
                              .description
                          }
                        </p>
                      </div>
                    )}
                  </TabsContent>
                  <TabsContent value="active" className="mt-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {activeSuggestions.map((suggestion) => (
                        <div key={suggestion.id} className="animate-fade-in-up">
                          <SuggestionCard
                            suggestion={suggestion}
                            onAction={handleSuggestionAction}
                            className="shadow-lg hover:shadow-xl transition-all duration-300"
                            dict={dashboardDict.suggestionCard}
                          />
                        </div>
                      ))}
                    </div>
                    {activeSuggestions.length === 0 && (
                      <div className="text-center p-12">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 flex items-center justify-center mx-auto mb-6">
                          <Target className="w-12 h-12 text-green-400" />
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          {dashboardDict.mainContent.emptyStates.active.title}
                        </h3>
                        <p className="text-gray-600">
                          {
                            dashboardDict.mainContent.emptyStates.active
                              .description
                          }
                        </p>
                      </div>
                    )}
                  </TabsContent>
                  <TabsContent value="history" className="mt-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {historySuggestions.map((suggestion) => (
                        <div key={suggestion.id} className="animate-fade-in-up">
                          <SuggestionCard
                            suggestion={suggestion}
                            onAction={handleSuggestionAction}
                            className="shadow-lg hover:shadow-xl transition-all duration-300"
                            dict={dashboardDict.suggestionCard}
                          />
                        </div>
                      ))}
                    </div>
                    {historySuggestions.length === 0 && (
                      <div className="text-center p-12">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-gray-100 to-slate-100 flex items-center justify-center mx-auto mb-6">
                          <Archive className="w-12 h-12 text-gray-400" />
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                          {dashboardDict.mainContent.emptyStates.history.title}
                        </h3>
                        <p className="text-gray-600">
                          {
                            dashboardDict.mainContent.emptyStates.history
                              .description
                          }
                        </p>
                      </div>
                    )}
                  </TabsContent>
                </>
              )}
            </Tabs>
          </div>
        </Card>
      </div>
    </div>
  );

  return (
    <div className={cn('min-h-screen', isMobile ? 'p-0' : 'p-0')}>
      {isMobile ? renderMobileView() : renderDesktopView()}

      <NewSuggestionForm
        isOpen={showNewSuggestion}
        onClose={() => setShowNewSuggestion(false)}
        candidates={allCandidates}
        onSubmit={handleNewSuggestion}
        locale={locale}
        dict={matchmakerDict}
      />

      <SuggestionDetailsDialog
        suggestion={selectedSuggestion}
        isOpen={!!selectedSuggestion}
        onClose={() => setSelectedSuggestion(null)}
        onAction={handleDialogAction}
        userId={session?.user?.id || ''}
        matchmakerDict={matchmakerDict}
        suggestionsDict={suggestionsDict}
        profileDict={profileDict}
        locale={locale}
      />

      <Dialog
        open={showMonthlyTrendDialog}
        onOpenChange={setShowMonthlyTrendDialog}
      >
        <DialogContent className="max-w-4xl">
          <DialogHeader>
            <DialogTitle>
              {dashboardDict.dialogs.monthlyTrend.title}
            </DialogTitle>
          </DialogHeader>
          <MonthlyTrendModal
            dict={dashboardDict.monthlyTrendModal}
            suggestions={suggestions}
          />
        </DialogContent>
      </Dialog>

      <EditSuggestionForm
        isOpen={showEditForm}
        onClose={() => setShowEditForm(false)}
        suggestion={selectedSuggestion}
        onSave={handleUpdateSuggestion}
        dict={dashboardDict.editSuggestionForm}
      />

      <MessageForm
        isOpen={showMessageForm}
        onClose={() => setShowMessageForm(false)}
        suggestion={selectedSuggestion}
        onSend={handleSendMessage}
        dict={dashboardDict.messageForm}
      />

      {confirmAction && (
        <AlertDialog
          open={showConfirmDialog}
          onOpenChange={setShowConfirmDialog}
        >
          <AlertDialogContent className="border-0 shadow-2xl rounded-2xl">
            <AlertDialogHeader>
              <AlertDialogTitle className="text-xl font-bold text-center">
                {dashboardDict.dialogs.deleteConfirm.title}
              </AlertDialogTitle>
              <AlertDialogDescription className="text-center text-gray-600 leading-relaxed">
                {dashboardDict.dialogs.deleteConfirm.description}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter className="gap-3">
              <AlertDialogCancel className="rounded-xl">
                {dashboardDict.dialogs.deleteConfirm.cancel}
              </AlertDialogCancel>
              <AlertDialogAction
                onClick={handleConfirmAction}
                className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-xl"
              >
                {dashboardDict.dialogs.deleteConfirm.confirm}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      )}
    </div>
  );
}
--- End of Content for MatchmakerDashboard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\container\MonthlyTrendModal.tsx
--------------------------------------------------------------------------------
Content:
import React, { useMemo } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {

  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,

  Area,
  AreaChart,
  PieChart,
  Pie,
  Cell,

} from 'recharts';
import {
  TrendingUp,

  Calendar,
  BarChart3,
  PieChart as PieChartIcon,
  Activity,
  Users,
  Clock,
  Award,
  Target,
  ArrowUp,
  ArrowDown,
  Sparkles,
  Crown,
  Download,
  Eye,
  XCircle,
} from 'lucide-react';
import type { Suggestion } from '@/types/suggestions';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface MonthlyTrendModalProps {
  dict: MatchmakerPageDictionary['suggestionsDashboard']['monthlyTrendModal'];
  suggestions: Suggestion[];
}

interface MonthlyData {
  month: string;
  year: number;
  count: number;
  active: number;
  pending: number;
  success: number;
  declined: number;
}

interface TrendCardProps {
  title: string;
  value: number;
  trend: number;
  icon: React.ElementType;
  gradient: string;
  description: string;
}

const TrendCard: React.FC<TrendCardProps> = ({
  title,
  value,
  trend,
  icon: Icon,
  gradient,
  description,
}) => (
  <Card className="border-0 shadow-xl hover:shadow-2xl transition-all duration-300 group overflow-hidden rounded-2xl">
    <div
      className={cn('absolute inset-0 opacity-5 bg-gradient-to-br', gradient)}
    />
    <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-xl" />

    <CardContent className="relative z-10 p-6">
      <div className="flex items-center justify-between mb-4">
        <div
          className={cn(
            'p-3 rounded-full shadow-lg group-hover:scale-110 transition-transform bg-gradient-to-r text-white',
            gradient
          )}
        >
          <Icon className="w-6 h-6" />
        </div>
        <div
          className={cn(
            'flex items-center gap-1 px-3 py-1 rounded-full text-sm font-bold',
            trend >= 0
              ? 'bg-green-100 text-green-700'
              : 'bg-red-100 text-red-700'
          )}
        >
          {trend >= 0 ? (
            <ArrowUp className="w-3 h-3" />
          ) : (
            <ArrowDown className="w-3 h-3" />
          )}
          {Math.abs(trend)}%
        </div>
      </div>

      <div className="space-y-2">
        <h3 className="text-3xl font-bold text-gray-800">{value}</h3>
        <p className="text-sm font-medium text-gray-600">{title}</p>
        <p className="text-xs text-gray-500 leading-relaxed">{description}</p>
      </div>
    </CardContent>
  </Card>
);

const MonthlyTrendModal: React.FC<MonthlyTrendModalProps> = ({
  dict,
  suggestions,
}) => {
  const monthlyData = useMemo(() => {
    const data = suggestions.reduce(
      (acc, s) => {
        const createdDate = new Date(s.createdAt);
        const month = createdDate.getMonth();
        const year = createdDate.getFullYear();
        const key = `${year}-${month + 1}`;

        if (!acc[key]) {
          acc[key] = {
            month: new Date(year, month).toLocaleString('he', {
              month: 'short',
            }),
            year: year,
            count: 0,
            active: 0,
            pending: 0,
            success: 0,
            declined: 0,
          };
        }

        acc[key].count += 1;
        if (s.category === 'ACTIVE') acc[key].active += 1;
        if (s.category === 'PENDING') acc[key].pending += 1;
        if (['MARRIED', 'ENGAGED'].includes(s.status)) acc[key].success += 1;
        if (
          s.status === 'FIRST_PARTY_DECLINED' ||
          s.status === 'SECOND_PARTY_DECLINED'
        ) {
          acc[key].declined += 1;
        }

        return acc;
      },
      {} as Record<string, MonthlyData>
    );

    return Object.values(data).sort((a, b) => {
      if (a.year !== b.year) return a.year - b.year;
      const monthA = new Date(
        a.year,
        a.month === 'ינו' ? 0 : new Date(`1 ${a.month} 2000`).getMonth()
      ).getMonth();
      const monthB = new Date(
        b.year,
        b.month === 'ינו' ? 0 : new Date(`1 ${b.month} 2000`).getMonth()
      ).getMonth();
      return monthA - monthB;
    });
  }, [suggestions]);

  const trends = useMemo(() => {
    if (monthlyData.length < 2)
      return { active: 0, pending: 0, success: 0, total: 0 };
    const current = monthlyData[monthlyData.length - 1];
    const previous = monthlyData[monthlyData.length - 2];
    const calculateTrend = (current: number, previous: number) => {
      if (previous === 0) return current > 0 ? 100 : 0;
      return Math.round(((current - previous) / previous) * 100);
    };
    return {
      active: calculateTrend(current.active, previous.active),
      pending: calculateTrend(current.pending, previous.pending),
      success: calculateTrend(current.success, previous.success),
      total: calculateTrend(current.count, previous.count),
    };
  }, [monthlyData]);

  const chartData = monthlyData.map((month) => ({
    name: `${month.month} ${month.year}`,
    [dict.charts.legend.active]: month.active,
    [dict.charts.legend.pending]: month.pending,
    [dict.charts.legend.success]: month.success,
    [dict.charts.legend.declined]: month.declined,
  }));

  const pieData =
    monthlyData.length > 0
      ? [
          {
            name: dict.charts.legend.active,
            value: monthlyData[monthlyData.length - 1].active,
            color: '#3B82F6',
          },
          {
            name: dict.charts.legend.pending,
            value: monthlyData[monthlyData.length - 1].pending,
            color: '#F59E0B',
          },
          {
            name: dict.charts.legend.success,
            value: monthlyData[monthlyData.length - 1].success,
            color: '#10B981',
          },
          {
            name: dict.charts.legend.declined,
            value: monthlyData[monthlyData.length - 1].declined,
            color: '#EF4444',
          },
        ]
      : [];

  const COLORS = ['#3B82F6', '#F59E0B', '#10B981', '#EF4444'];

  if (monthlyData.length === 0) {
    return (
      <div className="p-12 text-center">
        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center mx-auto mb-6">
          <BarChart3 className="w-12 h-12 text-purple-400" />
        </div>
        <h3 className="text-xl font-bold text-gray-800 mb-2">
          {dict.emptyState.title}
        </h3>
        <p className="text-gray-600">{dict.emptyState.description}</p>
      </div>
    );
  }

  const currentMonth = monthlyData[monthlyData.length - 1];
  const trendLabel =
    trends.total >= 0
      ? dict.trendCards.trendLabel.increase
      : dict.trendCards.trendLabel.decrease;

  return (
    <div className="space-y-8">
      <div className="relative">
        <div className="absolute inset-0 bg-gradient-to-r from-purple-50 via-cyan-50/30 to-emerald-50/20 rounded-3xl"></div>
        <div className="relative z-10 p-8 text-center">
          <div className="flex items-center justify-center gap-3 mb-4">
            <div className="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl">
              <TrendingUp className="w-8 h-8" />
            </div>
          </div>
          <h2 className="text-3xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-2">
            {dict.header.title}
          </h2>
          <p className="text-gray-600 text-lg">{dict.header.subtitle}</p>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <TrendCard
          title={dict.trendCards.total.title}
          value={currentMonth.count}
          trend={trends.total}
          icon={Users}
          gradient="from-blue-500 to-cyan-500"
          description={dict.trendCards.total.description.replace(
            '{{trend}}',
            trendLabel
          )}
        />
        <TrendCard
          title={dict.trendCards.active.title}
          value={currentMonth.active}
          trend={trends.active}
          icon={Target}
          gradient="from-green-500 to-emerald-500"
          description={dict.trendCards.active.description}
        />
        <TrendCard
          title={dict.trendCards.pending.title}
          value={currentMonth.pending}
          trend={trends.pending}
          icon={Clock}
          gradient="from-yellow-500 to-amber-500"
          description={dict.trendCards.pending.description}
        />
        <TrendCard
          title={dict.trendCards.success.title}
          value={currentMonth.success}
          trend={trends.success}
          icon={Crown}
          gradient="from-purple-500 to-pink-500"
          description={dict.trendCards.success.description}
        />
      </div>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <Card className="border-0 shadow-xl hover:shadow-2xl transition-all duration-300 bg-white overflow-hidden rounded-2xl">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg">
                  <BarChart3 className="w-6 h-6" />
                </div>
                <h3 className="text-xl font-bold text-gray-800">
                  {dict.charts.areaChart.title}
                </h3>
              </div>
              <Badge className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-3 py-1 rounded-full">
                {dict.charts.areaChart.badge.replace(
                  '{{count}}',
                  monthlyData.length.toString()
                )}
              </Badge>
            </div>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={chartData}>
                  <defs>
                    <linearGradient
                      id="colorActive"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#3B82F6" stopOpacity={0} />
                    </linearGradient>
                    <linearGradient
                      id="colorPending"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#F59E0B" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#F59E0B" stopOpacity={0} />
                    </linearGradient>
                    <linearGradient
                      id="colorSuccess"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#10B981" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#10B981" stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="name" stroke="#6b7280" fontSize={12} />
                  <YAxis stroke="#6b7280" fontSize={12} />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
                    }}
                    formatter={(value, name) => [value, name]}
                    labelFormatter={(label) =>
                      dict.charts.tooltip.monthLabel.replace('{{label}}', label)
                    }
                  />
                  <Area
                    type="monotone"
                    dataKey={dict.charts.legend.active}
                    stroke="#3B82F6"
                    fillOpacity={1}
                    fill="url(#colorActive)"
                    strokeWidth={3}
                  />
                  <Area
                    type="monotone"
                    dataKey={dict.charts.legend.pending}
                    stroke="#F59E0B"
                    fillOpacity={1}
                    fill="url(#colorPending)"
                    strokeWidth={3}
                  />
                  <Area
                    type="monotone"
                    dataKey={dict.charts.legend.success}
                    stroke="#10B981"
                    fillOpacity={1}
                    fill="url(#colorSuccess)"
                    strokeWidth={3}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>
        <Card className="border-0 shadow-xl hover:shadow-2xl transition-all duration-300 bg-white overflow-hidden rounded-2xl">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
                  <PieChartIcon className="w-6 h-6" />
                </div>
                <h3 className="text-xl font-bold text-gray-800">
                  {dict.charts.pieChart.title}
                </h3>
              </div>
              <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full">
                {dict.charts.pieChart.badge
                  .replace('{{month}}', currentMonth.month)
                  .replace('{{year}}', currentMonth.year.toString())}
              </Badge>
            </div>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={pieData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) =>
                      `${name} ${(percent * 100).toFixed(0)}%`
                    }
                    outerRadius={100}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {pieData.map((entry, index) => (
                      <Cell
                        key={`cell-${index}`}
                        fill={COLORS[index % COLORS.length]}
                      />
                    ))}
                  </Pie>
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>
      </div>
      <Card className="border-0 shadow-xl bg-white overflow-hidden rounded-2xl">
        <CardContent className="p-6">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-full bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-lg">
                <Activity className="w-6 h-6" />
              </div>
              <h3 className="text-xl font-bold text-gray-800">
                {dict.table.title}
              </h3>
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                className="rounded-xl border-emerald-200 text-emerald-600 hover:bg-emerald-50"
              >
                <Download className="w-4 h-4 ml-2" />
                {dict.table.exportButton}
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="rounded-xl border-blue-200 text-blue-600 hover:bg-blue-50"
              >
                <Eye className="w-4 h-4 ml-2" />
                {dict.table.viewAllButton}
              </Button>
            </div>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-gradient-to-r from-gray-50 to-slate-50">
                  <th className="p-4 text-right font-bold text-gray-800 border-b border-gray-200 rounded-tr-xl">
                    {dict.table.headers.month}
                  </th>
                  <th className="p-4 text-center font-bold text-gray-800 border-b border-gray-200">
                    {dict.table.headers.total}
                  </th>
                  <th className="p-4 text-center font-bold text-gray-800 border-b border-gray-200">
                    {dict.table.headers.active}
                  </th>
                  <th className="p-4 text-center font-bold text-gray-800 border-b border-gray-200">
                    {dict.table.headers.pending}
                  </th>
                  <th className="p-4 text-center font-bold text-gray-800 border-b border-gray-200">
                    {dict.table.headers.success}
                  </th>
                  <th className="p-4 text-center font-bold text-gray-800 border-b border-gray-200 rounded-tl-xl">
                    {dict.table.headers.declined}
                  </th>
                </tr>
              </thead>
              <tbody>
                {monthlyData
                  .slice()
                  .reverse()
                  .map((month, idx) => (
                    <tr
                      key={idx}
                      className={cn(
                        'hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 transition-all duration-200',
                        idx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50',
                        idx === 0 &&
                          'bg-gradient-to-r from-blue-50 to-cyan-50 font-semibold'
                      )}
                    >
                      <td className="p-4 border-b border-gray-100">
                        <div className="flex items-center gap-2">
                          <Calendar className="w-4 h-4 text-blue-500" />
                          <span className="font-bold text-gray-800">
                            {month.month} {month.year}
                          </span>
                          {idx === 0 && (
                            <Badge className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white text-xs px-2 py-1">
                              {dict.table.currentMonthBadge}
                            </Badge>
                          )}
                        </div>
                      </td>
                      <td className="p-4 text-center border-b border-gray-100">
                        <div className="flex items-center justify-center gap-2">
                          <Users className="w-4 h-4 text-blue-500" />
                          <span className="font-bold text-blue-600">
                            {month.count}
                          </span>
                        </div>
                      </td>
                      <td className="p-4 text-center border-b border-gray-100">
                        <div className="flex items-center justify-center gap-2">
                          <Target className="w-4 h-4 text-green-500" />
                          <span className="font-bold text-green-600">
                            {month.active}
                          </span>
                        </div>
                      </td>
                      <td className="p-4 text-center border-b border-gray-100">
                        <div className="flex items-center justify-center gap-2">
                          <Clock className="w-4 h-4 text-yellow-500" />
                          <span className="font-bold text-yellow-600">
                            {month.pending}
                          </span>
                        </div>
                      </td>
                      <td className="p-4 text-center border-b border-gray-100">
                        <div className="flex items-center justify-center gap-2">
                          <Crown className="w-4 h-4 text-purple-500" />
                          <span className="font-bold text-purple-600">
                            {month.success}
                          </span>
                        </div>
                      </td>
                      <td className="p-4 text-center border-b border-gray-100">
                        <div className="flex items-center justify-center gap-2">
                          <XCircle className="w-4 h-4 text-red-500" />
                          <span className="font-bold text-red-600">
                            {month.declined}
                          </span>
                        </div>
                      </td>
                    </tr>
                  ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
      <Card className="border-0 shadow-xl bg-gradient-to-r from-indigo-50 to-purple-50 overflow-hidden rounded-2xl">
        <CardContent className="p-8">
          <div className="flex items-center gap-4 mb-6">
            <div className="p-4 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-xl">
              <Sparkles className="w-8 h-8" />
            </div>
            <div>
              <h3 className="text-2xl font-bold text-indigo-800">
                {dict.insights.title}
              </h3>
              <p className="text-indigo-600">{dict.insights.subtitle}</p>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="p-6 bg-white/70 rounded-xl shadow-lg">
              <div className="flex items-center gap-3 mb-3">
                <TrendingUp className="w-6 h-6 text-green-500" />
                <h4 className="font-bold text-gray-800">
                  {dict.insights.growth.title}
                </h4>
              </div>
              <p className="text-sm text-gray-700 leading-relaxed">
                {trends.total >= 0
                  ? dict.insights.growth.increase.replace(
                      '{{trend}}',
                      trends.total.toString()
                    )
                  : dict.insights.growth.decrease.replace(
                      '{{trend}}',
                      Math.abs(trends.total).toString()
                    )}
              </p>
            </div>
            <div className="p-6 bg-white/70 rounded-xl shadow-lg">
              <div className="flex items-center gap-3 mb-3">
                <Award className="w-6 h-6 text-purple-500" />
                <h4 className="font-bold text-gray-800">
                  {dict.insights.successRate.title}
                </h4>
              </div>
              <p className="text-sm text-gray-700 leading-relaxed">
                {currentMonth.count > 0
                  ? dict.insights.successRate.rate.replace(
                      '{{rate}}',
                      Math.round(
                        (currentMonth.success / currentMonth.count) * 100
                      ).toString()
                    )
                  : dict.insights.successRate.noData}
              </p>
            </div>
            <div className="p-6 bg-white/70 rounded-xl shadow-lg">
              <div className="flex items-center gap-3 mb-3">
                <Activity className="w-6 h-6 text-blue-500" />
                <h4 className="font-bold text-gray-800">
                  {dict.insights.currentActivity.title}
                </h4>
              </div>
              <p className="text-sm text-gray-700 leading-relaxed">
                {dict.insights.currentActivity.body.replace(
                  '{{count}}',
                  (currentMonth.active + currentMonth.pending).toString()
                )}
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default MonthlyTrendModal;
--- End of Content for MonthlyTrendModal.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\container\SuggestionActionBar.tsx
--------------------------------------------------------------------------------
Content:
import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Badge } from '@/components/ui/badge';
import { DatePicker } from '@/components/ui/date-picker';
import {
  Search,
  Filter,
  X,
  Calendar,
  User,
  Clock,
  ChevronDown,
  AlertCircle,
  CheckCircle,

  RefreshCw,
  SlidersHorizontal,
  Sparkles,
  Target,
  Zap,

  TrendingUp,
  Star,
  Flame,
  Shield,
} from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import type { SuggestionFilters, SortByOption } from '@/types/suggestions';
import { Card, CardContent } from '@/components/ui/card';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

interface SuggestionActionBarProps {
  dict: MatchmakerPageDictionary['suggestionsDashboard']['actionBar'];
  searchQuery: string;
  onSearchChange: (value: string) => void;
  filters: SuggestionFilters;
  onFiltersChange: (filters: SuggestionFilters) => void;
  totalCount: number;
  activeCount: number;
  pendingCount: number;
  historyCount: number;
}

const SuggestionActionBar: React.FC<SuggestionActionBarProps> = ({
  dict,
  searchQuery,
  onSearchChange,
  filters,
  onFiltersChange,
}) => {
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
  const activeFilters = Object.keys(filters).length;
  const [dateRange, setDateRange] = useState<{
    from: Date | undefined;
    to: Date | undefined;
  }>({
    from: filters.dateRange?.start,
    to: filters.dateRange?.end,
  });

  const handleRemoveFilter = (key: keyof SuggestionFilters) => {
    const newFilters = { ...filters };
    delete newFilters[key];
    onFiltersChange(newFilters);
  };

  const handleDateRangeChange = (range: {
    from: Date | undefined;
    to: Date | undefined;
  }) => {
    setDateRange(range);
    if (range.from) {
      onFiltersChange({
        ...filters,
        dateRange: { start: range.from, end: range.to || new Date() },
      });
    } else {
      const newFilters = { ...filters };
      delete newFilters.dateRange;
      onFiltersChange(newFilters);
    }
  };

  // ✅ תיקון: יצירת אובייקט מיפוי לאייקונים במקום פונקציה חסרה
  const priorityInfoMap: Record<
    string,
    { icon: React.ElementType; color: string }
  > = {
    URGENT: { icon: Flame, color: 'text-red-600' },
    HIGH: { icon: Star, color: 'text-orange-600' },
    MEDIUM: { icon: Target, color: 'text-blue-600' },
    LOW: { icon: Shield, color: 'text-gray-600' },
  };

  const statusOptions: {
    value: MatchSuggestionStatus;
    icon: React.ElementType;
    color: string;
  }[] = [
    { value: 'PENDING_FIRST_PARTY', icon: Clock, color: 'text-yellow-600' },
    { value: 'PENDING_SECOND_PARTY', icon: Clock, color: 'text-blue-600' },
    {
      value: 'FIRST_PARTY_APPROVED',
      icon: CheckCircle,
      color: 'text-green-600',
    },
    {
      value: 'SECOND_PARTY_APPROVED',
      icon: CheckCircle,
      color: 'text-green-600',
    },
    { value: 'DATING', icon: AlertCircle, color: 'text-pink-600' },
  ];

  return (
    <div className="space-y-6">
      <Card className="border-0 shadow-xl bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 overflow-hidden rounded-2xl">
        <CardContent className="p-6">
          <div className="flex flex-col lg:flex-row gap-4 items-center">
            <div className="relative flex-1 w-full lg:w-auto">
              <div className="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 rounded-xl"></div>
              <Search className="absolute right-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-purple-400" />
              <Input
                value={searchQuery}
                onChange={(e) => onSearchChange(e.target.value)}
                placeholder={dict.searchPlaceholder}
                className="relative z-10 h-14 pr-14 text-right border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-xl bg-white/80 backdrop-blur-sm shadow-lg transition-all duration-300 text-lg"
              />
              <div className="absolute left-3 top-1/2 transform -translate-y-1/2">
                <Sparkles className="h-4 w-4 text-purple-400" />
              </div>
            </div>
            <div className="w-full lg:w-auto">
              <Select
                value={filters.priority?.[0] || 'all'}
                onValueChange={(value) =>
                  onFiltersChange({
                    ...filters,
                    priority: value === 'all' ? undefined : [value as Priority],
                  })
                }
              >
                <SelectTrigger className="h-14 w-full lg:w-48 border-2 border-purple-200 hover:border-purple-300 focus:border-purple-500 rounded-xl bg-white/80 backdrop-blur-sm shadow-lg transition-all">
                  <div className="flex items-center gap-2">
                    <Star className="w-5 h-5 text-purple-500" />
                    <SelectValue
                      placeholder={dict.priorityFilter.placeholder}
                    />
                  </div>
                </SelectTrigger>
                <SelectContent className="border-0 shadow-2xl rounded-xl">
                  <SelectItem value="all">
                    <div className="flex items-center gap-3">
                      <div className="w-3 h-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500"></div>
                      {dict.priorityFilter.all}
                    </div>
                  </SelectItem>
                  {/* ✅ תיקון: הלולאה תוקנה להשתמש במפת האייקונים */}
                  {Object.entries(dict.priorityFilter.options).map(
                    ([key, label]: [string, string]) => {
                      const info =
                        priorityInfoMap[key] || priorityInfoMap.MEDIUM;
                      const Icon = info.icon;
                      return (
                        <SelectItem key={key} value={key}>
                          <div className="flex items-center gap-3">
                            <Icon className={cn('w-4 h-4', info.color)} />
                            {label}
                          </div>
                        </SelectItem>
                      );
                    }
                  )}
                </SelectContent>
              </Select>
            </div>
            <Popover>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className="h-14 px-6 border-2 border-purple-200 hover:border-purple-300 hover:bg-purple-50 rounded-xl bg-white/80 backdrop-blur-sm shadow-lg transition-all duration-300"
                >
                  <Calendar className="h-5 w-5 ml-2 text-purple-500" />
                  <span className="font-medium">{dict.buttons.dateRange}</span>
                  <ChevronDown className="h-4 w-4 mr-2 text-purple-400" />
                </Button>
              </PopoverTrigger>
              <PopoverContent
                className="w-auto p-4 border-0 shadow-2xl rounded-2xl bg-white/95 backdrop-blur-sm"
                align="end"
              >
                <div className="space-y-4">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-5 h-5 text-purple-500" />
                    <h4 className="font-bold text-gray-800">
                      {dict.buttons.dateRange}
                    </h4>
                  </div>
                  <DatePicker
                    onChange={handleDateRangeChange}
                    value={dateRange}
                    isRange={true}
                  />
                  <div className="flex justify-end">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() =>
                        handleDateRangeChange({
                          from: undefined,
                          to: undefined,
                        })
                      }
                      className="rounded-xl border-purple-200 text-purple-600 hover:bg-purple-50"
                    >
                      {dict.buttons.clearDate}
                    </Button>
                  </div>
                </div>
              </PopoverContent>
            </Popover>
            <Button
              variant={showAdvancedFilters ? 'default' : 'outline'}
              onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
              className={cn(
                'h-14 px-6 rounded-xl transition-all duration-300 font-bold',
                showAdvancedFilters
                  ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-xl hover:shadow-2xl'
                  : 'border-2 border-purple-200 hover:border-purple-300 hover:bg-purple-50 bg-white/80 backdrop-blur-sm shadow-lg text-purple-600'
              )}
            >
              <SlidersHorizontal className="w-5 h-5 ml-2" />
              {dict.buttons.advancedFilters}
              {activeFilters > 0 && (
                <Badge className="mr-2 bg-white/20 text-current border-white/30 px-2 py-1">
                  {activeFilters}
                </Badge>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>
      {showAdvancedFilters && (
        <Card className="border-0 shadow-xl bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl overflow-hidden">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
                  <SlidersHorizontal className="w-6 h-6" />
                </div>
                <h3 className="text-xl font-bold text-gray-800">
                  {dict.advancedFilters.title}
                </h3>
              </div>
              <Button
                variant="ghost"
                size="sm"
                className="h-10 px-3 rounded-xl hover:bg-white/50"
                onClick={() => setShowAdvancedFilters(false)}
              >
                <X className="h-5 w-5" />
              </Button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div className="space-y-4">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg">
                    <Zap className="w-4 h-4" />
                  </div>
                  <h4 className="font-bold text-gray-800">
                    {dict.advancedFilters.statusTitle}
                  </h4>
                </div>
                <div className="space-y-3 max-h-60 overflow-y-auto">
                  {statusOptions.map((status) => {
                    const Icon = status.icon;
                    const label =
                      dict.advancedFilters.statusOptions[
                        status.value as keyof typeof dict.advancedFilters.statusOptions
                      ];
                    return (
                      <div
                        key={status.value}
                        className="flex items-center space-x-2 p-3 bg-white/70 rounded-xl hover:bg-white/90 transition-all"
                      >
                        <Checkbox
                          id={`status-${status.value}`}
                          checked={filters.status?.includes(
                            status.value as MatchSuggestionStatus
                          )}
                          onCheckedChange={(checked) => {
                            const newStatus = checked
                              ? [...(filters.status || []), status.value]
                              : filters.status?.filter(
                                  (s) => s !== status.value
                                );
                            onFiltersChange({
                              ...filters,
                              status: newStatus as MatchSuggestionStatus[],
                            });
                          }}
                        />
                        <label
                          htmlFor={`status-${status.value}`}
                          className="text-sm mr-2 flex items-center gap-2 cursor-pointer flex-1"
                        >
                          <Icon className={cn('h-4 w-4', status.color)} />
                          {label}
                        </label>
                      </div>
                    );
                  })}
                </div>
              </div>
              <div className="space-y-4">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
                    <User className="w-4 h-4" />
                  </div>
                  <h4 className="font-bold text-gray-800">
                    {dict.advancedFilters.participantsTitle}
                  </h4>
                </div>
                <div className="p-4 bg-white/70 rounded-xl">
                  <Select
                    value={filters.userId || 'all'}
                    onValueChange={(value) =>
                      onFiltersChange({
                        ...filters,
                        userId: value === 'all' ? undefined : value,
                      })
                    }
                  >
                    <SelectTrigger className="border-2 border-green-200 focus:border-green-400 rounded-xl">
                      <div className="flex items-center gap-2">
                        <User className="h-4 w-4 text-green-500" />
                        <SelectValue
                          placeholder={dict.advancedFilters.participantsTitle}
                        />
                      </div>
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="all">
                        {dict.advancedFilters.participantOptions.all}
                      </SelectItem>
                      <SelectItem value="user1">ישראל ישראלי</SelectItem>
                      <SelectItem value="user2">שרה כהן</SelectItem>
                      <SelectItem value="user3">דוד לוי</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="space-y-4">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
                    <TrendingUp className="w-4 h-4" />
                  </div>
                  <h4 className="font-bold text-gray-800">
                    {dict.advancedFilters.sortByTitle}
                  </h4>
                </div>
                <div className="p-4 bg-white/70 rounded-xl">
                  <Select
                    value={filters.sortBy || 'lastActivity'}
                    onValueChange={(value) =>
                      onFiltersChange({
                        ...filters,
                        sortBy: value as SortByOption,
                      })
                    }
                  >
                    <SelectTrigger className="border-2 border-purple-200 focus:border-purple-400 rounded-xl">
                      <div className="flex items-center gap-2">
                        <TrendingUp className="h-4 w-4 text-purple-500" />
                        <SelectValue
                          placeholder={dict.advancedFilters.sortByTitle}
                        />
                      </div>
                    </SelectTrigger>
                    <SelectContent>
                      {Object.entries(dict.advancedFilters.sortOptions).map(
                        ([key, label]) => (
                          <SelectItem key={key} value={key}>
                            {label}
                          </SelectItem>
                        )
                      )}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      {activeFilters > 0 && (
        <Card className="border-0 shadow-lg bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                  <Filter className="w-4 h-4" />
                </div>
                <span className="font-bold text-indigo-800">
                  {dict.activeFilters.title}
                </span>
              </div>
              <div className="flex items-center gap-2 flex-wrap">
                {filters.priority && (
                  <Badge className="bg-gradient-to-r from-orange-500 to-amber-500 text-white border-0 shadow-lg px-3 py-1 rounded-xl">
                    <Star className="w-3 h-3 ml-1" />
                    {dict.activeFilters.priorityLabel}:{' '}
                    {dict.priorityFilter.options[filters.priority[0]]}
                    <button
                      onClick={() => handleRemoveFilter('priority')}
                      className="ml-2 hover:bg-white/20 rounded-full p-0.5 transition-all"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filters.dateRange && (
                  <Badge className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 shadow-lg px-3 py-1 rounded-xl">
                    <Calendar className="w-3 h-3 ml-1" />
                    {dict.activeFilters.dateLabel}:{' '}
                    {new Date(filters.dateRange.start).toLocaleDateString(
                      'he-IL'
                    )}
                    {filters.dateRange.end &&
                      ` - ${new Date(filters.dateRange.end).toLocaleDateString('he-IL')}`}
                    <button
                      onClick={() => handleRemoveFilter('dateRange')}
                      className="ml-2 hover:bg-white/20 rounded-full p-0.5 transition-all"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filters.status && filters.status.length > 0 && (
                  <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-lg px-3 py-1 rounded-xl">
                    <AlertCircle className="w-3 h-3 ml-1" />
                    {dict.activeFilters.statusLabel}:{' '}
                    {filters.status.length === 1
                      ? dict.activeFilters.statusValues.single
                      : dict.activeFilters.statusValues.multiple.replace(
                          '{{count}}',
                          filters.status.length.toString()
                        )}
                    <button
                      onClick={() => handleRemoveFilter('status')}
                      className="ml-2 hover:bg-white/20 rounded-full p-0.5 transition-all"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                {filters.userId && (
                  <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 shadow-lg px-3 py-1 rounded-xl">
                    <User className="w-3 h-3 ml-1" />
                    {dict.activeFilters.userLabel}:{' '}
                    {dict.activeFilters.userValue}
                    <button
                      onClick={() => handleRemoveFilter('userId')}
                      className="ml-2 hover:bg-white/20 rounded-full p-0.5 transition-all"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  </Badge>
                )}
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onFiltersChange({})}
                  className="text-indigo-600 hover:text-indigo-700 hover:bg-indigo-100 rounded-xl transition-all font-medium"
                >
                  <RefreshCw className="w-3 h-3 ml-1" />
                  {dict.buttons.clearAll}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default SuggestionActionBar;
--- End of Content for SuggestionActionBar.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\details
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\details\SuggestionDetailsDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/details/SuggestionDetailsDialog.tsx
'use client';

import React, { useState, useEffect } from 'react';
import InquiryThreadView from '@/components/suggestions/inquiries/InquiryThreadView';
import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';

import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { ProfileCard } from '@/components/profile';
import { Timeline } from '@/components/ui/timeline';
import {
  CheckCircle,
  XCircle,
  MessageCircle,
  Send,
  RefreshCw,
  Edit,
  Calendar,
  Clock,

  AlarmClock,
  Trash2,
  User,
  Crown,
  Heart,
  Gem,
  Eye,
  Settings,
  Archive,
  Maximize,
  Minimize,
  X as CloseIcon,
  LucideIcon,
} from 'lucide-react';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';

import { MatchSuggestionStatus } from '@prisma/client';
import type {
  ExtendedMatchSuggestion,
  ActionAdditionalData,
} from '@/types/suggestions';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type {
  MatchmakerPageDictionary,
  SuggestionsDictionary,
  ProfilePageDictionary,
} from '@/types/dictionary';

type SuggestionDetailsActionType =
  | 'view'
  | 'contact'
  | 'message'
  | 'edit'
  | 'delete'
  | 'resend'
  | 'changeStatus'
  | 'reminder'
  | 'sendReminder'
  | 'shareContacts'
  | 'scheduleMeeting'
  | 'viewMeetings'
  | 'exportHistory'
  | 'export'
  | 'resendToAll';

interface DialogActionData extends ActionAdditionalData {
  suggestionId?: string;
  newStatus?: MatchSuggestionStatus;
  notes?: string;
  suggestion?: ExtendedMatchSuggestion;
  partyId?: string;
  type?: string;
  partyType?: 'first' | 'second' | 'both';
}

interface SuggestionDetailsDialogProps {
  suggestion: ExtendedMatchSuggestion | null;
  isOpen: boolean;
  onClose: () => void;
  onAction: (
    action: SuggestionDetailsActionType,
    data?: DialogActionData
  ) => void;
  userId: string;
  matchmakerDict: MatchmakerPageDictionary;
  suggestionsDict: SuggestionsDictionary;
  profileDict: ProfilePageDictionary; // ✅ הוספת המילון החדש
  locale: 'he' | 'en'; // <-- 1. הוסף את locale לממשק ה-props
}

interface StatusInfo {
  icon: LucideIcon;
  color: string;
  bgColor: string;
  badgeColor: string;
  progress: number;
}

const getEnhancedStatusInfo = (status: MatchSuggestionStatus): StatusInfo => {
  const statusInfoMap: Record<
    string,
    Omit<StatusInfo, 'label' | 'description'>
  > = {
    DRAFT: {
      icon: Edit,
      color: 'text-gray-600',
      bgColor: 'from-gray-50 to-slate-50',
      badgeColor: 'bg-gradient-to-r from-gray-500 to-slate-500 text-white',
      progress: 10,
    },
    PENDING_FIRST_PARTY: {
      icon: Clock,
      color: 'text-yellow-600',
      bgColor: 'from-yellow-50 to-amber-50',
      badgeColor: 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white',
      progress: 25,
    },
    FIRST_PARTY_APPROVED: {
      icon: CheckCircle,
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      badgeColor: 'bg-gradient-to-r from-green-500 to-emerald-500 text-white',
      progress: 40,
    },
    FIRST_PARTY_DECLINED: {
      icon: XCircle,
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      badgeColor: 'bg-gradient-to-r from-red-500 to-pink-500 text-white',
      progress: 0,
    },
    PENDING_SECOND_PARTY: {
      icon: Clock,
      color: 'text-blue-600',
      bgColor: 'from-blue-50 to-cyan-50',
      badgeColor: 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white',
      progress: 50,
    },
    SECOND_PARTY_APPROVED: {
      icon: CheckCircle,
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      badgeColor: 'bg-gradient-to-r from-green-500 to-emerald-500 text-white',
      progress: 60,
    },
    SECOND_PARTY_DECLINED: {
      icon: XCircle,
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      badgeColor: 'bg-gradient-to-r from-red-500 to-pink-500 text-white',
      progress: 0,
    },
    CONTACT_DETAILS_SHARED: {
      icon: Send,
      color: 'text-purple-600',
      bgColor: 'from-purple-50 to-pink-50',
      badgeColor: 'bg-gradient-to-r from-purple-500 to-pink-500 text-white',
      progress: 70,
    },
    AWAITING_FIRST_DATE_FEEDBACK: {
      icon: MessageCircle,
      color: 'text-orange-600',
      bgColor: 'from-orange-50 to-amber-50',
      badgeColor: 'bg-gradient-to-r from-orange-500 to-amber-500 text-white',
      progress: 75,
    },
    DATING: {
      icon: Heart,
      color: 'text-pink-600',
      bgColor: 'from-pink-50 to-rose-50',
      badgeColor: 'bg-gradient-to-r from-pink-500 to-rose-500 text-white',
      progress: 80,
    },
    ENGAGED: {
      icon: Gem,
      color: 'text-yellow-600',
      bgColor: 'from-yellow-50 to-orange-50',
      badgeColor: 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white',
      progress: 95,
    },
    MARRIED: {
      icon: Crown,
      color: 'text-emerald-600',
      bgColor: 'from-emerald-50 to-green-50',
      badgeColor: 'bg-gradient-to-r from-emerald-500 to-green-500 text-white',
      progress: 100,
    },
    EXPIRED: {
      icon: AlarmClock,
      color: 'text-gray-600',
      bgColor: 'from-gray-50 to-slate-50',
      badgeColor: 'bg-gradient-to-r from-gray-500 to-slate-500 text-white',
      progress: 0,
    },
    CLOSED: {
      icon: Archive,
      color: 'text-gray-600',
      bgColor: 'from-gray-50 to-slate-50',
      badgeColor: 'bg-gradient-to-r from-gray-500 to-slate-500 text-white',
      progress: 0,
    },
    CANCELLED: {
      icon: XCircle,
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      badgeColor: 'bg-gradient-to-r from-red-500 to-pink-500 text-white',
      progress: 0,
    },
    AWAITING_MATCHMAKER_APPROVAL: {
      icon: User,
      color: 'text-blue-600',
      bgColor: 'from-blue-50 to-cyan-50',
      badgeColor: 'bg-blue-500',
      progress: 65,
    },
    THINKING_AFTER_DATE: {
      icon: Clock,
      color: 'text-indigo-600',
      bgColor: 'from-indigo-50 to-violet-50',
      badgeColor: 'bg-indigo-500',
      progress: 77,
    },
    PROCEEDING_TO_SECOND_DATE: {
      icon: CheckCircle,
      color: 'text-teal-600',
      bgColor: 'from-teal-50 to-cyan-50',
      badgeColor: 'bg-teal-500',
      progress: 78,
    },
    ENDED_AFTER_FIRST_DATE: {
      icon: XCircle,
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      badgeColor: 'bg-red-500',
      progress: 0,
    },
    MEETING_PENDING: {
      icon: Calendar,
      color: 'text-purple-600',
      bgColor: 'from-purple-50 to-pink-50',
      badgeColor: 'bg-purple-500',
      progress: 72,
    },
    MEETING_SCHEDULED: {
      icon: Calendar,
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      badgeColor: 'bg-green-500',
      progress: 74,
    },
    MATCH_APPROVED: {
      icon: CheckCircle,
      color: 'text-green-600',
      bgColor: 'from-green-50 to-emerald-50',
      badgeColor: 'bg-green-500',
      progress: 60,
    },
    MATCH_DECLINED: {
      icon: XCircle,
      color: 'text-red-600',
      bgColor: 'from-red-50 to-pink-50',
      badgeColor: 'bg-red-500',
      progress: 0,
    },
  };
  return (
    statusInfoMap[status] || {
      icon: RefreshCw,
      color: 'text-gray-600',
      bgColor: 'from-gray-50 to-slate-50',
      badgeColor: 'bg-gray-500',
      progress: 10,
    }
  );
};


// ... Internal Components updated to receive and use dict ...

const SuggestionDetailsDialog: React.FC<SuggestionDetailsDialogProps> = ({
  suggestion,
  isOpen,
  onClose,
  onAction,
  userId,
  matchmakerDict,
  suggestionsDict,
  profileDict,
  locale, // <-- 2. קבל את locale
}) => {
  const dict = matchmakerDict.suggestionDetailsDialog;
  const [activeTab, setActiveTab] = useState('overview');
  const [firstPartyQuestionnaire, setFirstPartyQuestionnaire] =
    useState<QuestionnaireResponse | null>(null);
  const [secondPartyQuestionnaire, ] =
    useState<QuestionnaireResponse | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [statusChangeNote, setStatusChangeNote] = useState('');
  const [newStatus, setNewStatus] = useState<MatchSuggestionStatus | null>(
    null
  );
  const [showStatusChange, setShowStatusChange] = useState(false);
  const { refreshNotifications } = useNotifications();

  useEffect(() => {
    if (isOpen && suggestion) {
      setActiveTab('overview');
      setShowStatusChange(false);
      setNewStatus(null);
      setStatusChangeNote('');

      const hasUnread = suggestion.inquiries?.some(
        (inq) => inq.toUserId === userId && inq.status === 'PENDING'
      );
      if (hasUnread) {
        const markAsRead = async () => {
          try {
            await fetch(
              `/api/suggestions/${suggestion.id}/inquiries/mark-as-read`,
              { method: 'POST' }
            );
            refreshNotifications();
          } catch (error) {
            console.error('Failed to mark inquiries as read:', error);
          }
        };
        markAsRead();
      }
    }
  }, [isOpen, suggestion, userId, refreshNotifications]);

  const handleStatusChange = async () => {
    if (!newStatus || !suggestion) return;
    setIsLoading(true);
    try {
      onAction('changeStatus', {
        suggestionId: suggestion.id,
        newStatus,
        notes: statusChangeNote,
      });
      setShowStatusChange(false);
      setStatusChangeNote('');
      setNewStatus(null);
    } catch (error) {
      console.error('Error changing status:', error);
      toast.error(
        `${dict.toasts.statusUpdateError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsLoading(false);
    }
  };

  if (!suggestion) return null;

  const statusInfo = getEnhancedStatusInfo(suggestion.status);
  const statusLabel = dict.statusLabels[suggestion.status] || suggestion.status;
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent
        className={cn(
          'p-0 shadow-2xl border-0 bg-white overflow-hidden z-[50] flex flex-col transition-all duration-300 ease-in-out',
          isFullscreen
            ? '!w-screen !h-screen !max-w-none !max-h-none !rounded-none !fixed !inset-0 !m-0'
            : 'md:max-w-7xl md:w-[95vw] md:h-[95vh] md:rounded-3xl'
        )}
        dir={locale === 'he' ? 'rtl' : 'ltr'} // <-- ✨ 3. השתמש ב-locale לקביעת הכיווניות
        onOpenAutoFocus={(e) => e.preventDefault()}
      >
        <Tabs
          value={activeTab}
          onValueChange={setActiveTab}
          className="flex-1 flex flex-col overflow-hidden"
        >
          {/* Header and Tabs Component */}
          <div
            className={cn(
              'relative bg-gradient-to-br',
              statusInfo.bgColor,
              'border-b border-gray-100/80 flex-shrink-0'
            )}
          >
            <div className="absolute inset-0">
              <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-3xl opacity-50"></div>
              <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-white/10 to-transparent rounded-full blur-2xl opacity-40"></div>
            </div>
            <div className="relative z-10 p-6 space-y-4">
              <div className="flex items-start justify-between">
                <div className="flex items-center gap-4">
                  <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                    <statusInfo.icon
                      className={cn('w-7 h-7', statusInfo.color)}
                    />
                  </div>
                  <div>
                    <h1 className="text-xl lg:text-2xl font-bold text-gray-800">
                      {dict.header.title.replace(
                        '{{id}}',
                        suggestion.id.toString().split('-')[0]
                      )}
                    </h1>
                    <p className="text-md text-gray-600 mt-1">
                      {dict.header.subtitle
                        .replace('{{party1}}', suggestion.firstParty.firstName)
                        .replace(
                          '{{party2}}',
                          suggestion.secondParty.firstName
                        )}
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Badge
                    className={cn(
                      'text-sm font-bold shadow-md',
                      statusInfo.badgeColor
                    )}
                  >
                    <statusInfo.icon className="w-4 h-4 ml-2" />
                    {statusLabel}
                  </Badge>
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => setIsFullscreen(!isFullscreen)}
                          className="rounded-full h-10 w-10 text-gray-500 hover:text-gray-700 hover:bg-white/50 backdrop-blur-sm"
                        >
                          {isFullscreen ? (
                            <Minimize className="w-5 h-5" />
                          ) : (
                            <Maximize className="w-5 h-5" />
                          )}
                        </Button>
                      </TooltipTrigger>
                      <TooltipContent>
                        <p>
                          {isFullscreen
                            ? dict.header.minimizeTooltip
                            : dict.header.fullscreenTooltip}
                        </p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={onClose}
                    className="rounded-full h-10 w-10 text-gray-500 hover:text-gray-700 hover:bg-white/50 backdrop-blur-sm"
                  >
                    <CloseIcon className="w-5 h-5" />
                  </Button>
                </div>
              </div>
              <TabsList className="grid w-full grid-cols-3 sm:grid-cols-6 bg-white/60 backdrop-blur-sm rounded-2xl p-1.5 h-auto shadow-lg border border-white/50">
                {Object.entries(dict.tabs).map(([key, label]) => {
                  const IconComponent =
                    {
                      overview: Eye,
                      party1: User,
                      party2: User,
                      timeline: Calendar,
                      communication: MessageCircle,
                      actions: Settings,
                    }[key] || Eye;
                  return (
                    <TabsTrigger
                      key={key}
                      value={key}
                      onClick={() => setActiveTab(key)}
                      className={cn(
                        'flex flex-col items-center justify-center gap-1 rounded-xl text-xs font-bold transition-all duration-300 py-2 hover:scale-105 relative overflow-hidden group',
                        activeTab === key
                          ? 'bg-white text-primary shadow-md'
                          : 'text-gray-600 hover:bg-white/50'
                      )}
                    >
                      <IconComponent className="w-5 h-5 relative z-10" />
                      <span className="relative z-10 hidden sm:inline">
                        {label}
                      </span>
                    </TabsTrigger>
                  );
                })}
              </TabsList>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto bg-slate-50">
            <TabsContent value="overview" className="m-0 h-full">
              {/* OverviewTabContent Component would be here, but we'll inline it */}
            </TabsContent>
            <TabsContent value="firstParty" className="m-0 h-full">
              <div className="p-6">
                <ProfileCard
                  profile={suggestion.firstParty.profile}
                  images={suggestion.firstParty.images}
                  questionnaire={firstPartyQuestionnaire}
                  viewMode="matchmaker"
                  isProfileComplete={suggestion.firstParty.isProfileComplete}
                  dict={profileDict.profileCard}
                  locale={locale}
                />
              </div>
            </TabsContent>
            <TabsContent value="secondParty" className="m-0 h-full">
              <div className="p-6">
                <ProfileCard
                  profile={suggestion.secondParty.profile}
                  images={suggestion.secondParty.images}
                  questionnaire={secondPartyQuestionnaire}
                  viewMode="matchmaker"
                  isProfileComplete={suggestion.secondParty.isProfileComplete}
                  dict={profileDict.profileCard}
                  locale={locale}
                />
              </div>
            </TabsContent>
            <TabsContent value="timeline" className="m-0 h-full">
              <div className="p-6">
                <div className="bg-white rounded-2xl shadow-xl border-0 p-6">
                  <h3 className="text-2xl font-bold mb-6 flex items-center gap-3">
                    <div className="p-3 rounded-full bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg">
                      <Calendar className="w-6 h-6" />
                    </div>
                    {dict.timeline.title}
                  </h3>
                  <Timeline
                    items={(suggestion?.statusHistory || []).map((history) => {
                      const historyStatusInfo = getEnhancedStatusInfo(
                        history.status as MatchSuggestionStatus
                      );
                      return {
                        title:
                          dict.statusLabels[history.status] || history.status,
                        description: history.notes || dict.timeline.noNotes,
                        date:
                          typeof history.createdAt === 'string'
                            ? new Date(history.createdAt)
                            : history.createdAt,
                        icon: historyStatusInfo.icon,
                      };
                    })}
                  />
                </div>
              </div>
            </TabsContent>
            <TabsContent value="communication" className="m-0 h-full">
              <div className="p-6">
                <div className="bg-white rounded-2xl shadow-xl border-0 p-6">
                  <h3 className="text-2xl font-bold mb-6 flex items-center gap-3">
                    <div className="p-3 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg">
                      <MessageCircle className="w-6 h-6" />
                    </div>
                    {dict.communication.title}
                  </h3>
                  <InquiryThreadView
                    suggestionId={suggestion.id}
                    userId={userId}
                    showComposer={true}
                    dict={suggestionsDict.inquiryThread}
                  />
                </div>
              </div>
            </TabsContent>
            <TabsContent value="actions" className="m-0 h-full">
              <div className="p-6">
                <h3 className="text-2xl font-bold mb-6 flex items-center gap-3">
                  <div className="p-3 rounded-full bg-gradient-to-r from-gray-500 to-slate-500 text-white shadow-lg">
                    <Settings className="w-6 h-6" />
                  </div>
                  {dict.actions.title}
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="bg-white rounded-2xl shadow-xl border-0 p-6 hover:shadow-2xl transition-all duration-300">
                    <div className="p-3 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg w-fit mb-4">
                      <RefreshCw className="w-6 h-6" />
                    </div>
                    <h4 className="text-lg font-bold mb-3">
                      {dict.actions.statusChange.title}
                    </h4>
                    <p className="text-sm text-gray-600 mb-4">
                      {dict.actions.statusChange.description}
                    </p>
                    <Button
                      className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 shadow-lg"
                      onClick={() => setShowStatusChange(true)}
                    >
                      <RefreshCw className="w-4 h-4 ml-2" />
                      {dict.actions.statusChange.button}
                    </Button>
                  </div>
                  <div className="bg-white rounded-2xl shadow-xl border-0 p-6 hover:shadow-2xl transition-all duration-300">
                    <div className="p-3 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg w-fit mb-4">
                      <Edit className="w-6 h-6" />
                    </div>
                    <h4 className="text-lg font-bold mb-3">
                      {dict.actions.edit.title}
                    </h4>
                    <p className="text-sm text-gray-600 mb-4">
                      {dict.actions.edit.description}
                    </p>
                    <Button
                      variant="outline"
                      className="w-full border-2 border-amber-200 text-amber-700 hover:bg-amber-50"
                      onClick={() => onAction('edit', { suggestion })}
                    >
                      <Edit className="w-4 h-4 ml-2" />
                      {dict.actions.edit.button}
                    </Button>
                  </div>
                  <div className="bg-white rounded-2xl shadow-xl border-0 p-6 hover:shadow-2xl transition-all duration-300">
                    <div className="p-3 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg w-fit mb-4">
                      <Trash2 className="w-6 h-6" />
                    </div>
                    <h4 className="text-lg font-bold mb-3">
                      {dict.actions.delete.title}
                    </h4>
                    <p className="text-sm text-gray-600 mb-4">
                      {dict.actions.delete.description}
                    </p>
                    <Button
                      variant="outline"
                      className="w-full border-2 border-red-200 text-red-700 hover:bg-red-50"
                      onClick={() =>
                        onAction('delete', { suggestionId: suggestion.id })
                      }
                    >
                      <Trash2 className="w-4 h-4 ml-2" />
                      {dict.actions.delete.button}
                    </Button>
                  </div>
                </div>
              </div>
            </TabsContent>
          </div>
        </Tabs>
        {showStatusChange && (
          <div
            className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100]"
            dir="rtl"
          >
            <div className="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl m-4">
              <h3 className="text-xl font-bold mb-4 flex items-center">
                <RefreshCw className="w-5 h-5 ml-2 text-blue-600" />
                {dict.statusChangeModal.title}
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-600">
                    {dict.statusChangeModal.currentStatusLabel}
                  </label>
                  <div className="flex items-center p-3 bg-gray-100 rounded-lg border">
                    <statusInfo.icon
                      className={`w-5 h-5 ml-3 ${statusInfo.color}`}
                    />
                    <span className="font-bold">{statusLabel}</span>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-600">
                    {dict.statusChangeModal.newStatusLabel}
                  </label>
                  <Select
                    value={newStatus || undefined}
                    onValueChange={(value) =>
                      setNewStatus(value as MatchSuggestionStatus)
                    }
                  >
                    <SelectTrigger className="w-full">
                      <SelectValue
                        placeholder={
                          dict.statusChangeModal.newStatusPlaceholder
                        }
                      />
                    </SelectTrigger>
                    <SelectContent className="max-h-60 overflow-y-auto">
                      {Object.entries(dict.statusLabels).map(
                        ([status, label]) => (
                          <SelectItem key={status} value={status}>
                            {label}
                          </SelectItem>
                        )
                      )}
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-600">
                    {dict.statusChangeModal.notesLabel}
                  </label>
                  <Textarea
                    value={statusChangeNote}
                    onChange={(e) => setStatusChangeNote(e.target.value)}
                    placeholder={dict.statusChangeModal.notesPlaceholder}
                    className="min-h-[100px] resize-none"
                  />
                </div>
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button
                    variant="outline"
                    onClick={() => setShowStatusChange(false)}
                  >
                    {dict.statusChangeModal.cancelButton}
                  </Button>
                  <Button
                    onClick={handleStatusChange}
                    disabled={!newStatus || isLoading}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    {isLoading ? (
                      <>
                        <RefreshCw className="w-4 h-4 ml-2 animate-spin" />{' '}
                        {dict.statusChangeModal.savingButton}
                      </>
                    ) : (
                      dict.statusChangeModal.saveButton
                    )}
                  </Button>
                </div>
              </div>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
};

export default SuggestionDetailsDialog;
--- End of Content for SuggestionDetailsDialog.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\hooks\useMatchmaking.ts
--------------------------------------------------------------------------------
Content:
// /hooks/useMatchmaking.ts
import { useState, useEffect, useMemo, useCallback } from 'react';
import { AvailabilityStatus } from '@prisma/client';
import { calculateMatchScore, MatchScore } from '../utils/matchingAlgorithm';
import { MATCH_THRESHOLDS } from '../../new/constants/matchingCriteria';
import type { User } from '@/types/next-auth';
// Define types and interfaces
interface UseMatchmakingProps {
  candidates?: User[];
  onMatchFound?: (match: PotentialMatch) => void;
  onMatchScoreUpdate?: (scores: MatchScoreMap) => void;
}

export interface PotentialMatch {
  candidateA: User;
  candidateB: User;
  score: MatchScore;
  matchDate?: Date;
  status: 'new' | 'suggested' | 'rejected';
  lastUpdated: Date;
}

type MatchScoreMap = Map<string, Map<string, MatchScore>>;

interface MatchSuggestion {
  candidate: User;
  score: MatchScore;
  matchDate: Date;
}

export const useMatchmaking = ({
  candidates = [],
  onMatchScoreUpdate
}: UseMatchmakingProps = {}) => {
  // State declarations
  const [matchScores, setMatchScores] = useState<MatchScoreMap>(new Map());
  const [suggestedMatches, setSuggestedMatches] = useState<PotentialMatch[]>([]);
  const [isCalculating, setIsCalculating] = useState(false);
  const [lastCalculation, setLastCalculation] = useState<Date | null>(null);

  // Calculate all possible matches
  const calculateAllMatches = useCallback(() => {
    setIsCalculating(true);
    const newScores = new Map<string, Map<string, MatchScore>>();
    const newMatches: PotentialMatch[] = [];

    candidates.forEach((candidateA, indexA) => {
      const candidateAScores = new Map<string, MatchScore>();
      newScores.set(candidateA.id, candidateAScores);

      candidates.slice(indexA + 1).forEach(candidateB => {
        // Check basic compatibility conditions
        if (
          candidateA.profile?.gender === candidateB.profile?.gender ||
          candidateA.profile?.availabilityStatus !== AvailabilityStatus.AVAILABLE ||
          candidateB.profile?.availabilityStatus !== AvailabilityStatus.AVAILABLE
        ) {
          return;
        }

        // Calculate match score
        const matchScore = calculateMatchScore(candidateA.profile, candidateB.profile);
        
        if (matchScore) {
          candidateAScores.set(candidateB.id, matchScore);

          // Add to potential matches if score is good enough
          if (matchScore.score >= MATCH_THRESHOLDS.GOOD) {
            newMatches.push({
              candidateA,
              candidateB,
              score: matchScore,
              matchDate: new Date(),
              status: 'new',
              lastUpdated: new Date()
            });
          }
        }
      });
    });

    setMatchScores(newScores);
    setSuggestedMatches(prev => {
      const existing = new Set(prev.map(m => 
        `${m.candidateA.id}-${m.candidateB.id}`
      ));
      
      return [
        ...prev,
        ...newMatches.filter(m => 
          !existing.has(`${m.candidateA.id}-${m.candidateB.id}`)
        )
      ].sort((a, b) => b.score.score - a.score.score);
    });

    onMatchScoreUpdate?.(newScores);
    setIsCalculating(false);
    setLastCalculation(new Date());
  }, [candidates, onMatchScoreUpdate]);

  // Recalculate matches when candidates list changes
  useEffect(() => {
    if (candidates.length > 0 && !isCalculating) {
      calculateAllMatches();
    }
  }, [candidates, calculateAllMatches, isCalculating]);

  // Get best matches for a specific candidate
  const getBestMatchesForCandidate = useCallback((
    candidateId: string,
    limit: number = 5
  ): MatchSuggestion[] => {
    const candidate = candidates.find(c => c.id === candidateId);
    if (!candidate) return [];

    const matches: MatchSuggestion[] = [];
    const candidateScores = matchScores.get(candidateId);

    if (candidateScores) {
      candidateScores.forEach((score, otherId) => {
        const otherCandidate = candidates.find(c => c.id === otherId);
        if (otherCandidate && score.score >= MATCH_THRESHOLDS.FAIR) {
          matches.push({
            candidate: otherCandidate,
            score,
            matchDate: new Date()
          });
        }
      });
    }

    return matches
      .sort((a, b) => b.score.score - a.score.score)
      .slice(0, limit);
  }, [candidates, matchScores]);

  // Analyze matches by categories
  const matchAnalytics = useMemo(() => {
    const analytics = {
      total: suggestedMatches.length,
      byCategory: {
        excellent: 0,
        good: 0,
        fair: 0,
        poor: 0
      },
      averageScore: 0,
      recentMatches: [] as PotentialMatch[]
    };

    suggestedMatches.forEach(match => {
      if (match.score.score >= MATCH_THRESHOLDS.EXCELLENT) {
        analytics.byCategory.excellent++;
      } else if (match.score.score >= MATCH_THRESHOLDS.GOOD) {
        analytics.byCategory.good++;
      } else if (match.score.score >= MATCH_THRESHOLDS.FAIR) {
        analytics.byCategory.fair++;
      } else {
        analytics.byCategory.poor++;
      }
    });

    analytics.averageScore = suggestedMatches.reduce(
      (sum, match) => sum + match.score.score,
      0
    ) / (suggestedMatches.length || 1);

    // Get recent matches (last week)
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    analytics.recentMatches = suggestedMatches
      .filter(match => match.matchDate && match.matchDate >= oneWeekAgo)
      .sort((a, b) => 
        (b.matchDate?.getTime() || 0) - (a.matchDate?.getTime() || 0)
      );

    return analytics;
  }, [suggestedMatches]);

  // Update match status
  const updateMatchStatus = useCallback((
    candidateAId: string,
    candidateBId: string,
    status: 'suggested' | 'rejected'
  ) => {
    setSuggestedMatches(prev => prev.map(match => {
      if (
        (match.candidateA.id === candidateAId && match.candidateB.id === candidateBId) ||
        (match.candidateA.id === candidateBId && match.candidateB.id === candidateAId)
      ) {
        return {
          ...match,
          status,
          lastUpdated: new Date()
        };
      }
      return match;
    }));
  }, []);

  // Return hook interface
  return {
    matchScores,
    suggestedMatches,
    isCalculating,
    lastCalculation,
    matchAnalytics,
    getBestMatchesForCandidate,
    calculateAllMatches,
    updateMatchStatus
  };
};

export default useMatchmaking;
--- End of Content for useMatchmaking.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\list
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\list\ManagerSuggestionsList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/list/ManagerSuggestionsList.tsx

import React, { useMemo } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Users } from 'lucide-react';
import type {
  Suggestion,
  SuggestionFilters,
  ActionAdditionalData,
} from '@/types/suggestions';
import SuggestionCard from '../cards/SuggestionCard';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

type SuggestionActionType =
  | 'view'
  | 'contact'
  | 'message'
  | 'edit'
  | 'delete'
  | 'resend'
  | 'changeStatus'
  | 'reminder';

interface ManagerSuggestionsListProps {
  suggestions: Suggestion[];
  filters: SuggestionFilters;
  searchQuery: string;
  type: 'active' | 'pending' | 'history';
  onAction: (
    actionType: SuggestionActionType,
    data: { suggestion: Suggestion } & ActionAdditionalData
  ) => void;
  dict: MatchmakerPageDictionary['suggestionsDashboard'];
}

const ManagerSuggestionsList: React.FC<ManagerSuggestionsListProps> = ({
  suggestions,
  filters,
  searchQuery,
  type,
  onAction,
  dict,
}) => {
  const listDict = dict.managerSuggestionsList;

  const filteredSuggestions = useMemo(() => {
    return suggestions.filter((suggestion) => {
      // Base status filter
      if (
        type === 'active' &&
        [
          'CLOSED',
          'CANCELLED',
          'EXPIRED',
          'FIRST_PARTY_DECLINED',
          'SECOND_PARTY_DECLINED',
        ].includes(suggestion.status)
      ) {
        return false;
      }
      if (type === 'pending' && !suggestion.status.includes('PENDING')) {
        return false;
      }
      if (
        type === 'history' &&
        ![
          'CLOSED',
          'CANCELLED',
          'EXPIRED',
          'FIRST_PARTY_DECLINED',
          'SECOND_PARTY_DECLINED',
          'MARRIED',
          'ENGAGED',
        ].includes(suggestion.status)
      ) {
        return false;
      }

      // Search query
      if (searchQuery && suggestion.firstParty && suggestion.secondParty) {
        const searchTerm = searchQuery.toLowerCase();
        const searchableText =
          `${suggestion.firstParty.firstName} ${suggestion.firstParty.lastName} ${suggestion.secondParty.firstName} ${suggestion.secondParty.lastName} ${suggestion.matchingReason || ''}`.toLowerCase();
        if (!searchableText.includes(searchTerm)) return false;
      }

      // Priority filter
      if (
        filters.priority?.length &&
        !filters.priority.includes(suggestion.priority)
      ) {
        return false;
      }

      // Date range filter
      if (filters.dateRange) {
        const createdAt = new Date(suggestion.createdAt);
        if (
          createdAt < filters.dateRange.start ||
          (filters.dateRange.end && createdAt > filters.dateRange.end)
        ) {
          return false;
        }
      }

      return true;
    });
  }, [suggestions, filters, searchQuery, type]);

  if (filteredSuggestions.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-gray-400 text-center">
        <Users className="w-12 h-12 mb-4" />
        <h3 className="text-lg font-semibold text-gray-600">
          {listDict.emptyState.title}
        </h3>
        <p>{listDict.emptyState.description}</p>
      </div>
    );
  }

  return (
    <ScrollArea className="h-[600px] rounded-md border p-4">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {filteredSuggestions.map((suggestion) => {
          if (!suggestion.firstParty || !suggestion.secondParty) {
            return null; // Safety check for corrupted data
          }
          return (
            <SuggestionCard
              key={suggestion.id}
              suggestion={suggestion}
              onAction={(type, suggestionData, additionalData) =>
                onAction(type, {
                  suggestion: suggestionData,
                  ...additionalData,
                })
              }
              dict={dict.suggestionCard}
            />
          );
        })}
      </div>
    </ScrollArea>
  );
};

export default ManagerSuggestionsList;
--- End of Content for ManagerSuggestionsList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\list\SuggestionsList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/list/SuggestionsList.tsx

import React, { useState, useMemo } from 'react';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import {
  Search,
  Filter,
  SortDesc,
  LayoutGrid,
  List,
  Users,
  Clock,
  CheckCircle,
  XCircle,
  Heart,
 
  TrendingUp,
  Activity,
  BarChart3,

  Sparkles,

  Flame,

  RefreshCw,
  Calendar,

} from 'lucide-react';
import type { MatchSuggestion } from '@prisma/client';
import type { UserProfile, UserImage } from '@/types/next-auth';
import SuggestionCard from '../cards/SuggestionCard';
import { LoadingContainer } from '../../new/shared/LoadingStates';
import type {
  Suggestion,
  ActionAdditionalData,
  SuggestionStatusHistory,
} from '@/types/suggestions';
import { cn } from '@/lib/utils';
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';
import type { MatchmakerPageDictionary } from '@/types/dictionary';

// Define outside the component to avoid re-creation
const STATIC_SORT_OPTIONS = [
  { value: 'latest', icon: TrendingUp },
  { value: 'oldest', icon: Calendar },
  { value: 'deadline', icon: Clock },
  { value: 'priority', icon: Flame },
];

const STATIC_STATUS_OPTIONS = [
  {
    value: 'PENDING_FIRST_PARTY',
    color: 'from-yellow-500 to-amber-500',
    icon: Clock,
  },
  {
    value: 'PENDING_SECOND_PARTY',
    color: 'from-blue-500 to-cyan-500',
    icon: Clock,
  },
  {
    value: 'FIRST_PARTY_APPROVED',
    color: 'from-green-500 to-emerald-500',
    icon: CheckCircle,
  },
  {
    value: 'SECOND_PARTY_APPROVED',
    color: 'from-green-500 to-emerald-500',
    icon: CheckCircle,
  },
  {
    value: 'CONTACT_DETAILS_SHARED',
    color: 'from-purple-500 to-pink-500',
    icon: Heart,
  },
  { value: 'DATING', color: 'from-pink-500 to-rose-500', icon: Heart },
];

interface PartyInfo {
  id: string;
  firstName: string;
  lastName: string;
  profile: UserProfile;
  images: UserImage[];
}

interface ExtendedMatchSuggestion extends MatchSuggestion {
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  statusHistory: SuggestionStatusHistory[];
}

interface SuggestionsListProps {
  suggestions: ExtendedMatchSuggestion[];
  isLoading?: boolean;
  onAction: (
    type:
      | 'view'
      | 'contact'
      | 'message'
      | 'edit'
      | 'delete'
      | 'resend'
      | 'changeStatus'
      | 'reminder',
    suggestion: Suggestion,
    additionalData?: ActionAdditionalData
  ) => void;
  className?: string;
  dict: MatchmakerPageDictionary['suggestionsDashboard'];
}

const EnhancedListStats: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['suggestionsList']['stats'];
  total: number;
  pending: number;
  approved: number;
  declined: number;
  urgent: number;
}> = ({ dict, total, pending, approved, declined, urgent }) => (
  <Card className="border-0 shadow-xl bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 mb-6">
    <CardContent className="p-4">
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="text-center group">
          <div className="flex items-center justify-center gap-2 mb-1">
            <div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg group-hover:scale-110 transition-transform">
              <Users className="w-4 h-4" />
            </div>
            <span className="text-2xl font-bold text-blue-600">{total}</span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.total}</p>
        </div>
        <div className="text-center group">
          <div className="flex items-center justify-center gap-2 mb-1">
            <div className="p-2 rounded-full bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-lg group-hover:scale-110 transition-transform">
              <Clock className="w-4 h-4" />
            </div>
            <span className="text-2xl font-bold text-yellow-600">
              {pending}
            </span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.pending}</p>
        </div>
        <div className="text-center group">
          <div className="flex items-center justify-center gap-2 mb-1">
            <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg group-hover:scale-110 transition-transform">
              <CheckCircle className="w-4 h-4" />
            </div>
            <span className="text-2xl font-bold text-green-600">
              {approved}
            </span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.approved}</p>
        </div>
        <div className="text-center group">
          <div className="flex items-center justify-center gap-2 mb-1">
            <div className="p-2 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg group-hover:scale-110 transition-transform">
              <XCircle className="w-4 h-4" />
            </div>
            <span className="text-2xl font-bold text-red-600">{declined}</span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.declined}</p>
        </div>
        <div className="text-center group">
          <div className="flex items-center justify-center gap-2 mb-1">
            <div className="p-2 rounded-full bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg group-hover:scale-110 transition-transform animate-pulse">
              <Flame className="w-4 h-4" />
            </div>
            <span className="text-2xl font-bold text-orange-600">{urgent}</span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.urgent}</p>
        </div>
      </div>
    </CardContent>
  </Card>
);

const EnhancedFilterSection: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['suggestionsList']['filters'];
  searchQuery: string;
  onSearchChange: (query: string) => void;
  sortBy: string;
  onSortChange: (sort: string) => void;
  statusFilter: string[];
  onStatusFilterChange: (status: string[]) => void;
  showFilters: boolean;
  onToggleFilters: () => void;
  viewMode: 'grid' | 'list';
  onViewModeChange: (mode: 'grid' | 'list') => void;
}> = ({
  dict,
  searchQuery,
  onSearchChange,
  sortBy,
  onSortChange,
  statusFilter,
  onStatusFilterChange,
  showFilters,
  onToggleFilters,
  viewMode,
  onViewModeChange,
}) => (
  <Card className="border-0 shadow-xl bg-gradient-to-r from-white via-cyan-50/30 to-blue-50/30 mb-6">
    <CardContent className="p-6 space-y-4">
      <div className="flex flex-col md:flex-row gap-4">
        <div className="relative flex-1">
          <Search className="absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
          <Input
            placeholder={dict.searchPlaceholder}
            value={searchQuery}
            onChange={(e) => onSearchChange(e.target.value)}
            className="pr-12 text-right bg-white/80 backdrop-blur-sm border-cyan-200 focus:border-cyan-400 focus:ring-cyan-200 rounded-xl h-12 shadow-sm"
          />
        </div>
        <Select value={sortBy} onValueChange={onSortChange}>
          <SelectTrigger className="w-48 h-12 bg-white/80 backdrop-blur-sm border-cyan-200 focus:border-cyan-400 rounded-xl shadow-sm">
            <SortDesc className="w-4 h-4 ml-2" />
            <SelectValue placeholder={dict.sortPlaceholder} />
          </SelectTrigger>
          <SelectContent>
            {STATIC_SORT_OPTIONS.map((option) => {
              const IconComponent = option.icon;
              return (
                <SelectItem key={option.value} value={option.value}>
                  <div className="flex items-center gap-2">
                    <IconComponent className="w-4 h-4" />
                    {
                      dict.sortOptions[
                        option.value as keyof typeof dict.sortOptions
                      ]
                    }
                  </div>
                </SelectItem>
              );
            })}
          </SelectContent>
        </Select>
        <Button
          variant="outline"
          onClick={onToggleFilters}
          className={cn(
            'h-12 border-cyan-200 hover:bg-cyan-50 text-cyan-600 rounded-xl bg-white/80 backdrop-blur-sm shadow-sm',
            showFilters && 'bg-cyan-100 border-cyan-300'
          )}
        >
          <Filter className="w-4 h-4 ml-2" />
          {dict.filterButton}
        </Button>
        <ToggleGroup
          type="single"
          value={viewMode}
          onValueChange={(value: 'grid' | 'list') =>
            value && onViewModeChange(value)
          }
          className="bg-white/80 backdrop-blur-sm shadow-sm rounded-xl border border-cyan-200"
        >
          <ToggleGroupItem
            value="grid"
            aria-label={dict.viewModes.grid}
            className="data-[state=on]:bg-cyan-500 data-[state=on]:text-white"
          >
            <LayoutGrid className="h-4 w-4" />
          </ToggleGroupItem>
          <ToggleGroupItem
            value="list"
            aria-label={dict.viewModes.list}
            className="data-[state=on]:bg-cyan-500 data-[state=on]:text-white"
          >
            <List className="h-4 w-4" />
          </ToggleGroupItem>
        </ToggleGroup>
      </div>
      {showFilters && (
        <div className="pt-4 border-t border-cyan-100 space-y-4">
          <div>
            <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Activity className="w-4 h-4 text-cyan-500" />
              {dict.advancedFilterTitle}
            </h4>
            <div className="flex flex-wrap gap-2">
              {STATIC_STATUS_OPTIONS.map((status) => {
                const IconComponent = status.icon;
                return (
                  <Button
                    key={status.value}
                    variant={
                      statusFilter.includes(status.value)
                        ? 'default'
                        : 'outline'
                    }
                    size="sm"
                    onClick={() => {
                      const newFilter = statusFilter.includes(status.value)
                        ? statusFilter.filter((s) => s !== status.value)
                        : [...statusFilter, status.value];
                      onStatusFilterChange(newFilter);
                    }}
                    className={cn(
                      'text-xs rounded-xl transition-all duration-300',
                      statusFilter.includes(status.value)
                        ? `bg-gradient-to-r ${status.color} text-white shadow-lg border-0`
                        : 'border-gray-200 hover:bg-gray-50'
                    )}
                  >
                    <IconComponent className="w-3 h-3 ml-1" />
                    {
                      dict.statusOptions[
                        status.value as keyof typeof dict.statusOptions
                      ]
                    }
                  </Button>
                );
              })}
            </div>
          </div>
          <div className="flex justify-end">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => onStatusFilterChange([])}
              className="text-gray-500 hover:text-gray-700"
            >
              <RefreshCw className="w-3 h-3 ml-1" />
              {dict.clearFiltersButton}
            </Button>
          </div>
        </div>
      )}
    </CardContent>
  </Card>
);

const EnhancedEmptyState: React.FC<{
  dict: MatchmakerPageDictionary['suggestionsDashboard']['suggestionsList']['emptyState'];
  isFiltered: boolean;
  onClearFilters: () => void;
}> = ({ dict, isFiltered, onClearFilters }) => (
  <div className="flex flex-col items-center justify-center min-h-[500px] text-center p-12">
    <div className="w-32 h-32 rounded-full bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 flex items-center justify-center shadow-xl mb-8">
      {isFiltered ? (
        <Search className="w-16 h-16 text-purple-400" />
      ) : (
        <Users className="w-16 h-16 text-purple-400" />
      )}
    </div>
    <h3 className="text-2xl font-bold text-gray-800 mb-4">
      {isFiltered ? dict.filtered.title : dict.default.title}
    </h3>
    <p className="text-gray-600 max-w-md mx-auto mb-6 leading-relaxed">
      {isFiltered ? dict.filtered.description : dict.default.description}
    </p>
    {isFiltered && (
      <Button
        onClick={onClearFilters}
        className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white shadow-xl hover:shadow-2xl transition-all duration-300 rounded-xl"
      >
        <RefreshCw className="w-4 h-4 ml-2" />
        {dict.clearButton}
      </Button>
    )}
  </div>
);

const SuggestionsList: React.FC<SuggestionsListProps> = ({
  suggestions,
  isLoading = false,
  onAction,
  className,
  dict: dashboardDict,
}) => {
  const dict = dashboardDict.suggestionsList;
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState('latest');
  const [statusFilter, setStatusFilter] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');

  const stats = useMemo(() => {
    const total = suggestions.length;
    const pending = suggestions.filter((s) =>
      s.status.includes('PENDING')
    ).length;
    const approved = suggestions.filter((s) =>
      s.status.includes('APPROVED')
    ).length;
    const declined = suggestions.filter((s) =>
      s.status.includes('DECLINED')
    ).length;
    const urgent = suggestions.filter((s) => s.priority === 'URGENT').length;
    return { total, pending, approved, declined, urgent };
  }, [suggestions]);

  const filteredSuggestions = useMemo(() => {
    let result = [...suggestions];

    if (statusFilter.length > 0) {
      result = result.filter((s) => statusFilter.includes(s.status));
    }

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      result = result.filter((s) => {
        const searchText =
          `${s.firstParty.firstName} ${s.firstParty.lastName} ${s.secondParty.firstName} ${s.secondParty.lastName} ${s.firstParty.profile?.city || ''} ${s.secondParty.profile?.city || ''}`.toLowerCase();
        return searchText.includes(query);
      });
    }

    switch (sortBy) {
      case 'latest':
        result.sort(
          (a, b) =>
            new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
        );
        break;
      case 'oldest':
        result.sort(
          (a, b) =>
            new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()
        );
        break;
      case 'deadline':
        result.sort((a, b) => {
          if (!a.decisionDeadline) return 1;
          if (!b.decisionDeadline) return -1;
          return (
            new Date(a.decisionDeadline).getTime() -
            new Date(b.decisionDeadline).getTime()
          );
        });
        break;
      case 'priority':{ 
        const priorityOrder = { URGENT: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
        result.sort(
          (a, b) =>
            (priorityOrder[a.priority as keyof typeof priorityOrder] || 4) -
            (priorityOrder[b.priority as keyof typeof priorityOrder] || 4)
        );
        break;
      }
    }

    return result;
  }, [suggestions, searchQuery, sortBy, statusFilter]);

  const isFiltered = searchQuery !== '' || statusFilter.length > 0;
  const clearAllFilters = () => {
    setSearchQuery('');
    setStatusFilter([]);
  };

  const resultsLabel =
    filteredSuggestions.length === 1
      ? dict.results.itemLabel_one
      : dict.results.itemLabel_other;

  return (
    <div className={cn('space-y-6', className)}>
      <EnhancedListStats dict={dict.stats} {...stats} />
      <EnhancedFilterSection
        dict={dict.filters}
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        sortBy={sortBy}
        onSortChange={setSortBy}
        statusFilter={statusFilter}
        onStatusFilterChange={setStatusFilter}
        showFilters={showFilters}
        onToggleFilters={() => setShowFilters(!showFilters)}
        viewMode={viewMode}
        onViewModeChange={setViewMode}
      />
      <div className="flex justify-between items-center text-sm text-gray-600 px-2">
        <span className="font-medium">
          {dict.results.summary
            .replace('{{count}}', filteredSuggestions.length.toString())
            .replace('{{label}}', resultsLabel)
            .replace('{{total}}', suggestions.length.toString())}
        </span>
        {filteredSuggestions.length > 0 && (
          <div className="flex items-center gap-2">
            <Sparkles className="w-4 h-4 text-purple-500" />
            <span className="font-medium text-purple-600">
              {dict.results.qualityMatches}
            </span>
          </div>
        )}
      </div>
      {isLoading ? (
        <LoadingContainer>
          <div
            className={cn(
              viewMode === 'grid'
                ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
                : 'space-y-4'
            )}
          >
            {Array.from({ length: 6 }).map((_, i) => (
              <div
                key={i}
                className="h-80 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl animate-pulse shadow-lg"
              />
            ))}
          </div>
        </LoadingContainer>
      ) : filteredSuggestions.length === 0 ? (
        <EnhancedEmptyState
          dict={dict.emptyState}
          isFiltered={isFiltered}
          onClearFilters={clearAllFilters}
        />
      ) : (
        <div
          className={cn(
            'animate-fade-in-up',
            viewMode === 'grid'
              ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
              : 'space-y-6'
          )}
        >
          {filteredSuggestions.map((suggestion, index) => (
            <div
              key={suggestion.id}
              className="animate-scale-in"
              style={{
                animationDelay: `${index * 100}ms`,
                animationFillMode: 'both',
              }}
            >
              <SuggestionCard
                suggestion={suggestion as unknown as Suggestion}
                onAction={onAction}
                dict={dashboardDict.suggestionCard}
                className="h-full"
              />
            </div>
          ))}
        </div>
      )}
      {isFiltered && (
        <Card className="border-0 shadow-lg bg-gradient-to-r from-purple-50 to-pink-50">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm flex-wrap">
                <Filter className="w-4 h-4 text-purple-500" />
                <span className="font-medium text-purple-700">
                  {dict.activeFilters.title}
                </span>
                {searchQuery && (
                  <Badge className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 shadow-sm">
                    {dict.activeFilters.searchLabel.replace(
                      '{{query}}',
                      searchQuery
                    )}
                  </Badge>
                )}
                {statusFilter.map((status) => {
                  const statusOption = STATIC_STATUS_OPTIONS.find(
                    (opt) => opt.value === status
                  );
                  if (!statusOption) return null;
                  const IconComponent = statusOption.icon;
                  return (
                    <Badge
                      key={status}
                      className={cn(
                        `bg-gradient-to-r ${statusOption.color} text-white border-0 shadow-sm`
                      )}
                    >
                      <IconComponent className="w-3 h-3 ml-1" />
                      {
                        dict.filters.statusOptions[
                          status as keyof typeof dict.filters.statusOptions
                        ]
                      }
                    </Badge>
                  );
                })}
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={clearAllFilters}
                className="text-purple-600 hover:text-purple-700 hover:bg-purple-100 rounded-xl"
              >
                <RefreshCw className="w-3 h-3 ml-1" />
                {dict.activeFilters.clearAllButton}
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
      {filteredSuggestions.length > 0 && (
        <Card className="border-0 shadow-lg bg-gradient-to-r from-emerald-50 to-green-50">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-full bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-lg">
                  <BarChart3 className="w-4 h-4" />
                </div>
                <div>
                  <h4 className="font-bold text-emerald-800">
                    {dict.performance.title}
                  </h4>
                  <p className="text-sm text-emerald-600">
                    {dict.performance.description
                      .replace(
                        '{{rate}}',
                        Math.round(
                          (stats.approved / Math.max(stats.total, 1)) * 100
                        ).toString()
                      )
                      .replace('{{urgentCount}}', stats.urgent.toString())
                      .replace('{{pendingCount}}', stats.pending.toString())}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <div className="text-right text-xs text-emerald-600">
                  <div className="font-bold">
                    {Math.round(
                      (stats.approved / Math.max(stats.total, 1)) * 100
                    )}
                    %
                  </div>
                  <div>{dict.performance.successLabel}</div>
                </div>
                <div className="w-16 h-2 bg-emerald-200 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-gradient-to-r from-emerald-500 to-green-500 transition-all duration-500"
                    style={{
                      width: `${Math.round((stats.approved / Math.max(stats.total, 1)) * 100)}%`,
                    }}
                  />
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default SuggestionsList;
--- End of Content for SuggestionsList.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services
================================================================================

(This directory contains subdirectories but no files directly. See subdirectories below.)

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\NotificationService.ts
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/services/notification/NotificationService.ts

import { MatchSuggestionStatus } from '@prisma/client';
import { SuggestionWithParties } from '../suggestions/StatusTransitionService';
import { EmailDictionary } from '@/types/dictionary'; // ייבוא הטיפוס המאוחד

// --- הגדרות טיפוסים פנימיות של השירות ---

export type RecipientInfo = {
  email: string;
  phone?: string;
  name: string;
};

export type NotificationContent = {
  subject: string;
  body: string;
  htmlBody?: string;
};

export type NotificationChannel = 'email' | 'whatsapp' | 'sms';

export type NotificationOptions = {
  channels: NotificationChannel[];
  notifyParties?: ('first' | 'second' | 'matchmaker')[];
  customMessage?: string;
};

export interface NotificationAdapter {
  canSendTo(recipient: RecipientInfo): boolean;
  send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean>;
  getChannelType(): NotificationChannel;
}

// --- שירות ההודעות המלא והמשוכתב ---

export class NotificationService {
  private static instance: NotificationService;
  private adapters: Map<NotificationChannel, NotificationAdapter> = new Map();

  private constructor() {}

  public static getInstance(): NotificationService {
    if (!NotificationService.instance) {
      NotificationService.instance = new NotificationService();
    }
    return NotificationService.instance;
  }

  public registerAdapter(adapter: NotificationAdapter): void {
    this.adapters.set(adapter.getChannelType(), adapter);
    console.log(`Registered ${adapter.getChannelType()} adapter`);
  }

  public async sendNotification(
    recipient: RecipientInfo,
    content: NotificationContent,
    options: Pick<NotificationOptions, 'channels'>
  ): Promise<Record<NotificationChannel, boolean>> {
    const results: Record<NotificationChannel, boolean> = {} as any;

    for (const channel of options.channels) {
      const adapter = this.adapters.get(channel);
      if (adapter && adapter.canSendTo(recipient)) {
        try {
          console.log(`Sending ${channel} notification to ${recipient.name}`);
          results[channel] = await adapter.send(recipient, content);
          console.log(`${channel} notification sent successfully: ${results[channel]}`);
        } catch (error) {
          console.error(`Error sending notification via ${channel}:`, error);
          results[channel] = false;
        }
      } else {
        if (!adapter) console.warn(`No adapter registered for channel: ${channel}`);
        if (adapter && !adapter.canSendTo(recipient)) console.warn(`Cannot send to recipient via ${channel}: missing required info`);
        results[channel] = false;
      }
    }
    return results;
  }

  public async handleSuggestionStatusChange(
    suggestion: SuggestionWithParties,
    dictionary: EmailDictionary,
    options: Partial<NotificationOptions> = {}
  ): Promise<void> {
    console.log(`Processing notifications for suggestion ${suggestion.id} with status ${suggestion.status}`);
    
    // אנו עובדים עם תת-המילון של ההתראות
    const notificationDict = dictionary.notifications; 
    
    const contentGenerator = options.customMessage 
      ? this.getCustomMessageContent(options.customMessage, suggestion.id, notificationDict)
      : this.getSuggestionContentFromDict(suggestion, notificationDict);

    if (!contentGenerator) {
      console.log(`No template found for status ${suggestion.status} - skipping notification`);
      return;
    }
  
    const recipientsWithChannels = this.getRecipientsForSuggestion(suggestion);
  
    for (const { recipient, preferredChannels, partyType } of recipientsWithChannels) {
      if (options.notifyParties && !options.notifyParties.includes(partyType)) {
        console.log(`Skipping recipient ${recipient.name} (${partyType}) - not in notifyParties`, options.notifyParties);
        continue;
      }
      
      const personalizedContent = contentGenerator(partyType);
      
      const channelsToUse = options.channels || preferredChannels || ['email'];
      
      await this.sendNotification(
        recipient,
        personalizedContent,
        { channels: channelsToUse }
      );
    }
    console.log(`Finished processing notifications for suggestion ${suggestion.id}`);
  }

  private getSuggestionContentFromDict(
    suggestion: SuggestionWithParties,
    dictionary: EmailDictionary['notifications']
  ): ((partyType: 'first' | 'second' | 'matchmaker') => NotificationContent) | null {
      
    const status = suggestion.status;
    const template = dictionary.suggestionStatusChange[status];

    if (!template) {
      return null;
    }
    
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
    const reviewUrl = `${baseUrl}/suggestions/${suggestion.id}/review`;
    const dashboardUrl = `${baseUrl}/dashboard/suggestions/${suggestion.id}`;

    return (partyType: 'first' | 'second' | 'matchmaker'): NotificationContent => {
      let partyName = '';
      if(partyType === 'first') partyName = suggestion.firstParty.firstName;
      if(partyType === 'second') partyName = suggestion.secondParty.firstName;
      
      const replacements: Record<string, string> = {
        '{{partyName}}': partyName,
        '{{matchmakerName}}': suggestion.matchmaker.firstName,
        '{{reviewUrl}}': reviewUrl,
        '{{dashboardUrl}}': dashboardUrl,
      };

      const replacePlaceholders = (text: string) => text.replace(/{{partyName}}|{{matchmakerName}}|{{reviewUrl}}|{{dashboardUrl}}/g, (match) => replacements[match]);

      return {
        subject: replacePlaceholders(template.subject),
        body: replacePlaceholders(template.body),
        htmlBody: replacePlaceholders(template.htmlBody),
      };
    };
  }
  
  private getCustomMessageContent(
    customMessage: string,
    suggestionId: string,
    dictionary: EmailDictionary['notifications']
  ): (partyType: 'first' | 'second' | 'matchmaker') => NotificationContent {
    const reviewUrl = `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/suggestions/${suggestionId}/review`;
    return () => ({
        subject: dictionary.customMessage.subject,
        body: `${customMessage}\n\nלצפייה בפרטי ההצעה: ${reviewUrl}`,
        htmlBody: `<div dir="rtl"><p>${customMessage}</p><p>לצפייה בפרטי ההצעה: <a href="${reviewUrl}">לחץ כאן</a></p></div>`
    });
  }

  private getRecipientsForSuggestion(suggestion: SuggestionWithParties): Array<{
    recipient: RecipientInfo;
    preferredChannels: NotificationChannel[];
    partyType: 'first' | 'second' | 'matchmaker';
  }> {
    const recipients: Array<{ recipient: RecipientInfo; preferredChannels: NotificationChannel[]; partyType: 'first' | 'second' | 'matchmaker'}> = [];
    const { firstParty, secondParty, matchmaker } = suggestion;

    const party1 = {
      recipient: { email: firstParty.email, phone: firstParty.phone || undefined, name: `${firstParty.firstName} ${firstParty.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'first' as const,
    };
    const party2 = {
      recipient: { email: secondParty.email, phone: secondParty.phone || undefined, name: `${secondParty.firstName} ${secondParty.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'second' as const,
    };
    const mk = {
      recipient: { email: matchmaker.email, phone: matchmaker.phone || undefined, name: `${matchmaker.firstName} ${matchmaker.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'matchmaker' as const,
    };
    
    switch (suggestion.status) {
      case MatchSuggestionStatus.PENDING_FIRST_PARTY:
        recipients.push(party1);
        break;
      case MatchSuggestionStatus.FIRST_PARTY_APPROVED:
      case MatchSuggestionStatus.FIRST_PARTY_DECLINED:
      case MatchSuggestionStatus.SECOND_PARTY_APPROVED:
      case MatchSuggestionStatus.SECOND_PARTY_DECLINED:
      case MatchSuggestionStatus.THINKING_AFTER_DATE:
      case MatchSuggestionStatus.DATING:
      case MatchSuggestionStatus.EXPIRED:
        recipients.push(mk);
        break;
      case MatchSuggestionStatus.PENDING_SECOND_PARTY:
        recipients.push(party2);
        break;
      case MatchSuggestionStatus.CONTACT_DETAILS_SHARED:
      case MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK:
        recipients.push(party1, party2);
        break;
      case MatchSuggestionStatus.ENGAGED:
      case MatchSuggestionStatus.MARRIED:
        recipients.push(party1, party2, mk);
        break;
      default:
        console.log(`No specific recipient rule for status ${suggestion.status}, defaulting to matchmaker.`);
        recipients.push(mk);
        break;
    }
    return recipients;
  }
}

export const notificationService = NotificationService.getInstance();
--- End of Content for NotificationService.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\initNotifications.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/services/notification/initNotifications.ts

import { notificationService } from './NotificationService';
import { emailAdapter } from './adapters/EmailAdapter';
import { whatsAppAdapter } from './adapters/WhatsAppAdapter';

// Define notification channel type
export type NotificationChannel = 'email' | 'whatsapp' | 'sms';

export type NotificationOptions = {
    channels: NotificationChannel[];
    notifyParties?: ('first' | 'second' | 'matchmaker')[];
    customMessage?: string;
  };

/**
 * Initializes the notification service by registering all available adapters
 * @returns The initialized notification service
 */
export function initNotificationService() {
  // Register adapters
  notificationService.registerAdapter(emailAdapter);
  notificationService.registerAdapter(whatsAppAdapter);
  
  console.log('Notification service initialized with email and WhatsApp adapters');
  
  return notificationService;
}
--- End of Content for initNotifications.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\notification_contents.txt
--------------------------------------------------------------------------------
Content:
################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification
# Generated on: 2025-10-05 13:49:41
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\NotificationService.ts
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/services/notification/NotificationService.ts

import { MatchSuggestionStatus } from '@prisma/client';
import { SuggestionWithParties } from '../suggestions/StatusTransitionService';
import { EmailDictionary } from '@/types/dictionary'; // ייבוא הטיפוס המאוחד

// --- הגדרות טיפוסים פנימיות של השירות ---

export type RecipientInfo = {
  email: string;
  phone?: string;
  name: string;
};

export type NotificationContent = {
  subject: string;
  body: string;
  htmlBody?: string;
};

export type NotificationChannel = 'email' | 'whatsapp' | 'sms';

export type NotificationOptions = {
  channels: NotificationChannel[];
  notifyParties?: ('first' | 'second' | 'matchmaker')[];
  customMessage?: string;
};

export interface NotificationAdapter {
  canSendTo(recipient: RecipientInfo): boolean;
  send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean>;
  getChannelType(): NotificationChannel;
}

// --- שירות ההודעות המלא והמשוכתב ---

export class NotificationService {
  private static instance: NotificationService;
  private adapters: Map<NotificationChannel, NotificationAdapter> = new Map();

  private constructor() {}

  public static getInstance(): NotificationService {
    if (!NotificationService.instance) {
      NotificationService.instance = new NotificationService();
    }
    return NotificationService.instance;
  }

  public registerAdapter(adapter: NotificationAdapter): void {
    this.adapters.set(adapter.getChannelType(), adapter);
    console.log(`Registered ${adapter.getChannelType()} adapter`);
  }

  public async sendNotification(
    recipient: RecipientInfo,
    content: NotificationContent,
    options: Pick<NotificationOptions, 'channels'>
  ): Promise<Record<NotificationChannel, boolean>> {
    const results: Record<NotificationChannel, boolean> = {} as any;

    for (const channel of options.channels) {
      const adapter = this.adapters.get(channel);
      if (adapter && adapter.canSendTo(recipient)) {
        try {
          console.log(`Sending ${channel} notification to ${recipient.name}`);
          results[channel] = await adapter.send(recipient, content);
          console.log(`${channel} notification sent successfully: ${results[channel]}`);
        } catch (error) {
          console.error(`Error sending notification via ${channel}:`, error);
          results[channel] = false;
        }
      } else {
        if (!adapter) console.warn(`No adapter registered for channel: ${channel}`);
        if (adapter && !adapter.canSendTo(recipient)) console.warn(`Cannot send to recipient via ${channel}: missing required info`);
        results[channel] = false;
      }
    }
    return results;
  }

  public async handleSuggestionStatusChange(
    suggestion: SuggestionWithParties,
    dictionary: EmailDictionary,
    options: Partial<NotificationOptions> = {}
  ): Promise<void> {
    console.log(`Processing notifications for suggestion ${suggestion.id} with status ${suggestion.status}`);
    
    // אנו עובדים עם תת-המילון של ההתראות
    const notificationDict = dictionary.notifications; 
    
    const contentGenerator = options.customMessage 
      ? this.getCustomMessageContent(options.customMessage, suggestion.id, notificationDict)
      : this.getSuggestionContentFromDict(suggestion, notificationDict);

    if (!contentGenerator) {
      console.log(`No template found for status ${suggestion.status} - skipping notification`);
      return;
    }
  
    const recipientsWithChannels = this.getRecipientsForSuggestion(suggestion);
  
    for (const { recipient, preferredChannels, partyType } of recipientsWithChannels) {
      if (options.notifyParties && !options.notifyParties.includes(partyType)) {
        console.log(`Skipping recipient ${recipient.name} (${partyType}) - not in notifyParties`, options.notifyParties);
        continue;
      }
      
      const personalizedContent = contentGenerator(partyType);
      
      const channelsToUse = options.channels || preferredChannels || ['email'];
      
      await this.sendNotification(
        recipient,
        personalizedContent,
        { channels: channelsToUse }
      );
    }
    console.log(`Finished processing notifications for suggestion ${suggestion.id}`);
  }

  private getSuggestionContentFromDict(
    suggestion: SuggestionWithParties,
    dictionary: EmailDictionary['notifications']
  ): ((partyType: 'first' | 'second' | 'matchmaker') => NotificationContent) | null {
      
    const status = suggestion.status;
    const template = dictionary.suggestionStatusChange[status];

    if (!template) {
      return null;
    }
    
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
    const reviewUrl = `${baseUrl}/suggestions/${suggestion.id}/review`;
    const dashboardUrl = `${baseUrl}/dashboard/suggestions/${suggestion.id}`;

    return (partyType: 'first' | 'second' | 'matchmaker'): NotificationContent => {
      let partyName = '';
      if(partyType === 'first') partyName = suggestion.firstParty.firstName;
      if(partyType === 'second') partyName = suggestion.secondParty.firstName;
      
      const replacements: Record<string, string> = {
        '{{partyName}}': partyName,
        '{{matchmakerName}}': suggestion.matchmaker.firstName,
        '{{reviewUrl}}': reviewUrl,
        '{{dashboardUrl}}': dashboardUrl,
      };

      const replacePlaceholders = (text: string) => text.replace(/{{partyName}}|{{matchmakerName}}|{{reviewUrl}}|{{dashboardUrl}}/g, (match) => replacements[match]);

      return {
        subject: replacePlaceholders(template.subject),
        body: replacePlaceholders(template.body),
        htmlBody: replacePlaceholders(template.htmlBody),
      };
    };
  }
  
  private getCustomMessageContent(
    customMessage: string,
    suggestionId: string,
    dictionary: EmailDictionary['notifications']
  ): (partyType: 'first' | 'second' | 'matchmaker') => NotificationContent {
    const reviewUrl = `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/suggestions/${suggestionId}/review`;
    return () => ({
        subject: dictionary.customMessage.subject,
        body: `${customMessage}\n\nלצפייה בפרטי ההצעה: ${reviewUrl}`,
        htmlBody: `<div dir="rtl"><p>${customMessage}</p><p>לצפייה בפרטי ההצעה: <a href="${reviewUrl}">לחץ כאן</a></p></div>`
    });
  }

  private getRecipientsForSuggestion(suggestion: SuggestionWithParties): Array<{
    recipient: RecipientInfo;
    preferredChannels: NotificationChannel[];
    partyType: 'first' | 'second' | 'matchmaker';
  }> {
    const recipients: Array<{ recipient: RecipientInfo; preferredChannels: NotificationChannel[]; partyType: 'first' | 'second' | 'matchmaker'}> = [];
    const { firstParty, secondParty, matchmaker } = suggestion;

    const party1 = {
      recipient: { email: firstParty.email, phone: firstParty.phone || undefined, name: `${firstParty.firstName} ${firstParty.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'first' as const,
    };
    const party2 = {
      recipient: { email: secondParty.email, phone: secondParty.phone || undefined, name: `${secondParty.firstName} ${secondParty.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'second' as const,
    };
    const mk = {
      recipient: { email: matchmaker.email, phone: matchmaker.phone || undefined, name: `${matchmaker.firstName} ${matchmaker.lastName}`},
      preferredChannels: ['email', 'whatsapp'] as NotificationChannel[],
      partyType: 'matchmaker' as const,
    };
    
    switch (suggestion.status) {
      case MatchSuggestionStatus.PENDING_FIRST_PARTY:
        recipients.push(party1);
        break;
      case MatchSuggestionStatus.FIRST_PARTY_APPROVED:
      case MatchSuggestionStatus.FIRST_PARTY_DECLINED:
      case MatchSuggestionStatus.SECOND_PARTY_APPROVED:
      case MatchSuggestionStatus.SECOND_PARTY_DECLINED:
      case MatchSuggestionStatus.THINKING_AFTER_DATE:
      case MatchSuggestionStatus.DATING:
      case MatchSuggestionStatus.EXPIRED:
        recipients.push(mk);
        break;
      case MatchSuggestionStatus.PENDING_SECOND_PARTY:
        recipients.push(party2);
        break;
      case MatchSuggestionStatus.CONTACT_DETAILS_SHARED:
      case MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK:
        recipients.push(party1, party2);
        break;
      case MatchSuggestionStatus.ENGAGED:
      case MatchSuggestionStatus.MARRIED:
        recipients.push(party1, party2, mk);
        break;
      default:
        console.log(`No specific recipient rule for status ${suggestion.status}, defaulting to matchmaker.`);
        recipients.push(mk);
        break;
    }
    return recipients;
  }
}

export const notificationService = NotificationService.getInstance();
--- End of Content for NotificationService.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\initNotifications.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/services/notification/initNotifications.ts

import { notificationService } from './NotificationService';
import { emailAdapter } from './adapters/EmailAdapter';
import { whatsAppAdapter } from './adapters/WhatsAppAdapter';

// Define notification channel type
export type NotificationChannel = 'email' | 'whatsapp' | 'sms';

export type NotificationOptions = {
    channels: NotificationChannel[];
    notifyParties?: ('first' | 'second' | 'matchmaker')[];
    customMessage?: string;
  };

/**
 * Initializes the notification service by registering all available adapters
 * @returns The initialized notification service
 */
export function initNotificationService() {
  // Register adapters
  notificationService.registerAdapter(emailAdapter);
  notificationService.registerAdapter(whatsAppAdapter);
  
  console.log('Notification service initialized with email and WhatsApp adapters');
  
  return notificationService;
}
--- End of Content for initNotifications.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\notification_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters\EmailAdapter.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/services/notification/adapters/EmailAdapter.ts

import { NotificationAdapter, NotificationChannel, RecipientInfo, NotificationContent } from '../NotificationService';
import nodemailer from 'nodemailer';

export class EmailAdapter implements NotificationAdapter {
  private static instance: EmailAdapter;
  private transporter: nodemailer.Transporter;

  private constructor() {
    // Configure the transporter exactly like in EmailService
    this.transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.GMAIL_USER || '',
        pass: process.env.GMAIL_APP_PASSWORD || '',
      },
      tls: {
        rejectUnauthorized: false
      }
    });

    // Verify email configuration on initialization
    this.verifyEmailConfig();
  }

  private async verifyEmailConfig(): Promise<void> {
    try {
      await this.transporter.verify();
      console.log('Email configuration verified successfully');
    } catch (error) {
      console.error('Email configuration verification failed:', error);
      // Don't throw, to allow the system to continue even if verification fails
    }
  }

  public static getInstance(): EmailAdapter {
    if (!EmailAdapter.instance) {
      EmailAdapter.instance = new EmailAdapter();
    }
    return EmailAdapter.instance;
  }

  public getChannelType(): NotificationChannel {
    return 'email';
  }

  public canSendTo(recipient: RecipientInfo): boolean {
    return !!recipient.email;
  }

  public async send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean> {
    try {
      const result = await this.transporter.sendMail({
        from: `${process.env.EMAIL_FROM_NAME || 'מערכת השידוכים'} <${process.env.GMAIL_USER || ''}>`,
        to: recipient.email,
        subject: content.subject,
        text: content.body,
        html: content.htmlBody || content.body.replace(/\n/g, '<br>'),
      });

      console.log('Email sent successfully:', {
        messageId: result.messageId,
        response: result.response,
        to: recipient.email,
        subject: content.subject
      });

      return true;
    } catch (error) {
      console.error('Detailed error sending email:', {
        error: error instanceof Error ? {
          name: error.name,
          message: error.message,
          stack: error.stack
        } : error,
        recipient: recipient.email,
        subject: content.subject
      });
      return false;
    }
  }
}

export const emailAdapter = EmailAdapter.getInstance();
--- End of Content for EmailAdapter.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters\WhatsAppAdapter.ts
--------------------------------------------------------------------------------
Content:
// lib/WhatsAppAdapter.ts
import {
  NotificationAdapter,
  NotificationChannel,
  RecipientInfo,
  NotificationContent as BaseNotificationContent
} from '../NotificationService';
import twilio from 'twilio';
import { MessageListInstanceCreateOptions } from 'twilio/lib/rest/api/v2010/account/message';

interface NotificationContent extends BaseNotificationContent {
  _adapterSpecificData?: {
      contentSid?: string;
      contentVariables?: string;
  };
}

interface PotentialTwilioError {
  code?: number | string;
  message?: string;
}

function isPotentialTwilioError(error: unknown): error is PotentialTwilioError {
  return typeof error === 'object' && error !== null && ('code' in error || 'message' in error);
}

const logger = {
  info: (message: string, meta?: Record<string, unknown> | object) => {
    console.log(JSON.stringify({ timestamp: new Date().toISOString(), level: 'info', service: 'WhatsAppAdapter', message, ...(meta || {}) }));
  },
  warn: (message: string, meta?: Record<string, unknown> | object) => {
    console.warn(JSON.stringify({ timestamp: new Date().toISOString(), level: 'warn', service: 'WhatsAppAdapter', message, ...(meta || {}) }));
  },
  error: (message: string, meta?: Record<string, unknown> | object) => {
    let logMeta = meta || {};
    if (meta instanceof Error) {
        logMeta = { name: meta.name, message: meta.message, stack: meta.stack };
    } else if (isPotentialTwilioError(meta)) {
        logMeta = { code: meta.code, message: meta.message, ...meta };
    }
    console.error(JSON.stringify({ timestamp: new Date().toISOString(), level: 'error', service: 'WhatsAppAdapter', message, ...logMeta }));
  },
};


export class WhatsAppAdapter implements NotificationAdapter {
  private static instance: WhatsAppAdapter;
  private client: twilio.Twilio | null = null;
  private fromNumber: string = '';

  private constructor() {
    const accountSid = process.env.TWILIO_ACCOUNT_SID;
    const authToken = process.env.TWILIO_AUTH_TOKEN;
    this.fromNumber = process.env.TWILIO_WHATSAPP_NUMBER || '';

    if (!accountSid || !authToken || !this.fromNumber) {
      logger.error('Missing Twilio configuration details', {
          hasSid: !!accountSid,
          hasToken: !!authToken,
          hasWhatsAppNumber: !!this.fromNumber,
          detail: "WhatsApp notifications will be unavailable."
      });
    } else if (!this.fromNumber.startsWith('+')) {
      // --- NEW VALIDATION ---
      logger.error('Invalid TWILIO_WHATSAPP_NUMBER format in .env. It must start with a "+".', {
          providedNumber: this.fromNumber
      });
      this.fromNumber = ''; // Invalidate the number to prevent sending
      // --- END NEW VALIDATION ---
    } else {
      try {
        this.client = twilio(accountSid, authToken);
        logger.info('Twilio client initialized successfully', { fromWhatsAppNumber: this.fromNumber });
      } catch (error: unknown) {
        logger.error('Failed to initialize Twilio client during constructor', { error });
        this.client = null;
      }
    }
  }

  public static getInstance(): WhatsAppAdapter {
    if (!WhatsAppAdapter.instance) {
      WhatsAppAdapter.instance = new WhatsAppAdapter();
    }
    return WhatsAppAdapter.instance;
  }

  public getChannelType(): NotificationChannel {
    return 'whatsapp';
  }

  public canSendTo(recipient: RecipientInfo): boolean {
    // --- UPDATED VALIDATION ---
    // Using a more robust check for E.164 format
    const hasValidPhone = !!recipient.phone && /^\+[1-9]\d{1,14}$/.test(recipient.phone);
    // --- END UPDATED VALIDATION ---
    const isClientReady = this.client !== null;
    const hasFromNumber = this.fromNumber !== '';
    const canSend = hasValidPhone && isClientReady && hasFromNumber;

    if (!canSend) {
        let reason = 'Unknown';
        if (!hasValidPhone) reason = 'Invalid or missing phone number (must be in E.164 format, e.g., +14155552671)';
        else if (!isClientReady) reason = 'Twilio client not initialized';
        else if (!hasFromNumber) reason = 'Twilio "from" number not configured or invalid';
        logger.warn('Cannot send WhatsApp message due to configuration or recipient data', {
            reason: reason,
            recipientPhone: recipient.phone
        });
    }
    return canSend;
  }

  // --- REMOVED `formatPhoneNumber` method ---
  // This method is no longer needed as we expect a valid E.164 number directly.

  public async send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean> {
    logger.info('Attempting to send WhatsApp message', {
      recipientPhone: recipient.phone,
      fromNumber: this.fromNumber,
      hasClient: !!this.client,
      contentSid: content._adapterSpecificData?.contentSid,
      hasContentVariables: !!content._adapterSpecificData?.contentVariables,
    });

    if (!this.client || !this.fromNumber) {
      logger.error('Pre-send check failed: Twilio client or fromNumber is not configured.');
      return false;
    }
    
    // --- SIMPLIFIED VALIDATION ---
    if (!recipient.phone || !recipient.phone.startsWith('+')) {
      logger.error('Recipient phone number is missing or not in E.164 format.', { phone: recipient.phone });
      return false;
    }
    // --- END SIMPLIFIED VALIDATION ---

    try {
      // --- SIMPLIFIED NUMBER FORMATTING ---
      const fromWhatsAppFormatted = `whatsapp:${this.fromNumber}`;
      const toWhatsAppFormatted = `whatsapp:${recipient.phone}`; // Use the number directly
      // --- END SIMPLIFIED NUMBER FORMATTING ---

      logger.info(`Formatted numbers for sending via Twilio`, { from: fromWhatsAppFormatted, to: toWhatsAppFormatted });

      let messagePayload: MessageListInstanceCreateOptions;
      const adapterData = content._adapterSpecificData;

      if (adapterData?.contentSid && adapterData?.contentVariables) {
         logger.info(`Preparing WhatsApp template message`, { contentSid: adapterData.contentSid });
         messagePayload = {
            from: fromWhatsAppFormatted,
            to: toWhatsAppFormatted,
            contentSid: adapterData.contentSid,
            contentVariables: adapterData.contentVariables,
         };
      } else {
         const bodyText = content.body || content.subject || 'הודעה ממערכת השידוכים';
         logger.warn(`Preparing raw text WhatsApp message (using fallback, might fail)`, { bodyLength: bodyText.length });
         messagePayload = {
            from: fromWhatsAppFormatted,
            to: toWhatsAppFormatted,
            body: bodyText,
         };
      }
      
      logger.info("Sending message payload to Twilio API", { payload: {from: messagePayload.from, to: messagePayload.to, contentSid: messagePayload.contentSid} }); // Log safer data
      const message = await this.client.messages.create(messagePayload);
      
      logger.info('WhatsApp message request processed successfully by Twilio', {
        messageSid: message.sid,
        status: message.status,
        to: toWhatsAppFormatted,
        from: fromWhatsAppFormatted,
        price: message.price,
        priceUnit: message.priceUnit,
        errorCode: message.errorCode,
        errorMessage: message.errorMessage,
      });
      return true;

    } catch (error: unknown) {
      let errorMessage = 'Unknown error occurred while sending WhatsApp message.';
      let errorCode: number | string | undefined;

      if (isPotentialTwilioError(error)) {
          errorCode = error.code;
          errorMessage = error.message || errorMessage;
      } else if (error instanceof Error) {
          errorMessage = error.message;
      } else if (typeof error === 'string') {
          errorMessage = error;
      }

      logger.error('Failed to send WhatsApp message via Twilio', {
        errorCode,
        errorMessage,
        recipient: recipient.phone,
        from: this.fromNumber,
        errorDetails: error
      });

      if (errorCode === 63018 || errorCode === 21614) {
           logger.error(`Recipient number appears invalid or not registered on WhatsApp.`, { phone: recipient.phone, errorCode });
      } else if (errorCode === 63016) {
            logger.warn(`Failed to send non-template message outside 24-hour window.`, { phone: recipient.phone, errorCode });
      }

      return false;
    }
  }
}

export const whatsAppAdapter = WhatsAppAdapter.getInstance();
--- End of Content for WhatsAppAdapter.ts ---

--- End of Content for notification_contents.txt ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters\EmailAdapter.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/services/notification/adapters/EmailAdapter.ts

import { NotificationAdapter, NotificationChannel, RecipientInfo, NotificationContent } from '../NotificationService';
import nodemailer from 'nodemailer';

export class EmailAdapter implements NotificationAdapter {
  private static instance: EmailAdapter;
  private transporter: nodemailer.Transporter;

  private constructor() {
    // Configure the transporter exactly like in EmailService
    this.transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.GMAIL_USER || '',
        pass: process.env.GMAIL_APP_PASSWORD || '',
      },
      tls: {
        rejectUnauthorized: false
      }
    });

    // Verify email configuration on initialization
    this.verifyEmailConfig();
  }

  private async verifyEmailConfig(): Promise<void> {
    try {
      await this.transporter.verify();
      console.log('Email configuration verified successfully');
    } catch (error) {
      console.error('Email configuration verification failed:', error);
      // Don't throw, to allow the system to continue even if verification fails
    }
  }

  public static getInstance(): EmailAdapter {
    if (!EmailAdapter.instance) {
      EmailAdapter.instance = new EmailAdapter();
    }
    return EmailAdapter.instance;
  }

  public getChannelType(): NotificationChannel {
    return 'email';
  }

  public canSendTo(recipient: RecipientInfo): boolean {
    return !!recipient.email;
  }

  public async send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean> {
    try {
      const result = await this.transporter.sendMail({
        from: `${process.env.EMAIL_FROM_NAME || 'מערכת השידוכים'} <${process.env.GMAIL_USER || ''}>`,
        to: recipient.email,
        subject: content.subject,
        text: content.body,
        html: content.htmlBody || content.body.replace(/\n/g, '<br>'),
      });

      console.log('Email sent successfully:', {
        messageId: result.messageId,
        response: result.response,
        to: recipient.email,
        subject: content.subject
      });

      return true;
    } catch (error) {
      console.error('Detailed error sending email:', {
        error: error instanceof Error ? {
          name: error.name,
          message: error.message,
          stack: error.stack
        } : error,
        recipient: recipient.email,
        subject: content.subject
      });
      return false;
    }
  }
}

export const emailAdapter = EmailAdapter.getInstance();
--- End of Content for EmailAdapter.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\notification\adapters\WhatsAppAdapter.ts
--------------------------------------------------------------------------------
Content:
// lib/WhatsAppAdapter.ts
import {
  NotificationAdapter,
  NotificationChannel,
  RecipientInfo,
  NotificationContent as BaseNotificationContent
} from '../NotificationService';
import twilio from 'twilio';
import { MessageListInstanceCreateOptions } from 'twilio/lib/rest/api/v2010/account/message';

interface NotificationContent extends BaseNotificationContent {
  _adapterSpecificData?: {
      contentSid?: string;
      contentVariables?: string;
  };
}

interface PotentialTwilioError {
  code?: number | string;
  message?: string;
}

function isPotentialTwilioError(error: unknown): error is PotentialTwilioError {
  return typeof error === 'object' && error !== null && ('code' in error || 'message' in error);
}

const logger = {
  info: (message: string, meta?: Record<string, unknown> | object) => {
    console.log(JSON.stringify({ timestamp: new Date().toISOString(), level: 'info', service: 'WhatsAppAdapter', message, ...(meta || {}) }));
  },
  warn: (message: string, meta?: Record<string, unknown> | object) => {
    console.warn(JSON.stringify({ timestamp: new Date().toISOString(), level: 'warn', service: 'WhatsAppAdapter', message, ...(meta || {}) }));
  },
  error: (message: string, meta?: Record<string, unknown> | object) => {
    let logMeta = meta || {};
    if (meta instanceof Error) {
        logMeta = { name: meta.name, message: meta.message, stack: meta.stack };
    } else if (isPotentialTwilioError(meta)) {
        logMeta = { code: meta.code, message: meta.message, ...meta };
    }
    console.error(JSON.stringify({ timestamp: new Date().toISOString(), level: 'error', service: 'WhatsAppAdapter', message, ...logMeta }));
  },
};


export class WhatsAppAdapter implements NotificationAdapter {
  private static instance: WhatsAppAdapter;
  private client: twilio.Twilio | null = null;
  private fromNumber: string = '';

  private constructor() {
    const accountSid = process.env.TWILIO_ACCOUNT_SID;
    const authToken = process.env.TWILIO_AUTH_TOKEN;
    this.fromNumber = process.env.TWILIO_WHATSAPP_NUMBER || '';

    if (!accountSid || !authToken || !this.fromNumber) {
      logger.error('Missing Twilio configuration details', {
          hasSid: !!accountSid,
          hasToken: !!authToken,
          hasWhatsAppNumber: !!this.fromNumber,
          detail: "WhatsApp notifications will be unavailable."
      });
    } else if (!this.fromNumber.startsWith('+')) {
      // --- NEW VALIDATION ---
      logger.error('Invalid TWILIO_WHATSAPP_NUMBER format in .env. It must start with a "+".', {
          providedNumber: this.fromNumber
      });
      this.fromNumber = ''; // Invalidate the number to prevent sending
      // --- END NEW VALIDATION ---
    } else {
      try {
        this.client = twilio(accountSid, authToken);
        logger.info('Twilio client initialized successfully', { fromWhatsAppNumber: this.fromNumber });
      } catch (error: unknown) {
        logger.error('Failed to initialize Twilio client during constructor', { error });
        this.client = null;
      }
    }
  }

  public static getInstance(): WhatsAppAdapter {
    if (!WhatsAppAdapter.instance) {
      WhatsAppAdapter.instance = new WhatsAppAdapter();
    }
    return WhatsAppAdapter.instance;
  }

  public getChannelType(): NotificationChannel {
    return 'whatsapp';
  }

  public canSendTo(recipient: RecipientInfo): boolean {
    // --- UPDATED VALIDATION ---
    // Using a more robust check for E.164 format
    const hasValidPhone = !!recipient.phone && /^\+[1-9]\d{1,14}$/.test(recipient.phone);
    // --- END UPDATED VALIDATION ---
    const isClientReady = this.client !== null;
    const hasFromNumber = this.fromNumber !== '';
    const canSend = hasValidPhone && isClientReady && hasFromNumber;

    if (!canSend) {
        let reason = 'Unknown';
        if (!hasValidPhone) reason = 'Invalid or missing phone number (must be in E.164 format, e.g., +14155552671)';
        else if (!isClientReady) reason = 'Twilio client not initialized';
        else if (!hasFromNumber) reason = 'Twilio "from" number not configured or invalid';
        logger.warn('Cannot send WhatsApp message due to configuration or recipient data', {
            reason: reason,
            recipientPhone: recipient.phone
        });
    }
    return canSend;
  }

  // --- REMOVED `formatPhoneNumber` method ---
  // This method is no longer needed as we expect a valid E.164 number directly.

  public async send(recipient: RecipientInfo, content: NotificationContent): Promise<boolean> {
    logger.info('Attempting to send WhatsApp message', {
      recipientPhone: recipient.phone,
      fromNumber: this.fromNumber,
      hasClient: !!this.client,
      contentSid: content._adapterSpecificData?.contentSid,
      hasContentVariables: !!content._adapterSpecificData?.contentVariables,
    });

    if (!this.client || !this.fromNumber) {
      logger.error('Pre-send check failed: Twilio client or fromNumber is not configured.');
      return false;
    }
    
    // --- SIMPLIFIED VALIDATION ---
    if (!recipient.phone || !recipient.phone.startsWith('+')) {
      logger.error('Recipient phone number is missing or not in E.164 format.', { phone: recipient.phone });
      return false;
    }
    // --- END SIMPLIFIED VALIDATION ---

    try {
      // --- SIMPLIFIED NUMBER FORMATTING ---
      const fromWhatsAppFormatted = `whatsapp:${this.fromNumber}`;
      const toWhatsAppFormatted = `whatsapp:${recipient.phone}`; // Use the number directly
      // --- END SIMPLIFIED NUMBER FORMATTING ---

      logger.info(`Formatted numbers for sending via Twilio`, { from: fromWhatsAppFormatted, to: toWhatsAppFormatted });

      let messagePayload: MessageListInstanceCreateOptions;
      const adapterData = content._adapterSpecificData;

      if (adapterData?.contentSid && adapterData?.contentVariables) {
         logger.info(`Preparing WhatsApp template message`, { contentSid: adapterData.contentSid });
         messagePayload = {
            from: fromWhatsAppFormatted,
            to: toWhatsAppFormatted,
            contentSid: adapterData.contentSid,
            contentVariables: adapterData.contentVariables,
         };
      } else {
         const bodyText = content.body || content.subject || 'הודעה ממערכת השידוכים';
         logger.warn(`Preparing raw text WhatsApp message (using fallback, might fail)`, { bodyLength: bodyText.length });
         messagePayload = {
            from: fromWhatsAppFormatted,
            to: toWhatsAppFormatted,
            body: bodyText,
         };
      }
      
      logger.info("Sending message payload to Twilio API", { payload: {from: messagePayload.from, to: messagePayload.to, contentSid: messagePayload.contentSid} }); // Log safer data
      const message = await this.client.messages.create(messagePayload);
      
      logger.info('WhatsApp message request processed successfully by Twilio', {
        messageSid: message.sid,
        status: message.status,
        to: toWhatsAppFormatted,
        from: fromWhatsAppFormatted,
        price: message.price,
        priceUnit: message.priceUnit,
        errorCode: message.errorCode,
        errorMessage: message.errorMessage,
      });
      return true;

    } catch (error: unknown) {
      let errorMessage = 'Unknown error occurred while sending WhatsApp message.';
      let errorCode: number | string | undefined;

      if (isPotentialTwilioError(error)) {
          errorCode = error.code;
          errorMessage = error.message || errorMessage;
      } else if (error instanceof Error) {
          errorMessage = error.message;
      } else if (typeof error === 'string') {
          errorMessage = error;
      }

      logger.error('Failed to send WhatsApp message via Twilio', {
        errorCode,
        errorMessage,
        recipient: recipient.phone,
        from: this.fromNumber,
        errorDetails: error
      });

      if (errorCode === 63018 || errorCode === 21614) {
           logger.error(`Recipient number appears invalid or not registered on WhatsApp.`, { phone: recipient.phone, errorCode });
      } else if (errorCode === 63016) {
            logger.warn(`Failed to send non-template message outside 24-hour window.`, { phone: recipient.phone, errorCode });
      }

      return false;
    }
  }
}

export const whatsAppAdapter = WhatsAppAdapter.getInstance();
--- End of Content for WhatsAppAdapter.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\suggestions
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\suggestions\StatusTransitionService.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/suggestions/services/suggestions/StatusTransitionService.ts

import { MatchSuggestionStatus, User, MatchSuggestion, Profile } from "@prisma/client";
import prisma from "@/lib/prisma";
import { notificationService } from "../notification/NotificationService";
// ========================= שלב 1: ייבוא טיפוס המילון =========================
import type { EmailDictionary } from "@/types/dictionary";
// =========================================================================

type UserWithProfile = User & {
  profile: Profile | null;
};

export type SuggestionWithParties = MatchSuggestion & {
  firstParty: UserWithProfile;
  secondParty: UserWithProfile;
  matchmaker: User;
};

type TransitionOptions = {
  sendNotifications?: boolean;
  customMessage?: string;
  notifyParties?: ('first' | 'second' | 'matchmaker')[];
};

export class StatusTransitionService {
  private static instance: StatusTransitionService;
  private constructor() {}

  public static getInstance(): StatusTransitionService {
    if (!StatusTransitionService.instance) {
      StatusTransitionService.instance = new StatusTransitionService();
    }
    return StatusTransitionService.instance;
  }

  // ========================= שלב 2: עדכון חתימת הפונקציה =========================
  // הפונקציה מקבלת כעת את המילון (dictionary) כפרמטר שלישי, שהוא חובה.
  async transitionStatus(
    suggestion: SuggestionWithParties,
    newStatus: MatchSuggestionStatus,
    dictionary: EmailDictionary, // <-- הוספת המילון כפרמטר
    notes?: string,
    options: TransitionOptions = {}
  ): Promise<SuggestionWithParties> {
    const previousStatus = suggestion.status;
    const mergedOptions = {
      sendNotifications: true,
      notifyParties: ['first', 'second', 'matchmaker'],
      ...options
    };

    // Validate the transition
    this.validateStatusTransition(previousStatus, newStatus);

    // Perform the status transition in a transaction (הקוד כאן נשאר זהה)
    const updatedSuggestion = await prisma.$transaction(async (tx) => {
      const updated = await tx.matchSuggestion.update({
        where: { id: suggestion.id },
        data: {
          status: newStatus,
          previousStatus,
          lastStatusChange: new Date(),
          lastActivity: new Date(),
          ...(newStatus === MatchSuggestionStatus.FIRST_PARTY_APPROVED && { firstPartyResponded: new Date() }),
          ...(newStatus === MatchSuggestionStatus.PENDING_SECOND_PARTY && { secondPartySent: new Date() }),
          ...(newStatus === MatchSuggestionStatus.SECOND_PARTY_APPROVED && { secondPartyResponded: new Date() }),
          ...(newStatus === MatchSuggestionStatus.CONTACT_DETAILS_SHARED && { closedAt: new Date() }),
          ...(newStatus === MatchSuggestionStatus.MEETING_SCHEDULED && { firstMeetingScheduled: new Date() }),
        },
        include: {
          firstParty: { include: { profile: true } },
          secondParty: { include: { profile: true } },
          matchmaker: true,
        },
      });

      await tx.suggestionStatusHistory.create({
        data: {
          suggestionId: suggestion.id,
          status: newStatus,
          notes: notes || `Status changed from ${previousStatus} to ${newStatus}`,
        },
      });

      return updated;
    });

    // Only send notifications if option is enabled
    if (mergedOptions.sendNotifications) {
      try {
        // ========================= שלב 3: קריאה נכונה לשירות ההתראות =========================
        // כעת אנו מעבירים את המילון כארגומנט השני, ואת ההגדרות כשלישי.
        await notificationService.handleSuggestionStatusChange(
          updatedSuggestion, 
          dictionary, // <-- ארגומנט 2: המילון
          {           // <-- ארגומנט 3: אובייקט ההגדרות
            channels: ['email', 'whatsapp'],
            notifyParties: mergedOptions.notifyParties as ('first' | 'second' | 'matchmaker')[],
            customMessage: mergedOptions.customMessage
          }
        );
        // ======================================================================================
        
        console.log(`Notifications sent for suggestion ${updatedSuggestion.id} status change to ${newStatus}`);
      } catch (error) {
        // Log error but don't fail the transition
        console.error('Error sending status transition notifications:', error);
      }
    }

    return updatedSuggestion;
  }

  // הפונקציות הבאות נשארות ללא שינוי
  private validateStatusTransition(
    currentStatus: MatchSuggestionStatus, 
    newStatus: MatchSuggestionStatus
  ): void {
    const validTransitions: Record<MatchSuggestionStatus, MatchSuggestionStatus[]> = {
      DRAFT: [MatchSuggestionStatus.PENDING_FIRST_PARTY],
      PENDING_FIRST_PARTY: [
        MatchSuggestionStatus.FIRST_PARTY_APPROVED,
        MatchSuggestionStatus.FIRST_PARTY_DECLINED,
        MatchSuggestionStatus.CANCELLED
      ],
      FIRST_PARTY_APPROVED: [
        MatchSuggestionStatus.PENDING_SECOND_PARTY,
        MatchSuggestionStatus.CANCELLED
      ],
      FIRST_PARTY_DECLINED: [
        MatchSuggestionStatus.CLOSED
      ],
      PENDING_SECOND_PARTY: [
        MatchSuggestionStatus.SECOND_PARTY_APPROVED,
        MatchSuggestionStatus.SECOND_PARTY_DECLINED,
        MatchSuggestionStatus.CANCELLED
      ],
      SECOND_PARTY_APPROVED: [
        MatchSuggestionStatus.CONTACT_DETAILS_SHARED,
        MatchSuggestionStatus.CANCELLED
      ],
      SECOND_PARTY_DECLINED: [
        MatchSuggestionStatus.CLOSED
      ],
      AWAITING_MATCHMAKER_APPROVAL: [
        MatchSuggestionStatus.CONTACT_DETAILS_SHARED,
        MatchSuggestionStatus.CANCELLED
      ],
      CONTACT_DETAILS_SHARED: [
        MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK,
        MatchSuggestionStatus.CANCELLED
      ],
      AWAITING_FIRST_DATE_FEEDBACK: [
        MatchSuggestionStatus.THINKING_AFTER_DATE,
        MatchSuggestionStatus.ENDED_AFTER_FIRST_DATE,
        MatchSuggestionStatus.CANCELLED
      ],
      THINKING_AFTER_DATE: [
        MatchSuggestionStatus.PROCEEDING_TO_SECOND_DATE,
        MatchSuggestionStatus.ENDED_AFTER_FIRST_DATE,
        MatchSuggestionStatus.CANCELLED
      ],
      PROCEEDING_TO_SECOND_DATE: [
        MatchSuggestionStatus.DATING,
        MatchSuggestionStatus.CANCELLED
      ],
      ENDED_AFTER_FIRST_DATE: [
        MatchSuggestionStatus.CLOSED
      ],
      MEETING_PENDING: [
        MatchSuggestionStatus.MEETING_SCHEDULED,
        MatchSuggestionStatus.CANCELLED
      ],
      MEETING_SCHEDULED: [
        MatchSuggestionStatus.DATING,
        MatchSuggestionStatus.CANCELLED
      ],
      MATCH_APPROVED: [
        MatchSuggestionStatus.DATING,
        MatchSuggestionStatus.CANCELLED
      ],
      MATCH_DECLINED: [
        MatchSuggestionStatus.CLOSED
      ],
      DATING: [
        MatchSuggestionStatus.ENGAGED,
        MatchSuggestionStatus.CLOSED,
        MatchSuggestionStatus.CANCELLED
      ],
      ENGAGED: [
        MatchSuggestionStatus.MARRIED,
        MatchSuggestionStatus.CANCELLED
      ],
      MARRIED: [],
      EXPIRED: [],
      CLOSED: [],
      CANCELLED: []
    };

    if (!validTransitions[currentStatus]?.includes(newStatus)) {
      throw new Error(
        `Invalid status transition from ${currentStatus} to ${newStatus}. ` +
        `Valid transitions are: ${validTransitions[currentStatus]?.join(', ') || 'none'}`
      );
    }
  }
  
  getStatusLabel(status: MatchSuggestionStatus): string {
    const statusLabels: Record<MatchSuggestionStatus, string> = {
      DRAFT: "טיוטה",
      PENDING_FIRST_PARTY: "ממתין לתשובת הצד הראשון",
      FIRST_PARTY_APPROVED: "הצד הראשון אישר",
      FIRST_PARTY_DECLINED: "הצד הראשון דחה",
      PENDING_SECOND_PARTY: "ממתין לתשובת הצד השני",
      SECOND_PARTY_APPROVED: "הצד השני אישר",
      SECOND_PARTY_DECLINED: "הצד השני דחה",
      AWAITING_MATCHMAKER_APPROVAL: "ממתין לאישור השדכן",
      CONTACT_DETAILS_SHARED: "פרטי קשר שותפו",
      AWAITING_FIRST_DATE_FEEDBACK: "ממתין למשוב פגישה ראשונה",
      THINKING_AFTER_DATE: "בחשיבה לאחר הפגישה",
      PROCEEDING_TO_SECOND_DATE: "התקדמות לפגישה שנייה",
      ENDED_AFTER_FIRST_DATE: "הסתיים לאחר פגישה ראשונה",
      MEETING_PENDING: "פגישה בהמתנה",
      MEETING_SCHEDULED: "פגישה קבועה",
      MATCH_APPROVED: "השידוך אושר",
      MATCH_DECLINED: "השידוך נדחה",
      DATING: "בתהליך היכרות",
      ENGAGED: "אירוסין",
      MARRIED: "נישואין",
      CANCELLED: "בוטל",
      CLOSED: "נסגר",
      EXPIRED: "פג תוקף"
    };
    
    return statusLabels[status] || status;
  }
  
  getAvailableActions(
    suggestion: SuggestionWithParties, 
    userId: string
  ): { id: string; label: string; nextStatus: MatchSuggestionStatus }[] {
    const isFirstParty = suggestion.firstPartyId === userId;
    const isSecondParty = suggestion.secondPartyId === userId;
    const isMatchmaker = suggestion.matchmakerId === userId;
    
    const actions: Record<MatchSuggestionStatus, { 
      firstParty?: { id: string; label: string; nextStatus: MatchSuggestionStatus }[];
      secondParty?: { id: string; label: string; nextStatus: MatchSuggestionStatus }[];
      matchmaker?: { id: string; label: string; nextStatus: MatchSuggestionStatus }[];
    }> = {
      DRAFT: {
        matchmaker: [
          { id: "send-to-first", label: "שליחה לצד הראשון", nextStatus: MatchSuggestionStatus.PENDING_FIRST_PARTY }
        ]
      },
      PENDING_FIRST_PARTY: {
        firstParty: [
          { id: "approve", label: "אישור ההצעה", nextStatus: MatchSuggestionStatus.FIRST_PARTY_APPROVED },
          { id: "decline", label: "דחיית ההצעה", nextStatus: MatchSuggestionStatus.FIRST_PARTY_DECLINED }
        ],
        matchmaker: [
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      FIRST_PARTY_APPROVED: {
        matchmaker: [
          { id: "send-to-second", label: "שליחה לצד השני", nextStatus: MatchSuggestionStatus.PENDING_SECOND_PARTY },
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      FIRST_PARTY_DECLINED: {
        matchmaker: [
          { id: "close", label: "סגירת הצעה", nextStatus: MatchSuggestionStatus.CLOSED }
        ]
      },
      PENDING_SECOND_PARTY: {
        secondParty: [
          { id: "approve", label: "אישור ההצעה", nextStatus: MatchSuggestionStatus.SECOND_PARTY_APPROVED },
          { id: "decline", label: "דחיית ההצעה", nextStatus: MatchSuggestionStatus.SECOND_PARTY_DECLINED }
        ],
        matchmaker: [
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      SECOND_PARTY_APPROVED: {
        matchmaker: [
          { id: "share-contacts", label: "שיתוף פרטי קשר", nextStatus: MatchSuggestionStatus.CONTACT_DETAILS_SHARED },
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      SECOND_PARTY_DECLINED: {
        matchmaker: [
          { id: "close", label: "סגירת הצעה", nextStatus: MatchSuggestionStatus.CLOSED }
        ]
      },
      AWAITING_MATCHMAKER_APPROVAL: {
        matchmaker: [
          { id: "approve-share", label: "אישור שיתוף פרטים", nextStatus: MatchSuggestionStatus.CONTACT_DETAILS_SHARED },
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      CONTACT_DETAILS_SHARED: {
        firstParty: [
          { id: "provide-feedback", label: "דיווח משוב לאחר פגישה", nextStatus: MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK }
        ],
        secondParty: [
          { id: "provide-feedback", label: "דיווח משוב לאחר פגישה", nextStatus: MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK }
        ],
        matchmaker: [
          { id: "request-feedback", label: "בקש משוב", nextStatus: MatchSuggestionStatus.AWAITING_FIRST_DATE_FEEDBACK },
          { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      AWAITING_FIRST_DATE_FEEDBACK: {
         matchmaker: [
            { id: "mark-thinking", label: "סמן כ'בחשיבה'", nextStatus: MatchSuggestionStatus.THINKING_AFTER_DATE },
            { id: "mark-ended-first", label: "סמן כ'הסתיים לאחר פגישה'", nextStatus: MatchSuggestionStatus.ENDED_AFTER_FIRST_DATE },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      THINKING_AFTER_DATE: {
         matchmaker: [
            { id: "proceed-second", label: "המשך לפגישה שניה", nextStatus: MatchSuggestionStatus.PROCEEDING_TO_SECOND_DATE },
            { id: "mark-ended-first", label: "סמן כ'הסתיים לאחר פגישה'", nextStatus: MatchSuggestionStatus.ENDED_AFTER_FIRST_DATE },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      PROCEEDING_TO_SECOND_DATE: {
         matchmaker: [
            { id: "mark-dating", label: "סמן כ'בתהליך היכרות'", nextStatus: MatchSuggestionStatus.DATING },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      ENDED_AFTER_FIRST_DATE: {
        matchmaker: [
          { id: "close", label: "סגירת הצעה", nextStatus: MatchSuggestionStatus.CLOSED }
        ]
      },
      MEETING_PENDING: {
         matchmaker: [
            { id: "schedule-meeting", label: "קביעת פגישה", nextStatus: MatchSuggestionStatus.MEETING_SCHEDULED },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      MEETING_SCHEDULED: {
         matchmaker: [
            { id: "mark-dating", label: "סמן כ'בתהליך היכרות'", nextStatus: MatchSuggestionStatus.DATING },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      MATCH_APPROVED: {
         matchmaker: [
            { id: "mark-dating", label: "סמן כ'בתהליך היכרות'", nextStatus: MatchSuggestionStatus.DATING },
            { id: "cancel", label: "ביטול ההצעה", nextStatus: MatchSuggestionStatus.CANCELLED }
         ]
      },
      MATCH_DECLINED: {
        matchmaker: [
          { id: "close", label: "סגירת הצעה", nextStatus: MatchSuggestionStatus.CLOSED }
        ]
      },
      DATING: {
        matchmaker: [
          { id: "mark-engaged", label: "עדכון אירוסין", nextStatus: MatchSuggestionStatus.ENGAGED },
          { id: "close", label: "סגירת תהליך", nextStatus: MatchSuggestionStatus.CLOSED },
          { id: "cancel", label: "ביטול השידוך", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      ENGAGED: {
        matchmaker: [
          { id: "mark-married", label: "עדכון נישואין", nextStatus: MatchSuggestionStatus.MARRIED },
          { id: "cancel", label: "ביטול אירוסין", nextStatus: MatchSuggestionStatus.CANCELLED }
        ]
      },
      MARRIED: {},
      EXPIRED: {},
      CLOSED: {},
      CANCELLED: {}
    };
    
    if (isFirstParty && actions[suggestion.status]?.firstParty) {
      return actions[suggestion.status].firstParty || [];
    }
    
    if (isSecondParty && actions[suggestion.status]?.secondParty) {
      return actions[suggestion.status].secondParty || [];
    }
    
    if (isMatchmaker && actions[suggestion.status]?.matchmaker) {
      return actions[suggestion.status].matchmaker || [];
    }
    
    return [];
  }
}

// Export singleton instance
export const statusTransitionService = StatusTransitionService.getInstance();
--- End of Content for StatusTransitionService.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\services\suggestions\SuggestionService.ts
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/services/suggestions/SuggestionService.ts

import { MatchSuggestionStatus, Priority, UserRole } from "@prisma/client";
import prisma from "@/lib/prisma";
import { statusTransitionService, type SuggestionWithParties } from "./StatusTransitionService";
import { initNotificationService } from "../notification/initNotifications";
import type { 
  CreateSuggestionData,
  UpdateSuggestionData,
} from "@/types/suggestions";
import type { EmailDictionary } from "@/types/dictionary";

// הפעלת שירות ההתראות. הפעולה מתבצעת פעם אחת כשהמודול נטען.
const notificationService = initNotificationService();

// רשימת סטטוסים החוסמים יצירת הצעה חדשה עבור מועמד
const BLOCKING_SUGGESTION_STATUSES: MatchSuggestionStatus[] = [
  'FIRST_PARTY_APPROVED',
  'SECOND_PARTY_APPROVED',
  'AWAITING_MATCHMAKER_APPROVAL',
  'CONTACT_DETAILS_SHARED',
  'AWAITING_FIRST_DATE_FEEDBACK',
  'THINKING_AFTER_DATE',
  'PROCEEDING_TO_SECOND_DATE',
  'MEETING_PENDING',
  'MEETING_SCHEDULED',
  'MATCH_APPROVED',
  'DATING',
];

/**
 * שירות מרכזי לניהול הלוגיקה העסקית של הצעות שידוכים.
 * הוא אחראי על יצירה, עדכון, שינוי סטטוס, ואחזור של הצעות.
 */
export class SuggestionService {
  private static instance: SuggestionService;

  private constructor() {}

  public static getInstance(): SuggestionService {
    if (!SuggestionService.instance) {
      SuggestionService.instance = new SuggestionService();
    }
    return SuggestionService.instance;
  }

  /**
   * יצירת הצעת שידוך חדשה.
   * הפונקציה מקבלת את נתוני ההצעה ואת המילון המתורגם כדי לשלוח התראות בשפה הנכונה.
   */
  public async createSuggestion(
    data: CreateSuggestionData,
    dictionary: EmailDictionary 
  ): Promise<SuggestionWithParties> {
    // 1. וידוא הרשאות השדכן
    const matchmaker = await prisma.user.findUnique({
      where: { id: data.matchmakerId },
    });

    const allowedRoles: UserRole[] = [UserRole.MATCHMAKER, UserRole.ADMIN];
    if (!matchmaker || !allowedRoles.includes(matchmaker.role)) {
      throw new Error("Unauthorized - User must be a Matchmaker or Admin");
    }
  
    // 2. בדיקה אם לאחד המועמדים כבר יש הצעה פעילה
    const [firstParty, secondParty] = await Promise.all([
        prisma.user.findUnique({ where: { id: data.firstPartyId } }),
        prisma.user.findUnique({ where: { id: data.secondPartyId } })
    ]);

    if (!firstParty || !secondParty) {
        throw new Error("One or both candidates not found.");
    }
    
    const blockingSuggestion = await prisma.matchSuggestion.findFirst({
        where: {
            OR: [
                { firstPartyId: data.firstPartyId },
                { secondPartyId: data.firstPartyId },
                { firstPartyId: data.secondPartyId },
                { secondPartyId: data.secondPartyId },
            ],
            status: { in: BLOCKING_SUGGESTION_STATUSES },
        },
    });

    if (blockingSuggestion) {
        const hasBlockingSuggestion = (id: string) => 
            blockingSuggestion.firstPartyId === id || blockingSuggestion.secondPartyId === id;
            
        if (hasBlockingSuggestion(data.firstPartyId)) {
            throw new Error(`לא ניתן ליצור הצעה חדשה. ל${firstParty.firstName} ${firstParty.lastName} יש כבר הצעה פעילה.`);
        }
        if (hasBlockingSuggestion(data.secondPartyId)) {
            throw new Error(`לא ניתן ליצור הצעה חדשה. ל${secondParty.firstName} ${secondParty.lastName} יש כבר הצעה פעילה.`);
        }
    }

    // 3. יצירת ההצעה בטרנזקציה להבטחת שלמות הנתונים
    const suggestion = await prisma.$transaction(async (tx) => {
      const cleanedData = {
        matchmakerId: data.matchmakerId,
        firstPartyId: data.firstPartyId,
        secondPartyId: data.secondPartyId,
        status: MatchSuggestionStatus.PENDING_FIRST_PARTY,
        priority: data.priority || Priority.MEDIUM,
        matchingReason: data.notes?.matchingReason || null,
        firstPartyNotes: data.notes?.forFirstParty || null,
        secondPartyNotes: data.notes?.forSecondParty || null,
        internalNotes: data.notes?.internal || null,
        followUpNotes: data.notes?.followUpNotes || null,
        decisionDeadline: new Date(data.decisionDeadline),
        firstPartySent: new Date(),
        lastActivity: new Date(),
        lastStatusChange: new Date()
      };

      const newSuggestion = await tx.matchSuggestion.create({
        data: cleanedData,
        include: {
          firstParty: { include: { profile: true } },
          secondParty: { include: { profile: true } },
          matchmaker: true,
        },
      });

      await tx.suggestionStatusHistory.create({
        data: {
          suggestionId: newSuggestion.id,
          status: newSuggestion.status,
          notes: "Initial suggestion created and sent to first party",
        },
      });

      return newSuggestion;
    });

    // 4. שליחת התראות
    try {
      console.log('Sending notifications for new suggestion...');
      await notificationService.handleSuggestionStatusChange(
        suggestion,
        dictionary, // הארגומנט השני הוא המילון
        { // הארגומנט השלישי הוא אובייקט ההגדרות
          channels: ['email', 'whatsapp'],
          notifyParties: ['first']
        }
      );
    } catch (error) {
      console.error('Error sending initial suggestion notifications:', error);
    }

    return suggestion;
  }

  /**
   * עדכון פרטי הצעת שידוך (ללא שינוי סטטוס).
   */
  public async updateSuggestion(
    id: string,
    matchmakerId: string,
    data: UpdateSuggestionData
  ): Promise<SuggestionWithParties> {
    const suggestion = await prisma.matchSuggestion.findUnique({
      where: { id },
      include: {
        firstParty: { include: { profile: true } },
        secondParty: { include: { profile: true } },
        matchmaker: true,
      },
    });

    if (!suggestion) {
      throw new Error("Suggestion not found");
    }

    if (suggestion.matchmakerId !== matchmakerId) {
      throw new Error("Unauthorized - Only the original matchmaker can update the suggestion");
    }

    const cleanedUpdateData = {
      ...(data.notes?.matchingReason !== undefined && { matchingReason: data.notes.matchingReason }),
      ...(data.notes?.forFirstParty !== undefined && { firstPartyNotes: data.notes.forFirstParty }),
      ...(data.notes?.forSecondParty !== undefined && { secondPartyNotes: data.notes.forSecondParty }),
      ...(data.notes?.internal !== undefined && { internalNotes: data.notes.internal }),
      ...(data.notes?.followUpNotes !== undefined && { followUpNotes: data.notes.followUpNotes }),
      ...(data.priority && { priority: data.priority }),
      ...(data.decisionDeadline && { decisionDeadline: new Date(data.decisionDeadline) }),
      lastActivity: new Date()
    };

    return await prisma.matchSuggestion.update({
      where: { id },
      data: cleanedUpdateData,
      include: {
        firstParty: { include: { profile: true } },
        secondParty: { include: { profile: true } },
        matchmaker: true,
      },
    });
  }

  /**
   * עדכון סטטוס של הצעת שידוך.
   * הפונקציה מקבלת את המילון כדי להעביר אותו לשירות המעבר, שישלח התראות מתורגמות.
   */
  public async updateSuggestionStatus(
    id: string,
    newStatus: MatchSuggestionStatus,
    userId: string,
    dictionary: EmailDictionary, // <-- פרמטר המילון החדש והמתוקן
    notes?: string
  ): Promise<SuggestionWithParties> {
    const suggestion = await prisma.matchSuggestion.findUnique({
      where: { id },
      include: {
        firstParty: { include: { profile: true } },
        secondParty: { include: { profile: true } },
        matchmaker: true,
      },
    });

    if (!suggestion) {
      throw new Error("Suggestion not found");
    }

    this.validateStatusChangePermission(suggestion, userId, newStatus);
    
    // קריאה מתוקנת לשירות המעבר, עם העברת המילון כפרמטר השלישי
    return await statusTransitionService.transitionStatus(
      suggestion, 
      newStatus, 
      dictionary, // <-- העברת המילון
      notes
    );
  }

  /**
   * קבלת פרטי הצעת שידוך מלאים.
   */
  public async getSuggestionDetails(id: string, userId: string): Promise<SuggestionWithParties> {
    const suggestion = await prisma.matchSuggestion.findUnique({
      where: { id },
      include: {
        firstParty: { include: { profile: true } },
        secondParty: { include: { profile: true } },
        matchmaker: true,
        statusHistory: { orderBy: { createdAt: "desc" } },
        meetings: { include: { feedback: true } },
      },
    });

    if (!suggestion) {
      throw new Error("Suggestion not found");
    }

    if (
      userId !== suggestion.matchmakerId &&
      userId !== suggestion.firstPartyId &&
      userId !== suggestion.secondPartyId
    ) {
      throw new Error("Unauthorized to view this suggestion");
    }

    return suggestion;
  }

  /**
   * קבלת כל הצעות השידוך הקשורות למשתמש מסוים.
   */
  public async getUserSuggestions(userId: string): Promise<SuggestionWithParties[]> {
    return await prisma.matchSuggestion.findMany({
      where: {
        OR: [
          { matchmakerId: userId },
          { firstPartyId: userId },
          { secondPartyId: userId },
        ],
      },
      include: {
        firstParty: { include: { profile: true } },
        secondParty: { include: { profile: true } },
        matchmaker: true,
        statusHistory: { orderBy: { createdAt: "desc" } },
        meetings: { include: { feedback: true } },
      },
      orderBy: { lastActivity: "desc" },
    });
  }

  /**
   * פונקציית עזר פנימית לאימות הרשאות לשינוי סטטוס.
   */
  private validateStatusChangePermission(
    suggestion: SuggestionWithParties,
    userId: string,
    newStatus: MatchSuggestionStatus
  ): void {
    const isMatchmaker = userId === suggestion.matchmakerId;
    const isFirstParty = userId === suggestion.firstPartyId;

    switch (newStatus) {
      case MatchSuggestionStatus.FIRST_PARTY_APPROVED:
      case MatchSuggestionStatus.FIRST_PARTY_DECLINED:
        if (!isFirstParty) throw new Error("Only first party can approve/decline at this stage");
        break;

      // ניתן להוסיף כאן לוגיקות הרשאה נוספות עבור סטטוסים אחרים בעתיד.
      
      default:
        // כברירת מחדל, רוב שינויי הסטטוס מבוצעים על ידי השדכן.
        if (!isMatchmaker) {
          // חריג: אם הצד השני מאשר/דוחה
          if (
            (newStatus === MatchSuggestionStatus.SECOND_PARTY_APPROVED || newStatus === MatchSuggestionStatus.SECOND_PARTY_DECLINED) &&
            userId === suggestion.secondPartyId
          ) {
            // זה תקין
          } else {
            throw new Error("Only matchmaker can change status at this stage");
          }
        }
    }
  }
}

// ייצוא מופע יחיד של השירות (Singleton)
export const suggestionService = SuggestionService.getInstance();
--- End of Content for SuggestionService.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\utils
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\utils\matchingAlgorithm.ts
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/suggestions/utils/matchingAlgorithm.ts

import { AvailabilityStatus } from '@prisma/client';
import type { UserProfile } from '@/types/next-auth';

export interface MatchScore {
  score: number;
  criteria: MatchCriteria[];
  compatibility: number;
  reasons: string[]; // This will now contain keys, e.g., "age.reasons.ideal"
}

export interface MatchCriteria {
  name: string;
  weight: number;
  score: number;
  reason?: string; // This will also be a key
}

interface AgePreference {
  min: number;
  max: number;
}

const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

const calculateAgeCompatibility = (
  profileA: UserProfile,
  profileB: UserProfile,
  preferences: { ageA?: AgePreference; ageB?: AgePreference }
): MatchCriteria => {
  const ageA = calculateAge(profileA.birthDate);
  const ageB = calculateAge(profileB.birthDate);
  const ageDiff = Math.abs(ageA - ageB);
  
  let score = 0;
  let reason = '';

  const aPrefsMatch = preferences.ageA ? 
    (ageB >= preferences.ageA.min && ageB <= preferences.ageA.max) : true;
  const bPrefsMatch = preferences.ageB ?
    (ageA >= preferences.ageB.min && ageA <= preferences.ageB.max) : true;

  if (aPrefsMatch && bPrefsMatch) {
    if (ageDiff <= 2) {
      score = 1;
      reason = 'age.reasons.ideal';
    } else if (ageDiff <= 5) {
      score = 0.8;
      reason = 'age.reasons.good';
    } else if (ageDiff <= 8) {
      score = 0.6;
      reason = 'age.reasons.fair';
    } else {
      score = 0.4;
      reason = 'age.reasons.large';
    }
  } else {
    score = 0.2;
    reason = 'age.reasons.preferenceMismatch';
  }

  return {
    name: 'age',
    weight: 15,
    score,
    reason
  };
};

const calculateLocationCompatibility = (
  profileA: UserProfile,
  profileB: UserProfile
): MatchCriteria => {
  let score = 0;
  let reason = '';

  if (!profileA.city || !profileB.city) {
    return {
      name: 'location',
      weight: 10,
      score: 0.5,
      reason: 'location.reasons.noData'
    };
  }

  const sameCity = profileA.city === profileB.city;
  const preferredLocationsA = profileA.preferredLocations || [];
  const preferredLocationsB = profileB.preferredLocations || [];

  if (sameCity) {
    score = 1;
    reason = 'location.reasons.sameCity';
  } else if (
    preferredLocationsA.includes(profileB.city) &&
    preferredLocationsB.includes(profileA.city)
  ) {
    score = 0.8;
    reason = 'location.reasons.mutualPreference';
  } else if (
    preferredLocationsA.includes(profileB.city) ||
    preferredLocationsB.includes(profileA.city)
  ) {
    score = 0.6;
    reason = 'location.reasons.oneWayPreference';
  } else {
    score = 0.4;
    reason = 'location.reasons.differentCities';
  }

  return {
    name: 'location',
    weight: 10,
    score,
    reason
  };
};

const calculateReligiousCompatibility = (
  profileA: UserProfile,
  profileB: UserProfile
): MatchCriteria => {
  let score = 0;
  let reason = '';

  if (!profileA.religiousLevel || !profileB.religiousLevel) {
    return {
      name: 'religious',
      weight: 20,
      score: 0.5,
      reason: 'religious.reasons.noData'
    };
  }

  const sameLevel = profileA.religiousLevel === profileB.religiousLevel;
  const preferredLevelsA = profileA.preferredReligiousLevels || [];
  const preferredLevelsB = profileB.preferredReligiousLevels || [];

  if (sameLevel) {
    score = 1;
    reason = 'religious.reasons.sameLevel';
  } else if (
    preferredLevelsA.includes(profileB.religiousLevel) &&
    preferredLevelsB.includes(profileA.religiousLevel)
  ) {
    score = 0.8;
    reason = 'religious.reasons.mutualPreference';
  } else if (
    preferredLevelsA.includes(profileB.religiousLevel) ||
    preferredLevelsB.includes(profileA.religiousLevel)
  ) {
    score = 0.6;
    reason = 'religious.reasons.oneWayPreference';
  } else {
    score = 0.3;
    reason = 'religious.reasons.differentLevels';
  }

  return {
    name: 'religious',
    weight: 20,
    score,
    reason
  };
};

export const calculateMatchScore = (
  profileA: UserProfile,
  profileB: UserProfile
): MatchScore | null => {
  if (
    profileA.gender === profileB.gender ||
    profileA.availabilityStatus !== AvailabilityStatus.AVAILABLE ||
    profileB.availabilityStatus !== AvailabilityStatus.AVAILABLE
  ) {
    return null;
  }

  const ageCriteria = calculateAgeCompatibility(
    profileA,
    profileB,
    {
      ageA: profileA.preferredAgeMin && profileA.preferredAgeMax
        ? { min: profileA.preferredAgeMin, max: profileA.preferredAgeMax }
        : undefined,
      ageB: profileB.preferredAgeMin && profileB.preferredAgeMax
        ? { min: profileB.preferredAgeMin, max: profileB.preferredAgeMax }
        : undefined
    }
  );

  const locationCriteria = calculateLocationCompatibility(profileA, profileB);
  const religiousCriteria = calculateReligiousCompatibility(profileA, profileB);

  const criteria = [
    ageCriteria,
    locationCriteria,
    religiousCriteria
  ];

  const totalWeight = criteria.reduce((sum, c) => sum + c.weight, 0);
  const weightedScore = criteria.reduce((sum, c) => sum + (c.score * c.weight), 0);
  const finalScore = (weightedScore / totalWeight) * 100;

  const reasons = criteria
    .filter(c => c.score >= 0.6)
    .map(c => c.reason)
    .filter((reason): reason is string => reason !== undefined);

  return {
    score: Math.round(finalScore),
    criteria,
    compatibility: finalScore / 100,
    reasons
  };
};
--- End of Content for matchingAlgorithm.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\suggestions\utils\statisticsCalculator.ts
--------------------------------------------------------------------------------
Content:
// /utils/statisticsCalculator.ts
import type { Candidate } from '../../new/types/candidates';
import { Gender, AvailabilityStatus } from '@prisma/client';


export interface AgeDistribution {
  ageGroups: Record<string, number>;
  averageAge: number;
  medianAge: number;
}

export interface LocationDistribution {
  cities: Record<string, number>;
  topCities: Array<{ city: string; count: number }>;
}

export interface ReligiousDistribution {
  levels: Record<string, number>;
  percentages: Record<string, number>;
}

export interface ActivityStats {
  activeLastWeek: number;
  activeLastMonth: number;
  averageLoginFrequency: number;
  completedProfiles: number;
}

export interface MatchingStats {
  totalMatches: number;
  successfulMatches: number;
  averageMatchScore: number;
  matchesByStatus: Record<string, number>;
}

const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

export const calculateAgeDistribution = (candidates: Candidate[]): AgeDistribution => {
  const ages = candidates.map(c => calculateAge(c.profile.birthDate));
  
  // חישוב קבוצות גיל
  const ageGroups = ages.reduce((acc, age) => {
    const group = `${Math.floor(age / 5) * 5}-${Math.floor(age / 5) * 5 + 4}`;
    acc[group] = (acc[group] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  // חישוב ממוצע
  const averageAge = ages.reduce((sum, age) => sum + age, 0) / ages.length;

  // חישוב חציון
  const sortedAges = [...ages].sort((a, b) => a - b);
  const medianAge = sortedAges.length % 2 === 0
    ? (sortedAges[sortedAges.length / 2 - 1] + sortedAges[sortedAges.length / 2]) / 2
    : sortedAges[Math.floor(sortedAges.length / 2)];

  return {
    ageGroups,
    averageAge: Math.round(averageAge * 10) / 10,
    medianAge
  };
};

export const calculateLocationDistribution = (
  candidates: Candidate[],
  topCount: number = 10
): LocationDistribution => {
  // ספירת מועמדים לפי ערים
  const cities = candidates.reduce((acc, candidate) => {
    const city = candidate.profile.city || 'לא צוין';
    acc[city] = (acc[city] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  // מיון הערים לפי כמות מועמדים
  const topCities = Object.entries(cities)
    .map(([city, count]) => ({ city, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, topCount);

  return {
    cities,
    topCities
  };
};

export const calculateReligiousDistribution = (candidates: Candidate[]): ReligiousDistribution => {
  const total = candidates.length;
  
  // ספירת מועמדים לפי רמת דתיות
  const levels = candidates.reduce((acc, candidate) => {
    const level = candidate.profile.religiousLevel || 'לא צוין';
    acc[level] = (acc[level] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  // חישוב אחוזים
  const percentages = Object.entries(levels).reduce((acc, [level, count]) => {
    acc[level] = Math.round((count / total) * 100);
    return acc;
  }, {} as Record<string, number>);

  return {
    levels,
    percentages
  };
};

export const calculateActivityStats = (candidates: Candidate[]): ActivityStats => {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

  const activeLastWeek = candidates.filter(c => 
    c.profile.lastActive && new Date(c.profile.lastActive) >= weekAgo
  ).length;

  const activeLastMonth = candidates.filter(c =>
    c.profile.lastActive && new Date(c.profile.lastActive) >= monthAgo
  ).length;

  // חישוב תדירות התחברות ממוצעת (בימים)
  const loginGaps = candidates
    .filter(c => c.profile.lastActive)
    .map(c => {
      const lastActive = new Date(c.profile.lastActive!);
      return Math.floor((now.getTime() - lastActive.getTime()) / (24 * 60 * 60 * 1000));
    });

  const averageLoginFrequency = loginGaps.length > 0
    ? loginGaps.reduce((sum, gap) => sum + gap, 0) / loginGaps.length
    : 0;

  // ספירת פרופילים מלאים
  const completedProfiles = candidates.filter(c => 
    c.profile.about &&
    c.profile.religiousLevel &&
    c.profile.city &&
    c.images.length > 0
  ).length;

  return {
    activeLastWeek,
    activeLastMonth,
    averageLoginFrequency: Math.round(averageLoginFrequency * 10) / 10,
    completedProfiles
  };
};

export const calculateGenderStats = (candidates: Candidate[]) => {
  const maleCount = candidates.filter(c => c.profile.gender === Gender.MALE).length;
  const femaleCount = candidates.filter(c => c.profile.gender === Gender.FEMALE).length;
  
  return {
    maleCount,
    femaleCount,
    ratio: maleCount / femaleCount,
    total: candidates.length,
    percentages: {
      male: Math.round((maleCount / candidates.length) * 100),
      female: Math.round((femaleCount / candidates.length) * 100)
    }
  };
};

export const calculateAvailabilityStats = (candidates: Candidate[]) => {
  const total = candidates.length;
  const statusCounts = candidates.reduce((acc, candidate) => {
    const status = candidate.profile.availabilityStatus;
    acc[status] = (acc[status] || 0) + 1;
    return acc;
  }, {} as Record<AvailabilityStatus, number>);

  return {
    counts: statusCounts,
    percentages: Object.entries(statusCounts).reduce((acc, [status, count]) => {
      acc[status] = Math.round((count / total) * 100);
      return acc;
    }, {} as Record<string, number>)
  };
};

export const calculateCompletionStats = (candidates: Candidate[]) => {
  const total = candidates.length;
  const  stats = {
    hasPhotos: 0,
    hasAbout: 0,
    hasReferences: 0,
    hasPreferences: 0,
    isVerified: 0,
    fullyCompleted: 0
  };

  candidates.forEach(candidate => {
    if (candidate.images.length > 0) stats.hasPhotos++;
    if (candidate.profile.about) stats.hasAbout++;
    if (candidate.profile.preferredAgeMin && candidate.profile.preferredAgeMax) stats.hasPreferences++;
    if (candidate.isVerified) stats.isVerified++;
    
    // בדיקת פרופיל מלא
    if (
      candidate.images.length > 0 &&
      candidate.profile.about &&
      candidate.profile.religiousLevel &&
      candidate.profile.city &&
      candidate.profile.preferredAgeMin &&
      candidate.profile.preferredAgeMax
    ) {
      stats.fullyCompleted++;
    }
  });

  return {
    counts: stats,
    percentages: {
      hasPhotos: Math.round((stats.hasPhotos / total) * 100),
      hasAbout: Math.round((stats.hasAbout / total) * 100),
      hasReferences: Math.round((stats.hasReferences / total) * 100),
      hasPreferences: Math.round((stats.hasPreferences / total) * 100),
      isVerified: Math.round((stats.isVerified / total) * 100),
      fullyCompleted: Math.round((stats.fullyCompleted / total) * 100)
    }
  };
};

const statisticsCalculator = {
  calculateAgeDistribution,
  calculateLocationDistribution,
  calculateReligiousDistribution,
  calculateActivityStats,
  calculateGenderStats,
  calculateAvailabilityStats,
  calculateCompletionStats
};

export default statisticsCalculator;
--- End of Content for statisticsCalculator.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\AvailabilityRequestCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/AvailabilityRequestCard.tsx

import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Clock, CheckCircle, XCircle } from 'lucide-react';
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
import type { AvailabilityRequestCardDict } from '@/types/dictionary';
import { cn } from '@/lib/utils';
import type { Locale } from '../../../i18n-config';

interface AvailabilityRequestCardProps {
  inquiry: ExtendedAvailabilityInquiry;
  currentUserId: string;
  onRespond: (inquiryId: string, isAvailable: boolean) => Promise<void>;
  dict: AvailabilityRequestCardDict;
  locale: Locale;
}

export default function AvailabilityRequestCard({
  inquiry,
  currentUserId,
  onRespond,
  dict,
  locale,
}: AvailabilityRequestCardProps) {
  const isFirstParty = inquiry.firstPartyId === currentUserId;
  const isSecondParty = inquiry.secondPartyId === currentUserId;
  const totalResponses = [
    inquiry.firstPartyResponse,
    inquiry.secondPartyResponse,
  ].filter((r) => r !== null).length;
  const progress = (totalResponses / 2) * 100;

  return (
    <Card>
      <CardContent className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h3 className="font-medium">{dict.title}</h3>
            <p className="text-sm text-gray-600">
              {dict.fromMatchmaker.replace(
                '{{name}}',
                `${inquiry.matchmaker.firstName} ${inquiry.matchmaker.lastName}`
              )}
            </p>
          </div>
          <Clock className="w-5 h-5 text-gray-400" />
        </div>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-gray-500">
                {dict.firstPartyLabel}
              </div>
              <div className="flex items-center mt-1">
                {inquiry.firstPartyResponse === null ? (
                  <Clock
                    className={cn(
                      'w-4 h-4 text-yellow-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : inquiry.firstPartyResponse ? (
                  <CheckCircle
                    className={cn(
                      'w-4 h-4 text-green-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : (
                  <XCircle
                    className={cn(
                      'w-4 h-4 text-red-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                )}
                <span>
                  {inquiry.firstParty.firstName} {inquiry.firstParty.lastName}
                </span>
              </div>
            </div>
            <div>
              <div className="text-sm text-gray-500">
                {dict.secondPartyLabel}
              </div>
              <div className="flex items-center mt-1">
                {inquiry.secondPartyResponse === null ? (
                  <Clock
                    className={cn(
                      'w-4 h-4 text-yellow-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : inquiry.secondPartyResponse ? (
                  <CheckCircle
                    className={cn(
                      'w-4 h-4 text-green-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                ) : (
                  <XCircle
                    className={cn(
                      'w-4 h-4 text-red-500',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                  />
                )}
                <span>
                  {inquiry.secondParty.firstName} {inquiry.secondParty.lastName}
                </span>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <div className="flex justify-between text-sm text-gray-500">
              <span>{dict.progressLabel}</span>
              <span>{progress}%</span>
            </div>
            <Progress value={progress} className="w-full" />
          </div>

          {inquiry.note && (
            <div className="text-sm text-gray-600">
              <strong>{dict.noteLabel}</strong> {inquiry.note}
            </div>
          )}

          {((isFirstParty && inquiry.firstPartyResponse === null) ||
            (isSecondParty && inquiry.secondPartyResponse === null)) && (
            <div className="flex gap-2 mt-4">
              <Button
                onClick={() => onRespond(inquiry.id, true)}
                className="flex-1 bg-green-600 hover:bg-green-700"
              >
                <CheckCircle
                  className={cn('h-4 w-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />{' '}
                {dict.buttons.available}
              </Button>
              <Button
                onClick={() => onRespond(inquiry.id, false)}
                variant="outline"
                className="flex-1"
              >
                <XCircle
                  className={cn('h-4 w-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />{' '}
                {dict.buttons.unavailable}
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
--- End of Content for AvailabilityRequestCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageList.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/messages/MessageList.tsx
import React from 'react';
import type { UnifiedMessage } from '@/types/messages';
import MessageListItem from './MessageListItem';
import { ScrollArea } from '@/components/ui/scroll-area';
import { useSession } from 'next-auth/react';
import type { MessagesPageDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface MessageListProps {
  messages: UnifiedMessage[];
  selectedMessageId: string | null;
  onSelectMessage: (message: UnifiedMessage) => void;
  dict: MessagesPageDict; // קבלת המילון המלא
  locale: Locale;
}

const MessageList: React.FC<MessageListProps> = ({
  messages,
  selectedMessageId,
  onSelectMessage,
  dict,
  locale,
}) => {
  const { data: session } = useSession();
  const userId = session?.user?.id;

  if (!userId) return null;

  return (
    <div className="bg-white h-full flex flex-col">
      <div className="p-4 border-b">
        <h2 className="text-xl font-bold text-gray-800">
          {dict.messageList.header}
        </h2>
        <p className="text-sm text-gray-500">
          {dict.messageList.subtitle.replace(
            '{{count}}',
            messages.length.toString()
          )}
        </p>
      </div>
      <ScrollArea className="flex-1">
        <div className="p-2 space-y-1">
          {messages.map((message) => (
            <MessageListItem
              key={message.id}
              message={message}
              isSelected={message.id === selectedMessageId}
              onSelect={() => onSelectMessage(message)}
              userId={userId}
              dict={dict.messageListItem} // העברת החלק הרלוונטי
              locale={locale}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  );
};

export default MessageList;
--- End of Content for MessageList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageListItem.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/MessageListItem.tsx

import React from 'react';
import Image from 'next/image';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import type { UnifiedMessage } from '@/types/messages';
import { CheckCircle, Zap, MessageCircle, Info, Heart } from 'lucide-react';
import type { MessageListItemDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface MessageListItemProps {
  message: UnifiedMessage;
  isSelected: boolean;
  onSelect: () => void;
  userId: string;
  dict: MessageListItemDict;
  locale: Locale;
}

// Komponent pomocniczy do wyboru ikony i koloru na podstawie typu wiadomości
const MessageIcon: React.FC<{ type: UnifiedMessage['type'] }> = ({ type }) => {
  switch (type) {
    case 'ACTION_REQUIRED':
      return <Zap className="w-3 h-3 text-orange-500 fill-current" />;
    case 'MATCHMAKER_MESSAGE':
    case 'INQUIRY_RESPONSE':
      return <MessageCircle className="w-3 h-3 text-blue-500 fill-current" />;
    case 'STATUS_UPDATE':
      return <Info className="w-3 h-3 text-cyan-500" />;
    case 'NEW_SUGGESTION':
      return <Heart className="w-3 h-3 text-pink-500 fill-current" />;
    default:
      return null;
  }
};

const MessageListItem: React.FC<MessageListItemProps> = ({
  message,
  isSelected,
  onSelect,
  userId,
  dict,
  locale,
}) => {
  // Jeśli nie ma payloadu lub sugestii, nie renderujemy elementu
  const suggestion = message.payload?.suggestion;
  if (!suggestion) return null;

  // Identyfikacja drugiej strony w sugestii
  const otherParty =
    suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty;
  if (!otherParty) return null; // Dodatkowe zabezpieczenie

  const isActionRequired = message.type === 'ACTION_REQUIRED';
  const mainImage = otherParty.images?.find((img) => img.isMain);

  return (
    <button
      onClick={onSelect}
      className={cn(
        'w-full p-3 rounded-xl transition-all duration-200 flex items-start gap-4',
        locale === 'he' ? 'text-right' : 'text-left',
        isSelected ? 'bg-cyan-50 border border-cyan-200' : 'hover:bg-gray-100'
      )}
    >
      {/* Sekcja awatara z ikoną */}
      <div className="relative flex-shrink-0">
        <Avatar className="w-12 h-12 border-2 border-white shadow-md">
          {mainImage?.url ? (
            <Image
              src={getRelativeCloudinaryPath(mainImage.url)}
              alt={otherParty.firstName}
              fill
              className="object-cover"
              sizes="48px"
            />
          ) : (
            <AvatarFallback
              className={cn(
                'font-bold text-white',
                isActionRequired
                  ? 'bg-gradient-to-br from-orange-500 to-amber-500'
                  : 'bg-gradient-to-br from-cyan-500 to-blue-500'
              )}
            >
              {getInitials(`${otherParty.firstName} ${otherParty.lastName}`)}
            </AvatarFallback>
          )}
        </Avatar>
        {/* Mała ikona wskazująca typ wiadomości */}
        <div
          className={cn(
            'absolute -bottom-1 p-1 bg-white rounded-full shadow-lg',
            locale === 'he' ? '-left-1' : '-right-1'
          )}
        >
          <MessageIcon type={message.type} />
        </div>
      </div>

      {/* Sekcja treści */}
      <div className="flex-1 min-w-0">
        <div className="flex justify-between items-center">
          <h3 className="font-bold text-gray-800 truncate">{message.title}</h3>
          <span className="text-xs text-gray-400 flex-shrink-0">
            {formatDistanceToNow(new Date(message.timestamp), {
              addSuffix: true,
              locale: locale === 'he' ? he : enUS,
            })}
          </span>
        </div>
        <p className="text-sm text-gray-600 truncate">{message.description}</p>

        {/* Specjalna odznaka "Dopasowanie!" */}
        {message.type === 'STATUS_UPDATE' &&
          suggestion.status === 'CONTACT_DETAILS_SHARED' && (
            <Badge className="mt-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 text-xs shadow-md">
              <CheckCircle
                className={cn('w-3 h-3', locale === 'he' ? 'ml-1' : 'mr-1')}
              />
              {dict.matchBadge}
            </Badge>
          )}
      </div>
    </button>
  );
};

export default MessageListItem;
--- End of Content for MessageListItem.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessagesPage.tsx
--------------------------------------------------------------------------------
Content:
// FILENAME: src/app/components/messages/MessagesPage.tsx

'use client';

import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';
import { useState, useEffect, useCallback } from 'react';
import { useSession } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { toast } from 'sonner';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Clock, CheckCircle, XCircle, Loader2, Users } from 'lucide-react';
// --- START OF FIX ---
// Changed 'ExtendedInquiry' to 'ExtendedAvailabilityInquiry' to match the updated types file
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
// --- END OF FIX ---
import { Session } from 'next-auth';

// This component is now specifically for the matchmaker's view of availability requests.
// The candidate's message center is handled by MessageList.tsx which uses the unified feed.

export default function MessagesPage() {
  const { data: session } = useSession() as { data: Session | null };
  const { refreshNotifications } = useNotifications();
  // --- START OF FIX ---
  // Updated the state type to use the new name
  const [inquiries, setInquiries] = useState<ExtendedAvailabilityInquiry[]>([]);
  // --- END OF FIX ---
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [filters, setFilters] = useState({
    status: 'pending',
    timeframe: 'all',
  });
  const [note, setNote] = useState('');

  const loadInquiries = useCallback(async () => {
    try {
      setLoading(true);
      const queryParams = new URLSearchParams({
        status: filters.status,
        timeframe: filters.timeframe,
      });

      // This API endpoint is specific to matchmakers fetching availability inquiries
      const response = await fetch(`/api/matchmaker/inquiries?${queryParams}`);
      if (!response.ok)
        throw new Error('Failed to load availability inquiries');
      const data = await response.json();
      setInquiries(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load inquiries');
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => {
    if (session?.user) {
      loadInquiries();
    }
  }, [session, loadInquiries]);

  const handleResponse = async (inquiryId: string, isAvailable: boolean) => {
    try {
      const response = await fetch(
        `/api/matchmaker/inquiries/${inquiryId}/respond`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isAvailable, note }),
        }
      );

      if (!response.ok) {
        throw new Error('Failed to submit response');
      }

      await loadInquiries();
      await refreshNotifications();
      setNote('');
      toast.success('תגובתך נשמרה בהצלחה!');
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'Failed to submit response';
      setError(errorMessage);
      toast.error(errorMessage);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  if (inquiries.length === 0) {
    return (
      <Card className="max-w-4xl mx-auto mt-8">
        <CardContent className="p-6 text-center">
          <Users className="w-12 h-12 mx-auto text-gray-400 mb-4" />
          <h3 className="text-lg font-medium">אין בקשות זמינות</h3>
          <p className="text-gray-500">
            כרגע אין בקשות לבדיקת זמינות הממתינות לך.
          </p>
        </CardContent>
      </Card>
    );
  }

  // The rest of the component's JSX remains the same as it correctly handles the logic
  // for displaying and responding to Availability Inquiries.
  return (
    <div className="container mx-auto py-8 px-4">
      <Card className="mb-6">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle>בקשות לבדיקת זמינות</CardTitle>
          <div className="flex gap-4">
            <Select
              value={filters.status}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, status: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי סטטוס" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="pending">ממתין לתגובה</SelectItem>
                <SelectItem value="completed">טופל</SelectItem>
              </SelectContent>
            </Select>
            <Select
              value={filters.timeframe}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, timeframe: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי זמן" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="today">היום</SelectItem>
                <SelectItem value="week">שבוע אחרון</SelectItem>
                <SelectItem value="month">חודש אחרון</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
      </Card>
      {error && (
        <Alert variant="destructive" className="mb-6">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      <div className="grid grid-cols-1 gap-6">
        {inquiries.map((inquiry) => (
          <Card key={inquiry.id}>
            <CardContent className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="font-medium">בקשת בדיקת זמינות</h3>
                  <p className="text-sm text-gray-600">
                    מאת {inquiry.matchmaker.firstName}{' '}
                    {inquiry.matchmaker.lastName}
                  </p>
                </div>
                <Clock className="w-5 h-5 text-gray-400" />
              </div>
              <div className="space-y-4">
                {inquiry.note && (
                  <div className="text-sm text-gray-600 mt-2">
                    <strong>הערה:</strong> {inquiry.note}
                  </div>
                )}
                {!inquiry.firstPartyResponse && (
                  <>
                    <div className="space-y-2">
                      <label className="block text-sm font-medium">
                        הערות (אופציונלי):
                      </label>
                      <Textarea
                        value={note}
                        onChange={(e) => setNote(e.target.value)}
                        placeholder="הוסף/י הערות..."
                        className="w-full"
                      />
                    </div>
                    <div className="flex gap-2 mt-4">
                      <Button
                        onClick={() => handleResponse(inquiry.id, true)}
                        className="flex-1 bg-green-600 hover:bg-green-700"
                      >
                        <CheckCircle className="mr-2 h-4 w-4" /> אני זמין/ה
                      </Button>
                      <Button
                        onClick={() => handleResponse(inquiry.id, false)}
                        variant="outline"
                        className="flex-1"
                      >
                        <XCircle className="mr-2 h-4 w-4" /> לא זמין/ה כרגע
                      </Button>
                    </div>
                  </>
                )}
                {inquiry.firstPartyResponse !== null && (
                  <div className="space-y-4">
                    <div
                      className={`flex items-center gap-2 p-2 rounded-md ${inquiry.firstPartyResponse ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}
                    >
                      {inquiry.firstPartyResponse ? (
                        <CheckCircle className="h-5 w-5" />
                      ) : (
                        <XCircle className="h-5 w-5" />
                      )}
                      <span>
                        {inquiry.firstPartyResponse
                          ? 'אישרת זמינות'
                          : 'ציינת שאינך זמין/ה'}
                      </span>
                    </div>
                    <div>
                      <Button
                        onClick={() =>
                          handleResponse(
                            inquiry.id,
                            !inquiry.firstPartyResponse
                          )
                        }
                        className={`w-full ${inquiry.firstPartyResponse ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                      >
                        {inquiry.firstPartyResponse ? (
                          <>
                            <XCircle className="mr-2 h-4 w-4" /> שינוי תשובה -
                            אינני זמין/ה
                          </>
                        ) : (
                          <>
                            <CheckCircle className="mr-2 h-4 w-4" /> שינוי תשובה
                            - אני זמין/ה
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
--- End of Content for MessagesPage.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\NotificationCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/messages/NotificationCard.tsx

import React from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { formatDistanceToNow } from 'date-fns';
import { he, enUS } from 'date-fns/locale';
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import type { FeedItem } from '@/types/messages';
import {
  Heart,
  MessageCircle,
  ArrowLeft,
  Zap,
  CheckCircle,
  Info,
  ArrowRight,
} from 'lucide-react';
import type { MessagesPageDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface NotificationCardProps {
  item: FeedItem;
  userId: string;
  // ✨ PROP UPDATE: קבלת חלק מהמילון ו-locale
  dict: MessagesPageDict['notificationCard'];
  locale: Locale;
}

const NotificationCard: React.FC<NotificationCardProps> = ({
  item,
  userId,
  dict,
  locale,
}) => {
  // ... (לוגיקת האייקונים נשארת זהה)
  const iconMap: Record<
    FeedItem['type'],
    { icon: React.ElementType; color: string; gradient: string }
  > = {
    NEW_SUGGESTION: {
      icon: Heart,
      color: 'text-pink-500',
      gradient: 'from-pink-400 to-rose-500',
    },
    ACTION_REQUIRED: {
      icon: Zap,
      color: 'text-orange-500',
      gradient: 'from-orange-400 to-amber-500',
    },
    STATUS_UPDATE: {
      icon: CheckCircle,
      color: 'text-green-500',
      gradient: 'from-emerald-400 to-green-500',
    },
    MATCHMAKER_MESSAGE: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
    INQUIRY_RESPONSE: {
      icon: Info,
      color: 'text-cyan-500',
      gradient: 'from-cyan-400 to-teal-500',
    },
    AVAILABILITY_INQUIRY: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
  };

  const { icon: Icon, gradient } = iconMap[item.type] || {
    icon: Info,
    gradient: 'from-gray-400 to-slate-500',
  };
  const suggestion = item.payload.suggestion;
  const matchmaker = suggestion?.matchmaker;

  const otherParty = suggestion
    ? suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty
    : null;
  const mainImage = otherParty?.images?.find((img) => img.isMain);

  return (
    <Card className="shadow-lg border-0 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 bg-white">
      <CardContent className="p-5 flex items-start gap-4">
        <div className="flex flex-col items-center gap-2 flex-shrink-0">
          <div
            className={cn(
              'w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br shadow-md',
              gradient
            )}
          >
            <Icon className="w-6 h-6 text-white" />
          </div>
          {matchmaker && (
            <Avatar
              className="w-10 h-10 border-2 border-white"
              title={`${dict.matchmakerPrefix} ${matchmaker.firstName}`}
            >
              <AvatarFallback className="bg-gray-200 text-gray-600 text-sm font-bold">
                {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
              </AvatarFallback>
            </Avatar>
          )}
        </div>

        <div className="flex-1 min-w-0">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <h3 className="font-bold text-gray-800 text-lg leading-tight">
                {item.title}
              </h3>
              <p className="text-sm text-gray-600 mt-1">{item.description}</p>
            </div>
            <span className="text-xs text-gray-400 flex-shrink-0 pl-2">
              {/* ✨ LOCALE UPDATE: שימוש ב-locale עבור תאריך */}
              {formatDistanceToNow(new Date(item.timestamp), {
                addSuffix: true,
                locale: locale === 'he' ? he : enUS,
              })}
            </span>
          </div>

          <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
            {otherParty && (
              <div className="flex items-center gap-2">
                <Avatar className="w-8 h-8 border-2 border-white shadow">
                  {mainImage?.url ? (
                    <Image
                      src={getRelativeCloudinaryPath(mainImage.url)}
                      alt={otherParty.firstName}
                      fill
                      className="object-cover"
                      sizes="32px"
                    />
                  ) : (
                    <AvatarFallback className="bg-gray-300 text-gray-700 font-bold text-xs">
                      {getInitials(
                        `${otherParty.firstName} ${otherParty.lastName}`
                      )}
                    </AvatarFallback>
                  )}
                </Avatar>
                {/* ✨ TEXT UPDATE: שימוש במילון */}
                <span className="text-sm font-medium text-gray-700">
                  {dict.suggestionWith.replace(
                    '{{name}}',
                    otherParty.firstName
                  )}
                </span>
              </div>
            )}
            <Link href={item.link} passHref>
              <Button className="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full shadow-md hover:shadow-lg transition-all duration-300">
                {dict.viewDetails}
                {/* ✨ LOCALE UPDATE: שינוי כיוון החץ */}
                {locale === 'he' ? (
                  <ArrowLeft className="mr-2 h-4 w-4" />
                ) : (
                  <ArrowRight className="ml-2 h-4 w-4" />
                )}
              </Button>
            </Link>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default NotificationCard;
--- End of Content for NotificationCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\messages_contents.txt
--------------------------------------------------------------------------------
Content:
################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages
# Generated on: 2025-09-01 13:20:37
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\AvailabilityRequestCard.tsx
--------------------------------------------------------------------------------
Content:
// FILENAME: src/app/components/messages/AvailabilityRequestCard.tsx

import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Clock, CheckCircle, XCircle } from 'lucide-react';
// --- START OF FIX ---
// Changed 'ExtendedInquiry' to 'ExtendedAvailabilityInquiry'
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
// --- END OF FIX ---

interface AvailabilityRequestCardProps {
  // --- START OF FIX ---
  // Updated the prop type to use the new name
  inquiry: ExtendedAvailabilityInquiry;
  // --- END OF FIX ---
  currentUserId: string;
  onRespond: (inquiryId: string, isAvailable: boolean) => Promise<void>;
}

export default function AvailabilityRequestCard({
  inquiry,
  currentUserId,
  onRespond,
}: AvailabilityRequestCardProps) {
  const isFirstParty = inquiry.firstPartyId === currentUserId;
  const isSecondParty = inquiry.secondPartyId === currentUserId;
  const totalResponses = [
    inquiry.firstPartyResponse,
    inquiry.secondPartyResponse,
  ].filter((r) => r !== null).length;
  const progress = (totalResponses / 2) * 100;

  // Since this component is specifically for AvailabilityInquiry, its internal logic
  // for displaying responses and actions remains correct. The only change needed was the type import.
  return (
    <Card>
      <CardContent className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h3 className="font-medium">בקשת בדיקת זמינות</h3>
            <p className="text-sm text-gray-600">
              מאת {inquiry.matchmaker.firstName} {inquiry.matchmaker.lastName}
            </p>
          </div>
          <Clock className="w-5 h-5 text-gray-400" />
        </div>

        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-gray-500">צד ראשון</div>
              <div className="flex items-center mt-1">
                {inquiry.firstPartyResponse === null ? (
                  <Clock className="w-4 h-4 text-yellow-500 mr-1" />
                ) : inquiry.firstPartyResponse ? (
                  <CheckCircle className="w-4 h-4 text-green-500 mr-1" />
                ) : (
                  <XCircle className="w-4 h-4 text-red-500 mr-1" />
                )}
                <span>
                  {inquiry.firstParty.firstName} {inquiry.firstParty.lastName}
                </span>
              </div>
            </div>
            <div>
              <div className="text-sm text-gray-500">צד שני</div>
              <div className="flex items-center mt-1">
                {inquiry.secondPartyResponse === null ? (
                  <Clock className="w-4 h-4 text-yellow-500 mr-1" />
                ) : inquiry.secondPartyResponse ? (
                  <CheckCircle className="w-4 h-4 text-green-500 mr-1" />
                ) : (
                  <XCircle className="w-4 h-4 text-red-500 mr-1" />
                )}
                <span>
                  {inquiry.secondParty.firstName} {inquiry.secondParty.lastName}
                </span>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <div className="flex justify-between text-sm text-gray-500">
              <span>התקדמות</span>
              <span>{progress}%</span>
            </div>
            <Progress value={progress} className="w-full" />
          </div>

          {inquiry.note && (
            <div className="text-sm text-gray-600">
              <strong>הערה:</strong> {inquiry.note}
            </div>
          )}

          {isFirstParty && inquiry.firstPartyResponse === null && (
            <div className="flex gap-2 mt-4">
              <Button
                onClick={() => onRespond(inquiry.id, true)}
                className="flex-1 bg-green-600 hover:bg-green-700"
              >
                <CheckCircle className="mr-2 h-4 w-4" /> אני זמין/ה
              </Button>
              <Button
                onClick={() => onRespond(inquiry.id, false)}
                variant="outline"
                className="flex-1"
              >
                <XCircle className="mr-2 h-4 w-4" /> לא זמין/ה כרגע
              </Button>
            </div>
          )}

          {isSecondParty && inquiry.secondPartyResponse === null && (
            <div className="flex gap-2 mt-4">
              <Button
                onClick={() => onRespond(inquiry.id, true)}
                className="flex-1 bg-green-600 hover:bg-green-700"
              >
                <CheckCircle className="mr-2 h-4 w-4" /> אני זמין/ה
              </Button>
              <Button
                onClick={() => onRespond(inquiry.id, false)}
                variant="outline"
                className="flex-1"
              >
                <XCircle className="mr-2 h-4 w-4" /> לא זמין/ה כרגע
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
--- End of Content for AvailabilityRequestCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageList.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/messages/MessageList.tsx
import React from 'react';
import type { UnifiedMessage } from '@/types/messages';
import MessageListItem from './MessageListItem'; // זה יתחיל לעבוד אחרי שתיצור את הקובץ הבא
import { ScrollArea } from '@/components/ui/scroll-area';
import { useSession } from 'next-auth/react';

interface MessageListProps {
  messages: UnifiedMessage[];
  selectedMessageId: string | null;
  onSelectMessage: (message: UnifiedMessage) => void;
}

const MessageList: React.FC<MessageListProps> = ({ messages, selectedMessageId, onSelectMessage }) => {
  const { data: session } = useSession();
  const userId = session?.user?.id;

  if (!userId) return null; // הגנה למקרה שהסשן לא טעון

  return (
    <div className="bg-white h-full flex flex-col">
      <div className="p-4 border-b">
        <h2 className="text-xl font-bold text-gray-800">מרכז הפעילות</h2>
        <p className="text-sm text-gray-500">{messages.length} הצעות ועדכונים</p>
      </div>
      <ScrollArea className="flex-1">
        <div className="p-2 space-y-1">
          {messages.map((message) => (
            <MessageListItem
              key={message.id}
              message={message}
              isSelected={message.id === selectedMessageId}
              onSelect={() => onSelectMessage(message)}
              userId={userId}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  );
};

export default MessageList;
--- End of Content for MessageList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessageListItem.tsx
--------------------------------------------------------------------------------
Content:
// FILENAME: src/app/components/messages/MessageListItem.tsx

import React from 'react';
import Image from 'next/image';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import type { UnifiedMessage } from '@/types/messages';
import { CheckCircle, Zap, MessageCircle, Info, Heart } from 'lucide-react';

interface MessageListItemProps {
  message: UnifiedMessage;
  isSelected: boolean;
  onSelect: () => void;
  userId: string;
}

// קומפוננטת עזר לבחירת אייקון וצבע
const MessageIcon: React.FC<{ type: UnifiedMessage['type'] }> = ({ type }) => {
  switch (type) {
    case 'ACTION_REQUIRED':
      return <Zap className="w-3 h-3 text-orange-500 fill-current" />;
    case 'MATCHMAKER_MESSAGE':
    case 'INQUIRY_RESPONSE':
      return <MessageCircle className="w-3 h-3 text-blue-500 fill-current" />;
    case 'STATUS_UPDATE':
      return <Info className="w-3 h-3 text-cyan-500" />;
    case 'NEW_SUGGESTION':
      return <Heart className="w-3 h-3 text-pink-500 fill-current" />;
    default:
      return null;
  }
};

const MessageListItem: React.FC<MessageListItemProps> = ({
  message,
  isSelected,
  onSelect,
  userId,
}) => {
  // במידה ואין payload או suggestion, לא נציג את הפריט
  const suggestion = message.payload?.suggestion;
  if (!suggestion) return null;

  // זיהוי הצד השני בהצעה
  const otherParty =
    suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty;
  if (!otherParty) return null; // הגנה נוספת

  const isActionRequired = message.type === 'ACTION_REQUIRED';
  const mainImage = otherParty.images?.find((img) => img.isMain);

  return (
    <button
      onClick={onSelect}
      className={cn(
        'w-full text-right p-3 rounded-xl transition-all duration-200 flex items-start gap-4',
        isSelected ? 'bg-cyan-50 border border-cyan-200' : 'hover:bg-gray-100'
      )}
    >
      {/* Avatar Section with Icon */}
      <div className="relative flex-shrink-0">
        <Avatar className="w-12 h-12 border-2 border-white shadow-md">
          {mainImage?.url ? (
            <Image
              src={getRelativeCloudinaryPath(mainImage.url)}
              alt={otherParty.firstName}
              fill
              className="object-cover"
              sizes="48px"
            />
          ) : (
            <AvatarFallback
              className={cn(
                'font-bold text-white',
                isActionRequired
                  ? 'bg-gradient-to-br from-orange-500 to-amber-500'
                  : 'bg-gradient-to-br from-cyan-500 to-blue-500'
              )}
            >
              {getInitials(`${otherParty.firstName} ${otherParty.lastName}`)}
            </AvatarFallback>
          )}
        </Avatar>
        {/* אייקון קטן המציין את סוג ההודעה */}
        <div className="absolute -bottom-1 -left-1 p-1 bg-white rounded-full shadow-lg">
          <MessageIcon type={message.type} />
        </div>
      </div>

      {/* Content Section */}
      <div className="flex-1 min-w-0">
        <div className="flex justify-between items-center">
          <h3 className="font-bold text-gray-800 truncate">{message.title}</h3>
          <span className="text-xs text-gray-400 flex-shrink-0">
            {formatDistanceToNow(new Date(message.timestamp), {
              addSuffix: true,
              locale: he,
            })}
          </span>
        </div>
        <p className="text-sm text-gray-600 truncate">{message.description}</p>

        {/* תג "התאמה!" מיוחד */}
        {message.type === 'STATUS_UPDATE' &&
          suggestion.status === 'CONTACT_DETAILS_SHARED' && (
            <Badge className="mt-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 text-xs shadow-md">
              <CheckCircle className="w-3 h-3 ml-1" />
              התאמה!
            </Badge>
          )}
      </div>
    </button>
  );
};

export default MessageListItem;
--- End of Content for MessageListItem.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\MessagesPage.tsx
--------------------------------------------------------------------------------
Content:
// FILENAME: src/app/components/messages/MessagesPage.tsx

'use client';

import { useNotifications } from '@/app/[locale]/contexts/NotificationContext';
import { useState, useEffect, useCallback } from 'react';
import { useSession } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { toast } from 'sonner';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Clock, CheckCircle, XCircle, Loader2, Users } from 'lucide-react';
// --- START OF FIX ---
// Changed 'ExtendedInquiry' to 'ExtendedAvailabilityInquiry' to match the updated types file
import type { ExtendedAvailabilityInquiry } from '@/types/messages';
// --- END OF FIX ---
import { Session } from 'next-auth';

// This component is now specifically for the matchmaker's view of availability requests.
// The candidate's message center is handled by MessageList.tsx which uses the unified feed.

export default function MessagesPage() {
  const { data: session } = useSession() as { data: Session | null };
  const { refreshNotifications } = useNotifications();
  // --- START OF FIX ---
  // Updated the state type to use the new name
  const [inquiries, setInquiries] = useState<ExtendedAvailabilityInquiry[]>([]);
  // --- END OF FIX ---
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [filters, setFilters] = useState({
    status: 'pending',
    timeframe: 'all',
  });
  const [note, setNote] = useState('');

  const loadInquiries = useCallback(async () => {
    try {
      setLoading(true);
      const queryParams = new URLSearchParams({
        status: filters.status,
        timeframe: filters.timeframe,
      });

      // This API endpoint is specific to matchmakers fetching availability inquiries
      const response = await fetch(`/api/matchmaker/inquiries?${queryParams}`);
      if (!response.ok)
        throw new Error('Failed to load availability inquiries');
      const data = await response.json();
      setInquiries(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load inquiries');
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => {
    if (session?.user) {
      loadInquiries();
    }
  }, [session, loadInquiries]);

  const handleResponse = async (inquiryId: string, isAvailable: boolean) => {
    try {
      const response = await fetch(
        `/api/matchmaker/inquiries/${inquiryId}/respond`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isAvailable, note }),
        }
      );

      if (!response.ok) {
        throw new Error('Failed to submit response');
      }

      await loadInquiries();
      await refreshNotifications();
      setNote('');
      toast.success('תגובתך נשמרה בהצלחה!');
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'Failed to submit response';
      setError(errorMessage);
      toast.error(errorMessage);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  if (inquiries.length === 0) {
    return (
      <Card className="max-w-4xl mx-auto mt-8">
        <CardContent className="p-6 text-center">
          <Users className="w-12 h-12 mx-auto text-gray-400 mb-4" />
          <h3 className="text-lg font-medium">אין בקשות זמינות</h3>
          <p className="text-gray-500">
            כרגע אין בקשות לבדיקת זמינות הממתינות לך.
          </p>
        </CardContent>
      </Card>
    );
  }

  // The rest of the component's JSX remains the same as it correctly handles the logic
  // for displaying and responding to Availability Inquiries.
  return (
    <div className="container mx-auto py-8 px-4">
      <Card className="mb-6">
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle>בקשות לבדיקת זמינות</CardTitle>
          <div className="flex gap-4">
            <Select
              value={filters.status}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, status: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי סטטוס" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="pending">ממתין לתגובה</SelectItem>
                <SelectItem value="completed">טופל</SelectItem>
              </SelectContent>
            </Select>
            <Select
              value={filters.timeframe}
              onValueChange={(value) =>
                setFilters((prev) => ({ ...prev, timeframe: value }))
              }
            >
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="סינון לפי זמן" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">הכל</SelectItem>
                <SelectItem value="today">היום</SelectItem>
                <SelectItem value="week">שבוע אחרון</SelectItem>
                <SelectItem value="month">חודש אחרון</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
      </Card>
      {error && (
        <Alert variant="destructive" className="mb-6">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      <div className="grid grid-cols-1 gap-6">
        {inquiries.map((inquiry) => (
          <Card key={inquiry.id}>
            <CardContent className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="font-medium">בקשת בדיקת זמינות</h3>
                  <p className="text-sm text-gray-600">
                    מאת {inquiry.matchmaker.firstName}{' '}
                    {inquiry.matchmaker.lastName}
                  </p>
                </div>
                <Clock className="w-5 h-5 text-gray-400" />
              </div>
              <div className="space-y-4">
                {inquiry.note && (
                  <div className="text-sm text-gray-600 mt-2">
                    <strong>הערה:</strong> {inquiry.note}
                  </div>
                )}
                {!inquiry.firstPartyResponse && (
                  <>
                    <div className="space-y-2">
                      <label className="block text-sm font-medium">
                        הערות (אופציונלי):
                      </label>
                      <Textarea
                        value={note}
                        onChange={(e) => setNote(e.target.value)}
                        placeholder="הוסף/י הערות..."
                        className="w-full"
                      />
                    </div>
                    <div className="flex gap-2 mt-4">
                      <Button
                        onClick={() => handleResponse(inquiry.id, true)}
                        className="flex-1 bg-green-600 hover:bg-green-700"
                      >
                        <CheckCircle className="mr-2 h-4 w-4" /> אני זמין/ה
                      </Button>
                      <Button
                        onClick={() => handleResponse(inquiry.id, false)}
                        variant="outline"
                        className="flex-1"
                      >
                        <XCircle className="mr-2 h-4 w-4" /> לא זמין/ה כרגע
                      </Button>
                    </div>
                  </>
                )}
                {inquiry.firstPartyResponse !== null && (
                  <div className="space-y-4">
                    <div
                      className={`flex items-center gap-2 p-2 rounded-md ${inquiry.firstPartyResponse ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}
                    >
                      {inquiry.firstPartyResponse ? (
                        <CheckCircle className="h-5 w-5" />
                      ) : (
                        <XCircle className="h-5 w-5" />
                      )}
                      <span>
                        {inquiry.firstPartyResponse
                          ? 'אישרת זמינות'
                          : 'ציינת שאינך זמין/ה'}
                      </span>
                    </div>
                    <div>
                      <Button
                        onClick={() =>
                          handleResponse(
                            inquiry.id,
                            !inquiry.firstPartyResponse
                          )
                        }
                        className={`w-full ${inquiry.firstPartyResponse ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                      >
                        {inquiry.firstPartyResponse ? (
                          <>
                            <XCircle className="mr-2 h-4 w-4" /> שינוי תשובה -
                            אינני זמין/ה
                          </>
                        ) : (
                          <>
                            <CheckCircle className="mr-2 h-4 w-4" /> שינוי תשובה
                            - אני זמין/ה
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
--- End of Content for MessagesPage.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\NotificationCard.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/messages/NotificationCard.tsx

import React from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
// ================== שינוי 1: הוספת הייבוא ==================
import { cn, getInitials, getRelativeCloudinaryPath } from '@/lib/utils';
import type { FeedItem } from '@/types/messages';
import {
  Heart,
  MessageCircle,
  ArrowLeft,
  Zap,
  CheckCircle,
  Info,
} from 'lucide-react';

interface NotificationCardProps {
  item: FeedItem;
  userId: string;
}

const NotificationCard: React.FC<NotificationCardProps> = ({
  item,
  userId,
}) => {
  const iconMap: Record<
    FeedItem['type'],
    { icon: React.ElementType; color: string; gradient: string }
  > = {
    NEW_SUGGESTION: {
      icon: Heart,
      color: 'text-pink-500',
      gradient: 'from-pink-400 to-rose-500',
    },
    ACTION_REQUIRED: {
      icon: Zap,
      color: 'text-orange-500',
      gradient: 'from-orange-400 to-amber-500',
    },
    STATUS_UPDATE: {
      icon: CheckCircle,
      color: 'text-green-500',
      gradient: 'from-emerald-400 to-green-500',
    },
    MATCHMAKER_MESSAGE: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
    INQUIRY_RESPONSE: {
      icon: Info,
      color: 'text-cyan-500',
      gradient: 'from-cyan-400 to-teal-500',
    },
    AVAILABILITY_INQUIRY: {
      icon: MessageCircle,
      color: 'text-blue-500',
      gradient: 'from-blue-400 to-cyan-500',
    },
  };

  const { icon: Icon, gradient } = iconMap[item.type] || {
    icon: Info,
    color: 'text-gray-500',
    gradient: 'from-gray-400 to-slate-500',
  };
  const suggestion = item.payload.suggestion;
  const matchmaker = suggestion?.matchmaker;

  const otherParty = suggestion
    ? suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty
    : null;
  const mainImage = otherParty?.images?.find((img) => img.isMain);

  return (
    <Card className="shadow-lg border-0 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 bg-white">
      <CardContent className="p-5 flex items-start gap-4">
        {/* Icons Column */}
        <div className="flex flex-col items-center gap-2 flex-shrink-0">
          <div
            className={cn(
              'w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br shadow-md',
              gradient
            )}
          >
            <Icon className="w-6 h-6 text-white" />
          </div>
          {matchmaker && (
            <Avatar
              className="w-10 h-10 border-2 border-white"
              title={`הצעה מהשדכן/ית ${matchmaker.firstName}`}
            >
              <AvatarFallback className="bg-gray-200 text-gray-600 text-sm font-bold">
                {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
              </AvatarFallback>
            </Avatar>
          )}
        </div>

        {/* Content Column */}
        <div className="flex-1 min-w-0">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <h3 className="font-bold text-gray-800 text-lg leading-tight">
                {item.title}
              </h3>
              <p className="text-sm text-gray-600 mt-1">{item.description}</p>
            </div>
            <span className="text-xs text-gray-400 flex-shrink-0 pl-2">
              {formatDistanceToNow(new Date(item.timestamp), {
                addSuffix: true,
                locale: he,
              })}
            </span>
          </div>

          {/* Link to Suggestion */}
          <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
            {otherParty && (
              <div className="flex items-center gap-2">
                <Avatar className="w-8 h-8 border-2 border-white shadow">
                  {mainImage?.url ? (
                    // ================== שינוי 2: שימוש בפונקציית העזר ==================
                    <Image
                      src={getRelativeCloudinaryPath(mainImage.url)}
                      alt={otherParty.firstName}
                      fill
                      className="object-cover"
                      sizes="32px"
                    />
                  ) : (
                    <AvatarFallback className="bg-gray-300 text-gray-700 font-bold text-xs">
                      {getInitials(
                        `${otherParty.firstName} ${otherParty.lastName}`
                      )}
                    </AvatarFallback>
                  )}
                </Avatar>
                <span className="text-sm font-medium text-gray-700">
                  עם {otherParty.firstName}
                </span>
              </div>
            )}
            <Link href={item.link} passHref>
              <Button className="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full shadow-md hover:shadow-lg transition-all duration-300">
                צפה בפרטים
                <ArrowLeft className="mr-2 h-4 w-4" />
              </Button>
            </Link>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default NotificationCard;
--- End of Content for NotificationCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\messages\messages_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--- End of Content for messages_contents.txt ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\ProfileCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/ProfileCard.tsx

'use client';

import React, {
  useState,
  useMemo,
  useCallback,
  useEffect,
  useRef,
} from 'react';
import Image from 'next/image';
import BudgetDisplay from './sections/BudgetDisplay';

import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from '@/components/ui/resizable';

// UI Components
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent } from '@/components/ui/tabs';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogHeader,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';
import { Skeleton } from '@/components/ui/skeleton';

// Icons
import {
  User,
  Heart,
  FileText,
  Info as InfoIcon,
  Eye,
  Phone,
  ChevronLeft,
  ChevronRight,
  Briefcase,
  GraduationCap,
  Users,
  BookOpen,
  School,
  Lock,
  Calendar,
  Star,
  MapPin,
  CheckCircle,
  Clock,
  Cake,
  Sparkles,
  Users2,
  Award,
  Palette,
  Smile,
  X,
  BookMarked,
  Target,
  Edit3,
  Bot,
  Coffee,
  Camera,
  Music,
  Globe,
  Compass,
  Telescope,
  Crown,
  Zap,
  ArrowRight,
  Quote,
  ChevronDown,
  Moon,
  Sun,
  Home,
  Play,
  Lightbulb,
  Printer,
  Filter,
  MessageSquare,
  Phone as PhoneIcon,
  Stars,
  Sparkle,
  Sunrise,
  TreePine,
  Flower,
  Rainbow,
  Waves,
  Wind,
  Shield,
  ArrowLeft,
  MessageSquareQuote,
} from 'lucide-react';

// Types and Interfaces
import type {
  UserProfile,
  UserImage as UserImageType,
  QuestionnaireResponse,
  FormattedAnswer,
  ServiceType,
  HeadCoveringType,
  KippahType,
  WorldId,
} from '@/types/next-auth';
import type { Candidate } from '@/components/matchmaker/new/types/candidates';

import { ProfileCardDict, ProfileCardDisplayDict } from '@/types/dictionary';
// הוסף CSS משתנים דינמיים

const NeshamaTechSummary: React.FC<{
  profile: UserProfile;
  dict: ProfileCardDisplayDict;
  THEME: ThemeType;
  direction: 'ltr' | 'rtl';
}> = ({ profile, dict, THEME, direction }) => {
  if (!profile.isNeshamaTechSummaryVisible || !profile.manualEntryText) {
    return null;
  }
  return (
    <SectionCard
      title={dict.content.neshamaTechSummary.title.replace(
        '{{name}}',
        profile.user?.firstName || ''
      )}
      icon={Bot}
      variant="elegant"
      gradient={THEME.colors.primary.gold}
    >
      <div className="text-center italic p-4 bg-amber-50/50 rounded-lg border border-amber-200/50">
        <p
          dir={direction}
          className="whitespace-pre-wrap text-gray-800 leading-relaxed"
        >
          {' '}
          {profile.manualEntryText}
        </p>
      </div>
    </SectionCard>
  );
};

// רכיב 3: המלצות חברים (תצוגה מלאה)
const FriendTestimonialsSection: React.FC<{
  profile: UserProfile;
  dict: ProfileCardDisplayDict;
  THEME: ThemeType;
  direction: 'ltr' | 'rtl';
}> = ({ profile, dict, THEME, direction }) => {
  const approvedTestimonials = (profile.testimonials || []).filter(
    (t) => t.status === 'APPROVED'
  );

  if (!profile.isFriendsSectionVisible || approvedTestimonials.length === 0) {
    return (
      <EmptyState
        icon={MessageSquareQuote}
        title={dict.content.friendTestimonials.emptyState.title}
        description={dict.content.friendTestimonials.emptyState.description}
        variant="discovery"
        THEME={THEME}
      />
    );
  }

  return (
    <div className="space-y-4" dir={direction}>
      {approvedTestimonials.map((testimonial) => (
        <div
          key={testimonial.id}
          className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm"
        >
          <blockquote
            className={cn(
              'italic',
              direction === 'rtl' ? 'pr-4 border-r-4' : 'pl-4 border-l-4',
              THEME.colors.primary.main.includes('cyan')
                ? direction === 'rtl'
                  ? 'border-cyan-500'
                  : 'border-cyan-500'
                : THEME.colors.primary.main.includes('blue')
                  ? direction === 'rtl'
                    ? 'border-blue-500'
                    : 'border-blue-500'
                  : direction === 'rtl'
                    ? 'border-gray-500'
                    : 'border-gray-500',
              THEME.colors.primary.main.includes('cyan')
                ? 'text-cyan-800'
                : THEME.colors.primary.main.includes('blue')
                  ? 'text-blue-800'
                  : 'text-gray-800'
            )}
          >
            &quot;{testimonial.content}&quot;
          </blockquote>
          <div className="flex items-center justify-between mt-3 pt-3 border-t">
            <p className="text-sm font-semibold text-gray-800 text-start">
              {' '}
              - {testimonial.authorName},{' '}
              <span className="font-normal text-gray-600">
                {testimonial.relationship}
              </span>
            </p>
            {testimonial.isPhoneVisibleToMatch && testimonial.authorPhone && (
              <Button
                asChild
                variant="outline"
                size="sm"
                className={cn(
                  'rounded-full',
                  `text-${THEME.colors.primary.main.includes('cyan') ? 'cyan' : 'blue'}-700`,
                  `border-${THEME.colors.primary.main.includes('cyan') ? 'cyan' : 'blue'}-300`,
                  `hover:bg-${THEME.colors.primary.main.includes('cyan') ? 'cyan' : 'blue'}-50`
                )}
              >
                <a href={`tel:${testimonial.authorPhone}`}>
                  <Phone className="w-3 h-3 me-2" />
                  {dict.content.friendTestimonials.callButton.replace(
                    '{{name}}',
                    testimonial.authorName.split(' ')[0]
                  )}
                </a>
              </Button>
            )}
          </div>
        </div>
      ))}
      {approvedTestimonials.some((t) => t.isPhoneVisibleToMatch) && (
        <p className="text-xs text-center text-gray-500 mt-4 px-4">
          {dict.content.friendTestimonials.callDisclaimer}
        </p>
      )}
    </div>
  );
};

// --- Maps Creation ---
const createMaritalStatusMap = (
  dict: ProfileCardDict['options']['maritalStatus']
) => ({
  single: {
    label: dict.single,
    shortLabel: 'רווק',
    icon: Heart,
    color: 'text-rose-600',
  },
  divorced: {
    label: dict.divorced,
    shortLabel: 'גרוש',
    icon: Sunrise,
    color: 'text-amber-600',
  },
  widowed: {
    label: dict.widowed,
    shortLabel: 'אלמן',
    icon: Stars,
    color: 'text-purple-600',
  },
  annulled: {
    label: dict.annulled,
    shortLabel: 'מוכן לאהבה',
    icon: Rainbow,
    color: 'text-pink-600',
  },
  any: {
    label: 'פתוח/ה לכל האפשרויות',
    shortLabel: 'פתוח',
    icon: Sparkles,
    color: 'text-indigo-600',
  },
});

const createReligiousLevelMap = (
  dict: ProfileCardDict['options']['religiousLevel']
) => ({
  charedi: {
    label: dict.charedi,
    shortLabel: 'חרדי',
    icon: BookMarked,
    color: 'text-indigo-700',
  },
  charedi_modern: {
    label: dict.charedi_modern,
    shortLabel: 'חרדי מודרני',
    icon: BookOpen,
    color: 'text-indigo-600',
  },
  dati_leumi_torani: {
    label: dict.dati_leumi_torani,
    shortLabel: 'דתי תורני',
    icon: Star,
    color: 'text-blue-700',
  },
  dati_leumi_liberal: {
    label: dict.dati_leumi_liberal,
    shortLabel: 'דתי ליברלי',
    icon: Flower,
    color: 'text-blue-600',
  },
  dati_leumi_standard: {
    label: dict.dati_leumi_standard,
    shortLabel: 'דתי לאומי',
    icon: Crown,
    color: 'text-blue-600',
  },
  masorti_strong: {
    label: dict.masorti_strong,
    shortLabel: 'מסורתי חזק',
    icon: TreePine,
    color: 'text-emerald-700',
  },
  masorti_light: {
    label: dict.masorti_light,
    shortLabel: 'מסורתי קל',
    icon: Wind,
    color: 'text-emerald-600',
  },
  secular_traditional_connection: {
    label: dict.secular_traditional_connection,
    shortLabel: 'חילוני עם זיקה',
    icon: Waves,
    color: 'text-cyan-600',
  },
  secular: {
    label: dict.secular,
    shortLabel: 'חילוני',
    icon: Sunrise,
    color: 'text-orange-600',
  },
  spiritual_not_religious: {
    label: dict.spiritual_not_religious,
    shortLabel: 'רוחני',
    icon: Sparkle,
    color: 'text-purple-600',
  },
  other: {
    label: dict.other,
    shortLabel: 'ייחודי',
    icon: Rainbow,
    color: 'text-pink-600',
  },
  no_preference: {
    label: dict.other, // Assuming 'other' can serve as a fallback for 'no preference' text
    shortLabel: 'פתוח',
    icon: Globe,
    color: 'text-gray-600',
  },
});

const createReligiousJourneyMap = (
  dict: ProfileCardDict['options']['religiousJourney']
) => ({
  BORN_INTO_CURRENT_LIFESTYLE: {
    label: dict.BORN_INTO_CURRENT_LIFESTYLE,
    shortLabel: 'גדלתי דתי',
    icon: Home,
    color: 'text-blue-600',
  },
  BORN_SECULAR: {
    label: dict.BORN_SECULAR,
    shortLabel: 'גדלתי חילוני',
    icon: Sun,
    color: 'text-orange-600',
  },
  BAAL_TESHUVA: {
    label: dict.BAAL_TESHUVA,
    shortLabel: 'חוזר בתשובה',
    icon: Sparkles,
    color: 'text-purple-600',
  },
  DATLASH: {
    label: dict.DATLASH,
    shortLabel: 'דתל"ש',
    icon: ArrowLeft,
    color: 'text-gray-600',
  },
  CONVERT: {
    label: dict.CONVERT,
    shortLabel: 'גיורת',
    icon: Star,
    color: 'text-amber-600',
  },
  IN_PROCESS: {
    label: dict.IN_PROCESS,
    shortLabel: 'בתהליך',
    icon: Compass,
    color: 'text-teal-600',
  },
  OTHER: {
    label: dict.OTHER,
    shortLabel: 'אחר',
    icon: InfoIcon,
    color: 'text-pink-600',
  },
  no_preference: {
    label: 'ללא העדפה למסע הדתי',
    shortLabel: 'ללא העדפה',
    icon: Globe,
    color: 'text-gray-500',
  },
});

const createEducationLevelMap = (
  dict: ProfileCardDict['options']['educationLevel']
) => ({
  high_school: {
    label: dict.high_school,
    shortLabel: 'תיכון',
    icon: School,
    color: 'text-blue-600',
  },
  vocational: {
    label: dict.vocational,
    shortLabel: 'מקצועי',
    icon: Award,
    color: 'text-green-600',
  },
  academic_student: {
    label: dict.academic_student,
    shortLabel: 'סטודנט',
    icon: BookOpen,
    color: 'text-orange-600',
  },
  academic_ba: {
    label: dict.academic_ba,
    shortLabel: 'ב.א',
    icon: GraduationCap,
    color: 'text-purple-600',
  },
  academic_ma: {
    label: dict.academic_ma,
    shortLabel: 'מ.א',
    icon: Star,
    color: 'text-indigo-600',
  },
  academic_phd: {
    label: dict.academic_phd,
    shortLabel: 'דוקטור',
    icon: Crown,
    color: 'text-rose-600',
  },
  yeshiva_seminary: {
    label: dict.yeshiva_seminary,
    shortLabel: 'תורני',
    icon: BookMarked,
    color: 'text-amber-600',
  },
  other: {
    label: dict.other,
    shortLabel: 'ייחודי',
    icon: Sparkles,
    color: 'text-pink-600',
  },
  'ללא העדפה': {
    label: 'הכל פתוח',
    shortLabel: 'פתוח',
    icon: Globe,
    color: 'text-gray-600',
  },
});

const createServiceTypeMap = (
  dict: ProfileCardDict['options']['serviceType']
) => ({
  MILITARY_COMBATANT: {
    label: dict.MILITARY_COMBATANT,
    shortLabel: 'לוחם',
    icon: Award,
    color: 'text-red-600',
  },
  MILITARY_SUPPORT: {
    label: dict.MILITARY_SUPPORT,
    shortLabel: 'תומך',
    icon: Users,
    color: 'text-orange-600',
  },
  MILITARY_OFFICER: {
    label: dict.MILITARY_OFFICER,
    shortLabel: 'קצין',
    icon: Crown,
    color: 'text-purple-600',
  },
  MILITARY_INTELLIGENCE_CYBER_TECH: {
    label: dict.MILITARY_INTELLIGENCE_CYBER_TECH,
    shortLabel: 'טכנולוגיה',
    icon: Zap,
    color: 'text-blue-600',
  },
  NATIONAL_SERVICE_ONE_YEAR: {
    label: dict.NATIONAL_SERVICE_ONE_YEAR,
    shortLabel: 'שירות לאומי',
    icon: Heart,
    color: 'text-pink-600',
  },
  NATIONAL_SERVICE_TWO_YEARS: {
    label: dict.NATIONAL_SERVICE_TWO_YEARS,
    shortLabel: 'שירות מורחב',
    icon: Stars,
    color: 'text-rose-600',
  },
  HESDER_YESHIVA: {
    label: dict.HESDER_YESHIVA,
    shortLabel: 'הסדר',
    icon: BookMarked,
    color: 'text-indigo-600',
  },
  YESHIVA_ONLY_POST_HS: {
    label: dict.YESHIVA_ONLY_POST_HS,
    shortLabel: 'תורני',
    icon: BookOpen,
    color: 'text-amber-600',
  },
  PRE_MILITARY_ACADEMY_AND_SERVICE: {
    label: dict.PRE_MILITARY_ACADEMY_AND_SERVICE,
    shortLabel: 'מכינה',
    icon: GraduationCap,
    color: 'text-green-600',
  },
  EXEMPTED: {
    label: dict.EXEMPTED,
    shortLabel: 'פטור',
    icon: Shield,
    color: 'text-gray-600',
  },
  CIVILIAN_SERVICE: {
    label: dict.CIVILIAN_SERVICE,
    shortLabel: 'אזרחי',
    icon: Users2,
    color: 'text-teal-600',
  },
  OTHER: {
    label: dict.OTHER,
    shortLabel: 'ייחודי',
    icon: Sparkles,
    color: 'text-purple-600',
  },
});

const createHeadCoveringMap = (
  dict: ProfileCardDict['options']['headCovering']
) => ({
  FULL_COVERAGE: {
    label: dict.FULL_COVERAGE,
    shortLabel: 'מלא',
    icon: Crown,
    color: 'text-purple-600',
  },
  PARTIAL_COVERAGE: {
    label: dict.PARTIAL_COVERAGE,
    shortLabel: 'חלקי',
    icon: Flower,
    color: 'text-pink-600',
  },
  HAT_BERET: {
    label: dict.HAT_BERET,
    shortLabel: 'כובע',
    icon: Sun,
    color: 'text-orange-600',
  },
  SCARF_ONLY_SOMETIMES: {
    label: dict.SCARF_ONLY_SOMETIMES,
    shortLabel: 'לאירועים',
    icon: Sparkle,
    color: 'text-rose-600',
  },
  NONE: {
    label: dict.NONE,
    shortLabel: 'ללא',
    icon: Wind,
    color: 'text-blue-600',
  },
  any: {
    label: 'גמיש/ה',
    shortLabel: 'גמיש',
    icon: Rainbow,
    color: 'text-indigo-600',
  },
});

const createKippahTypeMap = (
  dict: ProfileCardDict['options']['kippahType']
) => ({
  BLACK_VELVET: {
    label: dict.BLACK_VELVET,
    shortLabel: 'קטיפה',
    icon: Crown,
    color: 'text-indigo-700',
  },
  KNITTED_SMALL: {
    label: dict.KNITTED_SMALL,
    shortLabel: 'סרוגה קטנה',
    icon: Star,
    color: 'text-blue-600',
  },
  KNITTED_LARGE: {
    label: dict.KNITTED_LARGE,
    shortLabel: 'סרוגה גדולה',
    icon: Stars,
    color: 'text-blue-700',
  },
  CLOTH: {
    label: dict.CLOTH,
    shortLabel: 'בד',
    icon: Flower,
    color: 'text-green-600',
  },
  BRESLEV: {
    label: dict.BRESLEV,
    shortLabel: 'ברסלב',
    icon: Sparkle,
    color: 'text-purple-600',
  },
  NONE_AT_WORK_OR_CASUAL: {
    label: dict.NONE_AT_WORK_OR_CASUAL,
    shortLabel: 'לא בעבודה',
    icon: Briefcase,
    color: 'text-gray-600',
  },
  NONE_USUALLY: {
    label: dict.NONE_USUALLY,
    shortLabel: 'לרוב לא',
    icon: Wind,
    color: 'text-gray-500',
  },
  OTHER: {
    label: dict.OTHER,
    shortLabel: 'ייחודי',
    icon: Rainbow,
    color: 'text-pink-600',
  },
  any: {
    label: 'גמיש',
    shortLabel: 'גמיש',
    icon: Globe,
    color: 'text-teal-600',
  },
});

const createCharacterTraitMap = (
  dict: ProfileCardDict['options']['traits']
) => ({
  empathetic: {
    label: dict.empathetic,
    shortLabel: 'אמפתי',
    icon: Heart,
    color: 'text-rose-600',
  },
  driven: {
    label: dict.driven,
    shortLabel: 'שאפתן',
    icon: Zap,
    color: 'text-orange-600',
  },
  optimistic: {
    label: dict.optimistic,
    shortLabel: 'אופטימי',
    icon: Sunrise,
    color: 'text-yellow-600',
  },
  family_oriented: {
    label: dict.family_oriented,
    shortLabel: 'משפחתי',
    icon: Users2,
    color: 'text-pink-600',
  },
  intellectual: {
    label: dict.intellectual,
    shortLabel: 'אינטלקטואל',
    icon: BookOpen,
    color: 'text-indigo-600',
  },
  organized: {
    label: dict.organized,
    shortLabel: 'מאורגן',
    icon: CheckCircle,
    color: 'text-green-600',
  },
  calm: {
    label: dict.calm,
    shortLabel: 'רגוע',
    icon: Waves,
    color: 'text-blue-600',
  },
  humorous: {
    label: dict.humorous,
    shortLabel: 'מצחיק',
    icon: Smile,
    color: 'text-purple-600',
  },
  sociable: {
    label: dict.sociable,
    shortLabel: 'חברותי',
    icon: Users,
    color: 'text-cyan-600',
  },
  sensitive: {
    label: dict.sensitive,
    shortLabel: 'רגיש',
    icon: Flower,
    color: 'text-pink-600',
  },
  independent: {
    label: dict.independent,
    shortLabel: 'עצמאי',
    icon: Crown,
    color: 'text-amber-600',
  },
  creative: {
    label: dict.creative,
    shortLabel: 'יצירתי',
    icon: Palette,
    color: 'text-rose-600',
  },
  honest: {
    label: dict.honest,
    shortLabel: 'כן וישר',
    icon: Star,
    color: 'text-blue-600',
  },
  responsible: {
    label: dict.responsible,
    shortLabel: 'אחראי',
    icon: Award,
    color: 'text-green-600',
  },
  easy_going: {
    label: dict.easy_going,
    shortLabel: 'זורם',
    icon: Wind,
    color: 'text-teal-600',
  },
  no_strong_preference: {
    label: 'פתוח/ה לגילוי',
    shortLabel: 'פתוח',
    icon: Compass,
    color: 'text-gray-600',
  },
});

const createHobbiesMap = (dict: ProfileCardDict['options']['hobbies']) => ({
  travel: {
    label: dict.travel,
    shortLabel: 'טיולים',
    icon: Compass,
    color: 'text-green-600',
  },
  sports: {
    label: dict.sports,
    shortLabel: 'ספורט',
    icon: Zap,
    color: 'text-orange-600',
  },
  reading: {
    label: dict.reading,
    shortLabel: 'קריאה',
    icon: BookOpen,
    color: 'text-indigo-600',
  },
  cooking_baking: {
    label: dict.cooking_baking,
    shortLabel: 'בישול',
    icon: Coffee,
    color: 'text-amber-600',
  },
  music_playing_instrument: {
    label: dict.music_playing_instrument,
    shortLabel: 'מוזיקה',
    icon: Music,
    color: 'text-purple-600',
  },
  art_crafts: {
    label: dict.art_crafts,
    shortLabel: 'אומנות',
    icon: Palette,
    color: 'text-pink-600',
  },
  volunteering: {
    label: dict.volunteering,
    shortLabel: 'התנדבות',
    icon: Heart,
    color: 'text-rose-600',
  },
  learning_courses: {
    label: dict.learning_courses,
    shortLabel: 'למידה',
    icon: GraduationCap,
    color: 'text-blue-600',
  },
  board_games_puzzles: {
    label: dict.board_games_puzzles,
    shortLabel: 'משחקים',
    icon: Play,
    color: 'text-cyan-600',
  },
  movies_theater: {
    label: dict.movies_theater,
    shortLabel: 'סרטים',
    icon: Camera,
    color: 'text-red-600',
  },
  dancing: {
    label: dict.dancing,
    shortLabel: 'ריקוד',
    icon: Sparkle,
    color: 'text-pink-600',
  },
  writing: {
    label: dict.writing,
    shortLabel: 'כתיבה',
    icon: Edit3,
    color: 'text-gray-600',
  },
  nature_hiking: {
    label: dict.nature_hiking,
    shortLabel: 'טבע',
    icon: TreePine,
    color: 'text-green-600',
  },
  photography: {
    label: dict.photography,
    shortLabel: 'צילום',
    icon: Camera,
    color: 'text-blue-600',
  },
  no_strong_preference: {
    label: 'פתוח/ה לגילוי יחד',
    shortLabel: 'פתוח',
    icon: Rainbow,
    color: 'text-gray-600',
  },
});

const createContactPreferenceMap = () => ({
  direct: {
    label: 'ישירות',
    shortLabel: 'ישירות',
    icon: PhoneIcon,
    color: 'text-green-600',
  },
  matchmaker: {
    label: 'דרך השדכן/ית',
    shortLabel: 'דרך שדכן',
    icon: Users,
    color: 'text-purple-600',
  },
  both: {
    label: 'גמיש/ה',
    shortLabel: 'גמיש',
    icon: MessageSquare,
    color: 'text-blue-600',
  },
});

// Enhanced Interfaces with Responsive Support
interface CreateSuggestionData {
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
  firstPartyId: string;
  secondPartyId: string;
  status:
    | 'DRAFT'
    | 'PENDING_FIRST_PARTY'
    | 'FIRST_PARTY_APPROVED'
    | 'FIRST_PARTY_DECLINED'
    | string;
  firstPartyNotes?: string;
  secondPartyNotes?: string;
}

interface ExcitementFactor {
  icon: React.ElementType;
  text: string;
  gradient: string;
  shortText?: string;
}

// Enhanced Color Palette & Theme with Responsive Support
const COLOR_PALETTES = {
  professional: {
    name: 'כחול-אפור',
    colors: {
      primary: {
        main: 'from-gray-700 via-gray-800 to-gray-900',
        mainSm: 'from-gray-600 via-gray-700 to-gray-800', // גרסה קלה יותר למובייל
        accent: 'from-blue-600 via-blue-700 to-blue-800',
        accentSm: 'from-blue-500 via-blue-600 to-blue-700',
        light: 'from-gray-100 via-gray-200 to-gray-300',
        lightSm: 'from-gray-50 via-gray-100 to-gray-200',
        romantic: 'from-blue-600 via-blue-700 to-blue-800',
        romanticSm: 'from-blue-500 via-blue-600 to-blue-700',
        rose: 'from-blue-500 via-blue-600 to-blue-700',
        roseSm: 'from-blue-400 via-blue-500 to-blue-600',
        gold: 'from-gray-400 via-gray-500 to-gray-600',
        goldSm: 'from-gray-300 via-gray-400 to-gray-500',
        elegant: 'from-gray-700 via-gray-800 to-gray-900',
        elegantSm: 'from-gray-600 via-gray-700 to-gray-800',
      },
      secondary: {
        sage: 'from-gray-300 via-gray-400 to-gray-500',
        sageSm: 'from-gray-200 via-gray-300 to-gray-400',
        sky: 'from-blue-100 via-blue-200 to-blue-300',
        skySm: 'from-blue-50 via-blue-100 to-blue-200',
        lavender: 'from-gray-200 via-gray-300 to-gray-400',
        lavenderSm: 'from-gray-100 via-gray-200 to-gray-300',
        peach: 'from-orange-100 via-amber-100 to-yellow-200',
        peachSm: 'from-orange-50 via-amber-50 to-yellow-100',
      },
      neutral: {
        warm: 'from-gray-50 via-white to-gray-100',
        warmSm: 'from-gray-25 via-white to-gray-50',
        cool: 'from-slate-50 via-gray-50 to-zinc-50',
        coolSm: 'from-slate-25 via-gray-25 to-zinc-25',
        elegant: 'from-white via-gray-50 to-neutral-100',
        elegantSm: 'from-white via-gray-25 to-neutral-50',
      },
    },
    shadows: {
      elegant: 'shadow-lg sm:shadow-xl shadow-gray-200/25',
      elegantSm: 'shadow-md shadow-gray-200/20',
      warm: 'shadow-md sm:shadow-lg shadow-gray-200/30',
      warmSm: 'shadow-sm shadow-gray-200/25',
      soft: 'shadow-sm sm:shadow-md shadow-gray-100/40',
      softSm: 'shadow-xs shadow-gray-100/30',
    },
  },
  feminine: {
    name: 'ורוד-אדום',
    colors: {
      primary: {
        main: 'from-rose-400 via-pink-400 to-rose-500',
        mainSm: 'from-rose-300 via-pink-300 to-rose-400',
        accent: 'from-pink-500 via-rose-500 to-red-400',
        accentSm: 'from-pink-400 via-rose-400 to-red-300',
        light: 'from-pink-100 via-rose-100 to-red-100',
        lightSm: 'from-pink-50 via-rose-50 to-red-50',
        romantic: 'from-rose-400 via-pink-400 to-rose-500',
        romanticSm: 'from-rose-300 via-pink-300 to-rose-400',
        rose: 'from-rose-400 via-pink-400 to-rose-500',
        roseSm: 'from-rose-300 via-pink-300 to-rose-400',
        gold: 'from-amber-200 via-yellow-200 to-orange-300',
        goldSm: 'from-amber-100 via-yellow-100 to-orange-200',
        elegant: 'from-pink-500 via-rose-500 to-red-400',
        elegantSm: 'from-pink-400 via-rose-400 to-red-300',
      },
      secondary: {
        sage: 'from-pink-200 via-rose-200 to-red-200',
        sageSm: 'from-pink-100 via-rose-100 to-red-100',
        sky: 'from-purple-200 via-pink-200 to-rose-300',
        skySm: 'from-purple-100 via-pink-100 to-rose-200',
        lavender: 'from-purple-200 via-violet-200 to-purple-300',
        lavenderSm: 'from-purple-100 via-violet-100 to-purple-200',
        peach: 'from-pink-200 via-rose-200 to-orange-300',
        peachSm: 'from-pink-100 via-rose-100 to-orange-200',
      },
      neutral: {
        warm: 'from-rose-50 via-pink-50 to-orange-50',
        warmSm: 'from-rose-25 via-pink-25 to-orange-25',
        cool: 'from-purple-50 via-pink-50 to-rose-50',
        coolSm: 'from-purple-25 via-pink-25 to-rose-25',
        elegant: 'from-pink-50 via-rose-50 to-neutral-100',
        elegantSm: 'from-pink-25 via-rose-25 to-neutral-50',
      },
    },
    shadows: {
      elegant: 'shadow-lg sm:shadow-xl shadow-pink-200/25',
      elegantSm: 'shadow-md shadow-pink-200/20',
      warm: 'shadow-md sm:shadow-lg shadow-rose-200/30',
      warmSm: 'shadow-sm shadow-rose-200/25',
      soft: 'shadow-sm sm:shadow-md shadow-pink-100/40',
      softSm: 'shadow-xs shadow-pink-100/30',
    },
  },
  masculine: {
    name: 'כחול-ירוק',
    colors: {
      primary: {
        main: 'from-blue-600 via-indigo-600 to-blue-700',
        mainSm: 'from-blue-500 via-indigo-500 to-blue-600',
        accent: 'from-cyan-500 via-blue-500 to-indigo-600',
        accentSm: 'from-cyan-400 via-blue-400 to-indigo-500',
        light: 'from-blue-100 via-indigo-100 to-cyan-100',
        lightSm: 'from-blue-50 via-indigo-50 to-cyan-50',
        romantic: 'from-cyan-500 via-blue-500 to-indigo-600',
        romanticSm: 'from-cyan-400 via-blue-400 to-indigo-500',
        rose: 'from-cyan-500 via-blue-500 to-indigo-600',
        roseSm: 'from-cyan-400 via-blue-400 to-indigo-500',
        gold: 'from-blue-200 via-cyan-200 to-teal-300',
        goldSm: 'from-blue-100 via-cyan-100 to-teal-200',
        elegant: 'from-blue-600 via-indigo-600 to-blue-700',
        elegantSm: 'from-blue-500 via-indigo-500 to-blue-600',
      },
      secondary: {
        sage: 'from-emerald-300 via-teal-300 to-cyan-400',
        sageSm: 'from-emerald-200 via-teal-200 to-cyan-300',
        sky: 'from-blue-200 via-sky-200 to-indigo-300',
        skySm: 'from-blue-100 via-sky-100 to-indigo-200',
        lavender: 'from-indigo-200 via-blue-200 to-cyan-300',
        lavenderSm: 'from-indigo-100 via-blue-100 to-cyan-200',
        peach: 'from-blue-200 via-cyan-200 to-teal-300',
        peachSm: 'from-blue-100 via-cyan-100 to-teal-200',
      },
      neutral: {
        warm: 'from-blue-50 via-indigo-50 to-cyan-50',
        warmSm: 'from-blue-25 via-indigo-25 to-cyan-25',
        cool: 'from-slate-50 via-blue-50 to-indigo-50',
        coolSm: 'from-slate-25 via-blue-25 to-indigo-25',
        elegant: 'from-gray-50 via-blue-50 to-neutral-100',
        elegantSm: 'from-gray-25 via-blue-25 to-neutral-50',
      },
    },
    shadows: {
      elegant: 'shadow-lg sm:shadow-xl shadow-blue-200/25',
      elegantSm: 'shadow-md shadow-blue-200/20',
      warm: 'shadow-md sm:shadow-lg shadow-indigo-200/30',
      warmSm: 'shadow-sm shadow-indigo-200/25',
      soft: 'shadow-sm sm:shadow-md shadow-blue-100/40',
      softSm: 'shadow-xs shadow-blue-100/30',
    },
  },
  luxury: {
    name: 'זהב-סגול',
    colors: {
      primary: {
        main: 'from-amber-500 via-yellow-500 to-amber-600',
        mainSm: 'from-amber-400 via-yellow-400 to-amber-500',
        accent: 'from-purple-600 via-indigo-600 to-purple-700',
        accentSm: 'from-purple-500 via-indigo-500 to-purple-600',
        light: 'from-amber-100 via-yellow-100 to-gold-100',
        lightSm: 'from-amber-50 via-yellow-50 to-gold-50',
        romantic: 'from-purple-600 via-indigo-600 to-purple-700',
        romanticSm: 'from-purple-500 via-indigo-500 to-purple-600',
        rose: 'from-purple-600 via-indigo-600 to-purple-700',
        roseSm: 'from-purple-500 via-indigo-500 to-purple-600',
        gold: 'from-amber-500 via-yellow-500 to-amber-600',
        goldSm: 'from-amber-400 via-yellow-400 to-amber-500',
        elegant: 'from-amber-500 via-yellow-500 to-amber-600',
        elegantSm: 'from-amber-400 via-yellow-400 to-amber-500',
      },
      secondary: {
        sage: 'from-emerald-400 via-teal-400 to-cyan-500',
        sageSm: 'from-emerald-300 via-teal-300 to-cyan-400',
        sky: 'from-indigo-300 via-purple-300 to-violet-400',
        skySm: 'from-indigo-200 via-purple-200 to-violet-300',
        lavender: 'from-purple-300 via-violet-300 to-indigo-400',
        lavenderSm: 'from-purple-200 via-violet-200 to-indigo-300',
        peach: 'from-amber-300 via-yellow-300 to-orange-400',
        peachSm: 'from-amber-200 via-yellow-200 to-orange-300',
      },
      neutral: {
        warm: 'from-amber-50 via-yellow-50 to-orange-50',
        warmSm: 'from-amber-25 via-yellow-25 to-orange-25',
        cool: 'from-purple-50 via-indigo-50 to-violet-50',
        coolSm: 'from-purple-25 via-indigo-25 to-violet-25',
        elegant: 'from-gray-50 via-amber-50 to-neutral-100',
        elegantSm: 'from-gray-25 via-amber-25 to-neutral-50',
      },
    },
    shadows: {
      elegant: 'shadow-lg sm:shadow-xl shadow-amber-200/25',
      elegantSm: 'shadow-md shadow-amber-200/20',
      warm: 'shadow-md sm:shadow-lg shadow-yellow-200/30',
      warmSm: 'shadow-sm shadow-yellow-200/25',
      soft: 'shadow-sm sm:shadow-md shadow-amber-100/40',
      softSm: 'shadow-xs shadow-amber-100/30',
    },
  },
} as const;

type ColorPaletteName = keyof typeof COLOR_PALETTES;

type ThemeType = {
  colors: {
    primary: {
      main: string;
      mainSm: string;
      accent: string;
      accentSm: string;
      light: string;
      lightSm: string;
      romantic: string;
      romanticSm: string;
      rose: string;
      roseSm: string;
      gold: string;
      goldSm: string;
      elegant: string;
      elegantSm: string;
    };
    secondary: {
      sage: string;
      sageSm: string;
      sky: string;
      skySm: string;
      lavender: string;
      lavenderSm: string;
      peach: string;
      peachSm: string;
    };
    neutral: {
      warm: string;
      warmSm: string;
      cool: string;
      coolSm: string;
      elegant: string;
      elegantSm: string;
    };
  };
  shadows: {
    elegant: string;
    elegantSm: string;
    warm: string;
    warmSm: string;
    soft: string;
    softSm: string;
  };
};

// --- Enhanced Helper Functions with Responsive Support ---

const formatEnumValue = (
  value: string | null | undefined,
  map: {
    [key: string]: {
      label: string;
      shortLabel?: string;
      icon: React.ElementType;
      color: string;
      mobileClasses?: string;
    };
  },
  placeholder: string,
  useMobile: boolean = false
): {
  label: string;
  shortLabel?: string;
  icon: React.ElementType;
  color: string;
  mobileClasses?: string;
} => {
  if (!value || !map[value]) {
    return {
      label: placeholder,
      shortLabel:
        useMobile && placeholder.length > 10
          ? placeholder.substring(0, 10) + '...'
          : placeholder,
      icon: Telescope,
      color: 'text-gray-500',
      mobileClasses: 'text-xs sm:text-sm',
    };
  }

  const result = map[value];
  return {
    ...result,
    shortLabel:
      result.shortLabel ||
      (useMobile && result.label.length > 10
        ? result.label.substring(0, 10) + '...'
        : result.label),
  };
};

const getInitials = (
  firstName?: string,
  lastName?: string,
  maxLength: number = 2
): string => {
  let initials = '';
  if (firstName && firstName.length > 0) initials += firstName[0];
  if (lastName && lastName.length > 0) initials += lastName[0];

  if (initials.length === 0 && firstName && firstName.length > 0) {
    initials =
      firstName.length > 1
        ? firstName.substring(0, Math.min(maxLength, firstName.length))
        : firstName[0];
  }

  return initials.toUpperCase() || '♥';
};

const calculateAge = (birthDate: Date | string | null | undefined): number => {
  if (!birthDate) return 0;
  try {
    const today = new Date();
    const birth = new Date(birthDate);
    if (isNaN(birth.getTime())) return 0;
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age > 0 ? age : 0;
  } catch (e) {
    return 0;
  }
};

const formatAvailabilityStatus = (
  status: UserProfile['availabilityStatus'] | undefined,
  THEME: ThemeType,
  dict: ProfileCardDisplayDict['availability'] & { mysterious: string },
  badgeDict: ProfileCardDisplayDict['header']['availabilityBadge']
) => {
  const statusMap = {
    AVAILABLE: {
      text: dict.AVAILABLE,
      shortText: badgeDict.available_short,
      gradient: THEME.colors.primary.main,
      gradientSm: THEME.colors.primary.mainSm,
      icon: Heart,
      pulse: false,
      bgColor: `bg-gradient-to-r ${THEME.colors.primary.main}`,
      bgColorSm: `bg-gradient-to-r ${THEME.colors.primary.mainSm}`,
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
    UNAVAILABLE: {
      text: dict.UNAVAILABLE,
      shortText: badgeDict.unavailable_short,
      gradient: 'from-gray-400 to-gray-500',
      gradientSm: 'from-gray-300 to-gray-400',
      icon: Clock,
      pulse: false,
      bgColor: 'bg-gradient-to-r from-gray-400 to-gray-500',
      bgColorSm: 'bg-gradient-to-r from-gray-300 to-gray-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
    DATING: {
      text: dict.DATING,
      shortText: badgeDict.dating_short,
      gradient: THEME.colors.primary.accent,
      gradientSm: THEME.colors.primary.accentSm,
      icon: Coffee,
      pulse: false,
      bgColor: 'bg-gradient-to-r from-amber-500 to-orange-500',
      bgColorSm: 'bg-gradient-to-r from-amber-400 to-orange-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
    PAUSED: {
      text: dict.PAUSED,
      shortText: badgeDict.paused_short,
      gradient: THEME.colors.secondary.sky,
      gradientSm: THEME.colors.secondary.skySm,
      icon: Moon,
      pulse: false,
      bgColor: 'bg-gradient-to-r from-blue-500 to-cyan-500',
      bgColorSm: 'bg-gradient-to-r from-blue-400 to-cyan-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
    ENGAGED: {
      text: dict.ENGAGED,
      shortText: badgeDict.engaged_short,
      gradient: THEME.colors.primary.light,
      gradientSm: THEME.colors.primary.lightSm,
      icon: Star,
      pulse: false,
      bgColor: 'bg-gradient-to-r from-pink-500 to-rose-500',
      bgColorSm: 'bg-gradient-to-r from-pink-400 to-rose-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
    MARRIED: {
      text: dict.MARRIED,
      shortText: badgeDict.married_short,
      gradient: THEME.colors.primary.main,
      gradientSm: THEME.colors.primary.mainSm,
      icon: Heart,
      pulse: false,
      bgColor: 'bg-gradient-to-r from-rose-500 to-pink-500',
      bgColorSm: 'bg-gradient-to-r from-rose-400 to-pink-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    },
  };

  return (
    statusMap[status as keyof typeof statusMap] || {
      text: dict.mysterious,
      shortText: badgeDict.mysterious_short,
      gradient: THEME.colors.secondary.lavender,
      gradientSm: THEME.colors.secondary.lavenderSm,
      icon: Sparkles,
      pulse: true,
      bgColor: 'bg-gradient-to-r from-purple-500 to-indigo-500',
      bgColorSm: 'bg-gradient-to-r from-purple-400 to-indigo-400',
      mobileClasses: 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
    }
  );
};

const formatBooleanPreference = (
  value: boolean | null | undefined,
  dict: ProfileCardDisplayDict['booleanPrefs'] & { willDiscover: string },
  useYesShomer: boolean = false,
  useMobile: boolean = false
): {
  label: string;
  shortLabel?: string;
  icon: React.ElementType;
  color: string;
  mobileClasses?: string;
} => {
  const yesLabel = useYesShomer ? dict.shomerYes : dict.yes;
  const noLabel = dict.no;
  const notSpecifiedLabel = dict.willDiscover;

  const baseResponse = {
    mobileClasses: 'text-xs sm:text-sm',
  };

  if (value === true) {
    return {
      label: yesLabel,
      shortLabel:
        useMobile && yesLabel.length > 8
          ? yesLabel.substring(0, 8) + '...'
          : yesLabel,
      icon: CheckCircle,
      color: 'text-green-600',
      ...baseResponse,
    };
  }

  if (value === false) {
    return {
      label: noLabel,
      shortLabel:
        useMobile && noLabel.length > 8
          ? noLabel.substring(0, 8) + '...'
          : noLabel,
      icon: X,
      color: 'text-red-500',
      ...baseResponse,
    };
  }

  return {
    label: notSpecifiedLabel,
    shortLabel:
      useMobile && notSpecifiedLabel.length > 8
        ? notSpecifiedLabel.substring(0, 8) + '...'
        : notSpecifiedLabel,
    icon: Telescope,
    color: 'text-gray-500',
    ...baseResponse,
  };
};

// --- Enhanced Helper Components with Full Responsive Support ---

// 1. DetailItem
const DetailItem: React.FC<{
  icon: React.ElementType;
  label: string;
  value: React.ReactNode;
  className?: string;
  iconColorClass?: string;
  valueClassName?: string;
  tooltip?: string;
  variant?: 'default' | 'highlight' | 'elegant' | 'romantic';
  size?: 'sm' | 'md' | 'lg';
  textAlign?: 'center' | 'right' | 'left' | 'start' | 'end';
  responsive?: boolean;
  useMobileLayout?: boolean;
  placeholder: string;
}> = ({
  icon: Icon,
  label,
  value,
  className,
  iconColorClass = 'text-rose-500',
  valueClassName,
  tooltip,
  variant = 'default',
  size = 'md',
  textAlign = 'center',
  responsive = true,
  useMobileLayout = false,
  placeholder,
}) => {
  const sizes = {
    sm: {
      container: 'p-2 gap-2 sm:p-3 sm:gap-3',
      icon: 'w-6 h-6 sm:w-8 sm:h-8',
      iconPadding: 'p-1 sm:p-1.5',
      text: 'text-xs sm:text-sm',
      label: 'text-xs sm:text-sm',
      value: 'text-xs sm:text-sm',
    },
    md: {
      container: 'p-2 gap-2 sm:p-3 sm:gap-3 md:p-4 md:gap-4',
      icon: 'w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12',
      iconPadding: 'p-1.5 sm:p-2 md:p-2.5',
      text: 'text-xs sm:text-sm md:text-base',
      label: 'text-xs sm:text-sm md:text-base',
      value: 'text-xs sm:text-sm md:text-base',
    },
    lg: {
      container: 'p-3 gap-3 sm:p-4 sm:gap-4 md:p-5 md:gap-5',
      icon: 'w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14',
      iconPadding: 'p-2 sm:p-2.5 md:p-3',
      text: 'text-sm sm:text-base md:text-lg',
      label: 'text-sm sm:text-base md:text-lg',
      value: 'text-sm sm:text-base md:text-lg',
    },
  };

  const variants = {
    default: {
      card: 'bg-white border border-gray-200 hover:border-rose-300 hover:shadow-md',
      icon: 'bg-rose-50 border border-rose-200',
      iconColor: iconColorClass || 'text-rose-500',
    },
    highlight: {
      card: `bg-gradient-to-r from-rose-50 via-pink-50 to-rose-50 border border-rose-200 shadow-sm hover:shadow-md`,
      icon: `bg-gradient-to-r from-rose-500 via-pink-500 to-rose-600 text-white shadow-sm`,
      iconColor: 'text-white',
    },
    elegant: {
      card: `bg-gradient-to-br from-white via-gray-50 to-neutral-100 border border-amber-200 shadow-md hover:shadow-lg`,
      icon: `bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-500 text-white shadow-md`,
      iconColor: 'text-white',
    },
    romantic: {
      card: `bg-gradient-to-r from-rose-50 via-pink-50 to-orange-50 border border-pink-200 shadow-sm hover:shadow-lg`,
      icon: `bg-gradient-to-r from-pink-500 via-rose-500 to-red-500 text-white shadow-sm`,
      iconColor: 'text-white',
    },
  };

  const currentSize = sizes[size];
  const currentVariant = variants[variant];
  const textAlignClass = `text-${textAlign}`;

  const content = (
    <div
      className={cn(
        'flex rounded-xl transition-all duration-300',
        'min-w-0 w-full max-w-full overflow-hidden',
        useMobileLayout
          ? 'flex-col items-center text-center gap-2 sm:gap-3'
          : 'items-start',
        currentSize.container,
        currentVariant.card,
        responsive && 'hover:scale-[1.02] active:scale-[0.98]',
        className
      )}
    >
      <div
        className={cn(
          'flex-1 overflow-hidden',
          useMobileLayout ? 'text-center w-full' : 'min-w-0'
        )}
      >
        <div className="flex items-center justify-center gap-2 sm:gap-3 mb-2">
          <div
            className={cn(
              'flex-shrink-0 rounded-lg transition-all duration-300',
              currentSize.iconPadding,
              currentVariant.icon,
              'min-w-fit'
            )}
          >
            <Icon
              aria-hidden="true"
              className={cn(
                currentSize.icon,
                currentVariant.iconColor,
                'transition-all duration-300'
              )}
            />
          </div>
        </div>
        <p
          className={cn(
            'font-semibold mb-1 tracking-wide leading-tight',
            textAlignClass,
            currentSize.label,
            'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere',
            variant === 'highlight' || variant === 'elegant'
              ? 'text-rose-700 sm:text-gray-700'
              : 'text-gray-600 sm:text-gray-700',
            useMobileLayout && 'px-1'
          )}
        >
          {label}
        </p>
        <div
          className={cn(
            'font-medium leading-relaxed',
            textAlignClass,
            currentSize.value,
            'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere',
            'max-w-full overflow-hidden',
            variant === 'highlight' || variant === 'elegant'
              ? 'text-gray-800 sm:text-gray-900'
              : 'text-gray-700 sm:text-gray-800',
            useMobileLayout && 'px-1',
            valueClassName
          )}
        >
          {value || (
            <span className="text-gray-400 italic text-xs sm:text-sm">
              {placeholder}
            </span>
          )}
        </div>
      </div>
    </div>
  );

  if (tooltip && responsive) {
    return (
      <Tooltip>
        <TooltipTrigger asChild className="w-full">
          {content}
        </TooltipTrigger>
        <TooltipContent
          side="top"
          className="max-w-xs text-center bg-white border border-rose-200 shadow-lg z-50"
          sideOffset={5}
        >
          <p className="text-gray-700 text-sm break-words p-2">{tooltip}</p>
        </TooltipContent>
      </Tooltip>
    );
  }

  return content;
};

// 2. EmptyState
const EmptyState: React.FC<{
  icon: React.ElementType;
  title: string;
  description?: string;
  className?: string;
  action?: React.ReactNode;
  variant?: 'mystery' | 'adventure' | 'discovery' | 'romantic';
  size?: 'sm' | 'md' | 'lg';
  compact?: boolean;
  THEME?: ThemeType;
}> = ({
  icon: Icon,
  title,
  description,
  className,
  action,
  variant = 'discovery',
  size = 'md',
  compact = false,
  THEME,
}) => {
  const sizes = {
    sm: {
      container: compact ? 'py-4 px-3' : 'py-6 px-4',
      icon: 'w-6 h-6 sm:w-8 sm:h-8',
      iconContainer: 'p-2 sm:p-3',
      title: 'text-sm sm:text-base',
      description: 'text-xs sm:text-sm',
      spacing: 'mb-2 sm:mb-3',
    },
    md: {
      container: compact ? 'py-6 px-4' : 'py-8 px-6',
      icon: 'w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12',
      iconContainer: 'p-3 sm:p-4',
      title: 'text-base sm:text-lg md:text-xl',
      description: 'text-sm sm:text-base',
      spacing: 'mb-3 sm:mb-4',
    },
    lg: {
      container: compact ? 'py-8 px-6' : 'py-12 px-8',
      icon: 'w-10 h-10 sm:w-12 sm:h-12 md:w-16 md:h-16',
      iconContainer: 'p-4 sm:p-5 md:p-6',
      title: 'text-lg sm:text-xl md:text-2xl',
      description: 'text-base sm:text-lg',
      spacing: 'mb-4 sm:mb-6',
    },
  };

  const variants = useMemo(() => {
    const baseVariants = {
      mystery: {
        bg: `bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100`,
        bgSm: `bg-gradient-to-br from-purple-25 via-violet-25 to-purple-50`,
        border: 'border-purple-200 hover:border-purple-300',
        iconBg: `bg-gradient-to-r from-purple-500 via-violet-500 to-purple-600`,
        iconBgSm: `bg-gradient-to-r from-purple-400 via-violet-400 to-purple-500`,
        textColor: 'text-purple-700 sm:text-purple-800',
        titleColor: 'text-purple-800 sm:text-purple-900',
      },
      adventure: {
        bg: `bg-gradient-to-br from-emerald-50 via-teal-50 to-green-100`,
        bgSm: `bg-gradient-to-br from-emerald-25 via-teal-25 to-green-50`,
        border: 'border-emerald-200 hover:border-emerald-300',
        iconBg: `bg-gradient-to-r from-emerald-500 via-teal-500 to-green-600`,
        iconBgSm: `bg-gradient-to-r from-emerald-400 via-teal-400 to-green-500`,
        textColor: 'text-emerald-700 sm:text-emerald-800',
        titleColor: 'text-emerald-800 sm:text-emerald-900',
      },
      discovery: {
        bg: `bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-100`,
        bgSm: `bg-gradient-to-br from-amber-25 via-yellow-25 to-orange-50`,
        border: 'border-amber-200 hover:border-amber-300',
        iconBg: `bg-gradient-to-r from-amber-500 via-yellow-500 to-orange-600`,
        iconBgSm: `bg-gradient-to-r from-amber-400 via-yellow-400 to-orange-500`,
        textColor: 'text-amber-700 sm:text-amber-800',
        titleColor: 'text-amber-800 sm:text-amber-900',
      },
      romantic: {
        bg: `bg-gradient-to-br from-rose-50 via-pink-50 to-red-100`,
        bgSm: `bg-gradient-to-br from-rose-25 via-pink-25 to-red-50`,
        border: 'border-rose-200 hover:border-rose-300',
        iconBg: `bg-gradient-to-r from-rose-500 via-pink-500 to-red-600`,
        iconBgSm: `bg-gradient-to-r from-rose-400 via-pink-400 to-red-500`,
        textColor: 'text-rose-700 sm:text-rose-800',
        titleColor: 'text-rose-800 sm:text-rose-900',
      },
    };

    if (THEME) {
      return {
        ...baseVariants,
        discovery: {
          bg: `bg-gradient-to-br ${THEME.colors.neutral.warm}`,
          bgSm: `bg-gradient-to-br ${THEME.colors.neutral.warmSm}`,
          border: 'border-gray-200 hover:border-gray-300',
          iconBg: `bg-gradient-to-r ${THEME.colors.primary.main}`,
          iconBgSm: `bg-gradient-to-r ${THEME.colors.primary.mainSm}`,
          textColor: 'text-gray-700 sm:text-gray-800',
          titleColor: 'text-gray-800 sm:text-gray-900',
        },
        romantic: {
          ...baseVariants.romantic,
          iconBg: `bg-gradient-to-r ${THEME.colors.primary.romantic}`,
          iconBgSm: `bg-gradient-to-r ${THEME.colors.primary.romanticSm}`,
        },
      };
    }
    return baseVariants;
  }, [THEME]);

  const currentSize = sizes[size];
  const currentVariant = variants[variant];

  return (
    <div
      className={cn(
        'flex flex-col items-center justify-center text-center rounded-xl border border-dashed transition-all duration-300',
        currentSize.container,
        currentVariant.bg,
        'sm:' + currentVariant.bgSm,
        currentVariant.border,
        'shadow-sm hover:shadow-md',
        'max-w-full overflow-hidden',
        className
      )}
    >
      <div
        className={cn(
          'rounded-full transition-all duration-300 hover:scale-110 active:scale-95',
          currentSize.iconContainer,
          currentSize.spacing,
          currentVariant.iconBg,
          THEME
            ? `${THEME.shadows.warm} hover:${THEME.shadows.elegant}`
            : 'shadow-md hover:shadow-lg sm:shadow-lg sm:hover:shadow-xl'
        )}
      >
        <Icon
          className={cn(
            currentSize.icon,
            'text-white transition-all duration-300'
          )}
        />
      </div>

      <h3
        className={cn(
          'font-bold leading-tight',
          currentSize.title,
          currentVariant.titleColor,
          currentSize.spacing,
          'break-words hyphens-auto word-break-break-word max-w-full px-2'
        )}
      >
        {title}
      </h3>

      {description && (
        <p
          className={cn(
            'leading-relaxed max-w-xs mx-auto',
            currentSize.description,
            currentVariant.textColor,
            action ? 'mb-4 sm:mb-6' : '',
            'break-words hyphens-auto word-break-break-word px-2'
          )}
        >
          {description}
        </p>
      )}

      {action && (
        <div className="flex flex-wrap justify-center gap-2 sm:gap-3 max-w-full">
          {action}
        </div>
      )}
    </div>
  );
};

// 3. SectionCard
const SectionCard: React.FC<{
  title: string;
  subtitle?: string;
  icon?: React.ElementType;
  children: React.ReactNode;
  className?: string;
  contentClassName?: string;
  headerClassName?: string;
  action?: React.ReactNode;
  variant?: 'default' | 'elegant' | 'romantic' | 'highlight';
  gradient?: string;
  size?: 'sm' | 'md' | 'lg';
  collapsible?: boolean;
  compact?: boolean;
}> = ({
  title,
  subtitle,
  icon: Icon,
  children,
  className,
  contentClassName,
  headerClassName,
  action,
  variant = 'default',
  gradient,
  size = 'md',
  collapsible = false,
  compact = false,
}) => {
  const [isCollapsed, setIsCollapsed] = useState(false);

  const sizes = {
    sm: {
      card: 'rounded-lg sm:rounded-xl',
      header: 'p-2 sm:p-3',
      content: 'p-2 sm:p-3',
      icon: 'w-4 h-4 sm:w-5 sm:h-5',
      iconPadding: 'p-1.5 sm:p-2',
      title: 'text-sm sm:text-base',
      subtitle: 'text-xs sm:text-sm',
      gap: 'gap-2 sm:gap-3',
    },
    md: {
      card: 'rounded-xl sm:rounded-2xl',
      header: compact ? 'p-3 sm:p-4' : 'p-4 sm:p-5 md:p-6',
      content: compact ? 'p-3 sm:p-4' : 'p-4 sm:p-5 md:p-6',
      icon: 'w-5 h-5 sm:w-6 sm:h-6',
      iconPadding: 'p-2 sm:p-2.5',
      title: 'text-base sm:text-lg md:text-xl',
      subtitle: 'text-sm sm:text-base',
      gap: 'gap-3 sm:gap-4',
    },
    lg: {
      card: 'rounded-2xl',
      header: compact ? 'p-4 sm:p-5' : 'p-5 sm:p-6 md:p-8',
      content: compact ? 'p-4 sm:p-5' : 'p-5 sm:p-6 md:p-8',
      icon: 'w-6 h-6 sm:w-7 sm:h-7',
      iconPadding: 'p-2.5 sm:p-3',
      title: 'text-lg sm:text-xl md:text-2xl',
      subtitle: 'text-base sm:text-lg',
      gap: 'gap-4 sm:gap-5',
    },
  };

  const variants = {
    default: {
      card: 'bg-white border-gray-200 shadow-lg hover:shadow-xl',
      header: 'bg-gradient-to-r from-gray-50 to-white border-gray-200',
      headerSm: 'bg-gradient-to-r from-gray-25 to-white border-gray-100',
      iconBg: 'bg-gray-100 border border-gray-200',
      iconColor: 'text-gray-600',
    },
    elegant: {
      card: `bg-white border-amber-200 shadow-xl hover:shadow-2xl`,
      header: `bg-gradient-to-r ${gradient || 'from-amber-50 via-yellow-50 to-orange-50'} border-amber-200`,
      headerSm: `bg-gradient-to-r from-amber-25 via-yellow-25 to-orange-25 border-amber-100`,
      iconBg: `bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-500 text-white shadow-md`,
      iconColor: 'text-white',
    },
    romantic: {
      card: `bg-white border-rose-200 shadow-lg hover:shadow-xl`,
      header: `bg-gradient-to-r ${gradient || 'from-rose-50 via-pink-50 to-red-50'} border-rose-200`,
      headerSm: `bg-gradient-to-r from-rose-25 via-pink-25 to-red-25 border-rose-100`,
      iconBg: `bg-gradient-to-r from-rose-500 via-pink-500 to-red-500 text-white shadow-md`,
      iconColor: 'text-white',
    },
    highlight: {
      card: `bg-white border-pink-200 shadow-lg hover:shadow-xl ring-1 ring-pink-100 hover:ring-pink-200`,
      header: `bg-gradient-to-r ${gradient || 'from-pink-500 via-rose-500 to-red-500'} border-pink-200`,
      headerSm: `bg-gradient-to-r from-pink-400 via-rose-400 to-red-400 border-pink-100`,
      iconBg: `bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-700 text-white shadow-lg`,
      iconColor: 'text-white',
    },
  };

  const currentSize = sizes[size];
  const currentVariant = variants[variant];
  // --- START MODIFICATION ---
  // If a gradient is provided for elegant or romantic variants, use it for the icon background.
  const iconBgClass =
    (variant === 'elegant' ||
      variant === 'romantic' ||
      variant === 'highlight') &&
    gradient
      ? `bg-gradient-to-r ${gradient} text-white shadow-md`
      : currentVariant.iconBg;
  // --- END MODIFICATION ---

  return (
    <div
      className={cn(
        'border overflow-hidden flex flex-col transition-all duration-300',
        currentSize.card,
        currentVariant.card,
        'max-w-full min-w-0',
        className
      )}
    >
      <div
        className={cn(
          'flex items-center justify-between border-b transition-all duration-300',
          currentSize.header,
          'gap-2',
          currentVariant.header,
          'sm:' + currentVariant.headerSm,
          'min-w-0 overflow-hidden',
          headerClassName
        )}
      >
        <div
          className={cn('flex items-center min-w-0 flex-1', 'gap-1 sm:gap-2')}
        >
          {Icon && (
            <div
              className={cn(
                'flex-shrink-0 rounded-lg transition-all duration-300',
                currentSize.iconPadding,
                iconBgClass, // Use the dynamic icon class here
                'hover:scale-110 active:scale-95'
              )}
            >
              <Icon
                className={cn(currentSize.icon, currentVariant.iconColor)}
              />
            </div>
          )}
          <div className="min-w-0 flex-1 overflow-hidden text-center">
            <h3
              className={cn(
                'font-bold leading-tight transition-all duration-300 text-center',
                currentSize.title,
                variant === 'default'
                  ? 'text-gray-800 hover:text-gray-900'
                  : 'text-gray-800',
                'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere max-w-full'
              )}
            >
              {title}
            </h3>
            {subtitle && (
              <p
                className={cn(
                  'mt-0.5 opacity-80 transition-all duration-300 text-center',
                  currentSize.subtitle,
                  'text-gray-600 text-center mx-auto',
                  'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere max-w-full'
                )}
              >
                {subtitle}
              </p>
            )}
          </div>
        </div>
        <div className="flex items-center gap-2 flex-shrink-0">
          {collapsible && (
            <Button
              variant="ghost"
              size="sm"
              className="md:hidden p-1 h-8 w-8 hover:bg-white/60"
              onClick={() => setIsCollapsed(!isCollapsed)}
            >
              <ChevronDown
                className={cn(
                  'w-4 h-4 transition-transform duration-200',
                  isCollapsed && 'rotate-180'
                )}
              />
            </Button>
          )}
          {action && <div className="flex-shrink-0">{action}</div>}
        </div>
      </div>
      <div
        className={cn(
          'transition-all duration-300 overflow-hidden',
          currentSize.content,
          collapsible &&
            isCollapsed &&
            'max-h-0 p-0 md:max-h-none md:p-4 md:sm:p-5 md:md:p-6',
          'min-w-0 max-w-full',
          contentClassName
        )}
      >
        {children}
      </div>
    </div>
  );
};

// 4. ColorPaletteSelector
const ColorPaletteSelector: React.FC<{
  selectedPalette: ColorPaletteName;
  onPaletteChange: (palette: ColorPaletteName) => void;
  THEME: ThemeType;
  dict: ProfileCardDisplayDict['colorPalette'];
  compact?: boolean;
  direction: 'ltr' | 'rtl';
}> = ({
  selectedPalette,
  onPaletteChange,

  dict,
  compact = false,
  direction,
}) => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="relative">
      <Button
        id="color-palette-button"
        aria-haspopup="menu"
        aria-expanded={isOpen}
        variant="ghost"
        size="icon"
        className={cn(
          'bg-white/90 backdrop-blur-sm rounded-full border border-gray-200/80 shadow-lg hover:shadow-xl transition-all duration-300',
          'text-gray-600 hover:text-gray-800 hover:bg-white/95',
          compact
            ? 'w-8 h-8 min-h-[44px] min-w-[44px]'
            : 'w-10 h-10 min-h-[44px] min-w-[44px]',
          'touch-manipulation',
          'active:scale-95 transition-transform' // הוסף
        )}
        onClick={() => setIsOpen(!isOpen)}
        aria-label={dict.selectLabel}
      >
        <Palette
          className={cn(
            compact ? 'w-4 h-4' : 'w-5 h-5',
            'transition-all duration-300'
          )}
        />
      </Button>
      {isOpen && (
        <>
          <div
            className="fixed inset-0 z-40"
            onClick={() => setIsOpen(false)}
          />
          <div
            role="menu"
            aria-labelledby="color-palette-button"
            className={cn(
              'absolute top-full mt-2 z-50',
              direction === 'rtl' ? 'right-0' : 'right-0',
              'bg-white/95 backdrop-blur-md rounded-2xl border border-gray-200/80 shadow-xl',
              'min-w-[160px] py-2',
              'animate-in fade-in-0 zoom-in-95 duration-200'
            )}
            dir={direction}
          >
            {Object.entries(COLOR_PALETTES).map(([key]) => (
              <button
                key={key}
                role="menuitem"
                onClick={() => {
                  onPaletteChange(key as ColorPaletteName);
                  setIsOpen(false);
                }}
                className={cn(
                  'w-full px-4 py-3 text-start transition-all duration-200',
                  'hover:bg-gray-100/80 active:bg-gray-200/50',
                  'flex items-center gap-3 min-h-[44px]',
                  selectedPalette === key && 'bg-gray-100/60 font-semibold'
                )}
              >
                <div
                  aria-hidden="true"
                  className={cn(
                    'w-4 h-4 rounded-full flex-shrink-0',
                    key === 'feminine' &&
                      'bg-gradient-to-r from-rose-400 to-pink-500',
                    key === 'masculine' &&
                      'bg-gradient-to-r from-blue-500 to-cyan-600',
                    key === 'luxury' &&
                      'bg-gradient-to-r from-amber-400 to-yellow-500',
                    key === 'professional' &&
                      'bg-gradient-to-r from-gray-500 to-slate-600'
                  )}
                />
                <span
                  className={cn(
                    'text-gray-700 font-medium text-sm',
                    selectedPalette === key && 'text-gray-900 font-semibold'
                  )}
                >
                  {dict.palettes[key as keyof typeof dict.palettes]}
                </span>
                {selectedPalette === key && (
                  <>
                    <span className="sr-only">{dict.selected}</span>
                    <CheckCircle
                      aria-hidden="true"
                      className="w-4 h-4 text-green-600 ms-auto"
                    />
                  </>
                )}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  );
};

interface ProfileCardProps {
  profile: Omit<UserProfile, 'isProfileComplete'>;
  isProfileComplete: boolean;
  images?: UserImageType[];
  questionnaire?: QuestionnaireResponse | null;
  viewMode?: 'matchmaker' | 'candidate';
  className?: string;
  candidate?: Candidate;
  allCandidates?: Candidate[];
  onCreateSuggestion?: (data: CreateSuggestionData) => Promise<void>;
  onClose?: () => void;
  dict: ProfileCardDict;
  locale: string;
}

const ProfileHeader: React.FC<{
  profile: UserProfile;
  age: number;
  mainImageToDisplay: UserImageType | null;
  availability: ReturnType<typeof formatAvailabilityStatus>;
  viewMode: 'matchmaker' | 'candidate';
  onSuggestClick: () => void;
  isMobile?: boolean;
  selectedPalette: ColorPaletteName;
  onPaletteChange?: (palette: ColorPaletteName) => void;
  THEME: ThemeType;
  dict: ProfileCardDisplayDict;
  compact?: boolean;
  characterTraitMap: ReturnType<typeof createCharacterTraitMap>;
  hobbiesMap: ReturnType<typeof createHobbiesMap>;
  religiousLevelMap: ReturnType<typeof createReligiousLevelMap>;
  educationLevelMap: ReturnType<typeof createEducationLevelMap>;
  locale: string;
}> = ({
  profile,
  age,
  mainImageToDisplay,
  availability,
  viewMode,
  onSuggestClick,
  isMobile = false,
  selectedPalette,
  onPaletteChange,
  THEME,
  dict,
  compact = false,
  characterTraitMap,
  hobbiesMap,
  religiousLevelMap,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';
  console.log(
    `ProfileCard Loaded - Locale: ${locale}, Direction: ${direction}`
  );

  const personalityHighlights = useMemo(() => {
    const highlights: ExcitementFactor[] = [];
    if (profile.profileCharacterTraits?.length > 0) {
      const trait = profile.profileCharacterTraits[0];
      const traitData = formatEnumValue(
        trait,
        characterTraitMap,
        trait,
        isMobile
      );
      highlights.push({
        icon: traitData.icon,
        text: traitData.label,
        shortText: traitData.shortLabel || traitData.label,
        gradient: THEME.colors.primary.light,
      });
    }

    if (profile.profileHobbies?.length > 0) {
      const hobby = profile.profileHobbies[0];
      const hobbyData = formatEnumValue(hobby, hobbiesMap, hobby, isMobile);
      highlights.push({
        icon: hobbyData.icon,
        text: hobbyData.label,
        shortText: hobbyData.shortLabel || hobbyData.label,
        gradient: THEME.colors.secondary.sage,
      });
    }

    if (profile.city) {
      const cityText = `גר/ה ב${profile.city}`;
      highlights.push({
        icon: MapPin,
        text: cityText,
        shortText:
          isMobile && cityText.length > 15 ? `${profile.city}` : cityText,
        gradient: THEME.colors.secondary.sky,
      });
    }

    return highlights.slice(0, 3);
  }, [
    profile.profileCharacterTraits,
    profile.profileHobbies,
    profile.city,
    isMobile,
    THEME.colors.primary.light,
    THEME.colors.secondary.sage,
    THEME.colors.secondary.sky,
    characterTraitMap,
    hobbiesMap,
  ]);

  return (
    <div className="relative overflow-hidden">
      <div
        className={cn(
          'absolute inset-0 bg-gradient-to-br',
          THEME.colors.neutral.warm
        )}
      >
        <div
          className={cn(
            'absolute bg-gradient-to-br from-rose-200/40 to-pink-200/40 rounded-full blur-xl sm:blur-2xl animate-pulse',
            compact
              ? 'top-2 end-2 w-8 h-8 sm:w-16 sm:h-16'
              : 'top-4 end-4 sm:top-10 sm:end-10 w-16 h-16 sm:w-32 sm:h-32'
          )}
        ></div>
        <div
          className={cn(
            'absolute bg-gradient-to-br from-amber-200/40 to-orange-200/40 rounded-full blur-lg sm:blur-xl animate-pulse',
            compact
              ? 'bottom-2 start-2 w-6 h-6 sm:w-12 sm:h-12'
              : 'bottom-4 start-4 sm:bottom-10 sm:start-10 w-12 h-12 sm:w-24 sm:h-24'
          )}
          style={{ animationDelay: '1s' }}
        ></div>
        <div
          className={cn(
            'absolute bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-md sm:blur-lg animate-pulse',
            compact
              ? 'top-1/2 left-1/2 w-4 h-4 sm:w-8 sm:h-8'
              : 'top-1/2 left-1/2 w-8 h-8 sm:w-20 sm:h-20'
          )}
          style={{ animationDelay: '2s' }}
        ></div>
      </div>

      <div
        className={cn(
          'relative z-10',
          compact ? 'p-2 sm:p-3' : 'p-3 sm:p-4 md:p-6'
        )}
      >
        <div
          className={cn(
            'flex items-start',
            isMobile
              ? 'flex-col items-center text-center gap-3 sm:gap-4'
              : 'flex-row gap-4 sm:gap-6'
          )}
        >
          <div className="relative flex-shrink-0">
            <div
              className={cn(
                'relative rounded-full overflow-hidden border-2 sm:border-4 border-white shadow-lg sm:shadow-2xl ring-2 sm:ring-4 ring-rose-200/50 transition-all duration-300 hover:scale-105',
                compact
                  ? 'h-32 w-32 sm:h-36 sm:w-36 md:h-40 md:w-40'
                  : isMobile
                    ? 'h-36 w-36 sm:h-40 sm:w-40 md:h-44 md:w-44'
                    : 'h-20 w-20 sm:h-24 sm:w-24 md:h-32 md:w-32 lg:h-36 lg:w-36',
                THEME.shadows.elegant
              )}
            >
              {mainImageToDisplay?.url ? (
                <Image
                  src={getRelativeCloudinaryPath(mainImageToDisplay.url)}
                  alt={dict.header.profileImageAlt.replace(
                    '{{name}}',
                    `${profile.user?.firstName || ''} ${profile.user?.lastName || ''}`.trim()
                  )}
                  fill
                  className="object-cover transition-transform duration-700 hover:scale-110"
                  sizes={compact ? '160px' : isMobile ? '176px' : '144px'}
                  priority
                />
              ) : (
                <div
                  className={cn(
                    'w-full h-full flex items-center justify-center',
                    `bg-gradient-to-br ${THEME.colors.primary.romantic}`
                  )}
                >
                  <span
                    className={cn(
                      'font-bold text-white',
                      compact
                        ? 'text-xl sm:text-2xl'
                        : 'text-3xl sm:text-4xl lg:text-6xl'
                    )}
                  >
                    {getInitials(
                      profile.user?.firstName,
                      profile.user?.lastName,
                      compact ? 1 : 2
                    )}
                  </span>
                </div>
              )}
            </div>

            <div
              className={cn(
                'absolute transition-all duration-300',
                compact ? '-bottom-1 -end-1' : '-bottom-2 -end-2'
              )}
            >
              <Badge
                className={cn(
                  'font-bold text-white border-0 transition-all duration-300 hover:scale-110',
                  compact
                    ? 'text-xs px-2 py-1'
                    : 'text-xs sm:text-sm px-2 py-1 sm:px-3 sm:py-2',
                  isMobile
                    ? availability.bgColorSm || availability.bgColor
                    : availability.bgColor,
                  'animate-pulse',
                  THEME.shadows.warm
                )}
              >
                <availability.icon
                  className={cn(
                    'flex-shrink-0',
                    compact ? 'w-2 h-2 me-1' : 'w-3 h-3 me-1 sm:me-1.5'
                  )}
                />
                <span className={cn('break-words')}>
                  {isMobile && compact
                    ? availability.shortText || availability.text
                    : isMobile
                      ? availability.shortText || availability.text
                      : availability.text}
                </span>
              </Badge>
            </div>
          </div>

          <div className="flex-1 min-w-0 flex flex-col justify-start items-start w-full">
            {!isMobile && onPaletteChange && (
              <div className="flex justify-end mb-2 sm:mb-3 w-full">
                <ColorPaletteSelector
                  selectedPalette={selectedPalette}
                  onPaletteChange={onPaletteChange}
                  THEME={THEME}
                  dict={dict.colorPalette}
                  compact={compact}
                  direction={direction}
                />
              </div>
            )}
            <div
              className={cn(
                'w-full overflow-hidden',
                compact ? 'mb-2 sm:mb-3' : 'mb-3 sm:mb-4',
                isMobile && 'text-center'
              )}
            >
              <h1
                className={cn(
                  'font-extrabold leading-tight transition-all duration-300',
                  compact
                    ? 'text-sm sm:text-base md:text-lg'
                    : isMobile
                      ? 'text-lg sm:text-xl md:text-2xl'
                      : 'text-xl sm:text-2xl md:text-3xl lg:text-4xl',
                  'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere',
                  'text-center max-w-full overflow-hidden',
                  'px-1 sm:px-2',
                  `bg-gradient-to-r ${THEME.colors.primary.main} bg-clip-text text-transparent`,
                  `hover:bg-gradient-to-r hover:${THEME.colors.primary.accent} bg-clip-text`
                )}
              >
                {profile.user?.firstName
                  ? dict.header.storyOf.replace(
                      '{{name}}',
                      `${profile.user.firstName} ${profile.user.lastName || ''}`.trim()
                    )
                  : dict.placeholders.storyWaiting}
              </h1>

              {age > 0 && (
                <div
                  className={cn(
                    'flex items-center justify-center gap-1 sm:gap-2 flex-wrap',
                    isMobile ? 'justify-center' : 'lg:justify-start',
                    'mt-2 sm:mt-3'
                  )}
                >
                  <Cake
                    className={cn(
                      'text-blue-500 flex-shrink-0',
                      compact ? 'w-3 h-3' : 'w-4 h-4 sm:w-5 sm:h-5'
                    )}
                  />
                  <span
                    className={cn(
                      'font-semibold text-gray-700',
                      compact
                        ? 'text-xs sm:text-sm'
                        : 'text-sm sm:text-base md:text-lg'
                    )}
                  >
                    {dict.header.ageLabel.replace('{{age}}', age.toString())}
                  </span>
                </div>
              )}
            </div>
            {personalityHighlights.length > 0 && (
              <div
                className={cn(
                  'w-full overflow-hidden',
                  compact ? 'mt-2 mb-2' : 'mt-3 mb-4',
                  isMobile ? 'flex justify-center' : 'flex justify-start'
                )}
              >
                <ScrollArea className="w-full max-w-full" dir={direction}>
                  <div
                    className={cn(
                      'flex gap-2 sm:gap-3 pb-2 px-1 min-w-max',
                      isMobile && 'justify-center'
                    )}
                  >
                    {personalityHighlights.map((highlight, index) => (
                      <div
                        key={index}
                        className={cn(
                          'flex items-center bg-white/80 border border-gray-200/50 text-gray-700 font-semibold backdrop-blur-sm flex-shrink-0 transition-all duration-300 hover:scale-105 hover:bg-white/90',
                          compact
                            ? 'gap-1 px-2 py-1 rounded-full text-xs'
                            : 'gap-1.5 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-full text-xs sm:text-sm',
                          THEME.shadows.soft
                        )}
                      >
                        <highlight.icon
                          className={cn(
                            'flex-shrink-0',
                            compact ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4'
                          )}
                        />
                        <span className="whitespace-nowrap font-medium">
                          {isMobile && compact
                            ? highlight.shortText || highlight.text
                            : isMobile
                              ? highlight.shortText || highlight.text
                              : highlight.text}
                        </span>
                      </div>
                    ))}
                  </div>
                  <ScrollBar orientation="horizontal" />
                </ScrollArea>
              </div>
            )}
            <div
              className={cn(
                'w-full overflow-hidden',
                compact ? 'mt-2' : 'mt-4 sm:mt-6'
              )}
            >
              {isMobile ? (
                <div className="w-full max-w-full overflow-hidden px-1">
                  <ScrollArea className="w-full" dir={direction}>
                    <div
                      className={cn(
                        'flex gap-2 sm:gap-3 pb-2 px-1',
                        'justify-center min-w-max'
                      )}
                    >
                      {profile.occupation && (
                        <KeyFactCard
                          icon={Briefcase}
                          label={dict.keyFacts.occupation}
                          value={profile.occupation}
                          color="amber"
                          compact={compact}
                        />
                      )}
                      {(() => {
                        const religiousLevelData = profile.religiousLevel
                          ? formatEnumValue(
                              profile.religiousLevel,
                              religiousLevelMap,
                              '',
                              true
                            )
                          : null;
                        if (
                          religiousLevelData &&
                          religiousLevelData.shortLabel?.trim()
                        ) {
                          return (
                            <KeyFactCard
                              icon={BookMarked}
                              label={dict.keyFacts.outlook}
                              value={religiousLevelData.shortLabel}
                              color="purple"
                              compact={compact}
                            />
                          );
                        }
                        return null;
                      })()}
                    </div>
                    <ScrollBar orientation="horizontal" />
                  </ScrollArea>
                </div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                  {profile.city && (
                    <KeyFactCard
                      icon={MapPin}
                      label={dict.keyFacts.location}
                      value={profile.city}
                      color="rose"
                      compact={compact}
                    />
                  )}
                  {profile.occupation && (
                    <KeyFactCard
                      icon={Briefcase}
                      label={dict.keyFacts.occupation}
                      value={profile.occupation}
                      color="amber"
                      compact={compact}
                    />
                  )}
                  {(() => {
                    const religiousLevelData = profile.religiousLevel
                      ? formatEnumValue(
                          profile.religiousLevel,
                          religiousLevelMap,
                          ''
                        )
                      : null;
                    if (
                      religiousLevelData &&
                      religiousLevelData.label?.trim()
                    ) {
                      return (
                        <KeyFactCard
                          icon={BookMarked}
                          label={dict.keyFacts.outlook}
                          value={religiousLevelData.label}
                          color="purple"
                          compact={compact}
                        />
                      );
                    }
                    return null;
                  })()}
                </div>
              )}
            </div>
            {viewMode === 'matchmaker' && (
              <div
                className={cn(
                  'w-full flex',
                  compact ? 'pt-3' : 'pt-4 sm:pt-6',
                  isMobile ? 'justify-center' : 'justify-end'
                )}
              >
                <Button
                  size={compact ? 'default' : 'lg'}
                  className={cn(
                    `bg-gradient-to-r ${THEME.colors.primary.main} hover:${THEME.colors.primary.accent}`,
                    'text-white font-bold rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 active:scale-95',
                    compact
                      ? 'px-4 py-2 text-sm'
                      : 'px-6 sm:px-8 py-2 sm:py-3 text-sm sm:text-base',
                    'min-h-[44px]'
                  )}
                  onClick={onSuggestClick}
                >
                  <Heart
                    className={cn(
                      'flex-shrink-0',
                      compact ? 'w-4 h-4' : 'w-4 h-4 sm:w-5 sm:h-5',
                      direction === 'rtl' ? 'ml-1 sm:ml-2' : 'mr-1 sm:mr-2'
                    )}
                  />
                  <span className="break-words">
                    {compact
                      ? dict.header.suggestMatchButton
                      : dict.header.suggestPerfectMatchButton}
                  </span>
                  {direction === 'rtl' ? (
                    <ArrowLeft
                      className={cn(
                        'flex-shrink-0',
                        compact
                          ? 'w-4 h-4 mr-1'
                          : 'w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2'
                      )}
                    />
                  ) : (
                    <ArrowRight
                      className={cn(
                        'flex-shrink-0',
                        compact
                          ? 'w-4 h-4 ml-1'
                          : 'w-4 h-4 sm:w-5 sm:h-5 ml-1 sm:ml-2'
                      )}
                    />
                  )}
                </Button>
              </div>
            )}
          </div>
        </div>
        {!compact && (
          <div
            className={cn(
              'text-center w-full overflow-hidden',
              isMobile ? 'mt-3 px-2' : 'mt-6 sm:mt-8'
            )}
          >
            <div
              className={cn(
                'inline-flex items-center justify-center rounded-full text-white shadow-lg max-w-full transition-all duration-300 hover:scale-105',
                isMobile
                  ? 'gap-1.5 px-3 py-2 text-sm flex-wrap'
                  : 'gap-2 px-4 py-3 text-base',
                `bg-gradient-to-r ${THEME.colors.primary.romantic}`
              )}
            >
              <Quote
                aria-hidden="true"
                className={cn(
                  'flex-shrink-0',
                  isMobile ? 'w-3 h-3' : 'w-4 h-4'
                )}
              />
              <p className="font-medium italic text-center break-words flex-shrink min-w-0">
                {dict.header.excitementQuote}
              </p>
              <Quote
                aria-hidden="true"
                className={cn(
                  'transform rotate-180 flex-shrink-0',
                  isMobile ? 'w-3 h-3' : 'w-4 h-4'
                )}
              />
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const KeyFactCard: React.FC<{
  icon: React.ElementType;
  label: string;
  value: string;
  color: 'rose' | 'amber' | 'purple';
  compact?: boolean;
}> = ({ icon: Icon, label, value, color, compact = false }) => {
  const colorClasses = {
    rose: 'border-rose-200/50 hover:border-rose-300',
    amber: 'border-amber-200/50 hover:border-amber-300',
    purple: 'border-purple-200/50 hover:border-purple-300',
  };

  const iconColors = {
    rose: 'text-rose-500',
    amber: 'text-amber-600',
    purple: 'text-purple-600',
  };

  return (
    <div
      className={cn(
        'flex items-center bg-white/80 backdrop-blur-sm rounded-xl border shadow-sm hover:shadow-md transition-all duration-300 flex-shrink-0',
        compact
          ? 'gap-2 p-2 min-w-[100px] max-w-[120px]'
          : 'gap-2 sm:gap-3 p-2 sm:p-3 min-w-[120px] max-w-[140px] sm:min-w-[140px] sm:max-w-[160px]',
        colorClasses[color],
        'max-w-[calc((100vw-4rem)/3)]'
      )}
    >
      <Icon
        aria-hidden="true"
        className={cn(
          'flex-shrink-0',
          compact ? 'w-4 h-4' : 'w-4 h-4 sm:w-5 sm:h-5',
          iconColors[color]
        )}
      />
      <div className="min-w-0 flex-1 overflow-hidden">
        <p
          className={cn(
            'font-medium text-gray-500 leading-tight',
            compact ? 'text-xs' : 'text-xs sm:text-sm'
          )}
        >
          {label}
        </p>
        <p
          className={cn(
            'font-semibold text-gray-800 break-words overflow-wrap-anywhere word-break-break-word leading-tight',
            compact ? 'text-xs' : 'text-xs sm:text-sm'
          )}
        >
          {value}
        </p>
      </div>
    </div>
  );
};

const MobileImageGallery: React.FC<{
  orderedImages: UserImageType[];
  profile: UserProfile;
  onImageClick: (image: UserImageType) => void;
  THEME: ThemeType;
  dict: ProfileCardDisplayDict['gallery'];
  compact?: boolean;
  direction: 'ltr' | 'rtl';
}> = ({
  orderedImages,
  profile,
  onImageClick,
  THEME,
  dict,
  compact = false,
  direction,
}) => {
  if (orderedImages.length === 0) return null;

  return (
    <div
      className={cn(
        'overflow-hidden',
        compact ? 'px-2 pt-2 pb-2' : 'px-3 sm:px-4 pt-3 sm:pt-4 pb-2 sm:pb-3',
        `bg-gradient-to-r ${THEME.colors.neutral.warm}`
      )}
    >
      <div
        className={cn(
          'text-center overflow-hidden',
          compact ? 'mb-2' : 'mb-3 sm:mb-4'
        )}
      >
        <h3
          className={cn(
            'font-bold text-gray-800 flex items-center justify-center gap-1.5 sm:gap-2',
            compact ? 'text-sm mb-1' : 'text-base sm:text-lg mb-1 sm:mb-2'
          )}
        >
          <Camera
            aria-label={dict.title || 'תמונות'}
            className={cn(
              'text-white',
              'flex-shrink-0',
              compact ? 'w-4 h-4' : 'w-4 h-4 sm:w-5 sm:h-5'
            )}
          />
          <span className="break-words min-w-0">
            {dict.title.replace(
              '{{name}}',
              profile.user?.firstName || 'המועמד'
            )}
          </span>
        </h3>
        <p
          className={cn(
            'text-gray-600',
            compact ? 'text-xs' : 'text-xs sm:text-sm'
          )}
        >
          {dict.subtitle}
        </p>
      </div>
      <ScrollArea dir={direction} className="w-full overflow-hidden">
        <div
          className={cn(
            'flex pb-2 sm:pb-3',
            compact ? 'gap-2' : 'gap-2 sm:gap-3 md:gap-4',
            'justify-center min-w-full'
          )}
        >
          {orderedImages.map((image, idx) => (
            <button
              key={image.id}
              type="button"
              aria-label={dict.showImageAlt.replace(
                '{{index}}',
                (idx + 1).toString()
              )}
              className={cn(
                'relative flex-shrink-0 rounded-xl sm:rounded-2xl overflow-hidden cursor-pointer group transition-all duration-300 hover:scale-105 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-rose-500',
                orderedImages.length <= 3
                  ? compact
                    ? 'w-20 h-24 border-2'
                    : 'w-24 h-32 sm:w-28 sm:h-36 border-2 sm:border-3'
                  : compact
                    ? 'w-16 h-20 border-2'
                    : 'w-20 h-26 sm:w-22 sm:h-30 border-2 sm:border-3',
                'border-white shadow-md hover:shadow-lg sm:shadow-lg sm:hover:shadow-xl',
                'max-w-[calc((100vw-3rem)/5)]'
              )}
              onClick={() => onImageClick(image)}
            >
              <Image
                src={getRelativeCloudinaryPath(image.url)}
                alt={dict.imageAlt.replace('{{index}}', (idx + 1).toString())}
                fill
                className="object-cover transition-transform duration-500 group-hover:scale-110"
                sizes={
                  orderedImages.length <= 3
                    ? compact
                      ? '80px'
                      : '112px'
                    : compact
                      ? '64px'
                      : '88px'
                }
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              {image.isMain && (
                <Badge
                  className={cn(
                    'absolute font-bold',
                    compact
                      ? 'top-0.5 end-0.5 text-xs px-1 py-0.5 gap-0.5'
                      : 'top-1 end-1 text-xs px-1.5 py-0.5 gap-1',
                    'bg-gradient-to-r from-yellow-400 to-amber-500 text-black shadow-sm',
                    THEME.shadows.warm
                  )}
                >
                  <Star
                    className={cn(
                      'fill-current',
                      compact ? 'w-2 h-2' : 'w-2 h-2 sm:w-2.5 sm:h-2.5'
                    )}
                  />
                  {!compact && <span>{dict.mainBadge}</span>}
                </Badge>
              )}
            </button>
          ))}
        </div>
        <ScrollBar orientation="horizontal" className="mt-1" />
      </ScrollArea>
    </div>
  );
};

const ImageDialogComponent: React.FC<{
  selectedImageForDialog: UserImageType | null;
  currentDialogImageIndex: number;
  orderedImages: UserImageType[];
  onClose: () => void;
  onNavigate: (direction: 'next' | 'prev') => void;
  onImageSelect: (image: UserImageType) => void;
  dict: ProfileCardDisplayDict['imageDialog'];
  THEME: ThemeType;
  direction: 'ltr' | 'rtl';
}> = ({
  selectedImageForDialog,
  currentDialogImageIndex,
  orderedImages,
  onClose,
  onNavigate,
  onImageSelect,
  dict,
  THEME,
  direction,
}) => {
  if (!selectedImageForDialog) return null;
  const PrevIcon = direction === 'rtl' ? ChevronRight : ChevronLeft;
  const NextIcon = direction === 'rtl' ? ChevronLeft : ChevronRight;

  return (
    <Dialog
      open={!!selectedImageForDialog}
      onOpenChange={(isOpen) => !isOpen && onClose()}
    >
      <DialogContent
        className={cn(
          'max-w-5xl w-[95vw] h-[90vh] p-0 border-none rounded-2xl flex flex-col',
          'bg-black/95 backdrop-blur-md'
        )}
        dir={direction}
      >
        <DialogHeader
          className={cn(
            'p-3 sm:p-4 text-white flex-row justify-between items-center border-b border-gray-700/50',
            'bg-black/80 backdrop-blur-sm'
          )}
        >
          <DialogTitle
            className={cn(
              'font-bold flex items-center gap-2',
              'text-base sm:text-lg'
            )}
          >
            <Camera className="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" />
            <span className="break-words">
              {dict.title
                .replace(
                  '{{current}}',
                  (currentDialogImageIndex + 1).toString()
                )
                .replace('{{total}}', orderedImages.length.toString())}
            </span>
          </DialogTitle>
          <DialogClose asChild>
            <Button
              variant="ghost"
              size="icon"
              aria-label={dict.closeLabel}
              className={cn(
                'text-gray-300 hover:text-white hover:bg-white/10 rounded-full transition-all',
                'w-8 h-8 sm:w-10 sm:h-10 min-h-[44px] min-w-[44px]'
              )}
            >
              <X className="w-4 h-4 sm:w-5 sm:h-5" />
            </Button>
          </DialogClose>
        </DialogHeader>

        <div className="relative flex-1 w-full min-h-0 overflow-hidden">
          <Image
            key={selectedImageForDialog.id}
            src={getRelativeCloudinaryPath(selectedImageForDialog.url)}
            alt={`תמונה מוגדלת ${currentDialogImageIndex + 1}`}
            fill
            className="object-contain"
            sizes="90vw"
            priority
          />

          {orderedImages.length > 1 && (
            <>
              <Button
                variant="ghost"
                aria-label={dict.prevLabel}
                className={cn(
                  'absolute top-1/2 -translate-y-1/2 rounded-full',
                  direction === 'rtl' ? 'right-4' : 'left-4',
                  `bg-gradient-to-r ${THEME.colors.primary.accent} hover:opacity-90 text-white border-0`,
                  'backdrop-blur-sm transition-all hover:scale-110 active:scale-95',
                  'w-12 h-12 sm:w-14 sm:h-14 min-h-[44px] min-w-[44px]'
                )}
                onClick={() => onNavigate('prev')}
              >
                <PrevIcon className="h-5 w-5 sm:h-6 sm:w-6" />
              </Button>
              <Button
                variant="ghost"
                aria-label={dict.nextLabel}
                className={cn(
                  'absolute top-1/2 -translate-y-1/2 rounded-full',
                  direction === 'rtl' ? 'left-4' : 'right-4',
                  `bg-gradient-to-r ${THEME.colors.primary.accent} hover:opacity-90 text-white border-0`,
                  'backdrop-blur-sm transition-all hover:scale-110 active:scale-95',
                  'w-12 h-12 sm:w-14 sm:h-14 min-h-[44px] min-w-[44px]'
                )}
                onClick={() => onNavigate('next')}
              >
                <NextIcon className="h-5 w-5 sm:h-6 sm:w-6" />
              </Button>
            </>
          )}
        </div>

        {orderedImages.length > 1 && (
          <DialogFooter className="border-t border-gray-700/50 bg-black/80 backdrop-blur-sm p-0">
            <ScrollArea dir={direction} className="w-full">
              <div className="flex gap-2 p-3 justify-center min-w-max">
                {orderedImages.map((img) => (
                  <div
                    key={img.id}
                    className={cn(
                      'relative flex-shrink-0 w-12 h-12 sm:w-16 sm:h-16 rounded-lg overflow-hidden cursor-pointer transition-all hover:scale-105',
                      'border-2',
                      img.id === selectedImageForDialog.id
                        ? 'border-rose-400 ring-2 ring-rose-400/50'
                        : 'border-white/20 opacity-60 hover:opacity-100 hover:border-white/40'
                    )}
                    onClick={() => onImageSelect(img)}
                  >
                    <Image
                      src={getRelativeCloudinaryPath(img.url)}
                      alt={dict.thumbAlt}
                      fill
                      className="object-cover"
                      sizes="64px"
                    />
                  </div>
                ))}
              </div>
              <ScrollBar orientation="horizontal" />
            </ScrollArea>
          </DialogFooter>
        )}
      </DialogContent>
    </Dialog>
  );
};

const TabNavigationButtons: React.FC<{
  activeTab: string;
  tabItems: {
    value: string;
    label: string;
    shortLabel?: string;
    icon: React.ElementType;
    gradient: string;
  }[];
  onTabChange: (newTab: string) => void;
  THEME: ThemeType;
  dict: ProfileCardDisplayDict['mobileNav'];
  direction: 'ltr' | 'rtl';
}> = ({ activeTab, tabItems, onTabChange, THEME, dict, direction }) => {
  const currentIndex = useMemo(
    () => tabItems.findIndex((tab) => tab.value === activeTab),
    [tabItems, activeTab]
  );

  const prevTab = useMemo(
    () => (currentIndex > 0 ? tabItems[currentIndex - 1] : null),
    [tabItems, currentIndex]
  );
  const nextTab = useMemo(
    () =>
      currentIndex < tabItems.length - 1 ? tabItems[currentIndex + 1] : null,
    [tabItems, currentIndex]
  );

  if (!prevTab && !nextTab) {
    return null;
  }

  const baseButtonClasses =
    'flex-1 flex flex-col p-4 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2';

  const PrevIcon = direction === 'rtl' ? ChevronRight : ChevronLeft;
  const NextIcon = direction === 'rtl' ? ChevronLeft : ChevronRight;

  return (
    <div
      className={cn(
        'mt-8 pt-6 border-t border-gray-200/80 flex items-stretch justify-between gap-3 sm:gap-4 w-full',
        direction === 'rtl' && 'flex-row-reverse'
      )}
    >
      {' '}
      {prevTab ? (
        <button
          className={cn(
            baseButtonClasses,
            'items-start text-start',
            'bg-white border border-gray-200/80 hover:border-gray-300',
            'focus-visible:ring-gray-400'
          )}
          onClick={() => onTabChange(prevTab.value)}
        >
          <div className="flex items-center gap-2">
            <PrevIcon className="w-6 h-6 text-gray-400 flex-shrink-0" />
            <p className="text-xs font-medium text-gray-500">{dict.previous}</p>
          </div>
          <div className="flex items-center gap-2 mt-1.5">
            <prevTab.icon className="w-5 h-5 text-gray-600 flex-shrink-0" />
            <span className="text-base font-bold text-gray-800 text-start break-words min-w-0">
              {prevTab.label}
            </span>
          </div>
        </button>
      ) : (
        <div className="flex-1" />
      )}
      {nextTab ? (
        <button
          className={cn(
            baseButtonClasses,
            'items-end text-end',
            `bg-gradient-to-r ${THEME.colors.primary.main} hover:${THEME.colors.primary.accent}`,
            'text-white',
            'focus-visible:ring-rose-500' // TODO: Make this dynamic
          )}
          onClick={() => onTabChange(nextTab.value)}
        >
          <div className="flex items-center gap-2 justify-end">
            <p className="text-xs font-medium text-white/90">{dict.next}</p>
            <NextIcon className="w-6 h-6 text-white flex-shrink-0" />
          </div>
          <div className="flex items-center justify-end gap-2 mt-1.5">
            <span className="text-base font-bold text-white text-end break-words min-w-0">
              {nextTab.label}
            </span>
            <nextTab.icon className="w-5 h-5 text-white flex-shrink-0" />
          </div>
        </button>
      ) : (
        <div className="flex-1" />
      )}
    </div>
  );
};

// Main ProfileCard Component
const ProfileCard: React.FC<ProfileCardProps> = ({
  profile: profileData,
  isProfileComplete,
  images = [],
  questionnaire,
  viewMode = 'candidate',
  className,
  onCreateSuggestion,
  onClose,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const contentScrollAreaRef = useRef<HTMLDivElement>(null);

  const profile = useMemo(
    () => ({
      ...profileData,
      isProfileComplete,
    }),
    [profileData, isProfileComplete]
  );

  const displayDict = dict.display;

  const [isClient, setIsClient] = useState(false);
  const [isDesktop, setIsDesktop] = useState(true);
  const [selectedImageForDialog, setSelectedImageForDialog] =
    useState<UserImageType | null>(null);
  const [activeTab, setActiveTab] = useState('essence');
  const [, setIsSuggestDialogOpen] = useState(false);
  const [mobileViewLayout, setMobileViewLayout] = useState<
    'focus' | 'detailed'
  >('focus');
  const [selectedPalette, setSelectedPalette] = useState<ColorPaletteName>(
    () => {
      return profile.gender === 'MALE' ? 'masculine' : 'feminine';
    }
  );

  const maritalStatusMap = useMemo(
    () => createMaritalStatusMap(dict.options.maritalStatus),
    [dict.options.maritalStatus]
  );
  const religiousLevelMap = useMemo(
    () => createReligiousLevelMap(dict.options.religiousLevel),
    [dict.options.religiousLevel]
  );
  const religiousJourneyMap = useMemo(
    () => createReligiousJourneyMap(dict.options.religiousJourney),
    [dict.options.religiousJourney]
  );
  const educationLevelMap = useMemo(
    () => createEducationLevelMap(dict.options.educationLevel),
    [dict.options.educationLevel]
  );
  const serviceTypeMap = useMemo(
    () =>
      createServiceTypeMap(
        dict.options.serviceType as Record<ServiceType, string>
      ),
    [dict.options.serviceType]
  );
  const headCoveringMap = useMemo(
    () =>
      createHeadCoveringMap(
        dict.options.headCovering as Record<HeadCoveringType, string>
      ),
    [dict.options.headCovering]
  );
  const kippahTypeMap = useMemo(
    () =>
      createKippahTypeMap(
        dict.options.kippahType as Record<KippahType, string>
      ),
    [dict.options.kippahType]
  );
  const contactPreferenceMap = useMemo(() => createContactPreferenceMap(), []);
  const characterTraitMap = useMemo(
    () => createCharacterTraitMap(dict.options.traits),
    [dict.options.traits]
  );
  const hobbiesMap = useMemo(
    () => createHobbiesMap(dict.options.hobbies),
    [dict.options.hobbies]
  );

  const activeTabRef = useRef(activeTab);

  useEffect(() => {
    activeTabRef.current = activeTab;
  }, [activeTab]);

  // גלילה אוטומטית לראש כשמשנים טאב
  useEffect(() => {
    // השהיה קטנה כדי לתת לטאב להירנדר
    const timer = setTimeout(() => {
      // מחשב - גלילה בתוך ה-ScrollArea של התוכן
      const scrollViewport = contentScrollAreaRef.current?.querySelector(
        '[data-radix-scroll-area-viewport]'
      );
      if (scrollViewport) {
        scrollViewport.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // מובייל - גלילה גם בחלון הראשי
      const mainContainer = document.querySelector(
        '#profile-card-tabs-content [data-radix-scroll-area-viewport]'
      );
      if (mainContainer) {
        mainContainer.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // fallback - אם יש scroll ברמת המסמך
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 50); // 50ms השהיה

    return () => clearTimeout(timer);
  }, [activeTab]); // רץ כל פעם שמשנים טאב

  // פונקציה פשוטה לשינוי טאב
  const handleTabChange = (newTab: string) => {
    if (activeTabRef.current === newTab) return;
    setActiveTab(newTab);
  };

  const THEME = useMemo(
    () => COLOR_PALETTES[selectedPalette],
    [selectedPalette]
  );

  const WORLDS: {
    [key: string]: {
      label: string;
      shortLabel?: string;
      icon: React.ElementType;
      gradient: string;
      description: string;
      accentColor: string;
    };
  } = useMemo(
    () => ({
      values: {
        ...displayDict.content.worlds.values,
        shortLabel: displayDict.tabs.journey.shortLabel,
        icon: BookMarked,
        gradient: THEME.colors.primary.accent,
        accentColor: 'blue',
      },
      personality: {
        ...displayDict.content.worlds.personality,
        shortLabel: displayDict.tabs.essence.shortLabel,
        icon: Sparkles,
        gradient: THEME.colors.primary.light,
        accentColor: 'purple',
      },
      relationship: {
        ...displayDict.content.worlds.relationship,
        shortLabel: displayDict.tabs.vision.shortLabel,
        icon: Heart,
        gradient: THEME.colors.primary.main,
        accentColor: 'rose',
      },
      partner: {
        ...displayDict.content.worlds.partner,
        shortLabel: displayDict.tabs.connection.shortLabel,
        icon: Users,
        gradient: THEME.colors.secondary.sky,
        accentColor: 'blue',
      },
      religion: {
        ...displayDict.content.worlds.religion,
        shortLabel: displayDict.tabs.spirit.shortLabel,
        icon: Star,
        gradient: THEME.colors.secondary.peach,
        accentColor: 'amber',
      },
      general: {
        ...displayDict.content.worlds.general,
        shortLabel: 'עוד',
        icon: FileText,
        gradient: THEME.colors.secondary.lavender,
        accentColor: 'purple',
      },
    }),
    [THEME, displayDict]
  );

  const hasAnyPreferences = useMemo(() => {
    return (
      (profile.preferredMaritalStatuses &&
        profile.preferredMaritalStatuses.length > 0) ||
      (profile.preferredReligiousLevels &&
        profile.preferredReligiousLevels.length > 0) ||
      (profile.preferredReligiousJourneys &&
        profile.preferredReligiousJourneys.length > 0) ||
      (profile.preferredEducation && profile.preferredEducation.length > 0) ||
      (profile.preferredOccupations &&
        profile.preferredOccupations.length > 0) ||
      (profile.preferredLocations && profile.preferredLocations.length > 0) ||
      (profile.preferredCharacterTraits &&
        profile.preferredCharacterTraits.length > 0) ||
      (profile.preferredHobbies && profile.preferredHobbies.length > 0)
    );
  }, [profile]);
  const hasEducationAndCareerDetails = useMemo(() => {
    return (
      !!profile.educationLevel ||
      !!profile.education ||
      !!profile.occupation ||
      !!profile.serviceType ||
      !!profile.serviceDetails
    );
  }, [
    profile.educationLevel,
    profile.education,
    profile.occupation,
    profile.serviceType,
    profile.serviceDetails,
  ]);

  const hasFamilyBackgroundDetails = useMemo(() => {
    return (
      !!profile.parentStatus ||
      !!profile.fatherOccupation ||
      !!profile.motherOccupation ||
      (profile.siblings !== null && profile.siblings !== undefined) ||
      !!profile.position ||
      !!profile.aliyaCountry ||
      !!profile.aliyaYear
    );
  }, [
    profile.parentStatus,
    profile.fatherOccupation,
    profile.motherOccupation,
    profile.siblings,
    profile.position,
    profile.aliyaCountry,
    profile.aliyaYear,
  ]);
  const hasUniqueTraitsOrHobbies = useMemo(() => {
    return (
      (profile.profileCharacterTraits &&
        profile.profileCharacterTraits.length > 0) ||
      (profile.profileHobbies && profile.profileHobbies.length > 0)
    );
  }, [profile.profileCharacterTraits, profile.profileHobbies]);

  const hasJudaismConnectionDetails = useMemo(() => {
    return (
      !!profile.religiousLevel ||
      !!profile.religiousJourney ||
      (profile.shomerNegiah !== null && profile.shomerNegiah !== undefined) ||
      (profile.gender === 'FEMALE' && !!profile.headCovering) ||
      (profile.gender === 'MALE' && !!profile.kippahType)
    );
  }, [
    profile.religiousLevel,
    profile.religiousJourney,
    profile.shomerNegiah,
    profile.gender,
    profile.headCovering,
    profile.kippahType,
  ]);

  const orderedImages = useMemo(() => {
    const validImages = (images || []).filter((img) => img.url);
    const mainImg = validImages.find((img) => img.isMain);
    const otherImages = validImages.filter((img) => !img.isMain);
    return mainImg ? [mainImg, ...otherImages] : validImages;
  }, [images]);

  const mainImageToDisplay = useMemo(
    () => (orderedImages.length > 0 ? orderedImages[0] : null),
    [orderedImages]
  );
  const age = useMemo(
    () => calculateAge(profile.birthDate),
    [profile.birthDate]
  );

  const availability = useMemo(
    () =>
      formatAvailabilityStatus(
        profile.availabilityStatus,
        THEME,
        {
          ...displayDict.availability,
          mysterious: displayDict.placeholders.mysterious,
        },
        displayDict.header.availabilityBadge
      ),
    [profile.availabilityStatus, THEME, displayDict]
  );

  // Helper function to check if an answer has actual content
  const isRawValueAnswered = (value: FormattedAnswer['rawValue']): boolean => {
    if (value === null || value === undefined) return false;
    if (typeof value === 'string' && value.trim() === '') return false;
    if (Array.isArray(value) && value.length === 0) return false;
    if (
      typeof value === 'object' &&
      !Array.isArray(value) &&
      Object.keys(value).length === 0
    )
      return false;
    return true;
  };

  // הקוד המתוקן
  const getVisibleAnswers = useCallback(
    (world: WorldId) => {
      // <-- שימוש בטיפוס המתוקן שלנו
      // ניגשים ישירות למפתח הנכון, ללא המרות מיותרות
      if (!questionnaire?.formattedAnswers?.[world]) return [];

      return questionnaire.formattedAnswers[world].filter((a) => {
        const hasContent = isRawValueAnswered(a.rawValue);
        if (!hasContent) return false;
        if (viewMode === 'matchmaker') return true;
        return a.isVisible !== false;
      });
    },
    [questionnaire, viewMode]
  );

  const personalityAnswers = useMemo(
    () => getVisibleAnswers('PERSONALITY'),
    [getVisibleAnswers]
  );
  const valuesAnswers = useMemo(
    () => getVisibleAnswers('VALUES'),
    [getVisibleAnswers]
  );
  const relationshipAnswers = useMemo(
    () => getVisibleAnswers('RELATIONSHIP'),
    [getVisibleAnswers]
  );
  const partnerAnswers = useMemo(
    () => getVisibleAnswers('PARTNER'),
    [getVisibleAnswers]
  );
  const religionAnswers = useMemo(
    () => getVisibleAnswers('RELIGION'),
    [getVisibleAnswers]
  );

  const hasDisplayableQuestionnaireAnswers = useMemo(
    () =>
      [
        ...personalityAnswers,
        ...valuesAnswers,
        ...relationshipAnswers,
        ...partnerAnswers,
        ...religionAnswers,
      ].length > 0,
    [
      personalityAnswers,
      valuesAnswers,
      relationshipAnswers,
      partnerAnswers,
      religionAnswers,
    ]
  );

  const currentDialogImageIndex = useMemo(
    () =>
      selectedImageForDialog
        ? orderedImages.findIndex((img) => img.id === selectedImageForDialog.id)
        : -1,
    [selectedImageForDialog, orderedImages]
  );

  const handleOpenImageDialog = (image: UserImageType) =>
    image.url && setSelectedImageForDialog(image);
  const handleCloseImageDialog = () => setSelectedImageForDialog(null);

  const handleDialogNav = (navDirection: 'next' | 'prev') => {
    if (currentDialogImageIndex === -1 || orderedImages.length <= 1) return;
    const newIndex =
      (currentDialogImageIndex +
        (navDirection === 'next' ? 1 : -1) +
        orderedImages.length) %
      orderedImages.length;
    setSelectedImageForDialog(orderedImages[newIndex]);
  };

  const handleClose = () => {
    if (onClose) {
      onClose();
    }
  };

  const tabItems = useMemo(
    () =>
      [
        {
          value: 'essence',
          label: displayDict.tabs.essence.label,
          shortLabel: displayDict.tabs.essence.shortLabel,
          icon: Sparkles,
          gradient: THEME.colors.primary.light,
          hasContent:
            !!profile.profileHeadline ||
            !!profile.about ||
            (profile.isFriendsSectionVisible &&
              (profile.testimonials || []).filter(
                (t) => t.status === 'APPROVED'
              ).length > 0) || // <-- תוכן שהועבר
            personalityAnswers.length > 0 ||
            (profile.profileCharacterTraits &&
              profile.profileCharacterTraits.length > 0) ||
            (profile.profileHobbies && profile.profileHobbies.length > 0),
        },
        {
          value: 'journey',
          label: displayDict.tabs.journey.label,
          shortLabel: displayDict.tabs.journey.shortLabel,
          icon: Compass,
          gradient: THEME.colors.primary.accent,
          hasContent:
            valuesAnswers.length > 0 ||
            !!profile.educationLevel ||
            !!profile.occupation ||
            !!profile.serviceType ||
            !!profile.parentStatus,
        },
        {
          value: 'spirit',
          label: displayDict.tabs.spirit.label,
          shortLabel: displayDict.tabs.spirit.shortLabel,
          icon: Star,
          gradient: THEME.colors.secondary.peach,
          hasContent:
            religionAnswers.length > 0 ||
            !!profile.religiousLevel ||
            !!profile.religiousJourney ||
            !!profile.influentialRabbi, // <-- תוכן שהועבר
        },
        {
          value: 'vision',
          label: displayDict.tabs.vision.label,
          shortLabel: displayDict.tabs.vision.shortLabel,
          icon: Heart,
          gradient: THEME.colors.primary.main,
          hasContent:
            relationshipAnswers.length > 0 ||
            !!profile.matchingNotes?.trim() ||
            !!profile.inspiringCoupleStory?.trim(), // <-- תוכן שהועבר
        },
        {
          value: 'connection',
          label: displayDict.tabs.connection.label,
          shortLabel: displayDict.tabs.connection.shortLabel,
          icon: Target,
          gradient: THEME.colors.secondary.sky,
          hasContent: hasAnyPreferences || partnerAnswers.length > 0,
        },
        viewMode === 'matchmaker' && {
          value: 'professional',
          label: displayDict.tabs.professional.label,
          shortLabel: displayDict.tabs.professional.shortLabel,
          icon: Lock,
          gradient: THEME.colors.secondary.lavender,
          hasContent: true,
        },
      ].filter(Boolean) as {
        value: string;
        label: string;
        shortLabel?: string;
        icon: React.ElementType;
        gradient: string;
        hasContent: boolean;
      }[],
    [
      THEME,
      profile,
      hasAnyPreferences,
      viewMode,
      personalityAnswers,
      valuesAnswers,
      relationshipAnswers,
      partnerAnswers,
      religionAnswers,
      displayDict,
    ]
  );

  const renderPreferenceBadges = (
    title: string,
    icon: React.ElementType,
    values: string[] | undefined,
    translationMap: {
      [key: string]: {
        label: string;
        shortLabel?: string;
        icon: React.ElementType;
        color: string;
      };
    },
    gradientClass: string = THEME.colors.secondary.sky,
    compact: boolean = false
  ) => {
    if (!values || values.length === 0) {
      return null;
    }

    const IconComponent = icon;
    return (
      <div className="space-y-3 sm:space-y-4 min-w-0 max-w-full overflow-hidden">
        <div className="flex items-center gap-2 sm:gap-3 min-w-0">
          <div
            className={cn(
              'flex-shrink-0 rounded-lg',
              compact ? 'p-1.5' : 'p-1.5 sm:p-2',
              `bg-gradient-to-r ${gradientClass}`
            )}
          >
            <IconComponent
              className={cn(
                'text-white',
                compact ? 'w-4 h-4' : 'w-4 h-4 sm:w-5 sm:h-5'
              )}
            />
          </div>
          <h4
            className={cn(
              'font-bold text-gray-800 break-words hyphens-auto word-break-break-word min-w-0 flex-1 overflow-wrap-anywhere',
              compact ? 'text-sm' : 'text-sm sm:text-base'
            )}
          >
            {title}
          </h4>
        </div>
        <div className="flex flex-wrap gap-2 sm:gap-3 min-w-0 max-w-full">
          {values.map((val) => {
            const itemData = translationMap[val] || {
              label: val,
              shortLabel: val.length > 12 ? val.substring(0, 12) + '...' : val,
              icon: Sparkles,
              color: 'text-gray-600',
            };
            return (
              <Badge
                key={val}
                variant="outline"
                className={cn(
                  'flex items-center font-semibold border-2 min-w-0 max-w-full transition-all hover:scale-105 active:scale-95',
                  compact
                    ? 'gap-1 px-2 py-1 text-xs'
                    : 'gap-1 sm:gap-2 px-2 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm',
                  'bg-white hover:bg-gray-50 border-gray-200 hover:border-rose-300',
                  THEME.shadows.soft,
                  'break-words hyphens-auto word-break-break-word overflow-wrap-anywhere'
                )}
              >
                <itemData.icon
                  className={cn(
                    'flex-shrink-0',
                    compact ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4',
                    itemData.color
                  )}
                />
                <span className="break-words overflow-hidden min-w-0">
                  {compact && itemData.shortLabel
                    ? itemData.shortLabel
                    : itemData.label}
                </span>
              </Badge>
            );
          })}
        </div>
      </div>
    );
  };

  const QuestionnaireItem: React.FC<{
    answer: FormattedAnswer;
    worldName: string;
    worldColor?: string;
    worldGradient?: string;
    compact?: boolean;
    direction: 'ltr' | 'rtl';
  }> = ({
    answer,
    worldName,
    worldColor = 'rose',
    worldGradient,
    compact = false,
    direction,
  }) => {
    return (
      <div
        className={cn(
          'rounded-xl border transition-all duration-300 hover:shadow-lg overflow-hidden',
          compact ? 'p-3 sm:p-4' : 'p-4 sm:p-5',
          'bg-gradient-to-br from-white to-gray-50/30 max-w-full min-w-0',
          `border-${worldColor}-200 hover:border-${worldColor}-300`
        )}
      >
        <div className="flex items-start gap-3 sm:gap-4 min-w-0">
          <div
            className={cn(
              'flex-shrink-0 rounded-lg text-white shadow-md',
              compact ? 'p-2' : 'p-2 sm:p-3',
              worldGradient
                ? `bg-gradient-to-r ${worldGradient}`
                : `bg-gradient-to-r from-${worldColor}-400 to-${worldColor}-500`
            )}
          >
            <Quote
              className={cn(compact ? 'w-4 h-4' : 'w-4 h-4 sm:w-5 sm:h-5')}
            />
          </div>
          <div className="flex-1 min-w-0 overflow-hidden">
            <h4
              dir="auto"
              className={cn(
                'font-bold mb-2 sm:mb-3 text-gray-800 leading-relaxed',
                'flex items-center justify-between gap-2 text-start',
                compact ? 'text-sm' : 'text-sm sm:text-base'
              )}
            >
              <span className="flex-1 break-words ...">
                <span className="sr-only">
                  {displayDict.content.questionnaire.questionFromCategory.replace(
                    '{{worldName}}',
                    worldName
                  )}{' '}
                </span>
                {answer.question}
              </span>
              {answer.isVisible === false && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <div className="flex-shrink-0 flex items-center gap-1 bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs cursor-default">
                        <Lock className="w-3 h-3" />
                        <span>
                          {displayDict.content.questionnaire.confidential}
                        </span>
                      </div>
                    </TooltipTrigger>
                    <TooltipContent side="top">
                      <p>
                        {displayDict.content.questionnaire.confidentialTooltip}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}
            </h4>
            <div
              className={cn(
                'rounded-lg bg-white/60 overflow-hidden',
                compact ? 'p-3' : 'p-3 sm:p-4',
                direction === 'rtl'
                  ? `border-r-4 border-${worldColor}-400`
                  : `border-l-4 border-${worldColor}-400`
              )}
            >
              {answer.questionType === 'budgetAllocation' &&
              typeof answer.rawValue === 'object' &&
              answer.rawValue &&
              !Array.isArray(answer.rawValue) ? (
                // --- START: התיקון ---
                (() => {
                  // השרת מספק מחרוזת מתורגמת מראש ב-displayText.
                  // אנו מפרקים אותה בחזרה לאובייקט שהמפתחות שלו כבר מתורגמים.
                  const translatedData = answer.displayText.split(' | ').reduce(
                    (acc, item) => {
                      const parts = item.split(': ');
                      if (parts.length === 2) {
                        const label = parts[0].trim();
                        const value = parseInt(
                          parts[1].replace(/[^0-9]/g, ''),
                          10
                        );
                        if (label && !isNaN(value)) {
                          acc[label] = value;
                        }
                      }
                      return acc;
                    },
                    {} as Record<string, number>
                  );

                  return (
                    <BudgetDisplay
                      data={translatedData}
                      dict={dict.budgetDisplay}
                      locale={locale}
                    />
                  );
                })()
              ) : (
                // --- END: התיקון ---
                <p
                  className={cn(
                    'text-gray-700 leading-relaxed italic break-words hyphens-auto word-break-break-word overflow-wrap-anywhere',
                    compact ? 'text-sm' : 'text-sm sm:text-base'
                  )}
                >
                  <Quote
                    className={cn(
                      'w-3 h-3 sm:w-4 sm:h-4 inline text-gray-400 flex-shrink-0',
                      direction === 'rtl' ? 'ml-1' : 'mr-1'
                    )}
                  />
                  {answer.displayText}
                  <Quote
                    className={cn(
                      'w-3 h-3 sm:w-4 sm:h-4 inline text-gray-400 transform rotate-180 flex-shrink-0',
                      direction === 'rtl' ? 'mr-1' : 'ml-1'
                    )}
                  />
                </p>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  useEffect(() => {
    setIsClient(true);
    const checkScreenSize = () => setIsDesktop(window.innerWidth >= 1024);
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);

    return () => {
      window.removeEventListener('resize', checkScreenSize);
    };
  }, []);

  const MainContentTabs: React.FC<{ isDesktop: boolean }> = ({ isDesktop }) => {
    const activeTabConfig = tabItems.find((tab) => tab.value === activeTab);

    // --- START: Refactored Logic for Content Slicing ---
    const getTabContent = (
      answers: FormattedAnswer[]
    ): {
      hookAnswer: FormattedAnswer | undefined;
      deeperAnswers: FormattedAnswer[];
    } => {
      if (!answers || answers.length === 0) {
        return { hookAnswer: undefined, deeperAnswers: [] };
      }
      return {
        hookAnswer: answers[0],
        deeperAnswers: answers.slice(1),
      };
    };

    const personalityContent = getTabContent(personalityAnswers);
    const valuesContent = getTabContent(valuesAnswers);
    const religionContent = getTabContent(religionAnswers);
    const relationshipContent = getTabContent(relationshipAnswers);
    const partnerContent = getTabContent(partnerAnswers);
    // --- END: Refactored Logic for Content Slicing ---

    return (
      <Tabs
        value={activeTab}
        onValueChange={handleTabChange}
        className="w-full flex flex-col flex-1 min-h-0 max-w-full overflow-hidden"
      >
        <div
          className={cn(
            'bg-white/95 backdrop-blur-md rounded-2xl border border-gray-200/50 overflow-hidden sticky top-0 z-20',
            'mb-3 sm:mb-4 md:mb-6 p-1 sm:p-2',
            THEME.shadows.elegant
          )}
        >
          <ScrollArea
            className="w-full max-w-full overflow-hidden"
            dir={direction}
          >
            <div className="flex gap-0.5 sm:gap-1 justify-center min-w-max px-2 sm:px-4">
              {tabItems.map((tab) => (
                <button
                  key={tab.value}
                  onClick={() => handleTabChange(tab.value)}
                  className={cn(
                    'flex flex-col items-center gap-1 rounded-xl flex-shrink-0 transition-all duration-300 border border-transparent',
                    'text-gray-600 hover:text-gray-800 hover:bg-rose-50',
                    'min-w-[50px] min-h-[44px] touch-manipulation',
                    'sm:min-w-[60px] md:min-w-[80px]',
                    'px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2',
                    'text-xs sm:text-sm font-semibold',
                    !tab.hasContent && 'opacity-50 cursor-not-allowed',
                    activeTab === tab.value &&
                      cn(
                        'font-bold text-white shadow-lg border-white/20',
                        `bg-gradient-to-r ${tab.gradient}`
                      )
                  )}
                  disabled={!tab.hasContent}
                >
                  <tab.icon className="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0" />
                  <span className="leading-tight text-center break-words hyphens-auto word-break-break-word max-w-full">
                    {typeof window !== 'undefined' &&
                    window.innerWidth < 640 &&
                    tab.shortLabel
                      ? tab.shortLabel
                      : tab.label}
                  </span>
                </button>
              ))}
            </div>
            <ScrollBar orientation="horizontal" className="mt-1" />
          </ScrollArea>
        </div>
        <ScrollArea
          id="profile-card-tabs-content"
          className="flex-1 overflow-auto h-full max-w-full"
          ref={contentScrollAreaRef}
        >
          <div className="space-y-3 sm:space-y-4 md:space-y-6 p-1 sm:p-2 min-w-0 max-w-full">
            {!(activeTabConfig && activeTabConfig.hasContent) && (
              <EmptyState
                icon={Telescope}
                title={displayDict.content.emptyStateTitle}
                description={displayDict.content.emptyStateDescription}
                variant="discovery"
                THEME={THEME}
              />
            )}

            {/* Essence Tab - REFACTORED */}
            <TabsContent value="essence" className="mt-0 max-w-full min-w-0">
              <div className="space-y-6 sm:space-y-8 max-w-full min-w-0">
                {/* 1. משפט הפתיחה מופיע ראשון */}
                {profile.profileHeadline && (
                  <SectionCard
                    title={displayDict.content.openingSentence}
                    icon={Quote}
                    variant="elegant"
                    gradient={THEME.colors.primary.main}
                  >
                    <p className="text-center text-lg italic font-semibold text-gray-700">
                      &quot;{profile.profileHeadline}&quot;
                    </p>
                  </SectionCard>
                )}

                {/* 2. הסיפור האישי עם כותרת משופרת */}
                <SectionCard
                  title={dict.display.content.aboutMe.titleCard.replace(
                    '{{name}}',
                    profile.user?.firstName || ''
                  )}
                  icon={User}
                  variant="romantic"
                  gradient={THEME.colors.primary.romantic}
                >
                  <div className="relative p-4 bg-rose-50/30 rounded-lg border border-rose-200/50">
                    <Quote className="absolute top-2 right-2 w-6 h-6 text-rose-200" />
                    <p className="whitespace-pre-wrap text-gray-800 leading-relaxed italic px-4">
                      {profile.about}
                    </p>
                    <Quote className="absolute bottom-2 left-2 w-6 h-6 text-rose-200 transform rotate-180" />
                  </div>
                </SectionCard>

                {/* --- START OF CHANGE --- */}
                {/* 3. חלק ההמלצות מופיע כאן (עם תנאי הצגה) */}
                {profile.isFriendsSectionVisible &&
                  (profile.testimonials || []).filter(
                    (t) => t.status === 'APPROVED'
                  ).length > 0 && (
                    <SectionCard
                      title={displayDict.content.recommendationsTitle.replace(
                        '{{name}}',
                        profile.user?.firstName || ''
                      )}
                      subtitle={displayDict.content.recommendationsSubtitle}
                      icon={MessageSquareQuote}
                      variant="default"
                      gradient={THEME.colors.primary.light}
                    >
                      <FriendTestimonialsSection
                        profile={profile}
                        dict={displayDict}
                        THEME={THEME}
                        direction={direction}
                      />
                    </SectionCard>
                  )}
                {/* --- END OF CHANGE --- */}

          {/* 5. שאלת הוו (Hook) מעולם "אישיות" */}
                {personalityContent.hookAnswer && (
                   <QuestionnaireItem
                     answer={personalityContent.hookAnswer}
                     worldName={WORLDS.personality.label}
                     worldColor={WORLDS.personality.accentColor}
                     worldGradient={WORLDS.personality.gradient}
                     direction={direction}
                   />
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 max-w-full min-w-0">
                  {profile.profileCharacterTraits &&
                    profile.profileCharacterTraits.length > 0 && (
                      <SectionCard
                        title={displayDict.content.whatMakesMeSpecial}
                        subtitle={displayDict.content.myTraits}
                        icon={Sparkles}
                        variant="elegant"
                        gradient={THEME.colors.primary.light}
                      >
                        <div className="flex flex-wrap gap-2 sm:gap-3">
                          {profile.profileCharacterTraits.map((trait) => {
                            const traitData = formatEnumValue(
                              trait,
                              characterTraitMap,
                              trait
                            );
                            return (
                              <Badge
                                key={trait}
                                className={cn(
                                  'flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 font-semibold text-xs sm:text-sm',
                                  'bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800',
                                  'border border-purple-200 rounded-full hover:scale-105 transition-transform',
                                  THEME.shadows.soft
                                )}
                              >
                                <traitData.icon
                                  className={cn(
                                    'w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0',
                                    traitData.color
                                  )}
                                />
                                <span>{traitData.label}</span>
                              </Badge>
                            );
                          })}
                        </div>
                      </SectionCard>
                    )}
                  {profile.profileHobbies &&
                    profile.profileHobbies.length > 0 && (
                      <SectionCard
                        title={displayDict.content.whatFillsMySoul}
                        subtitle={displayDict.content.myHobbies}
                        icon={Heart}
                        variant="elegant"
                        gradient={THEME.colors.secondary.sage}
                      >
                        <div className="flex flex-wrap gap-2 sm:gap-3">
                          {profile.profileHobbies.map((hobby) => {
                            const hobbyData = formatEnumValue(
                              hobby,
                              hobbiesMap,
                              hobby
                            );
                            return (
                              <Badge
                                key={hobby}
                                className={cn(
                                  'flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 font-semibold text-xs sm:text-sm',
                                  'bg-gradient-to-r from-emerald-100 to-cyan-100 text-emerald-800',
                                  'border border-emerald-200 rounded-full hover:scale-105 transition-transform',
                                  THEME.shadows.soft
                                )}
                              >
                                <hobbyData.icon
                                  className={cn(
                                    'w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0',
                                    hobbyData.color
                                  )}
                                />
                                <span>{hobbyData.label}</span>
                              </Badge>
                            );
                          })}
                        </div>
                      </SectionCard>
                    )}
                </div>
                {personalityContent.deeperAnswers.length > 0 && (
                  <SectionCard
                    title={displayDict.content.deepDivePersonality}
                    subtitle={displayDict.content.moreAnswersPersonality}
                    icon={Telescope}
                    variant="elegant"
                    gradient={WORLDS.personality.gradient}
                  >
                    <div className="grid grid-cols-1 gap-4 sm:gap-6">
                      {personalityContent.deeperAnswers.map((answer) => (
                        <QuestionnaireItem
                          key={answer.questionId}
                          answer={answer}
                          worldName={WORLDS.personality.label}
                          worldColor={WORLDS.personality.accentColor}
                          worldGradient={WORLDS.personality.gradient}
                          direction={direction}
                        />
                      ))}
                    </div>
                  </SectionCard>
                )}
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </div>
            </TabsContent>

        
            {/* Journey Tab - REFACTORED */}
            <TabsContent
              value="journey"
              className="mt-0 space-y-4 sm:space-y-6 max-w-full min-w-0"
            >
              <div className="space-y-6 sm:space-y-8 max-w-full min-w-0">
                {valuesContent.hookAnswer && (
                  <QuestionnaireItem
                    answer={valuesContent.hookAnswer}
                    worldName={WORLDS.values.label}
                    worldColor={WORLDS.values.accentColor}
                    worldGradient={WORLDS.values.gradient}
                    direction={direction}
                  />
                )}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                  {hasEducationAndCareerDetails && (
                    <SectionCard
                      title={displayDict.content.educationAndCareer}
                      subtitle={displayDict.content.academicAndProfessionalPath}
                      icon={GraduationCap}
                      variant="elegant"
                      gradient={THEME.colors.secondary.sky}
                    >
                      <div className="space-y-4 sm:space-y-5">
                        {profile.educationLevel && (
                          <DetailItem
                            icon={GraduationCap}
                            label={
                              displayDict.content.detailLabels.educationLevel
                            }
                            value={
                              formatEnumValue(
                                profile.educationLevel,
                                educationLevelMap,
                                ''
                              ).label
                            }
                            variant="highlight"
                            textAlign="start"
                            placeholder=""
                          />
                        )}
                        {profile.education && (
                          <DetailItem
                            icon={BookOpen}
                            label={
                              displayDict.content.detailLabels.educationDetails
                            }
                            value={profile.education}
                            variant="elegant"
                            valueClassName="whitespace-pre-wrap"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                        {profile.occupation && (
                          <DetailItem
                            icon={Briefcase}
                            label={
                              displayDict.content.detailLabels.professionalField
                            }
                            value={profile.occupation}
                            variant="elegant"
                            textAlign="start"
                            placeholder=""
                          />
                        )}
                        {profile.serviceType && (
                          <DetailItem
                            icon={Award}
                            label={
                              displayDict.content.detailLabels.militaryService
                            }
                            value={
                              formatEnumValue(
                                profile.serviceType,
                                serviceTypeMap,
                                ''
                              ).label
                            }
                            variant="elegant"
                            textAlign="start"
                            placeholder=""
                          />
                        )}

                        {profile.serviceDetails && (
                          <DetailItem
                            icon={InfoIcon}
                            label={
                              displayDict.content.detailLabels.serviceDetails
                            }
                            value={profile.serviceDetails}
                            variant="elegant"
                            valueClassName="whitespace-pre-wrap"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                      </div>
                    </SectionCard>
                  )}
                  {hasFamilyBackgroundDetails && (
                    <SectionCard
                      title={displayDict.content.familyAndCulturalBackground}
                      subtitle={displayDict.content.familyThatShapedMe}
                      icon={Users2}
                      variant="romantic"
                      gradient={THEME.colors.primary.accent}
                    >
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                        {profile.parentStatus && (
                          <DetailItem
                            icon={Users2}
                            label={
                              displayDict.content.detailLabels.parentStatus
                            }
                            value={profile.parentStatus}
                            variant="elegant"
                            textAlign="start"
                            placeholder=""
                          />
                        )}
                        {profile.fatherOccupation && (
                          <DetailItem
                            icon={Briefcase}
                            label={
                              displayDict.content.detailLabels.fatherOccupation
                            }
                            value={profile.fatherOccupation}
                            variant="elegant"
                            textAlign="start"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                        {profile.motherOccupation && (
                          <DetailItem
                            icon={Briefcase}
                            label={
                              displayDict.content.detailLabels.motherOccupation
                            }
                            value={profile.motherOccupation}
                            variant="elegant"
                            textAlign="start"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                        {profile.siblings !== null &&
                          profile.siblings !== undefined && (
                            <DetailItem
                              icon={Users}
                              label={displayDict.content.detailLabels.siblings}
                              value={`${profile.siblings} אחים/אחיות`}
                              variant="elegant"
                              textAlign="start"
                              placeholder=""
                            />
                          )}
                        {profile.position && (
                          <DetailItem
                            icon={Crown}
                            label={displayDict.content.detailLabels.birthOrder}
                            value={`מקום ${profile.position}`}
                            variant="elegant"
                            textAlign="start"
                            placeholder=""
                          />
                        )}
                        {profile.aliyaCountry && (
                          <DetailItem
                            icon={Globe}
                            label={
                              displayDict.content.detailLabels.countryOfOrigin
                            }
                            value={`${profile.aliyaCountry} - השורשים שלי`}
                            variant="elegant"
                            textAlign="start"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                        {profile.aliyaYear && (
                          <DetailItem
                            icon={Calendar}
                            label={displayDict.content.detailLabels.aliyaYear}
                            value={`${profile.aliyaYear} - הגעתי הביתה`}
                            variant="elegant"
                            textAlign="start"
                            placeholder={displayDict.placeholders.willDiscover}
                          />
                        )}
                      </div>
                    </SectionCard>
                  )}
                </div>
                {valuesContent.deeperAnswers.length > 0 && (
                  <SectionCard
                    title={displayDict.content.valuesAndPrinciples}
                    subtitle={displayDict.content.answersOnWhatMatters}
                    icon={BookMarked}
                    variant="elegant"
                    gradient={WORLDS.values.gradient}
                  >
                    <div className="grid grid-cols-1 gap-4 sm:gap-6">
                      {valuesContent.deeperAnswers.map((answer) => (
                        <QuestionnaireItem
                          key={answer.questionId}
                          answer={answer}
                          worldName={WORLDS.values.label}
                          worldColor={WORLDS.values.accentColor}
                          worldGradient={WORLDS.values.gradient}
                          direction={direction}
                        />
                      ))}
                    </div>
                  </SectionCard>
                )}
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </div>
            </TabsContent>

            {/* Spirit Tab - NEW & REFACTORED */}
            <TabsContent
              value="spirit"
              className="mt-0 space-y-4 sm:space-y-6 max-w-full min-w-0"
            >
              <div className="space-y-6 sm:space-y-8 max-w-full min-w-0">
                {religionContent.hookAnswer && (
                  <QuestionnaireItem
                    answer={religionContent.hookAnswer}
                    worldName={WORLDS.religion.label}
                    worldColor={WORLDS.religion.accentColor}
                    worldGradient={WORLDS.religion.gradient}
                    direction={direction}
                  />
                )}
                {hasJudaismConnectionDetails && (
                  <SectionCard
                    title={displayDict.content.myConnectionToJudaism}
                    subtitle={displayDict.content.faithAndTraditionInMyLife}
                    icon={BookMarked}
                    variant="elegant"
                    gradient={THEME.colors.primary.gold}
                  >
                    <div className="space-y-4 sm:space-y-5">
                      {(() => {
                        const religiousLevelData = profile.religiousLevel
                          ? formatEnumValue(
                              profile.religiousLevel,
                              religiousLevelMap,
                              ''
                            )
                          : null;
                        if (
                          religiousLevelData &&
                          religiousLevelData.label?.trim()
                        ) {
                          return (
                            <DetailItem
                              icon={BookMarked}
                              label="השקפת העולם שמנחה אותי"
                              value={religiousLevelData.label}
                              variant="highlight"
                              textAlign="start"
                              placeholder=""
                            />
                          );
                        }
                        return null;
                      })()}
                      {profile.religiousJourney && (
                        <DetailItem
                          icon={Compass}
                          label={
                            displayDict.content.detailLabels.religiousJourney
                          }
                          value={
                            formatEnumValue(
                              profile.religiousJourney,
                              religiousJourneyMap,
                              displayDict.placeholders.willDiscover
                            ).label
                          }
                          variant="elegant"
                          textAlign="start"
                          placeholder={displayDict.placeholders.willDiscover}
                        />
                      )}
                      {profile.shomerNegiah !== null &&
                        profile.shomerNegiah !== undefined && (
                          <DetailItem
                            icon={Heart}
                            label={
                              displayDict.content.detailLabels.shomerNegiah
                            }
                            value={
                              formatBooleanPreference(
                                profile.shomerNegiah,
                                {
                                  ...displayDict.booleanPrefs,
                                  willDiscover: '',
                                },
                                true
                              ).label
                            }
                            variant="elegant"
                            textAlign="start"
                            placeholder=""
                          />
                        )}
                      {profile.gender === 'FEMALE' && profile.headCovering && (
                        <DetailItem
                          icon={Crown}
                          label={displayDict.content.detailLabels.headCovering}
                          value={
                            formatEnumValue(
                              profile.headCovering,
                              headCoveringMap,
                              displayDict.placeholders.willDiscover
                            ).label
                          }
                          variant="elegant"
                          textAlign="start"
                          placeholder={displayDict.placeholders.willDiscover}
                        />
                      )}
                      {profile.gender === 'MALE' && profile.kippahType && (
                        <DetailItem
                          icon={Crown}
                          label={displayDict.content.detailLabels.kippahType}
                          value={
                            formatEnumValue(
                              profile.kippahType,
                              kippahTypeMap,
                              displayDict.placeholders.willDiscover
                            ).label
                          }
                          variant="elegant"
                          textAlign="start"
                          placeholder={displayDict.placeholders.willDiscover}
                        />
                      )}
                    </div>
                  </SectionCard>
                )}
                {profile.influentialRabbi && (
                  <SectionCard
                    title={displayDict.content.inspiringSpiritualFigure}
                    icon={Lightbulb}
                    variant="elegant"
                    gradient={THEME.colors.primary.gold}
                  >
                    <div
                      className={cn(
                        'p-4 sm:p-6 rounded-2xl border border-amber-200',
                        `bg-gradient-to-r ${THEME.colors.neutral.warm}`
                      )}
                    >
                      <p className="text-amber-800 leading-relaxed italic">
                        &quot;{profile.influentialRabbi}&quot;
                      </p>
                    </div>
                  </SectionCard>
                )}

                {religionContent.deeperAnswers.length > 0 && (
                  <SectionCard
                    title={displayDict.content.myReligiousAndSpiritualWorld}
                    subtitle={displayDict.content.answersOnFaith}
                    icon={Star}
                    variant="elegant"
                    gradient={WORLDS.religion.gradient}
                  >
                    <div className="grid grid-cols-1 gap-4 sm:gap-6">
                      {religionContent.deeperAnswers.map((answer) => (
                        <QuestionnaireItem
                          key={answer.questionId}
                          answer={answer}
                          worldName={WORLDS.religion.label}
                          worldColor={WORLDS.religion.accentColor}
                          worldGradient={WORLDS.religion.gradient}
                          direction={direction}
                        />
                      ))}
                    </div>
                  </SectionCard>
                )}
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </div>
            </TabsContent>

            {/* Vision Tab - REFACTORED */}
            <TabsContent
              value="vision"
              className="mt-0 space-y-4 sm:space-y-6 max-w-full min-w-0"
            >
              <div className="space-y-6 sm:space-y-8 max-w-full min-w-0">
                {relationshipContent.hookAnswer && (
                  <QuestionnaireItem
                    answer={relationshipContent.hookAnswer}
                    worldName={WORLDS.relationship.label}
                    worldColor={WORLDS.relationship.accentColor}
                    worldGradient={WORLDS.relationship.gradient}
                    direction={direction}
                  />
                )}
                {profile.matchingNotes && (
                  <SectionCard
                    title={displayDict.content.myDreamRelationship}
                    icon={Heart}
                    variant="romantic"
                    gradient={THEME.colors.primary.main}
                  >
                    <div
                      className={cn(
                        'p-4 sm:p-6 rounded-2xl border border-rose-200 max-w-full min-w-0 overflow-hidden',
                        `bg-gradient-to-r ${THEME.colors.neutral.warm}`,
                        THEME.shadows.soft
                      )}
                    >
                      <p className="text-rose-700 leading-relaxed whitespace-pre-wrap italic text-base sm:text-lg break-words hyphens-auto word-break-break-word overflow-wrap-anywhere">
                        <Quote
                          className={cn(
                            'w-4 h-4 sm:w-5 sm:h-5 inline text-rose-400 flex-shrink-0',
                            direction === 'rtl' ? 'ml-1' : 'mr-1'
                          )}
                        />
                        {profile.matchingNotes}
                        <Quote
                          className={cn(
                            'w-4 h-4 sm:w-5 sm:h-5 inline text-rose-400 transform rotate-180 flex-shrink-0',
                            direction === 'rtl' ? 'mr-1' : 'ml-1'
                          )}
                        />
                      </p>
                    </div>
                  </SectionCard>
                )}
                {profile.inspiringCoupleStory && (
                  <SectionCard
                    title={displayDict.content.myRoleModelForRelationship}
                    subtitle={displayDict.content.theCoupleThatInspiresMe}
                    icon={Stars}
                    variant="elegant"
                    gradient={THEME.colors.primary.gold}
                  >
                    <div
                      className={cn(
                        'p-4 sm:p-6 rounded-2xl border border-amber-200',
                        `bg-gradient-to-r ${THEME.colors.neutral.warm}`
                      )}
                    >
                      <p className="text-amber-800 leading-relaxed italic">
                        &quot;{profile.inspiringCoupleStory}&quot;
                      </p>
                    </div>
                  </SectionCard>
                )}
                {relationshipContent.deeperAnswers.length > 0 && (
                  <SectionCard
                    title={displayDict.content.moreOnMyVision}
                    subtitle={displayDict.content.answersOnLoveAndFamily}
                    icon={Heart}
                    variant="romantic"
                    gradient={WORLDS.relationship.gradient}
                  >
                    <div className="grid grid-cols-1 gap-4 sm:gap-6">
                      {relationshipContent.deeperAnswers.map((answer) => (
                        <QuestionnaireItem
                          key={answer.questionId}
                          answer={answer}
                          worldName={WORLDS.relationship.label}
                          worldColor={WORLDS.relationship.accentColor}
                          worldGradient={WORLDS.relationship.gradient}
                          direction={direction}
                        />
                      ))}
                    </div>
                  </SectionCard>
                )}
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </div>
            </TabsContent>

            {/* Connection Tab - REFACTORED */}
            <TabsContent
              value="connection"
              className="mt-0 space-y-4 sm:space-y-6 max-w-full min-w-0"
            >
              <div className="space-y-6 sm:space-y-8 max-w-full min-w-0">
                {partnerContent.hookAnswer && (
                  <QuestionnaireItem
                    answer={partnerContent.hookAnswer}
                    worldName={WORLDS.partner.label}
                    worldColor={WORLDS.partner.accentColor}
                    worldGradient={WORLDS.partner.gradient}
                    direction={direction}
                  />
                )}
                {hasAnyPreferences ? (
                  <SectionCard
                    title={displayDict.content.matchingPreferences}
                    subtitle={displayDict.content.whatHelpsFindConnection}
                    icon={Filter}
                    variant="default"
                  >
                    <div className="space-y-6 sm:space-y-8">
                      {renderPreferenceBadges(
                        displayDict.content.maritalStatuses,
                        Heart,
                        profile.preferredMaritalStatuses,
                        maritalStatusMap,
                        THEME.colors.primary.main
                      )}
                      {renderPreferenceBadges(
                        displayDict.content.religiousLevels,
                        BookMarked,
                        profile.preferredReligiousLevels,
                        religiousLevelMap,
                        THEME.colors.secondary.peach
                      )}
                      {renderPreferenceBadges(
                        displayDict.content.partnerReligiousJourney,
                        Compass,
                        profile.preferredReligiousJourneys as string[],
                        religiousJourneyMap,
                        THEME.colors.secondary.sage
                      )}
                      {renderPreferenceBadges(
                        displayDict.content.educationLevels,
                        GraduationCap,
                        profile.preferredEducation,
                        educationLevelMap,
                        THEME.colors.secondary.sky
                      )}
                    </div>
                  </SectionCard>
                ) : (
                  !partnerContent.hookAnswer &&
                  partnerContent.deeperAnswers.length === 0 && (
                    <EmptyState
                      icon={Compass}
                      title={displayDict.content.emptyPrefsTitle}
                      description={displayDict.content.emptyPrefsDescription}
                      variant="discovery"
                      THEME={THEME}
                    />
                  )
                )}
                {partnerContent.deeperAnswers.length > 0 && (
                  <SectionCard
                    title={displayDict.content.howIVisionMyPartner}
                    subtitle={displayDict.content.moreAnswersAboutPartner}
                    icon={Target}
                    variant="elegant"
                    gradient={WORLDS.partner.gradient}
                  >
                    <div className="grid grid-cols-1 gap-4 sm:gap-6">
                      {partnerContent.deeperAnswers.map((answer) => (
                        <QuestionnaireItem
                          key={answer.questionId}
                          answer={answer}
                          worldName={WORLDS.partner.label}
                          worldColor={WORLDS.partner.accentColor}
                          worldGradient={WORLDS.partner.gradient}
                          direction={direction}
                        />
                      ))}
                    </div>
                  </SectionCard>
                )}
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </div>
            </TabsContent>

            {/* Professional Tab */}
            {viewMode === 'matchmaker' && (
              <TabsContent
                value="professional"
                className="mt-0 max-w-full min-w-0"
              >
                <SectionCard
                  title={displayDict.content.confidentialInfo}
                  subtitle={displayDict.content.professionalDetails}
                  icon={Lock}
                  variant="elegant"
                  gradient={THEME.colors.primary.gold}
                >
                  <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {profile.contactPreference && (
                        <DetailItem
                          icon={Phone}
                          label={
                            displayDict.content.professionalInfo
                              .contactPreference
                          }
                          value={
                            formatEnumValue(
                              profile.contactPreference,
                              contactPreferenceMap,
                              ''
                            ).label
                          }
                          variant="elegant"
                          textAlign="start"
                          placeholder=""
                        />
                      )}
                      {profile.preferredMatchmakerGender && (
                        <DetailItem
                          icon={Users}
                          label={
                            displayDict.content.professionalInfo
                              .matchmakerGenderPref
                          }
                          value={
                            profile.preferredMatchmakerGender === 'MALE'
                              ? displayDict.content.professionalInfo
                                  .matchmakerMale
                              : displayDict.content.professionalInfo
                                  .matchmakerFemale
                          }
                          variant="elegant"
                          textAlign="start"
                          placeholder=""
                        />
                      )}
                    </div>
                    {profile.hasMedicalInfo && (
                      <DetailItem
                        icon={Heart}
                        label={displayDict.content.professionalInfo.medicalInfo}
                        value={
                          profile.isMedicalInfoVisible
                            ? displayDict.content.professionalInfo
                                .medicalInfoVisible
                            : displayDict.content.professionalInfo
                                .medicalInfoDiscreet
                        }
                        variant="elegant"
                        textAlign="start"
                        tooltip={profile.medicalInfoDetails || undefined}
                        placeholder={displayDict.placeholders.willDiscover}
                      />
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                      <div className="flex items-center gap-2">
                        <Calendar className="w-4 h-4 text-gray-500" />
                        <span>
                          {displayDict.content.professionalInfo.profileCreated}{' '}
                          {profile.createdAt
                            ? new Date(profile.createdAt).toLocaleDateString(
                                locale
                              )
                            : displayDict.content.professionalInfo.unknown}
                        </span>
                      </div>
                      {profile.lastActive && (
                        <div className="flex items-center gap-2">
                          <Clock className="w-4 h-4 text-gray-500" />
                          <span>
                            {displayDict.content.professionalInfo.lastActive}{' '}
                            {new Date(profile.lastActive).toLocaleDateString(
                              locale
                            )}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </SectionCard>
                {!isDesktop && mobileViewLayout === 'detailed' && (
                  <TabNavigationButtons
                    activeTab={activeTab}
                    tabItems={tabItems}
                    onTabChange={handleTabChange}
                    THEME={THEME}
                    dict={displayDict.mobileNav}
                    direction={direction}
                  />
                )}
              </TabsContent>
            )}
            {isDesktop && (
              <TabNavigationButtons
                activeTab={activeTab}
                tabItems={tabItems}
                onTabChange={handleTabChange}
                THEME={THEME}
                dict={displayDict.mobileNav}
                direction={direction}
              />
            )}
          </div>
        </ScrollArea>
      </Tabs>
    );
  };

  const MobileHeader = () => (
    <div
      className={cn(
        'flex-shrink-0 flex justify-between items-center border-b border-rose-200/50 sticky top-0 z-30 backdrop-blur-md',
        'p-3 sm:p-4 min-h-[60px]',
        `bg-gradient-to-r ${THEME.colors.neutral.warm}`
      )}
      dir={direction}
    >
      <Button
        variant="ghost"
        size="icon"
        className={cn(
          'text-gray-600 hover:text-gray-800 hover:bg-white/60 rounded-full transition-all duration-300 shadow-sm hover:shadow-md',
          'w-10 h-10 sm:w-12 sm:h-12 min-h-[44px] min-w-[44px] touch-manipulation'
        )}
        onClick={handleClose}
        aria-label={displayDict.mobileNav.closePreview}
      >
        <X className="w-4 h-4 sm:w-5 sm:h-5" />
      </Button>
      <div className="flex items-center gap-3 flex-1 justify-center">
        <ToggleGroup
          type="single"
          value={mobileViewLayout}
          onValueChange={(value: 'focus' | 'detailed') => {
            if (value) setMobileViewLayout(value);
          }}
          className={cn(
            'bg-white/95 backdrop-blur-sm rounded-2xl border border-rose-200/50 shadow-lg',
            'p-1',
            THEME.shadows.soft
          )}
        >
          <ToggleGroupItem
            value="focus"
            aria-label={displayDict.mobileNav.introView}
            className={cn(
              'rounded-xl transition-all duration-300 min-h-[44px] px-3 sm:px-4 py-2 touch-manipulation',
              'data-[state=on]:bg-gradient-to-r data-[state=on]:from-rose-500 data-[state=on]:to-pink-500 data-[state=on]:text-white data-[state=on]:shadow-md'
            )}
          >
            <Heart className="h-3 h-3 sm:h-4 sm:w-4" />
            <span className="mx-1.5 sm:mx-2 text-xs sm:text-sm font-medium">
              {displayDict.mobileNav.introView}
            </span>
          </ToggleGroupItem>
          <ToggleGroupItem
            value="detailed"
            aria-label={displayDict.mobileNav.detailedView}
            className={cn(
              'rounded-xl transition-all duration-300 min-h-[44px] px-3 sm:px-4 py-2 touch-manipulation',
              'data-[state=on]:bg-gradient-to-r data-[state=on]:from-purple-500 data-[state=on]:to-indigo-500 data-[state=on]:text-white data-[state=on]:shadow-md'
            )}
          >
            <FileText className="h-3 h-3 sm:h-4 sm:w-4" />
            <span className="mx-1.5 sm:mx-2 text-xs sm:text-sm font-medium">
              {displayDict.mobileNav.detailedView}
            </span>
          </ToggleGroupItem>
        </ToggleGroup>
        <ColorPaletteSelector
          selectedPalette={selectedPalette}
          onPaletteChange={setSelectedPalette}
          THEME={THEME}
          dict={displayDict.colorPalette}
          compact={true}
          direction={direction}
        />
      </div>
    </div>
  );

  const DetailedMobileLayout = () => (
    <ScrollArea className="flex-1 min-h-0 max-w-full overflow-hidden">
      <div className="flex flex-col min-w-0 max-w-full">
        <ProfileHeader
          profile={profile}
          age={age}
          mainImageToDisplay={mainImageToDisplay}
          availability={availability}
          viewMode={viewMode}
          onSuggestClick={() => setIsSuggestDialogOpen(true)}
          isMobile={true}
          selectedPalette={selectedPalette}
          THEME={THEME}
          dict={displayDict}
          compact={false}
          characterTraitMap={characterTraitMap}
          hobbiesMap={hobbiesMap}
          religiousLevelMap={religiousLevelMap}
          educationLevelMap={educationLevelMap}
          locale={locale}
        />
        <MobileImageGallery
          orderedImages={orderedImages}
          profile={profile}
          onImageClick={handleOpenImageDialog}
          THEME={THEME}
          dict={displayDict.gallery}
          compact={false}
          direction={direction}
        />
        <div
          className={cn(
            'p-3 sm:p-4 min-w-0 max-w-full overflow-hidden',
            `bg-gradient-to-br ${THEME.colors.neutral.cool}`
          )}
        >
          <MainContentTabs isDesktop={false} />
        </div>
      </div>
    </ScrollArea>
  );

  const FocusMobileLayout = () => (
    <div className="flex-1 min-h-0 flex flex-col max-w-full overflow-hidden">
      <ScrollArea className="flex-1 min-h-0 max-w-full">
        <div className="pb-4 px-2 sm:px-3 min-w-0 max-w-full overflow-hidden">
          <ProfileHeader
            profile={profile}
            age={age}
            mainImageToDisplay={mainImageToDisplay}
            availability={availability}
            viewMode={viewMode}
            onSuggestClick={() => setIsSuggestDialogOpen(true)}
            isMobile={true}
            selectedPalette={selectedPalette}
            onPaletteChange={setSelectedPalette}
            THEME={THEME}
            dict={displayDict}
            compact={true}
            characterTraitMap={characterTraitMap}
            hobbiesMap={hobbiesMap}
            religiousLevelMap={religiousLevelMap}
            educationLevelMap={educationLevelMap}
            locale={locale}
          />
          <MobileImageGallery
            orderedImages={orderedImages}
            profile={profile}
            onImageClick={handleOpenImageDialog}
            THEME={THEME}
            dict={displayDict.gallery}
            compact={true}
            direction={direction}
          />
          <div
            className={cn(
              'px-2 sm:px-3 py-2 space-y-3 sm:space-y-4 min-w-0 max-w-full overflow-hidden',
              `bg-gradient-to-br ${THEME.colors.neutral.warm}`
            )}
          >
            <NeshamaTechSummary
              profile={profile}
              dict={displayDict}
              THEME={THEME}
              direction={direction}
            />

            {profile.isAboutVisible && profile.about && (
              <SectionCard
                title={displayDict.content.focus.aboutMe}
                subtitle={displayDict.content.focus.myStory}
                icon={Heart}
                variant="romantic"
                gradient={THEME.colors.primary.main}
                compact={true}
              >
                <div className="p-3 text-start">
                  <p className="text-gray-800 leading-relaxed italic font-medium break-words line-clamp-4">
                    {profile.about}
                  </p>
                  <div className="text-center mt-3">
                    <Button
                      variant="link"
                      className={cn(
                        'font-bold',
                        THEME.colors.primary.main.includes('rose')
                          ? 'text-rose-600'
                          : THEME.colors.primary.main.includes('blue')
                            ? 'text-blue-600'
                            : THEME.colors.primary.main.includes('amber')
                              ? 'text-amber-600'
                              : 'text-gray-600'
                      )}
                      onClick={() => setMobileViewLayout('detailed')}
                    >
                      {dict.display.content.focus.readFullStory}{' '}
                      <ArrowLeft className="w-4 h-4 mr-1" />
                    </Button>
                  </div>
                </div>
              </SectionCard>
            )}

            {profile.isFriendsSectionVisible &&
              (profile.testimonials || []).filter(
                (t) => t.status === 'APPROVED'
              ).length > 0 && (
                <SectionCard
                  title={dict.display.content.friendTestimonials.title.replace(
                    '{{name}}',
                    profile.user?.firstName || ''
                  )}
                  subtitle={dict.display.content.friendTestimonials.focusSubtitle.replace(
                    '{{count}}',
                    (profile.testimonials || [])
                      .filter((t) => t.status === 'APPROVED')
                      .length.toString()
                  )}
                  icon={MessageSquareQuote}
                  variant="default"
                  compact={true}
                >
                  <div className="text-center p-2">
                    <Button
                      variant="outline"
                      className="w-full"
                      onClick={() => {
                        setMobileViewLayout('detailed');
                        setActiveTab('essence'); // Changed from 'recommendations' to 'essence' to ensure it goes to the right place
                      }}
                    >
                      {dict.display.content.friendTestimonials.viewButton}
                    </Button>
                  </div>
                </SectionCard>
              )}
            {/* --- END: VERIFY THIS CODE BLOCK --- */}

           
            <SectionCard
              title={displayDict.content.focus.quickSummary}
              subtitle={displayDict.content.focus.importantDetails}
              icon={Zap}
              variant="elegant"
              gradient={THEME.colors.primary.gold}
              compact={true}
              className="min-w-0 max-w-full"
            >
              <div className="grid grid-cols-1 gap-2 sm:gap-3 min-w-0 max-w-full">
                {(() => {
                  const religiousLevelData = profile.religiousLevel
                    ? formatEnumValue(
                        profile.religiousLevel,
                        religiousLevelMap,
                        displayDict.placeholders.willDiscover
                      )
                    : null;
                  if (
                    religiousLevelData &&
                    religiousLevelData.label?.trim() &&
                    religiousLevelData.label !==
                      displayDict.placeholders.willDiscover
                  ) {
                    return (
                      <DetailItem
                        icon={BookMarked}
                        label={dict.display.keyFacts.outlook}
                        value={religiousLevelData.label}
                        variant="highlight"
                        size="sm"
                        useMobileLayout={true}
                        textAlign="center"
                        placeholder={displayDict.placeholders.willDiscover}
                      />
                    );
                  }
                  return null;
                })()}
                {profile.shomerNegiah !== null &&
                  profile.shomerNegiah !== undefined && (
                    <DetailItem
                      icon={Heart}
                      label={displayDict.content.detailLabels.shomerNegiah}
                      value={
                        formatBooleanPreference(profile.shomerNegiah, {
                          ...displayDict.booleanPrefs,
                          willDiscover: displayDict.placeholders.willDiscover,
                        }).label
                      }
                      variant="elegant"
                      size="sm"
                      useMobileLayout={true}
                      placeholder={displayDict.placeholders.willDiscover}
                    />
                  )}
                {profile.occupation && (
                  <DetailItem
                    icon={Briefcase}
                    label={dict.display.keyFacts.occupation}
                    value={
                      profile.occupation ||
                      displayDict.placeholders.willDiscover
                    }
                    variant="elegant"
                    size="sm"
                    useMobileLayout={true}
                    placeholder={displayDict.placeholders.willDiscover}
                  />
                )}
                {profile.educationLevel && (
                  <DetailItem
                    icon={GraduationCap}
                    label={displayDict.content.detailLabels.educationLevel}
                    value={
                      formatEnumValue(
                        profile.educationLevel,
                        educationLevelMap,
                        displayDict.placeholders.willDiscover
                      ).label
                    }
                    variant="elegant"
                    size="sm"
                    useMobileLayout={true}
                    placeholder={displayDict.placeholders.willDiscover}
                  />
                )}
              </div>
            </SectionCard>
            {hasUniqueTraitsOrHobbies && (
              <SectionCard
                title={displayDict.content.focus.whatMakesMeUnique}
                subtitle={displayDict.content.focus.traitsAndHobbies}
                icon={Sparkles}
                variant="romantic"
                gradient={THEME.colors.primary.romantic}
                compact={true}
                className="min-w-0 max-w-full"
              >
                <div className="space-y-4 sm:space-y-5 min-w-0 max-w-full">
                  {profile.profileCharacterTraits &&
                    profile.profileCharacterTraits.length > 0 && (
                      <div className="min-w-0 max-w-full">
                        <h4 className="text-sm font-bold text-purple-700 mb-2 sm:mb-3 flex items-center justify-center gap-2">
                          <span className="break-words">
                            {displayDict.content.focus.myTraits}
                          </span>
                          <Sparkles className="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0" />
                        </h4>
                        <div className="flex flex-wrap gap-2 min-w-0 max-w-full justify-center">
                          {profile.profileCharacterTraits
                            .slice(0, 4)
                            .map((trait) => {
                              const traitData = formatEnumValue(
                                trait,
                                characterTraitMap,
                                trait,
                                true
                              );
                              return (
                                <Badge
                                  key={trait}
                                  className={cn(
                                    'flex items-center gap-1 px-2 py-1 text-xs font-semibold min-w-0 max-w-full',
                                    `bg-gradient-to-r ${THEME.colors.secondary.lavender} text-purple-800`,
                                    'border border-purple-200 rounded-full',
                                    'break-words'
                                  )}
                                >
                                  <traitData.icon className="w-2.5 h-2.5 sm:w-3 sm:h-3 flex-shrink-0" />
                                  <span className="break-words min-w-0 overflow-hidden">
                                    {traitData.shortLabel || traitData.label}
                                  </span>
                                </Badge>
                              );
                            })}
                        </div>
                      </div>
                    )}
                  {profile.profileHobbies &&
                    profile.profileHobbies.length > 0 && (
                      <div className="min-w-0 max-w-full">
                        <h4 className="text-sm font-bold text-emerald-700 mb-2 sm:mb-3 flex items-center justify-center gap-2">
                          <span className="break-words">
                            {displayDict.content.focus.whatILove}
                          </span>
                          <Heart className="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0" />
                        </h4>
                        <div className="flex flex-wrap gap-2 min-w-0 max-w-full justify-center">
                          {profile.profileHobbies.slice(0, 4).map((hobby) => {
                            const hobbyData = formatEnumValue(
                              hobby,
                              hobbiesMap,
                              hobby,
                              true
                            );
                            return (
                              <Badge
                                key={hobby}
                                className={cn(
                                  'flex items-center gap-1 px-2 py-1 text-xs font-semibold min-w-0 max-w-full',
                                  `bg-gradient-to-r ${THEME.colors.secondary.sage} text-emerald-800`,
                                  'border border-emerald-200 rounded-full',
                                  'break-words'
                                )}
                              >
                                <hobbyData.icon className="w-2.5 h-2.5 sm:w-3 sm:h-3 flex-shrink-0" />
                                <span className="break-words min-w-0 overflow-hidden">
                                  {hobbyData.shortLabel || hobbyData.label}
                                </span>
                              </Badge>
                            );
                          })}
                        </div>
                      </div>
                    )}
                </div>
              </SectionCard>
            )}
            <div
              className={cn(
                'bg-white hover:bg-gray-50 font-bold rounded-full min-h-[44px]',
                'px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base',
                // הוסף צבע טקסט דינמי:
                THEME.colors.primary.main.includes('rose')
                  ? 'text-rose-700'
                  : THEME.colors.primary.main.includes('blue')
                    ? 'text-blue-700'
                    : THEME.colors.primary.main.includes('amber')
                      ? 'text-amber-700'
                      : 'text-gray-700',
                THEME.shadows.warm
              )}
            >
              <h3 className="text-base sm:text-lg font-bold mb-2 break-words">
                {displayDict.content.focus.wantToKnowMore}
              </h3>
              <p className="mb-3 sm:mb-4 opacity-90 text-sm break-words">
                {displayDict.content.focus.moreToDiscover}
              </p>
              <Button
                onClick={() => setMobileViewLayout('detailed')}
                className={cn(
                  'bg-white text-gray-600 hover:bg-gray-50 font-bold rounded-full min-h-[44px]',
                  'px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base',
                  THEME.shadows.warm
                )}
              >
                <Eye
                  className={cn(
                    'w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0',
                    direction === 'rtl' ? 'ml-2' : 'mr-2'
                  )}
                />
                <span className="break-words">
                  {displayDict.content.focus.letsGetToKnow}
                </span>
              </Button>
            </div>
          </div>
        </div>
      </ScrollArea>
    </div>
  );

  if (!isClient) {
    return (
      <Card
        dir={direction}
        className={cn(
          'w-full bg-white shadow-2xl rounded-2xl overflow-hidden border-0 flex flex-col h-full',
          className
        )}
      >
        <div
          className={cn(
            'p-4 sm:p-6 border-b border-gray-200/80',
            `bg-gradient-to-r ${THEME.colors.neutral.warm}`
          )}
        >
          <div className="flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-6">
            <Skeleton className="h-24 w-24 sm:h-36 sm:w-36 rounded-full flex-shrink-0" />
            <div className="flex-grow w-full space-y-4">
              <Skeleton className="h-8 sm:h-12 w-3/4 mx-auto sm:mx-0" />
              <Skeleton className="h-4 sm:h-6 w-1/2 mx-auto sm:mx-0" />
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4 mt-4">
                <Skeleton className="h-10 sm:h-12 w-full rounded-xl" />
                <Skeleton className="h-10 sm:h-12 w-full rounded-xl" />
                <Skeleton className="h-10 sm:h-12 w-full rounded-xl" />
              </div>
            </div>
          </div>
        </div>
        <div className="p-4 sm:p-6 flex-grow">
    <div className="space-y-4" dir={direction}>
            <Skeleton className="h-6 sm:h-8 w-full rounded-xl" />
            <Skeleton className="h-24 sm:h-32 w-full rounded-xl" />
            <Skeleton className="h-16 sm:h-24 w-full rounded-xl" />
          </div>
        </div>
      </Card>
    );
  }

  return (
    <TooltipProvider>
      <Card
        dir={direction}
        id="profile-card-container"
        className={cn(
          'w-full h-full overflow-hidden flex flex-col max-w-full min-w-0',
          `bg-gradient-to-br ${THEME.colors.neutral.elegant}`,
          THEME.shadows.elegant,
          '[&_*]:box-border [&_*]:max-w-full',
          className
        )}
        style={{
          textAlign: direction === 'rtl' ? 'right' : 'left',
          overflow: 'hidden',
        }}
      >
        {isDesktop && onClose && (
          <div
            className={cn(
              'absolute top-4 z-40',
              direction === 'rtl' ? 'left-4' : 'right-4'
            )}
          >
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="ghost"
                  size="icon"
                  className={cn(
                    'text-gray-600 hover:text-gray-800 bg-white/80 hover:bg-white/90 rounded-full shadow-lg hover:shadow-xl transition-all duration-300',
                    'w-10 h-10 sm:w-12 sm:h-12 min-h-[44px] min-w-[44px]'
                  )}
                  onClick={handleClose}
                >
                  <X className="w-4 h-4 sm:w-5 sm:h-5" />
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>{displayDict.mobileNav.closePreview}</p>
              </TooltipContent>
            </Tooltip>
          </div>
        )}

        {isDesktop ? (
          <ResizablePanelGroup
            direction="horizontal"
            dir={direction}
            className="flex-grow min-h-0 max-w-full"
          >
            <ResizablePanel
              defaultSize={60}
              minSize={40}
              className="min-w-0 flex flex-col max-w-full overflow-hidden"
            >
              <ScrollArea className="flex-1 min-h-0 max-w-full">
                <ProfileHeader
                  profile={profile}
                  age={age}
                  mainImageToDisplay={mainImageToDisplay}
                  availability={availability}
                  viewMode={viewMode}
                  onSuggestClick={() => setIsSuggestDialogOpen(true)}
                  selectedPalette={selectedPalette}
                  onPaletteChange={setSelectedPalette}
                  THEME={THEME}
                  dict={displayDict}
                  characterTraitMap={characterTraitMap}
                  hobbiesMap={hobbiesMap}
                  religiousLevelMap={religiousLevelMap}
                  educationLevelMap={educationLevelMap}
                  locale={locale}
                />
                <div className="p-4 sm:p-6 overflow-hidden flex max-w-full">
                  <MainContentTabs isDesktop={isDesktop} />
                </div>
              </ScrollArea>
            </ResizablePanel>
            <ResizableHandle
              withHandle
              className={cn(
                'bg-gradient-to-b from-rose-200 to-pink-200 hover:from-rose-300 hover:to-pink-300',
                'transition-all duration-300'
              )}
            />
            <ResizablePanel
              defaultSize={40}
              minSize={25}
              className="min-w-0 flex flex-col max-w-full overflow-hidden"
            >
              <ScrollArea className="flex-grow min-h-0 max-w-full">
                <div className="p-4 sm:p-6 space-y-4 sm:space-y-6 min-w-0 max-w-full">
                  <NeshamaTechSummary
                    profile={profile}
                    dict={displayDict}
                    THEME={THEME}
                    direction={direction}
                  />
                  <SectionCard
                    title={displayDict.gallery.title.replace(
                      '{{name}}',
                      profile.user?.firstName || 'המועמד'
                    )}
                    subtitle={displayDict.gallery.subtitle}
                    icon={Camera}
                    variant="elegant"
                    gradient={THEME.colors.primary.main}
                    className="min-w-0 max-w-full"
                  >
                    {orderedImages.length > 0 ? (
                      <div className="space-y-4 min-w-0 max-w-full">
                        <div
                          className={cn(
                            'relative aspect-video rounded-2xl overflow-hidden cursor-pointer group border-2 sm:border-3 border-white shadow-lg hover:shadow-xl transition-all duration-300 max-w-full'
                          )}
                          onClick={() =>
                            handleOpenImageDialog(orderedImages[0])
                          }
                        >
                          <Image
                            src={getRelativeCloudinaryPath(
                              orderedImages[0].url
                            )}
                            alt={displayDict.gallery.imageAlt.replace(
                              '{{index}}',
                              '1'
                            )}
                            fill
                            className="object-cover transition-transform duration-500 group-hover:scale-105"
                            sizes="35vw"
                            priority
                          />
                          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <div className="text-center text-white">
                              <Eye className="w-6 h-6 sm:w-8 sm:h-8 mx-auto mb-2" />
                              <p className="font-bold text-sm sm:text-base">
                                {displayDict.gallery.subtitle}
                              </p>
                            </div>
                          </div>
                        </div>
                        {orderedImages.length > 1 && (
                          <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3 min-w-0 max-w-full">
                            {orderedImages.slice(1, 7).map((img, idx) => (
                              <div
                                key={img.id}
                                className={cn(
                                  'relative aspect-square rounded-xl overflow-hidden cursor-pointer border-2 border-transparent hover:border-rose-400 transition-all duration-300 shadow-md hover:shadow-lg max-w-full'
                                )}
                                onClick={() => handleOpenImageDialog(img)}
                              >
                                <Image
                                  src={getRelativeCloudinaryPath(img.url)}
                                  alt={displayDict.gallery.imageAlt.replace(
                                    '{{index}}',
                                    (idx + 2).toString()
                                  )}
                                  fill
                                  className="object-cover hover:scale-110 transition-transform duration-300"
                                  sizes="15vw"
                                />
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    ) : (
                      <EmptyState
                        icon={Camera}
                        title={displayDict.content.emptyStateTitle}
                        description={displayDict.content.emptyStateDescription}
                        variant="romantic"
                        THEME={THEME}
                      />
                    )}
                  </SectionCard>
                </div>
              </ScrollArea>
            </ResizablePanel>
          </ResizablePanelGroup>
        ) : (
          <div className="flex flex-col h-full w-full max-w-full min-w-0 overflow-hidden">
            <MobileHeader />
            {mobileViewLayout === 'detailed' ? (
              <DetailedMobileLayout />
            ) : (
              <FocusMobileLayout />
            )}
          </div>
        )}

        <ImageDialogComponent
          selectedImageForDialog={selectedImageForDialog}
          currentDialogImageIndex={currentDialogImageIndex}
          orderedImages={orderedImages}
          onClose={handleCloseImageDialog}
          onNavigate={handleDialogNav}
          onImageSelect={setSelectedImageForDialog}
          dict={displayDict.imageDialog}
          direction={direction}
          THEME={THEME}
        />
      </Card>
    </TooltipProvider>
  );
};

export default ProfileCard;
--- End of Content for ProfileCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\account-settings.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/account-settings.tsx

'use client';

import React, { useState, useEffect, useMemo } from 'react';
import { Languages, User, Mail, Key, Shield, Clock, Eye, EyeOff, CheckCircle, XCircle, Bell, Settings, AlertCircle, Trash2, Loader2 } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { Progress } from '@/components/ui/progress';
import { Switch } from '@/components/ui/switch';
import { toast } from 'sonner';
import { useSession, signOut } from 'next-auth/react';
import { UserRole, UserStatus, Language } from '@prisma/client';
import type { AccountSettingsDict } from '@/types/dictionary';
import type { Locale } from '../../../i18n-config';

interface AccountSettingsProps {
  user: {
    id: string;
    email: string;
    firstName: string;
    lastName: string;
    role: UserRole;
    status: UserStatus;
    isVerified: boolean;
    lastLogin: Date | null;
    createdAt: Date;
    engagementEmailsConsent?: boolean; // שדה חדש
    promotionalEmailsConsent?: boolean; // שדה חדש
    language?: Language;
  };
  dict: AccountSettingsDict;
  locale: Locale;
}

const PASSWORD_MIN_LENGTH = 8;

const AccountSettings: React.FC<AccountSettingsProps> = ({ user: propUser, dict, locale }) => {
  const { data: session, status: sessionStatus, update: updateSession } = useSession();

  // States for consents
  const [engagementConsent, setEngagementConsent] = useState(propUser.engagementEmailsConsent || false);
  const [promotionalConsent, setPromotionalConsent] = useState(propUser.promotionalEmailsConsent || false);
  const [isEngagementLoading, setIsEngagementLoading] = useState(false);
  const [isPromotionalLoading, setIsPromotionalLoading] = useState(false);

  // Other states
  const [preferredLanguage, setPreferredLanguage] = useState<Language>(propUser.language || Language.he);
  const [isLanguageLoading, setIsLanguageLoading] = useState(false);
  const [isChangingPassword, setIsChangingPassword] = useState(false);
  const [isSendingVerification, setIsSendingVerification] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [isDeletingAccount, setIsDeletingAccount] = useState(false);
  const [deleteConfirmText, setDeleteConfirmText] = useState('');
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [verificationCode, setVerificationCode] = useState('');
  const [showCurrentPassword, setShowCurrentPassword] = useState(false);
  const [showNewPassword, setShowNewPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [passwordChangeStep, setPasswordChangeStep] = useState(1);
  const [, setShowVerificationInput] = useState(false);
  const [passwordStrength, setPasswordStrength] = useState(0);
  const [passwordRequirements, setPasswordRequirements] = useState({
    length: false,
    uppercase: false,
    lowercase: false,
    number: false,
  });
  const [activeSection, setActiveSection] = useState<string | null>(null);

  useEffect(() => {
    if (session?.user) {
      if (session.user.language && session.user.language !== preferredLanguage) {
        setPreferredLanguage(session.user.language);
      }
      if (typeof session.user.engagementEmailsConsent === 'boolean' && session.user.engagementEmailsConsent !== engagementConsent) {
        setEngagementConsent(session.user.engagementEmailsConsent);
      }
      if (typeof session.user.promotionalEmailsConsent === 'boolean' && session.user.promotionalEmailsConsent !== promotionalConsent) {
        setPromotionalConsent(session.user.promotionalEmailsConsent);
      }
    }
  }, [session?.user]);

  const canChangePassword = useMemo(() => {
    if (sessionStatus === 'authenticated' && session?.user?.accounts) {
      return session.user.accounts.some((acc) => acc.provider === 'credentials');
    }
    return false;
  }, [session, sessionStatus]);

  useEffect(() => {
    if (!newPassword) {
      setPasswordStrength(0);
      setPasswordRequirements({ length: false, uppercase: false, lowercase: false, number: false });
      return;
    }
    const requirements = {
      length: newPassword.length >= PASSWORD_MIN_LENGTH,
      uppercase: /[A-Z]/.test(newPassword),
      lowercase: /[a-z]/.test(newPassword),
      number: /[0-9]/.test(newPassword),
    };
    setPasswordRequirements(requirements);
    const metRequirements = Object.values(requirements).filter(Boolean).length;
    setPasswordStrength(metRequirements * 25);
  }, [newPassword]);

  const validatePassword = (password: string) => {
    const { requirements } = dict.passwordDialog;
    if (password.length < PASSWORD_MIN_LENGTH) throw new Error(requirements.length.replace('{{count}}', String(PASSWORD_MIN_LENGTH)));
    if (!/[A-Z]/.test(password)) throw new Error(requirements.uppercase);
    if (!/[a-z]/.test(password)) throw new Error(requirements.lowercase);
    if (!/[0-9]/.test(password)) throw new Error(requirements.number);
  };

  const resetPasswordForm = () => {
    setCurrentPassword('');
    setNewPassword('');
    setConfirmPassword('');
    setVerificationCode('');
    setShowVerificationInput(false);
    setIsChangingPassword(false);
    setPasswordChangeStep(1);
    setShowCurrentPassword(false);
    setShowNewPassword(false);
    setShowConfirmPassword(false);
  };

  const sendVerificationEmail = async () => {
    setIsSendingVerification(true);
    try {
      const response = await fetch(`/api/auth/send-verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: propUser.email }),
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to send verification email');
      }
      toast.success(dict.toasts.verificationSentSuccess, {
        description: dict.toasts.verificationSentDesc,
        icon: <Mail className="h-5 w-5 text-blue-500" />,
      });
    } catch (error) {
      toast.error(error instanceof Error ? error.message : dict.toasts.sendVerificationError, {
        description: dict.toasts.sendVerificationDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setIsSendingVerification(false);
    }
  };

  const initiatePasswordChange = async () => {
    if (!currentPassword || !newPassword || !confirmPassword) {
      toast.error(dict.toasts.fillAllFieldsError, { description: dict.toasts.fillAllFieldsDesc, icon: <AlertCircle className="h-5 w-5 text-red-500" /> });
      return;
    }
    if (newPassword !== confirmPassword) {
      toast.error(dict.toasts.passwordsMismatchError, { description: dict.toasts.passwordsMismatchDesc, icon: <AlertCircle className="h-5 w-5 text-red-500" /> });
      return;
    }
    try {
      validatePassword(newPassword);
    } catch (error) {
      toast.error(error instanceof Error ? error.message : dict.toasts.passwordValidationError, {
        description: dict.toasts.passwordValidationDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
      return;
    }
    setIsLoading(true);
    try {
      const response = await fetch(`/api/auth/initiate-password-change`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: propUser.id, currentPassword, newPassword }),
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to initiate password change');
      }
      setPasswordChangeStep(2);
      setShowVerificationInput(true);
      toast.success(dict.toasts.verificationSentSuccess, {
        description: dict.toasts.verificationSentDesc,
        icon: <Mail className="h-5 w-5 text-blue-500" />,
      });
    } catch (error) {
      toast.error(error instanceof Error ? error.message : dict.toasts.initiatePasswordError, {
        description: dict.toasts.initiatePasswordDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setIsLoading(false);
    }
  };

  const completePasswordChange = async () => {
    if (!verificationCode || !/^\d{6}$/.test(verificationCode)) {
      toast.error(dict.toasts.invalidVerificationCode, {
        description: dict.toasts.invalidVerificationCodeDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
      return;
    }
    setIsLoading(true);
    try {
      const response = await fetch(`/api/auth/complete-password-change`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: propUser.id, token: verificationCode, newPassword }),
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to complete password change');
      }
      toast.success(dict.toasts.passwordUpdateSuccess, {
        description: dict.toasts.passwordUpdateSuccessDesc,
        icon: <CheckCircle className="h-5 w-5 text-green-500" />,
      });
      resetPasswordForm();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : dict.toasts.passwordUpdateError, {
        description: dict.toasts.passwordUpdateDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleDeleteAccount = async () => {
    if (deleteConfirmText !== dict.deleteDialog.confirmationPhrase) {
      toast.error(dict.toasts.invalidDeleteConfirmation, {
        description: dict.toasts.invalidDeleteConfirmationDesc.replace('{{phrase}}', dict.deleteDialog.confirmationPhrase),
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
      return;
    }
    setIsLoading(true);
    try {
      const response = await fetch(`/api/auth/delete`, { method: 'DELETE' });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to delete account');
      }
      toast.success(dict.toasts.deleteSuccess, {
        description: dict.toasts.deleteSuccessDesc,
        icon: <CheckCircle className="h-5 w-5 text-green-500" />,
      });
      await signOut({ callbackUrl: '/' });
    } catch (error) {
      toast.error(error instanceof Error ? error.message : dict.toasts.deleteError, {
        description: dict.toasts.deleteErrorDesc,
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleConsentChange = async (consentType: 'engagement' | 'promotional', checked: boolean) => {
    const setLoading = consentType === 'engagement' ? setIsEngagementLoading : setIsPromotionalLoading;
    const setConsent = consentType === 'engagement' ? setEngagementConsent : setPromotionalConsent;
    const previousValue = consentType === 'engagement' ? engagementConsent : promotionalConsent;

    setLoading(true);
    setConsent(checked); // Optimistic UI update

    try {
      const response = await fetch('/api/user/consent-settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ consentType, consentValue: checked }),
      });
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        setConsent(previousValue); // Revert on failure
        throw new Error(result.error || 'Failed to update preferences.');
      }
      
      toast.success(dict.toasts.consentUpdateSuccess, {
        icon: <CheckCircle className="h-5 w-5 text-green-500" />,
      });
      
      await updateSession();
    } catch (error) {
      setConsent(previousValue); // Revert on failure
      toast.error(error instanceof Error ? error.message : dict.toasts.consentUpdateError, {
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setLoading(false);
    }
  };

  const handleLanguageChange = async (newLanguage: Language) => {
    const previousLanguage = preferredLanguage;
    setPreferredLanguage(newLanguage);
    setIsLanguageLoading(true);
    
    try {
      const response = await fetch('/api/user/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ language: newLanguage }),
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to update language.');
      }
      
      await updateSession();
      
      toast.success(dict.toasts.languageUpdateSuccess, {
        icon: <CheckCircle className="h-5 w-5 text-green-500" />,
      });
      
    } catch (error) {
      setPreferredLanguage(previousLanguage);
      toast.error(error instanceof Error ? error.message : dict.toasts.languageUpdateError, {
        icon: <AlertCircle className="h-5 w-5 text-red-500" />,
      });
    } finally {
      setIsLanguageLoading(false);
    }
  };

  const getPasswordStrengthColor = () => {
    if (passwordStrength <= 25) return 'bg-red-500';
    if (passwordStrength <= 50) return 'bg-orange-500';
    if (passwordStrength <= 75) return 'bg-yellow-500';
    return 'bg-green-500';
  };

  const getPasswordStrengthText = () => {
    const { passwordStrength: strengthDict } = dict;
    if (passwordStrength <= 25) return strengthDict.veryWeak;
    if (passwordStrength <= 50) return strengthDict.weak;
    if (passwordStrength <= 75) return strengthDict.medium;
    return strengthDict.strong;
  };

  if (!propUser) {
    return <div>{dict.loadingText}</div>;
  }

  const PasswordRequirement: React.FC<{ label: string; met: boolean }> = ({ label, met }) => (
    <li className={`flex items-center text-xs ${met ? 'text-green-600' : 'text-gray-500'}`}>
      {met ? <CheckCircle className="w-3.5 h-3.5 me-1.5" /> : <XCircle className="w-3.5 h-3.5 me-1.5" />}
      {label}
    </li>
  );

  return (
    <div className="max-w-2xl mx-auto space-y-6" dir={locale === 'he' ? 'rtl' : 'ltr'}>
      <Card
        className={`shadow-md hover:shadow-lg transition-all duration-300 border-t-4 border-blue-600 overflow-hidden relative`}
        onMouseEnter={() => setActiveSection('main')}
        onMouseLeave={() => setActiveSection(null)}
      >
        <div className={`absolute inset-0 bg-gradient-to-r from-blue-50 to-blue-100 opacity-0 transition-opacity duration-500 ${activeSection === 'main' ? 'opacity-60' : ''}`} />
        <CardHeader className="border-b pb-3 relative">
          <CardTitle className="text-xl flex items-center">
            <Settings className="w-5 h-5 text-blue-600 me-2" />
            {dict.cardHeader.title}
          </CardTitle>
          <CardDescription>{dict.cardHeader.description}</CardDescription>
        </CardHeader>
        <CardContent className="divide-y relative">
          <div className="py-4">
            <h3 className="text-base font-semibold flex items-center mb-4">
              <User className="w-4 h-4 text-blue-600 me-2" />
              {dict.sections.personal.title}
            </h3>
            <div className="grid gap-3">
              <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                <User className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-700">{dict.sections.personal.fullNameLabel}</p>
                  <p className="text-base text-gray-800">{propUser.firstName || ''} {propUser.lastName || dict.sections.personal.fullNameNotSet}</p>
                </div>
              </div>
              <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                <Mail className="w-5 h-5 text-blue-600 mt-0.5" />
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between w-full gap-3">
                  <div>
                    <p className="text-sm font-medium text-gray-700">{dict.sections.personal.emailLabel}</p>
                    <p className="text-base text-gray-800">{propUser.email}</p>
                  </div>
                  {!propUser.isVerified && (
                    <Button variant="outline" size="sm" onClick={sendVerificationEmail} disabled={isSendingVerification}>
                      {isSendingVerification ? <Loader2 className="w-4 h-4 me-2 animate-spin" /> : <Mail className="w-4 h-4 me-2" />}
                      {dict.sections.personal.sendVerificationButton}
                    </Button>
                  )}
                </div>
              </div>
            </div>
          </div>

          <div className="py-4">
            <h3 className="text-base font-semibold mb-4 flex items-center">
              <Languages className="w-4 h-4 text-blue-600 me-2" />
              {dict.sections.language.title}
            </h3>
            <div className="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
              <div>
                <Label htmlFor="language-select" className="cursor-pointer text-start">
                  {dict.sections.language.label}
                </Label>
                <p className="text-xs text-gray-600 text-start">{dict.sections.language.description}</p>
              </div>
              <div className="relative">
                <select
                  id="language-select"
                  value={preferredLanguage}
                  onChange={(e) => handleLanguageChange(e.target.value as Language)}
                  disabled={isLanguageLoading}
                  className="w-32 appearance-none rounded-md border border-gray-300 bg-white px-3 py-2 pe-8 text-sm shadow-sm focus:border-cyan-500 focus:outline-none focus:ring-1 focus:ring-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <option value="he">עברית</option>
                  <option value="en">English</option>
                </select>
                {isLanguageLoading && <Loader2 className="absolute top-1/2 end-10 -translate-y-1/2 h-4 w-4 animate-spin text-gray-500 pointer-events-none" />}
              </div>
            </div>
          </div>

          <div className="py-4">
            <h3 className="text-base font-semibold mb-4 flex items-center">
              <Shield className="w-4 h-4 text-blue-600 me-2" />
              {dict.sections.status.title}
            </h3>
            <div className="grid gap-3">
              <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                <Shield className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-700">{dict.sections.status.permissionsLabel}</p>
                  <div className="flex flex-wrap gap-2 mt-1">
                    <Badge variant="outline">{dict.sections.status.roles[propUser.role]}</Badge>
                    <Badge>{dict.sections.status.statuses[propUser.status]}</Badge>
                    <Badge>{propUser.isVerified ? dict.sections.status.verification.verified : dict.sections.status.verification.notVerified}</Badge>
                  </div>
                </div>
              </div>
              <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                <Clock className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-700">{dict.sections.status.timeInfoLabel}</p>
                  <p className="text-gray-800">{dict.sections.status.createdAt} {new Date(propUser.createdAt).toLocaleDateString(locale)}</p>
                  {propUser.lastLogin && <p className="text-gray-800">{dict.sections.status.lastLogin} {new Date(propUser.lastLogin).toLocaleDateString(locale)}</p>}
                </div>
              </div>
            </div>
          </div>

          <div className="py-4">
            <h3 className="text-base font-semibold mb-4 flex items-center">
              <Bell className="w-4 h-4 text-blue-600 me-2" />
              {dict.sections.communication.title}
            </h3>
            <div className="space-y-4">
              <div className="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                <div>
                  <Label htmlFor="engagement-switch" className="cursor-pointer text-start font-medium text-gray-800">
                    {dict.sections.communication.engagement.label}
                  </Label>
                  <p className="text-xs text-gray-600 text-start">{dict.sections.communication.engagement.description}</p>
                </div>
                <Switch
                  id="engagement-switch"
                  checked={engagementConsent}
                  onCheckedChange={(checked) => handleConsentChange('engagement', checked)}
                  disabled={isEngagementLoading}
                />
              </div>
              <div className="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                <div>
                  <Label htmlFor="promotional-switch" className="cursor-pointer text-start font-medium text-gray-800">
                    {dict.sections.communication.promotional.label}
                  </Label>
                  <p className="text-xs text-gray-600 text-start">{dict.sections.communication.promotional.description}</p>
                </div>
                <Switch
                  id="promotional-switch"
                  checked={promotionalConsent}
                  onCheckedChange={(checked) => handleConsentChange('promotional', checked)}
                  disabled={isPromotionalLoading}
                />
              </div>
            </div>
          </div>

          <div className="py-4">
            <div className="flex items-center justify-between mb-4">
              <div className="text-start">
                <h3 className="text-base font-semibold flex items-center">
                  <Key className="w-4 h-4 text-blue-600 me-2" />
                  {dict.sections.security.title}
                </h3>
                <p className="text-sm text-muted-foreground">{dict.sections.security.description}</p>
              </div>
              {sessionStatus !== 'loading' && canChangePassword && (
                <Button variant="outline" size="sm" onClick={() => setIsChangingPassword(true)} disabled={isLoading}>
                  <Key className="w-4 h-4 me-2" />
                  {dict.sections.security.changePasswordButton}
                </Button>
              )}
            </div>
            <div className="grid gap-3">
              <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                <Shield className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-gray-700">{dict.sections.security.accountVerificationLabel}</p>
                  <p className="text-base text-gray-800 flex items-center gap-1">
                    {propUser.isVerified ? <CheckCircle className="w-4 h-4 text-green-600" /> : <XCircle className="w-4 h-4 text-red-600" />}
                    {propUser.isVerified ? dict.sections.status.verification.verified : dict.sections.status.verification.notVerified}
                  </p>
                </div>
              </div>
              {sessionStatus !== 'loading' && !canChangePassword && (
                <div className="bg-gray-50 p-3 rounded-lg flex items-start gap-3">
                  <Key className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-700">{dict.sections.security.passwordManagementLabel}</p>
                    <p className="text-sm text-gray-600">
                      {session?.user?.accounts && session.user.accounts.length > 0
                        ? dict.sections.security.managedByProvider.replace('{{provider}}', session.user.accounts[0].provider)
                        : dict.sections.security.managedExternally}
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="py-4 border-t border-dashed border-red-200">
            <div className="flex items-center justify-between">
              <div className="text-start">
                <h3 className="text-base font-semibold flex items-center text-red-600">
                  <Trash2 className="w-4 h-4 me-2" />
                  {dict.sections.delete.title}
                </h3>
                <p className="text-sm text-muted-foreground">{dict.sections.delete.description}</p>
              </div>
              <Button variant="destructive" size="sm" onClick={() => setIsDeletingAccount(true)} disabled={isLoading}>
                <Trash2 className="w-4 h-4 me-2" />
                {dict.sections.delete.deleteButton}
              </Button>
            </div>
          </div>
        </CardContent>
        <CardFooter className="bg-gradient-to-r from-gray-50 to-white border-t p-4 text-sm text-gray-500 relative">
          <div className="flex items-center">
            <Bell className="w-4 h-4 text-blue-600 me-2" />
            <span>{dict.cardFooter.notice}</span>
          </div>
        </CardFooter>
      </Card>

      {canChangePassword && (
        <Dialog open={isChangingPassword} onOpenChange={(open) => { if (!open) resetPasswordForm(); else setIsChangingPassword(true); }}>
          <DialogContent className="sm:max-w-md" dir={locale === 'he' ? 'rtl' : 'ltr'}>
            <DialogHeader className="text-start">
              <DialogTitle>{dict.passwordDialog.title}</DialogTitle>
              <DialogDescription>
                {passwordChangeStep === 1
                  ? dict.passwordDialog.step1Description
                  : dict.passwordDialog.step2Description.replace('{{email}}', propUser.email)}
              </DialogDescription>
            </DialogHeader>
            {passwordChangeStep === 1 ? (
              <div className="space-y-4 text-start">
                <div className="space-y-2">
                  <Label htmlFor="currentPassword">{dict.passwordDialog.currentPasswordLabel}</Label>
                  <div className="relative">
                    <Input id="currentPassword" type={showCurrentPassword ? 'text' : 'password'} value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} />
                    <Button variant="ghost" size="icon" className="absolute end-1 top-1/2 -translate-y-1/2 h-7 w-7" onClick={() => setShowCurrentPassword(!showCurrentPassword)}>
                      <span className="sr-only">{showCurrentPassword ? dict.passwordDialog.hidePassword : dict.passwordDialog.showPassword}</span>
                      {showCurrentPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="newPassword">{dict.passwordDialog.newPasswordLabel}</Label>
                  <div className="relative">
                    <Input id="newPassword" type={showNewPassword ? 'text' : 'password'} value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
                    <Button variant="ghost" size="icon" className="absolute end-1 top-1/2 -translate-y-1/2 h-7 w-7" onClick={() => setShowNewPassword(!showNewPassword)}>
                      <span className="sr-only">{showNewPassword ? dict.passwordDialog.hidePassword : dict.passwordDialog.showPassword}</span>
                      {showNewPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="confirmPassword">{dict.passwordDialog.confirmPasswordLabel}</Label>
                  <div className="relative">
                    <Input id="confirmPassword" type={showConfirmPassword ? 'text' : 'password'} value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                    <Button variant="ghost" size="icon" className="absolute end-1 top-1/2 -translate-y-1/2 h-7 w-7" onClick={() => setShowConfirmPassword(!showConfirmPassword)}>
                      <span className="sr-only">{showConfirmPassword ? dict.passwordDialog.hidePassword : dict.passwordDialog.showPassword}</span>
                      {showConfirmPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                {newPassword && (
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <p className="text-xs font-medium">{dict.passwordDialog.strengthLabel}</p>
                      <p className={`text-xs font-semibold ${getPasswordStrengthColor().replace('bg-', 'text-')}`}>{getPasswordStrengthText()}</p>
                    </div>
                    <Progress value={passwordStrength} className={`h-1.5 ${getPasswordStrengthColor()}`} />
                    <ul className="grid grid-cols-2 gap-x-4 gap-y-1 mt-2">
                      <PasswordRequirement label={dict.passwordDialog.requirements.length.replace('{{count}}', String(PASSWORD_MIN_LENGTH))} met={passwordRequirements.length} />
                      <PasswordRequirement label={dict.passwordDialog.requirements.uppercase} met={passwordRequirements.uppercase} />
                      <PasswordRequirement label={dict.passwordDialog.requirements.lowercase} met={passwordRequirements.lowercase} />
                      <PasswordRequirement label={dict.passwordDialog.requirements.number} met={passwordRequirements.number} />
                    </ul>
                  </div>
                )}
              </div>
            ) : (
              <div className="space-y-4 text-start">
                <Label htmlFor="verificationCode">{dict.passwordDialog.verificationCodeLabel}</Label>
                <Input id="verificationCode" value={verificationCode} onChange={(e) => setVerificationCode(e.target.value)} placeholder="123456" maxLength={6} />
              </div>
            )}
            <DialogFooter>
              <Button variant="outline" onClick={resetPasswordForm}>{dict.passwordDialog.cancelButton}</Button>
              <Button onClick={passwordChangeStep === 1 ? initiatePasswordChange : completePasswordChange} disabled={isLoading}>
                {isLoading ? <Loader2 className="me-2 h-4 w-4 animate-spin" /> : null}
                {passwordChangeStep === 1 ? dict.passwordDialog.continueButton : dict.passwordDialog.confirmButton}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}

      <Dialog open={isDeletingAccount} onOpenChange={(open) => { if (!open) { setIsDeletingAccount(false); setDeleteConfirmText(''); } else { setIsDeletingAccount(true); } }}>
        <DialogContent className="sm:max-w-md" dir={locale === 'he' ? 'rtl' : 'ltr'}>
          <DialogHeader className="text-start">
            <DialogTitle>{dict.deleteDialog.title}</DialogTitle>
            <DialogDescription>{dict.deleteDialog.description}</DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4 text-start">
            <Label htmlFor="deleteConfirm">{dict.deleteDialog.confirmationLabel} <strong>{dict.deleteDialog.confirmationPhrase}</strong></Label>
            <Input id="deleteConfirm" value={deleteConfirmText} onChange={(e) => setDeleteConfirmText(e.target.value)} placeholder={dict.deleteDialog.confirmationPhrase} />
            {deleteConfirmText && deleteConfirmText !== dict.deleteDialog.confirmationPhrase && <p className="text-xs text-red-600">{dict.deleteDialog.mismatchWarning}</p>}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => { setIsDeletingAccount(false); setDeleteConfirmText(''); }}>{dict.deleteDialog.cancelButton}</Button>
            <Button variant="destructive" onClick={handleDeleteAccount} disabled={isLoading || deleteConfirmText !== dict.deleteDialog.confirmationPhrase}>
              {isLoading ? <><Loader2 className="me-2 h-4 w-4 animate-spin" />{dict.deleteDialog.deletingButton}</> : dict.deleteDialog.deleteButton}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default AccountSettings;
--- End of Content for account-settings.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\constants.ts
--------------------------------------------------------------------------------
Content:
// src/components/profile/constants.ts
import { Heart, User, Users, Scroll, GraduationCap, MapPin } from "lucide-react";

// Keys for WORLDS, titles are now in the dictionary
export const WORLD_KEYS = {
  values: "values",
  personality: "personality",
  relationship: "relationship",
  religion: "religion",
  partner: "partner",
} as const;

export const WORLDS_CONFIG = {
  [WORLD_KEYS.values]: {
    icon: Heart,
    color: "text-pink-500",
    bgColor: "bg-pink-50",
    borderColor: "border-pink-200",
  },
  [WORLD_KEYS.personality]: {
    icon: User,
    color: "text-blue-500",
    bgColor: "bg-blue-50",
    borderColor: "border-blue-200",
  },
  [WORLD_KEYS.relationship]: {
    icon: Users,
    color: "text-purple-500",
    bgColor: "bg-purple-50",
    borderColor: "border-purple-200",
  },
  [WORLD_KEYS.religion]: {
    icon: Scroll,
    color: "text-indigo-500",
    bgColor: "bg-indigo-50",
    borderColor: "border-indigo-200",
  },
  [WORLD_KEYS.partner]: {
    icon: Heart,
    color: "text-red-500",
    bgColor: "bg-red-50",
    borderColor: "border-red-200",
  },
} as const;


// Keys for PROFILE_SECTIONS, titles are in the dictionary
export const PROFILE_SECTION_KEYS = {
  BASIC_INFO: "BASIC_INFO",
  EDUCATION: "EDUCATION",
  LOCATION: "LOCATION",
  FAMILY: "FAMILY",
  PREFERENCES: "PREFERENCES",
} as const;

export const PROFILE_SECTIONS_CONFIG = {
  [PROFILE_SECTION_KEYS.BASIC_INFO]: { icon: User },
  [PROFILE_SECTION_KEYS.EDUCATION]: { icon: GraduationCap },
  [PROFILE_SECTION_KEYS.LOCATION]: { icon: MapPin },
  [PROFILE_SECTION_KEYS.FAMILY]: { icon: Users },
  [PROFILE_SECTION_KEYS.PREFERENCES]: { icon: Heart },
} as const;


// Technical constants (keys or values that don't change with language)
export const CONTACT_PREFERENCE_KEYS = {
  DIRECT: "direct",
  MATCHMAKER: "matchmaker",
  BOTH: "both",
} as const;

// Validation rules (non-translatable)
export const VALIDATION_RULES = {
  AGE: {
    MIN: 18,
    MAX: 99
  },
  HEIGHT: {
    MIN: 100,
    MAX: 250
  },
  NAME: {
    MIN_LENGTH: 2,
    MAX_LENGTH: 50
  }
} as const;
--- End of Content for constants.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\index.ts
--------------------------------------------------------------------------------
Content:
// src/components/shared/profile/index.ts

// Main Components
export { default as ProfileCard } from './ProfileCard';

// Sections
export { default as PhotosSection } from './sections/PhotosSection';
export { default as PreferencesSection } from './sections/PreferencesSection';
export { default as ProfileSection } from './sections/ProfileSection';
export { default as QuestionnaireResponsesSection } from './sections/QuestionnaireResponsesSection';

// Elements
export { default as StatsCard } from './elements/StatsCard';
export { default as VisibilityControl } from './elements/VisibilityControl';
export { default as MinimalCard } from './elements/MinimalCard';

// Types
export * from './types/profile';
export * from './types/questionnaire';
--- End of Content for index.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\utils.ts
--------------------------------------------------------------------------------
Content:
// src/components/profile/utils.ts
import type { UserProfile } from "@/types/next-auth";
import { VALIDATION_RULES } from "./constants";
import { ProfileUtilsDict } from "@/types/dictionary";

export const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

export const formatProfileData = (profile: UserProfile) => {
  return {
    ...profile,
    age: calculateAge(new Date(profile.birthDate)),
    // Add any other formatting needed
  };
};

// The function now returns error keys instead of strings.
// The component calling it will use the key to get the translated message.
export const validateProfileData = (data: Partial<UserProfile>) => {
  const errors: Record<string, string> = {};
  
  if (data.height && (data.height < VALIDATION_RULES.HEIGHT.MIN || data.height > VALIDATION_RULES.HEIGHT.MAX)) {
    errors.height = "heightRange";
  }
  
  return {
    isValid: Object.keys(errors).length === 0,
    errors
  };
};
--- End of Content for utils.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\elements
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\elements\MinimalCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/elements/MinimalCard.tsx
import React from "react";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { User, MapPin, Scroll, Heart } from "lucide-react";
import Image from "next/image";
import { calculateAge } from "../utils";
import type { UserProfile, UserImage } from "@/types/next-auth";
import type { MinimalCardDict } from "@/types/dictionary";

interface MinimalCardProps {
  profile: UserProfile;
  mainImage?: UserImage;
  onClick?: () => void;
  className?: string;
  dict: MinimalCardDict;
}

const MinimalCard: React.FC<MinimalCardProps> = ({
  profile,
  mainImage,
  onClick,
  className = "",
  dict,
}) => {
  const age = calculateAge(new Date(profile.birthDate));
  const userName = profile.user
    ? `${profile.user.firstName} ${profile.user.lastName}`
    : dict.nameNotAvailable;

  return (
    <Card
      onClick={onClick}
      className={`relative overflow-hidden cursor-pointer hover:shadow-md transition-shadow ${className}`}
    >
      <div className="flex gap-4 p-4">
        {/* Profile Image */}
        <div className="relative w-24 h-24 rounded-lg overflow-hidden bg-gray-100">
          {mainImage ? (
            <Image
              src={mainImage.url}
              alt={dict.profileImageAlt}
              fill
              className="object-cover"
              sizes="96px"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center">
              <User className="w-8 h-8 text-gray-400" />
            </div>
          )}
        </div>

        {/* Basic Info */}
        <div className="flex-1 space-y-2">
          <div>
            <h3 className="text-lg font-medium">{userName}</h3>
            <p className="text-sm text-gray-500">
              {dict.yearsOld.replace('{{age}}', age.toString())}
            </p>
          </div>

          <div className="flex flex-wrap gap-2">
            {profile.city && (
              <Badge variant="secondary" className="flex items-center gap-1">
                <MapPin className="w-3 h-3" />
                {profile.city}
              </Badge>
            )}
            {profile.religiousLevel && (
              <Badge variant="secondary" className="flex items-center gap-1">
                <Scroll className="w-3 h-3" />
                {profile.religiousLevel}
              </Badge>
            )}
          </div>

          {/* Availability Status */}
          <div className="flex items-center gap-2 text-sm">
            {profile.availabilityStatus === "AVAILABLE" ? (
              <Badge variant="success" className="flex items-center gap-1">
                <Heart className="w-3 h-3" />
                {dict.available}
              </Badge>
            ) : (
              <Badge variant="secondary" className="flex items-center gap-1">
                <Heart className="w-3 h-3" />
                {dict.inProcess}
              </Badge>
            )}
          </div>
        </div>
      </div>
    </Card>
  );
};

export default MinimalCard;
--- End of Content for MinimalCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\elements\StatsCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/elements/StatsCard.tsx
import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { cn } from '@/lib/utils';
import type { StatsCardDict } from '@/types/dictionary';

interface StatsCardProps {
  icon: React.ElementType;
  title: string;
  value: string | number;
  dict?: StatsCardDict; // Optional dict for specific cases
  progress?: number;
  trend?: { value: number; label: string; isPositive?: boolean };
  variant?: 'default' | 'success' | 'warning' | 'destructive';
  className?: string;
}

const StatsCard: React.FC<StatsCardProps> = ({
  icon: Icon,
  title,
  value,
  dict,
  progress,
  trend,
  variant = 'default',
  className,
}) => {
  const getVariantStyles = () => {
    switch (variant) {
      case 'success':
        return 'bg-emerald-50 dark:bg-emerald-900/20';
      case 'warning':
        return 'bg-amber-50 dark:bg-amber-900/20';
      case 'destructive':
        return 'bg-red-50 dark:bg-red-900/20';
      default:
        return 'bg-card';
    }
  };

  const isAvailabilityStatus = dict && title === dict.availabilityStatusTitle;
  const isAvailable =
    typeof value === 'string' && value.toLowerCase() === 'available';

  const renderValue = () => {
    if (isAvailabilityStatus && dict) {
      const displayValue = isAvailable
        ? dict.availabilityValue.available
        : dict.availabilityValue.unavailable;
      return (
        <div className="mt-1">
          <span
            className={cn(
              'inline-flex px-3 py-1 rounded-full text-sm font-semibold tracking-wide',
              isAvailable
                ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300'
                : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200'
            )}
          >
            {displayValue}
          </span>
        </div>
      );
    }
    return <h3 className="text-2xl font-semibold">{value}</h3>;
  };

  return (
    <Card
      className={cn(
        'hover:shadow-md transition-shadow',
        getVariantStyles(),
        className
      )}
    >
      <CardContent className="p-6">
        <div className="flex items-center space-x-4 rtl:space-x-reverse">
          <div className="p-2 bg-primary/10 rounded-full">
            <Icon className="w-6 h-6 text-primary" />
          </div>
          <div className="flex-1 space-y-1">
            <p className="text-sm text-muted-foreground">{title}</p>
            {renderValue()}
          </div>
        </div>
        {progress !== undefined && (
          <div className="mt-4 space-y-2">
            <Progress
              value={progress}
              className="h-2"
              aria-label={`${title} progress: ${progress}%`}
            />
            <p className="text-sm text-muted-foreground text-right">
              {progress}%
            </p>
          </div>
        )}
        {trend && (
          <div className="mt-4 flex items-center">
            <span
              className={cn(
                'text-sm font-medium',
                trend.isPositive ? 'text-emerald-600' : 'text-red-600'
              )}
            >
              {trend.isPositive ? '+' : '-'}
              {trend.value}%
            </span>
            <span className="text-sm text-muted-foreground mr-2">
              {trend.label}
            </span>
          </div>
        )}
      </CardContent>
    </Card>
  );
};

export default StatsCard;
export type { StatsCardProps };
--- End of Content for StatsCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\elements\VisibilityControl.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/elements/VisibilityControl.tsx
import React from 'react';
import { Eye, EyeOff } from 'lucide-react';
import { Switch } from '@/components/ui/switch';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { cn } from '@/lib/utils';
import type { VisibilityControlDict } from '@/types/dictionary';

interface VisibilityControlProps {
  isVisible: boolean;
  onChange: (isVisible: boolean) => void;
  dict: VisibilityControlDict;
  className?: string;
  disabled?: boolean;
}

const VisibilityControl: React.FC<VisibilityControlProps> = ({
  isVisible,
  onChange,
  dict,
  className,
  disabled = false,
}) => {
  return (
    <div
      className={cn(
        'flex items-center gap-2 bg-secondary/20 p-2 rounded-md',
        disabled && 'opacity-50 cursor-not-allowed',
        className
      )}
    >
      {isVisible ? (
        <Eye className="h-4 w-4 text-primary" aria-hidden="true" />
      ) : (
        <EyeOff className="h-4 w-4 text-muted-foreground" aria-hidden="true" />
      )}

      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <div className="relative">
              <Switch
                checked={isVisible}
                onCheckedChange={onChange}
                disabled={disabled}
                className={cn(
                  'data-[state=checked]:bg-primary',
                  disabled && 'cursor-not-allowed'
                )}
                aria-label={dict.ariaLabel.replace(
                  '{{status}}',
                  isVisible ? 'visible' : 'hidden'
                )}
              />
              <span className="sr-only">
                {isVisible ? dict.srAction.hide : dict.srAction.show}
              </span>
            </div>
          </TooltipTrigger>
          <TooltipContent side="left" className="max-w-[200px]" dir="rtl">
            <p>{isVisible ? dict.tooltip.visible : dict.tooltip.hidden}</p>
            <p className="text-xs text-muted-foreground mt-1">
              {`${dict.tooltip.actionPrefix} ${isVisible ? dict.tooltip.actionHide : dict.tooltip.actionShow}`}
            </p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>
    </div>
  );
};

export default VisibilityControl;
export type { VisibilityControlProps };
--- End of Content for VisibilityControl.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\AIProfileAdvisorDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/advisor/AIProfileAdvisorDialog.tsx
'use client';

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogTrigger,
  DialogClose,
} from '@/components/ui/dialog';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, Sparkles, AlertTriangle, X, Brain, Zap } from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';

import AnalysisResultDisplay from './AnalysisResultDisplay';
import type { AiProfileAnalysisResult } from '@/lib/services/aiService';
import {
  AIAdvisorDialogDict,
  AnalysisResultDisplayDict,
} from '@/types/dictionary';

interface AIProfileAdvisorDialogProps {
  userId: string;
  dict: AIAdvisorDialogDict;
  analysisDict: AnalysisResultDisplayDict;
  locale: string;
}

export const AIProfileAdvisorDialog: React.FC<AIProfileAdvisorDialogProps> = ({
  dict,
  analysisDict,
  locale,
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [analysis, setAnalysis] = useState<AiProfileAnalysisResult | null>(
    null
  );
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const handleGetAnalysis = async () => {
    if (analysis) {
      setIsOpen(true);
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      const response = await fetch('/api/ai/analyze-my-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Error getting profile analysis.');
      }

      setAnalysis(result.data);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'An unexpected error occurred.';
      setError(errorMessage);
      toast.error(dict.toast.errorTitle, {
        description: dict.toast.errorDescription.replace(
          '{{error}}',
          errorMessage
        ),
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
    if (!open) {
      setError(null);
    }
  };

  const handleTriggerClick = () => {
    if (!analysis && !isLoading) {
      handleGetAnalysis();
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>
        <motion.div
          whileHover={{ scale: 1.02, y: -2 }}
          whileTap={{ scale: 0.98 }}
          className="w-full max-w-sm"
        >
          <Button
            onClick={handleTriggerClick}
            variant="outline"
            size="lg"
            className="relative group overflow-hidden w-full rounded-2xl border-2 border-purple-200/60 bg-gradient-to-br from-purple-50 via-pink-50 to-white hover:border-purple-300 transition-all duration-500 shadow-lg hover:shadow-2xl hover:shadow-purple-200/50 py-7"
          >
            {/* Decorative background elements */}
            <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-200/30 to-transparent rounded-full blur-2xl group-hover:scale-150 transition-transform duration-700" />
            <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-pink-200/30 to-transparent rounded-full blur-xl group-hover:scale-125 transition-transform duration-700" />
            
            {/* Content */}
            <div className="relative z-10 flex items-center justify-center gap-3">
              <div className="relative">
                <Sparkles className="w-6 h-6 text-purple-600 transition-all duration-500 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute inset-0 bg-purple-400 rounded-full blur-md opacity-0 group-hover:opacity-30 transition-opacity duration-500" />
              </div>
              <span className="font-semibold text-lg bg-gradient-to-r from-purple-700 via-pink-600 to-purple-700 bg-clip-text text-transparent group-hover:from-purple-800 group-hover:via-pink-700 group-hover:to-purple-800 transition-all duration-300">
                {dict.triggerButton}
              </span>
              <Brain className="w-5 h-5 text-pink-500 opacity-0 group-hover:opacity-100 transition-all duration-300 group-hover:rotate-6" />
            </div>

            {/* Animated gradient overlay */}
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-in-out" />
          </Button>
        </motion.div>
      </DialogTrigger>

      <DialogContent
        className="max-w-4xl w-[95vw] h-[90vh] flex flex-col p-0 border-2 border-purple-100/50 shadow-2xl overflow-hidden bg-gradient-to-br from-white via-purple-50/30 to-pink-50/30"
        dir={direction}
      >
        {/* Decorative background elements */}
        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-200/20 to-transparent rounded-full blur-3xl animate-float-slow" />
        <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-pink-200/20 to-transparent rounded-full blur-2xl animate-float-slow" style={{ animationDelay: '2s' }} />

        <DialogHeader className="relative z-10 p-6 border-b border-purple-100/50 bg-white/80 backdrop-blur-sm">
          <div className="flex justify-between items-start gap-4">
            <DialogClose asChild>
              <motion.button 
                whileHover={{ scale: 1.1, rotate: 90 }}
                whileTap={{ scale: 0.9 }}
                className="rounded-full p-2 text-gray-400 hover:text-gray-700 hover:bg-purple-50 shrink-0 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2"
              >
                <X className="h-5 w-5" />
                <span className="sr-only">{dict.closeButton}</span>
              </motion.button>
            </DialogClose>

            <div className="flex-grow">
              <DialogTitle className="flex items-center gap-3 text-2xl">
                <div className="relative">
                  <div className="absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-xl blur-lg opacity-40" />
                  <div className="relative bg-gradient-to-br from-purple-500 via-pink-500 to-purple-600 p-2.5 rounded-xl shadow-lg">
                    <Sparkles className="w-6 h-6 text-white" />
                  </div>
                </div>
                <span className="bg-gradient-to-r from-purple-700 via-pink-600 to-purple-700 bg-clip-text text-transparent font-bold">
                  {dict.dialogTitle}
                </span>
              </DialogTitle>
              <DialogDescription className="mt-2 text-gray-600 leading-relaxed">
                {dict.dialogDescription}
              </DialogDescription>
            </div>
          </div>
        </DialogHeader>

        <div className="relative z-10 flex-grow overflow-y-auto p-6 md:p-8">
          <AnimatePresence mode="wait">
            {isLoading ? (
              <motion.div
                key="loading"
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ duration: 0.3 }}
                role="status"
                aria-live="polite"
                className="flex flex-col items-center justify-center h-full text-center"
              >
                {/* Loading animation container */}
                <div className="relative mb-8">
                  {/* Animated rings */}
                  <motion.div
                    animate={{ rotate: 360 }}
                    transition={{ duration: 3, repeat: Infinity, ease: "linear" }}
                    className="absolute inset-0 w-32 h-32 rounded-full border-4 border-t-purple-500 border-r-pink-500 border-b-transparent border-l-transparent"
                  />
                  <motion.div
                    animate={{ rotate: -360 }}
                    transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
                    className="absolute inset-2 w-28 h-28 rounded-full border-4 border-t-transparent border-r-pink-400 border-b-purple-400 border-l-transparent"
                  />
                  
                  {/* Central icon */}
                  <div className="relative w-32 h-32 flex items-center justify-center">
                    <motion.div
                      animate={{ 
                        scale: [1, 1.2, 1],
                        rotate: [0, 180, 360]
                      }}
                      transition={{ 
                        duration: 2, 
                        repeat: Infinity,
                        ease: "easeInOut"
                      }}
                      className="bg-gradient-to-br from-purple-500 via-pink-500 to-purple-600 p-4 rounded-2xl shadow-2xl"
                    >
                      <Brain className="w-12 h-12 text-white" />
                    </motion.div>
                  </div>
                </div>

                {/* Loading text */}
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.2 }}
                  className="space-y-3"
                >
                  <p className="text-2xl font-bold bg-gradient-to-r from-purple-700 to-pink-600 bg-clip-text text-transparent">
                    {dict.loadingTitle}
                  </p>
                  <p className="text-gray-600 max-w-md">
                    {dict.loadingDescription}
                  </p>

                  {/* Animated dots */}
                  <div className="flex items-center justify-center gap-2 mt-6">
                    {[0, 0.2, 0.4].map((delay) => (
                      <motion.div
                        key={delay}
                        animate={{ 
                          y: [0, -8, 0],
                          opacity: [0.3, 1, 0.3]
                        }}
                        transition={{
                          duration: 1,
                          repeat: Infinity,
                          delay,
                          ease: "easeInOut"
                        }}
                        className="w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500"
                      />
                    ))}
                  </div>
                </motion.div>
              </motion.div>
            ) : error ? (
              <motion.div
                key="error"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.4 }}
                className="flex flex-col items-center justify-center h-full text-center px-4"
              >
                <div className="relative mb-6">
                  <div className="absolute inset-0 bg-red-400 rounded-full blur-xl opacity-20" />
                  <div className="relative bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-full border-2 border-red-200">
                    <AlertTriangle className="h-16 w-16 text-red-500" />
                  </div>
                </div>

                <Alert 
                  variant="destructive" 
                  className="max-w-md bg-white/90 backdrop-blur-sm border-2 border-red-200 shadow-xl"
                >
                  <AlertTriangle className="h-5 w-5" />
                  <AlertTitle className="text-lg font-bold">
                    {dict.errorAlertTitle}
                  </AlertTitle>
                  <AlertDescription className="space-y-2">
                    <p className="text-sm">{dict.errorAlertDescription}</p>
                    <p className="text-xs text-gray-600 bg-red-50 p-2 rounded-lg mt-2 font-mono">
                      {error}
                    </p>
                  </AlertDescription>
                </Alert>

                <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                  <Button
                    onClick={handleGetAnalysis}
                    variant="outline"
                    className="mt-6 bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 hover:border-purple-400 text-purple-700 font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                  >
                    <Zap className="w-4 h-4 mr-2" />
                    {dict.retryButton}
                  </Button>
                </motion.div>
              </motion.div>
            ) : analysis ? (
              <motion.div
                key="analysis"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.5 }}
              >
                <AnalysisResultDisplay
                  analysis={analysis}
                  dict={analysisDict}
                  locale={locale}
                />
              </motion.div>
            ) : (
              <motion.div
                key="initial"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="flex items-center justify-center h-full"
              >
                <div className="text-center space-y-4">
                  <div className="relative inline-block">
                    <div className="absolute inset-0 bg-gradient-to-br from-purple-300 to-pink-300 rounded-full blur-2xl opacity-30" />
                    <div className="relative bg-gradient-to-br from-purple-100 to-pink-100 p-8 rounded-full border-2 border-purple-200">
                      <Sparkles className="w-16 h-16 text-purple-600" />
                    </div>
                  </div>
                  <p className="text-lg text-gray-600">{dict.initialState}</p>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </DialogContent>

      {/* Custom animations */}
      <style>{`
        @keyframes float-slow {
          0%, 100% {
            transform: translateY(0) translateX(0);
          }
          25% {
            transform: translateY(-20px) translateX(10px);
          }
          50% {
            transform: translateY(0) translateX(20px);
          }
          75% {
            transform: translateY(20px) translateX(10px);
          }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }
      `}</style>
    </Dialog>
  );
};

export default AIProfileAdvisorDialog;
--- End of Content for AIProfileAdvisorDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\AnalysisResultDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/advisor/AnalysisResultDisplay.tsx
'use client';

import React from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  Lightbulb,
  CheckCircle2,
  AlertCircle,
  XCircle,
  User,
  Target,
} from 'lucide-react';
import { AiProfileAnalysisResult } from '@/lib/services/aiService';
import { cn } from '@/lib/utils';
import { AnalysisResultDisplayDict } from '@/types/dictionary';

interface AnalysisResultDisplayProps {
  analysis: AiProfileAnalysisResult;
  dict: AnalysisResultDisplayDict;
  locale: string; // Added locale prop
}

const TipCard: React.FC<{ area: string; tip: string }> = ({ area, tip }) => (
  <div className="p-4 rounded-lg bg-yellow-50/70 border border-yellow-200/80 flex items-start gap-4">
    <div className="flex-shrink-0 mt-1">
      <Lightbulb className="w-5 h-5 text-yellow-600" />
    </div>
    <div>
      <p className="font-semibold text-sm text-yellow-800">{area}</p>
      <p className="text-sm text-yellow-900 mt-1">{tip}</p>
    </div>
  </div>
);

interface ReportItemProps {
  area: string;
  status: 'COMPLETE' | 'PARTIAL' | 'MISSING';
  feedback: string;
  dict: AnalysisResultDisplayDict['completeness']['status'];
}

const ReportItem: React.FC<ReportItemProps> = ({
  area,
  status,
  feedback,
  dict,
}) => {
  const statusConfig = {
    COMPLETE: {
      icon: CheckCircle2,
      color: 'text-green-600',
      text: dict.complete,
    },
    PARTIAL: { icon: AlertCircle, color: 'text-amber-600', text: dict.partial },
    MISSING: { icon: XCircle, color: 'text-red-600', text: dict.missing },
  };

  const { icon: Icon, color, text } = statusConfig[status];

  return (
    <div className="flex items-start gap-3 p-3 border-b last:border-b-0">
      <div className="flex-shrink-0 mt-1">
        <Icon className={cn('w-5 h-5', color)} />
      </div>
      <div className="flex-1">
        <div className="flex justify-between items-center">
          <p className="font-medium text-sm text-slate-800">{area}</p>
          <Badge
            variant="outline"
            className={cn(
              'text-xs font-mono',
              color.replace('text-', 'border-').replace('-600', '-300')
            )}
          >
            {text}
          </Badge>
        </div>
        <p className="text-sm text-slate-600 mt-1">{feedback}</p>
      </div>
    </div>
  );
};

const AnalysisResultDisplay: React.FC<AnalysisResultDisplayProps> = ({
  analysis,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  return (
    <div dir={direction} className="w-full">
      <Tabs defaultValue="summary" className="w-full">
        <TabsList className="grid w-full grid-cols-3 h-auto p-1.5 bg-slate-200/70 rounded-lg">
          <TabsTrigger value="summary">{dict.tabs.summary}</TabsTrigger>
          <TabsTrigger value="completeness">
            {dict.tabs.completeness}
          </TabsTrigger>
          <TabsTrigger value="tips">{dict.tabs.tips}</TabsTrigger>
        </TabsList>

        <div className="mt-4">
          <TabsContent value="summary" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <User className="text-blue-500" />
                  {dict.summary.myPersonalityTitle}
                </CardTitle>
                <CardDescription>
                  {dict.summary.myPersonalityDescription}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">
                  {analysis.personalitySummary}
                </p>
              </CardContent>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Target className="text-green-500" />
                  {dict.summary.lookingForTitle}
                </CardTitle>
                <CardDescription>
                  {dict.summary.lookingForDescription}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">
                  {analysis.lookingForSummary}
                </p>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="completeness">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <CheckCircle2 className="text-indigo-500" />
                  {dict.completeness.title}
                </CardTitle>
                <CardDescription>
                  {dict.completeness.description}
                </CardDescription>
              </CardHeader>
              <CardContent className="p-0">
                <div className="space-y-0 divide-y">
                  {analysis.completenessReport.map((item, index) => (
                    <ReportItem
                      key={index}
                      {...item}
                      dict={dict.completeness.status}
                    />
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="tips">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Lightbulb className="text-yellow-500" />
                  {dict.tips.title}
                </CardTitle>
                <CardDescription>{dict.tips.description}</CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                {analysis.actionableTips.map((tip, index) => (
                  <TipCard key={index} area={tip.area} tip={tip.tip} />
                ))}
              </CardContent>
            </Card>
          </TabsContent>
        </div>
      </Tabs>
    </div>
  );
};

export default AnalysisResultDisplay;
--- End of Content for AnalysisResultDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\BudgetDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/sections/BudgetDisplay.tsx
import React from 'react';
import { Progress } from '@/components/ui/progress';
import { motion } from 'framer-motion';
import type { BudgetDisplayDict } from '@/types/dictionary';

interface BudgetDisplayProps {
  data: Record<string, number>;
  dict: BudgetDisplayDict;
  locale: string; // Added locale prop
}

const BudgetDisplay: React.FC<BudgetDisplayProps> = ({
  data,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  if (!data || typeof data !== 'object' || Array.isArray(data)) {
    return <p className="text-sm text-red-500">{dict.errorInvalidData}</p>;
  }

  const sortedEntries = Object.entries(data)
    .filter(([_, value]) => typeof value === 'number' && value > 0)
    .sort(([, a], [, b]) => b - a);

  if (sortedEntries.length === 0) {
    return (
      <p className="text-sm text-gray-500 italic">{dict.noValuesAllocated}</p>
    );
  }

  const colors = [
    'bg-cyan-500',
    'bg-teal-500',
    'bg-sky-500',
    'bg-indigo-500',
    'bg-purple-500',
    'bg-gray-400',
  ];

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.1 },
    },
  };

  // Adjust animation based on direction
  const itemVariants = {
    hidden: { opacity: 0, x: direction === 'rtl' ? 20 : -20 },
    visible: { opacity: 1, x: 0 },
  };

  return (
    <motion.div
      dir={direction} // Set direction for the whole component
      className="space-y-3 pt-2"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {sortedEntries.map(([label, value], index) => (
        <motion.div key={label} variants={itemVariants}>
          <div className="flex justify-between items-center mb-1 text-sm">
            <span className="font-medium text-gray-700">{label}</span>
            <span className="font-semibold text-cyan-700">{value}%</span>
          </div>
          <Progress
            value={value}
            className="h-2.5 rounded-full bg-gray-200/70"
            indicatorClassName={colors[index % colors.length]}
          />
        </motion.div>
      ))}
    </motion.div>
  );
};

export default BudgetDisplay;
--- End of Content for BudgetDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\CvUploadSection.tsx
--------------------------------------------------------------------------------
Content:
// בקובץ: src/components/profile/sections/CvUploadSection.tsx

'use client';

import React, { useRef, useState } from 'react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { FileText, UploadCloud, Loader2, Trash2, CheckCircle } from 'lucide-react';
import type { CvSectionDict } from '@/types/dictionary'; // ייבוא הטיפוס החדש

interface CvUploadSectionProps {
  cvUrl: string | null | undefined;
  isUploading: boolean;
  onUpload: (file: File) => Promise<void>;
  onDelete: () => Promise<void>;
  disabled?: boolean;
  dict: CvSectionDict; // שימוש בטיפוס המדויק
}

const CvUploadSection: React.FC<CvUploadSectionProps> = ({
  cvUrl,
  isUploading,
  onUpload,
  onDelete,
  disabled = false,
  dict,
}) => {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const validateFile = (file: File): string | null => {
    const validTypes = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
      'application/msword', // .doc
    ];
    const maxSize = 5 * 1024 * 1024; // 5MB

    if (!validTypes.includes(file.type)) {
      return dict.toasts.invalidFileType;
    }
    if (file.size > maxSize) {
      return dict.toasts.fileTooLarge;
    }
    return null;
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const error = validateFile(file);
    if (error) {
      toast.error(error);
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }

    try {
      await onUpload(file);
      toast.success(dict.toasts.uploadSuccess);
    } catch (err) {
      console.error('CV Upload failed:', err);
      toast.error(dict.toasts.uploadError);
    } finally {
        if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const triggerFileInput = () => {
    if (!isUploading && !isDeleting && !disabled) {
      fileInputRef.current?.click();
    }
  };

  const handleDelete = async () => {
    if (isDeleting || disabled) return;
    setIsDeleting(true);
    try {
      await onDelete();
      toast.success(dict.toasts.deleteSuccess);
    } catch (err) {
        console.error('CV Deletion failed:', err);
        toast.error(dict.toasts.deleteError);
    } finally {
      setIsDeleting(false);
    }
  };

  // ✨ פונקציה חכמה לחילוץ שם הקובץ מה-URL
  const getFileNameFromUrl = (url: string) => {
    try {
        // מפענח תווים מיוחדים ב-URL (כמו רווחים %20)
        const decodedUrl = decodeURIComponent(url);
        // לוקח את החלק האחרון של ה-URL אחרי ה-'/'
        const fileNameWithExtension = decodedUrl.split('/').pop()?.split('?')[0];
        // מסיר את התאריך והתווים הייחודיים שהוספנו
        const originalName = fileNameWithExtension?.replace(/-\d{13}$/, '');
        return originalName || 'cv-document';
    } catch {
        return 'cv-document'; // Fallback
    }
  }

  return (
    <div className="p-4 md:p-6 border-t border-gray-200/70">
      <input
        type="file"
        ref={fileInputRef}
        className="hidden"
        accept=".pdf,.doc,.docx"
        onChange={handleFileSelect}
        disabled={isUploading || isDeleting || disabled}
      />
      <h3 className="text-sm font-medium text-gray-700 mb-1">{dict.title}</h3>
      <p className="text-xs text-gray-500 mb-4">{dict.subtitle}</p>
      
      {isUploading ? (
        // --- מצב טעינה ---
        <div className="w-full flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
          <Loader2 className="w-5 h-5 text-cyan-600 animate-spin me-2" />
          <span className="text-sm font-medium text-cyan-700">{dict.uploading}</span>
        </div>
      ) : cvUrl ? (
        // --- ✨ מצב חדש: קובץ קיים ---
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-teal-50/60 border border-teal-200/80 rounded-lg">
          <div className="flex items-center mb-2 sm:mb-0">
            <CheckCircle className="w-5 h-5 text-teal-600 me-2 flex-shrink-0" />
            <div className='flex flex-col'>
                <a 
                  href={cvUrl} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  className="text-sm font-medium text-gray-800 break-all hover:underline"
                  title="לחץ לצפייה בקובץ"
                >
                  {getFileNameFromUrl(cvUrl)}
                </a>
                <Badge variant="secondary" className="mt-1 w-fit bg-teal-100 text-teal-800 text-xs">
                  {dict.successBadge}
                </Badge>
            </div>
          </div>
          {!disabled && (
            <div className="flex gap-2 self-end sm:self-center">
              <Button size="sm" variant="outline" onClick={triggerFileInput} className="text-xs">
                {dict.replaceButton}
              </Button>
              <Button size="sm" variant="destructive" onClick={handleDelete} disabled={isDeleting}>
                {isDeleting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-3 h-3" />}
              </Button>
            </div>
          )}
        </div>
      ) : (
        // --- מצב התחלתי: אין קובץ ---
        <div
          onClick={triggerFileInput}
          className={cn(
            'flex flex-col items-center justify-center text-center p-6 border-2 border-dashed border-gray-300 rounded-lg transition-colors duration-200',
            disabled ? 'bg-gray-100 cursor-not-allowed' : 'hover:border-cyan-400 hover:bg-cyan-50/50 cursor-pointer'
          )}
        >
          <UploadCloud className="w-8 h-8 text-gray-400 mb-2" />
          <span className="text-sm font-semibold text-cyan-700">{dict.uploadButton}</span>
          <span className="text-xs text-gray-500 mt-1">{dict.fileTypes}</span>
        </div>
      )}
    </div>
  );
};

export default CvUploadSection;
--- End of Content for CvUploadSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\NeshmaInsightButton.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/dashboard/NeshmaInsightButton.tsx

'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Sparkles, Loader2, Download, Lock, X } from 'lucide-react';
import { motion } from 'framer-motion';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
// ✨ תיקון: מייבאים את הטיפוס הנכון - TextOptionsLight
import type { TextOptionsLight } from 'jspdf';

interface NeshmaInsightButtonProps {
  userId: string;
  locale: 'he' | 'en';
  completionPercentage: number;
  lastGeneratedAt?: string | null;
  generatedCount?: number;
  dict: {
    buttonText: string;
    buttonSubtitle: string;
    dialogTitle: string;
    generating: string;
    downloadPdf: string;
    close: string;
    lockedTitle?: string;
    lockedDescription?: string;
    alreadyGeneratedToday?: string;
    minimizedButtonText?: string;
  };
}

export const NeshmaInsightButton: React.FC<NeshmaInsightButtonProps> = ({
  userId,
  locale,
  completionPercentage,
  lastGeneratedAt,
  generatedCount = 0,
  dict,
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [insightData, setInsightData] = useState<any>(null);
  const [isMinimized, setIsMinimized] = useState(false);
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const isProfileComplete = completionPercentage >= 100;

  const canGenerateToday = () => {
    if (!lastGeneratedAt) return true;
    const lastGenDate = new Date(lastGeneratedAt);
    const today = new Date();
    const diffTime = today.getTime() - lastGenDate.getTime();
    const diffHours = diffTime / (1000 * 60 * 60);
    return diffHours >= 24;
  };

  const hasGeneratedBefore = generatedCount > 0;
  const canGenerate = isProfileComplete && canGenerateToday();

  useEffect(() => {
    if (hasGeneratedBefore && isProfileComplete) {
      setIsMinimized(true);
    }
  }, [hasGeneratedBefore, isProfileComplete]);

  const handleGenerateInsight = async () => {
    if (!canGenerate) {
      if (!isProfileComplete) {
        toast.error(
          locale === 'he'
            ? 'יש להשלים את הפרופיל ל-100% כדי לקבל את התמונה המלאה'
            : 'Complete your profile to 100% to get your Full Picture'
        );
      } else if (!canGenerateToday()) {
        toast.error(
          locale === 'he'
            ? 'ניתן ליצור את התמונה המלאה פעם אחת ב-24 שעות'
            : 'You can generate your Full Picture once every 24 hours'
        );
      }
      return;
    }

    setIsOpen(true);
    setIsGenerating(true);

    try {
      const response = await fetch('/api/profile/neshama-insight', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, locale }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to generate insight');
      }

      const data = await response.json();
      setInsightData(data.insight);
      toast.success(
        locale === 'he'
          ? 'התמונה המלאה נוצרה בהצלחה!'
          : 'Your Full Picture was generated successfully!'
      );

      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (error: any) {
      console.error('Error generating insight:', error);
      toast.error(
        error.message ||
          (locale === 'he'
            ? 'אירעה שגיאה ביצירת התמונה המלאה'
            : 'Error generating your Full Picture')
      );
      setIsOpen(false);
    } finally {
      setIsGenerating(false);
    }
  };

  if (!isProfileComplete) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
        className="my-6"
      >
        <div className="relative group opacity-60">
          <div className="relative bg-gradient-to-br from-purple-50/50 via-pink-50/50 to-cyan-50/50 rounded-2xl p-4 shadow-md border border-gray-200">
            <div className="flex items-center gap-3">
              <div className="relative">
                <div className="bg-gradient-to-br from-purple-400 via-pink-400 to-cyan-400 p-3 rounded-xl">
                  <Sparkles className="w-6 h-6 text-white" />
                </div>
                <div className="absolute -top-1 -end-1 bg-white rounded-full p-1 shadow-md">
                  <Lock className="w-3 h-3 text-gray-600" />
                </div>
              </div>

              <div className="flex-1">
                <h4 className="text-sm font-bold text-gray-700">
                  {dict.lockedTitle ||
                    (locale === 'he'
                      ? 'התמונה המלאה - נעולה'
                      : 'Full Picture - Locked')}
                </h4>
                <p className="text-xs text-gray-500 mt-0.5">
                  {dict.lockedDescription ||
                    (locale === 'he'
                      ? `השלם את הפרופיל ל-100% כדי לפתוח (כרגע: ${completionPercentage}%)`
                      : `Complete your profile to 100% to unlock (Currently: ${completionPercentage}%)`)}
                </p>
              </div>
            </div>
          </div>
        </div>
      </motion.div>
    );
  }

  if (isMinimized && hasGeneratedBefore) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6, ease: 'easeOut' }}
        className="my-6"
      >
        <div className="relative bg-white/70 rounded-2xl p-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-3 flex-1">
              <div className="bg-gradient-to-br from-purple-500 via-pink-500 to-cyan-500 p-2 rounded-lg">
                <Sparkles className="w-5 h-5 text-white" />
              </div>
              <div>
                <h4 className="text-sm font-semibold text-gray-800">
                  {dict.minimizedButtonText ||
                    (locale === 'he' ? 'התמונה המלאה' : 'Full Picture')}
                </h4>
                <p className="text-xs text-gray-500">
                  {canGenerateToday()
                    ? locale === 'he'
                      ? 'לחץ ליצירת תמונה מעודכנת'
                      : 'Click to generate updated picture'
                    : dict.alreadyGeneratedToday ||
                      (locale === 'he'
                        ? 'נוצרה היום - זמינה מחר'
                        : 'Generated today - Available tomorrow')}
                </p>
              </div>
            </div>
            <Button
              onClick={handleGenerateInsight}
              disabled={!canGenerate}
              size="sm"
              className={cn(
                'gap-1.5 rounded-full text-xs',
                canGenerate
                  ? 'bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-700 hover:to-cyan-700 text-white'
                  : 'bg-gray-200 text-gray-500 cursor-not-allowed'
              )}
            >
              <Sparkles className="w-3.5 h-3.5" />
              {locale === 'he' ? 'צור מחדש' : 'Regenerate'}
            </Button>
          </div>
        </div>

        <Dialog open={isOpen} onOpenChange={setIsOpen}>
          <DialogContent
            className="max-w-4xl max-h-[90vh] overflow-y-auto"
            dir={direction}
          >
            <DialogHeader>
              <DialogTitle className="text-2xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-600 bg-clip-text text-transparent flex items-center gap-2">
                <Sparkles className="w-6 h-6 text-purple-600" />
                {dict.dialogTitle}
              </DialogTitle>
            </DialogHeader>
            {isGenerating ? (
              <div className="flex flex-col items-center justify-center py-12 space-y-4">
                <Loader2 className="w-16 h-16 text-purple-600 animate-spin" />
                <p className="text-lg text-gray-600">{dict.generating}</p>
              </div>
            ) : insightData ? (
              <InsightDisplay data={insightData} locale={locale} dict={dict} />
            ) : null}
          </DialogContent>
        </Dialog>
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.6, ease: 'easeOut' }}
      className="my-6"
    >
      <motion.div
        className="relative cursor-pointer"
        onClick={handleGenerateInsight}
        whileHover={{ scale: 1.02 }}
        whileTap={{ scale: 0.98 }}
      >
        <div className="absolute inset-0 bg-gradient-to-r from-purple-500 via-pink-500 to-cyan-500 rounded-2xl blur-lg opacity-30 animate-pulse" />

        <div className="relative bg-gradient-to-br from-purple-50 via-pink-50 to-cyan-50 rounded-2xl p-5 shadow-lg border border-purple-200">
          <div className="flex items-center gap-4">
            <div className="bg-gradient-to-br from-purple-500 via-pink-500 to-cyan-500 p-3 rounded-xl shadow-md">
              <Sparkles className="w-7 h-7 text-white" />
            </div>

            <div className="flex-1">
              <h4 className="text-lg font-bold text-gray-800">
                {dict.buttonText}
              </h4>
              <p className="text-sm text-gray-600 mt-1">
                {dict.buttonSubtitle}
              </p>
            </div>

            <div className="bg-gradient-to-r from-purple-600 to-cyan-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md">
              {locale === 'he' ? 'צור עכשיו' : 'Generate'}
            </div>
          </div>
        </div>
      </motion.div>

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent
          className="max-w-4xl max-h-[90vh] overflow-y-auto"
          dir={direction}
        >
          <DialogHeader>
            <DialogTitle className="text-2xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-cyan-600 bg-clip-text text-transparent flex items-center gap-2">
              <Sparkles className="w-6 h-6 text-purple-600" />
              {dict.dialogTitle}
            </DialogTitle>
          </DialogHeader>
          {isGenerating ? (
            <div className="flex flex-col items-center justify-center py-12 space-y-4">
              <Loader2 className="w-16 h-16 text-purple-600 animate-spin" />
              <p className="text-lg text-gray-600">{dict.generating}</p>
            </div>
          ) : insightData ? (
            <InsightDisplay data={insightData} locale={locale} dict={dict} />
          ) : null}
        </DialogContent>
      </Dialog>
    </motion.div>
  );
};

interface InsightDisplayProps {
  data: any;
  locale: 'he' | 'en';
  dict: NeshmaInsightButtonProps['dict'];
}

const InsightDisplay: React.FC<InsightDisplayProps> = ({
  data,
  locale,
  dict,
}) => {
  return (
    <div className="space-y-6 py-4">
      <InsightSection
        title={locale === 'he' ? '🌟 מי את/ה באמת' : '🌟 Who You Really Are'}
        content={data.whoYouAre}
        bgColor="from-purple-50 to-pink-50"
      />
      <InsightSection
        title={
          locale === 'he'
            ? '💫 השותף/ה שיתאים/תתאים לך'
            : '💫 Your Ideal Partner'
        }
        content={data.idealPartner}
        bgColor="from-pink-50 to-rose-50"
      />
      <InsightSection
        title={
          locale === 'he'
            ? '🎯 איך להתכונן למפגש הראשון'
            : '🎯 Preparing for the First Meeting'
        }
        content={data.firstMeetingTips}
        bgColor="from-rose-50 to-orange-50"
      />
      <InsightSection
        title={
          locale === 'he'
            ? '✨ הפוטנציאל הייחודי שלך'
            : '✨ Your Unique Potential'
        }
        content={data.uniquePotential}
        bgColor="from-blue-50 to-indigo-50"
      />
      <InsightSection
        title={locale === 'he' ? '🚀 הצעדים הבאים שלך' : '🚀 Your Next Steps'}
        content={data.nextSteps}
        bgColor="from-indigo-50 to-purple-50"
      />
      <div className="flex justify-center pt-4">
        <Button
          variant="outline"
          className="gap-2"
          onClick={() => handleDownloadPDF(data, locale)}
        >
          <Download className="w-4 h-4" />
          {dict.downloadPdf}
        </Button>
      </div>
    </div>
  );
};

const InsightSection: React.FC<{
  title: string;
  content: { summary: string; details: string[] };
  bgColor: string;
}> = ({ title, content, bgColor }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className={cn(
        'p-6 rounded-2xl bg-gradient-to-br shadow-md border border-white/50',
        bgColor
      )}
    >
      <h3 className="text-xl font-bold mb-4 text-gray-800">{title}</h3>
      <p className="text-gray-700 leading-relaxed mb-4 text-base">
        {content.summary}
      </p>
      {content.details && content.details.length > 0 && (
        <ul className="space-y-2">
          {content.details.map((detail, index) => (
            <li key={index} className="flex items-start gap-2 text-gray-600">
              <span className="text-purple-600 mt-1">•</span>
              <span className="text-sm leading-relaxed">{detail}</span>
            </li>
          ))}
        </ul>
      )}
    </motion.div>
  );
};

const handleDownloadPDF = async (data: any, locale: 'he' | 'en') => {
  try {
    const { jsPDF } = await import('jspdf');
    toast.info(
      locale === 'he' ? 'מכין את קובץ ה-PDF...' : 'Preparing PDF file...'
    );

    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4',
    });
    const isHebrew = locale === 'he';

    const fontResponse = await fetch('/fonts/Rubik-Regular.ttf');
    if (!fontResponse.ok) {
      throw new Error(
        "Font file not found. Make sure 'Rubik-Regular.ttf' is in the 'public/fonts' directory."
      );
    }
    const fontBlob = await fontResponse.blob();
    const reader = new FileReader();

    const fontPromise = new Promise<string>((resolve, reject) => {
      reader.onloadend = () => {
        if (typeof reader.result === 'string') {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        } else {
          reject('Failed to read font file');
        }
      };
      reader.onerror = reject;
      reader.readAsDataURL(fontBlob);
    });

    const fontBase64 = await fontPromise;
    doc.addFileToVFS('Rubik-Regular.ttf', fontBase64);
    doc.addFont('Rubik-Regular.ttf', 'Rubik', 'normal');
    doc.setFont('Rubik');

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    const maxWidth = pageWidth - margin * 2;
    let yPosition = margin;

    const H1_SIZE = 20,
      H2_SIZE = 14,
      BODY_SIZE = 10;
    const LINE_SPACING_H1 = 15,
      LINE_SPACING_H2 = 7,
      LINE_SPACING_BODY = 5;
    const SECTION_SPACING = 10,
      LIST_INDENT = 5;

    const addPageIfNeeded = () => {
      if (yPosition > pageHeight - 30) {
        doc.addPage();
        yPosition = margin;
      }
    };

    const writeText = (
      text: string | string[],
      x: number,
      y: number,
      options: TextOptionsLight = {}
    ) => {
      let finalOptions: TextOptionsLight = { ...options };
      let finalX = x;
      if (isHebrew) {
        finalOptions = { ...finalOptions, align: 'right' };
        finalX = pageWidth - margin;
      }
      doc.text(text, finalX, y, finalOptions);
    };

    doc.setFontSize(H1_SIZE);
    doc.setFont('Rubik', 'normal');
    const title = isHebrew ? 'התמונה המלאה שלך' : 'Your Full Picture';
    // ✨ תיקון: קוראים לפונקציה הרגילה במקום ישירות ל-doc.text
    writeText(title, pageWidth / 2, yPosition, { align: 'center' });
    yPosition += LINE_SPACING_H1;

    doc.setLineWidth(0.5);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += SECTION_SPACING;

    const addSection = (
      title: string,
      content: { summary: string; details: string[] }
    ) => {
      addPageIfNeeded();
      doc.setFontSize(H2_SIZE);
      writeText(title, margin, yPosition);
      yPosition += LINE_SPACING_H2;

      doc.setFontSize(BODY_SIZE);
      const summaryLines = doc.splitTextToSize(content.summary, maxWidth);
      addPageIfNeeded();
      writeText(summaryLines, margin, yPosition);
      yPosition += summaryLines.length * LINE_SPACING_BODY + 5;

      if (content.details && content.details.length > 0) {
        content.details.forEach((detail: string) => {
          addPageIfNeeded();
          const detailText = `•  ${detail}`;
          const detailLines = doc.splitTextToSize(
            detailText,
            maxWidth - LIST_INDENT
          );
          const detailX = isHebrew
            ? pageWidth - margin - LIST_INDENT
            : margin + LIST_INDENT;
          // ✨ תיקון: מסירים את המאפיין lang שלא נתמך
          const detailOptions: TextOptionsLight = isHebrew
            ? { align: 'right' }
            : {};
          doc.text(detailLines, detailX, yPosition, detailOptions);
          yPosition += detailLines.length * LINE_SPACING_BODY + 3;
        });
      }
      yPosition += SECTION_SPACING;
    };

    const sections = [
      {
        title: isHebrew ? '🌟 מי את/ה באמת' : '🌟 Who You Really Are',
        content: data.whoYouAre,
      },
      {
        title: isHebrew
          ? '💫 השותף/ה שיתאים/תתאים לך'
          : '💫 Your Ideal Partner',
        content: data.idealPartner,
      },
      {
        title: isHebrew
          ? '🎯 איך להתכונן למפגש הראשון'
          : '🎯 Preparing for the First Meeting',
        content: data.firstMeetingTips,
      },
      {
        title: isHebrew
          ? '✨ הפוטנציאל הייחודי שלך'
          : '✨ Your Unique Potential',
        content: data.uniquePotential,
      },
      {
        title: isHebrew ? '🚀 הצעדים הבאים שלך' : '🚀 Your Next Steps',
        content: data.nextSteps,
      },
    ];
    sections.forEach((section) => addSection(section.title, section.content));

    const pageCount = (doc.internal as any).getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      const footerText = isHebrew
        ? 'נוצר על ידי NeshamaTech - מערכת שידוכים מתקדמת'
        : 'Created by NeshamaTech - Advanced Matchmaking System';
      doc.setFontSize(8);
      doc.setTextColor(150);
      // ✨ תיקון: משתמשים ב-TextOptionsLight
      const footerOptions: TextOptionsLight = { align: 'center' };
      doc.text(footerText, pageWidth / 2, pageHeight - 10, footerOptions);
    }

    const filename = isHebrew ? 'התמונה-המלאה-שלי.pdf' : 'my-full-picture.pdf';
    doc.save(filename);

    toast.success(
      isHebrew ? 'הקובץ הורד בהצלחה!' : 'File downloaded successfully!'
    );
  } catch (error) {
    console.error('Error generating PDF:', error);
    toast.error(locale === 'he' ? 'שגיאה ביצירת PDF' : 'Error generating PDF');
  }
};
--- End of Content for NeshmaInsightButton.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\PhotosSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/sections/PhotosSection.tsx

'use client';

import React, { useRef, useState, useEffect, useCallback } from 'react';
import Image from 'next/image';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
// UI Components
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogDescription,
  DialogHeader,
  DialogFooter,
} from '@/components/ui/dialog';
import { toast } from 'sonner';

// Icons
import {
  Camera,
  Star,
  Loader2,
  ChevronLeft,
  ChevronRight,
  Upload,
  Trash2,
  X,
  CheckCircle2,
  MinusSquare,
} from 'lucide-react';

// Types
import type { UserImage } from '@/types/next-auth';
import { PhotosSectionDict } from '@/types/dictionary';

interface PhotosSectionProps {
  images: UserImage[];
  isUploading: boolean;
  disabled?: boolean;
  maxImages?: number;
  onUpload: (files: File[]) => Promise<void>;
  onSetMain: (imageId: string) => Promise<void>;
  onDelete: (imageIds: string[]) => Promise<void>;
  dict: PhotosSectionDict;
  locale: string; // Prop for language to determine direction
}

const PhotosSection: React.FC<PhotosSectionProps> = ({
  images,
  isUploading: isExternallyUploading,
  disabled = false,
  maxImages = 5,
  onUpload,
  onSetMain,
  onDelete,
  dict,
  locale,
}) => {
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [showImageViewer, setShowImageViewer] = useState(false);
  const [selectedViewerIndex, setSelectedViewerIndex] = useState<number | null>(
    null
  );
  const [isProcessing, setIsProcessing] = useState(false);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [imageToDelete, setImageToDelete] = useState<string | null>(null);
  const [uploadingFiles, setUploadingFiles] = useState<string[]>([]);
  const [selectionMode, setSelectionMode] = useState(false);
  const [selectedImageIds, setSelectedImageIds] = useState<Set<string>>(
    new Set()
  );

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const isLoading =
    isExternallyUploading || isProcessing || uploadingFiles.length > 0;

  const validateFiles = (
    files: FileList | File[]
  ): { validFiles: File[]; errors: string[] } => {
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    const validFiles: File[] = [];
    const errors: string[] = [];
    Array.from(files).forEach((file) => {
      if (!validTypes.includes(file.type)) {
        errors.push(
          dict.toasts.invalidFileTypeError.replace('{{fileName}}', file.name)
        );
        return;
      }
      if (file.size > maxSize) {
        errors.push(
          dict.toasts.fileTooLargeError.replace('{{fileName}}', file.name)
        );
        return;
      }
      validFiles.push(file);
    });
    return { validFiles, errors };
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const remainingSlots = maxImages - images.length;
    if (remainingSlots <= 0) {
      toast.error(dict.toasts.maxImagesError);
      return;
    }
    if (files.length > remainingSlots) {
      toast.error(
        dict.toasts.slotsError.replace('{{count}}', remainingSlots.toString())
      );
      return;
    }
    if (isLoading) return;

    const { validFiles, errors } = validateFiles(files);
    if (errors.length > 0) {
      errors.forEach((error) => toast.error(error));
    }
    if (validFiles.length === 0) return;

    setUploadingFiles(validFiles.map((f) => f.name));
    try {
      await onUpload(validFiles);
      toast.success(
        dict.toasts.uploadSuccess.replace(
          '{{count}}',
          validFiles.length.toString()
        )
      );
    } catch (error) {
      console.error('Error during upload process:', error);
      toast.error(dict.toasts.uploadError);
    } finally {
      setUploadingFiles([]);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const triggerFileInput = () => {
    if (!isLoading && !disabled && images.length < maxImages) {
      fileInputRef.current?.click();
    }
  };

  const handleToggleSelectionMode = () => {
    setSelectionMode((prev) => !prev);
    setSelectedImageIds(new Set());
  };

  const handleSelectAll = () => {
    if (selectedImageIds.size === images.length) {
      setSelectedImageIds(new Set());
    } else {
      setSelectedImageIds(new Set(images.map((img) => img.id)));
    }
  };

  const toggleImageSelection = (imageId: string) => {
    setSelectedImageIds((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(imageId)) {
        newSet.delete(imageId);
      } else {
        newSet.add(imageId);
      }
      return newSet;
    });
  };

  const handleImageClick = (index: number) => {
    if (selectionMode) {
      toggleImageSelection(images[index].id);
    } else {
      setSelectedViewerIndex(index);
      setShowImageViewer(true);
    }
  };

  const handleBulkDelete = async () => {
    if (selectedImageIds.size === 0) {
      toast.info(dict.toasts.selectOneError);
      return;
    }

    const confirmationMessage = dict.confirmations.bulkDelete.replace(
      '{{count}}',
      selectedImageIds.size.toString()
    );
    if (!window.confirm(confirmationMessage)) {
      return;
    }

    setIsProcessing(true);
    try {
      await onDelete(Array.from(selectedImageIds));
      toast.success(
        dict.toasts.bulkDeleteSuccess.replace(
          '{{count}}',
          selectedImageIds.size.toString()
        )
      );
      setSelectionMode(false);
      setSelectedImageIds(new Set());
    } catch (error) {
      console.error('Error during bulk delete:', error);
      toast.error(dict.toasts.bulkDeleteError);
    } finally {
      setIsProcessing(false);
    }
  };

  const requestDelete = (imageId: string, event?: React.MouseEvent) => {
    event?.stopPropagation();
    if (isLoading) return;
    setImageToDelete(imageId);
    setDeleteConfirmOpen(true);
  };

  const confirmDelete = async () => {
    if (!imageToDelete || isProcessing) return;
    setIsProcessing(true);
    try {
      await onDelete([imageToDelete]);
      toast.success(dict.toasts.singleDeleteSuccess);
      closeImageViewer();
      setDeleteConfirmOpen(false);
      setImageToDelete(null);
    } catch (error) {
      console.error('Error deleting image:', error);
      toast.error(dict.toasts.singleDeleteError);
    } finally {
      setIsProcessing(false);
    }
  };

  const closeImageViewer = useCallback(() => {
    setShowImageViewer(false);
    setSelectedViewerIndex(null);
  }, []);

  const handleNextImage = useCallback(
    () =>
      setSelectedViewerIndex((prev) =>
        prev === null || prev >= images.length - 1 ? 0 : prev + 1
      ),
    [images.length]
  );
  const handlePreviousImage = useCallback(
    () =>
      setSelectedViewerIndex((prev) =>
        prev === null || prev <= 0 ? images.length - 1 : prev - 1
      ),
    [images.length]
  );

  const handleSetMainImage = async (
    imageId: string,
    showToast = true,
    event?: React.MouseEvent
  ) => {
    event?.stopPropagation();
    if (isLoading) return;
    const currentImage = images.find((img) => img.id === imageId);
    if (!currentImage || currentImage.isMain) return;
    setIsProcessing(true);
    try {
      await onSetMain(imageId);
      if (showToast) toast.success(dict.toasts.setMainSuccess);
    } catch (error) {
      console.error('Error setting main image:', error);
      toast.error(dict.toasts.setMainError);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleControlClick = (e: React.MouseEvent) => e.stopPropagation();

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!showImageViewer) return;
      if (direction === 'rtl') {
        if (e.key === 'ArrowRight') handlePreviousImage();
        if (e.key === 'ArrowLeft') handleNextImage();
      } else {
        if (e.key === 'ArrowRight') handleNextImage();
        if (e.key === 'ArrowLeft') handlePreviousImage();
      }
      if (e.key === 'Escape') closeImageViewer();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [
    showImageViewer,
    handlePreviousImage,
    handleNextImage,
    closeImageViewer,
    direction,
  ]);

  const getRemainingSlots = () => maxImages - images.length;

  return (
    <div
      dir={direction}
      className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-6 md:p-8"
    >
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 pb-4 border-b border-gray-200/80">
        {!selectionMode ? (
          <>
            <div
              className={cn(
                'mb-3 sm:mb-0',
                direction === 'rtl' ? 'text-right' : 'text-left'
              )}
            >
              <h2 className="text-xl font-semibold text-gray-800">
                {dict.title}
              </h2>
              <p className="mt-1 text-sm text-gray-600">
                {dict.subtitle.replace('{{maxImages}}', maxImages.toString())}
              </p>
              {uploadingFiles.length > 0 && (
                <p className="mt-2 text-sm text-cyan-600 font-medium">
                  {dict.uploadingMultiple.replace(
                    '{{count}}',
                    uploadingFiles.length.toString()
                  )}
                </p>
              )}
            </div>
            <div className="flex gap-2 self-end sm:self-center">
              {images.length > 0 && !disabled && (
                <Button
                  variant="outline"
                  onClick={handleToggleSelectionMode}
                  className="rounded-full px-4 text-sm"
                >
                  {dict.selectForDeletion}
                </Button>
              )}
              {!disabled && (
                <Button
                  variant="outline"
                  onClick={triggerFileInput}
                  disabled={isLoading || images.length >= maxImages}
                  className="rounded-full border-2 border-cyan-300 text-cyan-700 hover:bg-cyan-50/50 hover:border-cyan-400 transition-all duration-300 px-5 py-2.5 text-sm font-medium flex items-center gap-2"
                >
                  {isExternallyUploading || uploadingFiles.length > 0 ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Upload className="w-4 h-4" />
                  )}
                  <span>{dict.uploadButton}</span>
                </Button>
              )}
            </div>
          </>
        ) : (
          <div className="w-full flex justify-between items-center">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={handleToggleSelectionMode}
                className="rounded-full text-gray-600 hover:bg-gray-100"
              >
                <X className="w-5 h-5" />
              </Button>
              <span className="font-semibold text-gray-700">
                {dict.selectionHeader.replace(
                  '{{count}}',
                  selectedImageIds.size.toString()
                )}
              </span>
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={handleSelectAll}
                className="rounded-full px-4 text-sm"
              >
                {selectedImageIds.size === images.length
                  ? dict.deselectAll
                  : dict.selectAll}
              </Button>
              <Button
                variant="destructive"
                onClick={handleBulkDelete}
                disabled={isProcessing || selectedImageIds.size === 0}
                className="rounded-full px-4 text-sm flex items-center gap-2"
              >
                {isProcessing ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Trash2 className="w-4 h-4" />
                )}
                {dict.deleteSelected}
              </Button>
            </div>
          </div>
        )}
      </div>

      <input
        type="file"
        ref={fileInputRef}
        className="hidden"
        accept="image/jpeg,image/png,image/jpg,image/webp"
        onChange={handleFileSelect}
        disabled={isLoading || disabled || images.length >= maxImages}
        multiple
      />

      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5">
        {images.map((image, index) => (
          <div
            key={image.id}
            role="button"
            tabIndex={0}
            aria-pressed={
              selectionMode ? selectedImageIds.has(image.id) : undefined
            }
            aria-label={`${dict.selectForDeletion} ${index + 1}`}
            className={cn(
              'relative group aspect-square rounded-xl overflow-hidden bg-gray-100 shadow-md transition-all duration-300 ease-in-out',
              selectionMode
                ? 'cursor-pointer'
                : 'cursor-pointer hover:shadow-lg',
              selectedImageIds.has(image.id) &&
                'ring-4 ring-offset-2 ring-cyan-500'
            )}
            onClick={() => handleImageClick(index)}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleImageClick(index);
              }
            }}
          >
            <Image
              src={getRelativeCloudinaryPath(image.url)}
              alt={`${dict.title} ${index + 1}`}
              fill
              className={cn(
                'object-cover transition-transform duration-300',
                !selectionMode && 'group-hover:scale-105'
              )}
              sizes="(max-width: 640px) 50vw, (max-width: 768px) 33vw, (max-width: 1024px) 25vw, 20vw"
              priority={index < 2}
            />
            {selectionMode && (
              <div className="absolute inset-0 bg-black/30 flex items-center justify-center transition-opacity opacity-0 group-hover:opacity-100">
                {selectedImageIds.has(image.id) ? (
                  <CheckCircle2 className="w-10 h-10 text-white drop-shadow-lg" />
                ) : (
                  <MinusSquare className="w-10 h-10 text-white/70 drop-shadow-lg" />
                )}
              </div>
            )}
            {!disabled && !selectionMode && (
              <div
                className={cn(
                  'absolute top-2 z-10 flex gap-1.5 opacity-85 group-hover:opacity-100 transition-opacity duration-200',
                  direction === 'rtl' ? 'left-2' : 'right-2'
                )}
                onClick={handleControlClick}
              >
                <Button
                  variant="secondary"
                  size="icon"
                  className={cn(
                    'w-8 h-8 rounded-full shadow-md border border-white/30 bg-black/40 text-white hover:bg-black/60 transition-colors',
                    image.isMain ? 'cursor-default' : 'hover:text-yellow-300'
                  )}
                  onClick={(e) => handleSetMainImage(image.id, true, e)}
                  disabled={image.isMain || isLoading}
                  title={image.isMain ? dict.mainBadge : dict.setAsMainTooltip}
                  aria-label={`${dict.setAsMainTooltip} ${index + 1}`}
                >
                  <Star
                    className={cn(
                      'w-4 h-4 transition-colors',
                      image.isMain
                        ? 'text-yellow-400 fill-yellow-400'
                        : 'text-white'
                    )}
                  />
                </Button>
                <Button
                  variant="secondary"
                  size="icon"
                  className="w-8 h-8 rounded-full shadow-md border border-white/30 bg-black/40 text-white hover:bg-red-600 hover:border-red-700 transition-colors"
                  onClick={(e) => requestDelete(image.id, e)}
                  disabled={isLoading}
                  title={dict.deleteTooltip}
                  aria-label={`${dict.deleteTooltip} ${index + 1}`}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            )}
            {image.isMain && !selectionMode && (
              <Badge
                className={cn(
                  'absolute bottom-2 rounded-full px-2.5 py-0.5 text-xs font-medium shadow-md text-white bg-gradient-to-r from-cyan-500 to-pink-500 border-none',
                  direction === 'rtl' ? 'right-2' : 'left-2'
                )}
              >
                {dict.mainBadge}
              </Badge>
            )}
          </div>
        ))}

        {!disabled && !selectionMode && images.length < maxImages && (
          <div
            onClick={triggerFileInput}
            className="flex flex-col items-center justify-center text-center p-4 aspect-square rounded-xl border-2 border-dashed border-cyan-300/70 bg-cyan-50/30 hover:bg-cyan-50/60 hover:border-cyan-400 transition-colors duration-300 cursor-pointer group"
          >
            <Upload className="w-8 h-8 text-cyan-500 mb-2 transition-transform group-hover:scale-110" />
            <span className="text-sm font-medium text-cyan-700">
              {dict.uploadPlaceholder.title}
            </span>
            <span className="text-xs text-cyan-600/90 mt-1">
              {dict.uploadPlaceholder.remaining.replace(
                '{{count}}',
                getRemainingSlots().toString()
              )}
            </span>
            <span className="text-xs text-cyan-500/80 mt-1">
              {dict.uploadPlaceholder.prompt}
            </span>
          </div>
        )}

        {uploadingFiles.map((_, index) => (
          <div
            key={`uploading-${index}`}
            className="relative aspect-square rounded-xl overflow-hidden bg-gray-200 shadow-md"
          >
            <div className="absolute inset-0 flex flex-col items-center justify-center">
              <Loader2 className="w-8 h-8 text-cyan-500 animate-spin mb-2" />
              <span className="text-xs text-gray-600 text-center px-2">
                {dict.uploadingPlaceholder}
              </span>
            </div>
            <div className="absolute bottom-0 left-0 right-0 bg-cyan-500 h-1 animate-pulse"></div>
          </div>
        ))}
      </div>

      {images.length === 0 &&
        uploadingFiles.length === 0 &&
        !disabled &&
        !selectionMode && (
          <div className="text-center py-16 mt-6 bg-gradient-to-br from-cyan-50/20 to-pink-50/20 rounded-xl border border-dashed border-gray-300">
            <Camera className="w-12 h-12 mx-auto text-gray-400/80" />
            <p className="mt-4 text-gray-600 font-medium">
              {dict.emptyState.title}
            </p>
            <p className="text-sm text-gray-500 mt-1 px-4">
              {dict.emptyState.description}
            </p>
          </div>
        )}
      {images.length === 0 && disabled && (
        <div className="text-center py-16 mt-6 bg-gray-50/50 rounded-xl border border-gray-200">
          <Camera className="w-12 h-12 mx-auto text-gray-400" />
          <p className="mt-4 text-gray-500 font-medium">
            {dict.emptyStateDisabled.title}
          </p>
        </div>
      )}

      <Dialog open={deleteConfirmOpen} onOpenChange={setDeleteConfirmOpen}>
        <DialogContent
          className="sm:max-w-md bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border-none p-6"
          dir={direction}
        >
          <DialogHeader>
            <DialogTitle className="text-lg font-semibold text-gray-800">
              {dict.deleteDialog.title}
            </DialogTitle>
            <DialogDescription className="text-sm text-gray-600 mt-2">
              {dict.deleteDialog.description}
            </DialogDescription>
          </DialogHeader>
          <DialogFooter className="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 sm:space-x-reverse gap-2">
            <Button
              type="button"
              variant="outline"
              onClick={() => setDeleteConfirmOpen(false)}
              disabled={isLoading}
              className="rounded-full px-5"
            >
              {dict.deleteDialog.cancel}
            </Button>
            <Button
              type="button"
              variant="destructive"
              onClick={confirmDelete}
              disabled={isLoading}
              className="rounded-full px-5 flex items-center gap-2"
            >
              {isProcessing ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                <Trash2 className="w-4 h-4" />
              )}
              <span>{dict.deleteDialog.confirm}</span>
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <Dialog open={showImageViewer} onOpenChange={setShowImageViewer}>
        <DialogContent
          className="p-0 m-0 w-screen h-screen max-w-none sm:max-w-full sm:h-full bg-black/90 backdrop-blur-sm border-none rounded-none flex items-center justify-center outline-none"
          aria-describedby={undefined}
          dir={direction}
        >
          <Button
            variant="ghost"
            size="icon"
            className={cn(
              'absolute top-4 z-50 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors',
              direction === 'rtl' ? 'right-4' : 'left-4'
            )}
            onClick={closeImageViewer}
            aria-label={dict.imageViewer.closeLabel}
          >
            <X className="w-6 h-6" />
          </Button>
          {selectedViewerIndex !== null && images[selectedViewerIndex] && (
            <div className="relative w-full h-full flex items-center justify-center">
              <div className="relative w-[95%] h-[85%] sm:w-[90%] sm:h-[90%]">
                <Image
                  src={getRelativeCloudinaryPath(
                    images[selectedViewerIndex].url
                  )}
                  alt={dict.imageViewer.altText.replace(
                    '{{index}}',
                    (selectedViewerIndex + 1).toString()
                  )}
                  fill
                  className="object-contain select-none"
                  sizes="90vw"
                  priority
                />
              </div>
              <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
                {images.length > 1 && (
                  <>
                    {/* Previous Button */}
                    <Button
                      variant="ghost"
                      size="icon"
                      className={cn(
                        'absolute top-1/2 transform -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors pointer-events-auto',
                        direction === 'rtl'
                          ? 'right-2 sm:right-4'
                          : 'left-2 sm:left-4'
                      )}
                      onClick={(e) => {
                        e.stopPropagation();
                        handlePreviousImage();
                      }}
                      disabled={selectedViewerIndex === 0}
                      aria-label={dict.imageViewer.prevLabel}
                    >
                      {direction === 'rtl' ? (
                        <ChevronRight className="w-7 h-7" />
                      ) : (
                        <ChevronLeft className="w-7 h-7" />
                      )}
                    </Button>
                    {/* Next Button */}
                    <Button
                      variant="ghost"
                      size="icon"
                      className={cn(
                        'absolute top-1/2 transform -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors pointer-events-auto',
                        direction === 'rtl'
                          ? 'left-2 sm:left-4'
                          : 'right-2 sm:right-4'
                      )}
                      onClick={(e) => {
                        e.stopPropagation();
                        handleNextImage();
                      }}
                      disabled={selectedViewerIndex === images.length - 1}
                      aria-label={dict.imageViewer.nextLabel}
                    >
                      {direction === 'rtl' ? (
                        <ChevronLeft className="w-7 h-7" />
                      ) : (
                        <ChevronRight className="w-7 h-7" />
                      )}
                    </Button>
                  </>
                )}
                {!disabled && (
                  <div
                    className={cn(
                      'absolute top-4 z-50 flex flex-col sm:flex-row gap-2 pointer-events-auto',
                      direction === 'rtl' ? 'left-4' : 'right-4'
                    )}
                  >
                    {!images[selectedViewerIndex].isMain && (
                      <Button
                        variant="secondary"
                        className="rounded-full bg-white/70 backdrop-blur-sm shadow-md hover:bg-white/90 text-gray-800 px-3 py-1.5 text-xs sm:text-sm border border-white/20 flex items-center gap-1.5"
                        onClick={(e) =>
                          handleSetMainImage(
                            images[selectedViewerIndex].id,
                            true,
                            e
                          )
                        }
                        size="sm"
                        disabled={isLoading}
                      >
                        <Star className="w-4 h-4" />
                        <span>{dict.imageViewer.setMainButton}</span>
                      </Button>
                    )}
                    <Button
                      variant="destructive"
                      className="rounded-full bg-red-600/80 hover:bg-red-700 text-white px-3 py-1.5 text-xs sm:text-sm shadow-md border-none flex items-center gap-1.5"
                      onClick={(e) =>
                        requestDelete(images[selectedViewerIndex].id, e)
                      }
                      size="sm"
                      disabled={isLoading}
                    >
                      <Trash2 className="w-4 h-4" />
                      <span>{dict.imageViewer.deleteButton}</span>
                    </Button>
                  </div>
                )}
                {images.length > 0 && (
                  <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/60 text-white px-3 py-1 rounded-full text-xs sm:text-sm font-medium select-none">
                    {dict.imageViewer.counter
                      .replace(
                        '{{current}}',
                        (selectedViewerIndex + 1).toString()
                      )
                      .replace('{{total}}', images.length.toString())}
                  </div>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default PhotosSection;
--- End of Content for PhotosSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\PreferencesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/(authenticated)/profile/components/dashboard/PreferencesSection.tsx
'use client';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Info, XCircle } from 'lucide-react';
import React, { useState, useEffect, useMemo } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Pencil,
  Save,
  X,
  FileText,
  SlidersHorizontal,
  MapPin,
  GraduationCap,
  Users,
  Sparkles,
  Heart,
  Briefcase,
  Shield,
  Palette,
  Smile,
} from 'lucide-react';
import { UserProfile } from '@/types/next-auth';
import { cn } from '@/lib/utils';
import {
  Gender,
  ServiceType,
  HeadCoveringType,
  KippahType,
  ReligiousJourney,
} from '@prisma/client';
import Autocomplete from 'react-google-autocomplete';
import { PreferencesSectionDict } from '@/types/dictionary'; // Assuming this is the correct path

// This would typically come from a context or a hook like `useI18n()`
// For this example, we'll pass it as a prop.
interface PreferencesSectionProps {
  profile: UserProfile | null;
  isEditing: boolean;
  viewOnly?: boolean;
  setIsEditing: (value: boolean) => void;
  onChange: (data: Partial<UserProfile>) => void;
  dictionary: PreferencesSectionDict; // Passing the dictionary as a prop
  locale: string; // Added locale for RTL/LTR support
}

const PreferencesSection: React.FC<PreferencesSectionProps> = ({
  profile,
  isEditing,
  viewOnly = false,
  setIsEditing,
  onChange,
  dictionary: t, // Using 't' as a shorthand for the dictionary
  locale, // Destructure locale
}) => {
  const [formData, setFormData] = useState<Partial<UserProfile>>({});
  const [initialData, setInitialData] = useState<Partial<UserProfile>>({});
  const [locationInputValue, setLocationInputValue] = useState('');
  const [originInputValue, setOriginInputValue] = useState('');

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- Map icons to values for dynamic options ---
  const iconMap: { [key: string]: React.ElementType } = {
    empathetic: Heart,
    driven: Briefcase,
    optimistic: Smile,
    family_oriented: Users,
    intellectual: GraduationCap,
    organized: Palette,
    calm: Heart,
    humorous: Smile,
    sociable: Users,
    sensitive: Heart,
    independent: MapPin,
    creative: Palette,
    honest: Shield,
    responsible: Shield,
    easy_going: Smile,
    no_strong_preference: Sparkles,
    travel: MapPin,
    sports: Briefcase,
    reading: GraduationCap,
    cooking_baking: Palette,
    music_playing_instrument: Palette,
    art_crafts: Palette,
    volunteering: Heart,
    learning_courses: GraduationCap,
    board_games_puzzles: Smile,
    movies_theater: Smile,
    dancing: Users,
    writing: GraduationCap,
    nature_hiking: MapPin,
    photography: Palette,
  };

  // --- Generate options from dictionary ---
  const useGenerateOptions = (
    optionsDict: { [key: string]: string },
    withIcon?: boolean
  ) => {
    return useMemo(
      () =>
        Object.entries(optionsDict).map(([value, label]) => ({
          value,
          label,
          ...(withIcon && { icon: iconMap[value] }),
        })),
      [optionsDict, withIcon]
    );
  };

  const religiousLevelOptions = useGenerateOptions(t.options.religiousLevels);
  const preferredReligiousJourneyOptions = useGenerateOptions(
    t.options.religiousJourneys
  );
  const educationPreferenceOptions = useGenerateOptions(t.options.education);
  const occupationPreferenceOptions = useGenerateOptions(t.options.occupation);
  const preferredShomerNegiahOptions = useGenerateOptions(
    t.options.shomerNegiah
  );
  const preferredPartnerHasChildrenOptions = useGenerateOptions(
    t.options.partnerHasChildren
  );
  const preferredOriginOptions = useGenerateOptions(t.options.origins);
  const preferredAliyaStatusOptions = useGenerateOptions(t.options.aliyaStatus);
  const maritalStatusOptions = useGenerateOptions(t.options.maritalStatus);
  const serviceTypeOptions = useGenerateOptions(t.options.serviceTypes);
  const headCoveringOptions = useGenerateOptions(t.options.headCovering);
  const kippahTypeOptions = useGenerateOptions(t.options.kippahType);
  const characterTraitsOptions = useGenerateOptions(t.options.traits, true);
  const hobbiesOptions = useGenerateOptions(t.options.hobbies, true);


  useEffect(() => {
    if (profile) {
      const nullToUndefined = <T,>(value: T | null): T | undefined =>
        value === null ? undefined : value;

      const newFormData: Partial<UserProfile> = {
        ...profile,
        preferredAgeMin: nullToUndefined(profile.preferredAgeMin),
        preferredAgeMax: nullToUndefined(profile.preferredAgeMax),
        preferredHeightMin: nullToUndefined(profile.preferredHeightMin),
        preferredHeightMax: nullToUndefined(profile.preferredHeightMax),
        matchingNotes: profile.matchingNotes ?? '',
        preferredShomerNegiah: nullToUndefined(profile.preferredShomerNegiah),
        preferredPartnerHasChildren: nullToUndefined(
          profile.preferredPartnerHasChildren
        ),
        preferredAliyaStatus: nullToUndefined(profile.preferredAliyaStatus),
        preferredLocations: profile.preferredLocations ?? [],
        preferredReligiousLevels: profile.preferredReligiousLevels ?? [],
        preferredEducation: profile.preferredEducation ?? [],
        preferredOccupations: profile.preferredOccupations ?? [],
        preferredMaritalStatuses: profile.preferredMaritalStatuses ?? [],
        preferredOrigins: profile.preferredOrigins ?? [],
        preferredServiceTypes: profile.preferredServiceTypes ?? [],
        preferredHeadCoverings: profile.preferredHeadCoverings ?? [],
        preferredKippahTypes: profile.preferredKippahTypes ?? [],
        preferredCharacterTraits: profile.preferredCharacterTraits ?? [],
        preferredHobbies: profile.preferredHobbies ?? [],
        preferredReligiousJourneys: profile.preferredReligiousJourneys ?? [],
      };
      setFormData(newFormData);
      setInitialData(newFormData);
    }
  }, [profile]);

  useEffect(() => {
    if (!isEditing && initialData) {
      setFormData(initialData);
    }
  }, [isEditing, initialData]);

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value, type } = e.target;
    const field = name as keyof UserProfile;

    setFormData((prev) => {
      let processedValue: string | number | undefined;
      if (type === 'number') {
        const num = parseInt(value, 10);
        processedValue = isNaN(num) ? undefined : num;
      } else {
        processedValue = value === '' ? undefined : value;
      }
      return { ...prev, [field]: processedValue };
    });
  };

  const handleSelectChange = (field: keyof UserProfile, value: string) => {
    setFormData((prev) => ({
      ...prev,
      [field]:
        value === '' ||
        value === 'לא_משנה' || // Keep legacy values just in case
        value === 'any' ||
        value === 'no_preference'
          ? undefined
          : (value as UserProfile[typeof field]),
    }));
  };

  const handleMultiSelectChange = (field: keyof UserProfile, value: string) => {
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      let newValues;
      const resetValues = [
        'any',
        'no_preference',
        'לא_משנה',
        'no_strong_preference',
      ];

      if (resetValues.includes(value)) {
        newValues = currentValues.includes(value) ? [] : [value];
      } else {
        const filteredValues = currentValues.filter(
          (v) => !resetValues.includes(v)
        );
        newValues = filteredValues.includes(value)
          ? filteredValues.filter((v) => v !== value)
          : [...filteredValues, value];
      }
      return { ...prev, [field]: newValues };
    });
  };

  const handleAddItemToArray = (field: keyof UserProfile, value: string) => {
    if (!value) return;
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      if (currentValues.includes(value)) {
        return prev;
      }
      return { ...prev, [field]: [...currentValues, value] };
    });
  };

  const handleRemoveItemFromArray = (
    field: keyof UserProfile,
    value: string
  ) => {
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      return {
        ...prev,
        [field]: currentValues.filter((item) => item !== value),
      };
    });
  };

  const handleSave = () => {
    const dataToSave = { ...formData };
    onChange(dataToSave);
    setIsEditing(false);
    setInitialData(dataToSave);
  };

  const handleCancel = () => {
    setFormData(initialData);
    setIsEditing(false);
  };

  const renderMultiSelectBadges = (
    fieldValues: string[] | undefined | null,
    options: { value: string; label: string; icon?: React.ElementType }[],
    badgeClass: string = 'bg-sky-100 text-sky-700',
    emptyPlaceholder: string
  ) => {
    if (!fieldValues || fieldValues.length === 0) {
      return <p className="text-sm text-gray-500 italic">{emptyPlaceholder}</p>;
    }
    return fieldValues.map((value) => {
      const option = options.find((opt) => opt.value === value);
      return option ? (
        <Badge
          key={value}
          variant="secondary"
          className={cn(
            'ltr:mr-1 rtl:ml-1 mb-1 text-xs px-2 py-0.5 rounded-full flex items-center',
            badgeClass
          )}
        >
          {option.icon && <option.icon className="w-3 h-3 ltr:mr-1 rtl:ml-1" />}
          {option.label}
        </Badge>
      ) : null;
    });
  };

  const getSelectDisplayValue = (
    value: string | undefined | null,
    options: { value: string; label: string }[],
    placeholder: string
  ) => {
    if (!value)
      return <span className="text-gray-500 italic">{placeholder}</span>;
    const option = options.find((opt) => opt.value === value);
    return option ? (
      option.label
    ) : (
      <span className="text-gray-500 italic">{placeholder}</span>
    );
  };

  return (
    <div className="relative" dir={direction}>
      <div className="sticky top-4 z-10 bg-gradient-to-b from-white via-white/95 to-white/0 pt-4 pb-3 backdrop-blur-sm">
        <div className="container mx-auto max-w-screen-xl px-4">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-xl md:text-2xl font-bold text-slate-800">
                {t.header.title}
              </h1>
              <p className="text-sm text-slate-500">
                {isEditing && !viewOnly
                  ? t.header.subtitleEdit
                  : t.header.subtitleView}
              </p>
            </div>
            {!viewOnly && (
              <div className="flex gap-2">
                {!isEditing ? (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setIsEditing(true)}
                    className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-cyan-400 text-cyan-700 hover:bg-cyan-50"
                  >
                    <Pencil className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                    {t.buttons.edit}
                  </Button>
                ) : (
                  <>
                    {/* ======================= START: DESKTOP BUTTONS (INSIDE STICKY HEADER) ======================= */}
                    <div className="hidden sm:flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={handleCancel}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50"
                      >
                        <X className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                        {t.buttons.cancel}
                      </Button>
                      <Button
                        variant="default"
                        size="sm"
                        onClick={handleSave}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white"
                      >
                        <Save className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                        {t.buttons.save}
                      </Button>
                    </div>
                    {/* ======================= END: DESKTOP BUTTONS ======================= */}
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      <div className="container mx-auto max-w-screen-xl py-6 px-4">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* --- Column 1 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-slate-50/40 to-gray-100/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <FileText className="w-5 h-5 text-slate-600" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.general.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-5">
                <div>
                  <div className="flex items-center gap-1.5 mb-1.5">
                    <Label
                      htmlFor="matchingNotes"
                      className="text-sm font-medium text-gray-700"
                    >
                      {t.cards.general.notesLabel}
                    </Label>
                    <TooltipProvider delayDuration={100}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="matchingNotes-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="matchingNotes-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                        >
                          <p>{t.cards.general.notesTooltip}</p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </div>
                  {isEditing ? (
                    <Textarea
                      id="matchingNotes"
                      name="matchingNotes"
                      value={formData.matchingNotes || ''}
                      onChange={handleInputChange}
                      placeholder={t.cards.general.notesPlaceholder}
                      className="text-sm focus:ring-cyan-500 min-h-[100px] rounded-lg"
                      rows={4}
                    />
                  ) : (
                    <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[60px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                      {formData.matchingNotes || (
                        <span className="text-gray-500 italic">
                          {t.cards.general.notesEmpty}
                        </span>
                      )}
                    </p>
                  )}
                </div>
           
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-indigo-50/40 to-purple-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <SlidersHorizontal className="w-5 h-5 text-indigo-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.ageAndHeight.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                  <fieldset>
                    <legend className="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-1.5">
                      {t.cards.ageAndHeight.ageLegend}
                      <TooltipProvider delayDuration={100}>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <button
                              type="button"
                              aria-describedby="age-range-tooltip"
                            >
                              <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                            </button>
                          </TooltipTrigger>
                          <TooltipContent id="age-range-tooltip" side="top">
                            <p>{t.cards.ageAndHeight.ageTooltip}</p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                    </legend>
                    <div className="flex items-center gap-2">
                      <Label htmlFor="preferredAgeMin" className="sr-only">
                        {t.cards.ageAndHeight.ageMinPlaceholder}
                      </Label>
                      <Input
                        id="preferredAgeMin"
                        type="number"
                        name="preferredAgeMin"
                        placeholder={t.cards.ageAndHeight.ageMinPlaceholder}
                        value={formData.preferredAgeMin ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                      <span aria-hidden="true" className="text-gray-500">
                        -
                      </span>
                      <Label htmlFor="preferredAgeMax" className="sr-only">
                        {t.cards.ageAndHeight.ageMaxPlaceholder}
                      </Label>
                      <Input
                        id="preferredAgeMax"
                        type="number"
                        name="preferredAgeMax"
                        placeholder={t.cards.ageAndHeight.ageMaxPlaceholder}
                        value={formData.preferredAgeMax ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                    </div>
                    {!isEditing &&
                      !formData.preferredAgeMin &&
                      !formData.preferredAgeMax && (
                        <p className="text-xs text-gray-500 italic mt-1">
                          {t.cards.ageAndHeight.ageEmpty}
                        </p>
                      )}
                  </fieldset>
                  <fieldset>
                    <legend className="block mb-1.5 text-xs font-medium text-gray-600">
                      {t.cards.ageAndHeight.heightLegend}
                    </legend>
                    <div className="flex items-center gap-2">
                      <Label htmlFor="preferredHeightMin" className="sr-only">
                        {t.cards.ageAndHeight.heightMinPlaceholder}
                      </Label>
                      <Input
                        id="preferredHeightMin"
                        type="number"
                        name="preferredHeightMin"
                        placeholder={t.cards.ageAndHeight.heightMinPlaceholder}
                        value={formData.preferredHeightMin ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                      <span aria-hidden="true" className="text-gray-500">
                        -
                      </span>
                      <Label htmlFor="preferredHeightMax" className="sr-only">
                        {t.cards.ageAndHeight.heightMaxPlaceholder}
                      </Label>
                      <Input
                        id="preferredHeightMax"
                        type="number"
                        name="preferredHeightMax"
                        placeholder={t.cards.ageAndHeight.heightMaxPlaceholder}
                        value={formData.preferredHeightMax ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                    </div>
                    {!isEditing &&
                      !formData.preferredHeightMin &&
                      !formData.preferredHeightMax && (
                        <p className="text-xs text-gray-500 italic mt-1">
                          {t.cards.ageAndHeight.heightEmpty}
                        </p>
                      )}
                  </fieldset>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* --- Column 2 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-sky-50/40 to-blue-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <MapPin className="w-5 h-5 text-sky-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.locationAndReligion.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <div>
                  <Label
                    htmlFor="preferred-locations-input"
                    className="block mb-2 text-xs font-medium text-gray-600"
                  >
                    {t.cards.locationAndReligion.locationsLabel}
                  </Label>
                  {isEditing ? (
                    <div className="space-y-2">
                      <div className="flex flex-wrap gap-1.5">
                        {(formData.preferredLocations || []).map((loc) => (
                          <Badge
                            key={loc}
                            variant="secondary"
                            className="bg-sky-100 text-sky-800 rounded-full px-2 py-1 text-sm font-normal"
                          >
                            <span>{loc}</span>
                            <button
                              type="button"
                              className="ltr:mr-1.5 rtl:ml-1.5 text-sky-600 hover:text-sky-900"
                              onClick={() =>
                                handleRemoveItemFromArray(
                                  'preferredLocations',
                                  loc
                                )
                              }
                              aria-label={t.cards.locationAndReligion.locationsRemoveLabel.replace(
                                '{{loc}}',
                                loc
                              )}
                            >
                              <XCircle className="w-3.5 h-3.5" />
                            </button>
                          </Badge>
                        ))}
                      </div>
                      <Autocomplete
                        id="preferred-locations-input"
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                        value={locationInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                          setLocationInputValue(e.target.value)
                        }
                        onPlaceSelected={(place) => {
                          const cityComponent = place.address_components?.find(
                            (component) => component.types.includes('locality')
                          );
                          const selectedCity =
                            cityComponent?.long_name ||
                            place.formatted_address ||
                            '';
                          handleAddItemToArray(
                            'preferredLocations',
                            selectedCity
                          );
                          setLocationInputValue('');
                        }}
                        options={{
                          types: ['(cities)'],
                          componentRestrictions: { country: 'il' },
                        }}
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={
                          t.cards.locationAndReligion.locationsPlaceholder
                        }
                      />
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {!formData.preferredLocations ||
                      formData.preferredLocations.length === 0 ? (
                        <p className="text-sm text-gray-500 italic">
                          {t.cards.locationAndReligion.locationsEmpty}
                        </p>
                      ) : (
                        formData.preferredLocations.map((loc) => (
                          <Badge
                            key={loc}
                            variant="secondary"
                            className="ltr:mr-1 rtl:ml-1 mb-1 bg-sky-100 text-sky-700 text-xs px-2 py-0.5 rounded-full"
                          >
                            {loc}
                          </Badge>
                        ))
                      )}
                    </div>
                  )}
                </div>
                <fieldset>
                  <legend className="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-2">
                    {t.cards.locationAndReligion.religiousLevelsLegend}
                    <TooltipProvider delayDuration={100}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="religious-level-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="religious-level-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                        >
                          <p>
                            {t.cards.locationAndReligion.religiousLevelsTooltip}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {religiousLevelOptions.map((level) => (
                        <Button
                          key={level.value}
                          type="button"
                          variant={
                            (formData.preferredReligiousLevels || []).includes(
                              level.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredReligiousLevels',
                              level.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredReligiousLevels || []).includes(
                              level.value
                            )
                              ? 'bg-pink-500 hover:bg-pink-600 text-white border-pink-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {level.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredReligiousLevels,
                        religiousLevelOptions,
                        'bg-pink-100 text-pink-700',
                        t.cards.locationAndReligion.religiousLevelsEmpty
                      )}
                    </div>
                  )}
                </fieldset>

                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.locationAndReligion.religiousJourneysLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {preferredReligiousJourneyOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (
                              formData.preferredReligiousJourneys || []
                            ).includes(opt.value as ReligiousJourney)
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredReligiousJourneys',
                              opt.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (
                              formData.preferredReligiousJourneys || []
                            ).includes(opt.value as ReligiousJourney)
                              ? 'bg-cyan-500 hover:bg-cyan-600 text-white border-cyan-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredReligiousJourneys as string[],
                        preferredReligiousJourneyOptions,
                        'bg-cyan-100 text-cyan-700',
                        t.cards.locationAndReligion.religiousJourneysEmpty
                      )}
                    </div>
                  )}
                </fieldset>

                <div>
                  <Label
                    htmlFor="preferredShomerNegiah"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.locationAndReligion.shomerNegiahLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredShomerNegiah"
                      value={formData.preferredShomerNegiah || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredShomerNegiah', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredShomerNegiah"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.locationAndReligion.shomerNegiahPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredShomerNegiahOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredShomerNegiah,
                        preferredShomerNegiahOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
                {profile?.gender === Gender.MALE && (
                  <fieldset>
                    <legend className="block mb-2 text-xs font-medium text-gray-600">
                      {t.cards.locationAndReligion.headCoveringLegend}
                    </legend>
                    {isEditing ? (
                      <div className="flex flex-wrap gap-2">
                        {headCoveringOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredHeadCoverings || []).includes(
                                opt.value as HeadCoveringType
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredHeadCoverings',
                                opt.value as HeadCoveringType
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredHeadCoverings || []).includes(
                                opt.value as HeadCoveringType
                              )
                                ? 'bg-purple-500 hover:bg-purple-600 text-white border-purple-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                    ) : (
                      <div className="mt-1 flex flex-wrap gap-1.5">
                        {renderMultiSelectBadges(
                          formData.preferredHeadCoverings as string[],
                          headCoveringOptions,
                          'bg-purple-100 text-purple-700',
                          t.cards.locationAndReligion.headCoveringEmpty
                        )}
                      </div>
                    )}
                  </fieldset>
                )}
                {profile?.gender === Gender.FEMALE && (
                  <fieldset>
                    <legend className="block mb-2 text-xs font-medium text-gray-600">
                      {t.cards.locationAndReligion.kippahTypeLegend}
                    </legend>
                    {isEditing ? (
                      <div className="flex flex-wrap gap-2">
                        {kippahTypeOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredKippahTypes || []).includes(
                                opt.value as KippahType
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredKippahTypes',
                                opt.value as KippahType
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredKippahTypes || []).includes(
                                opt.value as KippahType
                              )
                                ? 'bg-orange-500 hover:bg-orange-600 text-white border-orange-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                    ) : (
                      <div className="mt-1 flex flex-wrap gap-1.5">
                        {renderMultiSelectBadges(
                          formData.preferredKippahTypes as string[],
                          kippahTypeOptions,
                          'bg-orange-100 text-orange-700',
                          t.cards.locationAndReligion.kippahTypeEmpty
                        )}
                      </div>
                    )}
                  </fieldset>
                )}
              </CardContent>
            </Card>
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <GraduationCap className="w-5 h-5 text-teal-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.educationAndCareer.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.educationLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {educationPreferenceOptions.map((edu) => (
                        <Button
                          key={edu.value}
                          type="button"
                          variant={
                            (formData.preferredEducation || []).includes(
                              edu.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredEducation',
                              edu.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredEducation || []).includes(
                              edu.value
                            )
                              ? 'bg-teal-500 hover:bg-teal-600 text-white border-teal-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {edu.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredEducation,
                        educationPreferenceOptions,
                        'bg-teal-100 text-teal-700',
                        t.cards.educationAndCareer.educationEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.occupationLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {occupationPreferenceOptions.map((occ) => (
                        <Button
                          key={occ.value}
                          type="button"
                          variant={
                            (formData.preferredOccupations || []).includes(
                              occ.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredOccupations',
                              occ.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredOccupations || []).includes(
                              occ.value
                            )
                              ? 'bg-green-500 hover:bg-green-600 text-white border-green-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {occ.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredOccupations,
                        occupationPreferenceOptions,
                        'bg-green-100 text-green-700',
                        t.cards.educationAndCareer.occupationEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.serviceTypeLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {serviceTypeOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredServiceTypes || []).includes(
                              opt.value as ServiceType
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredServiceTypes',
                              opt.value as ServiceType
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredServiceTypes || []).includes(
                              opt.value as ServiceType
                            )
                              ? 'bg-lime-500 hover:bg-lime-600 text-white border-lime-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredServiceTypes as string[],
                        serviceTypeOptions,
                        'bg-lime-100 text-lime-700',
                        t.cards.educationAndCareer.serviceTypeEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
          </div>

          {/* --- Column 3 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-rose-50/40 to-fuchsia-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Users className="w-5 h-5 text-rose-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.personalBackground.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.personalBackground.maritalStatusLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {maritalStatusOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredMaritalStatuses || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredMaritalStatuses',
                              opt.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredMaritalStatuses || []).includes(
                              opt.value
                            )
                              ? 'bg-rose-500 hover:bg-rose-600 text-white border-rose-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredMaritalStatuses,
                        maritalStatusOptions,
                        'bg-rose-100 text-rose-700',
                        t.cards.personalBackground.maritalStatusEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <div>
                  <Label
                    htmlFor="preferredPartnerHasChildren"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.personalBackground.partnerHasChildrenLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredPartnerHasChildren"
                      value={formData.preferredPartnerHasChildren || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredPartnerHasChildren', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredPartnerHasChildren"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.personalBackground
                              .partnerHasChildrenPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredPartnerHasChildrenOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredPartnerHasChildren,
                        preferredPartnerHasChildrenOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.personalBackground.originLegend}
                  </legend>
                  {isEditing ? (
                    <div className="space-y-3">
                      <div className="flex flex-wrap gap-2">
                        {preferredOriginOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredOrigins || []).includes(
                                opt.value
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredOrigins',
                                opt.value
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredOrigins || []).includes(
                                opt.value
                              )
                                ? 'bg-fuchsia-500 hover:bg-fuchsia-600 text-white border-fuchsia-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                      <div className="space-y-2">
                        <div className="flex flex-wrap gap-1.5">
                          {(formData.preferredOrigins || [])
                            .filter(
                              (origin) =>
                                !preferredOriginOptions.some(
                                  (opt) => opt.value === origin
                                )
                            )
                            .map((origin) => (
                              <Badge
                                key={origin}
                                variant="secondary"
                                className="bg-fuchsia-100 text-fuchsia-800 rounded-full px-2 py-1 text-sm font-normal"
                              >
                                <span>{origin}</span>
                                <button
                                  type="button"
                                  className="ltr:mr-1.5 rtl:ml-1.5 text-fuchsia-600 hover:text-fuchsia-900"
                                  onClick={() =>
                                    handleRemoveItemFromArray(
                                      'preferredOrigins',
                                      origin
                                    )
                                  }
                                  aria-label={t.cards.personalBackground.originRemoveLabel.replace(
                                    '{{origin}}',
                                    origin
                                  )}
                                >
                                  <XCircle className="w-3.5 h-3.5" />
                                </button>
                              </Badge>
                            ))}
                        </div>
                        <Label
                          htmlFor="preferred-origins-input"
                          className="sr-only"
                        >
                          {t.cards.personalBackground.originPlaceholder}
                        </Label>
                        <Autocomplete
                          id="preferred-origins-input"
                          apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                          value={originInputValue}
                          onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                            setOriginInputValue(e.target.value)
                          }
                          onPlaceSelected={(place) => {
                            const countryComponent =
                              place.address_components?.find((component) =>
                                component.types.includes('country')
                              );
                            const selectedCountry =
                              countryComponent?.long_name ||
                              place.formatted_address ||
                              '';
                            handleAddItemToArray(
                              'preferredOrigins',
                              selectedCountry
                            );
                            setOriginInputValue('');
                          }}
                          options={{ types: ['country'] }}
                          className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                          placeholder={
                            t.cards.personalBackground.originPlaceholder
                          }
                        />
                      </div>
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {!formData.preferredOrigins ||
                      formData.preferredOrigins.length === 0 ? (
                        <p className="text-sm text-gray-500 italic">
                          {t.cards.personalBackground.originEmpty}
                        </p>
                      ) : (
                        formData.preferredOrigins.map((originValue) => {
                          const option = preferredOriginOptions.find(
                            (opt) => opt.value === originValue
                          );
                          const label = option ? option.label : originValue;
                          return (
                            <Badge
                              key={originValue}
                              variant="secondary"
                              className="ltr:mr-1 rtl:ml-1 mb-1 bg-fuchsia-100 text-fuchsia-700 text-xs px-2 py-0.5 rounded-full"
                            >
                              {label}
                            </Badge>
                          );
                        })
                      )}
                    </div>
                  )}
                </fieldset>
                <div>
                  <Label
                    htmlFor="preferredAliyaStatus"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.personalBackground.aliyaStatusLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredAliyaStatus"
                      value={formData.preferredAliyaStatus || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredAliyaStatus', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredAliyaStatus"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.personalBackground.aliyaStatusPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredAliyaStatusOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredAliyaStatus,
                        preferredAliyaStatusOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-amber-50/40 to-yellow-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Sparkles className="w-5 h-5 text-amber-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.characterAndInterests.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.characterAndInterests.traitsLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {characterTraitsOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredCharacterTraits || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredCharacterTraits',
                              opt.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.preferredCharacterTraits || []).length >=
                              3 &&
                            !(formData.preferredCharacterTraits || []).includes(
                              opt.value
                            ) &&
                            opt.value !== 'no_strong_preference'
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all flex items-center',
                            (formData.preferredCharacterTraits || []).includes(
                              opt.value
                            )
                              ? 'bg-yellow-500 hover:bg-yellow-600 text-white border-yellow-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.icon && (
                            <opt.icon className="w-3.5 h-3.5 ltr:mr-1.5 rtl:ml-1.5" />
                          )}
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredCharacterTraits,
                        characterTraitsOptions,
                        'bg-yellow-100 text-yellow-700',
                        t.cards.characterAndInterests.traitsEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.characterAndInterests.hobbiesLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {hobbiesOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredHobbies || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredHobbies',
                              opt.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.preferredHobbies || []).length >= 3 &&
                            !(formData.preferredHobbies || []).includes(
                              opt.value
                            ) &&
                            opt.value !== 'no_strong_preference'
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all flex items-center',
                            (formData.preferredHobbies || []).includes(
                              opt.value
                            )
                              ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.icon && (
                            <opt.icon className="w-3.5 h-3.5 ltr:mr-1.5 rtl:ml-1.5" />
                          )}
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredHobbies,
                        hobbiesOptions,
                        'bg-amber-100 text-amber-700',
                        t.cards.characterAndInterests.hobbiesEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>

      {/* ======================= START: MOBILE STICKY FOOTER ======================= */}
      {isEditing && !viewOnly && (
        <div className="sticky bottom-0 z-20 mt-4 border-t border-gray-200 bg-white/90 p-4 backdrop-blur-md shadow-[0_-4px_15px_-5px_rgba(0,0,0,0.15)] sm:hidden">
          <div className="flex items-center justify-center gap-3">
            <Button
              variant="outline"
              size="sm"
              onClick={handleCancel}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2"
            >
              <X className="w-4 h-4" />
              {t.buttons.cancel}
            </Button>
            <Button
              variant="default"
              size="sm"
              onClick={handleSave}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2"
            >
              <Save className="w-4 h-4" />
              {t.buttons.save}
            </Button>
          </div>
        </div>
      )}
      {/* ======================= END: MOBILE STICKY FOOTER ======================= */}
    </div>
  );
};

export default PreferencesSection;
--- End of Content for PreferencesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\ProfileChecklist.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/dashboard/ProfileChecklist.tsx

import React, { useState, useMemo } from 'react';
import Link from 'next/link';
import { Progress } from '@/components/ui/progress';
import { Button } from '@/components/ui/button';
import {
  CheckCircle,
  User,
  BookOpen,
  Camera,
  Target,
  ChevronUp,
  ChevronDown,
  Sparkles,
  Edit3,
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import type { User as SessionUserType } from '@/types/next-auth';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { Gender } from '@prisma/client';
import { ProfileChecklistDict } from '@/types/dictionary';

// Helper Types & Constants
const QUESTION_COUNTS: Record<
  'VALUES' | 'PERSONALITY' | 'RELATIONSHIP' | 'PARTNER' | 'RELIGION',
  number
> = {
  VALUES: 19,
  PERSONALITY: 19,
  RELATIONSHIP: 19,
  PARTNER: 17,
  RELIGION: 19,
};

const WORLD_NAMES_MAP = {
  values: 'ערכים',
  personality: 'אישיות',
  relationship: 'זוגיות',
  partner: 'פרטנר',
  religion: 'דת ומסורת',
} as const;

type WorldKey = keyof typeof WORLD_NAMES_MAP;

interface ChecklistItemProps {
  id: string;
  isCompleted: boolean;
  title: string;
  description: string;
  link?: string;
  onClick?: () => void;
  icon: React.ElementType;
  missingItems?: string[];
  worldProgress?: {
    world: string;
    completed: number;
    total: number;
    isDone: boolean;
  }[];
  isActive: boolean;
  setActiveItemId: React.Dispatch<React.SetStateAction<string | null>>;
  dict: ProfileChecklistDict;
}

const ChecklistItem: React.FC<ChecklistItemProps> = ({
  id,
  isCompleted,
  title,
  description,
  link,
  onClick,
  icon: Icon,
  missingItems,
  worldProgress,
  isActive,
  setActiveItemId,
  dict,
}) => {
  const canExpand =
    (missingItems && missingItems.length > 0) ||
    (worldProgress && worldProgress.length > 0);
  const isExpanded = isActive && canExpand;

  // --- שינוי 1: שם הפונקציה שונה כדי לשקף את השימוש ב-onPointerDown ---
  const handleInteraction = (event: React.PointerEvent) => {
    if (isCompleted) return;

    // מונע מהאירוע להפעיל אירועי עכבר מדומים שעלולים לגרום ללחיצה כפולה
    event.preventDefault();

    if (onClick) {
      onClick();
    }
  };

  const cardContent = (
    <>
      <div className="relative w-full flex justify-center mb-3">
        <div
          className={cn(
            'relative flex items-center justify-center w-14 h-14 rounded-2xl transition-all duration-300 transform group-hover:scale-110',
            isCompleted
              ? 'bg-emerald-100 shadow-emerald-500/10'
              : 'bg-cyan-100 shadow-cyan-500/10'
          )}
        >
          <Icon
            className={cn(
              'w-7 h-7 transition-colors duration-300',
              isCompleted ? 'text-emerald-500' : 'text-cyan-600'
            )}
          />
        </div>
        {isCompleted && (
          <motion.div
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{
              type: 'spring',
              stiffness: 400,
              damping: 20,
              delay: 0.2,
            }}
            className="absolute -top-1 -end-1"
          >
            <CheckCircle
              className="w-5 h-5 text-emerald-500 bg-white rounded-full p-0.5"
              fill="white"
            />
          </motion.div>
        )}
      </div>
      <h4
        className={cn(
          'font-bold text-sm text-center transition-colors',
          isCompleted ? 'text-gray-400 line-through' : 'text-gray-800'
        )}
      >
        {title}
      </h4>
      {!isCompleted && (
        <p className="text-xs text-center text-gray-500 mt-1 leading-tight h-8">
          {description}
        </p>
      )}
    </>
  );

  const interactiveContent =
    link && !isCompleted ? (
      <Link href={link} passHref legacyBehavior>
        <a className="block h-full w-full">{cardContent}</a>
      </Link>
    ) : (
      <button
        // --- שינוי 2: החלפת onClick ב-onPointerDown ---
        onPointerDown={handleInteraction}
        className="h-full w-full text-start"
        disabled={isCompleted}
      >
        {cardContent}
      </button>
    );

  return (
    <motion.div
      layout
      className={cn(
        'relative flex flex-col rounded-2xl transition-all duration-300 group overflow-hidden',
        isCompleted ? 'bg-white/40' : 'bg-white/70 shadow-md',
        isExpanded && 'shadow-xl bg-white'
      )}
    >
      <div className={cn('p-4 relative', !isCompleted && 'cursor-pointer')}>
        {interactiveContent}
        {canExpand && !isCompleted && (
          <Button
            variant="ghost"
            size="icon"
            // --- שינוי 3: החלפת onClick ב-onPointerDown בכפתור ההרחבה ---
            onPointerDown={(e) => {
              e.stopPropagation(); // עדיין חשוב מאוד למנוע bubbling
              setActiveItemId((prev) => (prev === id ? null : id));
            }}
            className="absolute bottom-1 end-1 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200/50"
            aria-label={isExpanded ? dict.minimizeLabel : dict.expandLabel}
          >
            {isExpanded ? (
              <ChevronUp className="w-5 h-5" />
            ) : (
              <ChevronDown className="w-5 h-5" />
            )}
          </Button>
        )}
      </div>
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            layout
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            transition={{ duration: 0.3, ease: 'easeInOut' }}
            className="overflow-hidden"
          >
            <div className="bg-slate-50/70 border-t border-slate-200 px-4 py-3 text-sm">
              <h4 className="font-semibold text-xs mb-2 text-gray-800">
                {dict.missingItemsTitle}
              </h4>
              {missingItems && (
                <ul className="list-disc ps-4 space-y-1.5 text-gray-600 text-xs">
                  {missingItems.map((item) => (
                    <li key={item}>{item}</li>
                  ))}
                </ul>
              )}
              {worldProgress && (
                <div className="space-y-2">
                  {worldProgress.map((world) => (
                    <div
                      key={world.world}
                      className="flex items-center justify-between text-xs"
                    >
                      <span
                        className={cn(
                          'font-medium',
                          world.isDone ? 'text-emerald-600' : 'text-gray-700'
                        )}
                      >
                        {WORLD_NAMES_MAP[world.world as WorldKey] ||
                          world.world}
                      </span>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-xs">
                          {world.completed}/{world.total}
                        </span>
                        {world.isDone && (
                          <CheckCircle className="h-4 w-4 text-emerald-500" />
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

interface ProfileChecklistProps {
  user: SessionUserType;
  hasSeenPreview: boolean;
  onPreviewClick: () => void;
  questionnaireResponse: QuestionnaireResponse | null;
  dict: ProfileChecklistDict;
  locale: string; // Added: locale prop for directionality
  onNavigateToTab: (tab: string) => void; // <-- הוסף שורה זו
  onCompletionChange?: (percentage: number) => void; // Track completion percentage
}

export const ProfileChecklist: React.FC<ProfileChecklistProps> = ({
  user,
  onPreviewClick,
  hasSeenPreview,
  questionnaireResponse,
  dict,
  locale, // Added: destructure locale
  onNavigateToTab, // <-- הוסף את זה
  onCompletionChange, // Track completion
}) => {
  const [isMinimized, setIsMinimized] = useState(true);
  const [activeItemId, setActiveItemId] = useState<string | null>(null);
  const missingItemsDict = dict.missingItems;

  // Added: Determine direction based on locale
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const getMissingItems = useMemo(() => {
    const p = user.profile;
    if (!p) return { personalDetails: [], partnerPreferences: [] };

    const personalDetails = [
      !p.profileHeadline && missingItemsDict.profileHeadline,
      (!p.about || p.about.trim().length < 100) && missingItemsDict.about,
      // --- START: הוספת בדיקות חדשות ---
      (!p.testimonials ||
        p.testimonials.filter((t) => t.status === 'APPROVED').length < 1) &&
        missingItemsDict.testimonials,
      // --- END: הוספת בדיקות חדשות ---
      !p.inspiringCoupleStory && missingItemsDict.inspiringCoupleStory,
      !p.influentialRabbi && missingItemsDict.influentialRabbi,
      (p.hasMedicalInfo === null || p.hasMedicalInfo === undefined) &&
        missingItemsDict.medicalInfoReference,
      p.hasMedicalInfo === true &&
        !p.medicalInfoDetails &&
        missingItemsDict.medicalInfoDetails,
      p.hasMedicalInfo === true &&
        !p.medicalInfoDisclosureTiming &&
        missingItemsDict.medicalInfoDisclosureTiming,
      !p.birthDate && missingItemsDict.birthDate,
      !p.height && missingItemsDict.height,
      !p.city && missingItemsDict.city,
      !p.origin && missingItemsDict.origin,
      !p.nativeLanguage && missingItemsDict.nativeLanguage,
      p.aliyaCountry && !p.aliyaYear && missingItemsDict.aliyaYear,
      !p.maritalStatus && missingItemsDict.maritalStatus,
      p.maritalStatus &&
        ['divorced', 'widowed', 'annulled'].includes(p.maritalStatus) &&
        (p.hasChildrenFromPrevious === null ||
          p.hasChildrenFromPrevious === undefined) &&
        missingItemsDict.childrenFromPreviousReference,
      !p.parentStatus && missingItemsDict.parentStatus,
      !p.fatherOccupation && missingItemsDict.fatherOccupation,
      !p.motherOccupation && missingItemsDict.motherOccupation,
      (p.siblings === null || p.siblings === undefined) &&
        missingItemsDict.siblings,
      (p.position === null || p.position === undefined) &&
        missingItemsDict.position,
      !p.religiousLevel && missingItemsDict.religiousLevel,
      !p.religiousJourney && missingItemsDict.religiousJourney,
      (p.shomerNegiah === null || p.shomerNegiah === undefined) &&
        missingItemsDict.shomerNegiah,
      !p.educationLevel && missingItemsDict.educationLevel,
      !p.education && missingItemsDict.educationDetails,
      !p.occupation && missingItemsDict.occupation,
      !p.serviceType && missingItemsDict.serviceType,
      !p.serviceDetails && missingItemsDict.serviceDetails,
      (!p.profileCharacterTraits || p.profileCharacterTraits.length === 0) &&
        missingItemsDict.characterTraits,
      (!p.profileHobbies || p.profileHobbies.length === 0) &&
        missingItemsDict.hobbies,
    ].filter(Boolean);

    const partnerPreferences = [
      (!p.matchingNotes || p.matchingNotes.trim().length === 0) &&
        missingItemsDict.matchingNotes,
      !p.contactPreference && missingItemsDict.contactPreference,
      (!p.preferredAgeMin || !p.preferredAgeMax) &&
        missingItemsDict.preferredAgeRange,
      (!p.preferredHeightMin || !p.preferredHeightMax) &&
        missingItemsDict.preferredHeightRange,
      (!p.preferredLocations || p.preferredLocations.length === 0) &&
        missingItemsDict.preferredLocations,
      (!p.preferredReligiousLevels ||
        p.preferredReligiousLevels.length === 0) &&
        missingItemsDict.preferredReligiousLevels,
      (!p.preferredReligiousJourneys ||
        p.preferredReligiousJourneys.length === 0) &&
        missingItemsDict.preferredReligiousJourneys,
      (p.preferredShomerNegiah === null ||
        p.preferredShomerNegiah === undefined) &&
        missingItemsDict.preferredShomerNegiah,
      (!p.preferredEducation || p.preferredEducation.length === 0) &&
        missingItemsDict.preferredEducation,
      (!p.preferredOccupations || p.preferredOccupations.length === 0) &&
        missingItemsDict.preferredOccupations,
      (!p.preferredServiceTypes || p.preferredServiceTypes.length === 0) &&
        missingItemsDict.preferredServiceTypes,
      (!p.preferredMaritalStatuses ||
        p.preferredMaritalStatuses.length === 0) &&
        missingItemsDict.preferredMaritalStatuses,
      (p.preferredPartnerHasChildren === null ||
        p.preferredPartnerHasChildren === undefined) &&
        missingItemsDict.preferredPartnerHasChildren,
      (!p.preferredOrigins || p.preferredOrigins.length === 0) &&
        missingItemsDict.preferredOrigins,
      !p.preferredAliyaStatus && missingItemsDict.preferredAliyaStatus,
      (!p.preferredCharacterTraits ||
        p.preferredCharacterTraits.length === 0) &&
        missingItemsDict.preferredCharacterTraits,
      (!p.preferredHobbies || p.preferredHobbies.length === 0) &&
        missingItemsDict.preferredHobbies,
    ].filter(Boolean);

    if (p.gender === Gender.FEMALE) {
      if (!p.headCovering) personalDetails.push(missingItemsDict.headCovering);
      if (!p.preferredKippahTypes || p.preferredKippahTypes.length === 0)
        partnerPreferences.push(missingItemsDict.preferredKippahTypes);
    } else if (p.gender === Gender.MALE) {
      if (!p.kippahType) personalDetails.push(missingItemsDict.kippahType);
      if (!p.preferredHeadCoverings || p.preferredHeadCoverings.length === 0)
        partnerPreferences.push(missingItemsDict.preferredHeadCoverings);
    }

    return {
      personalDetails: personalDetails as string[],
      partnerPreferences: partnerPreferences as string[],
    };
  }, [user.profile, missingItemsDict]);

  const questionnaireProgress = useMemo(() => {
    const getAnswerCountFromJsonArray = (jsonValue: unknown): number => {
      if (Array.isArray(jsonValue)) return jsonValue.length;
      return 0;
    };

    if (!questionnaireResponse) {
      return (Object.keys(WORLD_NAMES_MAP) as WorldKey[]).map((key) => ({
        world: WORLD_NAMES_MAP[key],
        completed: 0,
        total:
          QUESTION_COUNTS[key.toUpperCase() as keyof typeof QUESTION_COUNTS],
        isDone: false,
      }));
    }

    const qr = questionnaireResponse;
    return (Object.keys(WORLD_NAMES_MAP) as WorldKey[]).map((key) => {
      const uppercaseKey = key.toUpperCase() as keyof typeof QUESTION_COUNTS;
      const answersFieldKey = `${key}Answers` as keyof QuestionnaireResponse;
      const completedCount = getAnswerCountFromJsonArray(qr[answersFieldKey]);
      return {
        world: WORLD_NAMES_MAP[key],
        completed: completedCount,
        total: QUESTION_COUNTS[uppercaseKey],
        isDone: qr.worldsCompleted?.includes(uppercaseKey) ?? false,
      };
    });
  }, [questionnaireResponse]);

  const questionnaireCompleted = questionnaireResponse?.completed ?? false;

  // src/app/[locale]/(authenticated)/profile/components/dashboard/ProfileChecklist.tsx

  const tasks = [
    {
      id: 'photo',
      isCompleted: (user.images?.length ?? 0) >= 3,
      title: dict.tasks.photos.title,
      description: dict.tasks.photos.description,
      onClick: () => onNavigateToTab('photos'), // <-- שורה זו עודכנה
      icon: Camera,
      missingItems:
        (user.images?.length ?? 0) < 3
          ? [
              dict.tasks.photos.missing.replace(
                '{{count}}',
                (3 - (user.images?.length ?? 0)).toString()
              ),
            ]
          : [],
    },
    {
      id: 'personal_details',
      isCompleted: getMissingItems.personalDetails.length === 0,
      title: dict.tasks.personalDetails.title,
      description: dict.tasks.personalDetails.description,
      onClick: () => onNavigateToTab('overview'), // <-- שורה זו עודכנה
      icon: User,
      missingItems: getMissingItems.personalDetails,
    },
    {
      id: 'partner_preferences',
      isCompleted: getMissingItems.partnerPreferences.length === 0,
      title: dict.tasks.partnerPreferences.title,
      description: dict.tasks.partnerPreferences.description,
      onClick: () => onNavigateToTab('preferences'), // <-- שורה זו עודכנה
      icon: Target,
      missingItems: getMissingItems.partnerPreferences,
    },
    {
      id: 'questionnaire',
      isCompleted: questionnaireCompleted,
      title: dict.tasks.questionnaire.title,
      description: dict.tasks.questionnaire.description,
      link: '/questionnaire', // <-- ללא שינוי, מפנה לעמוד אחר
      icon: BookOpen,
      worldProgress: questionnaireProgress ?? undefined,
    },
    {
      id: 'review',
      isCompleted: hasSeenPreview,
      title: dict.tasks.review.title,
      description: dict.tasks.review.description,
      onClick: onPreviewClick, // <-- ללא שינוי, פותח דיאלוג
      icon: Edit3,
      missingItems: !hasSeenPreview ? [dict.tasks.review.missing] : [],
    },
  ];

  const completionPercentage = useMemo(() => {
    const QUESTIONNAIRE_WEIGHT = 20;
    const OTHER_TASKS_WEIGHT = 80;

    const totalQuestions = Object.values(QUESTION_COUNTS).reduce(
      (sum, count) => sum + count,
      0
    );
    const answeredQuestions = questionnaireProgress.reduce(
      (sum, world) => sum + world.completed,
      0
    );
    const questionnaireContribution =
      totalQuestions > 0
        ? (answeredQuestions / totalQuestions) * QUESTIONNAIRE_WEIGHT
        : 0;

    const p = user.profile;
    const otherTasksStatus: boolean[] = [];

    // Task 1: Photos
    otherTasksStatus.push((user.images?.length ?? 0) >= 3);

    if (p) {
      // --- START OF UPDATED LOGIC FOR PROGRESS BAR ---
      // Personal Details Checks
      otherTasksStatus.push(!!p.profileHeadline);
      otherTasksStatus.push(!!(p.about && p.about.trim().length >= 100));
      // --- START: הוספת בדיקות חדשות לסרגל ההתקדמות ---
      otherTasksStatus.push(
        !!(
          p.testimonials &&
          p.testimonials.filter((t) => t.status === 'APPROVED').length >= 1
        )
      );
      // --- END: הוספת בדיקות חדשות לסרגל ההתקדמות ---
      otherTasksStatus.push(!!p.inspiringCoupleStory);
      otherTasksStatus.push(!!p.influentialRabbi);
      otherTasksStatus.push(
        p.hasMedicalInfo !== null && p.hasMedicalInfo !== undefined
      );
      otherTasksStatus.push(!p.hasMedicalInfo || !!p.medicalInfoDetails);
      otherTasksStatus.push(
        !p.hasMedicalInfo || !!p.medicalInfoDisclosureTiming
      );
      otherTasksStatus.push(!!p.birthDate);
      otherTasksStatus.push(!!p.height);
      otherTasksStatus.push(!!p.city);
      otherTasksStatus.push(!!p.origin);
      otherTasksStatus.push(!!p.nativeLanguage);
      otherTasksStatus.push(!p.aliyaCountry || !!p.aliyaYear);
      otherTasksStatus.push(!!p.maritalStatus);
      otherTasksStatus.push(
        !['divorced', 'widowed', 'annulled'].includes(p.maritalStatus || '') ||
          (p.hasChildrenFromPrevious !== null &&
            p.hasChildrenFromPrevious !== undefined)
      );
      otherTasksStatus.push(!!p.parentStatus);
      otherTasksStatus.push(!!p.fatherOccupation);
      otherTasksStatus.push(!!p.motherOccupation);
      otherTasksStatus.push(p.siblings !== null && p.siblings !== undefined);
      otherTasksStatus.push(p.position !== null && p.position !== undefined);
      otherTasksStatus.push(!!p.religiousLevel);
      otherTasksStatus.push(!!p.religiousJourney);
      otherTasksStatus.push(
        p.shomerNegiah !== null && p.shomerNegiah !== undefined
      );
      otherTasksStatus.push(!!p.educationLevel);
      otherTasksStatus.push(!!p.education);
      otherTasksStatus.push(!!p.occupation);
      otherTasksStatus.push(!!p.serviceType);
      otherTasksStatus.push(!!p.serviceDetails);
      otherTasksStatus.push(
        !!(p.profileCharacterTraits && p.profileCharacterTraits.length > 0)
      );
      otherTasksStatus.push(
        !!(p.profileHobbies && p.profileHobbies.length > 0)
      );

      // Partner Preferences Checks
      otherTasksStatus.push(
        !!(p.matchingNotes && p.matchingNotes.trim().length > 0)
      );
      otherTasksStatus.push(!!p.contactPreference);
      otherTasksStatus.push(!!(p.preferredAgeMin && p.preferredAgeMax));
      otherTasksStatus.push(!!(p.preferredHeightMin && p.preferredHeightMax));
      otherTasksStatus.push(
        !!(p.preferredLocations && p.preferredLocations.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredReligiousLevels && p.preferredReligiousLevels.length > 0)
      );
      otherTasksStatus.push(
        !!(
          p.preferredReligiousJourneys &&
          p.preferredReligiousJourneys.length > 0
        )
      );
      otherTasksStatus.push(
        p.preferredShomerNegiah !== null &&
          p.preferredShomerNegiah !== undefined
      );
      otherTasksStatus.push(
        !!(p.preferredEducation && p.preferredEducation.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredOccupations && p.preferredOccupations.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredServiceTypes && p.preferredServiceTypes.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredMaritalStatuses && p.preferredMaritalStatuses.length > 0)
      );
      otherTasksStatus.push(
        p.preferredPartnerHasChildren !== null &&
          p.preferredPartnerHasChildren !== undefined
      );
      otherTasksStatus.push(
        !!(p.preferredOrigins && p.preferredOrigins.length > 0)
      );
      otherTasksStatus.push(!!p.preferredAliyaStatus);
      otherTasksStatus.push(
        !!(p.preferredCharacterTraits && p.preferredCharacterTraits.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredHobbies && p.preferredHobbies.length > 0)
      );

      // Gender-specific checks
      if (p.gender === Gender.FEMALE) {
        otherTasksStatus.push(!!p.headCovering); // personal
        otherTasksStatus.push(
          !!(p.preferredKippahTypes && p.preferredKippahTypes.length > 0)
        ); // preference
      } else if (p.gender === Gender.MALE) {
        otherTasksStatus.push(!!p.kippahType); // personal
        otherTasksStatus.push(
          !!(p.preferredHeadCoverings && p.preferredHeadCoverings.length > 0)
        ); // preference
      }
      // --- END OF UPDATED LOGIC FOR PROGRESS BAR ---
    } else {
      // If no profile, add placeholders for all items
      const totalProfileFields = 56; // Calculated number of fields including gender-specific and new ones
      otherTasksStatus.push(...Array(totalProfileFields).fill(false));
    }

    // Task 5: Review
    otherTasksStatus.push(hasSeenPreview);

    const totalOtherTasks = otherTasksStatus.length;
    const completedOtherTasks = otherTasksStatus.filter(
      (isCompleted) => isCompleted
    ).length;

    const otherTasksContribution =
      totalOtherTasks > 0
        ? (completedOtherTasks / totalOtherTasks) * OTHER_TASKS_WEIGHT
        : 0;

    return Math.round(questionnaireContribution + otherTasksContribution);
  }, [user, questionnaireProgress, hasSeenPreview]);

  const isAllComplete = completionPercentage >= 100;

  // Notify parent component of completion percentage changes
  React.useEffect(() => {
    if (onCompletionChange) {
      onCompletionChange(completionPercentage);
    }
  }, [completionPercentage, onCompletionChange]);

  return (
    <AnimatePresence>
      <motion.div
        layout
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, height: 0, transition: { duration: 0.4 } }}
        transition={{ duration: 0.5, ease: 'easeOut' }}
        className="mb-8 rounded-3xl shadow-xl border border-white/50 bg-white/70 backdrop-blur-md overflow-hidden"
        dir={direction} // Added: set direction for the whole component
      >
        <div className="p-4 sm:p-6">
          <div className="md:flex md:items-center md:justify-between">
            <div className="flex-1 text-center md:text-start">
              {' '}
              {/* Updated: from md:text-right to md:text-start */}
              <h2 className="text-xl font-bold text-slate-800 flex items-center justify-center md:justify-start gap-2">
                {isAllComplete && (
                  <Sparkles className="w-6 h-6 text-amber-500" />
                )}
                {(() => {
                  const isFemale = user.profile?.gender === 'FEMALE';
                  const welcomeText =
                    isFemale && dict.welcome_female
                      ? dict.welcome_female
                      : dict.welcome;
                  const allCompleteText =
                    isFemale && dict.allComplete_female
                      ? dict.allComplete_female
                      : dict.allComplete;
                  const textToShow = isAllComplete
                    ? allCompleteText
                    : welcomeText;
                  return textToShow.replace(
                    '{{firstName}}',
                    user.firstName || ''
                  );
                })()}
              </h2>
              <AnimatePresence initial={false}>
                {!isMinimized && (
                  <motion.p
                    initial={{ opacity: 0, height: 0, marginTop: 0 }}
                    animate={{
                      opacity: 1,
                      height: 'auto',
                      marginTop: '0.25rem',
                    }}
                    exit={{ opacity: 0, height: 0, marginTop: 0 }}
                    className="text-slate-600 text-sm md:text-base overflow-hidden"
                  >
                    {isAllComplete
                      ? dict.allCompleteSubtitle
                      : dict.welcomeSubtitle}
                  </motion.p>
                )}
              </AnimatePresence>
            </div>
            <div className="mt-4 md:mt-0 md:w-auto lg:w-1/3 flex items-center gap-4">
              <div className="flex-1">
                <div className="flex justify-between items-center text-sm mb-1">
                  <span
                    id="profile-completion-label"
                    className="font-medium text-gray-700"
                  >
                    {dict.completionLabel}
                  </span>
                  <span className="font-bold text-cyan-600">
                    {completionPercentage}%
                  </span>
                </div>
                <Progress
                  value={completionPercentage}
                  aria-labelledby="profile-completion-label"
                  className="h-2 bg-slate-200/70"
                />
              </div>
              <Button
                variant="ghost"
                size="icon"
                className="text-slate-500 hover:bg-slate-200/50 rounded-full flex-shrink-0"
                onClick={() => setIsMinimized(!isMinimized)}
                aria-label={isMinimized ? dict.expandLabel : dict.minimizeLabel}
              >
                {isMinimized ? (
                  <ChevronDown className="h-5 w-5" />
                ) : (
                  <ChevronUp className="h-5 w-5" />
                )}
              </Button>
            </div>
          </div>
          <AnimatePresence initial={false}>
            {!isMinimized && (
              <motion.div
                key="checklist-content"
                initial={{ height: 0, opacity: 0 }}
                animate={{
                  height: 'auto',
                  opacity: 1,
                  transition: { opacity: { delay: 0.1 } },
                }}
                exit={{ height: 0, opacity: 0, transition: { duration: 0.3 } }}
                className="overflow-hidden"
                // The onMouseLeave event handler has been removed from here.
              >
                <ul className="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-4">
                  {tasks.map((task) => (
                    <li key={task.id}>
                      <ChecklistItem
                        key={task.id}
                        {...task}
                        isActive={activeItemId === task.id}
                        setActiveItemId={setActiveItemId}
                        dict={dict}
                      />
                    </li>
                  ))}
                </ul>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </motion.div>
    </AnimatePresence>
  );
};
--- End of Content for ProfileChecklist.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\ProfileSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/profile/sections/ProfileSection.tsx
'use client';

import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import CvUploadSection from './CvUploadSection'; // Adjust the path if necessary

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import {
  Gender,
  AvailabilityStatus,
  ServiceType,
  HeadCoveringType,
  KippahType,
  ReligiousJourney,
} from '@prisma/client';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Pencil,
  Save,
  X,

  Award,
  Send,
  Copy,
  Users,
  BookOpen,
  Loader2,
  Trash2,
  Briefcase,
  Shield,
  Heart,
  MapPin,
  Languages,
  Palette,
  Smile,
  UserCircle,
  Info,
  HeartPulse,
  Lock,
  Eye,

} from 'lucide-react';
import { UserProfile, FriendTestimonial } from '@/types/next-auth';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { languageOptions } from '@/lib/languageOptions';
import { toast } from 'sonner';
import Autocomplete from 'react-google-autocomplete';
import { Switch } from '@/components/ui/switch';
import { ProfileSectionDict, FriendTestimonialsDict } from '@/types/dictionary';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';

interface ProfileSectionProps {
  profile: UserProfile | null;
  isEditing: boolean;
  setIsEditing: (value: boolean) => void;
  viewOnly?: boolean;
  onSave: (data: Partial<UserProfile>) => void;
  dict: ProfileSectionDict;
  locale: string;
  onCvUpload?: (file: File) => Promise<void>; // ✨ Add this
  onCvDelete?: () => Promise<void>; // ✨ Add this
  isCvUploading?: boolean; // ✨ Add this
}

const ensureDateObject = (
  value: string | number | Date | null | undefined
): Date | undefined => {
  if (!value) return undefined;
  if (value instanceof Date && !isNaN(value.getTime())) {
    return value;
  }
  if (typeof value === 'string' || typeof value === 'number') {
    const date = new Date(value);
    if (!isNaN(date.getTime())) {
      return date;
    }
  }
  return undefined;
};

// ========================================================================
// ✨ Helper Functions
// ========================================================================

const renderDisplayValue = (
  value: unknown,
  dict: ProfileSectionDict,
  placeholder?: string
): React.ReactNode => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  if (value === null || value === undefined || value === '') {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  if (value instanceof Date && !isNaN(value.getTime())) {
    return new Intl.DateTimeFormat('he-IL').format(value);
  }
  return String(value);
};

const renderSelectDisplayValue = (
  value: string | undefined | null,
  options: { value: string; label: string }[],
  dict: ProfileSectionDict,
  placeholder?: string
) => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  if (!value) {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  const option = options.find((opt) => opt.value === value);
  return option ? (
    option.label
  ) : (
    <span className="italic text-gray-500">{finalPlaceholder}</span>
  );
};

const renderBooleanDisplayValue = (
  value: boolean | undefined | null,
  dict: ProfileSectionDict,
  trueLabel?: string,
  falseLabel?: string,
  placeholder?: string
) => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  const finalTrueLabel = trueLabel || dict.cards.family.hasChildrenYes;
  const finalFalseLabel = falseLabel || dict.cards.medical.display.no;

  if (value === undefined || value === null) {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  return value ? finalTrueLabel : finalFalseLabel;
};

// ========================================================================
// ✨ Sub-Components
// ========================================================================

const StoryAndMoreCard: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  if (!profile) return null;
  const tAboutCard = dict.cards.about;
  const tAboutMe = dict.aboutMe;

  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-slate-50/40 to-gray-100/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
        <Info className="w-5 h-5 text-slate-600" />
        <CardTitle className="text-base font-semibold text-gray-700">
          {tAboutCard.title}
        </CardTitle>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        <div className="space-y-6">
          {/* Profile Headline Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="profileHeadline"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.headlineLabel}
              </Label>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button type="button" aria-describedby="headline-tooltip">
                      <Info className="w-4 h-4 text-gray-400" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="headline-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.headlinePlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Input
                id="profileHeadline"
                value={formData.profileHeadline || ''}
                onChange={(e) =>
                  handleChange('profileHeadline', e.target.value)
                }
                className="text-sm focus:ring-cyan-500 rounded-lg"
                placeholder={tAboutCard.headlinePlaceholder}
                maxLength={80}
              />
            ) : (
              <div className="mt-1">
                {formData.profileHeadline &&
                typeof formData.profileHeadline === 'string' &&
                formData.profileHeadline.trim() ? (
                  <p className="text-lg font-semibold text-cyan-700 italic">
                    {`"${formData.profileHeadline}"`}
                  </p>
                ) : (
                  <div className="rounded-lg bg-slate-50 p-3 text-base italic border border-slate-200/80">
                    <p className="font-medium not-italic text-slate-600">
                      {tAboutCard.headlineEmpty.title}
                    </p>
                    <p className="mt-1.5 text-slate-500">
                      {tAboutCard.headlineEmpty.subtitle}
                      <span className="block mt-1 font-semibold text-slate-700">
                        {tAboutCard.headlineEmpty.example}
                      </span>
                    </p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* My Story Section (formerly AboutMeCard) */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-1.5">
                <Label
                  htmlFor="about"
                  className="text-sm font-medium text-gray-700"
                >
                  {tAboutMe.cardTitle}
                </Label>
                <TooltipProvider delayDuration={100}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <button
                        type="button"
                        aria-describedby="about-tooltip"
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <Info className="w-4 h-4" />
                      </button>
                    </TooltipTrigger>
                    <TooltipContent
                      id="about-tooltip"
                      side="top"
                      className="max-w-xs text-center"
                      dir={direction}
                      sideOffset={5}
                      collisionPadding={10}
                    >
                      {/* UPDATED: Use placeholder text */}
                      <p>{tAboutMe.placeholder}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
           {/*    <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <div className="flex items-center gap-2">
                      <Switch
                        checked={formData.isAboutVisible ?? true}
                        onCheckedChange={(checked) =>
                          handleChange('isAboutVisible', checked)
                        }
                        disabled={!isEditing}
                      />
                    </div>
                  </TooltipTrigger>
                  <TooltipContent
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    <p>{tAboutMe.visibilityTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider> */}
            </div>
            {isEditing ? (
              <div>
                <Textarea
                  id="about"
                  value={formData.about || ''}
                  onChange={(e) => handleChange('about', e.target.value)}
                  className={cn(
                    'text-sm focus:ring-cyan-500 min-h-[120px] rounded-lg',
                    formData.about && formData.about.trim().length < 100
                      ? 'border-red-400 focus:ring-red-300'
                      : ''
                  )}
                  placeholder={tAboutMe.placeholder}
                  rows={5}
                  aria-describedby="about-char-count"
                />
                {formData.about && (
                  <div
                    id="about-char-count"
                    className={cn(
                      'text-xs mt-1 text-end',
                      formData.about.trim().length < 100
                        ? 'text-red-600'
                        : 'text-gray-500'
                    )}
                  >
                    {formData.about.trim().length}
                    {dict.charCount.replace('{{count}}', '100')}
                  </div>
                )}
              </div>
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[60px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {formData.about || (
                  <span className="text-gray-500 italic">
                    {tAboutCard.aboutEmpty}
                  </span>
                )}
              </p>
            )}
          </div>

          {/* Inspiring Couple Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="inspiringCoupleStory"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.inspiringCoupleLabel}
              </Label>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button type="button" aria-describedby="couple-tooltip">
                      <Info className="w-4 h-4 text-gray-400" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="couple-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.inspiringCouplePlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Textarea
                id="inspiringCoupleStory"
                value={formData.inspiringCoupleStory || ''}
                onChange={(e) =>
                  handleChange('inspiringCoupleStory', e.target.value)
                }
                className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                placeholder={tAboutCard.inspiringCouplePlaceholder}
                rows={3}
              />
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {renderDisplayValue(
                  formData.inspiringCoupleStory,
                  dict,
                  tAboutCard.inspiringCoupleEmpty
                )}
              </p>
            )}
          </div>

          {/* Private Notes Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="matchingNotes-private"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.privateNotesLabel}
              </Label>
              <TooltipProvider delayDuration={100}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-describedby="private-notes-tooltip"
                      className="text-gray-400 hover:text-gray-600"
                    >
                      <Info className="w-4 h-4" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="private-notes-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.privateNotesPlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Textarea
                id="matchingNotes-private"
                value={formData.matchingNotes || ''}
                onChange={(e) => handleChange('matchingNotes', e.target.value)}
                className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                placeholder={tAboutCard.privateNotesPlaceholder}
                rows={3}
              />
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {formData.matchingNotes || (
                  <span className="text-gray-500 italic">
                    {tAboutCard.privateNotesEmpty}
                  </span>
                )}
              </p>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

const NeshamaTechSummaryCard: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  if (!profile) return null;
  const t = dict.neshamaTechSummary;
  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-purple-50/40 to-indigo-50/40 border-b border-gray-200/50 p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Award className="w-5 h-5 text-purple-700" />
          <CardTitle className="text-base font-semibold text-gray-700">
            {t.cardTitle}
          </CardTitle>
        </div>
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Switch
                checked={formData.isNeshamaTechSummaryVisible ?? true}
                onCheckedChange={(checked) =>
                  handleChange('isNeshamaTechSummaryVisible', checked)
                }
                disabled={!isEditing}
              />
            </TooltipTrigger>
            <TooltipContent
              dir={direction}
              sideOffset={5}
              collisionPadding={10}
            >
              <p>{t.visibilityTooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        <p className="text-sm text-gray-700 whitespace-pre-wrap min-h-[60px]">
          {profile.manualEntryText || (
            <span className="italic text-gray-500">{t.emptyState}</span>
          )}
        </p>
      </CardContent>
    </Card>
  );
};

const FriendTestimonialsManager: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  const [testimonials, setTestimonials] = useState<FriendTestimonial[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);
  const [requestLink, setRequestLink] = useState('');

  const t = dict.friendTestimonials;

  const fetchTestimonials = useCallback(async () => {
    if (!profile) return;
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/testimonials');
      const data = await response.json();
      if (data.success) {
        setTestimonials(data.testimonials);
      } else {
        throw new Error(data.message || 'Failed to fetch');
      }
    } catch (error) {
      toast.error('Failed to load testimonials.');
      console.error(error);
    } finally {
      setIsLoading(false);
    }
  }, [profile]);

  useEffect(() => {
    fetchTestimonials();
  }, [fetchTestimonials]);

  const handleStatusChange = async (
    id: string,
    status: 'APPROVED' | 'HIDDEN'
  ) => {
    try {
      const response = await fetch(`/api/profile/testimonials/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });
      if (!response.ok) throw new Error('Failed to update status');
      toast.success('סטטוס ההמלצה עודכן!');
      fetchTestimonials(); // Refresh list
    } catch (error) {
      toast.error('שגיאה בעדכון סטטוס ההמלצה.');
    }
  };

  const handleDelete = async (id: string) => {
    if (window.confirm(t.deleteConfirm)) {
      try {
        const response = await fetch(`/api/profile/testimonials/${id}`, {
          method: 'DELETE',
        });
        if (!response.ok) throw new Error('Failed to delete');
        toast.success('ההמלצה נמחקה.');
        fetchTestimonials(); // Refresh list
      } catch (error) {
        toast.error('שגיאה במחיקת ההמלצה.');
      }
    }
  };

  const handleGenerateLink = async () => {
    try {
      const response = await fetch('/api/profile/testimonials/request-link', {
        method: 'POST',
      });
      const data = await response.json();
      if (data.success) {
        setRequestLink(data.link);
        setIsLinkModalOpen(true);
      } else {
        throw new Error(data.message || 'Failed to generate link');
      }
    } catch (error) {
      toast.error('שגיאה ביצירת קישור לבקשת המלצה.');
    }
  };

  const getStatusBadge = (status: 'PENDING' | 'APPROVED' | 'HIDDEN') => {
    switch (status) {
      case 'PENDING':
        return <Badge variant="warning">{t.pendingApproval}</Badge>;
      case 'APPROVED':
        return <Badge variant="success">{t.approvedAndVisible}</Badge>;
      case 'HIDDEN':
        return <Badge variant="secondary">{t.hidden}</Badge>;
    }
  };

  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Users className="w-5 h-5 text-teal-700" />
          <CardTitle className="text-base font-semibold text-gray-700">
            {t.cardTitle}
          </CardTitle>
        </div>
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Switch
                checked={formData.isFriendsSectionVisible ?? true}
                onCheckedChange={(checked) =>
                  handleChange('isFriendsSectionVisible', checked)
                }
                disabled={!isEditing}
              />
            </TooltipTrigger>
            <TooltipContent
              dir={direction}
              sideOffset={5}
              collisionPadding={10}
            >
              <p>{t.visibilityTooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        {isEditing && (
          <div className="flex flex-col sm:flex-row gap-2 mb-4 p-4 bg-slate-50 rounded-lg border">
            <Button
              size="sm"
              className="flex-1"
              onClick={() => setIsAddModalOpen(true)}
            >
              {t.addManualButton}
            </Button>
            <Button
              size="sm"
              variant="outline"
              className="flex-1"
              onClick={handleGenerateLink}
            >
              <Send className="w-4 h-4 mr-2" />
              {t.requestLinkButton}
            </Button>
          </div>
        )}

        {isLoading ? (
          <div className="flex justify-center p-4">
            <Loader2 className="animate-spin" />
          </div>
        ) : (
          <div className="space-y-3">
            {testimonials.length === 0 ? (
              <p className="text-sm text-center text-gray-500 py-4">
                {t.emptyState}
              </p>
            ) : (
              testimonials.map((item) => (
                <div
                  key={item.id}
                  className="border rounded-md p-3 bg-white/50"
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <p className="italic text-sm text-gray-600">
                        &quot;{item.content}&quot;
                      </p>
                      <p className="text-xs font-semibold mt-2">
                        - {item.authorName}, {item.relationship}
                      </p>
                    </div>
                    {isEditing && getStatusBadge(item.status)}
                  </div>
                  {isEditing && (
                    <div className="flex items-center gap-2 mt-2 pt-2 border-t">
                      {item.status !== 'APPROVED' && (
                        <Button
                          size="xs"
                          onClick={() =>
                            handleStatusChange(item.id, 'APPROVED')
                          }
                        >
                          {t.approveButton}
                        </Button>
                      )}
                      {item.status === 'APPROVED' && (
                        <Button
                          size="xs"
                          variant="outline"
                          onClick={() => handleStatusChange(item.id, 'HIDDEN')}
                        >
                          {t.hideButton}
                        </Button>
                      )}
                      {item.status === 'HIDDEN' && (
                        <Button
                          size="xs"
                          variant="outline"
                          onClick={() =>
                            handleStatusChange(item.id, 'APPROVED')
                          }
                        >
                          {t.showButton}
                        </Button>
                      )}
                      <Button
                        size="xs"
                        variant="destructive"
                        onClick={() => handleDelete(item.id)}
                      >
                        <Trash2 className="w-3 h-3 mr-1" />
                        {t.deleteButton}
                      </Button>
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        )}
      </CardContent>

      <AddTestimonialModal
        isOpen={isAddModalOpen}
        setIsOpen={setIsAddModalOpen}
        dict={t.addModal}
        onSuccess={fetchTestimonials}
      />

      <Dialog open={isLinkModalOpen} onOpenChange={setIsLinkModalOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t.linkModal.title}</DialogTitle>
            <DialogDescription>{t.linkModal.description}</DialogDescription>
          </DialogHeader>
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <Input value={requestLink} readOnly />
            <Button
              onClick={() =>
                navigator.clipboard
                  .writeText(requestLink)
                  .then(() => toast.success(t.linkModal.copiedTooltip))
              }
              size="icon"
            >
              <Copy className="h-4 w-4" />
            </Button>
          </div>
          <DialogFooter>
            <Button onClick={() => setIsLinkModalOpen(false)}>
              {t.linkModal.closeButton}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </Card>
  );
};

const AddTestimonialModal: React.FC<{
  isOpen: boolean;
  setIsOpen: (isOpen: boolean) => void;
  dict: FriendTestimonialsDict['addModal'];
  onSuccess: () => void;
}> = ({ isOpen, setIsOpen, dict, onSuccess }) => {
  const [formData, setFormData] = useState({
    authorName: '',
    relationship: '',
    content: '',
    authorPhone: '',
    isPhoneVisibleToMatch: false,
  });
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/testimonials', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      if (!response.ok) throw new Error('Failed to add testimonial');
      toast.success('Testimonial added!');
      onSuccess();
      setIsOpen(false);
      setFormData({
        authorName: '',
        relationship: '',
        content: '',
        authorPhone: '',
        isPhoneVisibleToMatch: false,
      });
    } catch (error) {
      toast.error('Error adding testimonial.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{dict.title}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label>{dict.authorNameLabel}</Label>
            <Input
              name="authorName"
              value={formData.authorName}
              onChange={(e) =>
                setFormData((p) => ({ ...p, authorName: e.target.value }))
              }
              required
              placeholder={dict.authorNamePlaceholder}
            />
          </div>
          <div>
            <Label>{dict.relationshipLabel}</Label>
            <Input
              name="relationship"
              value={formData.relationship}
              onChange={(e) =>
                setFormData((p) => ({ ...p, relationship: e.target.value }))
              }
              required
              placeholder={dict.relationshipPlaceholder}
            />
          </div>
          <div>
            <Label>{dict.contentLabel}</Label>
            <Textarea
              name="content"
              value={formData.content}
              onChange={(e) =>
                setFormData((p) => ({ ...p, content: e.target.value }))
              }
              required
              placeholder={dict.contentPlaceholder}
            />
          </div>
          <div>
            <Label>{dict.phoneLabel}</Label>
            <Input
              name="authorPhone"
              type="tel"
              value={formData.authorPhone}
              onChange={(e) =>
                setFormData((p) => ({ ...p, authorPhone: e.target.value }))
              }
              placeholder={dict.phonePlaceholder}
            />
          </div>
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <Checkbox
              id="consent"
              checked={formData.isPhoneVisibleToMatch}
              onCheckedChange={(c) =>
                setFormData((p) => ({ ...p, isPhoneVisibleToMatch: !!c }))
              }
              disabled={!formData.authorPhone}
            />
            <Label htmlFor="consent">{dict.consentLabel}</Label>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="ghost"
              onClick={() => setIsOpen(false)}
            >
              {dict.cancelButton}
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? (
                <Loader2 className="animate-spin" />
              ) : (
                dict.saveButton
              )}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
};

// ========================================================================
// ✨ Main Component: ProfileSection
// ========================================================================

const ProfileSection: React.FC<ProfileSectionProps> = ({
  profile: profileProp,
  isEditing,
  setIsEditing,
  viewOnly = false,
  onSave,
  onCvUpload,    // ✨ Add this
  onCvDelete,    // ✨ Add this
  isCvUploading, // ✨ Add this
  dict,
  locale,
}) => {
  console.log('✅ ProfileSection component has successfully loaded!');

  const [formData, setFormData] = useState<Partial<UserProfile>>({});
  const [loading, setLoading] = useState(true);
  const [initialData, setInitialData] = useState<Partial<UserProfile>>({});

  const [cityInputValue, setCityInputValue] = useState('');
  const [aliyaCountryInputValue, setAliyaCountryInputValue] = useState('');

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const characterTraitsOptions = useMemo(
    () =>
      Object.entries(dict.options.traits).map(([value, label]) => ({
        value,
        label,
        icon:
          {
            empathetic: Heart,
            driven: Briefcase,
            optimistic: Smile,
            family_oriented: Users,
            intellectual: BookOpen,
            organized: Palette,
            calm: Heart,
            humorous: Smile,
            sociable: Users,
            sensitive: Heart,
            independent: MapPin,
            creative: Palette,
            honest: Shield,
            responsible: Shield,
            easy_going: Smile,
          }[value] || Smile,
      })),
    [dict.options.traits]
  );

  const hobbiesOptions = useMemo(
    () =>
      Object.entries(dict.options.hobbies).map(([value, label]) => ({
        value,
        label,
        icon:
          {
            travel: MapPin,
            sports: Briefcase,
            reading: BookOpen,
            cooking_baking: Palette,
            music_playing_instrument: Languages,
            art_crafts: Palette,
            volunteering: Heart,
            learning_courses: BookOpen,
            board_games_puzzles: Smile,
            movies_theater: Smile,
            dancing: Users,
            writing: BookOpen,
            nature_hiking: MapPin,
            photography: Palette,
          }[value] || Smile,
      })),
    [dict.options.hobbies]
  );

  const maritalStatusOptions = useMemo(
    () =>
      Object.entries(dict.options.maritalStatus).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.maritalStatus]
  );
  const religiousLevelOptions = useMemo(
    () =>
      Object.entries(dict.options.religiousLevel).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.religiousLevel]
  );
  const religiousJourneyOptions = useMemo(
    () =>
      Object.entries(dict.options.religiousJourney).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.religiousJourney]
  );
  const educationLevelOptions = useMemo(
    () =>
      Object.entries(dict.options.educationLevel).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.educationLevel]
  );
  const serviceTypeOptions = useMemo(
    () =>
      Object.entries(dict.options.serviceType).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.serviceType]
  );
  const headCoveringOptions = useMemo(
    () =>
      Object.entries(dict.options.headCovering).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.headCovering]
  );
  const kippahTypeOptions = useMemo(
    () =>
      Object.entries(dict.options.kippahType).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.kippahType]
  );
  const preferredMatchmakerGenderOptions = useMemo(
    () =>
      Object.entries(dict.options.matchmakerGender).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.matchmakerGender]
  );

  const initializeFormData = useCallback((profileData: UserProfile | null) => {
    let headline = profileData?.profileHeadline || '';
    if (typeof headline === 'object' && headline !== null) {
      headline = '';
    }

    const dataToSet: Partial<UserProfile> = {
      gender: profileData?.gender || undefined,
      birthDate: ensureDateObject(profileData?.birthDate),
      nativeLanguage: profileData?.nativeLanguage || undefined,
      additionalLanguages: profileData?.additionalLanguages || [],
      height: profileData?.height ?? undefined,
      maritalStatus: profileData?.maritalStatus || undefined,
      occupation: profileData?.occupation || '',
      education: profileData?.education || '',
      educationLevel: profileData?.educationLevel || undefined,
      city: profileData?.city || '',
      origin: profileData?.origin || '',
      religiousJourney: profileData?.religiousJourney || undefined,
      religiousLevel: profileData?.religiousLevel || undefined,
      about: profileData?.about || '',
      parentStatus: profileData?.parentStatus || undefined,
      fatherOccupation: profileData?.fatherOccupation || '',
      motherOccupation: profileData?.motherOccupation || '',
      siblings: profileData?.siblings ?? undefined,
      position: profileData?.position ?? undefined,
      isProfileVisible: profileData?.isProfileVisible ?? true,
      preferredMatchmakerGender:
        profileData?.preferredMatchmakerGender || undefined,
      availabilityStatus:
        profileData?.availabilityStatus || AvailabilityStatus.AVAILABLE,
      availabilityNote: profileData?.availabilityNote || '',
      availabilityUpdatedAt: ensureDateObject(
        profileData?.availabilityUpdatedAt
      ),
      matchingNotes: profileData?.matchingNotes || '',
      shomerNegiah: profileData?.shomerNegiah ?? undefined,
      serviceType: profileData?.serviceType || undefined,
      serviceDetails: profileData?.serviceDetails || '',
      headCovering: profileData?.headCovering || undefined,
      kippahType: profileData?.kippahType || undefined,
      hasChildrenFromPrevious:
        profileData?.hasChildrenFromPrevious ?? undefined,
      profileCharacterTraits: profileData?.profileCharacterTraits || [],
      profileHobbies: profileData?.profileHobbies || [],
      aliyaCountry: profileData?.aliyaCountry || '',
      aliyaYear: profileData?.aliyaYear ?? undefined,
      id: profileData?.id,
      userId: profileData?.userId,
      createdAt: ensureDateObject(profileData?.createdAt),
      updatedAt: ensureDateObject(profileData?.updatedAt),
      lastActive: ensureDateObject(profileData?.lastActive),
      hasMedicalInfo: profileData?.hasMedicalInfo ?? false,
      medicalInfoDetails: profileData?.medicalInfoDetails || '',
      medicalInfoDisclosureTiming:
        profileData?.medicalInfoDisclosureTiming || undefined,
      isMedicalInfoVisible: profileData?.isMedicalInfoVisible ?? false,
      profileHeadline: headline,
      inspiringCoupleStory: profileData?.inspiringCoupleStory || '',
      influentialRabbi: profileData?.influentialRabbi || '',
      isAboutVisible: profileData?.isAboutVisible ?? true,
      isFriendsSectionVisible: profileData?.isFriendsSectionVisible ?? true,
      isNeshamaTechSummaryVisible:
        profileData?.isNeshamaTechSummaryVisible ?? true,
          cvUrl: profileData?.cvUrl,
      cvSummary: profileData?.cvSummary,
    };
    setFormData(dataToSet);
    setInitialData(dataToSet);

    setCityInputValue(dataToSet.city || '');
    setAliyaCountryInputValue(dataToSet.aliyaCountry || '');
  }, []);

  useEffect(() => {
    setLoading(true);
    if (profileProp) {
      initializeFormData(profileProp);
      setLoading(false);
    }
  }, [profileProp, initializeFormData]);

  const handleChange = (
    field: keyof UserProfile,
    value:
      | UserProfile[keyof UserProfile]
      | string
      | number
      | boolean
      | Date
      | string[]
      | null
  ) => {
    setFormData((prev) => {
      let finalValue: UserProfile[keyof UserProfile] | undefined = undefined;

      if (['height', 'siblings', 'position', 'aliyaYear'].includes(field)) {
        const rawValue = value as string | number;
        if (rawValue === '' || rawValue === null || rawValue === undefined) {
          finalValue = undefined;
        } else {
          const parsed = parseInt(String(rawValue), 10);
          finalValue = !isNaN(parsed)
            ? (parsed as UserProfile[typeof field])
            : undefined;
        }
      } else if (field === 'birthDate') {
        finalValue = ensureDateObject(
          value as string | Date | null | undefined
        ) as UserProfile[typeof field];
      } else {
        finalValue = (
          value === '' || value === null ? undefined : value
        ) as UserProfile[typeof field];
      }

      return {
        ...prev,
        [field]: finalValue,
      };
    });
  };

  const handleMultiSelectToggle = (
    field: keyof UserProfile,
    optionValue: string
  ) => {
    setFormData((prev) => {
      const currentValues = (prev[field] as string[]) || [];
      const newValues = currentValues.includes(optionValue)
        ? currentValues.filter((v) => v !== optionValue)
        : [...currentValues, optionValue];
      return { ...prev, [field]: newValues };
    });
  };

  const handleSave = () => {
    if (formData.about && formData.about.trim().length < 100) {
      toast.error(dict.toasts.validationErrorTitle, {
        description: dict.toasts.aboutMinLength.replace('{{count}}', '100'),
        duration: 5000,
      });
      return;
    }

    const dataToSave = { ...formData };
    onSave(dataToSave);
    setIsEditing(false);
    setInitialData(dataToSave);
  };

  const handleCancel = () => {
    setFormData(initialData);
    setCityInputValue(initialData.city || '');
    setAliyaCountryInputValue(initialData.aliyaCountry || '');
    setIsEditing(false);
  };

  if (loading) {
    return (
      <div role="status" aria-live="polite" className="text-center p-4">
        {dict.loading}
      </div>
    );
  }

  const renderMultiSelectBadges = (
    fieldValues: string[] | undefined,
    options: { value: string; label: string; icon?: React.ElementType }[],
    emptyPlaceholder: string
  ) => {
    if (!fieldValues || fieldValues.length === 0) {
      return <p className="text-sm text-gray-500 italic">{emptyPlaceholder}</p>;
    }
    return fieldValues.map((value) => {
      const option = options.find((opt) => opt.value === value);
      return option ? (
        <Badge
          key={value}
          variant="secondary"
          className="me-1 mb-1 bg-sky-100 text-sky-700 text-xs px-2 py-0.5 rounded-full"
        >
          {option.icon && <option.icon className="w-3 h-3 me-1" />}
          {option.label}
        </Badge>
      ) : null;
    });
  };

  return (
    <div className="relative" dir={direction}>
      <div className="sticky top-0 z-10 bg-gradient-to-b from-white via-white/95 to-white/0 pt-4 pb-3 backdrop-blur-sm">
        <div className="container mx-auto max-w-screen-xl px-4">
          <div className="flex items-center justify-between">
            <div className="text-start">
              <h1 className="text-xl md:text-2xl font-bold text-slate-800">
                {dict.header.title}
              </h1>
              <p className="text-sm text-slate-500">
                {isEditing && !viewOnly
                  ? dict.header.subtitleEdit
                  : dict.header.subtitleView}
              </p>
            </div>
            {!viewOnly && (
              <div className="flex gap-2">
                {!isEditing ? (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setIsEditing(true)}
                    className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-cyan-400 text-cyan-700 hover:bg-cyan-50"
                  >
                    <Pencil className="w-3.5 h-3.5 ms-1.5" />
                    {dict.buttons.edit}
                  </Button>
                ) : (
                  <>
                    {/* ======================= START: DESKTOP BUTTONS ======================= */}
                    <div className="hidden sm:flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={handleCancel}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50"
                      >
                        <X className="w-3.5 h-3.5 ms-1.5" />
                        {dict.buttons.cancel}
                      </Button>
                      <Button
                        variant="default"
                        size="sm"
                        onClick={handleSave}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white"
                      >
                        <Save className="w-3.5 h-3.5 ms-1.5" />
                        {dict.buttons.save}
                      </Button>
                    </div>
                    {/* ======================= END: DESKTOP BUTTONS ======================= */}
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      <div className="container mx-auto max-w-screen-xl py-6 px-4">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-cyan-50/40 to-pink-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <UserCircle className="w-5 h-5 text-cyan-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.personal.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                  <div>
                    <Label
                      htmlFor="gender"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.genderLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.gender || ''}
                        onValueChange={(value) =>
                          handleChange('gender', value as Gender)
                        }
                      >
                        <SelectTrigger
                          id="gender"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={dict.cards.personal.genderPlaceholder}
                          />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="MALE">
                            {dict.options.gender.MALE}
                          </SelectItem>
                          <SelectItem value="FEMALE">
                            {dict.options.gender.FEMALE}
                          </SelectItem>
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.gender
                            ? dict.options.gender[formData.gender]
                            : undefined,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="birthDate"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.birthDateLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="birthDate"
                        type="date"
                        value={
                          formData.birthDate instanceof Date &&
                          !isNaN(formData.birthDate.getTime())
                            ? formData.birthDate.toISOString().split('T')[0]
                            : ''
                        }
                        onChange={(e) =>
                          handleChange('birthDate', e.target.value || undefined)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        max={new Date().toISOString().split('T')[0]}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.birthDate, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="height"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.heightLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="height"
                        type="number"
                        value={formData.height ?? ''}
                        onChange={(e) => handleChange('height', e.target.value)}
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.personal.heightPlaceholder}
                        min="100"
                        max="250"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.height
                            ? `${formData.height} ${dict.cards.personal.heightUnit}`
                            : undefined,
                          dict
                        )}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="city-autocomplete"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.cityLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Autocomplete
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                         id="city-autocomplete"
                        value={cityInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                          setCityInputValue(e.target.value);
                        }}
                        // =========================== START: הקוד המתוקן ===========================
                        onPlaceSelected={(place) => {
                          // 1. הוספנו בדיקה קריטית: ודא שהאובייקט 'place' קיים ויש לו את המידע שאנו צריכים.
                          if (!place || !place.address_components) {
                            console.error(
                              "Google Autocomplete error: 'place' object or 'address_components' is undefined.",
                              place
                            );

                            // במקרה של שגיאה, אנו יכולים להשתמש בערך שהוקלד כברירת מחדל,
                            // או להציג שגיאה למשתמש. כאן נשתמש בערך שהוקלד.
                            handleChange('city', cityInputValue);
                            return;
                          }

                          const cityComponent = place.address_components.find(
                            (component) => component.types.includes('locality')
                          );

                          // 2. חיזוק לוגיקת החילוץ של שם העיר
                          const selectedCity =
                            cityComponent?.long_name || // העדפה לשם העיר הנקי
                            place.formatted_address || // אם אין, השתמש בכתובת המלאה
                            cityInputValue; // אם הכל נכשל, השתמש במה שהמשתמש הקליד

                          handleChange('city', selectedCity);
                          setCityInputValue(selectedCity);
                        }}
                        // ============================ END: הקוד המתוקן ============================
                        onBlur={() => {
                          if (cityInputValue !== formData.city) {
                            setCityInputValue(formData.city || '');
                          }
                        }}
                        // =========================== START: שינוי חשוב נוסף ===========================
                        options={{
                          types: ['(cities)'],
                          componentRestrictions: { country: 'il' },
                          // 3. הוספנו בקשה מפורשת לקבל את השדה 'address_components'
                          fields: [
                            'address_components',
                            'formatted_address',
                            'geometry',
                          ],
                        }}
                        // ============================ END: שינוי חשוב נוסף ============================
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={dict.cards.personal.cityPlaceholder}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.city, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="origin"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.originLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="origin"
                        value={formData.origin || ''}
                        onChange={(e) => handleChange('origin', e.target.value)}
                        placeholder={dict.cards.personal.originPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.origin, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="aliyaCountry-autocomplete"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.aliyaCountryLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Autocomplete
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                        id="aliyaCountry-autocomplete"
                        value={aliyaCountryInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                          setAliyaCountryInputValue(e.target.value);
                        }}
                        onPlaceSelected={(place) => {
                          const countryComponent =
                            place.address_components?.find((component) =>
                              component.types.includes('country')
                            );
                          const selectedCountry =
                            countryComponent?.long_name ||
                            place.formatted_address ||
                            '';
                          handleChange('aliyaCountry', selectedCountry);
                          setAliyaCountryInputValue(selectedCountry);
                        }}
                        onBlur={() => {
                          if (
                            aliyaCountryInputValue !== formData.aliyaCountry
                          ) {
                            setAliyaCountryInputValue(
                              formData.aliyaCountry || ''
                            );
                          }
                        }}
                        options={{
                          types: ['country'],
                        }}
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={
                          dict.cards.personal.aliyaCountryPlaceholder
                        }
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.aliyaCountry,
                          dict,
                          dict.placeholders.notRelevant
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="aliyaYear"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.aliyaYearLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="aliyaYear"
                        type="number"
                        value={formData.aliyaYear ?? ''}
                        onChange={(e) =>
                          handleChange('aliyaYear', e.target.value)
                        }
                        disabled={!formData.aliyaCountry}
                        placeholder={dict.cards.personal.aliyaYearPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                        min="1900"
                        max={new Date().getFullYear()}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.aliyaYear,
                          dict,
                          formData.aliyaCountry
                            ? dict.placeholders.noYear
                            : dict.placeholders.notRelevant
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="nativeLanguage"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.nativeLanguageLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.nativeLanguage || ''}
                        onValueChange={(value) =>
                          handleChange('nativeLanguage', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="nativeLanguage"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.personal.nativeLanguagePlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent position="item-aligned">
                          {languageOptions.map((lang) => (
                            <SelectItem key={lang.value} value={lang.value}>
                              {lang.label[locale] || lang.label.en}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.nativeLanguage,
                          languageOptions.map((opt) => ({
                            value: opt.value,
                            label: opt.label[locale] || opt.label.en,
                          })),
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div className="sm:col-span-2 lg:col-span-1">
                    <Label
                      htmlFor="additionalLanguages"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.additionalLanguagesLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        onValueChange={(value) => {
                          const currentLanguages =
                            formData.additionalLanguages || [];
                          if (!currentLanguages.includes(value)) {
                            handleChange('additionalLanguages', [
                              ...currentLanguages,
                              value,
                            ]);
                          }
                        }}
                      >
                        <SelectTrigger
                          id="additionalLanguages"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.personal.additionalLanguagesPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent
                          className="max-h-[200px]"
                          position="item-aligned"
                        >
                          {languageOptions
                            .filter(
                              (lang) =>
                                !(formData.additionalLanguages || []).includes(
                                  lang.value
                                ) && lang.value !== formData.nativeLanguage
                            )
                            .map((lang) => (
                              <SelectItem key={lang.value} value={lang.value}>
                                {lang.label[locale] || lang.label['en']}{' '}
                              </SelectItem>
                            ))}
                        </SelectContent>
                      </Select>
                    ) : null}
                    <div className="mt-2 flex flex-wrap gap-1.5">
                      {(formData.additionalLanguages || []).map((langValue) => {
                        const lang = languageOptions.find(
                          (l) => l.value === langValue
                        );
                        return lang ? (
                          <Badge
                            key={lang.value}
                            variant="secondary"
                            className="bg-cyan-100/70 text-cyan-800 px-2 py-0.5 rounded-full text-[11px] font-medium flex items-center"
                          >
                            {lang.label[locale] || lang.label['en']}{' '}
                            {isEditing && !viewOnly && (
                              <button
                                type="button"
                                onClick={() =>
                                  handleChange(
                                    'additionalLanguages',
                                    (formData.additionalLanguages || []).filter(
                                      (l) => l !== langValue
                                    )
                                  )
                                }
                                className="ms-1.5 text-cyan-600 hover:text-cyan-800 text-xs"
                                aria-label={dict.cards.personal.removeLanguageLabel.replace(
                                  '{{lang}}',
                                  lang.label[locale] || lang.label['en']
                                )}
                              >
                                ×
                              </button>
                            )}
                          </Badge>
                        ) : null;
                      })}
                      {(!isEditing || viewOnly) &&
                        (!formData.additionalLanguages ||
                          formData.additionalLanguages.length === 0) && (
                          <p className="text-sm text-gray-500 italic">
                            {dict.cards.personal.noAdditionalLanguages}
                          </p>
                        )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-purple-50/40 to-indigo-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Users className="w-5 h-5 text-purple-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.family.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-5 items-start">
                  <div>
                    <Label
                      htmlFor="maritalStatus"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.maritalStatusLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.maritalStatus || ''}
                        onValueChange={(value) =>
                          handleChange('maritalStatus', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="maritalStatus"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.family.maritalStatusPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {maritalStatusOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.maritalStatus,
                          maritalStatusOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  {(formData.maritalStatus === 'divorced' ||
                    formData.maritalStatus === 'widowed' ||
                    formData.maritalStatus === 'annulled') && (
                    <div
                      className={cn(
                        'pt-1 sm:pt-0',
                        isEditing && !viewOnly ? 'sm:pt-5' : 'sm:pt-0'
                      )}
                    >
                      <Label
                        htmlFor="hasChildrenFromPrevious"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.family.hasChildrenLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <div className="flex items-center space-x-2 rtl:space-x-reverse mt-2">
                          <Checkbox
                            id="hasChildrenFromPrevious"
                            checked={formData.hasChildrenFromPrevious || false}
                            onCheckedChange={(checked) =>
                              handleChange(
                                'hasChildrenFromPrevious',
                                checked as boolean
                              )
                            }
                          />
                          <Label
                            htmlFor="hasChildrenFromPrevious"
                            className="text-sm font-normal text-gray-700"
                          >
                            {dict.cards.family.hasChildrenYes}
                          </Label>
                        </div>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderBooleanDisplayValue(
                            formData.hasChildrenFromPrevious,
                            dict
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  <div>
                    <Label
                      htmlFor="parentStatus"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.parentStatusLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="parentStatus"
                        value={formData.parentStatus || ''}
                        onChange={(e) =>
                          handleChange('parentStatus', e.target.value)
                        }
                        placeholder={dict.cards.family.parentStatusPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.parentStatus, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="fatherOccupation"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.fatherOccupationLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="fatherOccupation"
                        value={formData.fatherOccupation || ''}
                        onChange={(e) =>
                          handleChange('fatherOccupation', e.target.value)
                        }
                        placeholder={
                          dict.cards.family.fatherOccupationPlaceholder
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.fatherOccupation, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="motherOccupation"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.motherOccupationLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="motherOccupation"
                        value={formData.motherOccupation || ''}
                        onChange={(e) =>
                          handleChange('motherOccupation', e.target.value)
                        }
                        placeholder={
                          dict.cards.family.motherOccupationPlaceholder
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.motherOccupation, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="siblings"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.siblingsLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="siblings"
                        type="number"
                        value={formData.siblings ?? ''}
                        onChange={(e) =>
                          handleChange('siblings', e.target.value)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.family.siblingsPlaceholder}
                        min="0"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.siblings, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="position"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.positionLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="position"
                        type="number"
                        value={formData.position ?? ''}
                        onChange={(e) =>
                          handleChange('position', e.target.value)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.family.positionPlaceholder}
                        min="0"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.position, dict)}
                      </p>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-yellow-50/40 to-amber-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <BookOpen className="w-5 h-5 text-amber-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.religion.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-5 items-start">
                  <div>
                    <Label
                      htmlFor="religiousLevel"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.religiousLevelLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.religiousLevel || ''}
                        onValueChange={(value) =>
                          handleChange('religiousLevel', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="religiousLevel"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.religiousLevelPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[250px]">
                          {religiousLevelOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.religiousLevel,
                          religiousLevelOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="religiousJourney"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.religiousJourneyLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.religiousJourney || ''}
                        onValueChange={(value) =>
                          handleChange(
                            'religiousJourney',
                            (value as ReligiousJourney) || undefined
                          )
                        }
                      >
                        <SelectTrigger
                          id="religiousJourney"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.religiousJourneyPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[250px]">
                          {religiousJourneyOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.religiousJourney,
                          religiousJourneyOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div
                    className={cn(
                      'pt-1 sm:pt-0',
                      isEditing && !viewOnly ? 'sm:pt-5' : 'sm:pt-0'
                    )}
                  >
                    <Label className="block mb-1.5 text-xs font-medium text-gray-600">
                      {dict.cards.religion.shomerNegiahLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <div className="flex items-center space-x-2 rtl:space-x-reverse mt-2">
                        <Checkbox
                          id="shomerNegiah"
                          checked={formData.shomerNegiah || false}
                          onCheckedChange={(checked) =>
                            handleChange('shomerNegiah', checked as boolean)
                          }
                        />
                        <Label
                          htmlFor="shomerNegiah"
                          className="text-sm font-normal text-gray-700"
                        >
                          {dict.cards.religion.shomerNegiahYes}
                        </Label>
                      </div>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderBooleanDisplayValue(
                          formData.shomerNegiah,
                          dict,
                          dict.cards.religion.shomerNegiahYes
                        )}
                      </p>
                    )}
                  </div>
                  {formData.gender === Gender.FEMALE && (
                    <div>
                      <Label
                        htmlFor="headCovering"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.religion.headCoveringLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <Select
                          dir={direction}
                          value={formData.headCovering || ''}
                          onValueChange={(value) =>
                            handleChange(
                              'headCovering',
                              (value as HeadCoveringType) || undefined
                            )
                          }
                        >
                          <SelectTrigger
                            id="headCovering"
                            className="h-9 text-sm focus:ring-cyan-500 text-start"
                          >
                            <SelectValue
                              placeholder={
                                dict.cards.religion.headCoveringPlaceholder
                              }
                            />
                          </SelectTrigger>
                          <SelectContent>
                            {headCoveringOptions.map((opt) => (
                              <SelectItem key={opt.value} value={opt.value}>
                                {opt.label}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderSelectDisplayValue(
                            formData.headCovering,
                            headCoveringOptions,
                            dict,
                            dict.cards.religion.headCoveringDefault
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  {formData.gender === Gender.MALE && (
                    <div>
                      <Label
                        htmlFor="kippahType"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.religion.kippahTypeLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <Select
                          dir={direction}
                          value={formData.kippahType || ''}
                          onValueChange={(value) =>
                            handleChange(
                              'kippahType',
                              (value as KippahType) || undefined
                            )
                          }
                        >
                          <SelectTrigger
                            id="kippahType"
                            className="h-9 text-sm focus:ring-cyan-500 text-start"
                          >
                            <SelectValue
                              placeholder={
                                dict.cards.religion.kippahTypePlaceholder
                              }
                            />
                          </SelectTrigger>
                          <SelectContent className="max-h-[200px]">
                            {kippahTypeOptions.map((opt) => (
                              <SelectItem key={opt.value} value={opt.value}>
                                {opt.label}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderSelectDisplayValue(
                            formData.kippahType,
                            kippahTypeOptions,
                            dict,
                            dict.cards.religion.kippahTypeDefault
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  <div>
                    <Label
                      htmlFor="preferredMatchmakerGender"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.matchmakerGenderLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.preferredMatchmakerGender || ''}
                        onValueChange={(value) =>
                          handleChange(
                            'preferredMatchmakerGender',
                            (value as Gender) || undefined
                          )
                        }
                      >
                        <SelectTrigger
                          id="preferredMatchmakerGender"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.matchmakerGenderPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {preferredMatchmakerGenderOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.preferredMatchmakerGender,
                          preferredMatchmakerGenderOptions,
                          dict,
                          dict.cards.religion.matchmakerGenderDefault
                        )}
                      </p>
                    )}
                  </div>
                </div>

                <div className="mt-6 pt-6 border-t border-gray-200/70">
                  <div className="flex items-center gap-1.5 mb-2">
                    <Label
                      htmlFor="influentialRabbi"
                      className="text-sm font-medium text-gray-700"
                    >
                      {dict.cards.religion.influentialRabbiLabel}
                    </Label>
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="rabbi-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="rabbi-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                          dir={direction}
                          sideOffset={5}
                          collisionPadding={10}
                        >
                          {/* UPDATED: Use placeholder text */}
                          <p>
                            {dict.cards.religion.influentialRabbiPlaceholder}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </div>
                  {isEditing && !viewOnly ? (
                    <Textarea
                      id="influentialRabbi"
                      value={formData.influentialRabbi || ''}
                      onChange={(e) =>
                        handleChange('influentialRabbi', e.target.value)
                      }
                      className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                      placeholder={
                        dict.cards.religion.influentialRabbiPlaceholder
                      }
                      rows={3}
                    />
                  ) : (
                    <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                      {renderDisplayValue(
                        formData.influentialRabbi,
                        dict,
                        dict.cards.religion.influentialRabbiEmpty
                      )}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-red-50/40 to-pink-50/40 border-b border-gray-200/50 p-4">
                <div className="flex items-center space-x-2 rtl:space-x-reverse">
                  <HeartPulse className="w-5 h-5 text-red-700" />
                  <CardTitle className="text-base font-semibold text-gray-700">
                    {dict.cards.medical.title}
                  </CardTitle>
                  <TooltipProvider delayDuration={100}>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <button
                          type="button"
                          aria-describedby="medical-tooltip"
                        >
                          <Lock className="w-4 h-4 text-gray-400" />
                        </button>
                      </TooltipTrigger>
                      <TooltipContent
                        id="medical-tooltip"
                        dir={direction}
                        sideOffset={5}
                        collisionPadding={10}
                      >
                        <p>{dict.cards.medical.tooltip}</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </div>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-4">
                <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200/80">
                  {dict.cards.medical.description}
                </div>

                {isEditing && !viewOnly ? (
                  <div className="space-y-4">
                    <div className="flex items-center space-x-2 rtl:space-x-reverse">
                      <Checkbox
                        id="hasMedicalInfo"
                        checked={formData.hasMedicalInfo || false}
                        onCheckedChange={(checked) =>
                          handleChange('hasMedicalInfo', checked as boolean)
                        }
                      />
                      <Label
                        htmlFor="hasMedicalInfo"
                        className="text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        {dict.cards.medical.hasInfoLabel}
                      </Label>
                    </div>

                    {formData.hasMedicalInfo && (
                      <div className="space-y-4 border-t pt-4 animate-in fade-in-50">
                        <div>
                          <Label
                            htmlFor="medicalInfoDetails"
                            className="block mb-1.5 text-xs font-medium text-gray-600"
                          >
                            {dict.cards.medical.detailsLabel}
                          </Label>
                          <Textarea
                            id="medicalInfoDetails"
                            value={formData.medicalInfoDetails || ''}
                            onChange={(e) =>
                              handleChange('medicalInfoDetails', e.target.value)
                            }
                            className="text-sm focus:ring-cyan-500 min-h-[100px] rounded-lg"
                            placeholder={dict.cards.medical.detailsPlaceholder}
                          />
                        </div>
                        <div>
                          <Label
                            htmlFor="medicalInfoDisclosureTiming"
                            className="block mb-1.5 text-xs font-medium text-gray-600"
                          >
                            {dict.cards.medical.timingLabel}
                          </Label>
                          <Select
                            dir={direction}
                            value={formData.medicalInfoDisclosureTiming || ''}
                            onValueChange={(value) =>
                              handleChange(
                                'medicalInfoDisclosureTiming',
                                value || undefined
                              )
                            }
                          >
                            <SelectTrigger
                              id="medicalInfoDisclosureTiming"
                              className="h-9 text-sm focus:ring-cyan-500 text-start"
                            >
                              <SelectValue
                                placeholder={
                                  dict.cards.medical.timingPlaceholder
                                }
                              />
                            </SelectTrigger>
                            <SelectContent>
                              {Object.entries(dict.options.medicalTiming).map(
                                ([value, label]) => (
                                  <SelectItem key={value} value={value}>
                                    {label}
                                  </SelectItem>
                                )
                              )}
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="border-t pt-4">
                          <Label className="block mb-2 text-xs font-medium text-gray-600">
                            {dict.cards.medical.visibilityLabel}
                          </Label>
                          <div className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
                            <Switch
                              id="isMedicalInfoVisible"
                              checked={!!formData.isMedicalInfoVisible}
                              onCheckedChange={(checked) =>
                                handleChange('isMedicalInfoVisible', checked)
                              }
                              className="data-[state=checked]:bg-green-500"
                            />
                            <div className="flex flex-col">
                              <Label
                                htmlFor="isMedicalInfoVisible"
                                className="text-sm font-medium text-gray-800 cursor-pointer"
                              >
                                {formData.isMedicalInfoVisible
                                  ? dict.cards.medical.visibilityToggle.visible
                                  : dict.cards.medical.visibilityToggle.hidden}
                              </Label>
                              <p className="text-xs text-gray-500">
                                {formData.isMedicalInfoVisible
                                  ? dict.cards.medical.visibilityDescription
                                      .visible
                                  : dict.cards.medical.visibilityDescription
                                      .hidden}
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div>
                      <p className="block text-xs font-medium text-gray-500">
                        {dict.cards.medical.display.sharedInfo}
                      </p>
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderBooleanDisplayValue(
                          formData.hasMedicalInfo,
                          dict,
                          dict.cards.medical.display.yes,
                          dict.cards.medical.display.no
                        )}
                      </p>
                    </div>
                    {formData.hasMedicalInfo && (
                      <>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.details}
                          </p>
                          <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[40px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                            {formData.medicalInfoDetails || (
                              <span className="text-gray-500 italic">
                                {dict.cards.medical.display.noDetails}
                              </span>
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.timing}
                          </p>
                          <p className="text-sm text-gray-800 font-medium mt-1">
                            {renderSelectDisplayValue(
                              formData.medicalInfoDisclosureTiming,
                              Object.entries(dict.options.medicalTiming).map(
                                ([value, label]) => ({ value, label })
                              ),
                              dict
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.visibility}
                          </p>
                          <div className="flex items-center gap-2 mt-1">
                            {formData.isMedicalInfoVisible ? (
                              <Badge
                                variant="secondary"
                                className="bg-green-100 text-green-800"
                              >
                                <Eye className="w-3.5 h-3.5 ms-1.5" />
                                {dict.cards.medical.display.visibleBadge}
                              </Badge>
                            ) : (
                              <Badge
                                variant="secondary"
                                className="bg-gray-100 text-gray-700"
                              >
                                <Lock className="w-3.5 h-3.5 ms-1.5" />
                                {dict.cards.medical.display.hiddenBadge}
                              </Badge>
                            )}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                )}
              </CardContent>
            </Card>
            <FriendTestimonialsManager
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />
          </div>

          <div className="space-y-6">
            <StoryAndMoreCard
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />

          <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
  <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
    <Briefcase className="w-5 h-5 text-teal-700" />
    <CardTitle className="text-base font-semibold text-gray-700">
      {dict.cards.education.title}
    </CardTitle>
  </CardHeader>
  <CardContent className="p-4 md:p-6">
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
      <div>
        <Label
          htmlFor="educationLevel"
          className="block mb-1.5 text-xs font-medium text-gray-600"
        >
          {dict.cards.education.levelLabel}
        </Label>
        {isEditing && !viewOnly ? (
          <Select
            dir={direction}
            value={formData.educationLevel || ''}
            onValueChange={(value) =>
              handleChange('educationLevel', value || undefined)
            }
          >
            <SelectTrigger
              id="educationLevel"
              className="h-9 text-sm focus:ring-cyan-500 text-start"
            >
              <SelectValue
                placeholder={dict.cards.education.levelPlaceholder}
              />
            </SelectTrigger>
            <SelectContent>
              {educationLevelOptions.map((opt) => (
                <SelectItem key={opt.value} value={opt.value}>
                  {opt.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        ) : (
          <p className="text-sm text-gray-800 font-medium mt-1">
            {renderSelectDisplayValue(
              formData.educationLevel,
              educationLevelOptions,
              dict
            )}
          </p>
        )}
      </div>
      <div className="sm:col-span-2">
        <Label
          htmlFor="education"
          className="block mb-1.5 text-xs font-medium text-gray-600"
        >
          {dict.cards.education.detailsLabel}
        </Label>
        {isEditing && !viewOnly ? (
          <Input
            id="education"
            value={formData.education || ''}
            onChange={(e) =>
              handleChange('education', e.target.value)
            }
            placeholder={dict.cards.education.detailsPlaceholder}
            className="h-9 text-sm focus:ring-cyan-500"
          />
        ) : (
          <p className="text-sm text-gray-800 font-medium mt-1">
            {renderDisplayValue(formData.education, dict)}
          </p>
        )}
      </div>
      <div className="sm:col-span-2">
        <Label
          htmlFor="occupation"
          className="block mb-1.5 text-xs font-medium text-gray-600"
        >
          {dict.cards.education.occupationLabel}
        </Label>
        {isEditing && !viewOnly ? (
          <Input
            id="occupation"
            value={formData.occupation || ''}
            onChange={(e) =>
              handleChange('occupation', e.target.value)
            }
            placeholder={dict.cards.education.occupationPlaceholder}
            className="h-9 text-sm focus:ring-cyan-500"
            maxLength={20}
          />
        ) : (
          <p className="text-sm text-gray-800 font-medium mt-1">
            {renderDisplayValue(formData.occupation, dict)}
          </p>
        )}
      </div>
      <div>
        <Label
          htmlFor="serviceType"
          className="block mb-1.5 text-xs font-medium text-gray-600"
        >
          {dict.cards.education.serviceTypeLabel}
        </Label>
        {isEditing && !viewOnly ? (
          <Select
            dir={direction}
            value={formData.serviceType || ''}
            onValueChange={(value) =>
              handleChange(
                'serviceType',
                (value as ServiceType) || undefined
              )
            }
          >
            <SelectTrigger
              id="serviceType"
              className="h-9 text-sm focus:ring-cyan-500 text-start"
            >
              <SelectValue
                placeholder={
                  dict.cards.education.serviceTypePlaceholder
                }
              />
            </SelectTrigger>
            <SelectContent className="max-h-[250px]">
              {serviceTypeOptions.map((opt) => (
                <SelectItem key={opt.value} value={opt.value}>
                  {opt.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        ) : (
          <p className="text-sm text-gray-800 font-medium mt-1">
            {renderSelectDisplayValue(
              formData.serviceType,
              serviceTypeOptions,
              dict
            )}
          </p>
        )}
      </div>
      <div className="sm:col-span-2">
        <Label
          htmlFor="serviceDetails"
          className="block mb-1.5 text-xs font-medium text-gray-600"
        >
          {dict.cards.education.serviceDetailsLabel}
        </Label>
        {isEditing && !viewOnly ? (
          <Input
            id="serviceDetails"
            value={formData.serviceDetails || ''}
            onChange={(e) =>
              handleChange('serviceDetails', e.target.value)
            }
            placeholder={
              dict.cards.education.serviceDetailsPlaceholder
            }
            className="h-9 text-sm focus:ring-cyan-500"
          />
        ) : (
          <p className="text-sm text-gray-800 font-medium mt-1">
            {renderDisplayValue(formData.serviceDetails, dict)}
          </p>
        )}
      </div>
    </div>
  </CardContent>

  {/* --- ✨ START: CV SECTION INTEGRATION ✨ --- */}
  {/* This section is added after CardContent to appear at the bottom of the card */}
<CvUploadSection
    cvUrl={formData.cvUrl}
    isUploading={isCvUploading ?? false}
    onUpload={onCvUpload || (async () => {})}
    onDelete={onCvDelete || (async () => {})}
    disabled={viewOnly || !isEditing}
    dict={dict.cards.education.cvSection}
/>
  {/* --- ✨ END: CV SECTION INTEGRATION ✨ --- */}

</Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-amber-50/40 to-yellow-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Smile className="w-5 h-5 text-amber-600" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.character.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-sm font-medium text-gray-700">
                    {dict.cards.character.traitsLabel}
                  </legend>
                  {isEditing && !viewOnly ? (
                    <div className="flex flex-wrap gap-2">
                      {characterTraitsOptions.map((trait) => (
                        <Button
                          key={trait.value}
                          type="button"
                          variant={
                            (formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectToggle(
                              'profileCharacterTraits',
                              trait.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.profileCharacterTraits || []).length >=
                              3 &&
                            !(formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                              ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {trait.icon && (
                            <trait.icon className="w-3.5 h-3.5 ms-1.5" />
                          )}
                          {trait.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.profileCharacterTraits,
                        characterTraitsOptions,
                        dict.cards.character.traitsEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-sm font-medium text-gray-700">
                    {dict.cards.character.hobbiesLabel}
                  </legend>
                  {isEditing && !viewOnly ? (
                    <div className="flex flex-wrap gap-2">
                      {hobbiesOptions.map((hobby) => (
                        <Button
                          key={hobby.value}
                          type="button"
                          variant={
                            (formData.profileHobbies || []).includes(
                              hobby.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectToggle(
                              'profileHobbies',
                              hobby.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.profileHobbies || []).length >= 3 &&
                            !(formData.profileHobbies || []).includes(
                              hobby.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.profileHobbies || []).includes(
                              hobby.value
                            )
                              ? 'bg-sky-500 hover:bg-sky-600 text-white border-sky-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {hobby.icon && (
                            <hobby.icon className="w-3.5 h-3.5 ms-1.5" />
                          )}
                          {hobby.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.profileHobbies,
                        hobbiesOptions,
                        dict.cards.character.hobbiesEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
            <NeshamaTechSummaryCard
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />
          </div>
        </div>
      </div>

      {/* ======================= START: MOBILE STICKY FOOTER ======================= */}
      {isEditing && !viewOnly && (
        <div className="sticky bottom-0 z-20 mt-4 border-t border-gray-200 bg-white/90 p-4 backdrop-blur-md shadow-[0_-4px_15px_-5px_rgba(0,0,0,0.15)] sm:hidden">
          <div className="flex items-center justify-center gap-3">
            <Button
              variant="outline"
              size="sm"
              onClick={handleCancel}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2"
            >
              <X className="w-4 h-4 ms-1.5" />
              {dict.buttons.cancel}
            </Button>
            <Button
              variant="default"
              size="sm"
              onClick={handleSave}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2"
            >
              <Save className="w-4 h-4 ms-1.5" />
              {dict.buttons.saveChanges}
            </Button>
          </div>
        </div>
      )}
      {/* ======================= END: MOBILE STICKY FOOTER ======================= */}
    </div>
  );
};

export default ProfileSection;
--- End of Content for ProfileSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\QuestionnaireResponsesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/profile/sections/QuestionnaireResponsesSection.tsx

import React, { useState, useMemo, useEffect } from 'react';
import { Progress } from '@/components/ui/progress';
import Link from 'next/link';
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  CardDescription,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
// Textarea is no longer needed for editing here, but might be used elsewhere.
// Keeping it for now, but it can be removed if not used in other contexts.
import {
  Book,
  CheckCircle,
  Clock,
  Pencil,

  Save,
  Eye,
  EyeOff,
  Loader2,
  ArrowRight,
  ArrowLeft,
  Trash2,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import {
  Tooltip,
  TooltipProvider,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip';

import type {
  QuestionnaireResponse,
  FormattedAnswer,
  UpdateValue,
} from '@/types/next-auth';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { WORLDS_CONFIG } from '../constants';

const QUESTIONNAIRE_URL = '/questionnaire';

interface QuestionnaireResponsesSectionProps {
  questionnaire: QuestionnaireResponse | null;
  onUpdate?: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isEditable?: boolean;
  dict: ProfilePageDictionary;
  locale: string;
}

interface QuestionCardProps {
  question: string;
  answer: FormattedAnswer;
  isEditingGlobally: boolean;
  worldKey: string;
  onUpdate: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isFirstInList?: boolean;
  dict: ProfilePageDictionary;
  locale: string;
}

interface WorldSectionProps {
  worldKey: keyof typeof WORLDS_CONFIG;
  worldConfig: (typeof WORLDS_CONFIG)[keyof typeof WORLDS_CONFIG];
  answers: FormattedAnswer[];
  isEditingGlobally: boolean;
  onUpdate: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isCompleted: boolean;
  className?: string;
  dict: ProfilePageDictionary;
  locale: string;
}

const QuestionCard: React.FC<QuestionCardProps> = ({
  question,
  answer,
  isEditingGlobally,
  worldKey,
  onUpdate,
  dict,
  locale,
}) => {
  // --- START: שינויים ---
  // הסרת מצבים הקשורים לעריכת טקסט מקומית
  // const [isEditingText, setIsEditingText] = useState(false);
  // const [editValue, setEditValue] = useState(answer.displayText);
  // const [isSavingText, setIsSavingText] = useState(false);
  const [isSavingVisibility, setIsSavingVisibility] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [currentIsVisible, setCurrentIsVisible] = useState(
    answer.isVisible ?? true
  );
  // --- END: שינויים ---

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const t = dict.questionnaireSection.questionCard;

  useEffect(() => {
    setCurrentIsVisible(answer.isVisible ?? true);
  }, [answer.isVisible]);

  // --- START: שינויים ---
  // עדכון המשתנה isSaving כדי שיכלול רק את המצבים הרלוונטיים
  const isSaving = isSavingVisibility || isDeleting;
  // --- END: שינויים ---

  // --- START: שינויים ---
  // הסרת פונקציות הקשורות לעריכת טקסט מקומית
  /*
  const handleStartEdit = () => {
    if (isSaving) return;
    setIsEditingText(true);
    setEditValue(answer.displayText);
  };

  const handleSaveText = async () => {
    if (!editValue?.trim()) {
      toast.error(t.toasts.emptyAnswer);
      return;
    }
    if (editValue.trim() === answer.displayText) {
      setIsEditingText(false);
      return;
    }

    setIsSavingText(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'answer',
        value: editValue.trim(),
      });
      toast.success(t.toasts.updateSuccess);
      setIsEditingText(false);
    } catch (error) {
      console.error('Error updating answer:', error);
      toast.error(t.toasts.updateError);
    } finally {
      setIsSavingText(false);
    }
  };

  const handleCancelEdit = () => {
    setIsEditingText(false);
    setEditValue(answer.displayText);
  };
  */
  // --- END: שינויים ---

  const handleVisibilityChange = async (newIsVisibleState: boolean) => {
    setCurrentIsVisible(newIsVisibleState);
    setIsSavingVisibility(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'visibility',
        isVisible: newIsVisibleState,
      });
      toast.success(t.toasts.visibilitySuccess);
    } catch (error) {
      console.error('Error updating visibility:', error);
      toast.error(t.toasts.visibilityError);
      setCurrentIsVisible(answer.isVisible ?? true);
    } finally {
      setIsSavingVisibility(false);
    }
  };

  const handleDelete = async () => {
    if (isSaving) return;

    const isConfirmed = window.confirm(t.deleteConfirm.message);
    if (!isConfirmed) {
      return;
    }

    setIsDeleting(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'delete',
      });
      toast.success(t.toasts.deleteSuccess);
    } catch (error) {
      console.error('Error deleting answer:', error);
      toast.error(t.toasts.deleteError);
    } finally {
      setIsDeleting(false);
    }
  };

  const renderAnswerContent = () => {
    // --- START: התיקון המרכזי ---
    if (
      answer.questionType === 'budgetAllocation' &&
      typeof answer.rawValue === 'object' &&
      answer.rawValue !== null &&
      !Array.isArray(answer.rawValue)
    ) {
      // השרת כבר הכין לנו את הטקסט המתורגם ב-displayText.
      // נשתמש בו ונוסיף את העיצוב הגרפי.

      // פיצול ה-displayText כדי לקבל את התוויות המתורגמות
      const displayItems = answer.displayText.split(' | ').map((item) => {
        const parts = item.split(': ');
        return { label: parts[0].trim(), value: parseInt(parts[1], 10) };
      });

      return (
        <div className="w-full space-y-3">
          {displayItems.map(({ label, value }) => (
            <div key={label}>
              <div className="flex justify-between items-center text-sm mb-1">
                <span className="text-gray-800 font-medium">{label}</span>
                <span className="text-gray-600 font-semibold">
                  {value}
                  {question.includes('%') ? '%' : ''}
                </span>
              </div>
              <Progress value={value} />
            </div>
          ))}
        </div>
      );
    }
    // --- END: התיקון המרכזי ---

    // הלוגיקה הקיימת לשאר סוגי השאלות נשארת זהה
    return (
      <p className="text-sm text-gray-800 break-words overflow-wrap-anywhere whitespace-pre-wrap">
        {answer.displayText}
      </p>
    );
  };
  const getVisibilityTooltip = () => {
    if (isEditingGlobally) {
      return currentIsVisible
        ? t.visibilityTooltip.editing.visible
        : t.visibilityTooltip.editing.hidden;
    }
    return currentIsVisible
      ? t.visibilityTooltip.viewing.visible
      : t.visibilityTooltip.viewing.hidden;
  };

  // --- START: שינויים ---
  // הגדרת ה-URL לעריכה שיהיה זהה לכל סוגי השאלות
  const editUrl = `/${locale}/questionnaire?world=${worldKey}&question=${answer.questionId}`;
  // בחירת טקסט גנרי עבור ה-Tooltip. אפשר להוסיף מפתח חדש ל-dictionary אם רוצים.
  const editTooltipText =
    answer.questionType === 'budgetAllocation'
      ? t.editTooltip.budget
      : t.editTooltip.text;
  // --- END: שינויים ---

  return (
    <div
      className="rounded-lg border bg-card p-4 shadow-sm transition-shadow duration-300 hover:shadow-md"
      dir={direction}
    >
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-2">
            <h4 className="font-medium text-sm sm:text-base flex-1 text-start">
              {question}
            </h4>
            <div className="flex items-center gap-2 self-end sm:self-center">
              {isDeleting && (
                <Loader2 className="h-4 w-4 animate-spin text-red-500" />
              )}
              {isSavingVisibility && (
                <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
              )}
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      role="switch"
                      aria-checked={currentIsVisible}
                      disabled={!isEditingGlobally || isSaving}
                      onClick={() => handleVisibilityChange(!currentIsVisible)}
                      className={cn(
                        'inline-flex items-center justify-center h-8 px-3 rounded-full gap-2 transition-all duration-200 ease-in-out',
                        'disabled:opacity-100 disabled:cursor-default',
                        currentIsVisible
                          ? 'bg-emerald-100 text-emerald-800'
                          : 'bg-gray-200 text-gray-600',
                        isEditingGlobally &&
                          !isSaving &&
                          'hover:shadow-md active:scale-95',
                        isEditingGlobally &&
                          !isSaving &&
                          currentIsVisible &&
                          'hover:bg-emerald-200',
                        isEditingGlobally &&
                          !isSaving &&
                          !currentIsVisible &&
                          'hover:bg-gray-300'
                      )}
                    >
                      {currentIsVisible ? (
                        <Eye className="h-3.5 w-3.5" />
                      ) : (
                        <EyeOff className="h-3.5 w-3.5" />
                      )}
                      <span className="text-xs font-medium whitespace-nowrap">
                        {currentIsVisible
                          ? t.visibilityButton.visible
                          : t.visibilityButton.hidden}
                      </span>
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" dir={direction}>
                    <p>{getVisibilityTooltip()}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
          </div>
          {/* --- START: שינויים --- */}
          {/* הסרת ה-Conditional Rendering של עריכה מקומית */}
          <div className="relative group overflow-hidden mt-1">
            <div className="p-3 bg-gray-50/50 rounded-md border border-gray-200/60 min-h-[40px]">
              {renderAnswerContent()}
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <span className="text-xs text-gray-400 block mt-2 text-start">
                      {new Date(answer.answeredAt).toLocaleDateString(
                        locale === 'he' ? 'he-IL' : 'en-US',
                        { year: 'numeric', month: '2-digit', day: '2-digit' }
                      )}
                    </span>
                  </TooltipTrigger>
                  <TooltipContent side="top" dir={direction}>
                    <p>{t.dateTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>

            {isEditingGlobally && !isSaving && (
              // --- START: התיקון כאן ---
              <div className="absolute top-0 end-0 opacity-100 transition-opacity duration-200 flex items-center">
                <TooltipProvider delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-red-500 hover:bg-red-50"
                        onClick={handleDelete}
                        disabled={isSaving}
                      >
                        <Trash2 className="h-4 w-4" />
                        <span className="sr-only">{t.editTooltip.delete}</span>
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent side="top" dir={direction}>
                      <p>{t.editTooltip.delete}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>

                <TooltipProvider delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        asChild
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-cyan-600 hover:bg-cyan-50"
                      >
                        <a href={editUrl}>
                          <Pencil className="h-4 w-4" />
                          <span className="sr-only">{editTooltipText}</span>
                        </a>
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent side="top" dir={direction}>
                      <p>{editTooltipText}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
            )}
          </div>
          {/* --- END: שינויים --- */}
        </div>
      </div>
    </div>
  );
};

// ... (שאר הרכיבים WorldSection ו-QuestionnaireResponsesSection נשארים ללא שינוי)

const WorldSection: React.FC<WorldSectionProps> = ({
  worldKey,
  worldConfig,
  answers,
  isEditingGlobally,
  onUpdate,
  isCompleted,
  className,
  dict,
  locale,
}) => {
  const { icon: Icon, color, bgColor, borderColor } = worldConfig;
  const t = dict.questionnaireSection.worldSection;
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const title = dict.questionnaireSection.worlds[worldKey]?.title || worldKey;
  const answerCountText = `${answers.length} ${
    answers.length === 1 ? t.answerSingular : t.answerPlural
  }`;

  return (
    <Card
      className={cn(
        'overflow-hidden shadow-sm border',
        bgColor,
        borderColor,
        className
      )}
      dir={direction}
    >
      <CardHeader
        className="p-4 border-b"
        style={{
          borderColor: `rgba(var(--${color.split('-')[1]}-200-rgb), 0.5)`,
        }}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div
              className={cn(
                'p-2 rounded-full',
                color.replace('text-', 'bg-') + '/10'
              )}
            >
              <Icon className={cn('h-5 w-5', color)} />
            </div>
            <div>
              <CardTitle className="text-md sm:text-lg text-gray-800">
                {title}
              </CardTitle>
              <CardDescription className="text-xs text-gray-500 mt-0.5">
                {answerCountText}
              </CardDescription>
            </div>
          </div>
          <Badge
            variant={isCompleted ? 'success' : 'secondary'}
            className={cn(
              'gap-1 text-xs px-2 py-0.5 rounded-full',
              isCompleted
                ? 'bg-emerald-100 text-emerald-800'
                : 'bg-blue-100 text-blue-800'
            )}
          >
            {isCompleted ? (
              <CheckCircle className="h-3 w-3" />
            ) : (
              <Clock className="h-3 w-3" />
            )}
            {isCompleted ? t.status.completed : t.status.inProgress}
          </Badge>
        </div>
      </CardHeader>
      <CardContent className="p-4 pt-4">
        <div className="space-y-4">
          {answers.map((answer, index) => (
            <QuestionCard
              key={answer.questionId}
              question={answer.question}
              answer={answer}
              isFirstInList={index === 0}
              isEditingGlobally={isEditingGlobally}
              worldKey={worldKey}
              onUpdate={onUpdate}
              dict={dict}
              locale={locale}
            />
          ))}
        </div>
      </CardContent>
    </Card>
  );
};

const QuestionnaireResponsesSection: React.FC<
  QuestionnaireResponsesSectionProps
> = ({ questionnaire, onUpdate, isEditable = false, dict, locale }) => {
  const [isEditingGlobally, setIsEditingGlobally] = useState(false);

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const ArrowIcon = direction === 'rtl' ? ArrowLeft : ArrowRight;
  const t = dict.questionnaireSection;

  const worldsWithAnswers = useMemo(() => {
    if (!questionnaire?.formattedAnswers) {
      console.log(
        '---[ CLIENT LOG | QuestionnaireResponsesSection useMemo ]--- אין "formattedAnswers". מחזיר מערך ריק.'
      );
      return [];
    }

    console.log(
      '---[ CLIENT LOG | QuestionnaireResponsesSection useMemo ]--- נמצא "formattedAnswers". מעבד את העולמות.'
    );

    return Object.entries(WORLDS_CONFIG)
      .map(([key, config]) => ({
        key: key as keyof typeof WORLDS_CONFIG,
        config,
        answers:
          questionnaire.formattedAnswers?.[
            key.toUpperCase() as keyof typeof questionnaire.formattedAnswers // ✨ התיקון: המרת המפתח לאותיות גדולות
          ] ?? [],
        isCompleted:
          (questionnaire[
            `${key.toLowerCase()}Completed` as keyof QuestionnaireResponse
          ] as boolean) ?? false,
      }))
      .filter((world) => world.answers.length > 0);
  }, [questionnaire]);

  if (!questionnaire) {
    const emptyStateT = t.emptyState;
    return (
      <Card
        className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border border-dashed"
        dir={direction}
      >
        <Book className="h-10 w-10 mx-auto mb-3 opacity-50 text-gray-400" />
        <p className="font-medium">{emptyStateT.title}</p>
        <p className="text-sm mt-1">{emptyStateT.subtitle}</p>
        <div className="mt-6">
          <Button
            asChild
            variant="default"
            className="bg-cyan-600 hover:bg-cyan-700"
          >
            <Link
              href={QUESTIONNAIRE_URL}
              className="flex items-center gap-1.5"
            >
              {emptyStateT.button} <ArrowIcon className="h-4 w-4" />
            </Link>
          </Button>
        </div>
      </Card>
    );
  }

  const hasAnyAnswers = worldsWithAnswers.length > 0;
  const headerT = t.header;

  return (
    <div className="space-y-6" dir={direction}>
      <Card className="shadow-sm border">
        <CardHeader className="p-6 space-y-4">
          {/* שורה ראשונה - כותרת ומידע */}
          <div className="flex items-center justify-center gap-3">
            {' '}
            {questionnaire.completed ? (
              <CheckCircle className="h-6 w-6 text-emerald-500 flex-shrink-0" />
            ) : (
              <Clock className="h-6 w-6 text-blue-500 flex-shrink-0" />
            )}
            <div>
              <h2 className="text-xl font-semibold text-gray-800">
                {questionnaire.completed
                  ? headerT.title.completed
                  : headerT.title.inProgress}
              </h2>
              <p className="text-sm text-gray-500 mt-1">
                {hasAnyAnswers
                  ? `${headerT.lastUpdated}: ${new Date(
                      questionnaire.lastSaved
                    ).toLocaleDateString(locale === 'he' ? 'he-IL' : 'en-US')}`
                  : headerT.notStarted}
              </p>
            </div>
          </div>

          {/* שורה שנייה - כפתורים */}
          <div className="flex items-center justify-center gap-3 pt-2 border-t border-gray-100">
            <Button asChild variant="outline" size="sm" className="h-9 px-4">
              <Link
                href={QUESTIONNAIRE_URL}
                className="flex items-center gap-2"
              >
                {headerT.goToButton}
                <ArrowIcon className="h-4 w-4" />
              </Link>
            </Button>

            {isEditable && hasAnyAnswers && onUpdate && (
              <Button
                variant={isEditingGlobally ? 'default' : 'outline'}
                size="sm"
                onClick={() => setIsEditingGlobally(!isEditingGlobally)}
                className="h-9 px-4 gap-2"
              >
                {isEditingGlobally ? (
                  <>
                    <Save className="h-4 w-4" />
                    {headerT.editButton.finish}
                  </>
                ) : (
                  <>
                    <Pencil className="h-4 w-4" />
                    {headerT.editButton.start}
                  </>
                )}
              </Button>
            )}
          </div>
        </CardHeader>
      </Card>
      {/* שאר הקוד נשאר זהה... */}
      {hasAnyAnswers ? (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {worldsWithAnswers.map(({ key, config, answers, isCompleted }) => (
            <WorldSection
              key={key}
              worldKey={key}
              worldConfig={config}
              answers={answers}
              isEditingGlobally={isEditingGlobally}
              onUpdate={onUpdate!}
              isCompleted={isCompleted}
              dict={dict}
              locale={locale}
            />
          ))}
        </div>
      ) : (
        <div className="text-center py-10 text-gray-500 bg-gray-50/50 rounded-lg border border-gray-200">
          <Book className="h-8 w-8 mx-auto mb-2 opacity-50 text-gray-400" />
          <p className="font-medium text-lg">{t.noAnswersState.title}</p>
          <p className="text-sm mt-1 text-gray-600">
            {t.noAnswersState.subtitle}
          </p>
          <div className="mt-6">
            <Button
              asChild
              variant="default"
              className="bg-cyan-600 hover:bg-cyan-700 text-white"
            >
              <Link
                href={QUESTIONNAIRE_URL}
                className="flex items-center gap-1.5 px-6 py-2"
              >
                {t.noAnswersState.button} <ArrowIcon className="h-4 w-4" />
              </Link>
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default QuestionnaireResponsesSection;
--- End of Content for QuestionnaireResponsesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\UnifiedProfileDashboard.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { useSession } from 'next-auth/react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import type { User as SessionUserType } from '@/types/next-auth';

// Child Components
import { ProfileChecklist } from './ProfileChecklist';
import { AIProfileAdvisorDialog } from './AIProfileAdvisorDialog';
import { NeshmaInsightButton } from './NeshmaInsightButton';

// UI Components
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogTrigger } from '@/components/ui/dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area';

// Shared Profile Components
import {
  ProfileCard,
  PhotosSection,
  PreferencesSection,
  ProfileSection,
  QuestionnaireResponsesSection,
} from '@/components/profile';

// Icons
import { Eye, Loader2 } from 'lucide-react';

// Types
import type {
  UserProfile,
  UserImage,
  QuestionnaireResponse,
  UpdateValue, // <-- פתרון בעיית ה-any
} from '@/types/next-auth';
import type { ProfilePageDictionary } from '@/types/dictionary';

// Props interface for the component, now including the dictionary
interface UnifiedProfileDashboardProps {
  viewOnly?: boolean;
  userId?: string;
  initialTab?: string;
  dict: ProfilePageDictionary;
  locale: 'he' | 'en';
}

const UnifiedProfileDashboard: React.FC<UnifiedProfileDashboardProps> = ({
  viewOnly = false,
  userId,
  initialTab = 'overview',
  dict,
  locale, // Destructure locale
}) => {
  console.log(
    `---[ CLIENT LOG 3 | UnifiedProfileDashboard.tsx ]--- הרכיב נטען. הוא קיבל את ה-prop "initialTab" עם הערך: "${initialTab}".`
  );

  const {
    data: session,
    status: sessionStatus,
    update: updateSession,
  } = useSession();
  const router = useRouter();

  // State hooks
  const [profileData, setProfileData] = useState<UserProfile | null>(null);
  const [images, setImages] = useState<UserImage[]>([]);
  const [questionnaireResponse, setQuestionnaireResponse] =
    useState<QuestionnaireResponse | null>(null);
  const [activeTab, setActiveTab] = useState(initialTab);
  console.log(
    `---[ CLIENT LOG 4 | UnifiedProfileDashboard.tsx ]--- מאתחל את ה-state של "activeTab". הערך כעת הוא: "${activeTab}". ערך זה שולט על רכיב ה-Tabs.`
  );
// Inside UnifiedProfileDashboard component
const [isCvUploading, setIsCvUploading] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState('');
  const [previewOpen, setPreviewOpen] = useState(false);
  const [hasSeenPreview, setHasSeenPreview] = useState(
    session?.user?.profile?.hasViewedProfilePreview || false
  );
  const [completionPercentage, setCompletionPercentage] = useState(0);
  const direction = locale === 'he' ? 'rtl' : 'ltr'; // Define direction based on locale

  useEffect(() => {
    setActiveTab(initialTab);
  }, [initialTab]);

  // --- קוד מעודכן ---
  // src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

  const handleTabChange = (newTab: string) => {
    // --- לוג מקדים ---
    console.log(
      `---[ CLIENT LOG 5 | UnifiedProfileDashboard.tsx ]--- handleTabChange נקראה עם הטאב החדש: "${newTab}".`
    );

    console.log(
      `---[ CLIENT LOG 5 | UnifiedProfileDashboard.tsx ]--- handleTabChange נקראה עם הטאב החדש: "${newTab}".`
    );

    setActiveTab(newTab);
    // ✨ התיקון המרכזי: הוספת משתנה ה-locale לכתובת ה-URL
    router.push(`/${locale}/profile?tab=${newTab}`, { scroll: false });

    // הגדלנו מעט את ההשהיה כדי לתת ל-React יותר זמן לעבד את השינוי ב-DOM.
    setTimeout(() => {
      console.log(
        `---[ CLIENT LOG 6 | UnifiedProfileDashboard.tsx ]--- ה-setTimeout של הגלילה החל. מנסה לגלול לטאב: "${newTab}".`
      );

      const elementId = `${newTab}-content`;
      console.log(
        `---[ CLIENT LOG 7 | UnifiedProfileDashboard.tsx ]--- מחפש אלמנט עם ID דינמי: "${elementId}".`
      );

      const element = document.getElementById(elementId);

      // --- זהו הלוג הקריטי ביותר ---
      if (element) {
        console.log(
          `✅ ---[ CLIENT LOG 8 | UnifiedProfileDashboard.tsx ]--- הצלחה! האלמנט נמצא. גולל אליו.`,
          element
        );
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        console.error(
          `❌ ---[ CLIENT LOG 8 | UnifiedProfileDashboard.tsx ]--- כישלון! האלמנט עם ID "${elementId}" לא נמצא ב-DOM ברגע זה. הגלילה נכשלה.`
        );

        // ננסה לגלוש לאלמנט החלופי כדי לראות אם הוא קיים
        const fallbackElement = document.getElementById('profile-tabs-content');
        if (fallbackElement) {
          console.warn(
            `---[ CLIENT LOG 9 | UnifiedProfileDashboard.tsx ]--- נסוג לגלילה לאלמנט החלופי "profile-tabs-content".`
          );
          fallbackElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
          });
        } else {
          console.error(
            `❌ ---[ CLIENT LOG 9 | UnifiedProfileDashboard.tsx ]--- כישלון קריטי! גם אלמנט הגיבוי "profile-tabs-content" לא נמצא.`
          );
        }
      }
    }, 150); // הגדלתי מעט את הזמן ל-150ms
  };

  const isOwnProfile = !userId || session?.user?.id === userId;

  const loadData = useCallback(async () => {
    setIsLoading(true);
    setError('');
    try {
      // Fetch profile data
      const profileUrl = userId
        ? `/api/profile?userId=${userId}`
        : '/api/profile';
      const profileResponse = await fetch(profileUrl);
      const profileJson = await profileResponse.json();

      if (!profileResponse.ok || !profileJson.success) {
        throw new Error(profileJson.message || 'Failed to load profile');
      }
      console.log('---[ CLIENT LOG 1 ]--- Received Profile Data from API:');
      console.log(profileJson.profile);

      setProfileData(profileJson.profile);
      setImages(profileJson.images || []);
      if (profileJson.profile?.hasViewedProfilePreview) {
        setHasSeenPreview(true);
      }

      // Fetch questionnaire data
      const params = new URLSearchParams();
      if (userId) {
        params.append('userId', userId);
      }
      params.append('locale', locale); // ✨ הוספת פרמטר השפה

      const questionnaireUrl = `/api/profile/questionnaire?${params.toString()}`;

      const questionnaireFetchResponse = await fetch(questionnaireUrl);

      console.log(
        `---[ CLIENT LOG | Dashboard loadData ]--- סטטוס תגובה מ-API השאלון: ${questionnaireFetchResponse.status}`
      );

      if (questionnaireFetchResponse.status === 404) {
        setQuestionnaireResponse(null);
      } else if (questionnaireFetchResponse.ok) {
        const questionnaireJson = await questionnaireFetchResponse.json();
        console.log(
          '---[ DEBUG LOG | Questionnaire API Response ]---',
          questionnaireJson
        );

        console.log(
          '---[ CLIENT LOG | Dashboard loadData ]--- התקבל JSON מה-API:',
          questionnaireJson
        );

        if (questionnaireJson.success) {
          setQuestionnaireResponse(questionnaireJson.questionnaireResponse);
        } else {
          console.warn(
            'Could not load questionnaire. Reason:',
            questionnaireJson.message
          );
          setQuestionnaireResponse(null);
        }
      } else {
        console.error(
          'Failed to fetch questionnaire data. Status:',
          questionnaireFetchResponse.status
        );
        setQuestionnaireResponse(null);
      }
    } catch (err: unknown) {
      console.error('Failed to load profile data:', err);
      let errorMessage = 'An unexpected error occurred.';
      if (err instanceof Error) {
        errorMessage = err.message || errorMessage;
      }
      const translatedError = dict.dashboard.loadError.replace(
        '{{error}}',
        errorMessage
      );
      setError(translatedError);
      toast.error(translatedError);
    } finally {
      setIsLoading(false);
    }
  }, [userId, dict]);
// Add these two functions inside the UnifiedProfileDashboard component

// src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

// בקובץ: src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

const handleCvUpload = async (file: File) => {
  setIsCvUploading(true);
  // ✨ הגדרת משתנה עזר לנתיב הנכון של ה-toasts
  const cvToasts = dict.profileSection.cards.education.cvSection.toasts;

  try {
    const formData = new FormData();
    formData.append('cv', file);

    const response = await fetch('/api/profile/cv', {
      method: 'POST',
      body: formData,
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.message || 'Failed to upload CV');
    }

    // ✨ עדכון ישיר של ה-state עם הפרופיל המעודכן שהתקבל מה-API
    if (data.profile) {
      setProfileData(data.profile);
      // ✨ שימוש בנתיב הנכון והמדויק להודעת ההצלחה
      toast.success(cvToasts.uploadSuccess);
    }
    
  } catch (err) {
    const errorMessage = err instanceof Error ? err.message : cvToasts.uploadError;
    // ✨ שימוש בנתיב הנכון להודעת השגיאה
    toast.error(errorMessage);
  } finally {
    setIsCvUploading(false);
  }
};

const handleCvDelete = async () => {
  setIsCvUploading(true);
  // ✨ הגדרת משתנה עזר לנתיב הנכון של ה-toasts
  const cvToasts = dict.profileSection.cards.education.cvSection.toasts;

  try {
    const response = await fetch('/api/profile/cv', {
      method: 'DELETE',
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.message || 'Failed to delete CV');
    }

    // ✨ עדכון ישיר של ה-state עם הפרופיל המעודכן
    if (data.profile) {
      setProfileData(data.profile);
      // ✨ שימוש בנתיב הנכון להודעת ההצלחה
      toast.success(cvToasts.deleteSuccess);
    }

  } catch (err) {
    const errorMessage = err instanceof Error ? err.message : cvToasts.deleteError;
    // ✨ שימוש בנתיב הנכון להודעת השגיאה
    toast.error(errorMessage);
  } finally {
    setIsCvUploading(false);
  }
};

  useEffect(() => {
    if (sessionStatus === 'authenticated') {
      loadData();
    }
  }, [sessionStatus, loadData]);

  useEffect(() => {
    const handleVisibilityChange = () => {
      if (
        document.visibilityState === 'visible' &&
        sessionStatus === 'authenticated'
      ) {
        loadData();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [loadData, sessionStatus]);

  const handlePreviewClick = async () => {
    setPreviewOpen(true);
    if (!hasSeenPreview) {
      try {
        const response = await fetch('/api/profile/viewed-preview', {
          method: 'POST',
        });
        if (!response.ok) {
          throw new Error('Failed to update preview status');
        }
        setHasSeenPreview(true);
        toast.success(dict.dashboard.viewedPreviewSuccess);
        await updateSession();
      } catch (error) {
        console.error('Error in handlePreviewClick:', error);
        toast.error(dict.dashboard.viewedPreviewError);
      }
    }
  };

  const handleSave = async (formData: Partial<UserProfile>) => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const data = await response.json();
      if (data.success && data.profile) {
        await updateSession();
        setProfileData(data.profile);
        setIsEditing(false);
        toast.success(dict.dashboard.updateSuccess);
        setError('');
      } else {
        const errorMessage = data.message || 'Profile update error';
        const translatedError = dict.dashboard.updateError.replace(
          '{{error}}',
          errorMessage
        );
        setError(translatedError);
        toast.error(translatedError);
      }
    } catch (err) {
      console.error('Save error:', err);
      const errorMessage = 'Profile update error';
      const translatedError = dict.dashboard.updateError.replace(
        '{{error}}',
        errorMessage
      );
      setError(translatedError);
      toast.error(translatedError);
    } finally {
      setIsLoading(false);
    }
  };

  // --- השלמת הפונקציות החסרות עם תרגום ---

  const handleImageUpload = async (files: File[]) => {
    if (!files || files.length === 0) return;

    setIsLoading(true);
    const uploadedImages: UserImage[] = [];
    const failedUploads: string[] = [];
    const toastsDict = dict.photosSection.toasts;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const toastId = `upload-${i}`;
      const loadingMsg = dict.photosSection.uploadingMultiple.replace(
        '{{count}}',
        `${i + 1}/${files.length}`
      );

      try {
        toast.loading(loadingMsg, { id: toastId });

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/profile/images', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success && data.image) {
          uploadedImages.push(data.image);
          toast.success(
            `${file.name} uploaded successfully!`, // This specific string is often kept in English for file names
            { id: toastId }
          );
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (err) {
        const errorMessage =
          err instanceof Error ? err.message : toastsDict.uploadError;
        failedUploads.push(`${file.name}: ${errorMessage}`);
        toast.error(`${file.name}: ${errorMessage}`, { id: toastId });
      }
    }

    if (uploadedImages.length > 0) {
      setImages((prev) => [...prev, ...uploadedImages].slice(0, 10)); // Assuming max 10 images
      await updateSession();
      toast.success(
        toastsDict.uploadSuccess.replace(
          '{{count}}',
          String(uploadedImages.length)
        )
      );
      setError('');
    }

    if (failedUploads.length > 0 && uploadedImages.length === 0) {
      setError(toastsDict.uploadError);
      toast.error(toastsDict.uploadError);
    }

    setIsLoading(false);
  };

  const handleSetMainImage = async (imageId: string) => {
    setIsLoading(true);
    try {
      const response = await fetch(`/api/profile/images/${imageId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isMain: true }),
      });
      const data = await response.json();
      if (data.success) {
        setImages(data.images);
        await updateSession();
        toast.success(dict.photosSection.toasts.setMainSuccess);
        setError('');
      } else {
        const errorMsg = data.message || dict.photosSection.toasts.setMainError;
        setError(errorMsg);
        toast.error(errorMsg);
      }
    } catch (err) {
      const errorMsg = dict.photosSection.toasts.setMainError;
      setError(errorMsg);
      toast.error(errorMsg);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDeleteImage = async (imageIds: string[]) => {
    if (!imageIds || imageIds.length === 0) {
      toast.info(dict.photosSection.toasts.selectOneError);
      return;
    }
    setIsLoading(true);
    try {
      const response = await fetch(`/api/profile/images`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageIds }),
      });

      const data = await response.json();
      if (data.success) {
        setImages(data.images);
        await updateSession();
        const successMsg =
          imageIds.length > 1
            ? dict.photosSection.toasts.bulkDeleteSuccess.replace(
                '{{count}}',
                String(imageIds.length)
              )
            : dict.photosSection.toasts.singleDeleteSuccess;
        toast.success(successMsg);
        setError('');
      } else {
        const errorMsg =
          data.message || dict.photosSection.toasts.bulkDeleteError;
        setError(errorMsg);
        toast.error(errorMsg);
      }
    } catch (err) {
      console.error('Delete image error:', err);
      setError(dict.photosSection.toasts.bulkDeleteError);
      toast.error(dict.photosSection.toasts.bulkDeleteError);
    } finally {
      setIsLoading(false);
    }
  };

  // src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

  const handleQuestionnaireUpdate = async (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => {
    // אין צורך ב-setIsLoading(true) כאן, כי loadData עושה זאת בעצמו.
    try {
      const payload = { worldKey: world, questionId: questionId, value };
      const response = await fetch('/api/profile/questionnaire', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (data.success) {
        toast.success(dict.dashboard.tabContent.questionnaireUpdateSuccess);
        setError('');

        // ✨ התיקון: במקום לעדכן עם תגובה חלקית מהשרת,
        // נטען מחדש את כל המידע כדי להבטיח סנכרון מלא.
        await loadData();
      } else {
        const errorMsg =
          data.message || dict.dashboard.tabContent.questionnaireUpdateError;
        setError(errorMsg);
        toast.error(errorMsg);
        // במקרה של שגיאה, נחזיר את המצב הטעינה לקדמותו
        setIsLoading(false);
      }
    } catch (err) {
      console.error('Failed to update questionnaire:', err);
      setError(dict.dashboard.tabContent.questionnaireUpdateError);
      toast.error(dict.dashboard.tabContent.questionnaireUpdateError);
      // גם במקרה של חריגה, נחזיר את המצב הטעינה לקדמותו
      setIsLoading(false);
    }
    // פונקציית loadData כבר משנה את isLoading ל-false בסופה,
    // כך שאין צורך בלוק 'finally'.
  };

  // --- סוף החלק שהושלם ---

  if (isLoading && !profileData) {
    return (
      <div
        role="status"
        aria-live="polite"
        className="flex items-center justify-center min-h-screen bg-gradient-to-br from-cyan-50 via-white to-pink-50"
        dir={direction} // Changed
      >
        <div className="flex items-center gap-2 text-lg text-cyan-600">
          <Loader2 className="animate-spin h-6 w-6" />
          <span>{dict.dashboard.loadingData}</span>
        </div>
      </div>
    );
  }

  if (error && !profileData) {
    return (
      <div
        className="flex items-center justify-center min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50 p-4"
        dir={direction} // Changed
      >
        <Alert variant="destructive" className="max-w-md mx-auto">
          <AlertDescription className="text-center">{error}</AlertDescription>
        </Alert>
      </div>
    );
  }

  const user = session?.user as SessionUserType | undefined;

  return (
    <div className="relative min-h-screen w-full" dir={direction}>
      <div
        className="absolute inset-0 bg-gradient-to-br from-cyan-50 via-white to-pink-50 animate-gradient-slow -z-10"
        style={{ backgroundSize: '400% 400%' }}
      />
      <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#06b6d4_1px,transparent_1px)] [background-size:30px_30px] -z-10"></div>
      <div className="relative max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8 z-10">
        <div className="space-y-6 md:space-y-8">
          {error && (
            <Alert variant="destructive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {isOwnProfile && user && profileData && (
            <>
              <ProfileChecklist
                user={{
                  ...user,
                  profile: profileData,
                  images: images,
                }}
                hasSeenPreview={hasSeenPreview}
                onPreviewClick={handlePreviewClick}
                questionnaireResponse={questionnaireResponse}
                dict={dict.dashboard.checklist}
                locale={locale} // Added
                onNavigateToTab={handleTabChange} // <-- הוסף שורה זו
                onCompletionChange={setCompletionPercentage} // Track completion
              />
              <div className="my-6 md:my-8 flex justify-center">
                <AIProfileAdvisorDialog
                  userId={user.id}
                  dict={dict.dashboard.aiAdvisor}
                  analysisDict={dict.dashboard.analysisResult}
                  locale={locale}
                />
              </div>
              
              
              {/* Neshama Insight Button - Shows in different states based on profile completion */}
              <NeshmaInsightButton
                userId={user.id}
                locale={locale}
                completionPercentage={completionPercentage}
                lastGeneratedAt={user.neshamaInsightLastGeneratedAt}
                generatedCount={user.neshamaInsightGeneratedCount || 0}
                dict={{
                  buttonText: locale === 'he' ? '✨ תובנת נשמה - הדו"ח האישי שלך מוכן!' : '✨ Your Neshama Insight is Ready!',
                  buttonSubtitle: locale === 'he' 
                    ? 'סיימת את הפרופיל! קבלו ניתוח מעמיק ואישי שיעזור לכם להבין את עצמכם טוב יותר ולהתכונן למסע השידוכים.'
                    : 'You completed your profile! Receive a deep, personalized analysis that will help you understand yourself better and prepare for your dating journey.',
                  dialogTitle: locale === 'he' ? 'תובנת נשמה - הדו"ח האישי שלך' : 'Your Neshama Insight',
                  generating: locale === 'he' ? 'יוצרים את התובנה שלך...' : 'Generating your insight...',
                  downloadPdf: locale === 'he' ? 'הורדה כ-PDF' : 'Download as PDF',
                  close: locale === 'he' ? 'סגור' : 'Close',
                  lockedTitle: locale === 'he' ? 'תובנת נשמה - נעולה' : 'Neshama Insight - Locked',
                  lockedDescription: locale === 'he' 
                    ? `השלם את הפרופיל ל-100% כדי לפתוח (כרגע: ${completionPercentage}%)`
                    : `Complete your profile to 100% to unlock (Currently: ${completionPercentage}%)`,
                  alreadyGeneratedToday: locale === 'he' 
                    ? 'כבר יצרת תובנה היום - זמינה מחר'
                    : 'Already generated today - Available tomorrow',
                  minimizedButtonText: locale === 'he' ? 'תובנת נשמה' : 'Neshama Insight',
                }}
              />
            </>
          )}

          {!viewOnly && isOwnProfile && (
            <div
              id="onboarding-target-preview-profile"
              className="flex justify-center my-6 md:my-8"
            >
              <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
                <DialogTrigger asChild>
                  <Button
                    onClick={handlePreviewClick}
                    variant="outline"
                    size="lg"
                    className="px-8 py-3 text-base sm:text-lg gap-2 rounded-full border-2 border-cyan-200 text-cyan-600 hover:bg-cyan-50 hover:border-cyan-400 transition-all duration-300 shadow-sm hover:shadow-md"
                  >
                    {dict.dashboard.previewButton}
                    <Eye className="w-5 h-5 sm:w-6 sm:h-6" />
                  </Button>
                </DialogTrigger>
                <DialogContent className="w-screen h-screen sm:w-[95vw] sm:h-[90vh] sm:max-w-6xl p-0 bg-white/95 backdrop-blur-md sm:rounded-3xl shadow-2xl border-none overflow-hidden">
                  {profileData ? (
                    <ProfileCard
                      profile={profileData}
                      images={images}
                      questionnaire={questionnaireResponse}
                      viewMode="candidate"
                      isProfileComplete={
                        session?.user?.isProfileComplete ?? false
                      }
                      className="h-full"
                      onClose={() => setPreviewOpen(false)}
                      dict={dict.profileCard}
                      locale={locale} // Pass locale to ProfileCard
                    />
                  ) : (
                    <p className="text-center text-gray-500 py-10">
                      {dict.dashboard.previewLoading}
                    </p>
                  )}
                </DialogContent>
              </Dialog>
            </div>
          )}

          <Tabs
            value={activeTab}
            onValueChange={handleTabChange}
            className="w-full"
          >
            <div className="flex justify-center mb-6 md:mb-8">
              <ScrollArea dir={direction} className="w-auto max-w-full">
                <TabsList className="h-auto p-1.5 bg-white/70 backdrop-blur-sm rounded-full shadow-md gap-1 inline-flex flex-nowrap">
                  <TabsTrigger
                    value="overview"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.overview}
                  </TabsTrigger>
                  <TabsTrigger
                    value="photos"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.photos}
                  </TabsTrigger>
                  <TabsTrigger
                    value="preferences"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.preferences}
                  </TabsTrigger>
                  <TabsTrigger
                    value="questionnaire"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.questionnaire}
                  </TabsTrigger>
                </TabsList>
                <ScrollBar orientation="horizontal" className="mt-1" />
              </ScrollArea>
            </div>
            <div
              id="profile-tabs-content"
              className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl transition-all duration-300 ease-in-out scroll-mt-4"
            >
              {/* הוסף id ו-className לכל TabsContent */}
              <TabsContent
                value="overview"
                id="overview-content"
                className="scroll-mt-24" // ✨ שינוי: הגדלת המרווח
              >
                {profileData ? (
                // Inside UnifiedProfileDashboard.tsx, find the <ProfileSection /> component

<ProfileSection
  profile={profileData}
  isEditing={isEditing}
  setIsEditing={setIsEditing}
  onSave={handleSave}
  viewOnly={viewOnly || !isOwnProfile}
  onCvUpload={handleCvUpload}         // ✨ Pass the function
  onCvDelete={handleCvDelete}         // ✨ Pass the function
  isCvUploading={isCvUploading}       // ✨ Pass the state
  dict={dict.profileSection}
  locale={locale}
/>
                ) : (
                  <p className="text-center text-gray-500 py-10">
                    {dict.dashboard.tabContent.loadingOverview}
                  </p>
                )}
              </TabsContent>
              <TabsContent
                value="photos"
                id="photos-content"
                className="scroll-mt-4"
              >
                <PhotosSection
                  images={images}
                  isUploading={isLoading}
                  disabled={viewOnly || !isOwnProfile}
                  onUpload={handleImageUpload}
                  onSetMain={handleSetMainImage}
                  onDelete={handleDeleteImage}
                  dict={dict.photosSection}
                  locale={locale}
                />
              </TabsContent>
              <TabsContent
                value="preferences"
                id="preferences-content"
                className="scroll-mt-4"
              >
                {profileData ? (
                  <PreferencesSection
                    profile={profileData}
                    isEditing={isEditing}
                    setIsEditing={setIsEditing}
                    onChange={handleSave}
                    viewOnly={viewOnly || !isOwnProfile}
                    dictionary={dict.preferencesSection}
                    locale={locale}
                  />
                ) : (
                  <p className="text-center text-gray-500 py-10">
                    {dict.dashboard.tabContent.loadingPreferences}
                  </p>
                )}
              </TabsContent>
              <TabsContent
                value="questionnaire"
                id="questionnaire-content"
                className="scroll-mt-4"
              >
                {questionnaireResponse ? (
                  <QuestionnaireResponsesSection
                    questionnaire={questionnaireResponse}
                    onUpdate={handleQuestionnaireUpdate}
                    isEditable={!viewOnly && isOwnProfile}
                    dict={dict}
                    locale={locale}
                  />
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    {isLoading
                      ? dict.dashboard.tabContent.loadingQuestionnaire
                      : dict.dashboard.tabContent.noQuestionnaire}
                    {!isLoading && isOwnProfile && (
                      <Button
                        asChild
                        variant="link"
                        className="mt-2 text-cyan-600"
                      >
                        <Link href="/questionnaire">
                          {dict.dashboard.tabContent.fillQuestionnaireLink}
                        </Link>
                      </Button>
                    )}
                  </div>
                )}
              </TabsContent>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  );
};

export default UnifiedProfileDashboard;
--- End of Content for UnifiedProfileDashboard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\sections_contents.txt
--------------------------------------------------------------------------------
Content:
################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections
# Generated on: 2025-10-05 13:18:10
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\AIProfileAdvisorDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/advisor/AIProfileAdvisorDialog.tsx
'use client';

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogTrigger,
  DialogClose,
} from '@/components/ui/dialog';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, Sparkles, AlertTriangle, X } from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils'; // Import cn utility

import AnalysisResultDisplay from './AnalysisResultDisplay';
import type { AiProfileAnalysisResult } from '@/lib/services/aiService';
import {
  AIAdvisorDialogDict,
  AnalysisResultDisplayDict,
} from '@/types/dictionary';

interface AIProfileAdvisorDialogProps {
  userId: string;
  dict: AIAdvisorDialogDict;
  analysisDict: AnalysisResultDisplayDict;
  locale: string; // Added locale prop
}

export const AIProfileAdvisorDialog: React.FC<AIProfileAdvisorDialogProps> = ({
  userId,
  dict,
  analysisDict,
  locale,
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [analysis, setAnalysis] = useState<AiProfileAnalysisResult | null>(
    null
  );
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const handleGetAnalysis = async () => {
    if (analysis) {
      setIsOpen(true);
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      const response = await fetch('/api/ai/analyze-my-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Error getting profile analysis.');
      }

      setAnalysis(result.data);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'An unexpected error occurred.';
      setError(errorMessage);
      toast.error(dict.toast.errorTitle, {
        description: dict.toast.errorDescription.replace(
          '{{error}}',
          errorMessage
        ),
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
    if (!open) {
      setError(null);
    }
  };

  const handleTriggerClick = () => {
    if (!analysis && !isLoading) {
      handleGetAnalysis();
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>
        <Button
          onClick={handleTriggerClick}
          variant="outline"
          size="lg"
          className="rounded-full border-2 border-purple-300 bg-purple-50 text-purple-700 hover:bg-purple-100 hover:border-purple-400 transition-all duration-300 shadow-sm hover:shadow-lg group w-full max-w-sm flex items-center gap-2"
        >
          <Sparkles className="w-5 h-5 text-purple-500 transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110" />
          <span>{dict.triggerButton}</span>
        </Button>
      </DialogTrigger>

      <DialogContent
        className="max-w-4xl w-[95vw] h-[90vh] flex flex-col p-0"
        dir={direction} // Dynamically set direction
      >
        <DialogHeader className="p-4 border-b">
          <div className="flex justify-between items-start gap-4">
            {/* Step 1: Move the Close Button to be the first element */}
            <DialogClose asChild>
              <button className="rounded-full p-1.5 text-gray-500 hover:text-gray-800 shrink-0 transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                <X className="h-5 w-5" />
                <span className="sr-only">{dict.closeButton}</span>
              </button>
            </DialogClose>

            {/* Wrapper for title and description - now the second element */}
            <div className="flex-grow">
              <DialogTitle className="flex items-center gap-2 text-xl">
                <Sparkles className="w-6 h-6 text-purple-500" />
                <span>{dict.dialogTitle}</span>
              </DialogTitle>
              <DialogDescription className="mt-1">
                {dict.dialogDescription}
              </DialogDescription>
            </div>
          </div>
        </DialogHeader>

        <div className="flex-grow overflow-y-auto p-4 md:p-6 bg-slate-50/50">
          {isLoading ? (
            <div
              role="status"
              aria-live="polite"
              className="flex flex-col items-center justify-center h-full text-center"
            >
              <Loader2 className="w-12 h-12 text-purple-500 animate-spin mb-4" />
              <p className="text-lg font-semibold text-gray-700">
                {dict.loadingTitle}
              </p>
              <p className="text-sm text-gray-500 mt-2">
                {dict.loadingDescription}
              </p>
            </div>
          ) : error ? (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <Alert variant="destructive" className="max-w-md">
                <AlertTriangle className="h-5 w-5" />
                <AlertTitle>{dict.errorAlertTitle}</AlertTitle>
                <AlertDescription>
                  <p>{dict.errorAlertDescription}</p>
                  <p className="text-xs mt-2">{error}</p>
                </AlertDescription>
              </Alert>
              <Button
                onClick={handleGetAnalysis}
                variant="outline"
                className="mt-4"
              >
                {dict.retryButton}
              </Button>
            </div>
          ) : analysis ? (
            <AnalysisResultDisplay
              analysis={analysis}
              dict={analysisDict}
              locale={locale} // Pass locale down
            />
          ) : (
            <div className="flex items-center justify-center h-full">
              <p>{dict.initialState}</p>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default AIProfileAdvisorDialog;
--- End of Content for AIProfileAdvisorDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\AnalysisResultDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/advisor/AnalysisResultDisplay.tsx
'use client';

import React from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  Lightbulb,
  CheckCircle2,
  AlertCircle,
  XCircle,
  User,
  Target,
} from 'lucide-react';
import { AiProfileAnalysisResult } from '@/lib/services/aiService';
import { cn } from '@/lib/utils';
import { AnalysisResultDisplayDict } from '@/types/dictionary';

interface AnalysisResultDisplayProps {
  analysis: AiProfileAnalysisResult;
  dict: AnalysisResultDisplayDict;
  locale: string; // Added locale prop
}

const TipCard: React.FC<{ area: string; tip: string }> = ({ area, tip }) => (
  <div className="p-4 rounded-lg bg-yellow-50/70 border border-yellow-200/80 flex items-start gap-4">
    <div className="flex-shrink-0 mt-1">
      <Lightbulb className="w-5 h-5 text-yellow-600" />
    </div>
    <div>
      <p className="font-semibold text-sm text-yellow-800">{area}</p>
      <p className="text-sm text-yellow-900 mt-1">{tip}</p>
    </div>
  </div>
);

interface ReportItemProps {
  area: string;
  status: 'COMPLETE' | 'PARTIAL' | 'MISSING';
  feedback: string;
  dict: AnalysisResultDisplayDict['completeness']['status'];
}

const ReportItem: React.FC<ReportItemProps> = ({
  area,
  status,
  feedback,
  dict,
}) => {
  const statusConfig = {
    COMPLETE: {
      icon: CheckCircle2,
      color: 'text-green-600',
      text: dict.complete,
    },
    PARTIAL: { icon: AlertCircle, color: 'text-amber-600', text: dict.partial },
    MISSING: { icon: XCircle, color: 'text-red-600', text: dict.missing },
  };

  const { icon: Icon, color, text } = statusConfig[status];

  return (
    <div className="flex items-start gap-3 p-3 border-b last:border-b-0">
      <div className="flex-shrink-0 mt-1">
        <Icon className={cn('w-5 h-5', color)} />
      </div>
      <div className="flex-1">
        <div className="flex justify-between items-center">
          <p className="font-medium text-sm text-slate-800">{area}</p>
          <Badge
            variant="outline"
            className={cn(
              'text-xs font-mono',
              color.replace('text-', 'border-').replace('-600', '-300')
            )}
          >
            {text}
          </Badge>
        </div>
        <p className="text-sm text-slate-600 mt-1">{feedback}</p>
      </div>
    </div>
  );
};

const AnalysisResultDisplay: React.FC<AnalysisResultDisplayProps> = ({
  analysis,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  return (
    <div dir={direction} className="w-full">
      <Tabs defaultValue="summary" className="w-full">
        <TabsList className="grid w-full grid-cols-3 h-auto p-1.5 bg-slate-200/70 rounded-lg">
          <TabsTrigger value="summary">{dict.tabs.summary}</TabsTrigger>
          <TabsTrigger value="completeness">
            {dict.tabs.completeness}
          </TabsTrigger>
          <TabsTrigger value="tips">{dict.tabs.tips}</TabsTrigger>
        </TabsList>

        <div className="mt-4">
          <TabsContent value="summary" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <User className="text-blue-500" />
                  {dict.summary.myPersonalityTitle}
                </CardTitle>
                <CardDescription>
                  {dict.summary.myPersonalityDescription}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">
                  {analysis.personalitySummary}
                </p>
              </CardContent>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Target className="text-green-500" />
                  {dict.summary.lookingForTitle}
                </CardTitle>
                <CardDescription>
                  {dict.summary.lookingForDescription}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">
                  {analysis.lookingForSummary}
                </p>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="completeness">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <CheckCircle2 className="text-indigo-500" />
                  {dict.completeness.title}
                </CardTitle>
                <CardDescription>
                  {dict.completeness.description}
                </CardDescription>
              </CardHeader>
              <CardContent className="p-0">
                <div className="space-y-0 divide-y">
                  {analysis.completenessReport.map((item, index) => (
                    <ReportItem
                      key={index}
                      {...item}
                      dict={dict.completeness.status}
                    />
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="tips">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Lightbulb className="text-yellow-500" />
                  {dict.tips.title}
                </CardTitle>
                <CardDescription>{dict.tips.description}</CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                {analysis.actionableTips.map((tip, index) => (
                  <TipCard key={index} area={tip.area} tip={tip.tip} />
                ))}
              </CardContent>
            </Card>
          </TabsContent>
        </div>
      </Tabs>
    </div>
  );
};

export default AnalysisResultDisplay;
--- End of Content for AnalysisResultDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\BudgetDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/sections/BudgetDisplay.tsx
import React from 'react';
import { Progress } from '@/components/ui/progress';
import { motion } from 'framer-motion';
import type { BudgetDisplayDict } from '@/types/dictionary';

interface BudgetDisplayProps {
  data: Record<string, number>;
  dict: BudgetDisplayDict;
  locale: string; // Added locale prop
}

const BudgetDisplay: React.FC<BudgetDisplayProps> = ({
  data,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  if (!data || typeof data !== 'object' || Array.isArray(data)) {
    return <p className="text-sm text-red-500">{dict.errorInvalidData}</p>;
  }

  const sortedEntries = Object.entries(data)
    .filter(([_, value]) => typeof value === 'number' && value > 0)
    .sort(([, a], [, b]) => b - a);

  if (sortedEntries.length === 0) {
    return (
      <p className="text-sm text-gray-500 italic">{dict.noValuesAllocated}</p>
    );
  }

  const colors = [
    'bg-cyan-500',
    'bg-teal-500',
    'bg-sky-500',
    'bg-indigo-500',
    'bg-purple-500',
    'bg-gray-400',
  ];

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.1 },
    },
  };

  // Adjust animation based on direction
  const itemVariants = {
    hidden: { opacity: 0, x: direction === 'rtl' ? 20 : -20 },
    visible: { opacity: 1, x: 0 },
  };

  return (
    <motion.div
      dir={direction} // Set direction for the whole component
      className="space-y-3 pt-2"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {sortedEntries.map(([label, value], index) => (
        <motion.div key={label} variants={itemVariants}>
          <div className="flex justify-between items-center mb-1 text-sm">
            <span className="font-medium text-gray-700">{label}</span>
            <span className="font-semibold text-cyan-700">{value}%</span>
          </div>
          <Progress
            value={value}
            className="h-2.5 rounded-full bg-gray-200/70"
            indicatorClassName={colors[index % colors.length]}
          />
        </motion.div>
      ))}
    </motion.div>
  );
};

export default BudgetDisplay;
--- End of Content for BudgetDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\PhotosSection.tsx
--------------------------------------------------------------------------------
Content:
// src/components/profile/sections/PhotosSection.tsx

'use client';

import React, { useRef, useState, useEffect, useCallback } from 'react';
import Image from 'next/image';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
// UI Components
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogDescription,
  DialogHeader,
  DialogFooter,
} from '@/components/ui/dialog';
import { toast } from 'sonner';

// Icons
import {
  Camera,
  Star,
  Loader2,
  ChevronLeft,
  ChevronRight,
  Upload,
  Trash2,
  X,
  CheckCircle2,
  MinusSquare,
} from 'lucide-react';

// Types
import type { UserImage } from '@/types/next-auth';
import { PhotosSectionDict } from '@/types/dictionary';

interface PhotosSectionProps {
  images: UserImage[];
  isUploading: boolean;
  disabled?: boolean;
  maxImages?: number;
  onUpload: (files: File[]) => Promise<void>;
  onSetMain: (imageId: string) => Promise<void>;
  onDelete: (imageIds: string[]) => Promise<void>;
  dict: PhotosSectionDict;
  locale: string; // Prop for language to determine direction
}

const PhotosSection: React.FC<PhotosSectionProps> = ({
  images,
  isUploading: isExternallyUploading,
  disabled = false,
  maxImages = 5,
  onUpload,
  onSetMain,
  onDelete,
  dict,
  locale,
}) => {
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [showImageViewer, setShowImageViewer] = useState(false);
  const [selectedViewerIndex, setSelectedViewerIndex] = useState<number | null>(
    null
  );
  const [isProcessing, setIsProcessing] = useState(false);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [imageToDelete, setImageToDelete] = useState<string | null>(null);
  const [uploadingFiles, setUploadingFiles] = useState<string[]>([]);
  const [selectionMode, setSelectionMode] = useState(false);
  const [selectedImageIds, setSelectedImageIds] = useState<Set<string>>(
    new Set()
  );

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const isLoading =
    isExternallyUploading || isProcessing || uploadingFiles.length > 0;

  const validateFiles = (
    files: FileList | File[]
  ): { validFiles: File[]; errors: string[] } => {
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    const validFiles: File[] = [];
    const errors: string[] = [];
    Array.from(files).forEach((file) => {
      if (!validTypes.includes(file.type)) {
        errors.push(
          dict.toasts.invalidFileTypeError.replace('{{fileName}}', file.name)
        );
        return;
      }
      if (file.size > maxSize) {
        errors.push(
          dict.toasts.fileTooLargeError.replace('{{fileName}}', file.name)
        );
        return;
      }
      validFiles.push(file);
    });
    return { validFiles, errors };
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const remainingSlots = maxImages - images.length;
    if (remainingSlots <= 0) {
      toast.error(dict.toasts.maxImagesError);
      return;
    }
    if (files.length > remainingSlots) {
      toast.error(
        dict.toasts.slotsError.replace('{{count}}', remainingSlots.toString())
      );
      return;
    }
    if (isLoading) return;

    const { validFiles, errors } = validateFiles(files);
    if (errors.length > 0) {
      errors.forEach((error) => toast.error(error));
    }
    if (validFiles.length === 0) return;

    setUploadingFiles(validFiles.map((f) => f.name));
    try {
      await onUpload(validFiles);
      toast.success(
        dict.toasts.uploadSuccess.replace(
          '{{count}}',
          validFiles.length.toString()
        )
      );
    } catch (error) {
      console.error('Error during upload process:', error);
      toast.error(dict.toasts.uploadError);
    } finally {
      setUploadingFiles([]);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const triggerFileInput = () => {
    if (!isLoading && !disabled && images.length < maxImages) {
      fileInputRef.current?.click();
    }
  };

  const handleToggleSelectionMode = () => {
    setSelectionMode((prev) => !prev);
    setSelectedImageIds(new Set());
  };

  const handleSelectAll = () => {
    if (selectedImageIds.size === images.length) {
      setSelectedImageIds(new Set());
    } else {
      setSelectedImageIds(new Set(images.map((img) => img.id)));
    }
  };

  const toggleImageSelection = (imageId: string) => {
    setSelectedImageIds((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(imageId)) {
        newSet.delete(imageId);
      } else {
        newSet.add(imageId);
      }
      return newSet;
    });
  };

  const handleImageClick = (index: number) => {
    if (selectionMode) {
      toggleImageSelection(images[index].id);
    } else {
      setSelectedViewerIndex(index);
      setShowImageViewer(true);
    }
  };

  const handleBulkDelete = async () => {
    if (selectedImageIds.size === 0) {
      toast.info(dict.toasts.selectOneError);
      return;
    }

    const confirmationMessage = dict.confirmations.bulkDelete.replace(
      '{{count}}',
      selectedImageIds.size.toString()
    );
    if (!window.confirm(confirmationMessage)) {
      return;
    }

    setIsProcessing(true);
    try {
      await onDelete(Array.from(selectedImageIds));
      toast.success(
        dict.toasts.bulkDeleteSuccess.replace(
          '{{count}}',
          selectedImageIds.size.toString()
        )
      );
      setSelectionMode(false);
      setSelectedImageIds(new Set());
    } catch (error) {
      console.error('Error during bulk delete:', error);
      toast.error(dict.toasts.bulkDeleteError);
    } finally {
      setIsProcessing(false);
    }
  };

  const requestDelete = (imageId: string, event?: React.MouseEvent) => {
    event?.stopPropagation();
    if (isLoading) return;
    setImageToDelete(imageId);
    setDeleteConfirmOpen(true);
  };

  const confirmDelete = async () => {
    if (!imageToDelete || isProcessing) return;
    setIsProcessing(true);
    try {
      await onDelete([imageToDelete]);
      toast.success(dict.toasts.singleDeleteSuccess);
      closeImageViewer();
      setDeleteConfirmOpen(false);
      setImageToDelete(null);
    } catch (error) {
      console.error('Error deleting image:', error);
      toast.error(dict.toasts.singleDeleteError);
    } finally {
      setIsProcessing(false);
    }
  };

  const closeImageViewer = useCallback(() => {
    setShowImageViewer(false);
    setSelectedViewerIndex(null);
  }, []);

  const handleNextImage = useCallback(
    () =>
      setSelectedViewerIndex((prev) =>
        prev === null || prev >= images.length - 1 ? 0 : prev + 1
      ),
    [images.length]
  );
  const handlePreviousImage = useCallback(
    () =>
      setSelectedViewerIndex((prev) =>
        prev === null || prev <= 0 ? images.length - 1 : prev - 1
      ),
    [images.length]
  );

  const handleSetMainImage = async (
    imageId: string,
    showToast = true,
    event?: React.MouseEvent
  ) => {
    event?.stopPropagation();
    if (isLoading) return;
    const currentImage = images.find((img) => img.id === imageId);
    if (!currentImage || currentImage.isMain) return;
    setIsProcessing(true);
    try {
      await onSetMain(imageId);
      if (showToast) toast.success(dict.toasts.setMainSuccess);
    } catch (error) {
      console.error('Error setting main image:', error);
      toast.error(dict.toasts.setMainError);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleControlClick = (e: React.MouseEvent) => e.stopPropagation();

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!showImageViewer) return;
      if (direction === 'rtl') {
        if (e.key === 'ArrowRight') handlePreviousImage();
        if (e.key === 'ArrowLeft') handleNextImage();
      } else {
        if (e.key === 'ArrowRight') handleNextImage();
        if (e.key === 'ArrowLeft') handlePreviousImage();
      }
      if (e.key === 'Escape') closeImageViewer();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [
    showImageViewer,
    handlePreviousImage,
    handleNextImage,
    closeImageViewer,
    direction,
  ]);

  const getRemainingSlots = () => maxImages - images.length;

  return (
    <div
      dir={direction}
      className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-6 md:p-8"
    >
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 pb-4 border-b border-gray-200/80">
        {!selectionMode ? (
          <>
            <div
              className={cn(
                'mb-3 sm:mb-0',
                direction === 'rtl' ? 'text-right' : 'text-left'
              )}
            >
              <h2 className="text-xl font-semibold text-gray-800">
                {dict.title}
              </h2>
              <p className="mt-1 text-sm text-gray-600">
                {dict.subtitle.replace('{{maxImages}}', maxImages.toString())}
              </p>
              {uploadingFiles.length > 0 && (
                <p className="mt-2 text-sm text-cyan-600 font-medium">
                  {dict.uploadingMultiple.replace(
                    '{{count}}',
                    uploadingFiles.length.toString()
                  )}
                </p>
              )}
            </div>
            <div className="flex gap-2 self-end sm:self-center">
              {images.length > 0 && !disabled && (
                <Button
                  variant="outline"
                  onClick={handleToggleSelectionMode}
                  className="rounded-full px-4 text-sm"
                >
                  {dict.selectForDeletion}
                </Button>
              )}
              {!disabled && (
                <Button
                  variant="outline"
                  onClick={triggerFileInput}
                  disabled={isLoading || images.length >= maxImages}
                  className="rounded-full border-2 border-cyan-300 text-cyan-700 hover:bg-cyan-50/50 hover:border-cyan-400 transition-all duration-300 px-5 py-2.5 text-sm font-medium flex items-center gap-2"
                >
                  {isExternallyUploading || uploadingFiles.length > 0 ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Upload className="w-4 h-4" />
                  )}
                  <span>{dict.uploadButton}</span>
                </Button>
              )}
            </div>
          </>
        ) : (
          <div className="w-full flex justify-between items-center">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                onClick={handleToggleSelectionMode}
                className="rounded-full text-gray-600 hover:bg-gray-100"
              >
                <X className="w-5 h-5" />
              </Button>
              <span className="font-semibold text-gray-700">
                {dict.selectionHeader.replace(
                  '{{count}}',
                  selectedImageIds.size.toString()
                )}
              </span>
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={handleSelectAll}
                className="rounded-full px-4 text-sm"
              >
                {selectedImageIds.size === images.length
                  ? dict.deselectAll
                  : dict.selectAll}
              </Button>
              <Button
                variant="destructive"
                onClick={handleBulkDelete}
                disabled={isProcessing || selectedImageIds.size === 0}
                className="rounded-full px-4 text-sm flex items-center gap-2"
              >
                {isProcessing ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Trash2 className="w-4 h-4" />
                )}
                {dict.deleteSelected}
              </Button>
            </div>
          </div>
        )}
      </div>

      <input
        type="file"
        ref={fileInputRef}
        className="hidden"
        accept="image/jpeg,image/png,image/jpg,image/webp"
        onChange={handleFileSelect}
        disabled={isLoading || disabled || images.length >= maxImages}
        multiple
      />

      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5">
        {images.map((image, index) => (
          <div
            key={image.id}
            role="button"
            tabIndex={0}
            aria-pressed={
              selectionMode ? selectedImageIds.has(image.id) : undefined
            }
            aria-label={`${dict.selectForDeletion} ${index + 1}`}
            className={cn(
              'relative group aspect-square rounded-xl overflow-hidden bg-gray-100 shadow-md transition-all duration-300 ease-in-out',
              selectionMode
                ? 'cursor-pointer'
                : 'cursor-pointer hover:shadow-lg',
              selectedImageIds.has(image.id) &&
                'ring-4 ring-offset-2 ring-cyan-500'
            )}
            onClick={() => handleImageClick(index)}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleImageClick(index);
              }
            }}
          >
            <Image
              src={getRelativeCloudinaryPath(image.url)}
              alt={`${dict.title} ${index + 1}`}
              fill
              className={cn(
                'object-cover transition-transform duration-300',
                !selectionMode && 'group-hover:scale-105'
              )}
              sizes="(max-width: 640px) 50vw, (max-width: 768px) 33vw, (max-width: 1024px) 25vw, 20vw"
              priority={index < 2}
            />
            {selectionMode && (
              <div className="absolute inset-0 bg-black/30 flex items-center justify-center transition-opacity opacity-0 group-hover:opacity-100">
                {selectedImageIds.has(image.id) ? (
                  <CheckCircle2 className="w-10 h-10 text-white drop-shadow-lg" />
                ) : (
                  <MinusSquare className="w-10 h-10 text-white/70 drop-shadow-lg" />
                )}
              </div>
            )}
            {!disabled && !selectionMode && (
              <div
                className={cn(
                  'absolute top-2 z-10 flex gap-1.5 opacity-85 group-hover:opacity-100 transition-opacity duration-200',
                  direction === 'rtl' ? 'left-2' : 'right-2'
                )}
                onClick={handleControlClick}
              >
                <Button
                  variant="secondary"
                  size="icon"
                  className={cn(
                    'w-8 h-8 rounded-full shadow-md border border-white/30 bg-black/40 text-white hover:bg-black/60 transition-colors',
                    image.isMain ? 'cursor-default' : 'hover:text-yellow-300'
                  )}
                  onClick={(e) => handleSetMainImage(image.id, true, e)}
                  disabled={image.isMain || isLoading}
                  title={image.isMain ? dict.mainBadge : dict.setAsMainTooltip}
                  aria-label={`${dict.setAsMainTooltip} ${index + 1}`}
                >
                  <Star
                    className={cn(
                      'w-4 h-4 transition-colors',
                      image.isMain
                        ? 'text-yellow-400 fill-yellow-400'
                        : 'text-white'
                    )}
                  />
                </Button>
                <Button
                  variant="secondary"
                  size="icon"
                  className="w-8 h-8 rounded-full shadow-md border border-white/30 bg-black/40 text-white hover:bg-red-600 hover:border-red-700 transition-colors"
                  onClick={(e) => requestDelete(image.id, e)}
                  disabled={isLoading}
                  title={dict.deleteTooltip}
                  aria-label={`${dict.deleteTooltip} ${index + 1}`}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            )}
            {image.isMain && !selectionMode && (
              <Badge
                className={cn(
                  'absolute bottom-2 rounded-full px-2.5 py-0.5 text-xs font-medium shadow-md text-white bg-gradient-to-r from-cyan-500 to-pink-500 border-none',
                  direction === 'rtl' ? 'right-2' : 'left-2'
                )}
              >
                {dict.mainBadge}
              </Badge>
            )}
          </div>
        ))}

        {!disabled && !selectionMode && images.length < maxImages && (
          <div
            onClick={triggerFileInput}
            className="flex flex-col items-center justify-center text-center p-4 aspect-square rounded-xl border-2 border-dashed border-cyan-300/70 bg-cyan-50/30 hover:bg-cyan-50/60 hover:border-cyan-400 transition-colors duration-300 cursor-pointer group"
          >
            <Upload className="w-8 h-8 text-cyan-500 mb-2 transition-transform group-hover:scale-110" />
            <span className="text-sm font-medium text-cyan-700">
              {dict.uploadPlaceholder.title}
            </span>
            <span className="text-xs text-cyan-600/90 mt-1">
              {dict.uploadPlaceholder.remaining.replace(
                '{{count}}',
                getRemainingSlots().toString()
              )}
            </span>
            <span className="text-xs text-cyan-500/80 mt-1">
              {dict.uploadPlaceholder.prompt}
            </span>
          </div>
        )}

        {uploadingFiles.map((_, index) => (
          <div
            key={`uploading-${index}`}
            className="relative aspect-square rounded-xl overflow-hidden bg-gray-200 shadow-md"
          >
            <div className="absolute inset-0 flex flex-col items-center justify-center">
              <Loader2 className="w-8 h-8 text-cyan-500 animate-spin mb-2" />
              <span className="text-xs text-gray-600 text-center px-2">
                {dict.uploadingPlaceholder}
              </span>
            </div>
            <div className="absolute bottom-0 left-0 right-0 bg-cyan-500 h-1 animate-pulse"></div>
          </div>
        ))}
      </div>

      {images.length === 0 &&
        uploadingFiles.length === 0 &&
        !disabled &&
        !selectionMode && (
          <div className="text-center py-16 mt-6 bg-gradient-to-br from-cyan-50/20 to-pink-50/20 rounded-xl border border-dashed border-gray-300">
            <Camera className="w-12 h-12 mx-auto text-gray-400/80" />
            <p className="mt-4 text-gray-600 font-medium">
              {dict.emptyState.title}
            </p>
            <p className="text-sm text-gray-500 mt-1 px-4">
              {dict.emptyState.description}
            </p>
          </div>
        )}
      {images.length === 0 && disabled && (
        <div className="text-center py-16 mt-6 bg-gray-50/50 rounded-xl border border-gray-200">
          <Camera className="w-12 h-12 mx-auto text-gray-400" />
          <p className="mt-4 text-gray-500 font-medium">
            {dict.emptyStateDisabled.title}
          </p>
        </div>
      )}

      <Dialog open={deleteConfirmOpen} onOpenChange={setDeleteConfirmOpen}>
        <DialogContent
          className="sm:max-w-md bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border-none p-6"
          dir={direction}
        >
          <DialogHeader>
            <DialogTitle className="text-lg font-semibold text-gray-800">
              {dict.deleteDialog.title}
            </DialogTitle>
            <DialogDescription className="text-sm text-gray-600 mt-2">
              {dict.deleteDialog.description}
            </DialogDescription>
          </DialogHeader>
          <DialogFooter className="mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 sm:space-x-reverse gap-2">
            <Button
              type="button"
              variant="outline"
              onClick={() => setDeleteConfirmOpen(false)}
              disabled={isLoading}
              className="rounded-full px-5"
            >
              {dict.deleteDialog.cancel}
            </Button>
            <Button
              type="button"
              variant="destructive"
              onClick={confirmDelete}
              disabled={isLoading}
              className="rounded-full px-5 flex items-center gap-2"
            >
              {isProcessing ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                <Trash2 className="w-4 h-4" />
              )}
              <span>{dict.deleteDialog.confirm}</span>
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <Dialog open={showImageViewer} onOpenChange={setShowImageViewer}>
        <DialogContent
          className="p-0 m-0 w-screen h-screen max-w-none sm:max-w-full sm:h-full bg-black/90 backdrop-blur-sm border-none rounded-none flex items-center justify-center outline-none"
          aria-describedby={undefined}
          dir={direction}
        >
          <Button
            variant="ghost"
            size="icon"
            className={cn(
              'absolute top-4 z-50 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors',
              direction === 'rtl' ? 'right-4' : 'left-4'
            )}
            onClick={closeImageViewer}
            aria-label={dict.imageViewer.closeLabel}
          >
            <X className="w-6 h-6" />
          </Button>
          {selectedViewerIndex !== null && images[selectedViewerIndex] && (
            <div className="relative w-full h-full flex items-center justify-center">
              <div className="relative w-[95%] h-[85%] sm:w-[90%] sm:h-[90%]">
                <Image
                  src={getRelativeCloudinaryPath(
                    images[selectedViewerIndex].url
                  )}
                  alt={dict.imageViewer.altText.replace(
                    '{{index}}',
                    (selectedViewerIndex + 1).toString()
                  )}
                  fill
                  className="object-contain select-none"
                  sizes="90vw"
                  priority
                />
              </div>
              <div className="absolute top-0 left-0 w-full h-full pointer-events-none">
                {images.length > 1 && (
                  <>
                    {/* Previous Button */}
                    <Button
                      variant="ghost"
                      size="icon"
                      className={cn(
                        'absolute top-1/2 transform -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors pointer-events-auto',
                        direction === 'rtl'
                          ? 'right-2 sm:right-4'
                          : 'left-2 sm:left-4'
                      )}
                      onClick={(e) => {
                        e.stopPropagation();
                        handlePreviousImage();
                      }}
                      disabled={selectedViewerIndex === 0}
                      aria-label={dict.imageViewer.prevLabel}
                    >
                      {direction === 'rtl' ? (
                        <ChevronRight className="w-7 h-7" />
                      ) : (
                        <ChevronLeft className="w-7 h-7" />
                      )}
                    </Button>
                    {/* Next Button */}
                    <Button
                      variant="ghost"
                      size="icon"
                      className={cn(
                        'absolute top-1/2 transform -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 transition-colors pointer-events-auto',
                        direction === 'rtl'
                          ? 'left-2 sm:left-4'
                          : 'right-2 sm:right-4'
                      )}
                      onClick={(e) => {
                        e.stopPropagation();
                        handleNextImage();
                      }}
                      disabled={selectedViewerIndex === images.length - 1}
                      aria-label={dict.imageViewer.nextLabel}
                    >
                      {direction === 'rtl' ? (
                        <ChevronLeft className="w-7 h-7" />
                      ) : (
                        <ChevronRight className="w-7 h-7" />
                      )}
                    </Button>
                  </>
                )}
                {!disabled && (
                  <div
                    className={cn(
                      'absolute top-4 z-50 flex flex-col sm:flex-row gap-2 pointer-events-auto',
                      direction === 'rtl' ? 'left-4' : 'right-4'
                    )}
                  >
                    {!images[selectedViewerIndex].isMain && (
                      <Button
                        variant="secondary"
                        className="rounded-full bg-white/70 backdrop-blur-sm shadow-md hover:bg-white/90 text-gray-800 px-3 py-1.5 text-xs sm:text-sm border border-white/20 flex items-center gap-1.5"
                        onClick={(e) =>
                          handleSetMainImage(
                            images[selectedViewerIndex].id,
                            true,
                            e
                          )
                        }
                        size="sm"
                        disabled={isLoading}
                      >
                        <Star className="w-4 h-4" />
                        <span>{dict.imageViewer.setMainButton}</span>
                      </Button>
                    )}
                    <Button
                      variant="destructive"
                      className="rounded-full bg-red-600/80 hover:bg-red-700 text-white px-3 py-1.5 text-xs sm:text-sm shadow-md border-none flex items-center gap-1.5"
                      onClick={(e) =>
                        requestDelete(images[selectedViewerIndex].id, e)
                      }
                      size="sm"
                      disabled={isLoading}
                    >
                      <Trash2 className="w-4 h-4" />
                      <span>{dict.imageViewer.deleteButton}</span>
                    </Button>
                  </div>
                )}
                {images.length > 0 && (
                  <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/60 text-white px-3 py-1 rounded-full text-xs sm:text-sm font-medium select-none">
                    {dict.imageViewer.counter
                      .replace(
                        '{{current}}',
                        (selectedViewerIndex + 1).toString()
                      )
                      .replace('{{total}}', images.length.toString())}
                  </div>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default PhotosSection;
--- End of Content for PhotosSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\PreferencesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/(authenticated)/profile/components/dashboard/PreferencesSection.tsx
'use client';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Info, XCircle } from 'lucide-react';
import React, { useState, useEffect, useMemo } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Pencil,
  Save,
  X,
  FileText,
  SlidersHorizontal,
  MapPin,
  GraduationCap,
  Users,
  Sparkles,
  Heart,
  Briefcase,
  Shield,
  Palette,
  Smile,
} from 'lucide-react';
import { UserProfile } from '@/types/next-auth';
import { cn } from '@/lib/utils';
import {
  Gender,
  ServiceType,
  HeadCoveringType,
  KippahType,
  ReligiousJourney,
} from '@prisma/client';
import Autocomplete from 'react-google-autocomplete';
import { PreferencesSectionDict } from '@/types/dictionary'; // Assuming this is the correct path

// This would typically come from a context or a hook like `useI18n()`
// For this example, we'll pass it as a prop.
interface PreferencesSectionProps {
  profile: UserProfile | null;
  isEditing: boolean;
  viewOnly?: boolean;
  setIsEditing: (value: boolean) => void;
  onChange: (data: Partial<UserProfile>) => void;
  dictionary: PreferencesSectionDict; // Passing the dictionary as a prop
  locale: string; // Added locale for RTL/LTR support
}

const PreferencesSection: React.FC<PreferencesSectionProps> = ({
  profile,
  isEditing,
  viewOnly = false,
  setIsEditing,
  onChange,
  dictionary: t, // Using 't' as a shorthand for the dictionary
  locale, // Destructure locale
}) => {
  const [formData, setFormData] = useState<Partial<UserProfile>>({});
  const [initialData, setInitialData] = useState<Partial<UserProfile>>({});
  const [locationInputValue, setLocationInputValue] = useState('');
  const [originInputValue, setOriginInputValue] = useState('');

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- Map icons to values for dynamic options ---
  const iconMap: { [key: string]: React.ElementType } = {
    empathetic: Heart,
    driven: Briefcase,
    optimistic: Smile,
    family_oriented: Users,
    intellectual: GraduationCap,
    organized: Palette,
    calm: Heart,
    humorous: Smile,
    sociable: Users,
    sensitive: Heart,
    independent: MapPin,
    creative: Palette,
    honest: Shield,
    responsible: Shield,
    easy_going: Smile,
    no_strong_preference: Sparkles,
    travel: MapPin,
    sports: Briefcase,
    reading: GraduationCap,
    cooking_baking: Palette,
    music_playing_instrument: Palette,
    art_crafts: Palette,
    volunteering: Heart,
    learning_courses: GraduationCap,
    board_games_puzzles: Smile,
    movies_theater: Smile,
    dancing: Users,
    writing: GraduationCap,
    nature_hiking: MapPin,
    photography: Palette,
  };

  // --- Generate options from dictionary ---
  const useGenerateOptions = (
    optionsDict: { [key: string]: string },
    withIcon?: boolean
  ) => {
    return useMemo(
      () =>
        Object.entries(optionsDict).map(([value, label]) => ({
          value,
          label,
          ...(withIcon && { icon: iconMap[value] }),
        })),
      [optionsDict, withIcon]
    );
  };

  const religiousLevelOptions = useGenerateOptions(t.options.religiousLevels);
  const preferredReligiousJourneyOptions = useGenerateOptions(
    t.options.religiousJourneys
  );
  const educationPreferenceOptions = useGenerateOptions(t.options.education);
  const occupationPreferenceOptions = useGenerateOptions(t.options.occupation);
  const preferredShomerNegiahOptions = useGenerateOptions(
    t.options.shomerNegiah
  );
  const preferredPartnerHasChildrenOptions = useGenerateOptions(
    t.options.partnerHasChildren
  );
  const preferredOriginOptions = useGenerateOptions(t.options.origins);
  const preferredAliyaStatusOptions = useGenerateOptions(t.options.aliyaStatus);
  const maritalStatusOptions = useGenerateOptions(t.options.maritalStatus);
  const serviceTypeOptions = useGenerateOptions(t.options.serviceTypes);
  const headCoveringOptions = useGenerateOptions(t.options.headCovering);
  const kippahTypeOptions = useGenerateOptions(t.options.kippahType);
  const characterTraitsOptions = useGenerateOptions(t.options.traits, true);
  const hobbiesOptions = useGenerateOptions(t.options.hobbies, true);
  const contactPreferenceOptions = Object.entries(
    t.options.contactPreference
  ).map(([value, label]) => ({ value, label }));

  useEffect(() => {
    if (profile) {
      const nullToUndefined = <T,>(value: T | null): T | undefined =>
        value === null ? undefined : value;

      const newFormData: Partial<UserProfile> = {
        ...profile,
        preferredAgeMin: nullToUndefined(profile.preferredAgeMin),
        preferredAgeMax: nullToUndefined(profile.preferredAgeMax),
        preferredHeightMin: nullToUndefined(profile.preferredHeightMin),
        preferredHeightMax: nullToUndefined(profile.preferredHeightMax),
        matchingNotes: profile.matchingNotes ?? '',
        contactPreference: nullToUndefined(profile.contactPreference),
        preferredShomerNegiah: nullToUndefined(profile.preferredShomerNegiah),
        preferredPartnerHasChildren: nullToUndefined(
          profile.preferredPartnerHasChildren
        ),
        preferredAliyaStatus: nullToUndefined(profile.preferredAliyaStatus),
        preferredLocations: profile.preferredLocations ?? [],
        preferredReligiousLevels: profile.preferredReligiousLevels ?? [],
        preferredEducation: profile.preferredEducation ?? [],
        preferredOccupations: profile.preferredOccupations ?? [],
        preferredMaritalStatuses: profile.preferredMaritalStatuses ?? [],
        preferredOrigins: profile.preferredOrigins ?? [],
        preferredServiceTypes: profile.preferredServiceTypes ?? [],
        preferredHeadCoverings: profile.preferredHeadCoverings ?? [],
        preferredKippahTypes: profile.preferredKippahTypes ?? [],
        preferredCharacterTraits: profile.preferredCharacterTraits ?? [],
        preferredHobbies: profile.preferredHobbies ?? [],
        preferredReligiousJourneys: profile.preferredReligiousJourneys ?? [],
      };
      setFormData(newFormData);
      setInitialData(newFormData);
    }
  }, [profile]);

  useEffect(() => {
    if (!isEditing && initialData) {
      setFormData(initialData);
    }
  }, [isEditing, initialData]);

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value, type } = e.target;
    const field = name as keyof UserProfile;

    setFormData((prev) => {
      let processedValue: string | number | undefined;
      if (type === 'number') {
        const num = parseInt(value, 10);
        processedValue = isNaN(num) ? undefined : num;
      } else {
        processedValue = value === '' ? undefined : value;
      }
      return { ...prev, [field]: processedValue };
    });
  };

  const handleSelectChange = (field: keyof UserProfile, value: string) => {
    setFormData((prev) => ({
      ...prev,
      [field]:
        value === '' ||
        value === 'לא_משנה' || // Keep legacy values just in case
        value === 'any' ||
        value === 'no_preference'
          ? undefined
          : (value as UserProfile[typeof field]),
    }));
  };

  const handleMultiSelectChange = (field: keyof UserProfile, value: string) => {
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      let newValues;
      const resetValues = [
        'any',
        'no_preference',
        'לא_משנה',
        'no_strong_preference',
      ];

      if (resetValues.includes(value)) {
        newValues = currentValues.includes(value) ? [] : [value];
      } else {
        const filteredValues = currentValues.filter(
          (v) => !resetValues.includes(v)
        );
        newValues = filteredValues.includes(value)
          ? filteredValues.filter((v) => v !== value)
          : [...filteredValues, value];
      }
      return { ...prev, [field]: newValues };
    });
  };

  const handleAddItemToArray = (field: keyof UserProfile, value: string) => {
    if (!value) return;
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      if (currentValues.includes(value)) {
        return prev;
      }
      return { ...prev, [field]: [...currentValues, value] };
    });
  };

  const handleRemoveItemFromArray = (
    field: keyof UserProfile,
    value: string
  ) => {
    setFormData((prev) => {
      const currentValues =
        (Array.isArray(prev[field]) ? (prev[field] as string[]) : []) ?? [];
      return {
        ...prev,
        [field]: currentValues.filter((item) => item !== value),
      };
    });
  };

  const handleSave = () => {
    const dataToSave = { ...formData };
    onChange(dataToSave);
    setIsEditing(false);
    setInitialData(dataToSave);
  };

  const handleCancel = () => {
    setFormData(initialData);
    setIsEditing(false);
  };

  const renderMultiSelectBadges = (
    fieldValues: string[] | undefined | null,
    options: { value: string; label: string; icon?: React.ElementType }[],
    badgeClass: string = 'bg-sky-100 text-sky-700',
    emptyPlaceholder: string
  ) => {
    if (!fieldValues || fieldValues.length === 0) {
      return <p className="text-sm text-gray-500 italic">{emptyPlaceholder}</p>;
    }
    return fieldValues.map((value) => {
      const option = options.find((opt) => opt.value === value);
      return option ? (
        <Badge
          key={value}
          variant="secondary"
          className={cn(
            'ltr:mr-1 rtl:ml-1 mb-1 text-xs px-2 py-0.5 rounded-full flex items-center',
            badgeClass
          )}
        >
          {option.icon && <option.icon className="w-3 h-3 ltr:mr-1 rtl:ml-1" />}
          {option.label}
        </Badge>
      ) : null;
    });
  };

  const getSelectDisplayValue = (
    value: string | undefined | null,
    options: { value: string; label: string }[],
    placeholder: string
  ) => {
    if (!value)
      return <span className="text-gray-500 italic">{placeholder}</span>;
    const option = options.find((opt) => opt.value === value);
    return option ? (
      option.label
    ) : (
      <span className="text-gray-500 italic">{placeholder}</span>
    );
  };

  return (
    <div className="relative" dir={direction}>
      <div className="sticky top-4 z-10 bg-gradient-to-b from-white via-white/95 to-white/0 pt-4 pb-3 backdrop-blur-sm">
        {' '}
        <div className="container mx-auto max-w-screen-xl px-4">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-xl md:text-2xl font-bold text-slate-800">
                {t.header.title}
              </h1>
              <p className="text-sm text-slate-500">
                {isEditing && !viewOnly
                  ? t.header.subtitleEdit
                  : t.header.subtitleView}
              </p>
            </div>
            {!viewOnly && (
              <div className="flex gap-2">
                {!isEditing ? (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setIsEditing(true)}
                    className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-cyan-400 text-cyan-700 hover:bg-cyan-50"
                  >
                    <Pencil className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                    {t.buttons.edit}
                  </Button>
                ) : (
                  <>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleCancel}
                      className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50"
                    >
                      <X className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                      {t.buttons.cancel}
                    </Button>
                    <Button
                      variant="default"
                      size="sm"
                      onClick={handleSave}
                      className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white"
                    >
                      <Save className="w-3.5 h-3.5 ltr:ml-1.5 rtl:mr-1.5" />
                      {t.buttons.save}
                    </Button>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      <div className="container mx-auto max-w-screen-xl py-6 px-4">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* --- Column 1 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-slate-50/40 to-gray-100/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <FileText className="w-5 h-5 text-slate-600" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.general.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-5">
                <div>
                  <div className="flex items-center gap-1.5 mb-1.5">
                    <Label
                      htmlFor="matchingNotes"
                      className="text-sm font-medium text-gray-700"
                    >
                      {t.cards.general.notesLabel}
                    </Label>
                    <TooltipProvider delayDuration={100}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="matchingNotes-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="matchingNotes-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                        >
                          <p>{t.cards.general.notesTooltip}</p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </div>
                  {isEditing ? (
                    <Textarea
                      id="matchingNotes"
                      name="matchingNotes"
                      value={formData.matchingNotes || ''}
                      onChange={handleInputChange}
                      placeholder={t.cards.general.notesPlaceholder}
                      className="text-sm focus:ring-cyan-500 min-h-[100px] rounded-lg"
                      rows={4}
                    />
                  ) : (
                    <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[60px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                      {formData.matchingNotes || (
                        <span className="text-gray-500 italic">
                          {t.cards.general.notesEmpty}
                        </span>
                      )}
                    </p>
                  )}
                </div>
                <div>
                  <Label
                    htmlFor="contactPreference"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.general.contactPreferenceLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="contactPreference"
                      value={formData.contactPreference || ''}
                      onValueChange={(value: string) =>
                        handleSelectChange('contactPreference', value)
                      }
                    >
                      <SelectTrigger
                        id="contactPreference"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.general.contactPreferencePlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {contactPreferenceOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.contactPreference,
                        contactPreferenceOptions,
                        t.cards.general.contactPreferenceEmpty
                      )}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-indigo-50/40 to-purple-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <SlidersHorizontal className="w-5 h-5 text-indigo-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.ageAndHeight.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                  <fieldset>
                    <legend className="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-1.5">
                      {t.cards.ageAndHeight.ageLegend}
                      <TooltipProvider delayDuration={100}>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <button
                              type="button"
                              aria-describedby="age-range-tooltip"
                            >
                              <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                            </button>
                          </TooltipTrigger>
                          <TooltipContent id="age-range-tooltip" side="top">
                            <p>{t.cards.ageAndHeight.ageTooltip}</p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                    </legend>
                    <div className="flex items-center gap-2">
                      <Label htmlFor="preferredAgeMin" className="sr-only">
                        {t.cards.ageAndHeight.ageMinPlaceholder}
                      </Label>
                      <Input
                        id="preferredAgeMin"
                        type="number"
                        name="preferredAgeMin"
                        placeholder={t.cards.ageAndHeight.ageMinPlaceholder}
                        value={formData.preferredAgeMin ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                      <span aria-hidden="true" className="text-gray-500">
                        -
                      </span>
                      <Label htmlFor="preferredAgeMax" className="sr-only">
                        {t.cards.ageAndHeight.ageMaxPlaceholder}
                      </Label>
                      <Input
                        id="preferredAgeMax"
                        type="number"
                        name="preferredAgeMax"
                        placeholder={t.cards.ageAndHeight.ageMaxPlaceholder}
                        value={formData.preferredAgeMax ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                    </div>
                    {!isEditing &&
                      !formData.preferredAgeMin &&
                      !formData.preferredAgeMax && (
                        <p className="text-xs text-gray-500 italic mt-1">
                          {t.cards.ageAndHeight.ageEmpty}
                        </p>
                      )}
                  </fieldset>
                  <fieldset>
                    <legend className="block mb-1.5 text-xs font-medium text-gray-600">
                      {t.cards.ageAndHeight.heightLegend}
                    </legend>
                    <div className="flex items-center gap-2">
                      <Label htmlFor="preferredHeightMin" className="sr-only">
                        {t.cards.ageAndHeight.heightMinPlaceholder}
                      </Label>
                      <Input
                        id="preferredHeightMin"
                        type="number"
                        name="preferredHeightMin"
                        placeholder={t.cards.ageAndHeight.heightMinPlaceholder}
                        value={formData.preferredHeightMin ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                      <span aria-hidden="true" className="text-gray-500">
                        -
                      </span>
                      <Label htmlFor="preferredHeightMax" className="sr-only">
                        {t.cards.ageAndHeight.heightMaxPlaceholder}
                      </Label>
                      <Input
                        id="preferredHeightMax"
                        type="number"
                        name="preferredHeightMax"
                        placeholder={t.cards.ageAndHeight.heightMaxPlaceholder}
                        value={formData.preferredHeightMax ?? ''}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        className="h-9 text-sm focus:ring-cyan-500 disabled:bg-gray-100/70"
                      />
                    </div>
                    {!isEditing &&
                      !formData.preferredHeightMin &&
                      !formData.preferredHeightMax && (
                        <p className="text-xs text-gray-500 italic mt-1">
                          {t.cards.ageAndHeight.heightEmpty}
                        </p>
                      )}
                  </fieldset>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* --- Column 2 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-sky-50/40 to-blue-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <MapPin className="w-5 h-5 text-sky-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.locationAndReligion.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <div>
                  <Label
                    htmlFor="preferred-locations-input"
                    className="block mb-2 text-xs font-medium text-gray-600"
                  >
                    {t.cards.locationAndReligion.locationsLabel}
                  </Label>
                  {isEditing ? (
                    <div className="space-y-2">
                      <div className="flex flex-wrap gap-1.5">
                        {(formData.preferredLocations || []).map((loc) => (
                          <Badge
                            key={loc}
                            variant="secondary"
                            className="bg-sky-100 text-sky-800 rounded-full px-2 py-1 text-sm font-normal"
                          >
                            <span>{loc}</span>
                            <button
                              type="button"
                              className="ltr:mr-1.5 rtl:ml-1.5 text-sky-600 hover:text-sky-900"
                              onClick={() =>
                                handleRemoveItemFromArray(
                                  'preferredLocations',
                                  loc
                                )
                              }
                              aria-label={t.cards.locationAndReligion.locationsRemoveLabel.replace(
                                '{{loc}}',
                                loc
                              )}
                            >
                              <XCircle className="w-3.5 h-3.5" />
                            </button>
                          </Badge>
                        ))}
                      </div>
                      <Autocomplete
                        id="preferred-locations-input"
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                        value={locationInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                          setLocationInputValue(e.target.value)
                        }
                        onPlaceSelected={(place) => {
                          const cityComponent = place.address_components?.find(
                            (component) => component.types.includes('locality')
                          );
                          const selectedCity =
                            cityComponent?.long_name ||
                            place.formatted_address ||
                            '';
                          handleAddItemToArray(
                            'preferredLocations',
                            selectedCity
                          );
                          setLocationInputValue('');
                        }}
                        options={{
                          types: ['(cities)'],
                          componentRestrictions: { country: 'il' },
                        }}
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={
                          t.cards.locationAndReligion.locationsPlaceholder
                        }
                      />
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {!formData.preferredLocations ||
                      formData.preferredLocations.length === 0 ? (
                        <p className="text-sm text-gray-500 italic">
                          {t.cards.locationAndReligion.locationsEmpty}
                        </p>
                      ) : (
                        formData.preferredLocations.map((loc) => (
                          <Badge
                            key={loc}
                            variant="secondary"
                            className="ltr:mr-1 rtl:ml-1 mb-1 bg-sky-100 text-sky-700 text-xs px-2 py-0.5 rounded-full"
                          >
                            {loc}
                          </Badge>
                        ))
                      )}
                    </div>
                  )}
                </div>
                <fieldset>
                  <legend className="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-2">
                    {t.cards.locationAndReligion.religiousLevelsLegend}
                    <TooltipProvider delayDuration={100}>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="religious-level-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="religious-level-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                        >
                          <p>
                            {t.cards.locationAndReligion.religiousLevelsTooltip}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {religiousLevelOptions.map((level) => (
                        <Button
                          key={level.value}
                          type="button"
                          variant={
                            (formData.preferredReligiousLevels || []).includes(
                              level.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredReligiousLevels',
                              level.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredReligiousLevels || []).includes(
                              level.value
                            )
                              ? 'bg-pink-500 hover:bg-pink-600 text-white border-pink-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {level.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredReligiousLevels,
                        religiousLevelOptions,
                        'bg-pink-100 text-pink-700',
                        t.cards.locationAndReligion.religiousLevelsEmpty
                      )}
                    </div>
                  )}
                </fieldset>

                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.locationAndReligion.religiousJourneysLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {preferredReligiousJourneyOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (
                              formData.preferredReligiousJourneys || []
                            ).includes(opt.value as ReligiousJourney)
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredReligiousJourneys',
                              opt.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (
                              formData.preferredReligiousJourneys || []
                            ).includes(opt.value as ReligiousJourney)
                              ? 'bg-cyan-500 hover:bg-cyan-600 text-white border-cyan-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredReligiousJourneys as string[],
                        preferredReligiousJourneyOptions,
                        'bg-cyan-100 text-cyan-700',
                        t.cards.locationAndReligion.religiousJourneysEmpty
                      )}
                    </div>
                  )}
                </fieldset>

                <div>
                  <Label
                    htmlFor="preferredShomerNegiah"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.locationAndReligion.shomerNegiahLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredShomerNegiah"
                      value={formData.preferredShomerNegiah || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredShomerNegiah', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredShomerNegiah"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.locationAndReligion.shomerNegiahPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredShomerNegiahOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredShomerNegiah,
                        preferredShomerNegiahOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
                {profile?.gender === Gender.MALE && (
                  <fieldset>
                    <legend className="block mb-2 text-xs font-medium text-gray-600">
                      {t.cards.locationAndReligion.headCoveringLegend}
                    </legend>
                    {isEditing ? (
                      <div className="flex flex-wrap gap-2">
                        {headCoveringOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredHeadCoverings || []).includes(
                                opt.value as HeadCoveringType
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredHeadCoverings',
                                opt.value as HeadCoveringType
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredHeadCoverings || []).includes(
                                opt.value as HeadCoveringType
                              )
                                ? 'bg-purple-500 hover:bg-purple-600 text-white border-purple-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                    ) : (
                      <div className="mt-1 flex flex-wrap gap-1.5">
                        {renderMultiSelectBadges(
                          formData.preferredHeadCoverings as string[],
                          headCoveringOptions,
                          'bg-purple-100 text-purple-700',
                          t.cards.locationAndReligion.headCoveringEmpty
                        )}
                      </div>
                    )}
                  </fieldset>
                )}
                {profile?.gender === Gender.FEMALE && (
                  <fieldset>
                    <legend className="block mb-2 text-xs font-medium text-gray-600">
                      {t.cards.locationAndReligion.kippahTypeLegend}
                    </legend>
                    {isEditing ? (
                      <div className="flex flex-wrap gap-2">
                        {kippahTypeOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredKippahTypes || []).includes(
                                opt.value as KippahType
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredKippahTypes',
                                opt.value as KippahType
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredKippahTypes || []).includes(
                                opt.value as KippahType
                              )
                                ? 'bg-orange-500 hover:bg-orange-600 text-white border-orange-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                    ) : (
                      <div className="mt-1 flex flex-wrap gap-1.5">
                        {renderMultiSelectBadges(
                          formData.preferredKippahTypes as string[],
                          kippahTypeOptions,
                          'bg-orange-100 text-orange-700',
                          t.cards.locationAndReligion.kippahTypeEmpty
                        )}
                      </div>
                    )}
                  </fieldset>
                )}
              </CardContent>
            </Card>
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <GraduationCap className="w-5 h-5 text-teal-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.educationAndCareer.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.educationLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {educationPreferenceOptions.map((edu) => (
                        <Button
                          key={edu.value}
                          type="button"
                          variant={
                            (formData.preferredEducation || []).includes(
                              edu.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredEducation',
                              edu.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredEducation || []).includes(
                              edu.value
                            )
                              ? 'bg-teal-500 hover:bg-teal-600 text-white border-teal-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {edu.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredEducation,
                        educationPreferenceOptions,
                        'bg-teal-100 text-teal-700',
                        t.cards.educationAndCareer.educationEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.occupationLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {occupationPreferenceOptions.map((occ) => (
                        <Button
                          key={occ.value}
                          type="button"
                          variant={
                            (formData.preferredOccupations || []).includes(
                              occ.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredOccupations',
                              occ.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredOccupations || []).includes(
                              occ.value
                            )
                              ? 'bg-green-500 hover:bg-green-600 text-white border-green-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {occ.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredOccupations,
                        occupationPreferenceOptions,
                        'bg-green-100 text-green-700',
                        t.cards.educationAndCareer.occupationEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.educationAndCareer.serviceTypeLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {serviceTypeOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredServiceTypes || []).includes(
                              opt.value as ServiceType
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredServiceTypes',
                              opt.value as ServiceType
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredServiceTypes || []).includes(
                              opt.value as ServiceType
                            )
                              ? 'bg-lime-500 hover:bg-lime-600 text-white border-lime-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredServiceTypes as string[],
                        serviceTypeOptions,
                        'bg-lime-100 text-lime-700',
                        t.cards.educationAndCareer.serviceTypeEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
          </div>

          {/* --- Column 3 --- */}
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-rose-50/40 to-fuchsia-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Users className="w-5 h-5 text-rose-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.personalBackground.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.personalBackground.maritalStatusLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {maritalStatusOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredMaritalStatuses || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredMaritalStatuses',
                              opt.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.preferredMaritalStatuses || []).includes(
                              opt.value
                            )
                              ? 'bg-rose-500 hover:bg-rose-600 text-white border-rose-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredMaritalStatuses,
                        maritalStatusOptions,
                        'bg-rose-100 text-rose-700',
                        t.cards.personalBackground.maritalStatusEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <div>
                  <Label
                    htmlFor="preferredPartnerHasChildren"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.personalBackground.partnerHasChildrenLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredPartnerHasChildren"
                      value={formData.preferredPartnerHasChildren || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredPartnerHasChildren', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredPartnerHasChildren"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.personalBackground
                              .partnerHasChildrenPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredPartnerHasChildrenOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredPartnerHasChildren,
                        preferredPartnerHasChildrenOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.personalBackground.originLegend}
                  </legend>
                  {isEditing ? (
                    <div className="space-y-3">
                      <div className="flex flex-wrap gap-2">
                        {preferredOriginOptions.map((opt) => (
                          <Button
                            key={opt.value}
                            type="button"
                            variant={
                              (formData.preferredOrigins || []).includes(
                                opt.value
                              )
                                ? 'default'
                                : 'outline'
                            }
                            size="sm"
                            onClick={() =>
                              handleMultiSelectChange(
                                'preferredOrigins',
                                opt.value
                              )
                            }
                            className={cn(
                              'rounded-full text-xs px-3 py-1.5 transition-all',
                              (formData.preferredOrigins || []).includes(
                                opt.value
                              )
                                ? 'bg-fuchsia-500 hover:bg-fuchsia-600 text-white border-fuchsia-500'
                                : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                            )}
                          >
                            {opt.label}
                          </Button>
                        ))}
                      </div>
                      <div className="space-y-2">
                        <div className="flex flex-wrap gap-1.5">
                          {(formData.preferredOrigins || [])
                            .filter(
                              (origin) =>
                                !preferredOriginOptions.some(
                                  (opt) => opt.value === origin
                                )
                            )
                            .map((origin) => (
                              <Badge
                                key={origin}
                                variant="secondary"
                                className="bg-fuchsia-100 text-fuchsia-800 rounded-full px-2 py-1 text-sm font-normal"
                              >
                                <span>{origin}</span>
                                <button
                                  type="button"
                                  className="ltr:mr-1.5 rtl:ml-1.5 text-fuchsia-600 hover:text-fuchsia-900"
                                  onClick={() =>
                                    handleRemoveItemFromArray(
                                      'preferredOrigins',
                                      origin
                                    )
                                  }
                                  aria-label={t.cards.personalBackground.originRemoveLabel.replace(
                                    '{{origin}}',
                                    origin
                                  )}
                                >
                                  <XCircle className="w-3.5 h-3.5" />
                                </button>
                              </Badge>
                            ))}
                        </div>
                        <Label
                          htmlFor="preferred-origins-input"
                          className="sr-only"
                        >
                          {t.cards.personalBackground.originPlaceholder}
                        </Label>
                        <Autocomplete
                          id="preferred-origins-input"
                          apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                          value={originInputValue}
                          onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                            setOriginInputValue(e.target.value)
                          }
                          onPlaceSelected={(place) => {
                            const countryComponent =
                              place.address_components?.find((component) =>
                                component.types.includes('country')
                              );
                            const selectedCountry =
                              countryComponent?.long_name ||
                              place.formatted_address ||
                              '';
                            handleAddItemToArray(
                              'preferredOrigins',
                              selectedCountry
                            );
                            setOriginInputValue('');
                          }}
                          options={{ types: ['country'] }}
                          className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                          placeholder={
                            t.cards.personalBackground.originPlaceholder
                          }
                        />
                      </div>
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {!formData.preferredOrigins ||
                      formData.preferredOrigins.length === 0 ? (
                        <p className="text-sm text-gray-500 italic">
                          {t.cards.personalBackground.originEmpty}
                        </p>
                      ) : (
                        formData.preferredOrigins.map((originValue) => {
                          const option = preferredOriginOptions.find(
                            (opt) => opt.value === originValue
                          );
                          const label = option ? option.label : originValue;
                          return (
                            <Badge
                              key={originValue}
                              variant="secondary"
                              className="ltr:mr-1 rtl:ml-1 mb-1 bg-fuchsia-100 text-fuchsia-700 text-xs px-2 py-0.5 rounded-full"
                            >
                              {label}
                            </Badge>
                          );
                        })
                      )}
                    </div>
                  )}
                </fieldset>
                <div>
                  <Label
                    htmlFor="preferredAliyaStatus"
                    className="block mb-1.5 text-xs font-medium text-gray-600"
                  >
                    {t.cards.personalBackground.aliyaStatusLabel}
                  </Label>
                  {isEditing ? (
                    <Select
                      name="preferredAliyaStatus"
                      value={formData.preferredAliyaStatus || ''}
                      onValueChange={(value) =>
                        handleSelectChange('preferredAliyaStatus', value)
                      }
                    >
                      <SelectTrigger
                        id="preferredAliyaStatus"
                        className="h-9 text-sm focus:ring-cyan-500"
                      >
                        <SelectValue
                          placeholder={
                            t.cards.personalBackground.aliyaStatusPlaceholder
                          }
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {preferredAliyaStatusOptions.map((opt) => (
                          <SelectItem key={opt.value} value={opt.value}>
                            {opt.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-sm text-gray-800 font-medium mt-1">
                      {getSelectDisplayValue(
                        formData.preferredAliyaStatus,
                        preferredAliyaStatusOptions,
                        ''
                      )}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-amber-50/40 to-yellow-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Sparkles className="w-5 h-5 text-amber-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {t.cards.characterAndInterests.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.characterAndInterests.traitsLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {characterTraitsOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredCharacterTraits || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredCharacterTraits',
                              opt.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.preferredCharacterTraits || []).length >=
                              3 &&
                            !(formData.preferredCharacterTraits || []).includes(
                              opt.value
                            ) &&
                            opt.value !== 'no_strong_preference'
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all flex items-center',
                            (formData.preferredCharacterTraits || []).includes(
                              opt.value
                            )
                              ? 'bg-yellow-500 hover:bg-yellow-600 text-white border-yellow-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.icon && (
                            <opt.icon className="w-3.5 h-3.5 ltr:mr-1.5 rtl:ml-1.5" />
                          )}
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredCharacterTraits,
                        characterTraitsOptions,
                        'bg-yellow-100 text-yellow-700',
                        t.cards.characterAndInterests.traitsEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-xs font-medium text-gray-600">
                    {t.cards.characterAndInterests.hobbiesLegend}
                  </legend>
                  {isEditing ? (
                    <div className="flex flex-wrap gap-2">
                      {hobbiesOptions.map((opt) => (
                        <Button
                          key={opt.value}
                          type="button"
                          variant={
                            (formData.preferredHobbies || []).includes(
                              opt.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectChange(
                              'preferredHobbies',
                              opt.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.preferredHobbies || []).length >= 3 &&
                            !(formData.preferredHobbies || []).includes(
                              opt.value
                            ) &&
                            opt.value !== 'no_strong_preference'
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all flex items-center',
                            (formData.preferredHobbies || []).includes(
                              opt.value
                            )
                              ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {opt.icon && (
                            <opt.icon className="w-3.5 h-3.5 ltr:mr-1.5 rtl:ml-1.5" />
                          )}
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.preferredHobbies,
                        hobbiesOptions,
                        'bg-amber-100 text-amber-700',
                        t.cards.characterAndInterests.hobbiesEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PreferencesSection;
--- End of Content for PreferencesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\ProfileChecklist.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/dashboard/ProfileChecklist.tsx

import React, { useState, useMemo } from 'react';
import Link from 'next/link';
import { Progress } from '@/components/ui/progress';
import { Button } from '@/components/ui/button';
import {
  CheckCircle,
  User,
  BookOpen,
  Camera,
  Target,
  ChevronUp,
  ChevronDown,
  Sparkles,
  Edit3,
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import type { User as SessionUserType } from '@/types/next-auth';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { Gender } from '@prisma/client';
import { ProfileChecklistDict } from '@/types/dictionary';

// Helper Types & Constants
const QUESTION_COUNTS: Record<
  'VALUES' | 'PERSONALITY' | 'RELATIONSHIP' | 'PARTNER' | 'RELIGION',
  number
> = {
  VALUES: 19,
  PERSONALITY: 19,
  RELATIONSHIP: 19,
  PARTNER: 17,
  RELIGION: 19,
};

const WORLD_NAMES_MAP = {
  values: 'ערכים',
  personality: 'אישיות',
  relationship: 'זוגיות',
  partner: 'פרטנר',
  religion: 'דת ומסורת',
} as const;

type WorldKey = keyof typeof WORLD_NAMES_MAP;

interface ChecklistItemProps {
  id: string;
  isCompleted: boolean;
  title: string;
  description: string;
  link?: string;
  onClick?: () => void;
  icon: React.ElementType;
  missingItems?: string[];
  worldProgress?: {
    world: string;
    completed: number;
    total: number;
    isDone: boolean;
  }[];
  isActive: boolean;
  setActiveItemId: React.Dispatch<React.SetStateAction<string | null>>;
  dict: ProfileChecklistDict;
}

const ChecklistItem: React.FC<ChecklistItemProps> = ({
  id,
  isCompleted,
  title,
  description,
  link,
  onClick,
  icon: Icon,
  missingItems,
  worldProgress,
  isActive,
  setActiveItemId,
  dict,
}) => {
  const canExpand =
    (missingItems && missingItems.length > 0) ||
    (worldProgress && worldProgress.length > 0);
  const isExpanded = isActive && canExpand;

  // --- שינוי 1: שם הפונקציה שונה כדי לשקף את השימוש ב-onPointerDown ---
  const handleInteraction = (event: React.PointerEvent) => {
    if (isCompleted) return;

    // מונע מהאירוע להפעיל אירועי עכבר מדומים שעלולים לגרום ללחיצה כפולה
    event.preventDefault();

    if (onClick) {
      onClick();
    }
  };

  const cardContent = (
    <>
      <div className="relative w-full flex justify-center mb-3">
        <div
          className={cn(
            'relative flex items-center justify-center w-14 h-14 rounded-2xl transition-all duration-300 transform group-hover:scale-110',
            isCompleted
              ? 'bg-emerald-100 shadow-emerald-500/10'
              : 'bg-cyan-100 shadow-cyan-500/10'
          )}
        >
          <Icon
            className={cn(
              'w-7 h-7 transition-colors duration-300',
              isCompleted ? 'text-emerald-500' : 'text-cyan-600'
            )}
          />
        </div>
        {isCompleted && (
          <motion.div
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{
              type: 'spring',
              stiffness: 400,
              damping: 20,
              delay: 0.2,
            }}
            className="absolute -top-1 -end-1"
          >
            <CheckCircle
              className="w-5 h-5 text-emerald-500 bg-white rounded-full p-0.5"
              fill="white"
            />
          </motion.div>
        )}
      </div>
      <h4
        className={cn(
          'font-bold text-sm text-center transition-colors',
          isCompleted ? 'text-gray-400 line-through' : 'text-gray-800'
        )}
      >
        {title}
      </h4>
      {!isCompleted && (
        <p className="text-xs text-center text-gray-500 mt-1 leading-tight h-8">
          {description}
        </p>
      )}
    </>
  );

  const interactiveContent =
    link && !isCompleted ? (
      <Link href={link} passHref legacyBehavior>
        <a className="block h-full w-full">{cardContent}</a>
      </Link>
    ) : (
      <button
        // --- שינוי 2: החלפת onClick ב-onPointerDown ---
        onPointerDown={handleInteraction}
        className="h-full w-full text-start"
        disabled={isCompleted}
      >
        {cardContent}
      </button>
    );

  return (
    <motion.div
      layout
      className={cn(
        'relative flex flex-col rounded-2xl transition-all duration-300 group overflow-hidden',
        isCompleted ? 'bg-white/40' : 'bg-white/70 shadow-md',
        isExpanded && 'shadow-xl bg-white'
      )}
    >
      <div className={cn('p-4 relative', !isCompleted && 'cursor-pointer')}>
        {interactiveContent}
        {canExpand && !isCompleted && (
          <Button
            variant="ghost"
            size="icon"
            // --- שינוי 3: החלפת onClick ב-onPointerDown בכפתור ההרחבה ---
            onPointerDown={(e) => {
              e.stopPropagation(); // עדיין חשוב מאוד למנוע bubbling
              setActiveItemId((prev) => (prev === id ? null : id));
            }}
            className="absolute bottom-1 end-1 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200/50"
            aria-label={isExpanded ? dict.minimizeLabel : dict.expandLabel}
          >
            {isExpanded ? (
              <ChevronUp className="w-5 h-5" />
            ) : (
              <ChevronDown className="w-5 h-5" />
            )}
          </Button>
        )}
      </div>
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            layout
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            transition={{ duration: 0.3, ease: 'easeInOut' }}
            className="overflow-hidden"
          >
            <div className="bg-slate-50/70 border-t border-slate-200 px-4 py-3 text-sm">
              <h4 className="font-semibold text-xs mb-2 text-gray-800">
                {dict.missingItemsTitle}
              </h4>
              {missingItems && (
                <ul className="list-disc ps-4 space-y-1.5 text-gray-600 text-xs">
                  {missingItems.map((item) => (
                    <li key={item}>{item}</li>
                  ))}
                </ul>
              )}
              {worldProgress && (
                <div className="space-y-2">
                  {worldProgress.map((world) => (
                    <div
                      key={world.world}
                      className="flex items-center justify-between text-xs"
                    >
                      <span
                        className={cn(
                          'font-medium',
                          world.isDone ? 'text-emerald-600' : 'text-gray-700'
                        )}
                      >
                        {WORLD_NAMES_MAP[world.world as WorldKey] ||
                          world.world}
                      </span>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-xs">
                          {world.completed}/{world.total}
                        </span>
                        {world.isDone && (
                          <CheckCircle className="h-4 w-4 text-emerald-500" />
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

interface ProfileChecklistProps {
  user: SessionUserType;
  hasSeenPreview: boolean;
  onPreviewClick: () => void;
  questionnaireResponse: QuestionnaireResponse | null;
  dict: ProfileChecklistDict;
  locale: string; // Added: locale prop for directionality
  onNavigateToTab: (tab: string) => void; // <-- הוסף שורה זו
}

export const ProfileChecklist: React.FC<ProfileChecklistProps> = ({
  user,
  onPreviewClick,
  hasSeenPreview,
  questionnaireResponse,
  dict,
  locale, // Added: destructure locale
  onNavigateToTab, // <-- הוסף את זה
}) => {
  const [isMinimized, setIsMinimized] = useState(true);
  const [activeItemId, setActiveItemId] = useState<string | null>(null);
  const missingItemsDict = dict.missingItems;

  // Added: Determine direction based on locale
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const getMissingItems = useMemo(() => {
    const p = user.profile;
    if (!p) return { personalDetails: [], partnerPreferences: [] };

    const personalDetails = [
      !p.profileHeadline && missingItemsDict.profileHeadline,
      (!p.about || p.about.trim().length < 100) && missingItemsDict.about,
      // --- START: הוספת בדיקות חדשות ---
      (!p.testimonials ||
        p.testimonials.filter((t) => t.status === 'APPROVED').length < 1) &&
        missingItemsDict.testimonials,
      // --- END: הוספת בדיקות חדשות ---
      !p.inspiringCoupleStory && missingItemsDict.inspiringCoupleStory,
      !p.influentialRabbi && missingItemsDict.influentialRabbi,
      (p.hasMedicalInfo === null || p.hasMedicalInfo === undefined) &&
        missingItemsDict.medicalInfoReference,
      p.hasMedicalInfo === true &&
        !p.medicalInfoDetails &&
        missingItemsDict.medicalInfoDetails,
      p.hasMedicalInfo === true &&
        !p.medicalInfoDisclosureTiming &&
        missingItemsDict.medicalInfoDisclosureTiming,
      !p.birthDate && missingItemsDict.birthDate,
      !p.height && missingItemsDict.height,
      !p.city && missingItemsDict.city,
      !p.origin && missingItemsDict.origin,
      !p.nativeLanguage && missingItemsDict.nativeLanguage,
      p.aliyaCountry && !p.aliyaYear && missingItemsDict.aliyaYear,
      !p.maritalStatus && missingItemsDict.maritalStatus,
      p.maritalStatus &&
        ['divorced', 'widowed', 'annulled'].includes(p.maritalStatus) &&
        (p.hasChildrenFromPrevious === null ||
          p.hasChildrenFromPrevious === undefined) &&
        missingItemsDict.childrenFromPreviousReference,
      !p.parentStatus && missingItemsDict.parentStatus,
      !p.fatherOccupation && missingItemsDict.fatherOccupation,
      !p.motherOccupation && missingItemsDict.motherOccupation,
      (p.siblings === null || p.siblings === undefined) &&
        missingItemsDict.siblings,
      (p.position === null || p.position === undefined) &&
        missingItemsDict.position,
      !p.religiousLevel && missingItemsDict.religiousLevel,
      !p.religiousJourney && missingItemsDict.religiousJourney,
      (p.shomerNegiah === null || p.shomerNegiah === undefined) &&
        missingItemsDict.shomerNegiah,
      !p.educationLevel && missingItemsDict.educationLevel,
      !p.education && missingItemsDict.educationDetails,
      !p.occupation && missingItemsDict.occupation,
      !p.serviceType && missingItemsDict.serviceType,
      !p.serviceDetails && missingItemsDict.serviceDetails,
      (!p.profileCharacterTraits || p.profileCharacterTraits.length === 0) &&
        missingItemsDict.characterTraits,
      (!p.profileHobbies || p.profileHobbies.length === 0) &&
        missingItemsDict.hobbies,
    ].filter(Boolean);

    const partnerPreferences = [
      (!p.matchingNotes || p.matchingNotes.trim().length === 0) &&
        missingItemsDict.matchingNotes,
      !p.contactPreference && missingItemsDict.contactPreference,
      (!p.preferredAgeMin || !p.preferredAgeMax) &&
        missingItemsDict.preferredAgeRange,
      (!p.preferredHeightMin || !p.preferredHeightMax) &&
        missingItemsDict.preferredHeightRange,
      (!p.preferredLocations || p.preferredLocations.length === 0) &&
        missingItemsDict.preferredLocations,
      (!p.preferredReligiousLevels ||
        p.preferredReligiousLevels.length === 0) &&
        missingItemsDict.preferredReligiousLevels,
      (!p.preferredReligiousJourneys ||
        p.preferredReligiousJourneys.length === 0) &&
        missingItemsDict.preferredReligiousJourneys,
      (p.preferredShomerNegiah === null ||
        p.preferredShomerNegiah === undefined) &&
        missingItemsDict.preferredShomerNegiah,
      (!p.preferredEducation || p.preferredEducation.length === 0) &&
        missingItemsDict.preferredEducation,
      (!p.preferredOccupations || p.preferredOccupations.length === 0) &&
        missingItemsDict.preferredOccupations,
      (!p.preferredServiceTypes || p.preferredServiceTypes.length === 0) &&
        missingItemsDict.preferredServiceTypes,
      (!p.preferredMaritalStatuses ||
        p.preferredMaritalStatuses.length === 0) &&
        missingItemsDict.preferredMaritalStatuses,
      (p.preferredPartnerHasChildren === null ||
        p.preferredPartnerHasChildren === undefined) &&
        missingItemsDict.preferredPartnerHasChildren,
      (!p.preferredOrigins || p.preferredOrigins.length === 0) &&
        missingItemsDict.preferredOrigins,
      !p.preferredAliyaStatus && missingItemsDict.preferredAliyaStatus,
      (!p.preferredCharacterTraits ||
        p.preferredCharacterTraits.length === 0) &&
        missingItemsDict.preferredCharacterTraits,
      (!p.preferredHobbies || p.preferredHobbies.length === 0) &&
        missingItemsDict.preferredHobbies,
    ].filter(Boolean);

    if (p.gender === Gender.FEMALE) {
      if (!p.headCovering) personalDetails.push(missingItemsDict.headCovering);
      if (!p.preferredKippahTypes || p.preferredKippahTypes.length === 0)
        partnerPreferences.push(missingItemsDict.preferredKippahTypes);
    } else if (p.gender === Gender.MALE) {
      if (!p.kippahType) personalDetails.push(missingItemsDict.kippahType);
      if (!p.preferredHeadCoverings || p.preferredHeadCoverings.length === 0)
        partnerPreferences.push(missingItemsDict.preferredHeadCoverings);
    }

    return {
      personalDetails: personalDetails as string[],
      partnerPreferences: partnerPreferences as string[],
    };
  }, [user.profile, missingItemsDict]);

  const questionnaireProgress = useMemo(() => {
    const getAnswerCountFromJsonArray = (jsonValue: unknown): number => {
      if (Array.isArray(jsonValue)) return jsonValue.length;
      return 0;
    };

    if (!questionnaireResponse) {
      return (Object.keys(WORLD_NAMES_MAP) as WorldKey[]).map((key) => ({
        world: WORLD_NAMES_MAP[key],
        completed: 0,
        total:
          QUESTION_COUNTS[key.toUpperCase() as keyof typeof QUESTION_COUNTS],
        isDone: false,
      }));
    }

    const qr = questionnaireResponse;
    return (Object.keys(WORLD_NAMES_MAP) as WorldKey[]).map((key) => {
      const uppercaseKey = key.toUpperCase() as keyof typeof QUESTION_COUNTS;
      const answersFieldKey = `${key}Answers` as keyof QuestionnaireResponse;
      const completedCount = getAnswerCountFromJsonArray(qr[answersFieldKey]);
      return {
        world: WORLD_NAMES_MAP[key],
        completed: completedCount,
        total: QUESTION_COUNTS[uppercaseKey],
        isDone: qr.worldsCompleted?.includes(uppercaseKey) ?? false,
      };
    });
  }, [questionnaireResponse]);

  const questionnaireCompleted = questionnaireResponse?.completed ?? false;

  // src/app/[locale]/(authenticated)/profile/components/dashboard/ProfileChecklist.tsx

  const tasks = [
    {
      id: 'photo',
      isCompleted: (user.images?.length ?? 0) >= 3,
      title: dict.tasks.photos.title,
      description: dict.tasks.photos.description,
      onClick: () => onNavigateToTab('photos'), // <-- שורה זו עודכנה
      icon: Camera,
      missingItems:
        (user.images?.length ?? 0) < 3
          ? [
              dict.tasks.photos.missing.replace(
                '{{count}}',
                (3 - (user.images?.length ?? 0)).toString()
              ),
            ]
          : [],
    },
    {
      id: 'personal_details',
      isCompleted: getMissingItems.personalDetails.length === 0,
      title: dict.tasks.personalDetails.title,
      description: dict.tasks.personalDetails.description,
      onClick: () => onNavigateToTab('overview'), // <-- שורה זו עודכנה
      icon: User,
      missingItems: getMissingItems.personalDetails,
    },
    {
      id: 'partner_preferences',
      isCompleted: getMissingItems.partnerPreferences.length === 0,
      title: dict.tasks.partnerPreferences.title,
      description: dict.tasks.partnerPreferences.description,
      onClick: () => onNavigateToTab('preferences'), // <-- שורה זו עודכנה
      icon: Target,
      missingItems: getMissingItems.partnerPreferences,
    },
    {
      id: 'questionnaire',
      isCompleted: questionnaireCompleted,
      title: dict.tasks.questionnaire.title,
      description: dict.tasks.questionnaire.description,
      link: '/questionnaire', // <-- ללא שינוי, מפנה לעמוד אחר
      icon: BookOpen,
      worldProgress: questionnaireProgress ?? undefined,
    },
    {
      id: 'review',
      isCompleted: hasSeenPreview,
      title: dict.tasks.review.title,
      description: dict.tasks.review.description,
      onClick: onPreviewClick, // <-- ללא שינוי, פותח דיאלוג
      icon: Edit3,
      missingItems: !hasSeenPreview ? [dict.tasks.review.missing] : [],
    },
  ];

  const completionPercentage = useMemo(() => {
    const QUESTIONNAIRE_WEIGHT = 20;
    const OTHER_TASKS_WEIGHT = 80;

    const totalQuestions = Object.values(QUESTION_COUNTS).reduce(
      (sum, count) => sum + count,
      0
    );
    const answeredQuestions = questionnaireProgress.reduce(
      (sum, world) => sum + world.completed,
      0
    );
    const questionnaireContribution =
      totalQuestions > 0
        ? (answeredQuestions / totalQuestions) * QUESTIONNAIRE_WEIGHT
        : 0;

    const p = user.profile;
    const otherTasksStatus: boolean[] = [];

    // Task 1: Photos
    otherTasksStatus.push((user.images?.length ?? 0) >= 3);

    if (p) {
      // --- START OF UPDATED LOGIC FOR PROGRESS BAR ---
      // Personal Details Checks
      otherTasksStatus.push(!!p.profileHeadline);
      otherTasksStatus.push(!!(p.about && p.about.trim().length >= 100));
      // --- START: הוספת בדיקות חדשות לסרגל ההתקדמות ---
      otherTasksStatus.push(
        !!(
          p.testimonials &&
          p.testimonials.filter((t) => t.status === 'APPROVED').length >= 1
        )
      );
      // --- END: הוספת בדיקות חדשות לסרגל ההתקדמות ---
      otherTasksStatus.push(!!p.inspiringCoupleStory);
      otherTasksStatus.push(!!p.influentialRabbi);
      otherTasksStatus.push(
        p.hasMedicalInfo !== null && p.hasMedicalInfo !== undefined
      );
      otherTasksStatus.push(!p.hasMedicalInfo || !!p.medicalInfoDetails);
      otherTasksStatus.push(
        !p.hasMedicalInfo || !!p.medicalInfoDisclosureTiming
      );
      otherTasksStatus.push(!!p.birthDate);
      otherTasksStatus.push(!!p.height);
      otherTasksStatus.push(!!p.city);
      otherTasksStatus.push(!!p.origin);
      otherTasksStatus.push(!!p.nativeLanguage);
      otherTasksStatus.push(!p.aliyaCountry || !!p.aliyaYear);
      otherTasksStatus.push(!!p.maritalStatus);
      otherTasksStatus.push(
        !['divorced', 'widowed', 'annulled'].includes(p.maritalStatus || '') ||
          (p.hasChildrenFromPrevious !== null &&
            p.hasChildrenFromPrevious !== undefined)
      );
      otherTasksStatus.push(!!p.parentStatus);
      otherTasksStatus.push(!!p.fatherOccupation);
      otherTasksStatus.push(!!p.motherOccupation);
      otherTasksStatus.push(p.siblings !== null && p.siblings !== undefined);
      otherTasksStatus.push(p.position !== null && p.position !== undefined);
      otherTasksStatus.push(!!p.religiousLevel);
      otherTasksStatus.push(!!p.religiousJourney);
      otherTasksStatus.push(
        p.shomerNegiah !== null && p.shomerNegiah !== undefined
      );
      otherTasksStatus.push(!!p.educationLevel);
      otherTasksStatus.push(!!p.education);
      otherTasksStatus.push(!!p.occupation);
      otherTasksStatus.push(!!p.serviceType);
      otherTasksStatus.push(!!p.serviceDetails);
      otherTasksStatus.push(
        !!(p.profileCharacterTraits && p.profileCharacterTraits.length > 0)
      );
      otherTasksStatus.push(
        !!(p.profileHobbies && p.profileHobbies.length > 0)
      );

      // Partner Preferences Checks
      otherTasksStatus.push(
        !!(p.matchingNotes && p.matchingNotes.trim().length > 0)
      );
      otherTasksStatus.push(!!p.contactPreference);
      otherTasksStatus.push(!!(p.preferredAgeMin && p.preferredAgeMax));
      otherTasksStatus.push(!!(p.preferredHeightMin && p.preferredHeightMax));
      otherTasksStatus.push(
        !!(p.preferredLocations && p.preferredLocations.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredReligiousLevels && p.preferredReligiousLevels.length > 0)
      );
      otherTasksStatus.push(
        !!(
          p.preferredReligiousJourneys &&
          p.preferredReligiousJourneys.length > 0
        )
      );
      otherTasksStatus.push(
        p.preferredShomerNegiah !== null &&
          p.preferredShomerNegiah !== undefined
      );
      otherTasksStatus.push(
        !!(p.preferredEducation && p.preferredEducation.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredOccupations && p.preferredOccupations.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredServiceTypes && p.preferredServiceTypes.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredMaritalStatuses && p.preferredMaritalStatuses.length > 0)
      );
      otherTasksStatus.push(
        p.preferredPartnerHasChildren !== null &&
          p.preferredPartnerHasChildren !== undefined
      );
      otherTasksStatus.push(
        !!(p.preferredOrigins && p.preferredOrigins.length > 0)
      );
      otherTasksStatus.push(!!p.preferredAliyaStatus);
      otherTasksStatus.push(
        !!(p.preferredCharacterTraits && p.preferredCharacterTraits.length > 0)
      );
      otherTasksStatus.push(
        !!(p.preferredHobbies && p.preferredHobbies.length > 0)
      );

      // Gender-specific checks
      if (p.gender === Gender.FEMALE) {
        otherTasksStatus.push(!!p.headCovering); // personal
        otherTasksStatus.push(
          !!(p.preferredKippahTypes && p.preferredKippahTypes.length > 0)
        ); // preference
      } else if (p.gender === Gender.MALE) {
        otherTasksStatus.push(!!p.kippahType); // personal
        otherTasksStatus.push(
          !!(p.preferredHeadCoverings && p.preferredHeadCoverings.length > 0)
        ); // preference
      }
      // --- END OF UPDATED LOGIC FOR PROGRESS BAR ---
    } else {
      // If no profile, add placeholders for all items
      const totalProfileFields = 56; // Calculated number of fields including gender-specific and new ones
      otherTasksStatus.push(...Array(totalProfileFields).fill(false));
    }

    // Task 5: Review
    otherTasksStatus.push(hasSeenPreview);

    const totalOtherTasks = otherTasksStatus.length;
    const completedOtherTasks = otherTasksStatus.filter(
      (isCompleted) => isCompleted
    ).length;

    const otherTasksContribution =
      totalOtherTasks > 0
        ? (completedOtherTasks / totalOtherTasks) * OTHER_TASKS_WEIGHT
        : 0;

    return Math.round(questionnaireContribution + otherTasksContribution);
  }, [user, questionnaireProgress, hasSeenPreview]);

  const isAllComplete = completionPercentage >= 100;

  return (
    <AnimatePresence>
      <motion.div
        layout
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, height: 0, transition: { duration: 0.4 } }}
        transition={{ duration: 0.5, ease: 'easeOut' }}
        className="mb-8 rounded-3xl shadow-xl border border-white/50 bg-white/70 backdrop-blur-md overflow-hidden"
        dir={direction} // Added: set direction for the whole component
      >
        <div className="p-4 sm:p-6">
          <div className="md:flex md:items-center md:justify-between">
            <div className="flex-1 text-center md:text-start">
              {' '}
              {/* Updated: from md:text-right to md:text-start */}
              <h2 className="text-xl font-bold text-slate-800 flex items-center justify-center md:justify-start gap-2">
                {isAllComplete && (
                  <Sparkles className="w-6 h-6 text-amber-500" />
                )}
                {(() => {
                  const isFemale = user.profile?.gender === 'FEMALE';
                  const welcomeText =
                    isFemale && dict.welcome_female
                      ? dict.welcome_female
                      : dict.welcome;
                  const allCompleteText =
                    isFemale && dict.allComplete_female
                      ? dict.allComplete_female
                      : dict.allComplete;
                  const textToShow = isAllComplete
                    ? allCompleteText
                    : welcomeText;
                  return textToShow.replace(
                    '{{firstName}}',
                    user.firstName || ''
                  );
                })()}
              </h2>
              <AnimatePresence initial={false}>
                {!isMinimized && (
                  <motion.p
                    initial={{ opacity: 0, height: 0, marginTop: 0 }}
                    animate={{
                      opacity: 1,
                      height: 'auto',
                      marginTop: '0.25rem',
                    }}
                    exit={{ opacity: 0, height: 0, marginTop: 0 }}
                    className="text-slate-600 text-sm md:text-base overflow-hidden"
                  >
                    {isAllComplete
                      ? dict.allCompleteSubtitle
                      : dict.welcomeSubtitle}
                  </motion.p>
                )}
              </AnimatePresence>
            </div>
            <div className="mt-4 md:mt-0 md:w-auto lg:w-1/3 flex items-center gap-4">
              <div className="flex-1">
                <div className="flex justify-between items-center text-sm mb-1">
                  <span
                    id="profile-completion-label"
                    className="font-medium text-gray-700"
                  >
                    {dict.completionLabel}
                  </span>
                  <span className="font-bold text-cyan-600">
                    {completionPercentage}%
                  </span>
                </div>
                <Progress
                  value={completionPercentage}
                  aria-labelledby="profile-completion-label"
                  className="h-2 bg-slate-200/70"
                />
              </div>
              <Button
                variant="ghost"
                size="icon"
                className="text-slate-500 hover:bg-slate-200/50 rounded-full flex-shrink-0"
                onClick={() => setIsMinimized(!isMinimized)}
                aria-label={isMinimized ? dict.expandLabel : dict.minimizeLabel}
              >
                {isMinimized ? (
                  <ChevronDown className="h-5 w-5" />
                ) : (
                  <ChevronUp className="h-5 w-5" />
                )}
              </Button>
            </div>
          </div>
          <AnimatePresence initial={false}>
            {!isMinimized && (
              <motion.div
                key="checklist-content"
                initial={{ height: 0, opacity: 0 }}
                animate={{
                  height: 'auto',
                  opacity: 1,
                  transition: { opacity: { delay: 0.1 } },
                }}
                exit={{ height: 0, opacity: 0, transition: { duration: 0.3 } }}
                className="overflow-hidden"
                // The onMouseLeave event handler has been removed from here.
              >
                <ul className="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-4">
                  {tasks.map((task) => (
                    <li key={task.id}>
                      <ChecklistItem
                        key={task.id}
                        {...task}
                        isActive={activeItemId === task.id}
                        setActiveItemId={setActiveItemId}
                        dict={dict}
                      />
                    </li>
                  ))}
                </ul>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </motion.div>
    </AnimatePresence>
  );
};
--- End of Content for ProfileChecklist.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\ProfileSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/profile/sections/ProfileSection.tsx
'use client';

import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import {
  Gender,
  AvailabilityStatus,
  ServiceType,
  HeadCoveringType,
  KippahType,
  ReligiousJourney,
} from '@prisma/client';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Pencil,
  Save,
  X,
  MessageSquare,
  Award,
  Send,
  Copy,
  Users,
  BookOpen,
  Loader2,
  Trash2,
  Briefcase,
  Shield,
  Heart,
  MapPin,
  Languages,
  Palette,
  Smile,
  UserCircle,
  Info,
  HeartPulse,
  Lock,
  Eye,
  EyeOff,
} from 'lucide-react';
import { UserProfile, FriendTestimonial } from '@/types/next-auth';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { languageOptions } from '@/lib/languageOptions';
import { toast } from 'sonner';
import Autocomplete from 'react-google-autocomplete';
import { Switch } from '@/components/ui/switch';
import { ProfileSectionDict, FriendTestimonialsDict } from '@/types/dictionary';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';

interface ProfileSectionProps {
  profile: UserProfile | null;
  isEditing: boolean;
  setIsEditing: (value: boolean) => void;
  viewOnly?: boolean;
  onSave: (data: Partial<UserProfile>) => void;
  dict: ProfileSectionDict;
  locale: string;
}

const ensureDateObject = (
  value: string | number | Date | null | undefined
): Date | undefined => {
  if (!value) return undefined;
  if (value instanceof Date && !isNaN(value.getTime())) {
    return value;
  }
  if (typeof value === 'string' || typeof value === 'number') {
    const date = new Date(value);
    if (!isNaN(date.getTime())) {
      return date;
    }
  }
  return undefined;
};

// ========================================================================
// ✨ Helper Functions
// ========================================================================

const renderDisplayValue = (
  value: unknown,
  dict: ProfileSectionDict,
  placeholder?: string
): React.ReactNode => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  if (value === null || value === undefined || value === '') {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  if (value instanceof Date && !isNaN(value.getTime())) {
    return new Intl.DateTimeFormat('he-IL').format(value);
  }
  return String(value);
};

const renderSelectDisplayValue = (
  value: string | undefined | null,
  options: { value: string; label: string }[],
  dict: ProfileSectionDict,
  placeholder?: string
) => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  if (!value) {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  const option = options.find((opt) => opt.value === value);
  return option ? (
    option.label
  ) : (
    <span className="italic text-gray-500">{finalPlaceholder}</span>
  );
};

const renderBooleanDisplayValue = (
  value: boolean | undefined | null,
  dict: ProfileSectionDict,
  trueLabel?: string,
  falseLabel?: string,
  placeholder?: string
) => {
  const finalPlaceholder = placeholder || dict.placeholders.notSpecified;
  const finalTrueLabel = trueLabel || dict.cards.family.hasChildrenYes;
  const finalFalseLabel = falseLabel || dict.cards.medical.display.no;

  if (value === undefined || value === null) {
    return <span className="italic text-gray-500">{finalPlaceholder}</span>;
  }
  return value ? finalTrueLabel : finalFalseLabel;
};

// ========================================================================
// ✨ Sub-Components
// ========================================================================

const StoryAndMoreCard: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  if (!profile) return null;
  const tAboutCard = dict.cards.about;
  const tAboutMe = dict.aboutMe;

  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-slate-50/40 to-gray-100/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
        <Info className="w-5 h-5 text-slate-600" />
        <CardTitle className="text-base font-semibold text-gray-700">
          {tAboutCard.title}
        </CardTitle>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        <div className="space-y-6">
          {/* Profile Headline Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="profileHeadline"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.headlineLabel}
              </Label>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button type="button" aria-describedby="headline-tooltip">
                      <Info className="w-4 h-4 text-gray-400" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="headline-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.headlinePlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Input
                id="profileHeadline"
                value={formData.profileHeadline || ''}
                onChange={(e) =>
                  handleChange('profileHeadline', e.target.value)
                }
                className="text-sm focus:ring-cyan-500 rounded-lg"
                placeholder={tAboutCard.headlinePlaceholder}
                maxLength={80}
              />
            ) : (
              <div className="mt-1">
                {formData.profileHeadline &&
                typeof formData.profileHeadline === 'string' &&
                formData.profileHeadline.trim() ? (
                  <p className="text-lg font-semibold text-cyan-700 italic">
                    {`"${formData.profileHeadline}"`}
                  </p>
                ) : (
                  <div className="rounded-lg bg-slate-50 p-3 text-base italic border border-slate-200/80">
                    <p className="font-medium not-italic text-slate-600">
                      {tAboutCard.headlineEmpty.title}
                    </p>
                    <p className="mt-1.5 text-slate-500">
                      {tAboutCard.headlineEmpty.subtitle}
                      <span className="block mt-1 font-semibold text-slate-700">
                        {tAboutCard.headlineEmpty.example}
                      </span>
                    </p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* My Story Section (formerly AboutMeCard) */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-1.5">
                <Label
                  htmlFor="about"
                  className="text-sm font-medium text-gray-700"
                >
                  {tAboutMe.cardTitle}
                </Label>
                <TooltipProvider delayDuration={100}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <button
                        type="button"
                        aria-describedby="about-tooltip"
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <Info className="w-4 h-4" />
                      </button>
                    </TooltipTrigger>
                    <TooltipContent
                      id="about-tooltip"
                      side="top"
                      className="max-w-xs text-center"
                      dir={direction}
                      sideOffset={5}
                      collisionPadding={10}
                    >
                      {/* UPDATED: Use placeholder text */}
                      <p>{tAboutMe.placeholder}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <div className="flex items-center gap-2">
                      <Switch
                        checked={formData.isAboutVisible ?? true}
                        onCheckedChange={(checked) =>
                          handleChange('isAboutVisible', checked)
                        }
                        disabled={!isEditing}
                      />
                    </div>
                  </TooltipTrigger>
                  <TooltipContent
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    <p>{tAboutMe.visibilityTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <div>
                <Textarea
                  id="about"
                  value={formData.about || ''}
                  onChange={(e) => handleChange('about', e.target.value)}
                  className={cn(
                    'text-sm focus:ring-cyan-500 min-h-[120px] rounded-lg',
                    formData.about && formData.about.trim().length < 100
                      ? 'border-red-400 focus:ring-red-300'
                      : ''
                  )}
                  placeholder={tAboutMe.placeholder}
                  rows={5}
                  aria-describedby="about-char-count"
                />
                {formData.about && (
                  <div
                    id="about-char-count"
                    className={cn(
                      'text-xs mt-1 text-end',
                      formData.about.trim().length < 100
                        ? 'text-red-600'
                        : 'text-gray-500'
                    )}
                  >
                    {formData.about.trim().length}
                    {dict.charCount.replace('{{count}}', '100')}
                  </div>
                )}
              </div>
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[60px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {formData.about || (
                  <span className="text-gray-500 italic">
                    {tAboutCard.aboutEmpty}
                  </span>
                )}
              </p>
            )}
          </div>

          {/* Inspiring Couple Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="inspiringCoupleStory"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.inspiringCoupleLabel}
              </Label>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button type="button" aria-describedby="couple-tooltip">
                      <Info className="w-4 h-4 text-gray-400" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="couple-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.inspiringCouplePlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Textarea
                id="inspiringCoupleStory"
                value={formData.inspiringCoupleStory || ''}
                onChange={(e) =>
                  handleChange('inspiringCoupleStory', e.target.value)
                }
                className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                placeholder={tAboutCard.inspiringCouplePlaceholder}
                rows={3}
              />
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {renderDisplayValue(
                  formData.inspiringCoupleStory,
                  dict,
                  tAboutCard.inspiringCoupleEmpty
                )}
              </p>
            )}
          </div>

          {/* Private Notes Section */}
          <div>
            <div className="flex items-center gap-1.5 mb-2">
              <Label
                htmlFor="matchingNotes-private"
                className="text-sm font-medium text-gray-700"
              >
                {tAboutCard.privateNotesLabel}
              </Label>
              <TooltipProvider delayDuration={100}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-describedby="private-notes-tooltip"
                      className="text-gray-400 hover:text-gray-600"
                    >
                      <Info className="w-4 h-4" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    id="private-notes-tooltip"
                    side="top"
                    className="max-w-xs text-center"
                    dir={direction}
                    sideOffset={5}
                    collisionPadding={10}
                  >
                    {/* UPDATED: Use placeholder text */}
                    <p>{tAboutCard.privateNotesPlaceholder}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
            {isEditing ? (
              <Textarea
                id="matchingNotes-private"
                value={formData.matchingNotes || ''}
                onChange={(e) => handleChange('matchingNotes', e.target.value)}
                className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                placeholder={tAboutCard.privateNotesPlaceholder}
                rows={3}
              />
            ) : (
              <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                {formData.matchingNotes || (
                  <span className="text-gray-500 italic">
                    {tAboutCard.privateNotesEmpty}
                  </span>
                )}
              </p>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

const NeshamaTechSummaryCard: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  if (!profile) return null;
  const t = dict.neshamaTechSummary;
  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-purple-50/40 to-indigo-50/40 border-b border-gray-200/50 p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Award className="w-5 h-5 text-purple-700" />
          <CardTitle className="text-base font-semibold text-gray-700">
            {t.cardTitle}
          </CardTitle>
        </div>
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Switch
                checked={formData.isNeshamaTechSummaryVisible ?? true}
                onCheckedChange={(checked) =>
                  handleChange('isNeshamaTechSummaryVisible', checked)
                }
                disabled={!isEditing}
              />
            </TooltipTrigger>
            <TooltipContent
              dir={direction}
              sideOffset={5}
              collisionPadding={10}
            >
              <p>{t.visibilityTooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        <p className="text-sm text-gray-700 whitespace-pre-wrap min-h-[60px]">
          {profile.manualEntryText || (
            <span className="italic text-gray-500">{t.emptyState}</span>
          )}
        </p>
      </CardContent>
    </Card>
  );
};

const FriendTestimonialsManager: React.FC<{
  profile: UserProfile | null;
  isEditing: boolean;
  dict: ProfileSectionDict;
  handleChange: (field: keyof UserProfile, value: any) => void;
  formData: Partial<UserProfile>;
  direction: string; // Added direction prop
}> = ({ profile, isEditing, dict, handleChange, formData, direction }) => {
  const [testimonials, setTestimonials] = useState<FriendTestimonial[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);
  const [requestLink, setRequestLink] = useState('');

  const t = dict.friendTestimonials;

  const fetchTestimonials = useCallback(async () => {
    if (!profile) return;
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/testimonials');
      const data = await response.json();
      if (data.success) {
        setTestimonials(data.testimonials);
      } else {
        throw new Error(data.message || 'Failed to fetch');
      }
    } catch (error) {
      toast.error('Failed to load testimonials.');
      console.error(error);
    } finally {
      setIsLoading(false);
    }
  }, [profile]);

  useEffect(() => {
    fetchTestimonials();
  }, [fetchTestimonials]);

  const handleStatusChange = async (
    id: string,
    status: 'APPROVED' | 'HIDDEN'
  ) => {
    try {
      const response = await fetch(`/api/profile/testimonials/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });
      if (!response.ok) throw new Error('Failed to update status');
      toast.success('סטטוס ההמלצה עודכן!');
      fetchTestimonials(); // Refresh list
    } catch (error) {
      toast.error('שגיאה בעדכון סטטוס ההמלצה.');
    }
  };

  const handleDelete = async (id: string) => {
    if (window.confirm(t.deleteConfirm)) {
      try {
        const response = await fetch(`/api/profile/testimonials/${id}`, {
          method: 'DELETE',
        });
        if (!response.ok) throw new Error('Failed to delete');
        toast.success('ההמלצה נמחקה.');
        fetchTestimonials(); // Refresh list
      } catch (error) {
        toast.error('שגיאה במחיקת ההמלצה.');
      }
    }
  };

  const handleGenerateLink = async () => {
    try {
      const response = await fetch('/api/profile/testimonials/request-link', {
        method: 'POST',
      });
      const data = await response.json();
      if (data.success) {
        setRequestLink(data.link);
        setIsLinkModalOpen(true);
      } else {
        throw new Error(data.message || 'Failed to generate link');
      }
    } catch (error) {
      toast.error('שגיאה ביצירת קישור לבקשת המלצה.');
    }
  };

  const getStatusBadge = (status: 'PENDING' | 'APPROVED' | 'HIDDEN') => {
    switch (status) {
      case 'PENDING':
        return <Badge variant="warning">{t.pendingApproval}</Badge>;
      case 'APPROVED':
        return <Badge variant="success">{t.approvedAndVisible}</Badge>;
      case 'HIDDEN':
        return <Badge variant="secondary">{t.hidden}</Badge>;
    }
  };

  return (
    <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
      <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Users className="w-5 h-5 text-teal-700" />
          <CardTitle className="text-base font-semibold text-gray-700">
            {t.cardTitle}
          </CardTitle>
        </div>
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Switch
                checked={formData.isFriendsSectionVisible ?? true}
                onCheckedChange={(checked) =>
                  handleChange('isFriendsSectionVisible', checked)
                }
                disabled={!isEditing}
              />
            </TooltipTrigger>
            <TooltipContent
              dir={direction}
              sideOffset={5}
              collisionPadding={10}
            >
              <p>{t.visibilityTooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </CardHeader>
      <CardContent className="p-4 md:p-6">
        {isEditing && (
          <div className="flex flex-col sm:flex-row gap-2 mb-4 p-4 bg-slate-50 rounded-lg border">
            <Button
              size="sm"
              className="flex-1"
              onClick={() => setIsAddModalOpen(true)}
            >
              {t.addManualButton}
            </Button>
            <Button
              size="sm"
              variant="outline"
              className="flex-1"
              onClick={handleGenerateLink}
            >
              <Send className="w-4 h-4 mr-2" />
              {t.requestLinkButton}
            </Button>
          </div>
        )}

        {isLoading ? (
          <div className="flex justify-center p-4">
            <Loader2 className="animate-spin" />
          </div>
        ) : (
          <div className="space-y-3">
            {testimonials.length === 0 ? (
              <p className="text-sm text-center text-gray-500 py-4">
                {t.emptyState}
              </p>
            ) : (
              testimonials.map((item) => (
                <div
                  key={item.id}
                  className="border rounded-md p-3 bg-white/50"
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <p className="italic text-sm text-gray-600">
                        &quot;{item.content}&quot;
                      </p>
                      <p className="text-xs font-semibold mt-2">
                        - {item.authorName}, {item.relationship}
                      </p>
                    </div>
                    {isEditing && getStatusBadge(item.status)}
                  </div>
                  {isEditing && (
                    <div className="flex items-center gap-2 mt-2 pt-2 border-t">
                      {item.status !== 'APPROVED' && (
                        <Button
                          size="xs"
                          onClick={() =>
                            handleStatusChange(item.id, 'APPROVED')
                          }
                        >
                          {t.approveButton}
                        </Button>
                      )}
                      {item.status === 'APPROVED' && (
                        <Button
                          size="xs"
                          variant="outline"
                          onClick={() => handleStatusChange(item.id, 'HIDDEN')}
                        >
                          {t.hideButton}
                        </Button>
                      )}
                      {item.status === 'HIDDEN' && (
                        <Button
                          size="xs"
                          variant="outline"
                          onClick={() =>
                            handleStatusChange(item.id, 'APPROVED')
                          }
                        >
                          {t.showButton}
                        </Button>
                      )}
                      <Button
                        size="xs"
                        variant="destructive"
                        onClick={() => handleDelete(item.id)}
                      >
                        <Trash2 className="w-3 h-3 mr-1" />
                        {t.deleteButton}
                      </Button>
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        )}
      </CardContent>

      <AddTestimonialModal
        isOpen={isAddModalOpen}
        setIsOpen={setIsAddModalOpen}
        dict={t.addModal}
        onSuccess={fetchTestimonials}
      />

      <Dialog open={isLinkModalOpen} onOpenChange={setIsLinkModalOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>{t.linkModal.title}</DialogTitle>
            <DialogDescription>{t.linkModal.description}</DialogDescription>
          </DialogHeader>
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <Input value={requestLink} readOnly />
            <Button
              onClick={() =>
                navigator.clipboard
                  .writeText(requestLink)
                  .then(() => toast.success(t.linkModal.copiedTooltip))
              }
              size="icon"
            >
              <Copy className="h-4 w-4" />
            </Button>
          </div>
          <DialogFooter>
            <Button onClick={() => setIsLinkModalOpen(false)}>
              {t.linkModal.closeButton}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </Card>
  );
};

const AddTestimonialModal: React.FC<{
  isOpen: boolean;
  setIsOpen: (isOpen: boolean) => void;
  dict: FriendTestimonialsDict['addModal'];
  onSuccess: () => void;
}> = ({ isOpen, setIsOpen, dict, onSuccess }) => {
  const [formData, setFormData] = useState({
    authorName: '',
    relationship: '',
    content: '',
    authorPhone: '',
    isPhoneVisibleToMatch: false,
  });
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/testimonials', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      if (!response.ok) throw new Error('Failed to add testimonial');
      toast.success('Testimonial added!');
      onSuccess();
      setIsOpen(false);
      setFormData({
        authorName: '',
        relationship: '',
        content: '',
        authorPhone: '',
        isPhoneVisibleToMatch: false,
      });
    } catch (error) {
      toast.error('Error adding testimonial.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{dict.title}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label>{dict.authorNameLabel}</Label>
            <Input
              name="authorName"
              value={formData.authorName}
              onChange={(e) =>
                setFormData((p) => ({ ...p, authorName: e.target.value }))
              }
              required
              placeholder={dict.authorNamePlaceholder}
            />
          </div>
          <div>
            <Label>{dict.relationshipLabel}</Label>
            <Input
              name="relationship"
              value={formData.relationship}
              onChange={(e) =>
                setFormData((p) => ({ ...p, relationship: e.target.value }))
              }
              required
              placeholder={dict.relationshipPlaceholder}
            />
          </div>
          <div>
            <Label>{dict.contentLabel}</Label>
            <Textarea
              name="content"
              value={formData.content}
              onChange={(e) =>
                setFormData((p) => ({ ...p, content: e.target.value }))
              }
              required
              placeholder={dict.contentPlaceholder}
            />
          </div>
          <div>
            <Label>{dict.phoneLabel}</Label>
            <Input
              name="authorPhone"
              type="tel"
              value={formData.authorPhone}
              onChange={(e) =>
                setFormData((p) => ({ ...p, authorPhone: e.target.value }))
              }
              placeholder={dict.phonePlaceholder}
            />
          </div>
          <div className="flex items-center space-x-2 rtl:space-x-reverse">
            <Checkbox
              id="consent"
              checked={formData.isPhoneVisibleToMatch}
              onCheckedChange={(c) =>
                setFormData((p) => ({ ...p, isPhoneVisibleToMatch: !!c }))
              }
              disabled={!formData.authorPhone}
            />
            <Label htmlFor="consent">{dict.consentLabel}</Label>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="ghost"
              onClick={() => setIsOpen(false)}
            >
              {dict.cancelButton}
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? (
                <Loader2 className="animate-spin" />
              ) : (
                dict.saveButton
              )}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
};

// ========================================================================
// ✨ Main Component: ProfileSection
// ========================================================================

const ProfileSection: React.FC<ProfileSectionProps> = ({
  profile: profileProp,
  isEditing,
  setIsEditing,
  viewOnly = false,
  onSave,
  dict,
  locale,
}) => {
  const [formData, setFormData] = useState<Partial<UserProfile>>({});
  const [loading, setLoading] = useState(true);
  const [initialData, setInitialData] = useState<Partial<UserProfile>>({});

  const [cityInputValue, setCityInputValue] = useState('');
  const [aliyaCountryInputValue, setAliyaCountryInputValue] = useState('');

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const characterTraitsOptions = useMemo(
    () =>
      Object.entries(dict.options.traits).map(([value, label]) => ({
        value,
        label,
        icon:
          {
            empathetic: Heart,
            driven: Briefcase,
            optimistic: Smile,
            family_oriented: Users,
            intellectual: BookOpen,
            organized: Palette,
            calm: Heart,
            humorous: Smile,
            sociable: Users,
            sensitive: Heart,
            independent: MapPin,
            creative: Palette,
            honest: Shield,
            responsible: Shield,
            easy_going: Smile,
          }[value] || Smile,
      })),
    [dict.options.traits]
  );

  const hobbiesOptions = useMemo(
    () =>
      Object.entries(dict.options.hobbies).map(([value, label]) => ({
        value,
        label,
        icon:
          {
            travel: MapPin,
            sports: Briefcase,
            reading: BookOpen,
            cooking_baking: Palette,
            music_playing_instrument: Languages,
            art_crafts: Palette,
            volunteering: Heart,
            learning_courses: BookOpen,
            board_games_puzzles: Smile,
            movies_theater: Smile,
            dancing: Users,
            writing: BookOpen,
            nature_hiking: MapPin,
            photography: Palette,
          }[value] || Smile,
      })),
    [dict.options.hobbies]
  );

  const maritalStatusOptions = useMemo(
    () =>
      Object.entries(dict.options.maritalStatus).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.maritalStatus]
  );
  const religiousLevelOptions = useMemo(
    () =>
      Object.entries(dict.options.religiousLevel).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.religiousLevel]
  );
  const religiousJourneyOptions = useMemo(
    () =>
      Object.entries(dict.options.religiousJourney).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.religiousJourney]
  );
  const educationLevelOptions = useMemo(
    () =>
      Object.entries(dict.options.educationLevel).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.educationLevel]
  );
  const serviceTypeOptions = useMemo(
    () =>
      Object.entries(dict.options.serviceType).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.serviceType]
  );
  const headCoveringOptions = useMemo(
    () =>
      Object.entries(dict.options.headCovering).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.headCovering]
  );
  const kippahTypeOptions = useMemo(
    () =>
      Object.entries(dict.options.kippahType).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.kippahType]
  );
  const preferredMatchmakerGenderOptions = useMemo(
    () =>
      Object.entries(dict.options.matchmakerGender).map(([value, label]) => ({
        value,
        label,
      })),
    [dict.options.matchmakerGender]
  );

  const initializeFormData = useCallback((profileData: UserProfile | null) => {
    let headline = profileData?.profileHeadline || '';
    if (typeof headline === 'object' && headline !== null) {
      headline = '';
    }

    const dataToSet: Partial<UserProfile> = {
      gender: profileData?.gender || undefined,
      birthDate: ensureDateObject(profileData?.birthDate),
      nativeLanguage: profileData?.nativeLanguage || undefined,
      additionalLanguages: profileData?.additionalLanguages || [],
      height: profileData?.height ?? undefined,
      maritalStatus: profileData?.maritalStatus || undefined,
      occupation: profileData?.occupation || '',
      education: profileData?.education || '',
      educationLevel: profileData?.educationLevel || undefined,
      city: profileData?.city || '',
      origin: profileData?.origin || '',
      religiousJourney: profileData?.religiousJourney || undefined,
      religiousLevel: profileData?.religiousLevel || undefined,
      about: profileData?.about || '',
      parentStatus: profileData?.parentStatus || undefined,
      fatherOccupation: profileData?.fatherOccupation || '',
      motherOccupation: profileData?.motherOccupation || '',
      siblings: profileData?.siblings ?? undefined,
      position: profileData?.position ?? undefined,
      isProfileVisible: profileData?.isProfileVisible ?? true,
      preferredMatchmakerGender:
        profileData?.preferredMatchmakerGender || undefined,
      availabilityStatus:
        profileData?.availabilityStatus || AvailabilityStatus.AVAILABLE,
      availabilityNote: profileData?.availabilityNote || '',
      availabilityUpdatedAt: ensureDateObject(
        profileData?.availabilityUpdatedAt
      ),
      matchingNotes: profileData?.matchingNotes || '',
      shomerNegiah: profileData?.shomerNegiah ?? undefined,
      serviceType: profileData?.serviceType || undefined,
      serviceDetails: profileData?.serviceDetails || '',
      headCovering: profileData?.headCovering || undefined,
      kippahType: profileData?.kippahType || undefined,
      hasChildrenFromPrevious:
        profileData?.hasChildrenFromPrevious ?? undefined,
      profileCharacterTraits: profileData?.profileCharacterTraits || [],
      profileHobbies: profileData?.profileHobbies || [],
      aliyaCountry: profileData?.aliyaCountry || '',
      aliyaYear: profileData?.aliyaYear ?? undefined,
      id: profileData?.id,
      userId: profileData?.userId,
      createdAt: ensureDateObject(profileData?.createdAt),
      updatedAt: ensureDateObject(profileData?.updatedAt),
      lastActive: ensureDateObject(profileData?.lastActive),
      hasMedicalInfo: profileData?.hasMedicalInfo ?? false,
      medicalInfoDetails: profileData?.medicalInfoDetails || '',
      medicalInfoDisclosureTiming:
        profileData?.medicalInfoDisclosureTiming || undefined,
      isMedicalInfoVisible: profileData?.isMedicalInfoVisible ?? false,
      profileHeadline: headline,
      inspiringCoupleStory: profileData?.inspiringCoupleStory || '',
      influentialRabbi: profileData?.influentialRabbi || '',
      isAboutVisible: profileData?.isAboutVisible ?? true,
      isFriendsSectionVisible: profileData?.isFriendsSectionVisible ?? true,
      isNeshamaTechSummaryVisible:
        profileData?.isNeshamaTechSummaryVisible ?? true,
    };
    setFormData(dataToSet);
    setInitialData(dataToSet);

    setCityInputValue(dataToSet.city || '');
    setAliyaCountryInputValue(dataToSet.aliyaCountry || '');
  }, []);

  useEffect(() => {
    setLoading(true);
    if (profileProp) {
      initializeFormData(profileProp);
      setLoading(false);
    }
  }, [profileProp, initializeFormData]);

  const handleChange = (
    field: keyof UserProfile,
    value:
      | UserProfile[keyof UserProfile]
      | string
      | number
      | boolean
      | Date
      | string[]
      | null
  ) => {
    setFormData((prev) => {
      let finalValue: UserProfile[keyof UserProfile] | undefined = undefined;

      if (['height', 'siblings', 'position', 'aliyaYear'].includes(field)) {
        const rawValue = value as string | number;
        if (rawValue === '' || rawValue === null || rawValue === undefined) {
          finalValue = undefined;
        } else {
          const parsed = parseInt(String(rawValue), 10);
          finalValue = !isNaN(parsed)
            ? (parsed as UserProfile[typeof field])
            : undefined;
        }
      } else if (field === 'birthDate') {
        finalValue = ensureDateObject(
          value as string | Date | null | undefined
        ) as UserProfile[typeof field];
      } else {
        finalValue = (
          value === '' || value === null ? undefined : value
        ) as UserProfile[typeof field];
      }

      return {
        ...prev,
        [field]: finalValue,
      };
    });
  };

  const handleMultiSelectToggle = (
    field: keyof UserProfile,
    optionValue: string
  ) => {
    setFormData((prev) => {
      const currentValues = (prev[field] as string[]) || [];
      const newValues = currentValues.includes(optionValue)
        ? currentValues.filter((v) => v !== optionValue)
        : [...currentValues, optionValue];
      return { ...prev, [field]: newValues };
    });
  };

  const handleSave = () => {
    if (formData.about && formData.about.trim().length < 100) {
      toast.error(dict.toasts.validationErrorTitle, {
        description: dict.toasts.aboutMinLength.replace('{{count}}', '100'),
        duration: 5000,
      });
      return;
    }

    const dataToSave = { ...formData };
    onSave(dataToSave);
    setIsEditing(false);
    setInitialData(dataToSave);
  };

  const handleCancel = () => {
    setFormData(initialData);
    setCityInputValue(initialData.city || '');
    setAliyaCountryInputValue(initialData.aliyaCountry || '');
    setIsEditing(false);
  };

  if (loading) {
    return (
      <div role="status" aria-live="polite" className="text-center p-4">
        {dict.loading}
      </div>
    );
  }

  const renderMultiSelectBadges = (
    fieldValues: string[] | undefined,
    options: { value: string; label: string; icon?: React.ElementType }[],
    emptyPlaceholder: string
  ) => {
    if (!fieldValues || fieldValues.length === 0) {
      return <p className="text-sm text-gray-500 italic">{emptyPlaceholder}</p>;
    }
    return fieldValues.map((value) => {
      const option = options.find((opt) => opt.value === value);
      return option ? (
        <Badge
          key={value}
          variant="secondary"
          className="me-1 mb-1 bg-sky-100 text-sky-700 text-xs px-2 py-0.5 rounded-full"
        >
          {option.icon && <option.icon className="w-3 h-3 me-1" />}
          {option.label}
        </Badge>
      ) : null;
    });
  };

  return (
    <div className="relative" dir={direction}>
      <div className="sticky top-0 z-10 bg-gradient-to-b from-white via-white/95 to-white/0 pt-4 pb-3 backdrop-blur-sm">
        <div className="container mx-auto max-w-screen-xl px-4">
          <div className="flex items-center justify-between">
            <div className="text-start">
              <h1 className="text-xl md:text-2xl font-bold text-slate-800">
                {dict.header.title}
              </h1>
              <p className="text-sm text-slate-500">
                {isEditing && !viewOnly
                  ? dict.header.subtitleEdit
                  : dict.header.subtitleView}
              </p>
            </div>
            {!viewOnly && (
              <div className="flex gap-2">
                {!isEditing ? (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setIsEditing(true)}
                    className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-cyan-400 text-cyan-700 hover:bg-cyan-50"
                  >
                    <Pencil className="w-3.5 h-3.5 ms-1.5" />
                    {dict.buttons.edit}
                  </Button>
                ) : (
                  <>
                    <div className="hidden sm:flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={handleCancel}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50"
                      >
                        <X className="w-3.5 h-3.5 ms-1.5" />
                        {dict.buttons.cancel}
                      </Button>
                      <Button
                        variant="default"
                        size="sm"
                        onClick={handleSave}
                        className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white"
                      >
                        <Save className="w-3.5 h-3.5 ms-1.5" />
                        {dict.buttons.save}
                      </Button>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      <div className="container mx-auto max-w-screen-xl py-6 px-4">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-6">
            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-cyan-50/40 to-pink-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <UserCircle className="w-5 h-5 text-cyan-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.personal.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                  <div>
                    <Label
                      htmlFor="gender"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.genderLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.gender || ''}
                        onValueChange={(value) =>
                          handleChange('gender', value as Gender)
                        }
                      >
                        <SelectTrigger
                          id="gender"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={dict.cards.personal.genderPlaceholder}
                          />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="MALE">
                            {dict.options.gender.MALE}
                          </SelectItem>
                          <SelectItem value="FEMALE">
                            {dict.options.gender.FEMALE}
                          </SelectItem>
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.gender
                            ? dict.options.gender[formData.gender]
                            : undefined,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="birthDate"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.birthDateLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="birthDate"
                        type="date"
                        value={
                          formData.birthDate instanceof Date &&
                          !isNaN(formData.birthDate.getTime())
                            ? formData.birthDate.toISOString().split('T')[0]
                            : ''
                        }
                        onChange={(e) =>
                          handleChange('birthDate', e.target.value || undefined)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        max={new Date().toISOString().split('T')[0]}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.birthDate, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="height"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.heightLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="height"
                        type="number"
                        value={formData.height ?? ''}
                        onChange={(e) => handleChange('height', e.target.value)}
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.personal.heightPlaceholder}
                        min="100"
                        max="250"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.height
                            ? `${formData.height} ${dict.cards.personal.heightUnit}`
                            : undefined,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="city-autocomplete"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.cityLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Autocomplete
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                        inputProps={{ id: 'city-autocomplete' }}
                        value={cityInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                          setCityInputValue(e.target.value);
                        }}
                        onPlaceSelected={(place) => {
                          const cityComponent = place.address_components?.find(
                            (component) => component.types.includes('locality')
                          );
                          const selectedCity =
                            cityComponent?.long_name ||
                            place.formatted_address ||
                            '';
                          handleChange('city', selectedCity);
                          setCityInputValue(selectedCity);
                        }}
                        onBlur={() => {
                          if (cityInputValue !== formData.city) {
                            setCityInputValue(formData.city || '');
                          }
                        }}
                        options={{
                          types: ['(cities)'],
                          componentRestrictions: { country: 'il' },
                        }}
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={dict.cards.personal.cityPlaceholder}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.city, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="origin"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.originLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="origin"
                        value={formData.origin || ''}
                        onChange={(e) => handleChange('origin', e.target.value)}
                        placeholder={dict.cards.personal.originPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.origin, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="aliyaCountry-autocomplete"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.aliyaCountryLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Autocomplete
                        apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
                        inputProps={{ id: 'aliyaCountry-autocomplete' }}
                        value={aliyaCountryInputValue}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                          setAliyaCountryInputValue(e.target.value);
                        }}
                        onPlaceSelected={(place) => {
                          const countryComponent =
                            place.address_components?.find((component) =>
                              component.types.includes('country')
                            );
                          const selectedCountry =
                            countryComponent?.long_name ||
                            place.formatted_address ||
                            '';
                          handleChange('aliyaCountry', selectedCountry);
                          setAliyaCountryInputValue(selectedCountry);
                        }}
                        onBlur={() => {
                          if (
                            aliyaCountryInputValue !== formData.aliyaCountry
                          ) {
                            setAliyaCountryInputValue(
                              formData.aliyaCountry || ''
                            );
                          }
                        }}
                        options={{
                          types: ['country'],
                        }}
                        className="w-full h-9 text-sm p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                        placeholder={
                          dict.cards.personal.aliyaCountryPlaceholder
                        }
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.aliyaCountry,
                          dict,
                          dict.placeholders.notRelevant
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="aliyaYear"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.aliyaYearLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="aliyaYear"
                        type="number"
                        value={formData.aliyaYear ?? ''}
                        onChange={(e) =>
                          handleChange('aliyaYear', e.target.value)
                        }
                        disabled={!formData.aliyaCountry}
                        placeholder={dict.cards.personal.aliyaYearPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                        min="1900"
                        max={new Date().getFullYear()}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(
                          formData.aliyaYear,
                          dict,
                          formData.aliyaCountry
                            ? dict.placeholders.noYear
                            : dict.placeholders.notRelevant
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="nativeLanguage"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.nativeLanguageLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.nativeLanguage || ''}
                        onValueChange={(value) =>
                          handleChange('nativeLanguage', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="nativeLanguage"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.personal.nativeLanguagePlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {languageOptions.map((lang) => (
                            <SelectItem key={lang.value} value={lang.value}>
                              {lang.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.nativeLanguage,
                          languageOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div className="sm:col-span-2 lg:col-span-1">
                    <Label
                      htmlFor="additionalLanguages"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.personal.additionalLanguagesLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        onValueChange={(value) => {
                          const currentLanguages =
                            formData.additionalLanguages || [];
                          if (!currentLanguages.includes(value)) {
                            handleChange('additionalLanguages', [
                              ...currentLanguages,
                              value,
                            ]);
                          }
                        }}
                      >
                        <SelectTrigger
                          id="additionalLanguages"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.personal.additionalLanguagesPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[200px]">
                          {languageOptions
                            .filter(
                              (lang) =>
                                !(formData.additionalLanguages || []).includes(
                                  lang.value
                                ) && lang.value !== formData.nativeLanguage
                            )
                            .map((lang) => (
                              <SelectItem key={lang.value} value={lang.value}>
                                {lang.label}
                              </SelectItem>
                            ))}
                        </SelectContent>
                      </Select>
                    ) : null}
                    <div className="mt-2 flex flex-wrap gap-1.5">
                      {(formData.additionalLanguages || []).map((langValue) => {
                        const lang = languageOptions.find(
                          (l) => l.value === langValue
                        );
                        return lang ? (
                          <Badge
                            key={lang.value}
                            variant="secondary"
                            className="bg-cyan-100/70 text-cyan-800 px-2 py-0.5 rounded-full text-[11px] font-medium flex items-center"
                          >
                            {lang.label}
                            {isEditing && !viewOnly && (
                              <button
                                type="button"
                                onClick={() =>
                                  handleChange(
                                    'additionalLanguages',
                                    (formData.additionalLanguages || []).filter(
                                      (l) => l !== langValue
                                    )
                                  )
                                }
                                className="ms-1.5 text-cyan-600 hover:text-cyan-800 text-xs"
                                aria-label={dict.cards.personal.removeLanguageLabel.replace(
                                  '{{lang}}',
                                  lang.label
                                )}
                              >
                                ×
                              </button>
                            )}
                          </Badge>
                        ) : null;
                      })}
                      {(!isEditing || viewOnly) &&
                        (!formData.additionalLanguages ||
                          formData.additionalLanguages.length === 0) && (
                          <p className="text-sm text-gray-500 italic">
                            {dict.cards.personal.noAdditionalLanguages}
                          </p>
                        )}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-purple-50/40 to-indigo-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Users className="w-5 h-5 text-purple-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.family.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-5 items-start">
                  <div>
                    <Label
                      htmlFor="maritalStatus"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.maritalStatusLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.maritalStatus || ''}
                        onValueChange={(value) =>
                          handleChange('maritalStatus', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="maritalStatus"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.family.maritalStatusPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {maritalStatusOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.maritalStatus,
                          maritalStatusOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  {(formData.maritalStatus === 'divorced' ||
                    formData.maritalStatus === 'widowed' ||
                    formData.maritalStatus === 'annulled') && (
                    <div
                      className={cn(
                        'pt-1 sm:pt-0',
                        isEditing && !viewOnly ? 'sm:pt-5' : 'sm:pt-0'
                      )}
                    >
                      <Label
                        htmlFor="hasChildrenFromPrevious"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.family.hasChildrenLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <div className="flex items-center space-x-2 rtl:space-x-reverse mt-2">
                          <Checkbox
                            id="hasChildrenFromPrevious"
                            checked={formData.hasChildrenFromPrevious || false}
                            onCheckedChange={(checked) =>
                              handleChange(
                                'hasChildrenFromPrevious',
                                checked as boolean
                              )
                            }
                          />
                          <Label
                            htmlFor="hasChildrenFromPrevious"
                            className="text-sm font-normal text-gray-700"
                          >
                            {dict.cards.family.hasChildrenYes}
                          </Label>
                        </div>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderBooleanDisplayValue(
                            formData.hasChildrenFromPrevious,
                            dict
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  <div>
                    <Label
                      htmlFor="parentStatus"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.parentStatusLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="parentStatus"
                        value={formData.parentStatus || ''}
                        onChange={(e) =>
                          handleChange('parentStatus', e.target.value)
                        }
                        placeholder={dict.cards.family.parentStatusPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.parentStatus, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="fatherOccupation"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.fatherOccupationLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="fatherOccupation"
                        value={formData.fatherOccupation || ''}
                        onChange={(e) =>
                          handleChange('fatherOccupation', e.target.value)
                        }
                        placeholder={
                          dict.cards.family.fatherOccupationPlaceholder
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.fatherOccupation, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="motherOccupation"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.motherOccupationLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="motherOccupation"
                        value={formData.motherOccupation || ''}
                        onChange={(e) =>
                          handleChange('motherOccupation', e.target.value)
                        }
                        placeholder={
                          dict.cards.family.motherOccupationPlaceholder
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.motherOccupation, dict)}
                      </p>
                    )}
                  </div>

                  <div>
                    <Label
                      htmlFor="siblings"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.siblingsLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="siblings"
                        type="number"
                        value={formData.siblings ?? ''}
                        onChange={(e) =>
                          handleChange('siblings', e.target.value)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.family.siblingsPlaceholder}
                        min="0"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.siblings, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="position"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.family.positionLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="position"
                        type="number"
                        value={formData.position ?? ''}
                        onChange={(e) =>
                          handleChange('position', e.target.value)
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                        placeholder={dict.cards.family.positionPlaceholder}
                        min="0"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.position, dict)}
                      </p>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-yellow-50/40 to-amber-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <BookOpen className="w-5 h-5 text-amber-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.religion.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-5 items-start">
                  <div>
                    <Label
                      htmlFor="religiousLevel"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.religiousLevelLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.religiousLevel || ''}
                        onValueChange={(value) =>
                          handleChange('religiousLevel', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="religiousLevel"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.religiousLevelPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[250px]">
                          {religiousLevelOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.religiousLevel,
                          religiousLevelOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="religiousJourney"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.religiousJourneyLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.religiousJourney || ''}
                        onValueChange={(value) =>
                          handleChange(
                            'religiousJourney',
                            (value as ReligiousJourney) || undefined
                          )
                        }
                      >
                        <SelectTrigger
                          id="religiousJourney"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.religiousJourneyPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[250px]">
                          {religiousJourneyOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.religiousJourney,
                          religiousJourneyOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div
                    className={cn(
                      'pt-1 sm:pt-0',
                      isEditing && !viewOnly ? 'sm:pt-5' : 'sm:pt-0'
                    )}
                  >
                    <Label className="block mb-1.5 text-xs font-medium text-gray-600">
                      {dict.cards.religion.shomerNegiahLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <div className="flex items-center space-x-2 rtl:space-x-reverse mt-2">
                        <Checkbox
                          id="shomerNegiah"
                          checked={formData.shomerNegiah || false}
                          onCheckedChange={(checked) =>
                            handleChange('shomerNegiah', checked as boolean)
                          }
                        />
                        <Label
                          htmlFor="shomerNegiah"
                          className="text-sm font-normal text-gray-700"
                        >
                          {dict.cards.religion.shomerNegiahYes}
                        </Label>
                      </div>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderBooleanDisplayValue(
                          formData.shomerNegiah,
                          dict,
                          dict.cards.religion.shomerNegiahYes
                        )}
                      </p>
                    )}
                  </div>
                  {formData.gender === Gender.FEMALE && (
                    <div>
                      <Label
                        htmlFor="headCovering"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.religion.headCoveringLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <Select
                          dir={direction}
                          value={formData.headCovering || ''}
                          onValueChange={(value) =>
                            handleChange(
                              'headCovering',
                              (value as HeadCoveringType) || undefined
                            )
                          }
                        >
                          <SelectTrigger
                            id="headCovering"
                            className="h-9 text-sm focus:ring-cyan-500 text-start"
                          >
                            <SelectValue
                              placeholder={
                                dict.cards.religion.headCoveringPlaceholder
                              }
                            />
                          </SelectTrigger>
                          <SelectContent>
                            {headCoveringOptions.map((opt) => (
                              <SelectItem key={opt.value} value={opt.value}>
                                {opt.label}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderSelectDisplayValue(
                            formData.headCovering,
                            headCoveringOptions,
                            dict,
                            dict.cards.religion.headCoveringDefault
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  {formData.gender === Gender.MALE && (
                    <div>
                      <Label
                        htmlFor="kippahType"
                        className="block mb-1.5 text-xs font-medium text-gray-600"
                      >
                        {dict.cards.religion.kippahTypeLabel}
                      </Label>
                      {isEditing && !viewOnly ? (
                        <Select
                          dir={direction}
                          value={formData.kippahType || ''}
                          onValueChange={(value) =>
                            handleChange(
                              'kippahType',
                              (value as KippahType) || undefined
                            )
                          }
                        >
                          <SelectTrigger
                            id="kippahType"
                            className="h-9 text-sm focus:ring-cyan-500 text-start"
                          >
                            <SelectValue
                              placeholder={
                                dict.cards.religion.kippahTypePlaceholder
                              }
                            />
                          </SelectTrigger>
                          <SelectContent className="max-h-[200px]">
                            {kippahTypeOptions.map((opt) => (
                              <SelectItem key={opt.value} value={opt.value}>
                                {opt.label}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      ) : (
                        <p className="text-sm text-gray-800 font-medium mt-1">
                          {renderSelectDisplayValue(
                            formData.kippahType,
                            kippahTypeOptions,
                            dict,
                            dict.cards.religion.kippahTypeDefault
                          )}
                        </p>
                      )}
                    </div>
                  )}
                  <div>
                    <Label
                      htmlFor="preferredMatchmakerGender"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.religion.matchmakerGenderLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.preferredMatchmakerGender || ''}
                        onValueChange={(value) =>
                          handleChange(
                            'preferredMatchmakerGender',
                            (value as Gender) || undefined
                          )
                        }
                      >
                        <SelectTrigger
                          id="preferredMatchmakerGender"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.religion.matchmakerGenderPlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {preferredMatchmakerGenderOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.preferredMatchmakerGender,
                          preferredMatchmakerGenderOptions,
                          dict,
                          dict.cards.religion.matchmakerGenderDefault
                        )}
                      </p>
                    )}
                  </div>
                </div>

                <div className="mt-6 pt-6 border-t border-gray-200/70">
                  <div className="flex items-center gap-1.5 mb-2">
                    <Label
                      htmlFor="influentialRabbi"
                      className="text-sm font-medium text-gray-700"
                    >
                      {dict.cards.religion.influentialRabbiLabel}
                    </Label>
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <button
                            type="button"
                            aria-describedby="rabbi-tooltip"
                          >
                            <Info className="w-4 h-4 text-gray-400" />
                          </button>
                        </TooltipTrigger>
                        <TooltipContent
                          id="rabbi-tooltip"
                          side="top"
                          className="max-w-xs text-center"
                          dir={direction}
                          sideOffset={5}
                          collisionPadding={10}
                        >
                          {/* UPDATED: Use placeholder text */}
                          <p>{dict.cards.religion.influentialRabbiPlaceholder}</p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </div>
                  {isEditing && !viewOnly ? (
                    <Textarea
                      id="influentialRabbi"
                      value={formData.influentialRabbi || ''}
                      onChange={(e) =>
                        handleChange('influentialRabbi', e.target.value)
                      }
                      className="text-sm focus:ring-cyan-500 min-h-[90px] rounded-lg"
                      placeholder={
                        dict.cards.religion.influentialRabbiPlaceholder
                      }
                      rows={3}
                    />
                  ) : (
                    <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[50px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                      {renderDisplayValue(
                        formData.influentialRabbi,
                        dict,
                        dict.cards.religion.influentialRabbiEmpty
                      )}
                    </p>
                  )}
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-red-50/40 to-pink-50/40 border-b border-gray-200/50 p-4">
                <div className="flex items-center space-x-2 rtl:space-x-reverse">
                  <HeartPulse className="w-5 h-5 text-red-700" />
                  <CardTitle className="text-base font-semibold text-gray-700">
                    {dict.cards.medical.title}
                  </CardTitle>
                  <TooltipProvider delayDuration={100}>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <button
                          type="button"
                          aria-describedby="medical-tooltip"
                        >
                          <Lock className="w-4 h-4 text-gray-400" />
                        </button>
                      </TooltipTrigger>
                      <TooltipContent
                        id="medical-tooltip"
                        dir={direction}
                        sideOffset={5}
                        collisionPadding={10}
                      >
                        <p>{dict.cards.medical.tooltip}</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </div>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-4">
                <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200/80">
                  {dict.cards.medical.description}
                </div>

                {isEditing && !viewOnly ? (
                  <div className="space-y-4">
                    <div className="flex items-center space-x-2 rtl:space-x-reverse">
                      <Checkbox
                        id="hasMedicalInfo"
                        checked={formData.hasMedicalInfo || false}
                        onCheckedChange={(checked) =>
                          handleChange('hasMedicalInfo', checked as boolean)
                        }
                      />
                      <Label
                        htmlFor="hasMedicalInfo"
                        className="text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        {dict.cards.medical.hasInfoLabel}
                      </Label>
                    </div>

                    {formData.hasMedicalInfo && (
                      <div className="space-y-4 border-t pt-4 animate-in fade-in-50">
                        <div>
                          <Label
                            htmlFor="medicalInfoDetails"
                            className="block mb-1.5 text-xs font-medium text-gray-600"
                          >
                            {dict.cards.medical.detailsLabel}
                          </Label>
                          <Textarea
                            id="medicalInfoDetails"
                            value={formData.medicalInfoDetails || ''}
                            onChange={(e) =>
                              handleChange('medicalInfoDetails', e.target.value)
                            }
                            className="text-sm focus:ring-cyan-500 min-h-[100px] rounded-lg"
                            placeholder={dict.cards.medical.detailsPlaceholder}
                          />
                        </div>
                        <div>
                          <Label
                            htmlFor="medicalInfoDisclosureTiming"
                            className="block mb-1.5 text-xs font-medium text-gray-600"
                          >
                            {dict.cards.medical.timingLabel}
                          </Label>
                          <Select
                            dir={direction}
                            value={formData.medicalInfoDisclosureTiming || ''}
                            onValueChange={(value) =>
                              handleChange(
                                'medicalInfoDisclosureTiming',
                                value || undefined
                              )
                            }
                          >
                            <SelectTrigger
                              id="medicalInfoDisclosureTiming"
                              className="h-9 text-sm focus:ring-cyan-500 text-start"
                            >
                              <SelectValue
                                placeholder={
                                  dict.cards.medical.timingPlaceholder
                                }
                              />
                            </SelectTrigger>
                            <SelectContent>
                              {Object.entries(dict.options.medicalTiming).map(
                                ([value, label]) => (
                                  <SelectItem key={value} value={value}>
                                    {label}
                                  </SelectItem>
                                )
                              )}
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="border-t pt-4">
                          <Label className="block mb-2 text-xs font-medium text-gray-600">
                            {dict.cards.medical.visibilityLabel}
                          </Label>
                          <div className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
                            <Switch
                              id="isMedicalInfoVisible"
                              checked={!!formData.isMedicalInfoVisible}
                              onCheckedChange={(checked) =>
                                handleChange('isMedicalInfoVisible', checked)
                              }
                              className="data-[state=checked]:bg-green-500"
                            />
                            <div className="flex flex-col">
                              <Label
                                htmlFor="isMedicalInfoVisible"
                                className="text-sm font-medium text-gray-800 cursor-pointer"
                              >
                                {formData.isMedicalInfoVisible
                                  ? dict.cards.medical.visibilityToggle.visible
                                  : dict.cards.medical.visibilityToggle.hidden}
                              </Label>
                              <p className="text-xs text-gray-500">
                                {formData.isMedicalInfoVisible
                                  ? dict.cards.medical.visibilityDescription
                                      .visible
                                  : dict.cards.medical.visibilityDescription
                                      .hidden}
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div>
                      <p className="block text-xs font-medium text-gray-500">
                        {dict.cards.medical.display.sharedInfo}
                      </p>
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderBooleanDisplayValue(
                          formData.hasMedicalInfo,
                          dict,
                          dict.cards.medical.display.yes,
                          dict.cards.medical.display.no
                        )}
                      </p>
                    </div>
                    {formData.hasMedicalInfo && (
                      <>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.details}
                          </p>
                          <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap min-h-[40px] bg-slate-50/70 p-3 rounded-lg border border-slate-200/50">
                            {formData.medicalInfoDetails || (
                              <span className="text-gray-500 italic">
                                {dict.cards.medical.display.noDetails}
                              </span>
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.timing}
                          </p>
                          <p className="text-sm text-gray-800 font-medium mt-1">
                            {renderSelectDisplayValue(
                              formData.medicalInfoDisclosureTiming,
                              Object.entries(dict.options.medicalTiming).map(
                                ([value, label]) => ({ value, label })
                              ),
                              dict
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="block text-xs font-medium text-gray-500">
                            {dict.cards.medical.display.visibility}
                          </p>
                          <div className="flex items-center gap-2 mt-1">
                            {formData.isMedicalInfoVisible ? (
                              <Badge
                                variant="secondary"
                                className="bg-green-100 text-green-800"
                              >
                                <Eye className="w-3.5 h-3.5 ms-1.5" />
                                {dict.cards.medical.display.visibleBadge}
                              </Badge>
                            ) : (
                              <Badge
                                variant="secondary"
                                className="bg-gray-100 text-gray-700"
                              >
                                <Lock className="w-3.5 h-3.5 ms-1.5" />
                                {dict.cards.medical.display.hiddenBadge}
                              </Badge>
                            )}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                )}
              </CardContent>
            </Card>
            <FriendTestimonialsManager
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />
          </div>

          <div className="space-y-6">
            <StoryAndMoreCard
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-teal-50/40 to-green-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Briefcase className="w-5 h-5 text-teal-700" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.education.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
                  <div>
                    <Label
                      htmlFor="educationLevel"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.education.levelLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.educationLevel || ''}
                        onValueChange={(value) =>
                          handleChange('educationLevel', value || undefined)
                        }
                      >
                        <SelectTrigger
                          id="educationLevel"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={dict.cards.education.levelPlaceholder}
                          />
                        </SelectTrigger>
                        <SelectContent>
                          {educationLevelOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.educationLevel,
                          educationLevelOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div className="sm:col-span-2">
                    <Label
                      htmlFor="education"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.education.detailsLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="education"
                        value={formData.education || ''}
                        onChange={(e) =>
                          handleChange('education', e.target.value)
                        }
                        placeholder={dict.cards.education.detailsPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.education, dict)}
                      </p>
                    )}
                  </div>
                  <div className="sm:col-span-2">
                    <Label
                      htmlFor="occupation"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.education.occupationLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="occupation"
                        value={formData.occupation || ''}
                        onChange={(e) =>
                          handleChange('occupation', e.target.value)
                        }
                        placeholder={dict.cards.education.occupationPlaceholder}
                        className="h-9 text-sm focus:ring-cyan-500"
                        maxLength={20}
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.occupation, dict)}
                      </p>
                    )}
                  </div>
                  <div>
                    <Label
                      htmlFor="serviceType"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.education.serviceTypeLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Select
                        dir={direction}
                        value={formData.serviceType || ''}
                        onValueChange={(value) =>
                          handleChange(
                            'serviceType',
                            (value as ServiceType) || undefined
                          )
                        }
                      >
                        <SelectTrigger
                          id="serviceType"
                          className="h-9 text-sm focus:ring-cyan-500 text-start"
                        >
                          <SelectValue
                            placeholder={
                              dict.cards.education.serviceTypePlaceholder
                            }
                          />
                        </SelectTrigger>
                        <SelectContent className="max-h-[250px]">
                          {serviceTypeOptions.map((opt) => (
                            <SelectItem key={opt.value} value={opt.value}>
                              {opt.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderSelectDisplayValue(
                          formData.serviceType,
                          serviceTypeOptions,
                          dict
                        )}
                      </p>
                    )}
                  </div>
                  <div className="sm:col-span-2">
                    <Label
                      htmlFor="serviceDetails"
                      className="block mb-1.5 text-xs font-medium text-gray-600"
                    >
                      {dict.cards.education.serviceDetailsLabel}
                    </Label>
                    {isEditing && !viewOnly ? (
                      <Input
                        id="serviceDetails"
                        value={formData.serviceDetails || ''}
                        onChange={(e) =>
                          handleChange('serviceDetails', e.target.value)
                        }
                        placeholder={
                          dict.cards.education.serviceDetailsPlaceholder
                        }
                        className="h-9 text-sm focus:ring-cyan-500"
                      />
                    ) : (
                      <p className="text-sm text-gray-800 font-medium mt-1">
                        {renderDisplayValue(formData.serviceDetails, dict)}
                      </p>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/40 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-amber-50/40 to-yellow-50/40 border-b border-gray-200/50 p-4 flex items-center space-x-2 rtl:space-x-reverse">
                <Smile className="w-5 h-5 text-amber-600" />
                <CardTitle className="text-base font-semibold text-gray-700">
                  {dict.cards.character.title}
                </CardTitle>
              </CardHeader>
              <CardContent className="p-4 md:p-6 space-y-6">
                <fieldset>
                  <legend className="block mb-2 text-sm font-medium text-gray-700">
                    {dict.cards.character.traitsLabel}
                  </legend>
                  {isEditing && !viewOnly ? (
                    <div className="flex flex-wrap gap-2">
                      {characterTraitsOptions.map((trait) => (
                        <Button
                          key={trait.value}
                          type="button"
                          variant={
                            (formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectToggle(
                              'profileCharacterTraits',
                              trait.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.profileCharacterTraits || []).length >=
                              3 &&
                            !(formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.profileCharacterTraits || []).includes(
                              trait.value
                            )
                              ? 'bg-amber-500 hover:bg-amber-600 text-white border-amber-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {trait.icon && (
                            <trait.icon className="w-3.5 h-3.5 ms-1.5" />
                          )}
                          {trait.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.profileCharacterTraits,
                        characterTraitsOptions,
                        dict.cards.character.traitsEmpty
                      )}
                    </div>
                  )}
                </fieldset>
                <fieldset>
                  <legend className="block mb-2 text-sm font-medium text-gray-700">
                    {dict.cards.character.hobbiesLabel}
                  </legend>
                  {isEditing && !viewOnly ? (
                    <div className="flex flex-wrap gap-2">
                      {hobbiesOptions.map((hobby) => (
                        <Button
                          key={hobby.value}
                          type="button"
                          variant={
                            (formData.profileHobbies || []).includes(
                              hobby.value
                            )
                              ? 'default'
                              : 'outline'
                          }
                          size="sm"
                          onClick={() =>
                            handleMultiSelectToggle(
                              'profileHobbies',
                              hobby.value
                            )
                          }
                          disabled={
                            !viewOnly &&
                            (formData.profileHobbies || []).length >= 3 &&
                            !(formData.profileHobbies || []).includes(
                              hobby.value
                            )
                          }
                          className={cn(
                            'rounded-full text-xs px-3 py-1.5 transition-all',
                            (formData.profileHobbies || []).includes(
                              hobby.value
                            )
                              ? 'bg-sky-500 hover:bg-sky-600 text-white border-sky-500'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400'
                          )}
                        >
                          {hobby.icon && (
                            <hobby.icon className="w-3.5 h-3.5 ms-1.5" />
                          )}
                          {hobby.label}
                        </Button>
                      ))}
                    </div>
                  ) : (
                    <div className="mt-1 flex flex-wrap gap-1.5">
                      {renderMultiSelectBadges(
                        formData.profileHobbies,
                        hobbiesOptions,
                        dict.cards.character.hobbiesEmpty
                      )}
                    </div>
                  )}
                </fieldset>
              </CardContent>
            </Card>
            <NeshamaTechSummaryCard
              profile={profileProp}
              isEditing={isEditing}
              dict={dict}
              handleChange={handleChange}
              formData={formData}
              direction={direction} // Pass direction
            />
          </div>
        </div>
      </div>

      {isEditing && !viewOnly && (
        <div className="sticky bottom-0 z-20 mt-4 border-t border-gray-200 bg-white/90 p-4 backdrop-blur-md shadow-[0_-4px_15px_-5px_rgba(0,0,0,0.15)] sm:hidden">
          <div className="flex items-center justify-center gap-3">
            <Button
              variant="outline"
              size="sm"
              onClick={handleCancel}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2"
            >
              <X className="w-4 h-4 ms-1.5" />
              {dict.buttons.cancel}
            </Button>
            <Button
              variant="default"
              size="sm"
              onClick={handleSave}
              className="rounded-full shadow-sm hover:shadow-md transition-all duration-300 bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2"
            >
              <Save className="w-4 h-4 ms-1.5" />
              {dict.buttons.saveChanges}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default ProfileSection;
--- End of Content for ProfileSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\QuestionnaireResponsesSection.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/profile/sections/QuestionnaireResponsesSection.tsx

import React, { useState, useMemo, useEffect } from 'react';
import { Progress } from '@/components/ui/progress';
import Link from 'next/link';
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  CardDescription,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
// Textarea is no longer needed for editing here, but might be used elsewhere.
// Keeping it for now, but it can be removed if not used in other contexts.
import { Textarea } from '@/components/ui/textarea';
import {
  Book,
  CheckCircle,
  Clock,
  Pencil,
  X,
  Save,
  Eye,
  EyeOff,
  Loader2,
  ArrowRight,
  ArrowLeft,
  Trash2,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { toast } from 'sonner';
import {
  Tooltip,
  TooltipProvider,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import BudgetDisplay from './BudgetDisplay';

import type {
  QuestionnaireResponse,
  FormattedAnswer,
  UpdateValue,
} from '@/types/next-auth';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { WORLDS_CONFIG } from '../constants';

const QUESTIONNAIRE_URL = '/questionnaire';

interface QuestionnaireResponsesSectionProps {
  questionnaire: QuestionnaireResponse | null;
  onUpdate?: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isEditable?: boolean;
  dict: ProfilePageDictionary;
  locale: string;
}

interface QuestionCardProps {
  question: string;
  answer: FormattedAnswer;
  isEditingGlobally: boolean;
  worldKey: string;
  onUpdate: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isFirstInList?: boolean;
  dict: ProfilePageDictionary;
  locale: string;
}

interface WorldSectionProps {
  worldKey: keyof typeof WORLDS_CONFIG;
  worldConfig: (typeof WORLDS_CONFIG)[keyof typeof WORLDS_CONFIG];
  answers: FormattedAnswer[];
  isEditingGlobally: boolean;
  onUpdate: (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => Promise<void>;
  isCompleted: boolean;
  className?: string;
  dict: ProfilePageDictionary;
  locale: string;
}

const QuestionCard: React.FC<QuestionCardProps> = ({
  question,
  answer,
  isEditingGlobally,
  worldKey,
  onUpdate,
  dict,
  locale,
}) => {
  // --- START: שינויים ---
  // הסרת מצבים הקשורים לעריכת טקסט מקומית
  // const [isEditingText, setIsEditingText] = useState(false);
  // const [editValue, setEditValue] = useState(answer.displayText);
  // const [isSavingText, setIsSavingText] = useState(false);
  const [isSavingVisibility, setIsSavingVisibility] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [currentIsVisible, setCurrentIsVisible] = useState(
    answer.isVisible ?? true
  );
  // --- END: שינויים ---

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const t = dict.questionnaireSection.questionCard;

  useEffect(() => {
    setCurrentIsVisible(answer.isVisible ?? true);
  }, [answer.isVisible]);

  // --- START: שינויים ---
  // עדכון המשתנה isSaving כדי שיכלול רק את המצבים הרלוונטיים
  const isSaving = isSavingVisibility || isDeleting;
  // --- END: שינויים ---

  // --- START: שינויים ---
  // הסרת פונקציות הקשורות לעריכת טקסט מקומית
  /*
  const handleStartEdit = () => {
    if (isSaving) return;
    setIsEditingText(true);
    setEditValue(answer.displayText);
  };

  const handleSaveText = async () => {
    if (!editValue?.trim()) {
      toast.error(t.toasts.emptyAnswer);
      return;
    }
    if (editValue.trim() === answer.displayText) {
      setIsEditingText(false);
      return;
    }

    setIsSavingText(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'answer',
        value: editValue.trim(),
      });
      toast.success(t.toasts.updateSuccess);
      setIsEditingText(false);
    } catch (error) {
      console.error('Error updating answer:', error);
      toast.error(t.toasts.updateError);
    } finally {
      setIsSavingText(false);
    }
  };

  const handleCancelEdit = () => {
    setIsEditingText(false);
    setEditValue(answer.displayText);
  };
  */
  // --- END: שינויים ---

  const handleVisibilityChange = async (newIsVisibleState: boolean) => {
    setCurrentIsVisible(newIsVisibleState);
    setIsSavingVisibility(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'visibility',
        isVisible: newIsVisibleState,
      });
      toast.success(t.toasts.visibilitySuccess);
    } catch (error) {
      console.error('Error updating visibility:', error);
      toast.error(t.toasts.visibilityError);
      setCurrentIsVisible(answer.isVisible ?? true);
    } finally {
      setIsSavingVisibility(false);
    }
  };

  const handleDelete = async () => {
    if (isSaving) return;

    const isConfirmed = window.confirm(t.deleteConfirm.message);
    if (!isConfirmed) {
      return;
    }

    setIsDeleting(true);
    try {
      await onUpdate(worldKey, answer.questionId, {
        type: 'delete',
      });
      toast.success(t.toasts.deleteSuccess);
    } catch (error) {
      console.error('Error deleting answer:', error);
      toast.error(t.toasts.deleteError);
    } finally {
      setIsDeleting(false);
    }
  };

  const renderAnswerContent = () => {
    // --- START: התיקון המרכזי ---
    if (
      answer.questionType === 'budgetAllocation' &&
      typeof answer.rawValue === 'object' &&
      answer.rawValue !== null &&
      !Array.isArray(answer.rawValue)
    ) {
      // השרת כבר הכין לנו את הטקסט המתורגם ב-displayText.
      // נשתמש בו ונוסיף את העיצוב הגרפי.
      const budgetData = answer.rawValue as Record<string, number>;

      // פיצול ה-displayText כדי לקבל את התוויות המתורגמות
      const displayItems = answer.displayText.split(' | ').map((item) => {
        const parts = item.split(': ');
        return { label: parts[0].trim(), value: parseInt(parts[1], 10) };
      });

      return (
        <div className="w-full space-y-3">
          {displayItems.map(({ label, value }) => (
            <div key={label}>
              <div className="flex justify-between items-center text-sm mb-1">
                <span className="text-gray-800 font-medium">{label}</span>
                <span className="text-gray-600 font-semibold">
                  {value}
                  {question.includes('%') ? '%' : ''}
                </span>
              </div>
              <Progress value={value} />
            </div>
          ))}
        </div>
      );
    }
    // --- END: התיקון המרכזי ---

    // הלוגיקה הקיימת לשאר סוגי השאלות נשארת זהה
    return (
      <p className="text-sm text-gray-800 break-words overflow-wrap-anywhere whitespace-pre-wrap">
        {answer.displayText}
      </p>
    );
  };
  const getVisibilityTooltip = () => {
    if (isEditingGlobally) {
      return currentIsVisible
        ? t.visibilityTooltip.editing.visible
        : t.visibilityTooltip.editing.hidden;
    }
    return currentIsVisible
      ? t.visibilityTooltip.viewing.visible
      : t.visibilityTooltip.viewing.hidden;
  };

  // --- START: שינויים ---
  // הגדרת ה-URL לעריכה שיהיה זהה לכל סוגי השאלות
  const editUrl = `/${locale}/questionnaire?world=${worldKey}&question=${answer.questionId}`;
  // בחירת טקסט גנרי עבור ה-Tooltip. אפשר להוסיף מפתח חדש ל-dictionary אם רוצים.
  const editTooltipText =
    answer.questionType === 'budgetAllocation'
      ? t.editTooltip.budget
      : t.editTooltip.text;
  // --- END: שינויים ---

  return (
    <div
      className="rounded-lg border bg-card p-4 shadow-sm transition-shadow duration-300 hover:shadow-md"
      dir={direction}
    >
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-2">
            <h4 className="font-medium text-sm sm:text-base flex-1 text-start">
              {question}
            </h4>
            <div className="flex items-center gap-2 self-end sm:self-center">
              {isDeleting && (
                <Loader2 className="h-4 w-4 animate-spin text-red-500" />
              )}
              {isSavingVisibility && (
                <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
              )}
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      role="switch"
                      aria-checked={currentIsVisible}
                      disabled={!isEditingGlobally || isSaving}
                      onClick={() => handleVisibilityChange(!currentIsVisible)}
                      className={cn(
                        'inline-flex items-center justify-center h-8 px-3 rounded-full gap-2 transition-all duration-200 ease-in-out',
                        'disabled:opacity-100 disabled:cursor-default',
                        currentIsVisible
                          ? 'bg-emerald-100 text-emerald-800'
                          : 'bg-gray-200 text-gray-600',
                        isEditingGlobally &&
                          !isSaving &&
                          'hover:shadow-md active:scale-95',
                        isEditingGlobally &&
                          !isSaving &&
                          currentIsVisible &&
                          'hover:bg-emerald-200',
                        isEditingGlobally &&
                          !isSaving &&
                          !currentIsVisible &&
                          'hover:bg-gray-300'
                      )}
                    >
                      {currentIsVisible ? (
                        <Eye className="h-3.5 w-3.5" />
                      ) : (
                        <EyeOff className="h-3.5 w-3.5" />
                      )}
                      <span className="text-xs font-medium whitespace-nowrap">
                        {currentIsVisible
                          ? t.visibilityButton.visible
                          : t.visibilityButton.hidden}
                      </span>
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" dir={direction}>
                    <p>{getVisibilityTooltip()}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
          </div>
          {/* --- START: שינויים --- */}
          {/* הסרת ה-Conditional Rendering של עריכה מקומית */}
          <div className="relative group overflow-hidden mt-1">
            <div className="p-3 bg-gray-50/50 rounded-md border border-gray-200/60 min-h-[40px]">
              {renderAnswerContent()}
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <span className="text-xs text-gray-400 block mt-2 text-start">
                      {new Date(answer.answeredAt).toLocaleDateString(
                        locale === 'he' ? 'he-IL' : 'en-US',
                        { year: 'numeric', month: '2-digit', day: '2-digit' }
                      )}
                    </span>
                  </TooltipTrigger>
                  <TooltipContent side="top" dir={direction}>
                    <p>{t.dateTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>

            {isEditingGlobally && !isSaving && (
              // --- START: התיקון כאן ---
              <div className="absolute top-0 end-0 opacity-100 transition-opacity duration-200 flex items-center">
                <TooltipProvider delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-red-500 hover:bg-red-50"
                        onClick={handleDelete}
                        disabled={isSaving}
                      >
                        <Trash2 className="h-4 w-4" />
                        <span className="sr-only">{t.editTooltip.delete}</span>
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent side="top" dir={direction}>
                      <p>{t.editTooltip.delete}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>

                <TooltipProvider delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        asChild
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-cyan-600 hover:bg-cyan-50"
                      >
                        <a href={editUrl}>
                          <Pencil className="h-4 w-4" />
                          <span className="sr-only">{editTooltipText}</span>
                        </a>
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent side="top" dir={direction}>
                      <p>{editTooltipText}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
            )}
          </div>
          {/* --- END: שינויים --- */}
        </div>
      </div>
    </div>
  );
};

// ... (שאר הרכיבים WorldSection ו-QuestionnaireResponsesSection נשארים ללא שינוי)

const WorldSection: React.FC<WorldSectionProps> = ({
  worldKey,
  worldConfig,
  answers,
  isEditingGlobally,
  onUpdate,
  isCompleted,
  className,
  dict,
  locale,
}) => {
  const { icon: Icon, color, bgColor, borderColor } = worldConfig;
  const t = dict.questionnaireSection.worldSection;
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  const title = dict.questionnaireSection.worlds[worldKey]?.title || worldKey;
  const answerCountText = `${answers.length} ${
    answers.length === 1 ? t.answerSingular : t.answerPlural
  }`;

  return (
    <Card
      className={cn(
        'overflow-hidden shadow-sm border',
        bgColor,
        borderColor,
        className
      )}
      dir={direction}
    >
      <CardHeader
        className="p-4 border-b"
        style={{
          borderColor: `rgba(var(--${color.split('-')[1]}-200-rgb), 0.5)`,
        }}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div
              className={cn(
                'p-2 rounded-full',
                color.replace('text-', 'bg-') + '/10'
              )}
            >
              <Icon className={cn('h-5 w-5', color)} />
            </div>
            <div>
              <CardTitle className="text-md sm:text-lg text-gray-800">
                {title}
              </CardTitle>
              <CardDescription className="text-xs text-gray-500 mt-0.5">
                {answerCountText}
              </CardDescription>
            </div>
          </div>
          <Badge
            variant={isCompleted ? 'success' : 'secondary'}
            className={cn(
              'gap-1 text-xs px-2 py-0.5 rounded-full',
              isCompleted
                ? 'bg-emerald-100 text-emerald-800'
                : 'bg-blue-100 text-blue-800'
            )}
          >
            {isCompleted ? (
              <CheckCircle className="h-3 w-3" />
            ) : (
              <Clock className="h-3 w-3" />
            )}
            {isCompleted ? t.status.completed : t.status.inProgress}
          </Badge>
        </div>
      </CardHeader>
      <CardContent className="p-4 pt-4">
        <div className="space-y-4">
          {answers.map((answer, index) => (
            <QuestionCard
              key={answer.questionId}
              question={answer.question}
              answer={answer}
              isFirstInList={index === 0}
              isEditingGlobally={isEditingGlobally}
              worldKey={worldKey}
              onUpdate={onUpdate}
              dict={dict}
              locale={locale}
            />
          ))}
        </div>
      </CardContent>
    </Card>
  );
};

const QuestionnaireResponsesSection: React.FC<
  QuestionnaireResponsesSectionProps
> = ({ questionnaire, onUpdate, isEditable = false, dict, locale }) => {
  const [isEditingGlobally, setIsEditingGlobally] = useState(false);

  const direction = locale === 'he' ? 'rtl' : 'ltr';
  const ArrowIcon = direction === 'rtl' ? ArrowLeft : ArrowRight;
  const t = dict.questionnaireSection;

  const worldsWithAnswers = useMemo(() => {
    if (!questionnaire?.formattedAnswers) {
      console.log(
        '---[ CLIENT LOG | QuestionnaireResponsesSection useMemo ]--- אין "formattedAnswers". מחזיר מערך ריק.'
      );
      return [];
    }

    console.log(
      '---[ CLIENT LOG | QuestionnaireResponsesSection useMemo ]--- נמצא "formattedAnswers". מעבד את העולמות.'
    );

    return Object.entries(WORLDS_CONFIG)
      .map(([key, config]) => ({
        key: key as keyof typeof WORLDS_CONFIG,
        config,
        answers:
          questionnaire.formattedAnswers?.[
            key.toUpperCase() as keyof typeof questionnaire.formattedAnswers // ✨ התיקון: המרת המפתח לאותיות גדולות
          ] ?? [],
        isCompleted:
          (questionnaire[
            `${key.toLowerCase()}Completed` as keyof QuestionnaireResponse
          ] as boolean) ?? false,
      }))
      .filter((world) => world.answers.length > 0);
  }, [questionnaire]);

  if (!questionnaire) {
    const emptyStateT = t.emptyState;
    return (
      <Card
        className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border border-dashed"
        dir={direction}
      >
        <Book className="h-10 w-10 mx-auto mb-3 opacity-50 text-gray-400" />
        <p className="font-medium">{emptyStateT.title}</p>
        <p className="text-sm mt-1">{emptyStateT.subtitle}</p>
        <div className="mt-6">
          <Button
            asChild
            variant="default"
            className="bg-cyan-600 hover:bg-cyan-700"
          >
            <Link
              href={QUESTIONNAIRE_URL}
              className="flex items-center gap-1.5"
            >
              {emptyStateT.button} <ArrowIcon className="h-4 w-4" />
            </Link>
          </Button>
        </div>
      </Card>
    );
  }

  const hasAnyAnswers = worldsWithAnswers.length > 0;
  const headerT = t.header;

  return (
    <div className="space-y-6" dir={direction}>
      <Card className="shadow-sm border">
        <CardHeader className="p-6 space-y-4">
          {/* שורה ראשונה - כותרת ומידע */}
          <div className="flex items-center justify-center gap-3">
            {' '}
            {questionnaire.completed ? (
              <CheckCircle className="h-6 w-6 text-emerald-500 flex-shrink-0" />
            ) : (
              <Clock className="h-6 w-6 text-blue-500 flex-shrink-0" />
            )}
            <div>
              <h2 className="text-xl font-semibold text-gray-800">
                {questionnaire.completed
                  ? headerT.title.completed
                  : headerT.title.inProgress}
              </h2>
              <p className="text-sm text-gray-500 mt-1">
                {hasAnyAnswers
                  ? `${headerT.lastUpdated}: ${new Date(
                      questionnaire.lastSaved
                    ).toLocaleDateString(locale === 'he' ? 'he-IL' : 'en-US')}`
                  : headerT.notStarted}
              </p>
            </div>
          </div>

          {/* שורה שנייה - כפתורים */}
          <div className="flex items-center justify-center gap-3 pt-2 border-t border-gray-100">
            <Button asChild variant="outline" size="sm" className="h-9 px-4">
              <Link
                href={QUESTIONNAIRE_URL}
                className="flex items-center gap-2"
              >
                {headerT.goToButton}
                <ArrowIcon className="h-4 w-4" />
              </Link>
            </Button>

            {isEditable && hasAnyAnswers && onUpdate && (
              <Button
                variant={isEditingGlobally ? 'default' : 'outline'}
                size="sm"
                onClick={() => setIsEditingGlobally(!isEditingGlobally)}
                className="h-9 px-4 gap-2"
              >
                {isEditingGlobally ? (
                  <>
                    <Save className="h-4 w-4" />
                    {headerT.editButton.finish}
                  </>
                ) : (
                  <>
                    <Pencil className="h-4 w-4" />
                    {headerT.editButton.start}
                  </>
                )}
              </Button>
            )}
          </div>
        </CardHeader>
      </Card>
      {/* שאר הקוד נשאר זהה... */}
      {hasAnyAnswers ? (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {worldsWithAnswers.map(({ key, config, answers, isCompleted }) => (
            <WorldSection
              key={key}
              worldKey={key}
              worldConfig={config}
              answers={answers}
              isEditingGlobally={isEditingGlobally}
              onUpdate={onUpdate!}
              isCompleted={isCompleted}
              dict={dict}
              locale={locale}
            />
          ))}
        </div>
      ) : (
        <div className="text-center py-10 text-gray-500 bg-gray-50/50 rounded-lg border border-gray-200">
          <Book className="h-8 w-8 mx-auto mb-2 opacity-50 text-gray-400" />
          <p className="font-medium text-lg">{t.noAnswersState.title}</p>
          <p className="text-sm mt-1 text-gray-600">
            {t.noAnswersState.subtitle}
          </p>
          <div className="mt-6">
            <Button
              asChild
              variant="default"
              className="bg-cyan-600 hover:bg-cyan-700 text-white"
            >
              <Link
                href={QUESTIONNAIRE_URL}
                className="flex items-center gap-1.5 px-6 py-2"
              >
                {t.noAnswersState.button} <ArrowIcon className="h-4 w-4" />
              </Link>
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default QuestionnaireResponsesSection;
--- End of Content for QuestionnaireResponsesSection.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\UnifiedProfileDashboard.tsx
--------------------------------------------------------------------------------
Content:
// src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { useSession } from 'next-auth/react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import type { User as SessionUserType } from '@/types/next-auth';

// Child Components
import { ProfileChecklist } from './ProfileChecklist';
import { AIProfileAdvisorDialog } from './AIProfileAdvisorDialog';

// UI Components
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogTrigger } from '@/components/ui/dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area';

// Shared Profile Components
import {
  ProfileCard,
  PhotosSection,
  PreferencesSection,
  ProfileSection,
  QuestionnaireResponsesSection,
} from '@/components/profile';

// Icons
import { Eye, Loader2 } from 'lucide-react';

// Types
import type {
  UserProfile,
  UserImage,
  QuestionnaireResponse,
  UpdateValue, // <-- פתרון בעיית ה-any
} from '@/types/next-auth';
import type { ProfilePageDictionary } from '@/types/dictionary';

// Props interface for the component, now including the dictionary
interface UnifiedProfileDashboardProps {
  viewOnly?: boolean;
  userId?: string;
  initialTab?: string;
  dict: ProfilePageDictionary;
  locale: string; // Added locale prop
}

const UnifiedProfileDashboard: React.FC<UnifiedProfileDashboardProps> = ({
  viewOnly = false,
  userId,
  initialTab = 'overview',
  dict,
  locale, // Destructure locale
}) => {
  console.log(
    `---[ CLIENT LOG 3 | UnifiedProfileDashboard.tsx ]--- הרכיב נטען. הוא קיבל את ה-prop "initialTab" עם הערך: "${initialTab}".`
  );

  const {
    data: session,
    status: sessionStatus,
    update: updateSession,
  } = useSession();
  const router = useRouter();

  // State hooks
  const [profileData, setProfileData] = useState<UserProfile | null>(null);
  const [images, setImages] = useState<UserImage[]>([]);
  const [questionnaireResponse, setQuestionnaireResponse] =
    useState<QuestionnaireResponse | null>(null);
  const [activeTab, setActiveTab] = useState(initialTab);
  console.log(
    `---[ CLIENT LOG 4 | UnifiedProfileDashboard.tsx ]--- מאתחל את ה-state של "activeTab". הערך כעת הוא: "${activeTab}". ערך זה שולט על רכיב ה-Tabs.`
  );

  const [isEditing, setIsEditing] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState('');
  const [previewOpen, setPreviewOpen] = useState(false);
  const [hasSeenPreview, setHasSeenPreview] = useState(
    session?.user?.profile?.hasViewedProfilePreview || false
  );
  const direction = locale === 'he' ? 'rtl' : 'ltr'; // Define direction based on locale

  useEffect(() => {
    setActiveTab(initialTab);
  }, [initialTab]);

  // --- קוד מעודכן ---
  // src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

  const handleTabChange = (newTab: string) => {
    // --- לוג מקדים ---
    console.log(
      `---[ CLIENT LOG 5 | UnifiedProfileDashboard.tsx ]--- handleTabChange נקראה עם הטאב החדש: "${newTab}".`
    );

    console.log(
      `---[ CLIENT LOG 5 | UnifiedProfileDashboard.tsx ]--- handleTabChange נקראה עם הטאב החדש: "${newTab}".`
    );

    setActiveTab(newTab);
    // ✨ התיקון המרכזי: הוספת משתנה ה-locale לכתובת ה-URL
    router.push(`/${locale}/profile?tab=${newTab}`, { scroll: false });

    // הגדלנו מעט את ההשהיה כדי לתת ל-React יותר זמן לעבד את השינוי ב-DOM.
    setTimeout(() => {
      console.log(
        `---[ CLIENT LOG 6 | UnifiedProfileDashboard.tsx ]--- ה-setTimeout של הגלילה החל. מנסה לגלול לטאב: "${newTab}".`
      );

      const elementId = `${newTab}-content`;
      console.log(
        `---[ CLIENT LOG 7 | UnifiedProfileDashboard.tsx ]--- מחפש אלמנט עם ID דינמי: "${elementId}".`
      );

      const element = document.getElementById(elementId);

      // --- זהו הלוג הקריטי ביותר ---
      if (element) {
        console.log(
          `✅ ---[ CLIENT LOG 8 | UnifiedProfileDashboard.tsx ]--- הצלחה! האלמנט נמצא. גולל אליו.`,
          element
        );
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        console.error(
          `❌ ---[ CLIENT LOG 8 | UnifiedProfileDashboard.tsx ]--- כישלון! האלמנט עם ID "${elementId}" לא נמצא ב-DOM ברגע זה. הגלילה נכשלה.`
        );

        // ננסה לגלוש לאלמנט החלופי כדי לראות אם הוא קיים
        const fallbackElement = document.getElementById('profile-tabs-content');
        if (fallbackElement) {
          console.warn(
            `---[ CLIENT LOG 9 | UnifiedProfileDashboard.tsx ]--- נסוג לגלילה לאלמנט החלופי "profile-tabs-content".`
          );
          fallbackElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
          });
        } else {
          console.error(
            `❌ ---[ CLIENT LOG 9 | UnifiedProfileDashboard.tsx ]--- כישלון קריטי! גם אלמנט הגיבוי "profile-tabs-content" לא נמצא.`
          );
        }
      }
    }, 150); // הגדלתי מעט את הזמן ל-150ms
  };

  const isOwnProfile = !userId || session?.user?.id === userId;

  const loadData = useCallback(async () => {
    setIsLoading(true);
    setError('');
    try {
      // Fetch profile data
      const profileUrl = userId
        ? `/api/profile?userId=${userId}`
        : '/api/profile';
      const profileResponse = await fetch(profileUrl);
      const profileJson = await profileResponse.json();

      if (!profileResponse.ok || !profileJson.success) {
        throw new Error(profileJson.message || 'Failed to load profile');
      }
      console.log('---[ CLIENT LOG 1 ]--- Received Profile Data from API:');
      console.log(profileJson.profile);

      setProfileData(profileJson.profile);
      setImages(profileJson.images || []);
      if (profileJson.profile?.hasViewedProfilePreview) {
        setHasSeenPreview(true);
      }

      // Fetch questionnaire data
      const params = new URLSearchParams();
      if (userId) {
        params.append('userId', userId);
      }
      params.append('locale', locale); // ✨ הוספת פרמטר השפה

      const questionnaireUrl = `/api/profile/questionnaire?${params.toString()}`;

      const questionnaireFetchResponse = await fetch(questionnaireUrl);

      console.log(
        `---[ CLIENT LOG | Dashboard loadData ]--- סטטוס תגובה מ-API השאלון: ${questionnaireFetchResponse.status}`
      );

      if (questionnaireFetchResponse.status === 404) {
        setQuestionnaireResponse(null);
      } else if (questionnaireFetchResponse.ok) {
        const questionnaireJson = await questionnaireFetchResponse.json();
        console.log(
          '---[ DEBUG LOG | Questionnaire API Response ]---',
          questionnaireJson
        );

        console.log(
          '---[ CLIENT LOG | Dashboard loadData ]--- התקבל JSON מה-API:',
          questionnaireJson
        );

        if (questionnaireJson.success) {
          setQuestionnaireResponse(questionnaireJson.questionnaireResponse);
        } else {
          console.warn(
            'Could not load questionnaire. Reason:',
            questionnaireJson.message
          );
          setQuestionnaireResponse(null);
        }
      } else {
        console.error(
          'Failed to fetch questionnaire data. Status:',
          questionnaireFetchResponse.status
        );
        setQuestionnaireResponse(null);
      }
    } catch (err: unknown) {
      console.error('Failed to load profile data:', err);
      let errorMessage = 'An unexpected error occurred.';
      if (err instanceof Error) {
        errorMessage = err.message || errorMessage;
      }
      const translatedError = dict.dashboard.loadError.replace(
        '{{error}}',
        errorMessage
      );
      setError(translatedError);
      toast.error(translatedError);
    } finally {
      setIsLoading(false);
    }
  }, [userId, dict]);

  useEffect(() => {
    if (sessionStatus === 'authenticated') {
      loadData();
    }
  }, [sessionStatus, loadData]);

  useEffect(() => {
    const handleVisibilityChange = () => {
      if (
        document.visibilityState === 'visible' &&
        sessionStatus === 'authenticated'
      ) {
        loadData();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [loadData, sessionStatus]);

  const handlePreviewClick = async () => {
    setPreviewOpen(true);
    if (!hasSeenPreview) {
      try {
        const response = await fetch('/api/profile/viewed-preview', {
          method: 'POST',
        });
        if (!response.ok) {
          throw new Error('Failed to update preview status');
        }
        setHasSeenPreview(true);
        toast.success(dict.dashboard.viewedPreviewSuccess);
        await updateSession();
      } catch (error) {
        console.error('Error in handlePreviewClick:', error);
        toast.error(dict.dashboard.viewedPreviewError);
      }
    }
  };

  const handleSave = async (formData: Partial<UserProfile>) => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/profile/update', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const data = await response.json();
      if (data.success && data.profile) {
        await updateSession();
        setProfileData(data.profile);
        setIsEditing(false);
        toast.success(dict.dashboard.updateSuccess);
        setError('');
      } else {
        const errorMessage = data.message || 'Profile update error';
        const translatedError = dict.dashboard.updateError.replace(
          '{{error}}',
          errorMessage
        );
        setError(translatedError);
        toast.error(translatedError);
      }
    } catch (err) {
      console.error('Save error:', err);
      const errorMessage = 'Profile update error';
      const translatedError = dict.dashboard.updateError.replace(
        '{{error}}',
        errorMessage
      );
      setError(translatedError);
      toast.error(translatedError);
    } finally {
      setIsLoading(false);
    }
  };

  // --- השלמת הפונקציות החסרות עם תרגום ---

  const handleImageUpload = async (files: File[]) => {
    if (!files || files.length === 0) return;

    setIsLoading(true);
    const uploadedImages: UserImage[] = [];
    const failedUploads: string[] = [];
    const toastsDict = dict.photosSection.toasts;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const toastId = `upload-${i}`;
      const loadingMsg = dict.photosSection.uploadingMultiple.replace(
        '{{count}}',
        `${i + 1}/${files.length}`
      );

      try {
        toast.loading(loadingMsg, { id: toastId });

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/profile/images', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success && data.image) {
          uploadedImages.push(data.image);
          toast.success(
            `${file.name} uploaded successfully!`, // This specific string is often kept in English for file names
            { id: toastId }
          );
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (err) {
        const errorMessage =
          err instanceof Error ? err.message : toastsDict.uploadError;
        failedUploads.push(`${file.name}: ${errorMessage}`);
        toast.error(`${file.name}: ${errorMessage}`, { id: toastId });
      }
    }

    if (uploadedImages.length > 0) {
      setImages((prev) => [...prev, ...uploadedImages].slice(0, 10)); // Assuming max 10 images
      await updateSession();
      toast.success(
        toastsDict.uploadSuccess.replace(
          '{{count}}',
          String(uploadedImages.length)
        )
      );
      setError('');
    }

    if (failedUploads.length > 0 && uploadedImages.length === 0) {
      setError(toastsDict.uploadError);
      toast.error(toastsDict.uploadError);
    }

    setIsLoading(false);
  };

  const handleSetMainImage = async (imageId: string) => {
    setIsLoading(true);
    try {
      const response = await fetch(`/api/profile/images/${imageId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isMain: true }),
      });
      const data = await response.json();
      if (data.success) {
        setImages(data.images);
        await updateSession();
        toast.success(dict.photosSection.toasts.setMainSuccess);
        setError('');
      } else {
        const errorMsg = data.message || dict.photosSection.toasts.setMainError;
        setError(errorMsg);
        toast.error(errorMsg);
      }
    } catch (err) {
      const errorMsg = dict.photosSection.toasts.setMainError;
      setError(errorMsg);
      toast.error(errorMsg);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDeleteImage = async (imageIds: string[]) => {
    if (!imageIds || imageIds.length === 0) {
      toast.info(dict.photosSection.toasts.selectOneError);
      return;
    }
    setIsLoading(true);
    try {
      const response = await fetch(`/api/profile/images`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageIds }),
      });

      const data = await response.json();
      if (data.success) {
        setImages(data.images);
        await updateSession();
        const successMsg =
          imageIds.length > 1
            ? dict.photosSection.toasts.bulkDeleteSuccess.replace(
                '{{count}}',
                String(imageIds.length)
              )
            : dict.photosSection.toasts.singleDeleteSuccess;
        toast.success(successMsg);
        setError('');
      } else {
        const errorMsg =
          data.message || dict.photosSection.toasts.bulkDeleteError;
        setError(errorMsg);
        toast.error(errorMsg);
      }
    } catch (err) {
      console.error('Delete image error:', err);
      setError(dict.photosSection.toasts.bulkDeleteError);
      toast.error(dict.photosSection.toasts.bulkDeleteError);
    } finally {
      setIsLoading(false);
    }
  };

  // src/app/[locale]/(authenticated)/profile/components/dashboard/UnifiedProfileDashboard.tsx

  const handleQuestionnaireUpdate = async (
    world: string,
    questionId: string,
    value: UpdateValue
  ) => {
    // אין צורך ב-setIsLoading(true) כאן, כי loadData עושה זאת בעצמו.
    try {
      const payload = { worldKey: world, questionId: questionId, value };
      const response = await fetch('/api/profile/questionnaire', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (data.success) {
        toast.success(dict.dashboard.tabContent.questionnaireUpdateSuccess);
        setError('');

        // ✨ התיקון: במקום לעדכן עם תגובה חלקית מהשרת,
        // נטען מחדש את כל המידע כדי להבטיח סנכרון מלא.
        await loadData();
      } else {
        const errorMsg =
          data.message || dict.dashboard.tabContent.questionnaireUpdateError;
        setError(errorMsg);
        toast.error(errorMsg);
        // במקרה של שגיאה, נחזיר את המצב הטעינה לקדמותו
        setIsLoading(false);
      }
    } catch (err) {
      console.error('Failed to update questionnaire:', err);
      setError(dict.dashboard.tabContent.questionnaireUpdateError);
      toast.error(dict.dashboard.tabContent.questionnaireUpdateError);
      // גם במקרה של חריגה, נחזיר את המצב הטעינה לקדמותו
      setIsLoading(false);
    }
    // פונקציית loadData כבר משנה את isLoading ל-false בסופה,
    // כך שאין צורך בלוק 'finally'.
  };

  // --- סוף החלק שהושלם ---

  if (isLoading && !profileData) {
    return (
      <div
        role="status"
        aria-live="polite"
        className="flex items-center justify-center min-h-screen bg-gradient-to-br from-cyan-50 via-white to-pink-50"
        dir={direction} // Changed
      >
        <div className="flex items-center gap-2 text-lg text-cyan-600">
          <Loader2 className="animate-spin h-6 w-6" />
          <span>{dict.dashboard.loadingData}</span>
        </div>
      </div>
    );
  }

  if (error && !profileData) {
    return (
      <div
        className="flex items-center justify-center min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50 p-4"
        dir={direction} // Changed
      >
        <Alert variant="destructive" className="max-w-md mx-auto">
          <AlertDescription className="text-center">{error}</AlertDescription>
        </Alert>
      </div>
    );
  }

  const user = session?.user as SessionUserType | undefined;

  return (
    <div className="relative min-h-screen w-full" dir={direction}>
      <div
        className="absolute inset-0 bg-gradient-to-br from-cyan-50 via-white to-pink-50 animate-gradient-slow -z-10"
        style={{ backgroundSize: '400% 400%' }}
      />
      <div className="absolute inset-0 opacity-10 bg-[radial-gradient(#06b6d4_1px,transparent_1px)] [background-size:30px_30px] -z-10"></div>
      <div className="relative max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8 z-10">
        <div className="space-y-6 md:space-y-8">
          {error && (
            <Alert variant="destructive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {isOwnProfile && user && profileData && (
            <>
              <ProfileChecklist
                user={{
                  ...user,
                  profile: profileData,
                  images: images,
                }}
                hasSeenPreview={hasSeenPreview}
                onPreviewClick={handlePreviewClick}
                questionnaireResponse={questionnaireResponse}
                dict={dict.dashboard.checklist}
                locale={locale} // Added
                onNavigateToTab={handleTabChange} // <-- הוסף שורה זו
              />
              <div className="my-6 md:my-8 flex justify-center">
                <AIProfileAdvisorDialog
                  userId={user.id}
                  dict={dict.dashboard.aiAdvisor}
                  analysisDict={dict.dashboard.analysisResult}
                  locale={locale}
                />
              </div>
            </>
          )}

          {!viewOnly && isOwnProfile && (
            <div
              id="onboarding-target-preview-profile"
              className="flex justify-center my-6 md:my-8"
            >
              <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
                <DialogTrigger asChild>
                  <Button
                    onClick={handlePreviewClick}
                    variant="outline"
                    size="lg"
                    className="px-8 py-3 text-base sm:text-lg gap-2 rounded-full border-2 border-cyan-200 text-cyan-600 hover:bg-cyan-50 hover:border-cyan-400 transition-all duration-300 shadow-sm hover:shadow-md"
                  >
                    {dict.dashboard.previewButton}
                    <Eye className="w-5 h-5 sm:w-6 sm:h-6" />
                  </Button>
                </DialogTrigger>
                <DialogContent className="w-screen h-screen sm:w-[95vw] sm:h-[90vh] sm:max-w-6xl p-0 bg-white/95 backdrop-blur-md sm:rounded-3xl shadow-2xl border-none overflow-hidden">
                  {profileData ? (
                    <ProfileCard
                      profile={profileData}
                      images={images}
                      questionnaire={questionnaireResponse}
                      viewMode="candidate"
                      isProfileComplete={
                        session?.user?.isProfileComplete ?? false
                      }
                      className="h-full"
                      onClose={() => setPreviewOpen(false)}
                      dict={dict.profileCard}
                      locale={locale} // Pass locale to ProfileCard
                    />
                  ) : (
                    <p className="text-center text-gray-500 py-10">
                      {dict.dashboard.previewLoading}
                    </p>
                  )}
                </DialogContent>
              </Dialog>
            </div>
          )}

          <Tabs
            value={activeTab}
            onValueChange={handleTabChange}
            className="w-full"
          >
            <div className="flex justify-center mb-6 md:mb-8">
              <ScrollArea dir={direction} className="w-auto max-w-full">
                <TabsList className="h-auto p-1.5 bg-white/70 backdrop-blur-sm rounded-full shadow-md gap-1 inline-flex flex-nowrap">
                  <TabsTrigger
                    value="overview"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.overview}
                  </TabsTrigger>
                  <TabsTrigger
                    value="photos"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.photos}
                  </TabsTrigger>
                  <TabsTrigger
                    value="preferences"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.preferences}
                  </TabsTrigger>
                  <TabsTrigger
                    value="questionnaire"
                    className="px-4 py-2 rounded-full text-sm font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-cyan-100/50 data-[state=active]:bg-cyan-500 data-[state=active]:text-white data-[state=active]:shadow-md"
                  >
                    {dict.dashboard.tabs.questionnaire}
                  </TabsTrigger>
                </TabsList>
                <ScrollBar orientation="horizontal" className="mt-1" />
              </ScrollArea>
            </div>
            <div
              id="profile-tabs-content"
              className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl transition-all duration-300 ease-in-out scroll-mt-4"
            >
              {/* הוסף id ו-className לכל TabsContent */}
              <TabsContent
                value="overview"
                id="overview-content"
                className="scroll-mt-24" // ✨ שינוי: הגדלת המרווח
              >
                {profileData ? (
                  <ProfileSection
                    profile={profileData}
                    isEditing={isEditing}
                    setIsEditing={setIsEditing}
                    onSave={handleSave}
                    viewOnly={viewOnly || !isOwnProfile}
                    dict={dict.profileSection}
                    locale={locale}
                  />
                ) : (
                  <p className="text-center text-gray-500 py-10">
                    {dict.dashboard.tabContent.loadingOverview}
                  </p>
                )}
              </TabsContent>
              <TabsContent
                value="photos"
                id="photos-content"
                className="scroll-mt-4"
              >
                <PhotosSection
                  images={images}
                  isUploading={isLoading}
                  disabled={viewOnly || !isOwnProfile}
                  onUpload={handleImageUpload}
                  onSetMain={handleSetMainImage}
                  onDelete={handleDeleteImage}
                  dict={dict.photosSection}
                  locale={locale}
                />
              </TabsContent>
              <TabsContent
                value="preferences"
                id="preferences-content"
                className="scroll-mt-4"
              >
                {profileData ? (
                  <PreferencesSection
                    profile={profileData}
                    isEditing={isEditing}
                    setIsEditing={setIsEditing}
                    onChange={handleSave}
                    viewOnly={viewOnly || !isOwnProfile}
                    dictionary={dict.preferencesSection}
                    locale={locale}
                  />
                ) : (
                  <p className="text-center text-gray-500 py-10">
                    {dict.dashboard.tabContent.loadingPreferences}
                  </p>
                )}
              </TabsContent>
              <TabsContent
                value="questionnaire"
                id="questionnaire-content"
                className="scroll-mt-4"
              >
                {questionnaireResponse ? (
                  <QuestionnaireResponsesSection
                    questionnaire={questionnaireResponse}
                    onUpdate={handleQuestionnaireUpdate}
                    isEditable={!viewOnly && isOwnProfile}
                    dict={dict}
                    locale={locale}
                  />
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    {isLoading
                      ? dict.dashboard.tabContent.loadingQuestionnaire
                      : dict.dashboard.tabContent.noQuestionnaire}
                    {!isLoading && isOwnProfile && (
                      <Button
                        asChild
                        variant="link"
                        className="mt-2 text-cyan-600"
                      >
                        <Link href="/questionnaire">
                          {dict.dashboard.tabContent.fillQuestionnaireLink}
                        </Link>
                      </Button>
                    )}
                  </div>
                )}
              </TabsContent>
            </div>
          </Tabs>
        </div>
      </div>
    </div>
  );
};

export default UnifiedProfileDashboard;
--- End of Content for UnifiedProfileDashboard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\sections\sections_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--- End of Content for sections_contents.txt ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\types\profile.ts
--------------------------------------------------------------------------------
Content:
import type { UserProfile, UserImage, QuestionnaireResponse } from "@/types/next-auth";

// Define specific types for questionnaire updates
export interface QuestionnaireUpdateValue {
  type: 'answer' | 'visibility';
  value?: string;
  isVisible?: boolean;
}

// Interfaces for the main sections
export interface PhotosSectionProps {
  images: UserImage[];
  isUploading: boolean;
  disabled?: boolean;
  onUpload: (file: File) => Promise<void>;
  onSetMain: (imageId: string) => Promise<void>;
  onDelete: (imageId: string) => Promise<void>;
}


export interface PreferencesSectionProps {
  profile: UserProfile | null;
  isEditing: boolean;
  viewOnly?: boolean;
  setIsEditing: (value: boolean) => void;
  onChange: (data: Partial<UserProfile>) => void;
}

export interface QuestionnaireResponsesSectionProps {
  questionnaire: QuestionnaireResponse | null;
  onUpdate?: (world: string, questionId: string, value: QuestionnaireUpdateValue) => Promise<void>;
  isEditable?: boolean;
  viewMode?: "matchmaker" | "candidate";
}

// Types for the extended profile data
export interface ExtendedProfileData {
  personalityTraits?: {
    temperament?: string;
    decisionMaking?: string;
    stressManagement?: string;
    communicationStyle?: string;
  };
  spiritualProfile?: {
    prayerStyle?: string;
    secularStudiesAttitude?: string;
    modestyLevel?: string;
    childrenEducationApproach?: string;
  };
  familyBackground?: {
    parentsSpiritualLevel?: string;
    parentsOccupations?: {
      father?: string;
      mother?: string;
    };
    familyDynamics?: string;
  };
  lifestylePreferences?: {
    careerAspiration?: string;
    futureStudyPlans?: string;
    livingPreferences?: {
      proximity?: string;
    };
    relationshipExpectations?: string;
  };
  healthProfile?: {
    generalHealth?: string;
    dietaryRestrictions?: string[];
    physicalActivity?: string;
  };
  personalValues?: {
    parentalRespect?: number;
    communityInvolvement?: string;
    volunteeringPreferences?: string;
    financialManagement?: string;
  };
  futureGoals?: string[];
  [key: string]: unknown;
}

// Additional utility types
export type ViewMode = "matchmaker" | "candidate";
export type CardSize = "sm" | "md" | "lg";
--- End of Content for profile.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\profile\types\questionnaire.ts
--------------------------------------------------------------------------------
Content:
// src/components/shared/profile/types/questionnaire.ts

export type QuestionnaireAnswerValue = {
  type: 'answer';
  value: string;
} | {
  type: 'visibility';
  isVisible: boolean;
} | string | number | boolean;

export interface FormattedAnswer {
  questionId: string;
  question: string;
  value: QuestionnaireAnswerValue;
  displayText: string;
  answeredAt: string;
  category?: string;
  isVisible: boolean;
}

export interface QuestionnaireResponse {
  id: string;
  userId: string;
  formattedAnswers: {
    values: FormattedAnswer[];
    personality: FormattedAnswer[];
    relationship: FormattedAnswer[];
    partner: FormattedAnswer[];
    religion: FormattedAnswer[];
  };
  valuesCompleted: boolean;
  personalityCompleted: boolean;
  relationshipCompleted: boolean;
  partnerCompleted: boolean;
  religionCompleted: boolean;
  worldsCompleted: string[];
  completed: boolean;
  startedAt: string | Date;
  completedAt?: string | Date;
  lastSaved: string | Date;
}

export interface QuestionnaireWorld {
  key: string;
  title: string;
  icon: React.ElementType;
  color: string;
  bgColor: string;
  borderColor: string;
}

export interface QuestionCardProps {
  question: string;
  answer: FormattedAnswer;
  isEditing: boolean;
  onEdit: (value: string) => void;
  onVisibilityChange: (isVisible: boolean) => void;
}

export interface WorldSectionProps {
  title: string;
  icon: React.ElementType;
  answers: FormattedAnswer[];
  isEditing: boolean;
  onEdit: (questionId: string, value: string) => void;
  onVisibilityChange: (questionId: string, isVisible: boolean) => void;
  isCompleted: boolean;
  className?: string;
}
--- End of Content for questionnaire.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\MatchmakingQuestionnaire.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/MatchmakingQuestionnaire.tsx
'use client';

import React, {
  useState,
  useMemo,
  useEffect,
  useCallback,
  useRef,
} from 'react';
import { useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import QuestionnaireLayout from './layout/QuestionnaireLayout';
import WorldComponent from './worlds/WorldComponent';
import QuestionnaireCompletion from './common/QuestionnaireCompletion';
import QuestionnaireLandingPage from './pages/QuestionnaireLandingPage';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { cn } from '@/lib/utils';
import WorldsMap from './layout/WorldsMap';
import { useIdleTimeout } from './hooks/useIdleTimeout';
import { signOut } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useQuestionnaireState } from '@/app/[locale]/contexts/QuestionnaireStateContext';

import {
  Loader2,
  CheckCircle,
  AlertTriangle,
  XCircle,
  Info,
  Clock,
  LogOut,
  Sparkles,
  AlertCircle,
  Zap,
} from 'lucide-react';
import type {
  WorldId,
  QuestionnaireSubmission,
  QuestionnaireAnswer,
  AnswerValue,
  Question,
} from './types/types';
import type { QuestionnaireDictionary } from '@/types/dictionary';

import { personalityQuestions } from './questions/personality/personalityQuestions';
import { valuesQuestions } from './questions/values/valuesQuestions';
import { relationshipQuestions } from './questions/relationship/relationshipQuestions';
import { partnerQuestions } from './questions/partner/partnerQuestions';
import { religionQuestions } from './questions/religion/religionQuestions';

const worldConfig: Record<WorldId, { questions: Question[] }> = {
  PERSONALITY: { questions: personalityQuestions },
  VALUES: { questions: valuesQuestions },
  RELATIONSHIP: { questions: relationshipQuestions },
  PARTNER: { questions: partnerQuestions },
  RELIGION: { questions: religionQuestions },
};

enum OnboardingStep {
  LANDING = 'LANDING',
  MAP = 'MAP',
  WORLDS = 'WORLDS',
  COMPLETED = 'COMPLETED',
}

const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

export interface MatchmakingQuestionnaireProps {
  userId?: string;
  onComplete?: () => void;
  initialWorld?: WorldId;
  initialQuestionId?: string;
  dict: QuestionnaireDictionary;
  locale: 'he' | 'en';
}

export default function MatchmakingQuestionnaire({
  userId,
  onComplete,
  initialWorld,
  initialQuestionId,
  dict,
  locale,
}: MatchmakingQuestionnaireProps) {
  console.log(
    `%c[MatchmakingQuestionnaire] 🚀 Initializing | User: ${userId ? 'Authenticated' : 'Guest'} | World: ${initialWorld || 'None'} | Question: ${initialQuestionId || 'None'}`,
    'color: #0d9488; font-weight: bold; font-size: 14px;'
  );

  const router = useRouter();
  const sessionId = useMemo(() => `session_${Date.now()}`, []);

  // Check for saved progress
  const hasSavedProgress = useMemo(() => {
    if (typeof window === 'undefined') return false;
    const saved = localStorage.getItem('tempQuestionnaire');
    return !!saved;
  }, []);

  const [currentStep, setCurrentStep] = useState<OnboardingStep>(
    initialWorld ? OnboardingStep.WORLDS : OnboardingStep.LANDING
  );
  const [currentWorld, setCurrentWorld] = useState<WorldId>(
    initialWorld || 'PERSONALITY'
  );
  const [answers, setAnswers] = useState<QuestionnaireAnswer[]>([]);
  const [completedWorlds, setCompletedWorlds] = useState<WorldId[]>([]);
  const [startTime] = useState(() => new Date().toISOString());
  const [lastSavedTime, setLastSavedTime] = useState<Date | null>(null);
  const [isDirectNavigation, setIsDirectNavigation] = useState(false);
  const [currentQuestionIndices, setCurrentQuestionIndices] = useState<
    Record<WorldId, number>
  >({
    PERSONALITY: 0,
    VALUES: 0,
    RELATIONSHIP: 0,
    PARTNER: 0,
    RELIGION: 0,
  });

  const [isSaving, setIsSaving] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isDirty, setIsDirty] = useState(false);
  const { setIsDirty: setGlobalDirty, setSaveHandler } =
    useQuestionnaireState();

  const [toastState, setToastState] = useState<{
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';
    isVisible: boolean;
    action?: { label: string; onClick: () => void };
  }>({
    message: '',
    type: 'info',
    isVisible: false,
  });

  const [showIdleModal, setShowIdleModal] = useState(false);
  const logoutTimer = useRef<NodeJS.Timeout | null>(null);

  // Idle timeout handler
  const handleIdle = useCallback(() => {
    if (userId) {
      console.log(
        '%c[MatchmakingQuestionnaire] ⏰ User idle detected',
        'color: #f97316; font-weight: bold;'
      );
      setShowIdleModal(true);
      logoutTimer.current = setTimeout(() => {
        signOut({ callbackUrl: '/' });
      }, 60000);
    }
  }, [userId]);

  const { resetTimer: resetIdleTimer } = useIdleTimeout({
    onIdle: handleIdle,
    idleTimeSeconds: 7200,
  });

  const handleStayActive = useCallback(() => {
    if (logoutTimer.current) {
      clearTimeout(logoutTimer.current);
    }
    setShowIdleModal(false);
    resetIdleTimer();
    console.log(
      '%c[MatchmakingQuestionnaire] ✅ User stayed active',
      'color: #0d9488; font-weight: bold;'
    );
  }, [resetIdleTimer]);

  // Sync isDirty state globally
  useEffect(() => {
    setGlobalDirty(isDirty);
  }, [isDirty, setGlobalDirty]);

  // Handle initial world
  useEffect(() => {
    if (initialWorld) {
      setCurrentWorld(initialWorld);
    }
  }, [initialWorld]);

  // Enhanced toast notification system
  const showToast = useCallback(
    (
      message: string,
      type: 'success' | 'error' | 'info' | 'warning' = 'info',
      duration: number = 3000,
      action?: { label: string; onClick: () => void }
    ) => {
      console.log(
        `%c[Toast] ${type.toUpperCase()}: ${message}`,
        'color: #6366f1; font-weight: bold;'
      );
      setToastState({ message, type, isVisible: true, action });
      if (!action) {
        setTimeout(() => {
          setToastState((prev) => ({ ...prev, isVisible: false }));
        }, duration);
      }
    },
    []
  );

  // Get next world in sequence
  const getNextWorld = (currentWorldId: WorldId): WorldId | null => {
    const currentIndex = WORLD_ORDER.indexOf(currentWorldId);
    if (currentIndex < WORLD_ORDER.length - 1) {
      return WORLD_ORDER[currentIndex + 1];
    }
    return null;
  };

  // Prepare submission data
  const prepareSubmissionData = useCallback((): QuestionnaireSubmission => {
    const isCompleted = completedWorlds.length === WORLD_ORDER.length;
    return {
      userId: userId || sessionId,
      answers: answers,
      worldsCompleted: completedWorlds,
      completed: isCompleted,
      startedAt: startTime,
      completedAt: isCompleted ? new Date().toISOString() : undefined,
      currentQuestionIndices: currentQuestionIndices,
    };
  }, [
    answers,
    completedWorlds,
    sessionId,
    startTime,
    userId,
    currentQuestionIndices,
  ]);

  // Enhanced save handler with better feedback
  const handleQuestionnaireSave = useCallback(
    async (isAutoSave = false) => {
      if (isSaving && !isAutoSave) return;

      console.log(
        `%c[Save] ${isAutoSave ? '💾 Auto-saving' : '🖱️ Manual save'} | Answers: ${answers.length} | Completed: ${completedWorlds.length}/${WORLD_ORDER.length}`,
        'color: #f97316; font-weight: bold;'
      );

      setIsSaving(true);
      setError(null);

      try {
        const submissionData = prepareSubmissionData();

        // Validation
        const validateSubmission = (data: QuestionnaireSubmission): boolean => {
          if (!data.userId) return false;
          if (!Array.isArray(data.worldsCompleted)) return false;
          if (typeof data.completed !== 'boolean') return false;
          if (!data.startedAt) return false;
          if (data.completed && !data.completedAt) return false;
          return true;
        };

        if (!validateSubmission(submissionData)) {
          throw new Error(dict.matchmaking.errors.invalidSubmission);
        }

        // Save logic
        if (!userId) {
          // Guest user - save to localStorage
          localStorage.setItem(
            'tempQuestionnaire',
            JSON.stringify(submissionData)
          );
          console.log(
            '%c[Save] ✅ Saved to localStorage (guest user)',
            'color: #0d9488; font-weight: bold;'
          );

          if (currentStep === OnboardingStep.COMPLETED) {
            router.push('/auth/signin?callbackUrl=/questionnaire/restore');
          }
        } else {
          // Authenticated user - save to backend
          const response = await fetch('/api/questionnaire', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submissionData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || dict.matchmaking.errors.saveFailed
            );
          }

          console.log(
            '%c[Save] ✅ Saved to backend (authenticated user)',
            'color: #0d9488; font-weight: bold;'
          );
        }

        setLastSavedTime(new Date());
        setIsDirty(false);
        setToastState((prev) => ({ ...prev, isVisible: false }));

        if (!isAutoSave) {
          showToast(dict.matchmaking.toasts.saveSuccess, 'success', 2000);
        }
      } catch (err) {
        console.error(
          '%c[Save] ❌ Save failed:',
          'color: #f43f5e; font-weight: bold;',
          err
        );
        const errorMessage =
          err instanceof Error
            ? err.message
            : dict.matchmaking.errors.saveFailed;
        setError(errorMessage);
        showToast(errorMessage, 'error', 5000);
      } finally {
        setIsSaving(false);
      }
    },
    [
      isSaving,
      prepareSubmissionData,
      userId,
      currentStep,
      router,
      dict.matchmaking.errors,
      dict.matchmaking.toasts,
      showToast,
      answers.length,
      completedWorlds.length,
    ]
  );

  useEffect(() => {
    setSaveHandler(() => handleQuestionnaireSave(false));
  }, [handleQuestionnaireSave, setSaveHandler]);

  // Load saved progress
  useEffect(() => {
    const loadProgress = async () => {
      console.log(
        '%c[Load] 📂 Loading progress...',
        'color: #0d9488; font-weight: bold;'
      );
      setIsLoading(true);
      setError(null);

      try {
        if (!userId) {
          // Guest user - load from localStorage
          const saved = localStorage.getItem('tempQuestionnaire');
          if (saved) {
            const loadedData = JSON.parse(saved);
            console.log(
              '%c[Load] ✅ Loaded from localStorage',
              'color: #0d9488; font-weight: bold;',
              loadedData
            );
            setAnswers(loadedData.answers || []);
            setCompletedWorlds(loadedData.worldsCompleted || []);

            setCurrentQuestionIndices((prevIndices) => ({
              ...prevIndices,
              ...(loadedData.currentQuestionIndices || {}),
            }));

            if ((loadedData.answers || []).length > 0) {
              setCurrentStep(OnboardingStep.MAP);
            }
          } else {
            console.log(
              '%c[Load] ℹ️ No saved progress found for guest',
              'color: #6b7280; font-weight: bold;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          }
          setIsLoading(false);
          return;
        }

        // Authenticated user - load from server
        const response = await fetch('/api/questionnaire');

        if (!response.ok) {
          if (response.status === 404) {
            console.log(
              '%c[Load] ℹ️ No existing questionnaire data found for user. Starting fresh.',
              'color: #6b7280;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          } else {
            const errorData = await response.json();
            throw new Error(
              errorData.error || dict.matchmaking.errors.loadFailed
            );
          }
        } else {
          const apiResponse = await response.json();
          console.log(
            '%c[Load] ✅ Loaded from backend',
            'color: #0d9488; font-weight: bold;',
            apiResponse
          );

          if (apiResponse.success && apiResponse.data) {
            const loadedData = apiResponse.data;

            const allAnswers = [
              ...(loadedData.answers || []),
              ...(loadedData.valuesAnswers || []),
              ...(loadedData.personalityAnswers || []),
              ...(loadedData.relationshipAnswers || []),
              ...(loadedData.partnerAnswers || []),
              ...(loadedData.religionAnswers || []),
            ].filter(
              (answer, index, self) =>
                index ===
                self.findIndex((a) => a.questionId === answer.questionId)
            );

            setAnswers(allAnswers);
            const loadedCompletedWorlds = loadedData.worldsCompleted || [];
            setCompletedWorlds(loadedCompletedWorlds);

            if (
              loadedData.currentQuestionIndices &&
              typeof loadedData.currentQuestionIndices === 'object'
            ) {
              setCurrentQuestionIndices((prev) => ({
                ...prev,
                ...loadedData.currentQuestionIndices,
              }));
            }

            const isQuestionnaireComplete =
              loadedData.completed ||
              loadedCompletedWorlds.length === WORLD_ORDER.length;

            if (initialWorld && initialQuestionId) {
              const worldQuestions = worldConfig[initialWorld].questions;
              const questionIndex = worldQuestions.findIndex(
                (q) => q.id === initialQuestionId
              );
              if (questionIndex !== -1) {
                setCurrentQuestionIndices((prev) => ({
                  ...prev,
                  [initialWorld]: questionIndex,
                }));
                setCurrentWorld(initialWorld);
                setCurrentStep(OnboardingStep.WORLDS);
                setIsDirectNavigation(true);
              } else {
                setCurrentStep(OnboardingStep.MAP);
              }
            } else if (isQuestionnaireComplete) {
              setCurrentStep(OnboardingStep.MAP);
            } else if (allAnswers.length > 0) {
              const worldToResume =
                WORLD_ORDER.find(
                  (world) => !loadedCompletedWorlds.includes(world)
                ) || WORLD_ORDER[0];
              setCurrentWorld(worldToResume);
              setCurrentStep(OnboardingStep.WORLDS);
              console.log(
                `%c[Load]  resuming questionnaire at world: ${worldToResume}.`,
                'color: #28a745; font-weight: bold;'
              );
            } else {
              setCurrentStep(OnboardingStep.LANDING);
            }
          } else {
            console.log(
              '%c[Load] API response indicates no existing data. Starting from LANDING.',
              'color: #f44336;'
            );
            setCurrentStep(OnboardingStep.LANDING);
          }
        }
      } catch (err) {
        console.error(
          '%c[Load] ❌ Load failed:',
          'color: #f43f5e; font-weight: bold;',
          err
        );
        const errorMessage =
          err instanceof Error
            ? err.message
            : dict.matchmaking.errors.loadFailed;
        setError(errorMessage);
        showToast(errorMessage, 'error', 5000);
        setCurrentStep(OnboardingStep.LANDING);
      } finally {
        setIsLoading(false);
      }
    };

    loadProgress();
  }, [
    userId,
    initialWorld,
    initialQuestionId,
    dict.matchmaking.errors,
    showToast,
  ]);

  // Answer handler
  const handleAnswer = useCallback(
    (worldId: WorldId, questionId: string, value: AnswerValue) => {
      console.log(
        `%c[Answer] 📝 ${worldId} | ${questionId}`,
        'color: #06b6d4; font-weight: bold;'
      );

      setAnswers((prev) => {
        const existingIndex = prev.findIndex(
          (a) => a.worldId === worldId && a.questionId === questionId
        );
        const newAnswer: QuestionnaireAnswer = {
          worldId,
          questionId,
          value,
          answeredAt: new Date().toISOString(),
        };

        if (existingIndex >= 0) {
          const updated = [...prev];
          updated[existingIndex] = newAnswer;
          return updated;
        }
        return [...prev, newAnswer];
      });

      setIsDirty(true);
    },
    []
  );

  // Visibility change handler
  const handleVisibilityChange = useCallback(
    (worldId: WorldId, questionId: string, isVisible: boolean) => {
      console.log(
        `%c[Visibility] ${isVisible ? '👁️' : '👁️‍🗨️'} ${worldId} | ${questionId}`,
        'color: #f97316;'
      );

      setAnswers((prev) => {
        const existingIndex = prev.findIndex(
          (a) => a.worldId === worldId && a.questionId === questionId
        );

        if (existingIndex >= 0) {
          const updated = [...prev];
          updated[existingIndex] = {
            ...updated[existingIndex],
            isVisible: isVisible,
          };
          return updated;
        }

        const newAnswer: QuestionnaireAnswer = {
          worldId,
          questionId,
          value: undefined,
          answeredAt: new Date().toISOString(),
          isVisible: isVisible,
        };
        return [...prev, newAnswer];
      });

      setIsDirty(true);
    },
    []
  );

  // World change handler
  const handleWorldChange = useCallback((worldId: WorldId) => {
    console.log(
      `%c[Navigation] 🗺️ Changing to world: ${worldId}`,
      'color: #ec4899; font-weight: bold;'
    );
    setCurrentWorld(worldId);
    setCurrentStep(OnboardingStep.WORLDS);
    setIsDirectNavigation(true);
  }, []);

  // World completion handler
  const handleWorldComplete = useCallback(
    async (worldId: WorldId) => {
      console.log(
        `%c[Complete] ✨ World completed: ${worldId}`,
        'color: #0d9488; font-weight: bold;'
      );

      if (!completedWorlds.includes(worldId)) {
        const updatedCompleted = [...completedWorlds, worldId];
        setCompletedWorlds(updatedCompleted);

        await handleQuestionnaireSave(true);

        const nextWorld = getNextWorld(worldId);
        if (nextWorld) {
          showToast(
            dict.matchmaking.toasts.worldFinished.replace(
              '{{worldName}}',
              dict.matchmaking.worldLabels[worldId]
            ),
            'success',
            4000,
            {
              label: dict.matchmaking.toasts.nextWorldAction.replace(
                '{{name}}',
                dict.matchmaking.worldLabels[nextWorld]
              ),
              onClick: () => {
                setCurrentWorld(nextWorld);
                setIsDirectNavigation(false);
              },
            }
          );
        } else {
          console.log(
            '%c[Complete] 🏆 ALL WORLDS COMPLETED!',
            'color: #fbbf24; font-weight: bold; font-size: 16px;'
          );
          showToast(
            dict.matchmaking.toasts.allWorldsFinished,
            'success',
            3000
          );
          setCurrentStep(OnboardingStep.COMPLETED);
        }
      }
    },
    [
      completedWorlds,
      handleQuestionnaireSave,
      showToast,
      dict.matchmaking.worldLabels,
      dict.matchmaking.toasts,
    ]
  );

  // Exit handler
  const handleExit = useCallback(() => {
    console.log(
      '%c[Navigation] 🔙 Exiting to map',
      'color: #6b7280; font-weight: bold;'
    );
    setCurrentStep(OnboardingStep.MAP);
  }, []);

  // Start questionnaire handler
  const handleStartQuestionnaire = useCallback(() => {
    console.log(
      '%c[Start] 🚀 Starting questionnaire',
      'color: #0d9488; font-weight: bold;'
    );

    if (hasSavedProgress && completedWorlds.length > 0) {
      setCurrentStep(OnboardingStep.MAP);
    } else {
      setCurrentWorld('PERSONALITY');
      setCurrentStep(OnboardingStep.WORLDS);
    }
  }, [hasSavedProgress, completedWorlds.length]);

  // Render current world
  const renderCurrentWorld = useCallback(() => {
    const worldProps = {
      onAnswer: handleAnswer,
      onVisibilityChange: handleVisibilityChange,
      onComplete: () => handleWorldComplete(currentWorld),
      onBack: handleExit,
      answers: answers.filter((a) => a.worldId === currentWorld),
      isCompleted: completedWorlds.includes(currentWorld),
      currentQuestionIndex: currentQuestionIndices[currentWorld],
      setCurrentQuestionIndex: (index: number) => {
        setCurrentQuestionIndices((prev) => ({
          ...prev,
          [currentWorld]: index,
        }));
      },
      onSave: () => handleQuestionnaireSave(false),
      isSaving: isSaving,
      isDirectNavigation: isDirectNavigation,
      dict: {
        world: dict.world,
        questionCard: dict.questionCard,
        worldLabels: dict.matchmaking.worldLabels,
        answerInput: dict.answerInput,
        interactiveScale: dict.interactiveScale,
        questionsList: dict.questionsList,
        questions: dict.questions,
      },
    };

    return (
      <WorldComponent {...worldProps} worldId={currentWorld} locale={locale} />
    );
  }, [
    currentWorld,
    handleAnswer,
    handleVisibilityChange,
    handleWorldComplete,
    handleExit,
    answers,
    completedWorlds,
    currentQuestionIndices,
    handleQuestionnaireSave,
    isSaving,
    isDirectNavigation,
    dict,
    locale,
  ]);

  const worldStats = useMemo(
    () => ({
      PERSONALITY: { questionCount: personalityQuestions.length },
      VALUES: { questionCount: valuesQuestions.length },
      RELATIONSHIP: { questionCount: relationshipQuestions.length },
      PARTNER: { questionCount: partnerQuestions.length },
      RELIGION: { questionCount: religionQuestions.length },
    }),
    []
  );

  const renderCurrentStep = () => {
    if (isLoading) {
      return (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20"
        >
          <div className="relative">
            <div className="absolute inset-0 bg-gradient-to-r from-teal-400 to-orange-500 rounded-full blur-xl opacity-50 animate-pulse" />
            <Loader2 className="relative h-16 w-16 animate-spin text-teal-600" />
          </div>
          <motion.p
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="mt-6 text-xl font-semibold text-gray-700"
          >
            {dict.matchmaking.loading}
          </motion.p>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.4 }}
            className="mt-4 flex items-center gap-2 text-sm text-gray-500"
          >
            <Sparkles className="w-4 h-4" />
            <span>{dict.matchmaking.loadingSubtext}</span>
          </motion.div>
        </motion.div>
      );
    }

    switch (currentStep) {
      case OnboardingStep.LANDING:
        return (
          <QuestionnaireLandingPage
            onStartQuestionnaire={handleStartQuestionnaire}
            hasSavedProgress={hasSavedProgress}
            isLoading={isSaving}
            dict={dict.landingPage}
            locale={locale}
          />
        );

      case OnboardingStep.MAP:
        return (
          <WorldsMap
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={handleWorldChange}
            dict={dict.worldsMap}
            locale={locale}
            answers={answers}
            worldStats={worldStats}
          />
        );

      case OnboardingStep.WORLDS:
        return (
          <QuestionnaireLayout
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={handleWorldChange}
            onExit={handleExit}
            onSaveProgress={() => handleQuestionnaireSave(false)}
            locale={locale}
            dict={{
              layout: dict.layout,
              worldLabels: dict.matchmaking.worldLabels,
              faq: dict.faq,
              accessibilityFeatures: dict.accessibilityFeatures,
            }}
          >
            {renderCurrentWorld()}
          </QuestionnaireLayout>
        );

      case OnboardingStep.COMPLETED:
        return (
          <QuestionnaireCompletion
            onSendToMatching={async () => {
              console.log(
                '%c[Complete] 🎯 Sending to matching...',
                'color: #0d9488; font-weight: bold;'
              );
              if (onComplete) onComplete();
              else router.push('/dashboard');
            }}
            isLoading={isSaving}
            isLoggedIn={!!userId}
            dict={dict.completion}
          />
        );

      default:
        return (
          <div className="flex items-center justify-center min-h-screen">
            <Alert variant="destructive" className="max-w-md">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>
                {dict.matchmaking.errors.stageLoadError}
              </AlertDescription>
            </Alert>
          </div>
        );
    }
  };

  // Enhanced Toast Component
  const Toast = ({
    message,
    type,
    isVisible,
    action,
  }: {
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';
    isVisible: boolean;
    action?: { label: string; onClick: () => void };
  }) => {
    if (!isVisible) return null;

    const typeConfig = {
      success: {
        bg: 'from-teal-500 to-emerald-600',
        icon: CheckCircle,
        border: 'border-teal-400',
      },
      error: {
        bg: 'from-rose-500 to-red-600',
        icon: XCircle,
        border: 'border-rose-400',
      },
      info: {
        bg: 'from-blue-500 to-cyan-600',
        icon: Info,
        border: 'border-blue-400',
      },
      warning: {
        bg: 'from-orange-500 to-amber-600',
        icon: AlertCircle,
        border: 'border-orange-400',
      },
    };

    const config = typeConfig[type];
    const Icon = config.icon;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0, y: 50, scale: 0.9 }}
          animate={{ opacity: 1, y: 0, scale: 1 }}
          exit={{ opacity: 0, y: 20, scale: 0.9 }}
          transition={{ type: 'spring', stiffness: 200, damping: 20 }}
          className={cn(
            'fixed bottom-6 right-6 z-[100] max-w-md backdrop-blur-xl',
            'rounded-2xl shadow-2xl border-2',
            config.border
          )}
        >
          <div
            className={cn(
              'relative overflow-hidden rounded-2xl bg-gradient-to-r p-5',
              config.bg
            )}
          >
            <div className="absolute inset-0 bg-black/10" />
            <div className="relative z-10 flex items-center justify-between gap-4">
              <div className="flex items-center gap-3 flex-1">
                <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                  <Icon className="h-6 w-6 text-white" />
                </div>
                <p className="text-white font-semibold leading-relaxed">
                  {message}
                </p>
              </div>
              {action && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    action.onClick();
                    setToastState((prev) => ({ ...prev, isVisible: false }));
                  }}
                  className="text-white hover:bg-white/20 font-bold border-2 border-white/40 rounded-xl flex-shrink-0"
                >
                  {action.label}
                </Button>
              )}
            </div>
          </div>
        </motion.div>
      </AnimatePresence>
    );
  };

  // Enhanced Idle Modal Component
  const IdleModal = () => {
    if (!showIdleModal) return null;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black/70 backdrop-blur-md z-[200] flex items-center justify-center p-4"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0, y: 20 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            exit={{ scale: 0.9, opacity: 0, y: 20 }}
            transition={{ type: 'spring', stiffness: 200 }}
          >
            <Card className="max-w-md w-full shadow-2xl border-2 border-orange-200">
              <CardHeader className="bg-gradient-to-r from-orange-50 to-amber-50 border-b-2 border-orange-200">
                <CardTitle className="flex items-center gap-3 text-xl">
                  <div className="p-2 bg-gradient-to-br from-orange-400 to-amber-500 rounded-xl">
                    <Clock className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-gray-800">
                    {dict.matchmaking.idleModal.title}
                  </span>
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6 space-y-6">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg flex-shrink-0">
                    <AlertCircle className="w-5 h-5 text-orange-600" />
                  </div>
                  <p className="text-gray-600 leading-relaxed">
                    {dict.matchmaking.idleModal.description}
                  </p>
                </div>

                <div className="flex flex-col sm:flex-row gap-3">
                  <Button
                    variant="outline"
                    onClick={() => signOut({ callbackUrl: '/' })}
                    className="w-full sm:w-auto border-2 border-rose-300 text-rose-600 hover:bg-rose-50"
                  >
                    <LogOut className="w-4 h-4 mr-2" />
                    {dict.matchmaking.idleModal.logoutButton}
                  </Button>
                  <Button
                    onClick={handleStayActive}
                    className="w-full sm:w-auto bg-gradient-to-r from-teal-500 to-orange-500 hover:from-teal-600 hover:to-orange-600 text-white font-bold"
                  >
                    <Zap className="w-4 h-4 mr-2" />
                    {dict.matchmaking.idleModal.stayActiveButton}
                  </Button>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        </motion.div>
      </AnimatePresence>
    );
  };

  // Last Saved Indicator
  const LastSavedIndicator = () => {
    if (!lastSavedTime || currentStep !== OnboardingStep.WORLDS || !userId)
      return null;

    return (
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: 20 }}
        className="fixed bottom-6 left-6 z-40 bg-white/95 backdrop-blur-sm p-3 rounded-xl shadow-lg border-2 border-teal-200"
      >
        <div className="flex items-center gap-2">
          <CheckCircle className="h-4 w-4 text-teal-600" />
          <span className="text-sm font-semibold text-gray-700">
            {dict.matchmaking.lastSaved.replace(
              '{{time}}',
              lastSavedTime.toLocaleTimeString(
                locale === 'he' ? 'he-IL' : 'en-US',
                {
                  hour: '2-digit',
                  minute: '2-digit',
                }
              )
            )}
          </span>
        </div>
      </motion.div>
    );
  };

  // Error Alert
  const ErrorAlert = () => {
    if (!error || currentStep === OnboardingStep.WORLDS) return null;

    return (
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="max-w-2xl mx-auto m-6"
      >
        <Alert
          variant="destructive"
          className="border-2 border-rose-300 shadow-lg"
        >
          <div className="flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 mt-0.5 text-rose-600" />
            <AlertDescription className="text-base leading-relaxed text-rose-800">
              {error}
            </AlertDescription>
          </div>
        </Alert>
      </motion.div>
    );
  };

  return (
    <div
      className={cn(
        'min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        locale === 'he' ? 'dir-rtl' : 'dir-ltr'
      )}
    >
      <IdleModal />
      <LastSavedIndicator />
      <ErrorAlert />

      <AnimatePresence mode="wait">
        <motion.div
          key={currentStep}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.3 }}
        >
          {renderCurrentStep()}
        </motion.div>
      </AnimatePresence>

      <Toast
        message={toastState.message}
        type={toastState.type}
        isVisible={toastState.isVisible}
        action={toastState.action}
      />
    </div>
  );
}
--- End of Content for MatchmakingQuestionnaire.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnaireComplete.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { CheckCircle2, ArrowRight } from 'lucide-react';
import type { QuestionnaireCompletePageDict } from '@/types/dictionary'; // Import dictionary type

// --- Props Interface ---
interface QuestionnaireCompleteProps {
  dict: QuestionnaireCompletePageDict;
}

export default function QuestionnaireComplete({
  dict,
}: QuestionnaireCompleteProps) {
  const { status } = useSession();
  const router = useRouter();

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/auth/signin');
    }
  }, [status, router]);

  if (status === 'loading') {
    return (
      <div className="container mx-auto py-8 px-4">
        <Card className="max-w-xl mx-auto">
          <CardContent className="p-8">
            <div className="text-center">{dict.loading}</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 px-4">
      <Card className="max-w-xl mx-auto bg-green-50 border-green-200">
        <CardHeader className="text-center pb-2">
          <div className="flex justify-center mb-4">
            <CheckCircle2 className="w-12 h-12 text-green-500" />
          </div>
          <CardTitle className="text-2xl">{dict.title}</CardTitle>
        </CardHeader>

        <CardContent className="space-y-6 pt-4">
          <div className="text-center text-gray-600 space-y-2">
            <p>{dict.successMessage1}</p>
            <p>{dict.successMessage2}</p>
          </div>

          <Alert className="bg-blue-50 border-blue-200">
            <AlertDescription>{dict.profilePrompt}</AlertDescription>
          </Alert>

          <div className="flex justify-center pt-4">
            <Button
              onClick={() => router.push('/profile')}
              className="flex items-center"
            >
              {dict.continueButton}
              <ArrowRight className="mr-2 h-5 w-5" />
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
--- End of Content for QuestionnaireComplete.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnairePageClient.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/QuestionnairePageClient.tsx
'use client';

import { useSession } from 'next-auth/react';
import { useState, useEffect } from 'react';
import { useRouter, useSearchParams, useParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft, AlertCircle, Loader2 } from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import QuestionnaireLandingPage from './pages/QuestionnaireLandingPage';
import MatchmakingQuestionnaire from './MatchmakingQuestionnaire';
import StandardizedLoadingSpinner from './common/StandardizedLoadingSpinner'; // <-- שלב 1: הוספת הייבוא
import type { WorldId } from './types/types';
import type { QuestionnaireDictionary } from '@/types/dictionary';

// Enum to track questionnaire flow stages
enum QuestionnaireStage {
  LANDING = 'LANDING',
  QUESTIONNAIRE = 'QUESTIONNAIRE',
  COMPLETE = 'COMPLETE',
}

// הגדרת Props לרכיב
interface QuestionnairePageClientProps {
  dict: QuestionnaireDictionary;
  locale: 'he' | 'en';
}

export default function QuestionnairePageClient({
  dict,
  locale,
}: QuestionnairePageClientProps) {
  const { data: session, status } = useSession();
  const router = useRouter();
  const searchParams = useSearchParams();
  const params = useParams();

  // State for tracking current stage in the flow
  const [currentStage, setCurrentStage] = useState<QuestionnaireStage>(
    QuestionnaireStage.LANDING
  );
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [hasSavedProgress, setHasSavedProgress] = useState(false);
  const [initialWorld, setInitialWorld] = useState<WorldId | undefined>(
    undefined
  );
  const [initialQuestionId, setInitialQuestionId] = useState<
    string | undefined
  >(undefined);

  // Check for existing progress when component mounts
  useEffect(() => {
    const checkExistingProgress = async () => {
      if (status === 'loading') return;
      setIsLoading(true);
      try {
        if (session?.user?.id) {
          const response = await fetch('/api/questionnaire');
          const data = await response.json();
          if (data.success && data.data) {
            setHasSavedProgress(true);
          }
        }
      } catch (err) {
        console.error('Error checking questionnaire progress:', err);
      } finally {
        setIsLoading(false);
      }
    };
    checkExistingProgress();
  }, [session, status]);

  // Check for world parameter in URL and normalize it
  useEffect(() => {
    if (status === 'loading') {
      return;
    }
    const worldParam = searchParams?.get('world');
    const questionParam = searchParams?.get('question');

    if (worldParam) {
      const worldParamUpper = worldParam.toUpperCase() as WorldId;
      const validWorlds: WorldId[] = [
        'PERSONALITY',
        'VALUES',
        'RELATIONSHIP',
        'PARTNER',
        'RELIGION',
      ];
      if (validWorlds.includes(worldParamUpper)) {
        setInitialWorld(worldParamUpper);
        if (questionParam) {
          setInitialQuestionId(questionParam);
        }
        setCurrentStage(QuestionnaireStage.QUESTIONNAIRE);
      } else {
        console.warn(
          `[QuestionnairePage] Invalid world param received in URL: ${worldParam}`
        );
      }
    }
  }, [searchParams, status]);

  const handleStartQuestionnaire = () => {
    setCurrentStage(QuestionnaireStage.QUESTIONNAIRE);
  };

  const handleQuestionnaireComplete = async () => {
    try {
      await router.push('/questionnaire/complete');
      setCurrentStage(QuestionnaireStage.COMPLETE);
    } catch (err) {
      console.error('Error completing questionnaire:', err);
      setError(dict.page.completionError); // שימוש במילון
    }
  };

  // --- שלב 2: החלפת רכיב הטעינה ---
  if (isLoading) {
    return (
      <StandardizedLoadingSpinner
        text={dict.page.loading}
        subtext={
          dict.matchmaking.loadingSubtext || 'רק רגע, מכינים לך את המסע...'
        }
      />
    );
  }

  const renderCurrentStage = () => {
    switch (currentStage) {
      case QuestionnaireStage.LANDING:
        return (
          <QuestionnaireLandingPage
            onStartQuestionnaire={handleStartQuestionnaire}
            hasSavedProgress={hasSavedProgress}
            dict={dict.landingPage}
            locale={locale}
          />
        );
      case QuestionnaireStage.QUESTIONNAIRE:
        return (
          <MatchmakingQuestionnaire
            userId={session?.user?.id}
            onComplete={handleQuestionnaireComplete}
            initialWorld={initialWorld}
            initialQuestionId={initialQuestionId}
            dict={dict}
            locale={locale}
          />
        );
      case QuestionnaireStage.COMPLETE:
        return null;
      default:
        return <div>{dict.page.stageLoadError}</div>;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {error && (
        <div className="container mx-auto p-4">
          <Alert variant="destructive" className="mb-4">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        </div>
      )}

      {renderCurrentStage()}
    </div>
  );
}
--- End of Content for QuestionnairePageClient.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\QuestionnaireRestore.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';
import type { QuestionnaireRestoreDict } from '@/types/dictionary'; // Import dictionary type

// --- Props Interface ---
interface QuestionnaireRestoreProps {
  dict: QuestionnaireRestoreDict;
}

export default function QuestionnaireRestore({
  dict,
}: QuestionnaireRestoreProps) {
  const router = useRouter();
  const { data: session, status } = useSession();
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const restoreQuestionnaire = async () => {
      if (isProcessing) return;

      try {
        setIsProcessing(true);
        setError(null);

        const savedData = localStorage.getItem('tempQuestionnaire');

        if (!savedData || !session?.user?.id) {
          router.push('/dashboard');
          return;
        }

        const questionnaireData = JSON.parse(savedData);
        questionnaireData.userId = session.user.id;

        const response = await fetch('/api/questionnaire', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(questionnaireData),
        });

        if (!response.ok) {
          const errorData = await response.json();
          // Developer-facing error can remain in English
          throw new Error(errorData.message || 'Failed to save questionnaire');
        }

        localStorage.removeItem('tempQuestionnaire');
        router.push(
          questionnaireData.completed ? '/dashboard' : '/questionnaire'
        );
      } catch (err) {
        console.error('Error restoring questionnaire:', err);
        // Set user-facing error from the dictionary
        setError(dict.error);
      } finally {
        setIsProcessing(false);
      }
    };

    if (session?.user && !isProcessing && status === 'authenticated') {
      restoreQuestionnaire();
    }
  }, [session, router, isProcessing, status, dict.error]);

  const renderContent = () => {
    if (status === 'loading') {
      return (
        <Card>
          <CardContent className="p-6 text-center">
            <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4" />
            <p className="text-lg">{dict.loading}</p>
          </CardContent>
        </Card>
      );
    }

    if (status === 'unauthenticated') {
      router.push('/login');
      return null;
    }

    if (error) {
      return (
        <>
          <Alert variant="destructive">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
          <div className="mt-4 flex justify-center">
            <Button onClick={() => router.push('/questionnaire')}>
              {dict.backButton}
            </Button>
          </div>
        </>
      );
    }

    return (
      <Card>
        <CardContent className="p-6 text-center">
          <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4" />
          <p className="text-lg">{dict.restoringTitle}</p>
          <p className="text-sm text-gray-500 mt-2">{dict.restoringSubtitle}</p>
        </CardContent>
      </Card>
    );
  };

  return (
    <div className="container mx-auto p-4 max-w-md">{renderContent()}</div>
  );
}
--- End of Content for QuestionnaireRestore.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\AnswerInput.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/AnswerInput.tsx

import React, { useState, useEffect, useCallback } from 'react';
import { Slider } from '@/components/ui/slider';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  X,
  Plus,
  Minus,
  CheckCircle,
  Eraser,
  Info,
  ChevronDown,
  CornerDownRight,
  AlertCircle,
  Sparkles,
  Clock,
  Copy,
  CheckCheck,
  Edit,
  Trash2,
  Target,
  Flame,
  TrendingUp,
} from 'lucide-react';
import InteractiveScale from './InteractiveScale';
import type { AnswerValue, Option, Question } from '../types/types';
import { cn } from '@/lib/utils';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { motion, AnimatePresence } from 'framer-motion';
import { Badge } from '@/components/ui/badge';
import type { AnswerInputDict, InteractiveScaleDict } from '@/types/dictionary';

type ThemeColor = 'sky' | 'rose' | 'purple' | 'teal' | 'amber';

const getThemeConfig = (themeColor: ThemeColor) => {
  const themes = {
    sky: {
      gradient: 'from-cyan-400 via-sky-500 to-blue-500',
      lightBg: 'from-cyan-50 to-blue-50',
      textColor: 'text-sky-900',
      iconColor: 'text-sky-600',
      borderColor: 'border-sky-400',
      ringColor: 'ring-sky-300',
      bgSoft: 'bg-sky-50',
      shadowColor: 'shadow-sky-200/50',
      hoverBorder: 'hover:border-sky-200',
    },
    rose: {
      gradient: 'from-rose-400 via-pink-500 to-red-500',
      lightBg: 'from-rose-50 to-red-50',
      textColor: 'text-rose-900',
      iconColor: 'text-rose-600',
      borderColor: 'border-rose-400',
      ringColor: 'ring-rose-300',
      bgSoft: 'bg-rose-50',
      shadowColor: 'shadow-rose-200/50',
      hoverBorder: 'hover:border-rose-200',
    },
    purple: {
      gradient: 'from-purple-400 via-violet-500 to-indigo-500',
      lightBg: 'from-purple-50 to-indigo-50',
      textColor: 'text-purple-900',
      iconColor: 'text-purple-600',
      borderColor: 'border-purple-400',
      ringColor: 'ring-purple-300',
      bgSoft: 'bg-purple-50',
      shadowColor: 'shadow-purple-200/50',
      hoverBorder: 'hover:border-purple-200',
    },
    teal: {
      gradient: 'from-teal-400 via-emerald-500 to-green-500',
      lightBg: 'from-teal-50 to-emerald-50',
      textColor: 'text-teal-900',
      iconColor: 'text-teal-600',
      borderColor: 'border-teal-400',
      ringColor: 'ring-teal-300',
      bgSoft: 'bg-teal-50',
      shadowColor: 'shadow-teal-200/50',
      hoverBorder: 'hover:border-teal-200',
    },
    amber: {
      gradient: 'from-amber-400 via-orange-500 to-yellow-500',
      lightBg: 'from-amber-50 to-orange-50',
      textColor: 'text-amber-900',
      iconColor: 'text-amber-600',
      borderColor: 'border-amber-400',
      ringColor: 'ring-amber-300',
      bgSoft: 'bg-amber-50',
      shadowColor: 'shadow-amber-200/50',
      hoverBorder: 'hover:border-amber-200',
    },
  };
  return themes[themeColor] || themes.sky;
};

export interface AnswerInputProps {
  locale: string;
  question: Question;
  themeColor?: ThemeColor;
  value?: AnswerValue;
  onChange?: (value: AnswerValue) => void;
  onClear?: () => void;
  className?: string;
  validationError?: string;
  dict: {
    answerInput: AnswerInputDict;
    interactiveScale: InteractiveScaleDict;
  };
}

export default function AnswerInput({
  question,
  value,
  onChange,
  onClear,
  className = '',
  validationError,
  dict,
  locale,
  themeColor = 'sky',
}: AnswerInputProps) {
  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);

  const [internalValue, setInternalValue] = useState<AnswerValue>(value);
  const [error, setError] = useState<string | null>(null);
  const [customValue, setCustomValue] = useState<string>('');
  const [isFocused, setIsFocused] = useState<boolean>(false);
  const [textAreaHeight, setTextAreaHeight] = useState<number>(150);
  const [isCollapsibleOpen, setIsCollapsibleOpen] = useState<boolean>(false);
  const [textCopied, setTextCopied] = useState(false);

  useEffect(() => {
    setInternalValue(value);
    if (typeof value === 'string') {
      if (value.length > 200) setTextAreaHeight(220);
      else if (value.length > 100) setTextAreaHeight(180);
      else setTextAreaHeight(150);
    } else if (value === undefined || value === null) {
      setTextAreaHeight(150);
    }
  }, [value]);

  const handleClear = useCallback(() => {
    let emptyValue: AnswerValue;
    switch (question.type) {
      case 'multiChoice':
      case 'multiSelect':
      case 'multiSelectWithOther':
        emptyValue = [];
        break;
      case 'budgetAllocation':
        emptyValue = {};
        break;
      case 'openText':
        emptyValue = '';
        break;
      case 'scale':
        emptyValue = undefined;
        break;
      case 'singleChoice':
      case 'scenario':
      case 'iconChoice':
      default:
        emptyValue = undefined;
    }
    setInternalValue(emptyValue);
    setCustomValue('');
    setError(null);
    onClear?.();
  }, [question.type, onClear]);

  const handleValueChange = useCallback(
    (newValue: AnswerValue) => {
      if (
        (question.type === 'singleChoice' ||
          question.type === 'iconChoice' ||
          question.type === 'scenario') &&
        newValue === internalValue &&
        !question.isRequired
      ) {
        handleClear();
        return;
      }
      setInternalValue(newValue);
      setError(null);
      onChange?.(newValue);
    },
    [internalValue, onChange, question.isRequired, question.type, handleClear]
  );

  const handleCopyText = useCallback(() => {
    if (typeof internalValue === 'string' && internalValue) {
      navigator.clipboard.writeText(internalValue);
      setTextCopied(true);
      setTimeout(() => setTextCopied(false), 2000);
    }
  }, [internalValue]);

  const optionVariants = {
    initial: { opacity: 0, y: 20, scale: 0.95 },
    animate: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: {
        duration: 0.3,
        ease: [0.25, 1, 0.5, 1],
      },
    },
    exit: {
      opacity: 0,
      scale: 0.95,
      y: -10,
      transition: { duration: 0.2 },
    },
    hover: {
      scale: 1.02,
      y: -2,
      transition: { duration: 0.2, ease: 'easeOut' },
    },
    tap: { scale: 0.98 },
  };

  const rippleVariants = {
    initial: { scale: 0, opacity: 0.5 },
    animate: {
      scale: 2,
      opacity: 0,
      transition: { duration: 0.6, ease: 'easeOut' },
    },
  };

  const renderSingleChoiceOption = (
    choiceOption: Option,
    isSelected: boolean
  ) => (
    <motion.div
      key={choiceOption.value}
      variants={optionVariants}
      initial="initial"
      animate="animate"
      exit="exit"
      whileHover={!isSelected ? 'hover' : undefined}
      whileTap="tap"
      layout
      className="relative"
    >
      <div
        className={cn(
          'group relative p-4 rounded-2xl cursor-pointer transition-all duration-300',
          'border-2 overflow-hidden',
          isSelected
            ? cn(
                'bg-gradient-to-br',
                theme.lightBg,
                theme.borderColor,
                'shadow-lg',
                theme.shadowColor
              )
            : cn(
                'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-md',
                theme.lightBg
                  .replace('from-', 'hover:from-')
                  .replace('to-', 'hover:to-'),
                theme.hoverBorder
              )
        )}
        onMouseDown={(e) => {
          e.preventDefault();
          handleValueChange(choiceOption.value);
        }}
      >
        {!isSelected && (
          <div className="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/40 to-transparent" />
        )}

        <AnimatePresence>
          {isSelected && (
            <motion.div
              variants={rippleVariants}
              initial="initial"
              animate="animate"
              className={cn(
                'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-20',
                theme.gradient
              )}
            />
          )}
        </AnimatePresence>

        <div
          className={cn(
            'flex items-center justify-between gap-3 relative z-10',
            isRTL && 'flex-row-reverse'
          )}
        >
          <div className={cn('flex items-center gap-3 flex-1')}>
            {choiceOption.icon && (
              <motion.div
                animate={{
                  scale: isSelected ? [1, 1.2, 1] : 1,
                  rotate: isSelected ? [0, 5, -5, 0] : 0,
                }}
                transition={{ duration: 0.5 }}
                className={cn(
                  'p-2 rounded-xl transition-colors',
                  isSelected
                    ? cn(
                        'bg-gradient-to-br text-white shadow-md',
                        theme.gradient
                      )
                    : `bg-gray-100 text-gray-600 group-hover:${theme.bgSoft} group-hover:${theme.iconColor}`
                )}
              >
                {choiceOption.icon}
              </motion.div>
            )}
            <span
              className={cn(
                'font-medium transition-colors',
                isSelected
                  ? theme.textColor
                  : cn(
                      'text-gray-700',
                      theme.textColor.replace('text-', 'group-hover:text-')
                    )
              )}
            >
              {choiceOption.text}
            </span>
          </div>

          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: isSelected ? 1 : 0 }}
            className="relative"
          >
            <div
              className={cn(
                'w-7 h-7 rounded-full bg-gradient-to-br flex items-center justify-center shadow-lg',
                theme.gradient
              )}
            >
              <CheckCircle className="w-4 h-4 text-white" fill="white" />
            </div>
          </motion.div>
        </div>

        {isSelected && (
          <motion.div
            initial={{ scale: 0, rotate: -45 }}
            animate={{ scale: 1, rotate: 0 }}
            className={cn(
              'absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-white/20 to-transparent rounded-bl-full opacity-50',
              theme.gradient
            )}
          />
        )}
      </div>
    </motion.div>
  );

  const renderInput = () => {
    switch (question.type) {
      case 'singleChoice':
        return (
          <div className="space-y-3">
            <AnimatePresence mode="popLayout">
              {question.options?.map((optionItem) => {
                const isSelected = internalValue === optionItem.value;
                return renderSingleChoiceOption(optionItem, isSelected);
              })}
            </AnimatePresence>
          </div>
        );

      case 'scale':
        return (
          <div className="relative">
            <div
              className={cn(
                'absolute inset-0 rounded-2xl blur-xl -z-10 bg-gradient-to-r opacity-50',
                theme.lightBg
              )}
            />

            <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border-2 border-gray-100 shadow-lg">
              <InteractiveScale
                min={question.min ?? 1}
                max={question.max ?? 10}
                step={question.step ?? 1}
                value={
                  typeof internalValue === 'number' ? internalValue : undefined
                }
                onChange={(newValue) => handleValueChange(newValue)}
                showLabels={true}
                showValue={true}
                name={question.id}
                required={question.isRequired}
                ariaLabelledby={question.id}
                dict={dict.interactiveScale}
                themeColor={themeColor}
              />
            </div>
          </div>
        );

      case 'multiChoice':
      case 'multiSelect': {
        const selectedValues = Array.isArray(internalValue)
          ? (internalValue as string[])
          : [];
        const progress = question.maxSelections
          ? (selectedValues.length / question.maxSelections) * 100
          : 0;

        return (
          <div className="space-y-4">
            {question.maxSelections && (
              <motion.div
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                className={cn(
                  'bg-gradient-to-r rounded-xl p-4 border',
                  theme.lightBg,
                  theme.borderColor
                )}
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <Target className={cn('w-4 h-4', theme.iconColor)} />
                    <span
                      className={cn('text-sm font-medium', theme.textColor)}
                    >
                      {dict.answerInput.multiSelect.selectedInfo.replace(
                        '{{count}}',
                        selectedValues.length.toString()
                      )}
                    </span>
                  </div>
                  <Badge
                    className={cn(
                      'text-white bg-gradient-to-r',
                      theme.gradient
                    )}
                  >
                    {selectedValues.length}/{question.maxSelections}
                  </Badge>
                </div>
                <Progress value={progress} className="h-2" />
              </motion.div>
            )}

            <div className="space-y-2">
              <AnimatePresence mode="popLayout">
                {question.options?.map((option, index) => {
                  const isSelected = selectedValues.includes(option.value);
                  const isMaxReached =
                    question.maxSelections &&
                    selectedValues.length >= question.maxSelections &&
                    !isSelected;

                  return (
                    <motion.div
                      key={option.value}
                      variants={optionVariants}
                      initial="initial"
                      animate="animate"
                      exit="exit"
                      whileHover={!isMaxReached ? 'hover' : undefined}
                      whileTap={!isMaxReached ? 'tap' : undefined}
                      layout
                      style={{ zIndex: isSelected ? 10 : 1 }}
                    >
                      <div
                        className={cn(
                          'group relative p-4 rounded-2xl cursor-pointer transition-all duration-300',
                          'border-2 overflow-hidden',
                          isSelected
                            ? cn(
                                'bg-gradient-to-r',
                                theme.lightBg,
                                theme.borderColor,
                                'shadow-lg',
                                theme.shadowColor
                              )
                            : isMaxReached
                              ? 'bg-gray-50 border-gray-200 opacity-50 cursor-not-allowed'
                              : cn(
                                  'bg-white border-gray-200 hover:shadow-md',
                                  theme.bgSoft.replace('bg-', 'hover:bg-') +
                                    '/30',
                                  theme.hoverBorder
                                )
                        )}
                        onMouseDown={(e) => {
                          e.preventDefault();
                          if (isMaxReached) {
                            setError(
                              dict.answerInput.multiSelect.maxSelectionError.replace(
                                '{{count}}',
                                String(question.maxSelections)
                              )
                            );
                            setTimeout(() => setError(null), 2500);
                            return;
                          }

                          let newValues: string[];
                          if (isSelected) {
                            newValues = selectedValues.filter(
                              (v) => v !== option.value
                            );
                          } else {
                            newValues = [...selectedValues, option.value];
                          }
                          handleValueChange(newValues);
                        }}
                      >
                        <AnimatePresence>
                          {isSelected && (
                            <motion.div
                              initial={{ scale: 0, opacity: 0 }}
                              animate={{ scale: 1.5, opacity: 0 }}
                              exit={{ scale: 0, opacity: 0 }}
                              transition={{ duration: 0.6 }}
                              className={cn(
                                'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-20',
                                theme.gradient
                              )}
                            />
                          )}
                        </AnimatePresence>

                        <div
                          className={cn(
                            'flex items-center justify-between gap-3 relative z-10',
                            isRTL && 'flex-row-reverse'
                          )}
                        >
                          <div
                            className={cn(
                              'flex items-center gap-3 flex-1',
                              isRTL && 'flex-row-reverse text-right'
                            )}
                          >
                            {option.icon && (
                              <motion.div
                                animate={{ scale: isSelected ? 1.1 : 1 }}
                                className={cn(
                                  'p-2 rounded-xl transition-all',
                                  isSelected
                                    ? cn(
                                        'bg-gradient-to-br text-white',
                                        theme.gradient
                                      )
                                    : cn(
                                        'bg-gray-100 text-gray-600',
                                        theme.bgSoft.replace(
                                          'bg-',
                                          'group-hover:bg-'
                                        )
                                      )
                                )}
                              >
                                {option.icon}
                              </motion.div>
                            )}
                            <span
                              className={cn(
                                'font-medium',
                                isSelected ? theme.textColor : 'text-gray-700'
                              )}
                            >
                              {option.text}
                            </span>
                          </div>

                          <motion.div
                            className={cn(
                              'w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all',
                              isSelected
                                ? cn(
                                    'bg-gradient-to-br',
                                    theme.gradient,
                                    theme.borderColor
                                  )
                                : 'border-gray-300 bg-white'
                            )}
                            whileTap={{ scale: 0.9 }}
                          >
                            <AnimatePresence>
                              {isSelected && (
                                <motion.div
                                  initial={{ scale: 0, rotate: -180 }}
                                  animate={{ scale: 1, rotate: 0 }}
                                  exit={{ scale: 0, rotate: 180 }}
                                >
                                  <CheckCheck
                                    className="w-4 h-4 text-white"
                                    strokeWidth={3}
                                  />
                                </motion.div>
                              )}
                            </AnimatePresence>
                          </motion.div>
                        </div>
                      </div>
                    </motion.div>
                  );
                })}
              </AnimatePresence>
            </div>

            <AnimatePresence>
              {error && (
                <motion.div
                  initial={{ opacity: 0, y: -10, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, scale: 0.95 }}
                  className="flex items-center gap-2 p-3 bg-red-50 border-2 border-red-200 rounded-xl"
                >
                  <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                  <p className="text-sm font-medium text-red-700">{error}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      case 'multiSelectWithOther': {
        const selectedWithOtherValues = Array.isArray(internalValue)
          ? (internalValue as string[])
          : [];
        const customAnswers = selectedWithOtherValues.filter((v) =>
          v.startsWith('custom:')
        );
        const predefinedAnswers = selectedWithOtherValues.filter(
          (v) => !v.startsWith('custom:')
        );
        const isCustomValueEmpty = !customValue.trim();
        const isMaxLengthReached =
          question.maxSelections !== undefined &&
          selectedWithOtherValues.length >= question.maxSelections;

        return (
          <div className="space-y-4">
            <div className="space-y-2">
              {question.options?.map((option) => {
                if (option.value === 'other') return null;
                const isSelected = predefinedAnswers.includes(option.value);

                return (
                  <motion.div
                    key={option.value}
                    variants={optionVariants}
                    initial="initial"
                    animate="animate"
                    whileHover="hover"
                    whileTap="tap"
                    layout
                  >
                    <div
                      className={cn(
                        'p-4 rounded-2xl cursor-pointer border-2 transition-all',
                        isSelected
                          ? cn(
                              'bg-gradient-to-r shadow-lg',
                              theme.lightBg,
                              theme.borderColor
                            )
                          : cn(
                              'bg-white border-gray-200',
                              theme.bgSoft.replace('bg-', 'hover:bg-') + '/30',
                              theme.hoverBorder
                            )
                      )}
                      onMouseDown={(e) => {
                        e.preventDefault();
                        if (isMaxLengthReached && !isSelected) {
                          setError(
                            dict.answerInput.multiSelect.maxSelectionError.replace(
                              '{{count}}',
                              String(question.maxSelections)
                            )
                          );
                          setTimeout(() => setError(null), 2500);
                          return;
                        }

                        let newValues: string[];
                        if (isSelected) {
                          newValues = predefinedAnswers.filter(
                            (v) => v !== option.value
                          );
                        } else {
                          newValues = [...predefinedAnswers, option.value];
                        }
                        handleValueChange([...newValues, ...customAnswers]);
                      }}
                    >
                      <div
                        className={cn(
                          'flex items-center justify-between',
                          isRTL && 'flex-row-reverse'
                        )}
                      >
                        <div
                          className={cn(
                            'flex items-center gap-3',
                            isRTL && 'flex-row-reverse'
                          )}
                        >
                          {option.icon && (
                            <div
                              className={cn(
                                'p-2 rounded-xl',
                                isSelected
                                  ? cn(
                                      'text-white bg-gradient-to-r',
                                      theme.gradient
                                    )
                                  : 'bg-gray-100 text-gray-600'
                              )}
                            >
                              {option.icon}
                            </div>
                          )}
                          <span
                            className={cn(
                              'font-medium',
                              isSelected ? theme.textColor : 'text-gray-700'
                            )}
                          >
                            {option.text}
                          </span>
                        </div>
                        <motion.div
                          className={cn(
                            'w-6 h-6 rounded-lg border-2 flex items-center justify-center',
                            isSelected
                              ? cn(
                                  'bg-gradient-to-r',
                                  theme.gradient,
                                  theme.borderColor
                                )
                              : 'border-gray-300'
                          )}
                        >
                          {isSelected && (
                            <CheckCheck className="w-4 h-4 text-white" />
                          )}
                        </motion.div>
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </div>

            {/* Custom input section */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="relative"
            >
              <div className="absolute inset-0 bg-gradient-to-r from-purple-100/50 to-pink-100/50 rounded-2xl blur-xl" />
              <div className="relative bg-white rounded-2xl p-5 border-2 border-dashed border-purple-300 space-y-3">
                <div className="flex items-center gap-2 text-purple-900">
                  <Sparkles className="w-5 h-5" />
                  <Label className="font-semibold">
                    {dict.answerInput.multiSelectWithOther.addOtherOptionLabel}
                  </Label>
                </div>

                <div className="flex gap-2">
                  <Input
                    value={customValue}
                    onChange={(e) => setCustomValue(e.target.value)}
                    placeholder={
                      dict.answerInput.multiSelectWithOther
                        .otherOptionPlaceholder
                    }
                    className="flex-1 border-2 border-purple-200 focus:border-purple-400 rounded-xl"
                    disabled={isMaxLengthReached && isCustomValueEmpty}
                  />
                  <Button
                    type="button"
                    size="sm"
                    onMouseDown={(e) => {
                      e.preventDefault();
                      if (!isCustomValueEmpty) {
                        if (isMaxLengthReached) {
                          setError(
                            dict.answerInput.multiSelect.maxSelectionError.replace(
                              '{{count}}',
                              String(question.maxSelections)
                            )
                          );
                          setTimeout(() => setError(null), 2500);
                          return;
                        }
                        const newCustomAnswer = `custom:${customValue.trim()}`;
                        if (!customAnswers.includes(newCustomAnswer)) {
                          handleValueChange([
                            ...predefinedAnswers,
                            ...customAnswers,
                            newCustomAnswer,
                          ]);
                          setCustomValue('');
                        } else {
                          setError(
                            dict.answerInput.multiSelectWithOther.errorExists
                          );
                          setTimeout(() => setError(null), 2500);
                        }
                      }
                    }}
                    disabled={isCustomValueEmpty || isMaxLengthReached}
                    className="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
                  >
                    <Plus className="w-4 h-4 mr-1" />
                    {dict.answerInput.multiSelectWithOther.addButton}
                  </Button>
                </div>

                <AnimatePresence>
                  {customAnswers.length > 0 && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      exit={{ opacity: 0, height: 0 }}
                      className="space-y-2 pt-2"
                    >
                      <Label className="text-xs text-purple-700 flex items-center gap-1">
                        <Edit className="w-3 h-3" />
                        {
                          dict.answerInput.multiSelectWithOther
                            .addedAnswersLabel
                        }
                      </Label>
                      {customAnswers.map((customVal, index) => (
                        <motion.div
                          key={index}
                          initial={{ opacity: 0, x: -20 }}
                          animate={{ opacity: 1, x: 0 }}
                          exit={{ opacity: 0, x: 20 }}
                          className="flex items-center justify-between p-3 bg-purple-50 rounded-xl border border-purple-200"
                        >
                          <div className="flex items-center gap-2">
                            <CornerDownRight className="w-4 h-4 text-purple-500" />
                            <span className="text-sm font-medium text-purple-900">
                              {customVal.replace('custom:', '')}
                            </span>
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="h-7 w-7 text-purple-400 hover:text-red-500 hover:bg-red-50"
                            onMouseDown={(e) => {
                              e.preventDefault();
                              const newValues = selectedWithOtherValues.filter(
                                (v) => v !== customVal
                              );
                              handleValueChange(newValues);
                            }}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </motion.div>
                      ))}
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </motion.div>

            {error && (
              <motion.div
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                className="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-xl"
              >
                <AlertCircle className="w-5 h-5 text-red-500" />
                <p className="text-sm text-red-700">{error}</p>
              </motion.div>
            )}
          </div>
        );
      }

      case 'scenario':
        return (
          <div className="space-y-3">
            {question.options?.map((option, index) => {
              const optionValue = option.value || option.text;
              const isSelected = internalValue === optionValue;

              return (
                <motion.div
                  key={index}
                  variants={optionVariants}
                  initial="initial"
                  animate="animate"
                  whileHover="hover"
                  whileTap="tap"
                  layout
                >
                  <div
                    className={cn(
                      'relative p-5 rounded-2xl cursor-pointer border-2 transition-all overflow-hidden',
                      isSelected
                        ? cn(
                            'bg-gradient-to-br shadow-xl',
                            theme.lightBg,
                            theme.borderColor,
                            theme.shadowColor
                          )
                        : cn(
                            'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-lg',
                            theme.lightBg
                              .replace('from-', 'hover:from-')
                              .replace('to-', 'hover:to-'),
                            theme.hoverBorder
                          )
                    )}
                    onMouseDown={(e) => {
                      e.preventDefault();
                      handleValueChange(optionValue);
                    }}
                  >
                    <div
                      className={cn(
                        'absolute top-0 right-0 w-32 h-32 bg-gradient-to-br to-transparent rounded-bl-full opacity-20',
                        theme.gradient
                      )}
                    />

                    <div className="relative z-10">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div
                            className={cn(
                              'font-semibold text-lg mb-2 transition-colors',
                              isSelected ? theme.textColor : 'text-gray-800'
                            )}
                          >
                            {option.text}
                          </div>
                          {option.description && (
                            <p
                              className={cn(
                                'text-sm leading-relaxed transition-colors',
                                isSelected ? 'text-gray-700' : 'text-gray-600'
                              )}
                            >
                              {option.description}
                            </p>
                          )}
                        </div>

                        <motion.div
                          initial={{ scale: 0 }}
                          animate={{ scale: isSelected ? 1 : 0 }}
                        >
                          <div
                            className={cn(
                              'w-8 h-8 rounded-full bg-gradient-to-br flex items-center justify-center shadow-lg',
                              theme.gradient
                            )}
                          >
                            <CheckCircle
                              className="w-5 h-5 text-white"
                              fill="white"
                            />
                          </div>
                        </motion.div>
                      </div>
                    </div>

                    {isSelected && (
                      <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        className={cn(
                          'absolute inset-0 rounded-2xl bg-gradient-to-r opacity-10',
                          theme.gradient
                        )}
                      />
                    )}
                  </div>
                </motion.div>
              );
            })}
          </div>
        );

      case 'iconChoice':
        return (
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {question.options?.map((option) => {
              const isSelected = internalValue === option.value;

              return (
                <TooltipProvider key={option.value} delayDuration={200}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <motion.div
                        variants={optionVariants}
                        initial="initial"
                        animate="animate"
                        whileHover="hover"
                        whileTap="tap"
                        onMouseDown={(e) => {
                          e.preventDefault();
                          handleValueChange(option.value);
                        }}
                      >
                        <Card
                          className={cn(
                            'relative p-6 cursor-pointer transition-all min-h-[140px]',
                            'flex flex-col items-center justify-center gap-3 text-center overflow-hidden',
                            'border-2',
                            isSelected
                              ? cn(
                                  'bg-gradient-to-br shadow-xl',
                                  theme.lightBg,
                                  theme.borderColor,
                                  theme.shadowColor
                                )
                              : cn(
                                  'bg-white hover:bg-gradient-to-br border-gray-200 hover:shadow-lg',
                                  theme.lightBg
                                    .replace('from-', 'hover:from-')
                                    .replace('to-', 'hover:to-'),
                                  theme.hoverBorder
                                )
                          )}
                        >
                          <AnimatePresence>
                            {isSelected && (
                              <motion.div
                                initial={{ scale: 0, opacity: 0 }}
                                animate={{ scale: 2, opacity: 0.3 }}
                                exit={{ scale: 0, opacity: 0 }}
                                transition={{ duration: 0.6 }}
                                className={cn(
                                  'absolute inset-0 bg-gradient-to-br blur-2xl',
                                  theme.gradient
                                )}
                              />
                            )}
                          </AnimatePresence>

                          <AnimatePresence>
                            {isSelected && (
                              <motion.div
                                initial={{ scale: 0, rotate: -180 }}
                                animate={{ scale: 1, rotate: 0 }}
                                exit={{ scale: 0, rotate: 180 }}
                                className={cn(
                                  'absolute -top-2 -right-2 bg-gradient-to-br text-white rounded-full p-1.5 shadow-lg z-10',
                                  theme.gradient
                                )}
                              >
                                <CheckCircle className="h-4 w-4" fill="white" />
                              </motion.div>
                            )}
                          </AnimatePresence>

                          <div className="relative z-10">
                            <motion.div
                              animate={{
                                scale: isSelected ? [1, 1.2, 1] : 1,
                                rotate: isSelected ? [0, 10, -10, 0] : 0,
                              }}
                              transition={{ duration: 0.5 }}
                              className={cn(
                                'text-5xl mb-3 transition-all',
                                isSelected
                                  ? 'drop-shadow-lg'
                                  : 'opacity-70 group-hover:opacity-100'
                              )}
                            >
                              {option.icon}
                            </motion.div>

                            <span
                              className={cn(
                                'text-sm font-semibold transition-colors',
                                isSelected ? theme.textColor : 'text-gray-700'
                              )}
                            >
                              {option.text}
                            </span>
                          </div>
                        </Card>
                      </motion.div>
                    </TooltipTrigger>
                    {option.description && (
                      <TooltipContent
                        side="top"
                        className="max-w-xs bg-white/95 backdrop-blur-sm"
                      >
                        <p className="text-sm">{option.description}</p>
                      </TooltipContent>
                    )}
                  </Tooltip>
                </TooltipProvider>
              );
            })}
          </div>
        );

      case 'openText': {
        let textValue = '';
        if (typeof internalValue === 'string') {
          textValue = internalValue;
        } else if (
          typeof internalValue === 'object' &&
          internalValue !== null &&
          !Array.isArray(internalValue) &&
          'text' in internalValue
        ) {
          textValue = String(internalValue.text || '');
        }

        const hasMinLength =
          question.minLength !== undefined && question.minLength > 0;
        const hasMaxLength =
          question.maxLength !== undefined && question.maxLength > 0;
        const isMinLengthMet =
          !hasMinLength || textValue.length >= (question.minLength ?? 0);
        const isCloseToMax =
          hasMaxLength && textValue.length > (question.maxLength ?? 0) * 0.85;
        const lengthExceeded =
          hasMaxLength && textValue.length > (question.maxLength ?? 0);
        const completionPercentage = hasMinLength
          ? Math.min(
              100,
              Math.round((textValue.length / (question.minLength ?? 1)) * 100)
            )
          : 0;

        const wordCount = textValue.trim()
          ? textValue.trim().split(/\s+/).length
          : 0;
        const estimatedReadTime = Math.max(1, Math.ceil(wordCount / 200));

        return (
          <div className="space-y-4">
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex items-center justify-between gap-4 flex-wrap"
            >
              <div className="flex items-center gap-3">
                <Badge
                  variant="outline"
                  className={cn(
                    'text-xs',
                    theme.bgSoft,
                    theme.textColor.replace('900', '700'),
                    theme.borderColor
                  )}
                >
                  <Edit className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.wordCount.replace(
                    '{{count}}',
                    wordCount.toString()
                  )}
                </Badge>
                {wordCount > 0 && (
                  <Badge
                    variant="outline"
                    className="bg-purple-50 text-purple-700 border-purple-200"
                  >
                    <Clock className="w-3 h-3 mr-1" />
                    {dict.answerInput.openText.readingTime.replace(
                      '{{count}}',
                      estimatedReadTime.toString()
                    )}
                  </Badge>
                )}
              </div>

              {hasMinLength && (
                <Badge
                  className={cn(
                    'transition-all',
                    isMinLengthMet
                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                      : completionPercentage > 50
                        ? 'bg-gradient-to-r from-amber-500 to-orange-600 text-white'
                        : 'bg-gradient-to-r from-gray-400 to-gray-500 text-white'
                  )}
                >
                  {dict.answerInput.openText.completionPercentage.replace(
                    '{{count}}',
                    completionPercentage.toString()
                  )}
                </Badge>
              )}
            </motion.div>

            <div className="relative">
              <div
                className={cn(
                  'absolute inset-0 rounded-2xl blur-2xl -z-10 bg-gradient-to-br opacity-50',
                  theme.lightBg
                )}
              />

              <div
                className={cn(
                  'relative rounded-2xl transition-all duration-300 overflow-hidden',
                  'border-2',
                  isFocused
                    ? cn(
                        theme.borderColor,
                        'shadow-xl',
                        theme.shadowColor,
                        'ring-4',
                        theme.ringColor
                      )
                    : lengthExceeded
                      ? 'border-red-400 shadow-lg shadow-red-200/50'
                      : isCloseToMax
                        ? 'border-amber-400 shadow-lg shadow-amber-200/50'
                        : cn('border-gray-200 shadow-md', theme.hoverBorder)
                )}
              >
                <Textarea
                  value={textValue}
                  onChange={(e) => handleValueChange(e.target.value)}
                  onFocus={() => setIsFocused(true)}
                  onBlur={() => setIsFocused(false)}
                  placeholder={
                    question.placeholder ||
                    dict.answerInput.openText.placeholder
                  }
                  className={cn(
                    'resize-y border-0 focus-visible:ring-0 w-full min-h-[180px] text-base leading-relaxed',
                    'bg-white/80 backdrop-blur-sm relative z-10',
                    textValue.length > 0 ? (isRTL ? 'pl-14' : 'pr-14') : '',
                    isRTL ? 'py-4 pr-4' : 'py-4 pl-4'
                  )}
                  style={{ height: `${textAreaHeight}px` }}
                  aria-label={question.question}
                  aria-invalid={
                    (!isMinLengthMet && question.isRequired) || lengthExceeded
                  }
                />

                {textValue.length > 0 && (
                  <div
                    className={cn(
                      'absolute top-3 flex flex-col gap-2 z-20',
                      isRTL ? 'left-3' : 'right-3'
                    )}
                  >
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <motion.button
                            whileHover={{ scale: 1.1 }}
                            whileTap={{ scale: 0.9 }}
                            className={cn(
                              'p-2 rounded-xl transition-all shadow-md',
                              textCopied
                                ? 'bg-gradient-to-br from-green-500 to-emerald-600 text-white'
                                : `bg-white text-gray-600 hover:${theme.bgSoft} hover:${theme.iconColor}`
                            )}
                            onMouseDown={(e) => {
                              e.preventDefault();
                              handleCopyText();
                            }}
                          >
                            {textCopied ? (
                              <CheckCheck className="h-4 w-4" />
                            ) : (
                              <Copy className="h-4 w-4" />
                            )}
                          </motion.button>
                        </TooltipTrigger>
                        <TooltipContent>
                          <p>
                            {textCopied
                              ? dict.answerInput.tooltips.copied
                              : dict.answerInput.tooltips.copy}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>

                    {!question.isRequired && (
                      <TooltipProvider>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <motion.button
                              whileHover={{ scale: 1.1 }}
                              whileTap={{ scale: 0.9 }}
                              className="p-2 rounded-xl bg-white text-gray-600 hover:bg-red-50 hover:text-red-600 transition-all shadow-md"
                              onMouseDown={(e) => {
                                e.preventDefault();
                                handleClear();
                              }}
                            >
                              <Eraser className="h-4 w-4" />
                            </motion.button>
                          </TooltipTrigger>
                          <TooltipContent>
                            <p>{dict.answerInput.tooltips.clearText}</p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                    )}
                  </div>
                )}
              </div>
            </div>

            {hasMinLength && question.isRequired && (
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                className="space-y-2"
              >
                <div className="flex items-center justify-between text-sm">
                  <div className="flex items-center gap-2">
                    {isMinLengthMet ? (
                      <>
                        <CheckCircle className="w-4 h-4 text-green-500" />
                        <span className="text-green-700 font-medium">
                          {dict.answerInput.openText.minLengthMet}
                        </span>
                      </>
                    ) : (
                      <>
                        <TrendingUp className="w-4 h-4 text-amber-500" />
                        <span className="text-amber-700 font-medium">
                          {dict.answerInput.openText.minLengthRequired.replace(
                            '{{count}}',
                            (
                              (question.minLength ?? 0) - textValue.length
                            ).toString()
                          )}
                        </span>
                      </>
                    )}
                  </div>
                  <span
                    className={cn(
                      'font-bold text-lg',
                      isMinLengthMet ? 'text-green-600' : 'text-amber-600'
                    )}
                  >
                    {completionPercentage}%
                  </span>
                </div>

                <div className="relative h-3 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${completionPercentage}%` }}
                    transition={{ duration: 0.5, ease: 'easeOut' }}
                    className={cn(
                      'absolute inset-y-0 left-0 rounded-full',
                      'bg-gradient-to-r',
                      isMinLengthMet
                        ? 'from-green-500 to-emerald-600'
                        : completionPercentage > 50
                          ? 'from-amber-500 to-orange-600'
                          : 'from-gray-400 to-gray-500'
                    )}
                  />

                  {!isMinLengthMet && completionPercentage > 0 && (
                    <motion.div
                      className="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent"
                      animate={{ x: ['-100%', '200%'] }}
                      transition={{
                        duration: 2,
                        repeat: Infinity,
                        ease: 'linear',
                      }}
                    />
                  )}
                </div>
              </motion.div>
            )}

            <div className="flex flex-wrap gap-2">
              {hasMinLength && (
                <Badge
                  variant="outline"
                  className={cn(
                    'border-2',
                    !isMinLengthMet && question.isRequired
                      ? 'border-red-300 bg-red-50 text-red-700'
                      : cn(
                          theme.borderColor,
                          theme.bgSoft,
                          theme.textColor.replace('900', '700')
                        )
                  )}
                >
                  <Info className="w-3 h-3 mr-1" />
                  {question.isRequired
                    ? dict.answerInput.openText.minLengthInfoRequired.replace(
                        '{{count}}',
                        String(question.minLength ?? 0)
                      )
                    : dict.answerInput.openText.minLengthInfoRecommended.replace(
                        '{{count}}',
                        String(question.minLength ?? 0)
                      )}
                </Badge>
              )}

              {lengthExceeded && (
                <Badge className="bg-gradient-to-r from-red-500 to-rose-600 text-white animate-pulse">
                  <AlertCircle className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.maxLengthExceeded}
                </Badge>
              )}

              {textValue.length > 50 && !lengthExceeded && (
                <Badge
                  variant="outline"
                  className="border-green-300 bg-green-50 text-green-700"
                >
                  <Flame className="w-3 h-3 mr-1" />
                  {dict.answerInput.openText.writingGreat}
                </Badge>
              )}
            </div>

            {question.description && (
              <Collapsible
                open={isCollapsibleOpen}
                onOpenChange={setIsCollapsibleOpen}
              >
                <CollapsibleTrigger asChild>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="w-full flex items-center justify-between px-4 py-3 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 rounded-xl transition-all border-2 border-dashed border-purple-200"
                  >
                    <div className="flex items-center gap-2">
                      <Sparkles className="h-5 w-5 text-purple-500" />
                      <span className="font-semibold text-purple-900">
                        {dict.answerInput.openText.tipsButton}
                      </span>
                    </div>
                    <motion.div
                      animate={{ rotate: isCollapsibleOpen ? 180 : 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <ChevronDown className="h-5 w-5 text-purple-500" />
                    </motion.div>
                  </Button>
                </CollapsibleTrigger>
                <CollapsibleContent>
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="mt-3 p-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200"
                  >
                    <div className="prose prose-sm max-w-none text-purple-900">
                      {question.description}
                    </div>
                  </motion.div>
                </CollapsibleContent>
              </Collapsible>
            )}
          </div>
        );
      }

      case 'budgetAllocation': {
        const budgetValues = (internalValue as Record<string, number>) || {};
        const totalPointsRequired = question.totalPoints ?? 100;

        // Calculate totals
        const totalAllocated = Object.values(budgetValues).reduce(
          (sum, val) => sum + (Number(val) || 0),
          0
        );
        const remaining = totalPointsRequired - totalAllocated;

        // Determine status color
        let statusColor = 'text-blue-600';
        let statusBg = 'bg-blue-100';
        let statusBorder = 'border-blue-200';

        if (remaining === 0) {
          statusColor = 'text-green-600';
          statusBg = 'bg-green-100';
          statusBorder = 'border-green-200';
        } else if (remaining < 0) {
          statusColor = 'text-red-600';
          statusBg = 'bg-red-100';
          statusBorder = 'border-red-200';
        }

        return (
          <div className="space-y-5">
            {/* 1. Cleaner Summary Bar */}
            <div
              className={cn(
                'sticky top-0 z-20 flex items-center justify-between p-3 rounded-xl border-2 backdrop-blur-md shadow-sm transition-colors duration-300',
                statusBg,
                statusBorder
              )}
            >
              <div className="flex items-center gap-2">
                <div
                  className={cn('p-1.5 rounded-full bg-white/50', statusColor)}
                >
                  {remaining === 0 ? (
                    <CheckCircle className="w-5 h-5" />
                  ) : (
                    <Target className="w-5 h-5" />
                  )}
                </div>
                <span className={cn('font-bold text-sm', statusColor)}>
                  {remaining === 0
                    ? dict.answerInput.budgetAllocation.statusComplete
                    : remaining > 0
                      ? dict.answerInput.budgetAllocation.statusRemaining.replace(
                          '{{count}}',
                          remaining.toString()
                        )
                      : dict.answerInput.budgetAllocation.statusExceeded.replace(
                          '{{count}}',
                          Math.abs(remaining).toString()
                        )}
                </span>
              </div>
              <div className="text-xs font-semibold px-2 py-1 bg-white/60 rounded-md">
                {totalAllocated} / {totalPointsRequired}
              </div>
            </div>

            {/* 2. Simplified Category List */}
            <div className="grid gap-3">
              {question.categories?.map((category, index) => {
                const currentValue = budgetValues[category.value] || 0;

                const maxAllowed = Math.min(
                  totalPointsRequired,
                  currentValue + Math.max(0, remaining)
                );

                return (
                  <div
                    key={category.value}
                    className={cn(
                      'bg-white rounded-xl border-2 p-3 sm:p-4 transition-all duration-200',
                      currentValue > 0
                        ? 'border-blue-200 shadow-sm'
                        : 'border-gray-100 hover:border-gray-200'
                    )}
                  >
                    {/* Header: Label + Controls */}
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2 text-gray-700">
                        {category.icon && (
                          <span className="text-gray-400">{category.icon}</span>
                        )}
                        <span className="font-medium text-sm sm:text-base">
                          {category.label}
                        </span>
                      </div>

                      {/* Manual Controls (+/- buttons) */}
                      <div className="flex items-center gap-1">
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-7 w-7 rounded-full hover:bg-gray-100 text-gray-500"
                          onClick={() => {
                            const newVal = Math.max(0, currentValue - 1);
                            handleValueChange({
                              ...budgetValues,
                              [category.value]: newVal,
                            });
                          }}
                          disabled={currentValue <= 0}
                        >
                          <Minus className="w-3 h-3" />
                        </Button>

                        <div
                          className={cn(
                            'min-w-[40px] text-center font-bold text-sm py-1 px-2 rounded-md',
                            currentValue > 0
                              ? 'bg-blue-50 text-blue-700'
                              : 'bg-gray-100 text-gray-500'
                          )}
                        >
                          {currentValue}
                        </div>

                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-7 w-7 rounded-full hover:bg-gray-100 text-gray-500"
                          onClick={() => {
                            if (remaining > 0) {
                              const newVal = currentValue + 1;
                              handleValueChange({
                                ...budgetValues,
                                [category.value]: newVal,
                              });
                            }
                          }}
                          disabled={remaining <= 0}
                        >
                          <Plus className="w-3 h-3" />
                        </Button>
                      </div>
                    </div>

                    {/* Slider */}
                    <Slider
                      value={[currentValue]}
                      min={0}
                      max={maxAllowed}
                      step={1}
                      onValueChange={(val) => {
                        handleValueChange({
                          ...budgetValues,
                          [category.value]: val[0],
                        });
                      }}
                      className={cn(
                        'cursor-pointer',
                        currentValue > 0
                          ? '[&>.bg-primary]:bg-blue-500'
                          : '[&>.bg-primary]:bg-gray-300'
                      )}
                    />
                  </div>
                );
              })}
            </div>
            {/* Reset Button */}
            {totalAllocated > 0 && (
              <div className="flex justify-end">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={handleClear}
                  className="text-gray-400 hover:text-red-500 text-xs gap-1"
                >
                  <Trash2 className="w-3 h-3" />
                  {dict.answerInput.budgetAllocation.resetButton}
                </Button>
              </div>
            )}

            <AnimatePresence>
              {validationError && (
                <motion.div
                  initial={{ opacity: 0, y: -10, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, y: -10, scale: 0.95 }}
                  className="flex items-center gap-3 p-4 bg-red-50 border-2 border-red-200 rounded-xl"
                >
                  <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                  <p className="text-sm font-medium text-red-700">
                    {validationError}
                  </p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      default:
        console.warn('Unsupported question type:', question.type);
        return (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="p-6 bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-2xl"
          >
            <div className="flex items-start gap-3">
              <div className="p-2 bg-amber-500 rounded-lg">
                <AlertCircle className="w-5 h-5 text-white" />
              </div>
              <div>
                <p className="font-bold text-amber-900 mb-1">
                  {dict.answerInput.unsupportedType.replace(
                    '{{type}}',
                    question.type
                  )}
                </p>
                <p className="text-sm text-amber-700">
                  {dict.answerInput.supportContactMessage}
                </p>
              </div>
            </div>
          </motion.div>
        );
    }
  };

  return (
    <div className={cn('space-y-4', className)}>
      {renderInput()}

      <style>{`
        @keyframes shimmer {
          0% {
            transform: translateX(-100%);
          }
          100% {
            transform: translateX(100%);
          }
        }

        @keyframes float {
          0%, 100% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(-10px);
          }
        }

        @keyframes pulse-glow {
          0%, 100% {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
          }
          50% {
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
          }
        }

        .animate-float {
          animation: float 3s ease-in-out infinite;
        }

        .animate-pulse-glow {
          animation: pulse-glow 2s ease-in-out infinite;
        }
      `}</style>
    </div>
  );
}
--- End of Content for AnswerInput.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\InteractiveScale.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/InteractiveScale.tsx
'use client';

import React, { useState, useCallback, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Star, Heart, ThumbsUp } from 'lucide-react';
import type { InteractiveScaleDict } from '@/types/dictionary';

// הגדרות הצבעים הדינמיות עבור כל עולם
type ThemeColor = 'sky' | 'rose' | 'purple' | 'teal' | 'amber';

const getThemeConfig = (themeColor: ThemeColor) => {
  const themes = {
    sky: {
      gradientStyle:
        'linear-gradient(to right, rgb(34 211 238), rgb(14 165 233), rgb(59 130 246))',
    },
    rose: {
      gradientStyle:
        'linear-gradient(to right, rgb(251 113 133), rgb(236 72 153), rgb(239 68 68))',
    },
    purple: {
      gradientStyle:
        'linear-gradient(to right, rgb(192 132 252), rgb(139 92 246), rgb(99 102 241))',
    },
    teal: {
      gradientStyle:
        'linear-gradient(to right, rgb(45 212 191), rgb(16 185 129), rgb(34 197 94))',
    },
    amber: {
      gradientStyle:
        'linear-gradient(to right, rgb(251 191 36), rgb(249 115 22), rgb(234 179 8))',
    },
  };
  return themes[themeColor] || themes.sky;
};

interface ScaleOption {
  value: number;
  label: string;
  description?: string;
  icon?: React.ReactNode;
}

interface InteractiveScaleProps {
  min?: number;
  max?: number;
  step?: number;
  defaultValue?: number;
  value?: number;
  onChange?: (value: number) => void;
  onComplete?: (value: number) => void;
  labels?: { min: string; max: string; middle?: string };
  descriptions?: { min?: string; max?: string; middle?: string };
  options?: ScaleOption[];
  mode?: 'numeric' | 'icons' | 'hearts' | 'stars' | 'thumbs';
  size?: 'sm' | 'md' | 'lg';
  showLabels?: boolean;
  showValue?: boolean;
  showTooltips?: boolean;
  isDisabled?: boolean;
  className?: string;
  required?: boolean;
  name?: string;
  error?: string;
  ariaLabelledby?: string;
  dict: InteractiveScaleDict;
  themeColor?: ThemeColor;
}

const defaultIcons = { stars: Star, hearts: Heart, thumbs: ThumbsUp };

export default function InteractiveScale({
  min = 1,
  max = 10,
  step = 1,
  defaultValue,
  value: controlledValue,
  onChange,
  onComplete,
  labels,
  options,
  mode = 'numeric',
  size = 'md',
  showLabels = true,
  showValue = true,
  showTooltips = true,
  isDisabled = false,
  className = '',
  required = false,
  name,
  error,
  dict,
  themeColor = 'sky',
}: InteractiveScaleProps) {
  const [internalValue, setInternalValue] = useState<number | null>(
    defaultValue || null
  );
  const [hoveredValue, setHoveredValue] = useState<number | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  const theme = getThemeConfig(themeColor);

  const value = controlledValue !== undefined ? controlledValue : internalValue;

  const handleValueChange = useCallback(
    (newValue: number) => {
      if (!isDisabled) {
        setInternalValue(newValue);
        onChange?.(newValue);
      }
    },
    [isDisabled, onChange]
  );

  const handleClick = useCallback(
    (clickedValue: number) => {
      handleValueChange(clickedValue);
      onComplete?.(clickedValue);
    },
    [handleValueChange, onComplete]
  );

  const handleKeyPress = useCallback(
    (event: React.KeyboardEvent, itemValue: number) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handleClick(itemValue);
      }
    },
    [handleClick]
  );

  const handleMouseMove = useCallback(
    (event: MouseEvent) => {
      if (isDragging && containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const width = rect.width;
        const percentage = Math.max(0, Math.min(1, x / width));
        const range = max - min;
        const newValue = Math.round((percentage * range) / step) * step + min;
        handleValueChange(newValue);
        setHoveredValue(newValue);
      }
    },
    [isDragging, min, max, step, handleValueChange]
  );

  const handleTouchMove = useCallback(
    (event: TouchEvent) => {
      if (isDragging && containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        const touch = event.touches[0];
        const x = touch.clientX - rect.left;
        const width = rect.width;
        const percentage = Math.max(0, Math.min(1, x / width));
        const range = max - min;
        const newValue = Math.round((percentage * range) / step) * step + min;
        handleValueChange(newValue);
        setHoveredValue(newValue);
      }
    },
    [isDragging, min, max, step, handleValueChange]
  );

  useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('touchmove', handleTouchMove);
      window.addEventListener('mouseup', () => setIsDragging(false));
      window.addEventListener('touchend', () => setIsDragging(false));
    }
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('touchmove', handleTouchMove);
      window.removeEventListener('mouseup', () => setIsDragging(false));
      window.removeEventListener('touchend', () => setIsDragging(false));
    };
  }, [isDragging, handleMouseMove, handleTouchMove]);

  const getScaleItems = () => {
    if (options) return options;
    const items: ScaleOption[] = [];
    for (let i = min; i <= max; i += step) {
      const item: ScaleOption = { value: i, label: i.toString() };
      if (mode !== 'numeric') {
        const Icon = defaultIcons[mode as keyof typeof defaultIcons];
        item.icon = <Icon className="w-4 h-4 sm:w-5 sm:h-5" />;
      }
      items.push(item);
    }
    return items;
  };

  const scaleItems = getScaleItems();
  const activeValue = hoveredValue !== null ? hoveredValue : value;

  // גודלים רספונסיביים - קטן יותר במובייל
  const sizeClasses = {
    sm: 'h-7 sm:h-8 text-xs sm:text-sm',
    md: 'h-8 sm:h-10 text-sm sm:text-base',
    lg: 'h-10 sm:h-12 text-base sm:text-lg',
  };

  return (
    <div
      className={cn(
        'relative space-y-2 w-full',
        isDisabled && 'opacity-50 cursor-not-allowed',
        className
      )}
    >
      <div
        ref={containerRef}
        className={cn(
          'relative flex items-center justify-between',
          // רווחים דינמיים לפי מספר הפריטים
          scaleItems.length <= 5 ? 'gap-2 sm:gap-3' : 'gap-0.5 sm:gap-1',
          sizeClasses[size]
        )}
        onMouseDown={() => !isDisabled && setIsDragging(true)}
        onTouchStart={() => !isDisabled && setIsDragging(true)}
      >
        {showLabels && labels && (
          <div className="absolute -top-6 left-0 right-0 flex justify-between text-xs sm:text-sm text-gray-500 px-1">
            <span className="text-right">{labels.min}</span>
            {labels.middle && (
              <span className="hidden sm:inline">{labels.middle}</span>
            )}
            <span className="text-left">{labels.max}</span>
          </div>
        )}
        <div className="relative flex-1 flex items-center justify-between w-full">
          <AnimatePresence>
            {scaleItems.map((item) => (
              <TooltipProvider key={item.value}>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <motion.button
                      type="button"
                      style={
                        activeValue !== null && item.value <= activeValue
                          ? { background: theme.gradientStyle }
                          : undefined
                      }
                      className={cn(
                        'relative flex items-center justify-center',
                        // גודלים דינמיים לפי מספר פריטים
                        scaleItems.length <= 5
                          ? 'w-10 h-10 sm:w-12 sm:h-12'
                          : scaleItems.length <= 7
                            ? 'w-8 h-8 sm:w-10 sm:h-10'
                            : 'w-6 h-6 sm:w-8 sm:h-8',
                        'rounded-full transition-all duration-200',
                        'focus:outline-none focus:ring-2 focus:ring-offset-1 sm:focus:ring-offset-2',
                        'active:scale-95 touch-manipulation',
                        // טקסט קטן יותר במובייל לסקיילות ארוכות
                        scaleItems.length > 7 && 'text-xs sm:text-sm',
                        activeValue !== null &&
                          item.value <= activeValue &&
                          'text-white shadow-md',
                        activeValue !== null &&
                          item.value > activeValue &&
                          'bg-gray-200 hover:bg-gray-300',
                        isDisabled && 'cursor-not-allowed'
                      )}
                      onMouseDown={(e) => {
                        e.stopPropagation();
                        handleClick(item.value);
                      }}
                      onTouchStart={(e) => {
                        e.stopPropagation();
                        handleClick(item.value);
                      }}
                      onKeyDown={(e) => handleKeyPress(e, item.value)}
                      onMouseEnter={() =>
                        !isDisabled && setHoveredValue(item.value)
                      }
                      onMouseLeave={() => setHoveredValue(null)}
                      disabled={isDisabled}
                      aria-label={dict.ariaLabel.replace(
                        '{{value}}',
                        item.value.toString()
                      )}
                      initial={{ scale: 0.8, opacity: 0 }}
                      animate={{ scale: 1, opacity: 1 }}
                      exit={{ scale: 0.8, opacity: 0 }}
                      transition={{ duration: 0.15 }}
                    >
                      {item.icon || item.label}
                    </motion.button>
                  </TooltipTrigger>
                  {showTooltips && item.description && (
                    <TooltipContent>
                      <p className="text-xs sm:text-sm">{item.description}</p>
                    </TooltipContent>
                  )}
                </Tooltip>
              </TooltipProvider>
            ))}
          </AnimatePresence>
        </div>
      </div>
      {showValue && value !== null && (
        <div className="text-center text-xs sm:text-sm text-gray-500 mt-2">
          {dict.selectedValue.replace('{{value}}', value.toString())}
        </div>
      )}
      {error && (
        <div className="text-xs sm:text-sm text-red-500 mt-1">{error}</div>
      )}
      {required && (
        <input
          type="hidden"
          name={name}
          value={value || ''}
          required
          aria-hidden="true"
        />
      )}
    </div>
  );
}
--- End of Content for InteractiveScale.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionCard.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { VisibilityToggleButton } from '@/components/ui/VisibilityToggleButton';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import {
  Bookmark,
  AlertCircle,
  HelpCircle,
  SkipForward,
  Star,
  Lightbulb,
  Save,
  Loader2,
  BookUser,
  Clock,
  TrendingUp,
} from 'lucide-react';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { motion, AnimatePresence } from 'framer-motion';
import type { Question, QuestionDepth } from '../types/types';
import { cn } from '@/lib/utils';
import type { QuestionCardDict } from '@/types/dictionary';

// --- Props Interface ---
interface QuestionCardProps {
  question: Question;
  depth: QuestionDepth;
  isRequired?: boolean;
  onSkip?: () => void;
  onBookmark?: () => void;
  onHelp?: () => void;
  className?: string;
  validationError?: string;
  isDisabled?: boolean;
  children?: React.ReactNode;
  locale?: 'he' | 'en';
  themeColor?: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
  isVisible: boolean;
  onVisibilityChange: (isVisible: boolean) => void;
  onSave?: () => void;
  isSaving?: boolean;
  dict: QuestionCardDict;
  currentQuestionNumber?: number;
  totalQuestions?: number;
  estimatedTimeMinutes?: number;
}

// --- Helper Functions ---
const getThemeConfig = (themeColor: string) => {
  const themes = {
    sky: {
      gradient: 'from-sky-400 to-blue-500',
      lightGradient: 'from-sky-50 via-blue-50 to-white',
      glowColor: 'shadow-sky-400/30',
    },
    rose: {
      gradient: 'from-rose-400 to-red-500',
      lightGradient: 'from-rose-50 via-red-50 to-white',
      glowColor: 'shadow-rose-400/30',
    },
    purple: {
      gradient: 'from-purple-400 to-indigo-500',
      lightGradient: 'from-purple-50 via-indigo-50 to-white',
      glowColor: 'shadow-purple-400/30',
    },
    teal: {
      gradient: 'from-teal-400 to-emerald-500',
      lightGradient: 'from-teal-50 via-emerald-50 to-white',
      glowColor: 'shadow-teal-400/30',
    },
    amber: {
      gradient: 'from-amber-400 to-orange-500',
      lightGradient: 'from-amber-50 via-orange-50 to-white',
      glowColor: 'shadow-amber-400/30',
    },
  };
  return themes[themeColor as keyof typeof themes] || themes.sky;
};

const getDepthIcon = (depth: QuestionDepth) => {
  switch (depth) {
    case 'BASIC':
      return <Star className="w-3.5 h-3.5" fill="currentColor" />;
    case 'ADVANCED':
      return (
        <>
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
        </>
      );
    case 'EXPERT':
      return (
        <>
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
          <Star className="w-3.5 h-3.5" fill="currentColor" />
        </>
      );
    default:
      return <Star className="w-3.5 h-3.5" fill="currentColor" />;
  }
};

// --- Main Component ---
export default function QuestionCard({
  question,
  depth,
  isRequired = false,
  onSkip,
  onBookmark,
  onHelp,
  className = '',
  validationError,
  isDisabled = false,
  children,
  locale = 'he',
  themeColor = 'sky',
  isVisible,
  onVisibilityChange,
  onSave,
  isSaving,
  dict,
  currentQuestionNumber,
  totalQuestions,
  estimatedTimeMinutes = 5,
}: QuestionCardProps) {
  // --- State and Variables ---
  const [isBookmarked, setIsBookmarked] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [showBenefit, setShowBenefit] = useState(true);

  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);

  // --- Effects ---
  useEffect(() => {
    if (currentQuestionNumber && currentQuestionNumber % 5 === 0) {
      setShowBenefit(true);
      const timer = setTimeout(() => setShowBenefit(false), 8000);
      return () => clearTimeout(timer);
    } else {
      setShowBenefit(false);
    }
  }, [currentQuestionNumber]);

  // --- Animation Variants ---
  const cardVariants = {
    initial: { opacity: 0, y: 30, scale: 0.98 },
    animate: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: { duration: 0.5, ease: [0.25, 1, 0.5, 1] },
    },
    exit: { opacity: 0, y: -20, transition: { duration: 0.3 } },
  };

  const currentBenefit =
    dict.benefitMessages[
      Math.floor(
        ((currentQuestionNumber || 0) / 5) % dict.benefitMessages.length
      )
    ];
  const progressPercentage =
    currentQuestionNumber && totalQuestions
      ? Math.round((currentQuestionNumber / totalQuestions) * 100)
      : 0;

  return (
    <motion.div
      key={question.id}
      initial="initial"
      animate="animate"
      exit="exit"
      variants={cardVariants}
      className="relative"
    >
      {/* Main Card */}
      <div
        role="region"
        aria-labelledby={question.id}
        className={cn(
          'relative overflow-hidden rounded-3xl bg-white/90 backdrop-blur-sm shadow-xl border border-white/60 transition-all duration-500',
          isDisabled && 'opacity-75 cursor-not-allowed',
          className
        )}
      >
        {/* Top Gradient Bar */}
        <div className={cn('h-1.5 w-full bg-gradient-to-r', theme.gradient)} />

        {/* Decorative Orbs */}
        <div
          className={cn(
            'absolute top-4 w-40 h-40 rounded-full bg-gradient-to-br opacity-20 blur-3xl pointer-events-none',
            theme.lightGradient,
            isRTL ? 'left-[-20px]' : 'right-[-20px]'
          )}
        />

        {/* Header Section */}
        <div className="relative px-6 sm:px-8 pt-6 pb-4 space-y-4">
          {/* Progress Bar */}
          {currentQuestionNumber && totalQuestions && (
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="flex items-center gap-3 mb-4"
            >
              <div className="flex-1">
                <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${progressPercentage}%` }}
                    transition={{ duration: 0.8, ease: 'easeOut' }}
                    className="h-full bg-gradient-to-r from-teal-400 to-orange-400"
                  />
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-sm font-bold text-gray-700">
                  {currentQuestionNumber}/{totalQuestions}
                </span>
              </div>
            </motion.div>
          )}

          {/* Badges Row */}
          <div className="flex items-center justify-between">
            <div
              className={cn(
                'flex flex-wrap items-center gap-2',
                isRTL && 'flex-row-reverse'
              )}
            >
              <TooltipProvider delayDuration={200}>
                <Tooltip>
                  <TooltipTrigger>
                    <Badge
                      className={cn(
                        'flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r text-white border-0 shadow-sm transition-all hover:shadow-md',
                        theme.gradient,
                        theme.glowColor
                      )}
                    >
                      {getDepthIcon(depth)}
                      <span className="text-xs font-bold tracking-wide">
                        {dict.depthLabels[depth]}
                      </span>
                    </Badge>
                  </TooltipTrigger>
                  <TooltipContent
                    side="bottom"
                    className="max-w-xs bg-white/95 backdrop-blur-sm"
                  >
                    <p className="text-sm font-medium">
                      {dict.depthDescriptions[depth]}
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>

              {isRequired && (
                <Badge className="bg-gradient-to-r from-rose-500 to-red-600 text-white text-xs font-semibold px-3 py-1.5 border-0 shadow-sm">
                  <span className="relative flex h-2 w-2 mr-1.5">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                  </span>
                  {dict.requiredBadge}
                </Badge>
              )}

              {estimatedTimeMinutes && (
                <Badge
                  variant="outline"
                  className="flex items-center gap-1.5 text-xs border-gray-200 bg-white/50 text-gray-600 backdrop-blur-sm"
                >
                  <Clock className="w-3.5 h-3.5" />
                  <span>
                    {dict.estimatedTime.replace(
                      '{{minutes}}',
                      String(estimatedTimeMinutes)
                    )}
                  </span>
                </Badge>
              )}
            </div>

            {/* Action Buttons (Help/Bookmark) */}
            <div className="flex items-center gap-1">
              {onBookmark && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setIsBookmarked(!isBookmarked)}
                        className={cn(
                          'h-9 w-9 rounded-xl transition-all duration-300',
                          isBookmarked
                            ? 'text-orange-500 bg-orange-50'
                            : 'text-gray-400 hover:bg-gray-100'
                        )}
                      >
                        <Bookmark
                          className="w-5 h-5"
                          fill={isBookmarked ? 'currentColor' : 'none'}
                        />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {isBookmarked
                          ? dict.tooltips.removeBookmark
                          : dict.tooltips.addBookmark}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}

              {question.metadata?.helpText && (
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setShowHelp(!showHelp)}
                        className={cn(
                          'h-9 w-9 rounded-xl transition-all duration-300',
                          showHelp
                            ? 'text-teal-600 bg-teal-50'
                            : 'text-gray-400 hover:bg-gray-100'
                        )}
                      >
                        <HelpCircle className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {showHelp
                          ? dict.tooltips.hideHelp
                          : dict.tooltips.showHelp}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              )}
            </div>
          </div>

          {/* Question Text */}
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1, duration: 0.4 }}
          >
            <h2
              id={question.id}
              className={cn(
                'text-2xl sm:text-3xl font-bold text-gray-800 leading-tight mt-2',
                isRTL ? 'text-right' : 'text-left'
              )}
            >
              {question.question}
            </h2>
          </motion.div>
        </div>

        {/* Content Section */}
        <div className="relative px-6 sm:px-8 pb-6 space-y-6">
          <AnimatePresence>
            {showHelp && question.metadata?.helpText && (
              <motion.div
                initial={{ opacity: 0, height: 0, y: -10 }}
                animate={{ opacity: 1, height: 'auto', y: 0 }}
                exit={{ opacity: 0, height: 0, y: -10 }}
                transition={{ duration: 0.3 }}
              >
                <div className="rounded-2xl p-4 border bg-teal-50/50 border-teal-100">
                  <div
                    className={cn(
                      'flex items-start gap-3',
                      isRTL && 'flex-row-reverse'
                    )}
                  >
                    <div className="flex-shrink-0 p-1.5 rounded-lg bg-teal-100 text-teal-600">
                      <Lightbulb className="w-5 h-5" />
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-medium text-teal-800 leading-relaxed">
                        {question.metadata.helpText}
                      </p>
                    </div>
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Validation Error */}
          <AnimatePresence>
            {validationError && (
              <motion.div
                initial={{ opacity: 0, height: 0, y: -10 }}
                animate={{ opacity: 1, height: 'auto', y: 0 }}
                exit={{ opacity: 0, height: 0, y: -10 }}
                transition={{ duration: 0.3 }}
              >
                <Alert
                  role="alert"
                  className="bg-rose-50 border-rose-200 text-rose-900"
                >
                  <div
                    className={cn(
                      'flex items-center gap-3',
                      isRTL && 'flex-row-reverse'
                    )}
                  >
                    <AlertCircle className="h-5 w-5 text-rose-600 flex-shrink-0" />
                    <AlertDescription className="text-sm font-medium">
                      {validationError}
                    </AlertDescription>
                  </div>
                </Alert>
              </motion.div>
            )}
          </AnimatePresence>

          {/* Answer Input Container */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.2, duration: 0.4 }}
            className="relative"
          >
            {children}
          </motion.div>
        </div>

        {/* Encouragement Footer */}
        <AnimatePresence>
          {showBenefit &&
            currentQuestionNumber &&
            currentQuestionNumber % 5 === 0 && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="bg-orange-50/50 border-t border-orange-100 px-6 py-3"
              >
                <div className="flex items-center justify-center gap-2 text-orange-700">
                  <TrendingUp className="w-4 h-4" />
                  <span className="text-sm font-semibold">
                    {currentBenefit}
                  </span>
                </div>
              </motion.div>
            )}
        </AnimatePresence>

        {/* Card Footer */}
        <div className="relative px-6 sm:px-8 py-4 bg-gray-50/80 border-t border-gray-100 flex justify-between items-center backdrop-blur-sm">
          <div className="flex items-center gap-2">
            <VisibilityToggleButton
              isVisible={isVisible}
              onToggle={() => onVisibilityChange(!isVisible)}
              disabled={isDisabled}
              visibleText={dict.visibilityButton.visible}
              hiddenText={dict.visibilityButton.hidden}
            />

            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Link
                    href="/profile?tab=questionnaire"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-9 w-9 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                    >
                      <BookUser className="w-4 h-4" />
                    </Button>
                  </Link>
                </TooltipTrigger>
                <TooltipContent>
                  <p className="text-sm">{dict.tooltips.viewProfile}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>

          <div className="flex items-center gap-2">
            {onSave && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-9 w-9 rounded-xl text-teal-600 hover:bg-teal-50"
                      onClick={onSave}
                      disabled={isSaving || isDisabled}
                    >
                      {isSaving ? (
                        <Loader2 className="w-4 h-4 animate-spin" />
                      ) : (
                        <Save className="w-4 h-4" />
                      )}
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>
                      {isSaving
                        ? dict.tooltips.saveProgressSaving
                        : dict.tooltips.saveProgress}
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}

            {onSkip && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onSkip}
                disabled={isRequired || isDisabled}
                className={cn(
                  'rounded-xl px-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100',
                  isRequired && 'opacity-50 cursor-not-allowed'
                )}
              >
                {isRequired ? (
                  <span className="text-xs">{dict.skipButton.required}</span>
                ) : (
                  <div className="flex items-center gap-1.5">
                    <span className="text-sm">{dict.skipButton.skip}</span>
                    <SkipForward className="w-4 h-4" />
                  </div>
                )}
              </Button>
            )}
          </div>
        </div>
      </div>
    </motion.div>
  );
}
--- End of Content for QuestionCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionnaireCompletion.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionnaireCompletion.tsx
'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  Send,
  CheckCircle2,
  BookUser,
  Loader2,
  Trophy,
  Zap,
  Award,
  Star,
  Target,
  Clock,
  ArrowRight,
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '@/lib/utils';
import type { QuestionnaireCompletionDict } from '@/types/dictionary';

interface QuestionnaireCompletionProps {
  onSendToMatching: () => void;
  isLoading?: boolean;
  isLoggedIn?: boolean;
  dict: QuestionnaireCompletionDict;
  // סטטיסטיקות אופציונליות
  totalQuestions?: number;
  answeredQuestions?: number;
  timeSpentMinutes?: number;
  worldsCompleted?: number;
  locale?: 'he' | 'en';
}

// Confetti Component
const Confetti: React.FC = () => {
  const confettiColors = [
    'bg-red-500',
    'bg-blue-500',
    'bg-yellow-500',
    'bg-green-500',
    'bg-purple-500',
    'bg-pink-500',
    'bg-orange-500',
    'bg-cyan-500',
  ];

  const confettiPieces = Array.from({ length: 50 }, (_, i) => ({
    id: i,
    left: Math.random() * 100,
    delay: Math.random() * 2,
    duration: 3 + Math.random() * 2,
    color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
    rotation: Math.random() * 360,
  }));

  return (
    <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
      {confettiPieces.map((piece) => (
        <motion.div
          key={piece.id}
          className={cn('absolute w-3 h-3 rounded-sm', piece.color)}
          initial={{
            top: '-5%',
            left: `${piece.left}%`,
            rotate: 0,
            opacity: 1,
          }}
          animate={{
            top: '105%',
            rotate: piece.rotation * 3,
            opacity: 0,
          }}
          transition={{
            duration: piece.duration,
            delay: piece.delay,
            ease: 'easeIn',
          }}
        />
      ))}
    </div>
  );
};

// Achievement Badge Component
const AchievementBadge: React.FC<{
  icon: React.ReactNode;
  title: string;
  description: string;
  delay: number;
}> = ({ icon, title, description, delay }) => {
  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.8, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      transition={{ delay, duration: 0.5, type: 'spring', stiffness: 200 }}
      className="flex items-start gap-3 p-4 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-white shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105"
    >
      <div className="flex-shrink-0 p-2 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-md">
        {icon}
      </div>
      <div className="flex-1 min-w-0">
        <h4 className="font-bold text-gray-800 text-sm">{title}</h4>
        <p className="text-xs text-gray-600 mt-0.5">{description}</p>
      </div>
    </motion.div>
  );
};

// Stats Card Component
const StatsCard: React.FC<{
  icon: React.ReactNode;
  value: string | number;
  label: string;
  gradient: string;
  delay: number;
}> = ({ icon, value, label, gradient, delay }) => {
  const [count, setCount] = useState(0);
  const finalValue = typeof value === 'number' ? value : parseInt(value) || 0;

  useEffect(() => {
    if (typeof value === 'number') {
      let start = 0;
      const duration = 2000;
      const increment = finalValue / (duration / 16);
      const timer = setInterval(() => {
        start += increment;
        if (start >= finalValue) {
          setCount(finalValue);
          clearInterval(timer);
        } else {
          setCount(Math.floor(start));
        }
      }, 16);
      return () => clearInterval(timer);
    }
  }, [value, finalValue]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 30 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay, duration: 0.6, type: 'spring' }}
      whileHover={{ y: -8, scale: 1.05 }}
      className="relative overflow-hidden"
    >
      <div
        className={cn(
          'relative p-6 rounded-3xl bg-gradient-to-br',
          gradient,
          'text-white shadow-2xl border-2 border-white/20'
        )}
      >
        {/* Background decoration */}
        <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full blur-2xl" />
        <div className="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full blur-xl" />

        <div className="relative z-10">
          <div className="flex items-center justify-between mb-3">
            <div className="p-2 bg-white/20 rounded-xl backdrop-blur-sm">
              {icon}
            </div>
          </div>
          <div className="text-4xl font-bold mb-1">
            {typeof value === 'number' ? count : value}
          </div>
          <div className="text-sm font-medium text-white/90">{label}</div>
        </div>
      </div>
    </motion.div>
  );
};

const QuestionnaireCompletion: React.FC<QuestionnaireCompletionProps> = ({
  onSendToMatching,
  isLoading = false,
  isLoggedIn = false,
  dict,
  totalQuestions = 0,
  answeredQuestions = 0,
  timeSpentMinutes = 0,
  locale = 'he',
}) => {
  const [showConfetti, setShowConfetti] = useState(false);
  const [showContent, setShowContent] = useState(false);
  const isRTL = locale === 'he';

  useEffect(() => {
    // Show confetti immediately
    setShowConfetti(true);
    // Show content after a brief delay
    setTimeout(() => setShowContent(true), 300);
    // Hide confetti after 4 seconds
    setTimeout(() => setShowConfetti(false), 4000);
  }, []);

  const completionPercentage = totalQuestions
    ? Math.round((answeredQuestions / totalQuestions) * 100)
    : 100;

  const achievements = [
    {
      icon: <CheckCircle2 className="w-5 h-5" />,
      title: dict.achievements.completed.title,
      description: dict.achievements.completed.description,
    },
    {
      icon: <Zap className="w-5 h-5" />,
      title: dict.achievements.speed.title,
      description: dict.achievements.speed.description.replace(
        '{{minutes}}',
        timeSpentMinutes.toString()
      ),
    },
    {
      icon: <Target className="w-5 h-5" />,
      title: dict.achievements.profile.title,
      description: dict.achievements.profile.description,
    },
  ];

  return (
    <div
      className="min-h-screen relative overflow-hidden"
      dir={isRTL ? 'rtl' : 'ltr'}
    >
      {/* Background Gradient */}
      <div className="fixed inset-0 bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50 -z-10" />

      {/* Animated Background Elements */}
      <div className="fixed inset-0 -z-10 overflow-hidden">
        <motion.div
          animate={{
            scale: [1, 1.2, 1],
            rotate: [0, 90, 0],
            opacity: [0.3, 0.5, 0.3],
          }}
          transition={{ duration: 20, repeat: Infinity }}
          className="absolute -top-1/2 -left-1/2 w-full h-full bg-gradient-to-br from-cyan-200 to-blue-300 rounded-full blur-3xl"
        />
        <motion.div
          animate={{
            scale: [1, 1.3, 1],
            rotate: [0, -90, 0],
            opacity: [0.3, 0.5, 0.3],
          }}
          transition={{ duration: 25, repeat: Infinity }}
          className="absolute -bottom-1/2 -right-1/2 w-full h-full bg-gradient-to-br from-pink-200 to-rose-300 rounded-full blur-3xl"
        />
      </div>

      {/* Confetti */}
      <AnimatePresence>{showConfetti && <Confetti />}</AnimatePresence>

      {/* Main Content */}
      <div className="relative z-10 max-w-5xl mx-auto px-4 py-12">
        <AnimatePresence>
          {showContent && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ duration: 0.5 }}
              className="space-y-8"
            >
              {/* Hero Section */}
              <motion.div
                initial={{ opacity: 0, y: -50, scale: 0.9 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                transition={{ duration: 0.7, type: 'spring', stiffness: 100 }}
                className="text-center space-y-6"
              >
                {/* Trophy Icon with Pulse */}
                <motion.div
                  animate={{
                    scale: [1, 1.1, 1],
                    rotate: [0, 5, -5, 0],
                  }}
                  transition={{
                    duration: 2,
                    repeat: Infinity,
                    repeatType: 'reverse',
                  }}
                  className="inline-block"
                >
                  <div className="relative">
                    <div className="absolute inset-0 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full blur-xl opacity-50" />
                    <div className="relative p-8 bg-gradient-to-br from-amber-400 via-orange-500 to-red-500 rounded-full shadow-2xl">
                      <Trophy
                        className="w-20 h-20 text-white"
                        strokeWidth={2.5}
                      />
                    </div>
                  </div>
                </motion.div>

                {/* Title */}
                <div className="space-y-3">
                  <motion.h1
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3, duration: 0.6 }}
                    className="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600"
                  >
                    {dict.title}
                  </motion.h1>
                  <motion.p
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.5, duration: 0.6 }}
                    className="text-xl md:text-2xl text-gray-700 font-medium max-w-2xl mx-auto leading-relaxed"
                  >
                    {isLoggedIn
                      ? dict.loggedInDescription
                      : dict.guestDescription}
                  </motion.p>
                </div>
              </motion.div>

              {/* Stats Grid */}
              {totalQuestions > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <StatsCard
                    icon={<Star className="w-6 h-6" />}
                    value={completionPercentage}
                    label={dict.stats.completion}
                    gradient="from-purple-500 via-pink-500 to-rose-500"
                    delay={0.7}
                  />
                  <StatsCard
                    icon={<CheckCircle2 className="w-6 h-6" />}
                    value={answeredQuestions}
                    label={dict.stats.answered}
                    gradient="from-cyan-500 via-blue-500 to-indigo-500"
                    delay={0.9}
                  />
                  <StatsCard
                    icon={<Clock className="w-6 h-6" />}
                    value={`${timeSpentMinutes}'`}
                    label={dict.stats.time}
                    gradient="from-emerald-500 via-teal-500 to-green-500"
                    delay={1.1}
                  />
                </div>
              )}

              {/* Achievements Section */}
              <motion.div
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 1.3, duration: 0.6 }}
                className="bg-white/40 backdrop-blur-md rounded-3xl p-8 border-2 border-white shadow-2xl"
              >
                <div className="flex items-center gap-3 mb-6">
                  <div className="p-3 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl shadow-lg">
                    <Award className="w-6 h-6 text-white" />
                  </div>
                  <h2 className="text-2xl font-bold text-gray-800">
                    {dict.unlocksTitle}
                  </h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {achievements.map((achievement, index) => (
                    <AchievementBadge
                      key={index}
                      {...achievement}
                      delay={1.5 + index * 0.2}
                    />
                  ))}
                </div>
              </motion.div>

              {/* CTA Section */}
              <motion.div
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 2.1, duration: 0.6 }}
                className="bg-white/60 backdrop-blur-lg rounded-3xl p-8 md:p-10 border-2 border-white shadow-2xl"
              >
                {isLoggedIn ? (
                  <div className="space-y-6">
                    <div className="text-center space-y-2">
                      <p className="text-lg font-semibold text-gray-800">
                        {dict.loggedInContent.prompt}
                      </p>
                      <p className="text-gray-600">
                        {dict.loggedInContent.promptSubtitle}
                      </p>
                    </div>

                    <div className="flex flex-col sm:flex-row gap-4 max-w-2xl mx-auto">
                      <Button
                        onClick={onSendToMatching}
                        disabled={isLoading}
                        size="lg"
                        className={cn(
                          'flex-1 h-14 text-lg font-bold rounded-2xl shadow-xl transition-all duration-300',
                          'bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600',
                          'hover:from-purple-700 hover:via-pink-700 hover:to-rose-700',
                          'hover:shadow-2xl hover:scale-105',
                          'disabled:opacity-50 disabled:cursor-not-allowed'
                        )}
                      >
                        {isLoading ? (
                          <>
                            <Loader2 className="w-6 h-6 animate-spin" />
                            <span className="mr-2">
                              {dict.loggedInContent.sendingButton}
                            </span>
                          </>
                        ) : (
                          <>
                            <Send className="w-6 h-6" />
                            <span className="mr-2">
                              {dict.loggedInContent.sendButton}
                            </span>
                            <ArrowRight className="w-5 h-5" />
                          </>
                        )}
                      </Button>

                      <Link
                        href="/profile?tab=questionnaire"
                        className="flex-1"
                      >
                        <Button
                          variant="outline"
                          size="lg"
                          disabled={isLoading}
                          className="w-full h-14 text-lg font-semibold rounded-2xl border-2 bg-white hover:bg-gray-50 transition-all duration-300 hover:scale-105"
                        >
                          <BookUser className="w-6 h-6 text-blue-600" />
                          <span className="mr-2">
                            {dict.loggedInContent.reviewButton}
                          </span>
                        </Button>
                      </Link>
                    </div>
                  </div>
                ) : (
                  <div className="max-w-md mx-auto text-center space-y-6">
                    <p className="text-lg text-gray-700">
                      {isRTL
                        ? 'כדי להמשיך ולקבל התאמות, אנא התחבר לחשבון שלך'
                        : 'To continue and receive matches, please log in to your account'}
                    </p>
                    <Button
                      onClick={onSendToMatching}
                      size="lg"
                      className="w-full h-14 text-lg font-bold rounded-2xl shadow-xl bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition-all duration-300 hover:scale-105"
                    >
                      <span className="mr-2">
                        {dict.guestContent.loginButton}
                      </span>
                      <ArrowRight className="w-5 h-5" />
                    </Button>
                  </div>
                )}
              </motion.div>

              {/* Decorative Elements */}
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 2.5, duration: 1 }}
                className="flex justify-center gap-4 text-4xl"
              >
                <motion.span
                  animate={{ rotate: [0, 15, -15, 0] }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  🎊
                </motion.span>
                <motion.span
                  animate={{ scale: [1, 1.2, 1] }}
                  transition={{ duration: 1.5, repeat: Infinity }}
                >
                  ❤️
                </motion.span>
                <motion.span
                  animate={{ rotate: [0, -15, 15, 0] }}
                  transition={{ duration: 2, repeat: Infinity }}
                >
                  🎉
                </motion.span>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Custom Styles */}
      <style>{`
        @keyframes shimmer {
          0% {
            background-position: -100% 0;
          }
          100% {
            background-position: 200% 0;
          }
        }
      `}</style>
    </div>
  );
};

export default QuestionnaireCompletion;
--- End of Content for QuestionnaireCompletion.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\QuestionsList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/QuestionsList.tsx
'use client';

import React, { useState } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  CheckCircle,
  AlertCircle,
  Circle,
  Sparkles,
  Star,
  Zap,
  CheckCircle2,
  AlertTriangle,
  Award,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import type {
  Question,
  QuestionnaireAnswer,
  AnswerValue,
  QuestionDepth,
} from '../types/types';
import { Badge } from '@/components/ui/badge';
import { motion, AnimatePresence } from 'framer-motion';
import type { QuestionsListDict } from '@/types/dictionary';

interface QuestionsListProps {
  locale: string;
  allQuestions: Question[];
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
  answers: QuestionnaireAnswer[];
  className?: string;
  onClose?: () => void;
  themeColor?: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
  dict: QuestionsListDict;
}

const getThemeConfig = (themeColor: string) => {
  const themes = {
    sky: {
      gradient: 'from-cyan-400 via-sky-500 to-blue-500',
      lightBg: 'from-cyan-50 to-blue-50',
      textColor: 'text-cyan-700',
      iconColor: 'text-cyan-600',
      borderColor: 'border-cyan-200',
      ringColor: 'ring-cyan-300',
      bgSoft: 'bg-cyan-50',
      shadowColor: 'shadow-cyan-200/50',
    },
    rose: {
      gradient: 'from-rose-400 via-pink-500 to-red-500',
      lightBg: 'from-rose-50 to-pink-50',
      textColor: 'text-rose-700',
      iconColor: 'text-rose-600',
      borderColor: 'border-rose-200',
      ringColor: 'ring-rose-300',
      bgSoft: 'bg-rose-50',
      shadowColor: 'shadow-rose-200/50',
    },
    purple: {
      gradient: 'from-purple-400 via-violet-500 to-indigo-500',
      lightBg: 'from-purple-50 to-indigo-50',
      textColor: 'text-purple-700',
      iconColor: 'text-purple-600',
      borderColor: 'border-purple-200',
      ringColor: 'ring-purple-300',
      bgSoft: 'bg-purple-50',
      shadowColor: 'shadow-purple-200/50',
    },
    teal: {
      gradient: 'from-teal-400 via-emerald-500 to-green-500',
      lightBg: 'from-teal-50 to-emerald-50',
      textColor: 'text-teal-700',
      iconColor: 'text-teal-600',
      borderColor: 'border-teal-200',
      ringColor: 'ring-teal-300',
      bgSoft: 'bg-teal-50',
      shadowColor: 'shadow-teal-200/50',
    },
    amber: {
      gradient: 'from-amber-400 via-orange-500 to-yellow-500',
      lightBg: 'from-amber-50 to-orange-50',
      textColor: 'text-amber-700',
      iconColor: 'text-amber-600',
      borderColor: 'border-amber-200',
      ringColor: 'ring-amber-300',
      bgSoft: 'bg-amber-50',
      shadowColor: 'shadow-amber-200/50',
    },
  };
  return themes[themeColor as keyof typeof themes] || themes.sky;
};

const QuestionsList: React.FC<QuestionsListProps> = ({
  allQuestions,
  currentQuestionIndex,
  setCurrentQuestionIndex,
  answers,
  locale = 'he',
  className = '',
  onClose,
  themeColor = 'sky',
  dict,
}) => {
  const isRTL = locale === 'he';
  const theme = getThemeConfig(themeColor);
  const [hoveredIndex, setHoveredIndex] = useState<number | null>(null);

  const findAnswer = (questionId: string): AnswerValue | undefined => {
    return answers.find((a) => a.questionId === questionId)?.value;
  };

  const isAnswerNotEmpty = (answer: AnswerValue | undefined): boolean => {
    if (answer === undefined || answer === null) return false;
    if (typeof answer === 'string' && answer.trim() === '') return false;
    if (Array.isArray(answer) && answer.length === 0) return false;
    if (
      typeof answer === 'object' &&
      !Array.isArray(answer) &&
      Object.keys(answer).length === 0
    )
      return false;
    return true;
  };

  const handleItemClick = (index: number) => {
    setCurrentQuestionIndex(index);
    onClose?.();
  };

  // חישוב סטטיסטיקות
  const answeredCount = allQuestions.filter((q) =>
    isAnswerNotEmpty(findAnswer(q.id))
  ).length;
  const totalCount = allQuestions.length;
  const progressPercentage = Math.round((answeredCount / totalCount) * 100);

  // הודעת מוטיבציה דינמית מהמילון
  const getMotivationalMessage = () => {
    if (progressPercentage >= 100) {
      return {
        emoji: '🎉',
        title: dict.motivationalMessages.finish.title,
        subtitle: dict.motivationalMessages.finish.subtitle,
        color: 'from-green-500 to-emerald-500',
      };
    }
    if (progressPercentage >= 75) {
      return {
        emoji: '🔥',
        title: dict.motivationalMessages.threeQuarters.title,
        subtitle: dict.motivationalMessages.threeQuarters.subtitle,
        color: theme.gradient,
      };
    }
    if (progressPercentage >= 50) {
      return {
        emoji: '⭐',
        title: dict.motivationalMessages.half.title,
        subtitle: dict.motivationalMessages.half.subtitle,
        color: theme.gradient,
      };
    }
    if (progressPercentage >= 25) {
      return {
        emoji: '🚀',
        title: dict.motivationalMessages.quarter.title,
        subtitle: dict.motivationalMessages.quarter.subtitle,
        color: theme.gradient,
      };
    }
    return {
      emoji: '💪',
      title: dict.motivationalMessages.start.title,
      subtitle: dict.motivationalMessages.start.subtitle,
      color: theme.gradient,
    };
  };

  const motivationalMessage = getMotivationalMessage();

  // אנימציות
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.03,
      },
    },
  };

  const itemVariants = {
    hidden: { opacity: 0, x: -20 },
    visible: {
      opacity: 1,
      x: 0,
      transition: { duration: 0.3, ease: 'easeOut' },
    },
  };

  return (
    <ScrollArea className={cn('h-full', className)}>
      <div className="px-2 pb-2">
        {/* Summary Section - סטטיסטיקות */}
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4 }}
          className="flex-shrink-0 mb-4 space-y-4"
        >
          {/* Progress Stats */}
          <div className="bg-white rounded-2xl p-4 border-2 border-gray-100 shadow-md">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <div
                  className={cn(
                    'p-2 rounded-xl bg-gradient-to-br',
                    theme.gradient,
                    'text-white shadow-md'
                  )}
                >
                  <CheckCircle2 className="w-4 h-4" />
                </div>
                <div>
                  <div className="text-2xl font-bold text-gray-800">
                    {answeredCount}/{totalCount}
                  </div>
                  <div className="text-xs text-gray-600">
                    {dict.stats.answeredQuestions}
                  </div>
                </div>
              </div>
              <div className="text-center">
                <div className={cn('text-3xl font-bold', theme.textColor)}>
                  {progressPercentage}%
                </div>
                <div className="text-xs text-gray-500">
                  {dict.stats.complete}
                </div>
              </div>
            </div>

            {/* Progress Bar */}
            <div className="relative h-3 bg-gray-100 rounded-full overflow-hidden">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${progressPercentage}%` }}
                transition={{ duration: 1, ease: 'easeOut' }}
                className={cn(
                  'h-full bg-gradient-to-r',
                  theme.gradient,
                  'shadow-lg'
                )}
              />
            </div>
          </div>

          {/* Motivational Card */}
          <motion.div
            animate={{ scale: [1, 1.02, 1] }}
            transition={{ duration: 3, repeat: Infinity }}
            className={cn(
              'relative overflow-hidden rounded-2xl p-4 text-white shadow-lg',
              'bg-gradient-to-r',
              motivationalMessage.color
            )}
          >
            <div className="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full blur-2xl" />
            <div className="relative z-10 flex items-center gap-3">
              <div className="text-3xl">{motivationalMessage.emoji}</div>
              <div className="flex-1">
                <div className="font-bold text-lg">
                  {motivationalMessage.title}
                </div>
                <div className="text-sm text-white/90">
                  {motivationalMessage.subtitle}
                </div>
              </div>
            </div>
          </motion.div>

          {/* Quick Stats */}
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-3 border border-blue-100">
              <div className="flex items-center gap-2 mb-1">
                <Zap className="w-4 h-4 text-blue-600" />
                <span className="text-xs font-semibold text-blue-700">
                  {dict.stats.remaining}
                </span>
              </div>
              <div className="text-2xl font-bold text-blue-900">
                {totalCount - answeredCount}
              </div>
            </div>

            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-3 border border-green-100">
              <div className="flex items-center gap-2 mb-1">
                <Award className="w-4 h-4 text-green-600" />
                <span className="text-xs font-semibold text-green-700">
                  {dict.stats.done}
                </span>
              </div>
              <div className="text-2xl font-bold text-green-900">
                {answeredCount}
              </div>
            </div>
          </div>
        </motion.div>

        {/* Questions List */}
        <motion.div
          variants={containerVariants}
          initial="hidden"
          animate="visible"
          className="relative space-y-2"
          dir={isRTL ? 'rtl' : 'ltr'}
        >
          {/* Timeline Line */}
          <div
            className="absolute top-0 bottom-0 w-0.5 bg-gradient-to-b from-gray-200 via-gray-300 to-gray-200 rounded-full"
            style={isRTL ? { right: '1.75rem' } : { left: '1.75rem' }}
          />

          {allQuestions.map((q, index) => {
            const answer = findAnswer(q.id);
            const isAnswered = isAnswerNotEmpty(answer);
            const isCurrent = index === currentQuestionIndex;
            const isHovered = hoveredIndex === index;

            // אייקון סטטוס
            let StatusIcon;
            let statusColor = '';
            let statusBgColor = '';

            if (isCurrent) {
              StatusIcon = Sparkles;
              statusColor = theme.iconColor;
              statusBgColor = cn('bg-gradient-to-br', theme.lightBg);
            } else if (isAnswered) {
              StatusIcon = CheckCircle2;
              statusColor = 'text-green-600';
              statusBgColor = 'bg-green-50';
            } else if (q.isRequired) {
              StatusIcon = AlertTriangle;
              statusColor = 'text-rose-500';
              statusBgColor = 'bg-rose-50';
            } else {
              StatusIcon = Circle;
              statusColor = 'text-gray-300';
              statusBgColor = 'bg-gray-50';
            }

            const depthMap: { [key in QuestionDepth]: number } = {
              BASIC: 1,
              ADVANCED: 2,
              EXPERT: 3,
            };
            const starCount = depthMap[q.depth] || 1;

            return (
              <motion.button
                key={q.id}
                variants={itemVariants}
                type="button"
                onClick={() => handleItemClick(index)}
                onMouseEnter={() => setHoveredIndex(index)}
                onMouseLeave={() => setHoveredIndex(null)}
                className={cn(
                  'relative w-full flex items-start text-start p-4 rounded-2xl transition-all duration-300 border-2 group',
                  'hover:shadow-lg active:scale-[0.98]',
                  isCurrent
                    ? cn(
                        'bg-gradient-to-br',
                        theme.lightBg,
                        theme.borderColor,
                        'ring-2',
                        theme.ringColor,
                        theme.shadowColor
                      )
                    : isAnswered
                    ? 'bg-white border-green-200 hover:border-green-300 hover:bg-green-50/30'
                    : q.isRequired
                    ? 'bg-white border-rose-200 hover:border-rose-300 hover:bg-rose-50/30'
                    : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                )}
                aria-current={isCurrent ? 'step' : undefined}
              >
                {/* Icon Container */}
                <motion.div
                  whileHover={{ scale: 1.1, rotate: 5 }}
                  whileTap={{ scale: 0.95 }}
                  className={cn(
                    'flex-shrink-0 z-10 rounded-xl p-2.5 shadow-md border-2 border-white transition-all duration-300',
                    statusBgColor,
                    isHovered && 'shadow-lg'
                  )}
                >
                  <StatusIcon className={cn('h-5 w-5', statusColor)} />
                </motion.div>

                {/* Content */}
                <div className="flex-1 min-w-0 ml-3 space-y-2">
                  {/* Question Number & Text */}
                  <div>
                    <span
                      className={cn(
                        'inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold mr-2',
                        isCurrent
                          ? cn(
                              'bg-gradient-to-br',
                              theme.gradient,
                              'text-white'
                            )
                          : 'bg-gray-100 text-gray-600'
                      )}
                    >
                      {index + 1}
                    </span>
                    <p
                      className={cn(
                        'inline text-sm leading-relaxed transition-colors',
                        isCurrent
                          ? cn(theme.textColor, 'font-semibold')
                          : isAnswered
                          ? 'text-gray-700 font-medium'
                          : 'text-gray-600'
                      )}
                    >
                      {q.question}
                    </p>
                  </div>

                  {/* Badges Row */}
                  <div className="flex items-center gap-2 flex-wrap">
                    {/* Depth Badge */}
                    <Badge
                      variant="outline"
                      className={cn(
                        'text-[10px] font-medium border transition-all',
                        isCurrent
                          ? cn(
                              'bg-white/80 backdrop-blur-sm',
                              theme.borderColor,
                              theme.textColor
                            )
                          : 'bg-white border-gray-200 text-gray-600'
                      )}
                    >
                      {Array.from({ length: starCount }).map((_, i) => (
                        <Star
                          key={i}
                          className="w-2.5 h-2.5 inline mx-0.5"
                          fill="currentColor"
                        />
                      ))}
                      <span className="ml-1">
                        {dict.depthLabels[q.depth]}
                      </span>
                    </Badge>

                    {/* Required Badge */}
                    {q.isRequired && !isAnswered && (
                      <Badge
                        variant="outline"
                        className="text-[10px] font-semibold bg-rose-50 border-rose-300 text-rose-700"
                      >
                        <AlertCircle className="w-2.5 h-2.5 mr-1" />
                        {dict.badges.required}
                      </Badge>
                    )}

                    {/* Answered Badge */}
                    {isAnswered && (
                      <Badge
                        variant="outline"
                        className="text-[10px] font-semibold bg-green-50 border-green-300 text-green-700"
                      >
                        <CheckCircle className="w-2.5 h-2.5 mr-1" />
                        {dict.badges.answered}
                      </Badge>
                    )}
                  </div>
                </div>

                {/* Hover Indicator */}
                <AnimatePresence>
                  {isHovered && !isCurrent && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0 }}
                      animate={{ opacity: 1, scale: 1 }}
                      exit={{ opacity: 0, scale: 0 }}
                      transition={{ duration: 0.2 }}
                      className="absolute top-1/2 -translate-y-1/2"
                      style={isRTL ? { left: '8px' } : { right: '8px' }}
                    >
                      <div
                        className={cn(
                          'w-8 h-8 rounded-full flex items-center justify-center',
                          'bg-gradient-to-br',
                          theme.gradient,
                          'text-white shadow-lg'
                        )}
                      >
                        <Zap className="w-4 h-4" />
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* Current Pulse Effect */}
                {isCurrent && (
                  <motion.div
                    className={cn(
                      'absolute inset-0 rounded-2xl border-2',
                      theme.borderColor
                    )}
                    animate={{
                      scale: [1, 1.02, 1],
                      opacity: [0.5, 0.8, 0.5],
                    }}
                    transition={{
                      duration: 2,
                      repeat: Infinity,
                      ease: 'easeInOut',
                    }}
                  />
                )}
              </motion.button>
            );
          })}
        </motion.div>
      </div>
    </ScrollArea>
  );
};

export default QuestionsList;
--- End of Content for QuestionsList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\common\StandardizedLoadingSpinner.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/common/StandardizedLoadingSpinner.tsx
'use client';

import React from 'react';
import { motion } from 'framer-motion';
import { Loader2, Sparkles } from 'lucide-react';
import { cn } from '@/lib/utils';

interface StandardizedLoadingSpinnerProps {
  text?: string;
  subtext?: string;
  layout?: 'fullscreen' | 'inline';
  className?: string;
}

export default function StandardizedLoadingSpinner({
  text = 'טוען...',
  subtext,
  layout = 'fullscreen',
  className,
}: StandardizedLoadingSpinnerProps) {
  const containerClasses = {
    fullscreen: 'flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-slate-50 p-4',
    inline: 'flex flex-col items-center justify-center w-full my-8 p-4',
  };

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className={cn(containerClasses[layout], className)}
    >
      <div className="relative">
        <div className="absolute inset-0 bg-gradient-to-r from-teal-400 to-orange-500 rounded-full blur-xl opacity-50 animate-pulse" />
        <Loader2 className="relative h-16 w-16 animate-spin text-teal-600" />
      </div>
      <motion.p
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2 }}
        className="mt-6 text-xl font-semibold text-gray-700 text-center"
      >
        {text}
      </motion.p>
      {subtext && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="mt-4 flex items-center gap-2 text-sm text-gray-500"
        >
          <Sparkles className="w-4 h-4" />
          <span>{subtext}</span>
        </motion.div>
      )}
    </motion.div>
  );
}
--- End of Content for StandardizedLoadingSpinner.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\AccessibilityFeatures.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/AccessibilityFeatures.tsx
'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  Accessibility,
  Plus,
  Minus,
  MoonStar,
  SunMedium,
  Type,
  MousePointer,
  Hand,
  Contrast,
  Speech,
  X,
  Settings,
  Volume2,
  VolumeX,
  Palette,
  Eye,
  RefreshCw,
  Check,
  Sparkles,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Slider } from '@/components/ui/slider';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import type { AccessibilityFeaturesDict } from '@/types/dictionary';
import { useIsMobile } from '../hooks/useMediaQuery';

declare global {
  interface Window {
    webkitAudioContext: typeof AudioContext;
  }
}

interface AccessibilityFeaturesProps {
  className?: string;
  isPanelOpen?: boolean;
  onPanelOpenChange?: (isOpen: boolean) => void;
  dict: AccessibilityFeaturesDict;
}

interface AccessibilitySettings {
  fontScale: number;
  contrastMode: 'normal' | 'high' | 'dark';
  reducedMotion: boolean;
  readableMode: boolean;
  bigCursor: boolean;
  textReader: boolean;
  soundEnabled: boolean;
}

const defaultSettings: AccessibilitySettings = {
  fontScale: 1,
  contrastMode: 'normal',
  reducedMotion: false,
  readableMode: false,
  bigCursor: false,
  textReader: false,
  soundEnabled: true,
};

const getSettingName = (
  key: keyof AccessibilitySettings,
  dict: AccessibilityFeaturesDict
): string => {
  return dict.settingNames[key] || key;
};

export default function AccessibilityFeatures({
  className,
  isPanelOpen,
  onPanelOpenChange,
  dict,
}: AccessibilityFeaturesProps) {
  const [settings, setSettings] =
    useState<AccessibilitySettings>(defaultSettings);
  const [internalShowPanel, setInternalShowPanel] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);
  const [showToast, setShowToast] = useState<{
    message: string;
    type: 'success' | 'info';
    visible: boolean;
  }>({ message: '', type: 'info', visible: false });

  const panelRef = useRef<HTMLDivElement>(null);
  const toastTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const isMobile = useIsMobile();

  const showAccessibilityPanel =
    isPanelOpen !== undefined ? isPanelOpen : internalShowPanel;
  const setShowAccessibilityPanel = onPanelOpenChange || setInternalShowPanel;

  useEffect(() => {
    const savedSettings = localStorage.getItem('accessibilitySettings');
    if (savedSettings) {
      try {
        const parsed = JSON.parse(savedSettings);
        setSettings({ ...defaultSettings, ...parsed });
      } catch (error) {
        console.error('Error loading accessibility settings:', error);
      }
    }
  }, []);

  useEffect(() => {
    const htmlElement = document.documentElement;
    htmlElement.style.fontSize = `${settings.fontScale * 100}%`;
    htmlElement.classList.toggle(
      'high-contrast',
      settings.contrastMode === 'high'
    );
    htmlElement.classList.toggle('dark-mode', settings.contrastMode === 'dark');
    htmlElement.classList.toggle('reduce-motion', settings.reducedMotion);
    htmlElement.classList.toggle('readable-font', settings.readableMode);
    htmlElement.classList.toggle('big-cursor', settings.bigCursor);
    updateAccessibilityStyles();
    localStorage.setItem('accessibilitySettings', JSON.stringify(settings));
  }, [settings]);

  const updateAccessibilityStyles = () => {
    const styleElement =
      document.getElementById('accessibility-styles') ||
      document.createElement('style');
    styleElement.id = 'accessibility-styles';
    styleElement.textContent = `
      .high-contrast { filter: contrast(1.5) brightness(1.1); }
      .dark-mode { filter: invert(1) hue-rotate(180deg); background: #1a1a1a !important; }
      .reduce-motion * { animation-duration: 0.001s !important; transition-duration: 0.001s !important; }
      .readable-font * { font-family: 'Arial', 'Helvetica', sans-serif !important; letter-spacing: 0.05em !important; word-spacing: 0.1em !important; line-height: 1.6 !important; }
      .big-cursor, .big-cursor * { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16"><circle fill="%23000" stroke="%23fff" stroke-width="2" cx="8" cy="8" r="6"/></svg>') 16 16, auto !important; }
      .accessibility-panel-enter { opacity: 0; transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .accessibility-panel-enter-active { opacity: 1; transform: scale(1) translateY(0); }
      .accessibility-panel-exit { opacity: 1; transform: scale(1) translateY(0); transition: all 0.2s ease-in; }
      .accessibility-panel-exit-active { opacity: 0; transform: scale(0.95) translateY(10px); }
      .accessibility-button { transition: all 0.3s ease; }
      .accessibility-button:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
      .accessibility-button:active { transform: scale(0.95); }
      .toast-enter { opacity: 0; transform: translateY(20px) scale(0.9); transition: all 0.3s ease; }
      .toast-enter-active { opacity: 1; transform: translateY(0) scale(1); }
      .toast-exit { opacity: 1; transform: translateY(0) scale(1); transition: all 0.2s ease; }
      .toast-exit-active { opacity: 0; transform: translateY(20px) scale(0.9); }
      .pulse-animation { animation: pulse 2s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } }
      .setting-card { transition: all 0.2s ease; border-radius: 8px; }
      .setting-card:hover { background-color: rgba(59, 130, 246, 0.05); transform: translateX(-2px); }
    `;
    if (!document.getElementById('accessibility-styles')) {
      document.head.appendChild(styleElement);
    }
  };

  const showSuccessToast = useCallback((message: string) => {
    setShowToast({ message, type: 'success', visible: true });
    if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
    toastTimeoutRef.current = setTimeout(() => {
      setShowToast((prev) => ({ ...prev, visible: false }));
    }, 2500);
  }, []);

  const playClickSound = useCallback(() => {
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const audioContext = new AudioContext();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.01,
        audioContext.currentTime + 0.1
      );
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    } catch (error) {
      console.log('Could not play sound:', error);
    }
  }, []);

  const updateSetting = useCallback(
    <K extends keyof AccessibilitySettings>(
      key: K,
      value: AccessibilitySettings[K]
    ) => {
      setSettings((prev) => ({ ...prev, [key]: value }));
      setHasChanges(true);
      if (settings.soundEnabled) playClickSound();
      const settingName = getSettingName(key, dict);
      showSuccessToast(
        dict.toasts.settingUpdated.replace('{{settingName}}', settingName)
      );
    },
    [settings.soundEnabled, playClickSound, dict, showSuccessToast]
  );

  const readSelectedText = useCallback((e: MouseEvent) => {
    const element = e.target as HTMLElement;
    if (element && element.textContent && 'speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const text = element.textContent.trim();
      if (text && text.length > 0) {
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const hebrewVoice = voices.find((voice) => voice.lang === 'he-IL');
        if (hebrewVoice) {
          utterance.voice = hebrewVoice;
          utterance.lang = 'he-IL';
        }
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      }
    }
  }, []);

  const toggleTextReader = useCallback(() => {
    const willBeActive = !settings.textReader;
    updateSetting('textReader', willBeActive);
    if (willBeActive) {
      document.addEventListener('click', readSelectedText);
      showSuccessToast(dict.toasts.readerEnabled);
    } else {
      document.removeEventListener('click', readSelectedText);
      if (window.speechSynthesis) window.speechSynthesis.cancel();
    }
  }, [
    settings.textReader,
    updateSetting,
    readSelectedText,
    showSuccessToast,
    dict.toasts.readerEnabled,
  ]);

  const resetSettings = () => {
    setSettings(defaultSettings);
    setHasChanges(false);
    showSuccessToast(dict.toasts.settingsReset);
    if (settings.soundEnabled) playClickSound();
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        panelRef.current &&
        !panelRef.current.contains(event.target as Node)
      ) {
        const target = event.target as HTMLElement;
        if (!target.closest('[data-accessibility-trigger]')) {
          setShowAccessibilityPanel(false);
        }
      }
    };
    if (showAccessibilityPanel) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showAccessibilityPanel, setShowAccessibilityPanel]);

  useEffect(() => {
    return () => {
      if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
      document.removeEventListener('click', readSelectedText);
    };
  }, [readSelectedText]);

  const contrastOptions = [
    { key: 'normal' as const, icon: SunMedium },
    { key: 'high' as const, icon: Contrast },
    { key: 'dark' as const, icon: MoonStar },
  ];

  const advancedOptions = [
    {
      key: 'sound' as const,
      setting: 'soundEnabled' as const,
      icon: settings.soundEnabled ? Volume2 : VolumeX,
    },
    { key: 'reader' as const, setting: 'textReader' as const, icon: Speech },
    {
      key: 'cursor' as const,
      setting: 'bigCursor' as const,
      icon: MousePointer,
    },
    { key: 'font' as const, setting: 'readableMode' as const, icon: Eye },
    { key: 'motion' as const, setting: 'reducedMotion' as const, icon: Hand },
  ];

  return (
    <>
      <div
        className={cn(
          'fixed z-50 right-4',
          isMobile ? 'bottom-24' : 'bottom-4'
        )}
      >
        <Button
          data-accessibility-trigger
          variant={showAccessibilityPanel ? 'default' : 'outline'}
          size="icon"
          className={cn(
            'accessibility-button rounded-full shadow-lg transition-all duration-300',
            'hover:shadow-xl bg-white border-2',
            showAccessibilityPanel
              ? 'bg-blue-600 border-blue-600 text-white shadow-blue-200'
              : 'border-blue-200 hover:border-blue-400 hover:bg-blue-50',
            hasChanges && 'ring-2 ring-blue-400 ring-opacity-50 ring-offset-2',
            className
          )}
          onClick={() => setShowAccessibilityPanel(!showAccessibilityPanel)}
          title={
            showAccessibilityPanel
              ? dict.triggerButton.close
              : dict.triggerButton.open
          }
        >
          <div className="relative">
            {showAccessibilityPanel ? (
              <X className="h-5 w-5" />
            ) : (
              <Accessibility className="h-5 w-5" />
            )}
            {hasChanges && !showAccessibilityPanel && (
              <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-600 rounded-full pulse-animation" />
            )}
          </div>
        </Button>
      </div>

      {showAccessibilityPanel && (
        <div
          ref={panelRef}
          className={cn(
            'fixed z-40 bottom-20 right-4 max-w-sm w-[340px]',
            'accessibility-panel-enter accessibility-panel-enter-active'
          )}
        >
          <Card className="shadow-2xl border-2 border-blue-100 bg-white">
            <CardHeader className="pb-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-lg">
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg flex items-center gap-2 text-slate-800">
                  <div className="p-1.5 bg-blue-100 rounded-lg">
                    <Settings className="h-4 w-4 text-blue-600" />
                  </div>
                  {dict.panelTitle}
                  {hasChanges && (
                    <Badge
                      variant="secondary"
                      className="text-xs bg-blue-100 text-blue-700 border-blue-200"
                    >
                      <Sparkles className="h-3 w-3 mr-1" />
                      {dict.changedBadge}
                    </Badge>
                  )}
                </CardTitle>
              </div>
              <p className="text-xs text-slate-600 mt-1">
                {dict.panelSubtitle}
              </p>
            </CardHeader>

            <CardContent className="space-y-6 pt-5 max-h-[65vh] overflow-y-auto">
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <Label className="text-sm font-medium flex items-center gap-2">
                    <Type className="h-4 w-4 text-blue-500" />
                    {dict.textSize.title}
                  </Label>
                  <div className="flex items-center gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-8 w-8 p-0 hover:bg-blue-50 border-blue-200"
                      onClick={() =>
                        updateSetting(
                          'fontScale',
                          Math.max(0.8, settings.fontScale - 0.1)
                        )
                      }
                      disabled={settings.fontScale <= 0.8}
                    >
                      <Minus className="h-3 w-3" />
                    </Button>
                    <Badge
                      variant="outline"
                      className="min-w-[55px] text-center font-mono bg-blue-50 border-blue-200"
                    >
                      {Math.round(settings.fontScale * 100)}%
                    </Badge>
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-8 w-8 p-0 hover:bg-blue-50 border-blue-200"
                      onClick={() =>
                        updateSetting(
                          'fontScale',
                          Math.min(1.6, settings.fontScale + 0.1)
                        )
                      }
                      disabled={settings.fontScale >= 1.6}
                    >
                      <Plus className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
                <Slider
                  value={[settings.fontScale * 100]}
                  min={80}
                  max={160}
                  step={5}
                  onValueChange={(value) =>
                    updateSetting('fontScale', value[0] / 100)
                  }
                  className="py-2"
                />
                <p className="text-xs text-slate-500">
                  {dict.textSize.description}
                </p>
              </div>

              <div className="space-y-4">
                <Label className="text-sm font-medium flex items-center gap-2">
                  <Palette className="h-4 w-4 text-blue-500" />
                  {dict.displayMode.title}
                </Label>
                <div className="grid grid-cols-3 gap-2">
                  {contrastOptions.map(({ key, icon: Icon }) => {
                    const optionDict = dict.contrastOptions[key];
                    return (
                      <Button
                        key={key}
                        variant={
                          settings.contrastMode === key ? 'default' : 'outline'
                        }
                        size="sm"
                        className={cn(
                          'h-14 flex flex-col gap-1 text-xs transition-all relative',
                          settings.contrastMode === key
                            ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                            : 'hover:bg-blue-50 border-blue-200'
                        )}
                        onClick={() => updateSetting('contrastMode', key)}
                        title={optionDict.description}
                      >
                        <Icon className="h-4 w-4" />
                        <span className="font-medium">{optionDict.label}</span>
                        {settings.contrastMode === key && (
                          <div className="absolute top-1 right-1">
                            <Check className="h-3 w-3" />
                          </div>
                        )}
                      </Button>
                    );
                  })}
                </div>
              </div>

              <div className="space-y-4 pt-2 border-t border-slate-200">
                <Label className="text-sm font-medium text-slate-700">
                  {dict.additionalSettings.title}
                </Label>
                {advancedOptions.map(({ key, setting, icon: Icon }) => {
                  const optionDict = dict.advancedOptions[key];
                  return (
                    <div
                      key={key}
                      className="setting-card flex items-center justify-between group p-3 rounded-lg"
                    >
                      <div className="flex items-center gap-3">
                        <div
                          className={cn(
                            'p-2 rounded-lg transition-colors',
                            settings[setting]
                              ? 'bg-blue-100 text-blue-600'
                              : 'bg-slate-100 text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-500'
                          )}
                        >
                          <Icon className="h-4 w-4" />
                        </div>
                        <div className="flex-1">
                          <Label className="text-sm font-medium cursor-pointer">
                            {optionDict.label}
                          </Label>
                          <p className="text-xs text-slate-500 mt-0.5 leading-relaxed">
                            {optionDict.description}
                          </p>
                        </div>
                      </div>
                      <Switch
                        checked={settings[setting]}
                        onCheckedChange={(checked) => {
                          if (setting === 'textReader') toggleTextReader();
                          else updateSetting(setting, checked);
                        }}
                      />
                    </div>
                  );
                })}
              </div>

              <div className="pt-4 border-t border-slate-200">
                <Button
                  variant="outline"
                  size="sm"
                  className={cn(
                    'w-full flex items-center gap-2 transition-all',
                    hasChanges
                      ? 'hover:bg-red-50 hover:border-red-200 hover:text-red-700'
                      : 'opacity-50 cursor-not-allowed'
                  )}
                  onClick={resetSettings}
                  disabled={!hasChanges}
                >
                  <RefreshCw className="h-4 w-4" />
                  {dict.resetButton}
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {showToast.visible && (
        <div className="fixed bottom-4 left-4 z-50 toast-enter toast-enter-active">
          <div className="bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 border border-green-500">
            <div className="p-1 bg-green-500 rounded-full">
              <Check className="h-3 w-3" />
            </div>
            <span className="text-sm font-medium">{showToast.message}</span>
          </div>
        </div>
      )}
    </>
  );
}
--- End of Content for AccessibilityFeatures.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\FAQ.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/FAQ.tsx
'use client';

import React, { useState, useMemo } from 'react';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { cn } from '@/lib/utils';
import {
  Search,
  HelpCircle,
  ArrowRight,
  Info,
  Clock,
  Star,
  AlertCircle,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import type { QuestionnaireFaqDict, FaqAnswerPart } from '@/types/dictionary';

interface FAQProps {
  className?: string;
  showSearch?: boolean;
  showCategories?: boolean;
  initialOpenId?: string;
  dict: QuestionnaireFaqDict;
}

// Metadata for FAQs (category, popularity) which is NOT in the dictionary
// Keys must match the keys in dict.items
const faqMetadata: {
  [key: string]: {
    category: keyof QuestionnaireFaqDict['categories'];
    isPopular?: boolean;
  };
} = {
  'save-progress': { category: 'technical', isPopular: true },
  'time-to-complete': { category: 'process', isPopular: true },
  'required-questions': { category: 'process' },
  'how-matching-works': { category: 'process', isPopular: true },
  'privacy-info': { category: 'privacy' },
  'edit-answers': { category: 'technical' },
  'match-percentage': { category: 'results' },
  'incomplete-questionnaire': { category: 'process' },
  'inactive-account': { category: 'general' },
};

// Helper function to render the answer JSX from dictionary data
const renderAnswer = (answerParts: FaqAnswerPart[]) => (
  <div className="space-y-3">
    {answerParts.map((part, index) => {
      switch (part.type) {
        case 'p':
          return <p key={index}>{part.content}</p>;
        case 'list':
          return (
            <ol key={index} className="list-decimal mr-5 space-y-1 pr-5">
              {(part.content as string[]).map((item, i) => (
                <li key={i}>{item}</li>
              ))}
            </ol>
          );
        case 'tip':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-blue-50 rounded-md"
            >
              <Clock className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-blue-700">
                {part.title && <p className="font-medium mb-1">{part.title}</p>}
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'info':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-blue-50 rounded-md"
            >
              <Info className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-blue-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'star':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-amber-50 rounded-md border border-amber-100"
            >
              <Star className="h-5 w-5 text-amber-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-amber-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        case 'alert':
          return (
            <div
              key={index}
              className="flex items-start gap-2 mt-2 p-3 bg-red-50 rounded-md border border-red-100"
            >
              <AlertCircle className="h-5 w-5 text-red-500 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-red-700">
                <p>{part.content}</p>
              </div>
            </div>
          );
        default:
          return null;
      }
    })}
  </div>
);

export default function FAQ({
  className,
  showSearch = true,
  showCategories = true,
  initialOpenId,
  dict,
}: FAQProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [activeCategory, setActiveCategory] = useState<string | null>(null);
  const [expandedItems, setExpandedItems] = useState<string[]>(
    initialOpenId ? [initialOpenId] : []
  );

  const faqItems = useMemo(() => {
    return Object.keys(dict.items).map((id) => {
      const key = id as keyof typeof dict.items;
      return {
        id,
        question: dict.items[key].question,
        answer: renderAnswer(dict.items[key].answer),
        category: faqMetadata[key]?.category || 'general',
        isPopular: faqMetadata[key]?.isPopular || false,
      };
    });
  }, [dict]);

  const categories = useMemo(
    () => [
      {
        id: 'process',
        label: dict.categories.process,
        icon: <ArrowRight className="h-4 w-4" />,
      },
      {
        id: 'technical',
        label: dict.categories.technical,
        icon: <HelpCircle className="h-4 w-4" />,
      },
      {
        id: 'privacy',
        label: dict.categories.privacy,
        icon: <Info className="h-4 w-4" />,
      },
      {
        id: 'results',
        label: dict.categories.results,
        icon: <Star className="h-4 w-4" />,
      },
      {
        id: 'general',
        label: dict.categories.general,
        icon: <Info className="h-4 w-4" />,
      },
    ],
    [dict.categories]
  );

  const filteredItems = useMemo(() => {
    return faqItems.filter((item) => {
      const matchesSearch =
        !searchQuery ||
        item.question.toLowerCase().includes(searchQuery.toLowerCase());

      const matchesCategory =
        !activeCategory || item.category === activeCategory;

      return matchesSearch && matchesCategory;
    });
  }, [faqItems, searchQuery, activeCategory]);

  return (
    <Card className={cn('shadow-sm', className)}>
      <CardHeader className="pb-3">
        <CardTitle className="text-lg md:text-xl">{dict.title}</CardTitle>
        <p className="text-gray-500 text-sm">{dict.subtitle}</p>

        {showSearch && (
          <div className="relative mt-2">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
            <Input
              placeholder={dict.searchPlaceholder}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 bg-gray-50"
            />
          </div>
        )}

        {showCategories && (
          <div className="flex flex-wrap gap-2 mt-3">
            <Badge
              variant={activeCategory === null ? 'default' : 'outline'}
              className="cursor-pointer"
              onClick={() => setActiveCategory(null)}
            >
              {dict.categories.all}
            </Badge>

            {categories.map((category) => (
              <Badge
                key={category.id}
                variant={activeCategory === category.id ? 'default' : 'outline'}
                className="cursor-pointer flex items-center gap-1"
                onClick={() =>
                  setActiveCategory(
                    activeCategory === category.id ? null : category.id
                  )
                }
              >
                {category.icon}
                {category.label}
              </Badge>
            ))}
          </div>
        )}
      </CardHeader>

      <CardContent>
        {filteredItems.length === 0 ? (
          <div className="text-center py-8">
            <HelpCircle className="h-12 w-12 mx-auto text-gray-300 mb-2" />
            <p className="text-gray-500">{dict.emptyState}</p>
          </div>
        ) : (
          <Accordion
            type="multiple"
            value={expandedItems}
            onValueChange={setExpandedItems}
            className="space-y-2"
          >
            {filteredItems.map((item) => (
              <AccordionItem
                key={item.id}
                value={item.id}
                className={cn(
                  'border rounded-lg px-4 py-1',
                  expandedItems.includes(item.id)
                    ? 'bg-blue-50 border-blue-200'
                    : 'bg-white border-gray-200 hover:border-blue-200'
                )}
              >
                <AccordionTrigger className="hover:no-underline py-3">
                  <div className="flex items-center gap-2 text-right">
                    <span className="font-medium text-start">
                      {item.question}
                    </span>
                    {item.isPopular && (
                      <Badge
                        variant="outline"
                        className="bg-amber-50 text-amber-700 border-amber-200 text-xs whitespace-nowrap"
                      >
                        {dict.popularBadge}
                      </Badge>
                    )}
                  </div>
                </AccordionTrigger>
                <AccordionContent className="text-gray-700 pt-1 pb-4">
                  {item.answer}
                </AccordionContent>
              </AccordionItem>
            ))}
          </Accordion>
        )}
      </CardContent>
    </Card>
  );
}
--- End of Content for FAQ.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\MatchResultCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/MatchResultCard.tsx
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  X,
  MessageCircle,
  User,
  MapPin,
  Calendar,
  GraduationCap,
  Briefcase,
  Sparkles,
  Star,
  BookOpen,
  ChevronsDown,
  ChevronsUp,
  Music,
  Coffee,
  Bookmark,
  ExternalLink,
} from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { MatchResultCardDict } from '@/types/dictionary';

interface MatchTrait {
  name: string;
  score: number; // 0-100
  description?: string;
}

interface CommonInterest {
  name: string;
  category:
    | 'hobby'
    | 'value'
    | 'lifestyle'
    | 'religion'
    | 'education'
    | 'other';
  icon?: React.ReactNode;
}

interface MatchResultCardProps {
  id: string;
  name: string;
  age: number;
  location: string;
  distance?: number;
  profileImage?: string;
  matchPercentage: number;
  occupation?: string;
  education?: string;
  about?: string;
  matchTraits?: MatchTrait[];
  commonInterests?: CommonInterest[];
  lastActive?: Date;
  conversationStarted?: boolean;
  bookmarked?: boolean;
  className?: string;
  onAccept?: (id: string) => void;
  onReject?: (id: string) => void;
  onMessage?: (id: string) => void;
  onViewProfile?: (id: string) => void;
  onBookmark?: (id: string, bookmarked: boolean) => void;
  isPremium?: boolean;
  dict: MatchResultCardDict;
}

export default function MatchResultCard({
  id,
  name,
  age,
  location,
  distance,
  profileImage,
  matchPercentage,
  occupation,
  education,
  about,
  matchTraits = [],
  commonInterests = [],
  lastActive,
  conversationStarted = false,
  bookmarked = false,
  className,
  onAccept,
  onReject,
  onMessage,
  onViewProfile,
  onBookmark,
  isPremium = false,
  dict,
}: MatchResultCardProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isBookmarked, setIsBookmarked] = useState(bookmarked);
  const [showConfirmReject, setShowConfirmReject] = useState(false);

  const getCategoryIcon = (category: string) => {
    switch (category) {
      case 'hobby':
        return <Music className="h-3.5 w-3.5" />;
      case 'value':
        return <Heart className="h-3.5 w-3.5" />;
      case 'lifestyle':
        return <Coffee className="h-3.5 w-3.5" />;
      case 'religion':
        return <BookOpen className="h-3.5 w-3.5" />;
      case 'education':
        return <GraduationCap className="h-3.5 w-3.5" />;
      default:
        return <Star className="h-3.5 w-3.5" />;
    }
  };

  const formatLastActive = (date?: Date) => {
    if (!date) return dict.lastActiveFormat.unknown;
    const now = new Date();
    const diffInDays = Math.floor(
      (now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24)
    );
    if (diffInDays === 0) return dict.lastActiveFormat.today;
    if (diffInDays === 1) return dict.lastActiveFormat.yesterday;
    if (diffInDays < 7)
      return dict.lastActiveFormat.daysAgo.replace(
        '{{count}}',
        diffInDays.toString()
      );
    const diffInWeeks = Math.floor(diffInDays / 7);
    if (diffInDays < 30)
      return dict.lastActiveFormat.weeksAgo.replace(
        '{{count}}',
        diffInWeeks.toString()
      );
    const diffInMonths = Math.floor(diffInDays / 30);
    return dict.lastActiveFormat.monthsAgo.replace(
      '{{count}}',
      diffInMonths.toString()
    );
  };

  const handleBookmark = () => {
    setIsBookmarked(!isBookmarked);
    if (onBookmark) onBookmark(id, !isBookmarked);
  };

  const getMatchColor = () => {
    if (matchPercentage >= 90) return 'from-green-400 to-emerald-500';
    if (matchPercentage >= 80) return 'from-emerald-400 to-green-500';
    if (matchPercentage >= 70) return 'from-blue-400 to-blue-500';
    if (matchPercentage >= 60) return 'from-blue-400 to-cyan-500';
    return 'from-cyan-400 to-blue-500';
  };

  const expandVariants = {
    hidden: { height: 0, opacity: 0 },
    visible: {
      height: 'auto',
      opacity: 1,
      transition: {
        height: { duration: 0.3 },
        opacity: { duration: 0.3, delay: 0.1 },
      },
    },
  };

  return (
    <Card
      className={cn(
        'overflow-hidden transition-all border',
        isExpanded ? 'shadow-md' : 'shadow-sm hover:shadow-md',
        isPremium ? 'border-amber-200' : 'border-blue-100',
        className
      )}
    >
      {isPremium && (
        <div className="absolute top-0 left-0 bg-gradient-to-r from-amber-400 to-amber-600 text-white px-2 py-0.5 text-xs rounded-br-md z-10">
          <Sparkles className="h-3 w-3 inline-block mr-1" />
          {dict.premiumBadge}
        </div>
      )}

      <div className="p-4 flex md:flex-row flex-col gap-4">
        <div className="relative">
          <Avatar className="w-24 h-24 rounded-lg border-2 border-white shadow-sm">
            <AvatarImage src={profileImage} alt={name} />
            <AvatarFallback className="bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600 text-3xl">
              {name.charAt(0)}
            </AvatarFallback>
          </Avatar>
          <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2">
            <Badge
              className={cn(
                'rounded-full bg-gradient-to-r px-2 text-white border-0 shadow-sm',
                getMatchColor()
              )}
            >
              <Sparkles className="h-3 w-3 mr-1" />
              {dict.matchPercentageBadge.replace(
                '{{percentage}}',
                matchPercentage.toString()
              )}
            </Badge>
          </div>
        </div>

        <div className="flex-1 space-y-2">
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-lg font-medium">
                {name}, {age}
              </h3>
              <div className="flex items-center text-sm text-gray-600">
                <MapPin className="h-3.5 w-3.5 mr-1" />
                {location}
                {distance && <span className="mr-1">({distance} קמ)</span>}
              </div>
            </div>
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="ghost"
                    size="icon"
                    className={cn(
                      'h-8 w-8 rounded-full',
                      isBookmarked ? 'text-amber-500' : 'text-gray-400'
                    )}
                    onClick={handleBookmark}
                  >
                    <Bookmark className="h-5 w-5" />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>
                    {isBookmarked
                      ? dict.tooltips.removeFromBookmarks
                      : dict.tooltips.addToBookmarks}
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>

          <div className="space-y-1">
            {occupation && (
              <div className="flex items-center text-sm text-gray-600">
                <Briefcase className="h-3.5 w-3.5 mr-1 text-gray-500" />
                {occupation}
              </div>
            )}
            {education && (
              <div className="flex items-center text-sm text-gray-600">
                <GraduationCap className="h-3.5 w-3.5 mr-1 text-gray-500" />
                {education}
              </div>
            )}
          </div>

          {commonInterests.length > 0 && (
            <div className="flex flex-wrap gap-1 pt-1">
              {commonInterests.slice(0, 3).map((interest, index) => (
                <Badge
                  key={index}
                  variant="outline"
                  className="bg-blue-50 text-blue-700 border-blue-200 text-xs py-0 h-5"
                >
                  {interest.icon || getCategoryIcon(interest.category)}
                  <span className="mr-1 truncate max-w-[100px]">
                    {interest.name}
                  </span>
                </Badge>
              ))}
              {commonInterests.length > 3 && (
                <Badge
                  variant="outline"
                  className="bg-gray-50 text-gray-600 border-gray-200 text-xs"
                >
                  +{commonInterests.length - 3}
                </Badge>
              )}
            </div>
          )}
        </div>
      </div>

      <div className="px-4 pb-3 flex gap-2 justify-center">
        {onReject &&
          (showConfirmReject ? (
            <>
              <Button
                variant="destructive"
                size="sm"
                className="flex-1"
                onClick={() => onReject(id)}
              >
                {dict.buttons.confirmReject}
              </Button>
              <Button
                variant="outline"
                size="sm"
                className="flex-1"
                onClick={() => setShowConfirmReject(false)}
              >
                {dict.buttons.cancel}
              </Button>
            </>
          ) : (
            <Button
              variant="outline"
              size="sm"
              className="flex-1 border-red-200 text-red-600 hover:bg-red-50 hover:text-red-700"
              onClick={() => setShowConfirmReject(true)}
            >
              <X className="h-4 w-4 mr-1" />
              {dict.buttons.reject}
            </Button>
          ))}
        {onAccept && (
          <Button
            variant="default"
            size="sm"
            className="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700"
            onClick={() => onAccept(id)}
          >
            <Heart className="h-4 w-4 mr-1" />
            {dict.buttons.accept}
          </Button>
        )}
        {conversationStarted && onMessage && (
          <Button
            variant="default"
            size="sm"
            className="flex-1"
            onClick={() => onMessage(id)}
          >
            <MessageCircle className="h-4 w-4 mr-1" />
            {dict.buttons.continueChat}
          </Button>
        )}
      </div>

      <div className="px-4 pb-2 text-center">
        <Button
          variant="ghost"
          size="sm"
          className="text-xs text-gray-500 hover:text-gray-700"
          onClick={() => setIsExpanded(!isExpanded)}
        >
          {isExpanded ? (
            <>
              <ChevronsUp className="h-3.5 w-3.5 mr-1" />
              {dict.buttons.hideMore}
            </>
          ) : (
            <>
              <ChevronsDown className="h-3.5 w-3.5 mr-1" />
              {dict.buttons.showMore}
            </>
          )}
        </Button>
      </div>

      <AnimatePresence>
        {isExpanded && (
          <motion.div
            variants={expandVariants}
            initial="hidden"
            animate="visible"
            exit="hidden"
            className="border-t border-gray-100"
          >
            <CardContent className="p-4 space-y-5">
              {about && (
                <div className="space-y-2">
                  <h4 className="text-sm font-medium flex items-center">
                    <User className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.about.replace('{{name}}', name)}
                  </h4>
                  <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border">
                    {about}
                  </p>
                </div>
              )}
              {matchTraits.length > 0 && (
                <div className="space-y-3">
                  <h4 className="text-sm font-medium flex items-center">
                    <Sparkles className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.topMatches}
                  </h4>
                  <div className="space-y-2">
                    {matchTraits.map((trait, index) => (
                      <TooltipProvider key={index}>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <div className="space-y-1">
                              <div className="flex justify-between text-sm">
                                <span>{trait.name}</span>
                                <span className="text-sm text-gray-600">
                                  {trait.score}%
                                </span>
                              </div>
                              <Progress
                                value={trait.score}
                                className={cn(
                                  'h-2',
                                  trait.score >= 80
                                    ? '[--progress-foreground:theme(colors.green.500)]'
                                    : trait.score >= 60
                                      ? '[--progress-foreground:theme(colors.blue.500)]'
                                      : '[--progress-foreground:theme(colors.blue.400)]'
                                )}
                              />
                            </div>
                          </TooltipTrigger>
                          {trait.description && (
                            <TooltipContent side="top" className="max-w-xs">
                              <p>
                                {dict.tooltips.traitDescription.replace(
                                  '{{description}}',
                                  trait.description
                                )}
                              </p>
                            </TooltipContent>
                          )}
                        </Tooltip>
                      </TooltipProvider>
                    ))}
                  </div>
                </div>
              )}
              {commonInterests.length > 0 && (
                <div className="space-y-3">
                  <h4 className="text-sm font-medium flex items-center">
                    <Heart className="h-4 w-4 mr-1 text-blue-500" />
                    {dict.sections.commonInterests}
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {commonInterests.map((interest, index) => (
                      <Badge
                        key={index}
                        variant="outline"
                        className={cn(
                          'bg-blue-50 text-blue-700 border-blue-200',
                          interest.category === 'value' &&
                            'bg-pink-50 text-pink-700 border-pink-200',
                          interest.category === 'religion' &&
                            'bg-purple-50 text-purple-700 border-purple-200',
                          interest.category === 'education' &&
                            'bg-emerald-50 text-emerald-700 border-emerald-200'
                        )}
                      >
                        {interest.icon || getCategoryIcon(interest.category)}
                        <span className="mr-1">{interest.name}</span>
                      </Badge>
                    ))}
                  </div>
                </div>
              )}
              {lastActive && (
                <div className="text-sm text-gray-500 flex items-center">
                  <Calendar className="h-4 w-4 mr-1 text-gray-400" />
                  {dict.sections.lastActive.replace(
                    '{{time}}',
                    formatLastActive(lastActive)
                  )}
                </div>
              )}
            </CardContent>
            <CardFooter className="px-4 py-3 bg-gray-50 flex justify-between">
              {onViewProfile && (
                <Button
                  variant="outline"
                  size="sm"
                  className="w-full"
                  onClick={() => onViewProfile(id)}
                >
                  <ExternalLink className="h-4 w-4 mr-1" />
                  {dict.buttons.viewFullProfile}
                </Button>
              )}
            </CardFooter>
          </motion.div>
        )}
      </AnimatePresence>
    </Card>
  );
}
--- End of Content for MatchResultCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\components\UserStats.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/components/UserStats.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  UserCheck,
  Users,
  Calendar,
  Sparkles,
  Heart,
  CheckCheck,
  BarChart4,
  Zap,
  Award,
  Star,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { UserStatsDict } from '@/types/dictionary';

interface UserStatsProps {
  totalQuestionsAnswered: number;
  totalQuestionsCount: number;
  activeMatches?: number;
  pendingMatches?: number;
  matchScore?: number;
  profileCompletion?: number;
  activeWorldsCompleted?: string[];
  personalityTraits?: Array<{
    trait: string;
    score: number;
  }>;
  activityLevel?: 'low' | 'medium' | 'high';
  registrationDate?: Date;
  lastActive?: Date;
  className?: string;
  dict: UserStatsDict;
}

export default function UserStats({
  totalQuestionsAnswered,
  totalQuestionsCount,
  activeMatches = 0,
  pendingMatches = 0,
  matchScore = 0,
  profileCompletion = 0,
  activeWorldsCompleted = [],
  personalityTraits = [],
  activityLevel = 'medium',
  registrationDate,
  className,
  dict,
}: UserStatsProps) {
  const formatDate = (date?: Date) => {
    if (!date) return dict.common.notAvailable;
    return date.toLocaleDateString('he-IL');
  };

  const getDaysActive = () => {
    if (!registrationDate) return 0;
    const today = new Date();
    const diffTime = Math.abs(today.getTime() - registrationDate.getTime());
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  };

  const getActivityLevelColor = () => {
    switch (activityLevel) {
      case 'high':
        return 'text-green-600 bg-green-100';
      case 'medium':
        return 'text-blue-600 bg-blue-100';
      case 'low':
        return 'text-amber-600 bg-amber-100';
      default:
        return 'text-gray-600 bg-gray-100';
    }
  };

  const worldConfig = [
    { id: 'PERSONALITY', color: 'blue' },
    { id: 'VALUES', color: 'emerald' },
    { id: 'RELATIONSHIP', color: 'purple' },
    { id: 'PARTNER', color: 'pink' },
    { id: 'RELIGION', color: 'indigo' },
  ];

  return (
    <div className={cn('space-y-4', className)}>
      <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
        <CardHeader className="pb-2">
          <CardTitle className="text-lg flex items-center">
            <UserCheck className="h-5 w-5 mr-2 text-blue-500" />
            {dict.matchStatsCard.title}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
              <div className="text-xs text-gray-600 mb-1">
                {dict.matchStatsCard.activeMatches}
              </div>
              <div className="flex items-center">
                <Users className="h-5 w-5 text-blue-600 mr-2" />
                <span className="text-2xl font-semibold">{activeMatches}</span>
              </div>
            </div>
            <div className="bg-amber-50 p-3 rounded-lg border border-amber-100">
              <div className="text-xs text-gray-600 mb-1">
                {dict.matchStatsCard.pendingMatches}
              </div>
              <div className="flex items-center">
                <Calendar className="h-5 w-5 text-amber-600 mr-2" />
                <span className="text-2xl font-semibold">{pendingMatches}</span>
              </div>
            </div>
            <div className="col-span-2 bg-gray-50 p-3 rounded-lg border">
              <div className="flex justify-between mb-1">
                <div className="text-xs text-gray-600">
                  {dict.matchStatsCard.matchScore}
                </div>
                <Badge variant="outline" className="text-xs">
                  {matchScore}%
                </Badge>
              </div>
              <Progress
                value={matchScore}
                className={cn(
                  'h-2',
                  matchScore > 70
                    ? '[--progress-foreground:theme(colors.green.500)]'
                    : '[--progress-foreground:theme(colors.blue.500)]'
                )}
              />
            </div>
            <div className="col-span-2 flex justify-between text-sm p-2">
              <div className="flex items-center text-gray-600">
                <Sparkles className="h-4 w-4 mr-1 text-blue-400" />
                {dict.matchStatsCard.daysActive.replace(
                  '{{days}}',
                  getDaysActive().toString()
                )}
              </div>
              <div className="text-gray-600">
                {dict.matchStatsCard.joinDate.replace(
                  '{{date}}',
                  formatDate(registrationDate)
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
        <CardHeader className="pb-2">
          <CardTitle className="text-lg flex items-center">
            <BarChart4 className="h-5 w-5 mr-2 text-blue-500" />
            {dict.profileProgressCard.title}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="space-y-1">
              <div className="flex justify-between text-sm">
                <div className="flex items-center">
                  <CheckCheck className="h-4 w-4 mr-1 text-blue-500" />
                  {dict.profileProgressCard.profileCompletion}
                </div>
                <Badge
                  variant="outline"
                  className={cn(
                    'text-xs',
                    profileCompletion >= 80
                      ? 'border-green-500 text-green-600'
                      : 'border-amber-500 text-amber-600'
                  )}
                >
                  {profileCompletion}%
                </Badge>
              </div>
              <Progress
                value={profileCompletion}
                className={cn(
                  'h-2',
                  profileCompletion < 30
                    ? '[--progress-foreground:theme(colors.red.500)]'
                    : profileCompletion < 70
                      ? '[--progress-foreground:theme(colors.amber.500)]'
                      : '[--progress-foreground:theme(colors.green.500)]'
                )}
              />
            </div>
            <div className="space-y-1">
              <div className="flex justify-between text-sm">
                <div className="flex items-center">
                  <Zap className="h-4 w-4 mr-1 text-amber-500" />
                  {dict.profileProgressCard.questionsAnswered}
                </div>
                <span className="text-xs text-gray-600">
                  {totalQuestionsAnswered} {dict.profileProgressCard.outOf}{' '}
                  {totalQuestionsCount}
                </span>
              </div>
              <Progress
                value={(totalQuestionsAnswered / totalQuestionsCount) * 100}
                className="h-2"
              />
            </div>
            <div className="pt-2">
              <div className="text-sm mb-2 flex items-center">
                <Heart className="h-4 w-4 mr-1 text-pink-500" />
                <span>{dict.profileProgressCard.completedWorlds}</span>
              </div>
              <div className="flex flex-wrap gap-2">
                {worldConfig.map((world) => {
                  const isCompleted = activeWorldsCompleted.includes(world.id);
                  const worldName =
                    dict.worlds[world.id as keyof typeof dict.worlds];
                  return (
                    <Badge
                      key={world.id}
                      variant={isCompleted ? 'default' : 'outline'}
                      className={
                        isCompleted
                          ? `bg-${world.color}-100 hover:bg-${world.color}-200 text-${world.color}-800 border-${world.color}-200`
                          : `text-gray-500 border-gray-200 bg-gray-50`
                      }
                    >
                      {isCompleted && <CheckCheck className="h-3 w-3 mr-1" />}
                      {worldName}
                    </Badge>
                  );
                })}
              </div>
            </div>
            {activityLevel && (
              <div className="flex justify-between items-center pt-2 text-sm text-gray-600">
                <div>{dict.profileProgressCard.activityLevel}</div>
                <Badge
                  variant="outline"
                  className={cn(
                    'font-normal border-0',
                    getActivityLevelColor()
                  )}
                >
                  {dict.activityLevels[activityLevel]}
                </Badge>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {personalityTraits && personalityTraits.length > 0 && (
        <Card className="shadow-sm hover:shadow-md transition-shadow border-blue-100">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg flex items-center">
              <Award className="h-5 w-5 mr-2 text-blue-500" />
              {dict.personalityTraitsCard.title}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {personalityTraits.map((trait, index) => (
                <TooltipProvider key={index}>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <div className="space-y-1">
                        <div className="flex justify-between text-sm">
                          <div className="flex items-center">
                            <Star className="h-3.5 w-3.5 mr-1 text-amber-500" />
                            {trait.trait}
                          </div>
                          <span className="text-xs">{trait.score}%</span>
                        </div>
                        <Progress
                          value={trait.score}
                          className={cn(
                            'h-1.5',
                            'relative overflow-hidden',
                            'before:absolute before:inset-0 before:bg-gradient-to-r before:from-blue-400',
                            trait.score < 40
                              ? 'before:to-blue-500'
                              : trait.score < 70
                                ? 'before:to-purple-500'
                                : 'before:to-pink-500'
                          )}
                        />
                      </div>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>
                        {dict.tooltips.traitScore.replace(
                          '{{score}}',
                          trait.score.toString()
                        )}
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
--- End of Content for UserStats.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks\useIdleTimeout.ts
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/hooks/useIdleTimeout.ts
import { useState, useEffect, useCallback, useRef } from 'react';

interface UseIdleTimeoutProps {
  onIdle: () => void;
  idleTimeSeconds?: number;
}

export function useIdleTimeout({ onIdle, idleTimeSeconds = 7200 }: UseIdleTimeoutProps) { // ברירת מחדל: שעתיים
  const [isIdle, setIsIdle] = useState(false);
  // --- This is the corrected line ---
  const timeoutId = useRef<NodeJS.Timeout | null>(null);

  const startTimer = useCallback(() => {
    // Clear any existing timer before starting a new one
    if (timeoutId.current) {
      clearTimeout(timeoutId.current);
    }
    
    timeoutId.current = setTimeout(() => {
      setIsIdle(true);
      onIdle();
    }, idleTimeSeconds * 1000);
  }, [idleTimeSeconds, onIdle]);

  const resetTimer = useCallback(() => {
    // The previous implementation was already correct, it just needed the right type
    if (timeoutId.current) {
      clearTimeout(timeoutId.current);
    }
    setIsIdle(false);
    startTimer();
  }, [startTimer]);

  const handleEvent = useCallback(() => {
    resetTimer();
  }, [resetTimer]);

  useEffect(() => {
    // אירועים שיאפסו את הטיימר
    const events = ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'];
    
    // התחלת הטיימר הראשוני
    startTimer();

    // הוספת מאזינים
    events.forEach(event => window.addEventListener(event, handleEvent));

    // ניקוי
    return () => {
      if (timeoutId.current) {
        clearTimeout(timeoutId.current);
      }
      events.forEach(event => window.removeEventListener(event, handleEvent));
    };
  }, [handleEvent, startTimer]);

  return { isIdle, resetTimer };
}
--- End of Content for useIdleTimeout.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\hooks\useMediaQuery.ts
--------------------------------------------------------------------------------
Content:
import { useState, useEffect } from "react";

/**
 * הוק המאפשר לנטר שינויים במדיה קוורי
 * 
 * @param query מחרוזת מדיה קוורי כגון "(max-width: 768px)"
 * @returns בוליאני המציין האם המדיה קוורי פעיל
 * 
 * דוגמאות לשימוש:
 * const isMobile = useMediaQuery("(max-width: 768px)");
 * const isTablet = useMediaQuery("(min-width: 769px) and (max-width: 1024px)");
 * const isDesktop = useMediaQuery("(min-width: 1025px)");
 */
export function useMediaQuery(query: string): boolean {
  // מצב התאמת המדיה הנוכחית
  const [matches, setMatches] = useState<boolean>(false);

  // זיהוי האם אנו נמצאים בסביבת דפדפן
  const isBrowser = typeof window !== "undefined";

  useEffect(() => {
    // אם איננו בדפדפן, אין טעם להמשיך
    if (!isBrowser) {
      return undefined;
    }

    // בדיקה ראשונית של התאמת המדיה
    const media = window.matchMedia(query);
    setMatches(media.matches);

    // כשמתרחש שינוי בהתאמת המדיה, עדכן את המצב
    const listener = (event: MediaQueryListEvent) => {
      setMatches(event.matches);
    };

    // רישום האזנה לשינויים
    if (media.addEventListener) {
      media.addEventListener("change", listener);
    } else {
      // תמיכה בדפדפנים ישנים יותר
      media.addListener(listener);
    }

    // ניקוי האזנה בעת עזיבת הקומפוננטה
    return () => {
      if (media.removeEventListener) {
        media.removeEventListener("change", listener);
      } else {
        // תמיכה בדפדפנים ישנים יותר
        media.removeListener(listener);
      }
    };
  }, [query, isBrowser]);

  return matches;
}

// מקצרים נפוצים לשימוש
export function useIsMobile() {
  return useMediaQuery("(max-width: 767px)");
}

export function useIsTablet() {
  return useMediaQuery("(min-width: 768px) and (max-width: 1023px)");
}

export function useIsDesktop() {
  return useMediaQuery("(min-width: 1024px)");
}

export function useIsDarkMode() {
  return useMediaQuery("(prefers-color-scheme: dark)");
}

export function useReducedMotion() {
  return useMediaQuery("(prefers-reduced-motion: reduce)");
}

export default useMediaQuery;
--- End of Content for useMediaQuery.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\QuestionnaireLayout.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/QuestionnaireLayout.tsx
'use client';

import React, { useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import {
  Loader2,
  Menu,
  Save,
  CheckCircle,
  LogIn,
  UserPlus,
} from 'lucide-react';
import type { WorldId } from '../types/types';
import { cn } from '@/lib/utils';
import { useMediaQuery } from '../hooks/useMediaQuery';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { QuestionnaireSidebar } from './QuestionnaireSidebar';
import type {
  QuestionnaireLayoutDict,
  MatchmakingQuestionnaireDict,
  QuestionnaireFaqDict,
  AccessibilityFeaturesDict,
} from '@/types/dictionary';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';

// Props Interface
export interface QuestionnaireLayoutProps {
  children: React.ReactNode;
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit?: () => void;
  locale?: 'he' | 'en';
  onSaveProgress?: () => Promise<void>;
  dict: {
    layout: QuestionnaireLayoutDict;
    worldLabels: MatchmakingQuestionnaireDict['worldLabels'];
    faq: QuestionnaireFaqDict;
    accessibilityFeatures: AccessibilityFeaturesDict;
  };
  // Props חדשים שיועברו מ-WorldComponent
  mobileHeaderContent?: React.ReactNode;
  onMenuOpen?: () => void;
}

// Note: Specific world colors (Sky, Rose, etc.) are kept for the specific world content,
// but the layout shell uses the new global palette (Teal/Orange).

export default function QuestionnaireLayout({
  children,
  currentWorld,
  completedWorlds,
  onWorldChange,
  onExit,
  locale = 'he',
  onSaveProgress,
  dict,
  mobileHeaderContent,
  onMenuOpen,
}: QuestionnaireLayoutProps) {
  const { status } = useSession();
  const router = useRouter();
  const isLoggedIn = status === 'authenticated';

  const [isSaving, setIsSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);

  const isDesktop = useMediaQuery('(min-width: 1024px)');
  const isRTL = locale === 'he';

  const handleSave = useCallback(async () => {
    if (!onSaveProgress) return;
    setIsSaving(true);
    try {
      await onSaveProgress();
      setLastSaved(new Date());
      setSaveSuccess(true);
      setTimeout(() => setSaveSuccess(false), 2000);
    } catch (err) {
      console.error('Save failed in layout:', err);
    } finally {
      setIsSaving(false);
    }
  }, [onSaveProgress]);

  const handleMenuOpen = () => {
    setIsMobileSidebarOpen(true);
    if (onMenuOpen) {
      onMenuOpen();
    }
  };

  return (
    <div
      className={cn(
        // Updated Main Background
        'min-h-screen bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        isRTL ? 'rtl' : 'ltr'
      )}
    >
      {isDesktop ? (
        <div className="flex flex-row">
          <QuestionnaireSidebar
            currentWorld={currentWorld}
            completedWorlds={completedWorlds}
            onWorldChange={onWorldChange}
            onExit={onExit!}
            locale={locale}
            isLoggedIn={isLoggedIn}
            onSaveProgress={handleSave}
            isSaving={isSaving}
            saveSuccess={saveSuccess}
            lastSaved={lastSaved}
            dict={{
              layout: dict.layout,
              worldLabels: dict.worldLabels,
              faq: dict.faq,
              accessibilityFeatures: dict.accessibilityFeatures,
            }}
          />
          <main className="flex-1 overflow-y-auto p-4 md:p-8 lg:p-10">
            {children}
          </main>
        </div>
      ) : (
        <div className="flex flex-col">
          {/* Mobile Sidebar Sheet - Hidden by default */}
          <Sheet
            open={isMobileSidebarOpen}
            onOpenChange={setIsMobileSidebarOpen}
          >
            <SheetContent
              side={isRTL ? 'right' : 'left'}
              className="w-[320px] p-0 flex flex-col"
            >
              <QuestionnaireSidebar
                currentWorld={currentWorld}
                completedWorlds={completedWorlds}
                onWorldChange={(worldId) => {
                  onWorldChange(worldId);
                  setIsMobileSidebarOpen(false);
                }}
                onExit={() => {
                  if (onExit) onExit();
                  setIsMobileSidebarOpen(false);
                }}
                locale={locale}
                isLoggedIn={isLoggedIn}
                onSaveProgress={handleSave}
                isSaving={isSaving}
                saveSuccess={saveSuccess}
                lastSaved={lastSaved}
                dict={dict}
              />
            </SheetContent>
          </Sheet>

          <main className="flex-1">
            {!isLoggedIn && (
              <div className="p-4">
                {/* Updated Unauthenticated Prompt Colors */}
                <div className="rounded-xl bg-amber-50 p-4 border border-amber-200 text-center">
                  <h3 className="text-sm font-semibold text-amber-800">
                    {dict.layout.unauthenticatedPrompt.title}
                  </h3>
                  <p className="text-xs text-amber-700 mt-1">
                    {dict.layout.unauthenticatedPrompt.subtitle}
                  </p>
                  <div className="flex justify-center gap-2 mt-3">
                    <Button
                      size="sm"
                      // Teal buttons for action
                      className="bg-teal-600 hover:bg-teal-700 text-white"
                      onClick={() => router.push('/auth/signin')}
                    >
                      <LogIn className="w-4 h-4 ml-2" />
                      {dict.layout.unauthenticatedPrompt.loginButton}
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      className="border-teal-600 text-teal-700 hover:bg-teal-50"
                      onClick={() => router.push('/auth/register')}
                    >
                      <UserPlus className="w-4 h-4 ml-2" />
                      {dict.layout.unauthenticatedPrompt.registerButton}
                    </Button>
                  </div>
                </div>
              </div>
            )}
            <div className="p-2 sm:p-4">
              {/* Pass menu opener function to children */}
              {React.Children.map(children, (child) => {
                if (React.isValidElement(child)) {
                  return React.cloneElement(child as React.ReactElement<any>, {
                    onMobileMenuOpen: handleMenuOpen,
                  });
                }
                return child;
              })}
            </div>
          </main>
        </div>
      )}
    </div>
  );
}
--- End of Content for QuestionnaireLayout.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\QuestionnaireSidebar.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/QuestionnaireSidebar.tsx
'use client';

import React from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  Heart,
  User,
  Users,
  Save,
  CheckCircle,
  Loader2,
  UserCheck,
  Home,
  LogIn,
  UserPlus,
  Scroll,
  ChevronLeft,
  ChevronRight,
  Edit,
  BookUser,
  Info,
  Sparkles,
  Target,
  Compass,
  Award,
  Check,
} from 'lucide-react';
import type { WorldId } from '../types/types';
import { cn } from '@/lib/utils';
import { motion } from 'framer-motion';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import FAQ from '../components/FAQ';
import type {
  QuestionnaireLayoutDict,
  MatchmakingQuestionnaireDict,
  QuestionnaireFaqDict,
  AccessibilityFeaturesDict,
} from '@/types/dictionary';

// Interface for props
interface QuestionnaireSidebarProps {
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit: () => void;
  locale: 'he' | 'en';
  isLoggedIn: boolean;
  onSaveProgress: () => Promise<void>;
  isSaving: boolean;
  saveSuccess: boolean;
  lastSaved: Date | null;
  dict: {
    layout: QuestionnaireLayoutDict;
    worldLabels: MatchmakingQuestionnaireDict['worldLabels'];
    faq: QuestionnaireFaqDict;
    accessibilityFeatures: AccessibilityFeaturesDict;
  };
}

const worldConfig = {
  PERSONALITY: { icon: User, themeColor: 'sky', order: 1 },
  VALUES: { icon: Heart, themeColor: 'rose', order: 2 },
  RELATIONSHIP: { icon: Users, themeColor: 'purple', order: 3 },
  PARTNER: { icon: UserCheck, themeColor: 'teal', order: 4 },
  RELIGION: { icon: Scroll, themeColor: 'amber', order: 5 },
} as const;

const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

const colorMap = {
  sky: {
    gradient: 'from-sky-400 to-blue-500',
    bg: 'bg-sky-50',
    text: 'text-sky-600',
    border: 'border-sky-300',
    ring: 'ring-sky-400',
  },
  rose: {
    gradient: 'from-rose-400 to-pink-500',
    bg: 'bg-rose-50',
    text: 'text-rose-600',
    border: 'border-rose-300',
    ring: 'ring-rose-400',
  },
  purple: {
    gradient: 'from-purple-400 to-indigo-500',
    bg: 'bg-purple-50',
    text: 'text-purple-600',
    border: 'border-purple-300',
    ring: 'ring-purple-400',
  },
  teal: {
    gradient: 'from-teal-400 to-emerald-500',
    bg: 'bg-teal-50',
    text: 'text-teal-600',
    border: 'border-teal-300',
    ring: 'ring-teal-400',
  },
  amber: {
    gradient: 'from-amber-400 to-orange-500',
    bg: 'bg-amber-50',
    text: 'text-amber-600',
    border: 'border-amber-300',
    ring: 'ring-amber-400',
  },
};

const completedStyles = {
  sky: {
    border: 'border-sky-300',
    bgGradient: 'bg-gradient-to-r from-sky-50 to-sky-100',
    hoverGradient: 'hover:from-sky-100 hover:to-sky-150',
  },
  rose: {
    border: 'border-rose-300',
    bgGradient: 'bg-gradient-to-r from-rose-50 to-rose-100',
    hoverGradient: 'hover:from-rose-100 hover:to-rose-150',
  },
  purple: {
    border: 'border-purple-300',
    bgGradient: 'bg-gradient-to-r from-purple-50 to-purple-100',
    hoverGradient: 'hover:from-purple-100 hover:to-purple-150',
  },
  teal: {
    border: 'border-teal-300',
    bgGradient: 'bg-gradient-to-r from-teal-50 to-teal-100',
    hoverGradient: 'hover:from-teal-100 hover:to-teal-150',
  },
  amber: {
    border: 'border-amber-300',
    bgGradient: 'bg-gradient-to-r from-amber-50 to-amber-100',
    hoverGradient: 'hover:from-amber-100 hover:to-amber-150',
  },
} as const;

type ThemeColor = keyof typeof colorMap;

const NavButton = React.memo(
  ({
    worldId,
    currentWorld,
    completedWorlds,
    onWorldChange,
    dict,
    isMobile = false,
    currentThemeColor,
    locale,
  }: {
    worldId: WorldId;
    currentWorld: WorldId;
    completedWorlds: WorldId[];
    onWorldChange: (worldId: WorldId) => void;
    dict: QuestionnaireSidebarProps['dict'];
    isMobile?: boolean;
    currentThemeColor: ThemeColor;
    locale: 'he' | 'en';
  }) => {
    const { icon: Icon, themeColor, order } = worldConfig[worldId];
    const label = dict.worldLabels[worldId];
    const isActive = currentWorld === worldId;
    const isCompleted = completedWorlds.includes(worldId);
    const colors = colorMap[themeColor];
    const currentColors = colorMap[currentThemeColor];
    const isRTL = locale === 'he';

    let status: 'active' | 'completed' | 'available' = 'available';
    if (isActive) status = 'active';
    else if (isCompleted) status = 'completed';

    const statusConfig = {
      active: {
        containerClass: cn(
          'relative overflow-hidden border-2 shadow-lg',
          `bg-gradient-to-r ${colors.gradient} ${colors.border}`,
          'ring-2 ring-offset-1',
          colors.ring
        ),
        textClass: 'text-white font-bold',
        iconClass: 'text-white',
        badge: (
          <motion.div
            animate={{ x: [0, 3, 0] }}
            transition={{ duration: 1.5, repeat: Infinity }}
            className="flex-shrink-0"
          >
            {isRTL ? (
              <ChevronLeft className="h-5 w-5 text-white" />
            ) : (
              <ChevronRight className="h-5 w-5 text-white" />
            )}
          </motion.div>
        ),
        shimmer: true,
      },
      completed: {
        containerClass: cn(
          'border-2 shadow-sm hover:shadow-md',
          completedStyles[currentThemeColor].border,
          completedStyles[currentThemeColor].bgGradient,
          completedStyles[currentThemeColor].hoverGradient
        ),
        textClass: cn('font-semibold', currentColors.text),
        iconClass: currentColors.text,
        badge: (
          <div className="flex items-center gap-1">
            <Check className={cn('h-4 w-4', currentColors.text)} />
            <Edit
              className={cn('h-3.5 w-3.5 opacity-60', currentColors.text)}
            />
          </div>
        ),
        shimmer: false,
      },
      available: {
        containerClass: cn(
          'bg-white border-2 border-gray-200',
          'hover:bg-gray-50 hover:border-gray-300',
          'shadow-sm hover:shadow'
        ),
        textClass: 'text-gray-700 font-medium',
        iconClass: colors.text,
        badge: null,
        shimmer: false,
      },
    };
    const config = statusConfig[status];

    return (
      <motion.div
        initial={{ opacity: 0, x: isMobile ? 0 : -20 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay: order * 0.05 }}
        whileHover={{ scale: 1.02, x: isRTL ? -3 : 3 }}
        whileTap={{ scale: 0.98 }}
      >
        <Button
          variant="ghost"
          size={isMobile ? 'sm' : 'default'}
          className={cn(
            'flex items-center justify-between w-full mb-2.5 transition-all duration-300 rounded-xl relative',
            config.containerClass,
            isMobile ? 'py-3 px-3' : 'p-4 h-auto'
          )}
          onClick={() => onWorldChange(worldId)}
        >
          {config.shimmer && (
            <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full animate-shimmer"></span>
          )}
          <div className="relative z-10 flex items-center gap-3 flex-1">
            <div
              className={cn(
                'p-2 rounded-lg flex-shrink-0 transition-all duration-300',
                status === 'active'
                  ? 'bg-white/20 backdrop-blur-sm'
                  : status === 'completed'
                    ? currentColors.bg
                    : colors.bg
              )}
            >
              <Icon className={cn('h-5 w-5', config.iconClass)} />
            </div>
            <div className="flex flex-col items-start flex-1 min-w-0">
              <span className={cn('truncate text-sm', config.textClass)}>
                {label}
              </span>
              {!isMobile && (
                <span
                  className={cn(
                    'text-xs font-normal',
                    status === 'active' ? 'text-white/80' : 'text-gray-500'
                  )}
                >
                  {status === 'active' && dict.layout.navButtonStatus.active}
                  {status === 'completed' &&
                    dict.layout.navButtonStatus.completed}
                  {status === 'available' &&
                    dict.layout.navButtonStatus.available.replace(
                      '{{order}}',
                      String(order)
                    )}
                </span>
              )}
            </div>
            <div className="flex-shrink-0">{config.badge}</div>
          </div>
        </Button>
      </motion.div>
    );
  }
);
NavButton.displayName = 'NavButton';

const _QuestionnaireSidebar: React.FC<QuestionnaireSidebarProps> = ({
  currentWorld,
  completedWorlds,
  onWorldChange,
  onExit,
  locale,
  isLoggedIn,
  onSaveProgress,
  isSaving,
  saveSuccess,
  lastSaved,
  dict,
}) => {
  const isRTL = locale === 'he';
  const profileLinkWithTab = `/${locale}/profile?tab=questionnaire`;
  const currentThemeColor = worldConfig[currentWorld].themeColor;
  const currentColors = colorMap[currentThemeColor];

  const completionPercent = Math.round(
    (completedWorlds.length / WORLD_ORDER.length) * 100
  );

  return (
    <>
      <div className="relative p-6 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white">
        <div className="absolute inset-0 bg-black/5" />
        <div className="relative z-10">
          <div className="flex items-center gap-3 mb-3">
            <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
              <Compass className="h-6 w-6" />
            </div>
            <div>
              <h3 className="font-extrabold text-2xl">
                {dict.layout.sidebarHeader.title}
              </h3>
              <p className="text-sm text-white/90">
                {dict.layout.sidebarHeader.subtitle}
              </p>
            </div>
          </div>
        </div>
      </div>
      <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        className="mx-4 my-4 p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200/60 shadow-sm"
      >
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <div className={cn('p-1.5 rounded-lg', currentColors.bg)}>
              <Target className={cn('h-4 w-4', currentColors.text)} />
            </div>
            <span className="text-sm font-bold text-gray-800">
              {dict.layout.sidebarProgress.title}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs font-medium text-gray-600">
              {dict.layout.sidebarProgress.worldsLabel
                .replace('{{completedCount}}', String(completedWorlds.length))
                .replace('{{totalCount}}', String(WORLD_ORDER.length))}
            </span>
            <span className={cn('text-base font-bold', currentColors.text)}>
              {completionPercent}%
            </span>
          </div>
        </div>
        <div className="relative h-2 bg-gray-200 rounded-full overflow-hidden">
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: `${completionPercent}%` }}
            transition={{ duration: 1, ease: 'easeOut' }}
            className={cn(
              'absolute inset-y-0 left-0 bg-gradient-to-r rounded-full',
              currentColors.gradient
            )}
          />
        </div>
        {completionPercent === 100 && (
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            className="flex items-center justify-center gap-2 mt-2"
          >
            <Award className="h-4 w-4 text-amber-500" />
            <p className="text-xs font-bold text-amber-600">
              {dict.layout.sidebarProgress.completionMessage}
            </p>
          </motion.div>
        )}
      </motion.div>
      <div className="flex-1 px-4 py-3 overflow-y-auto">
        <div className="space-y-1">
          {WORLD_ORDER.map((worldId) => (
            <NavButton
              key={worldId}
              worldId={worldId}
              currentWorld={currentWorld}
              completedWorlds={completedWorlds}
              onWorldChange={onWorldChange}
              dict={dict}
              currentThemeColor={currentThemeColor}
              locale={locale}
            />
          ))}
        </div>
      </div>
      {!isLoggedIn && (
        <div className="px-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.4 }}
            className="mx-auto my-3 p-5 bg-gradient-to-br from-cyan-50 via-blue-50 to-indigo-50 border-2 border-cyan-300/60 rounded-xl shadow-md"
          >
            <div className="text-center space-y-3">
              <div className="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full shadow-lg mb-2">
                <Sparkles className="w-6 h-6 text-white" />
              </div>
              <p className="text-base text-cyan-900 font-bold">
                {dict.layout.unauthenticatedPrompt.title}
              </p>
              <p className="text-sm text-cyan-700 leading-relaxed">
                {dict.layout.unauthenticatedPrompt.subtitle}
              </p>
              <div className="flex gap-2 justify-center pt-2">
                <Link href="/auth/signin">
                  <Button
                    variant="outline"
                    size="sm"
                    className="bg-white/90 border-2 border-cyan-300 text-cyan-700 hover:bg-cyan-50 hover:border-cyan-400 font-semibold shadow-sm"
                  >
                    <LogIn className="w-4 h-4 ml-1" />
                    {dict.layout.unauthenticatedPrompt.loginButton}
                  </Button>
                </Link>
                <Link href="/auth/register">
                  <Button
                    size="sm"
                    className="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white font-bold shadow-md"
                  >
                    <UserPlus className="w-4 h-4 ml-1" />
                    {dict.layout.unauthenticatedPrompt.registerButton}
                  </Button>
                </Link>
              </div>
            </div>
          </motion.div>
        </div>
      )}
      <div className="p-4 border-t-2 border-gray-200 mt-auto space-y-3 bg-gray-50/50">
        {lastSaved && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="flex items-center justify-center gap-2 p-2 bg-green-100/80 rounded-lg border border-green-300/60"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <span className="text-xs font-semibold text-green-700">
              {dict.layout.lastSavedSuccess.replace(
                '{{time}}',
                lastSaved.toLocaleTimeString(
                  locale === 'he' ? 'he-IL' : 'en-US'
                )
              )}
            </span>
          </motion.div>
        )}
        <Button
          variant="outline"
          className={cn(
            'w-full font-bold shadow-sm border-2 transition-all duration-300',
            saveSuccess
              ? 'bg-green-100 border-green-300 text-green-700'
              : 'bg-white hover:bg-gray-50 border-gray-300'
          )}
          onClick={onSaveProgress}
          disabled={isSaving}
        >
          {isSaving ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              {dict.layout.saveButton.saving}
            </>
          ) : saveSuccess ? (
            <>
              <CheckCircle className="w-4 h-4 mr-2" />
              {dict.layout.saveButton.saved}
            </>
          ) : (
            <>
              <Save className="w-4 h-4 mr-2" />
              {dict.layout.saveButton.default}
            </>
          )}
        </Button>
        <Link href={profileLinkWithTab}>
          <Button
            variant="outline"
            className="w-full font-semibold border-2 border-teal-300 text-teal-700 hover:bg-teal-50 hover:border-teal-400"
          >
            <BookUser className="w-4 h-4 mr-2" />
            {dict.layout.actionButtons.review}
          </Button>
        </Link>
        <Button
          variant="outline"
          className="w-full font-semibold border-2 border-gray-300 hover:bg-gray-50"
          onClick={onExit}
        >
          <Home className="w-4 h-4 mr-2" />
          {dict.layout.actionButtons.exitToMap}
        </Button>
        <Sheet>
          <SheetTrigger asChild>
            <Button
              variant="outline"
              size="default"
              className="w-full justify-start gap-2 bg-white hover:bg-gray-50 border-2 border-gray-200 font-semibold"
            >
              <div className="p-1 bg-purple-100 rounded">
                <Info className="h-3.5 w-3.5 text-purple-600" />
              </div>
              {dict.layout.actionButtons.faq}
            </Button>
          </SheetTrigger>
          <SheetContent
            side={isRTL ? 'left' : 'right'}
            className="w-full sm:max-w-lg"
          >
            <SheetHeader>
              <SheetTitle className="text-xl font-bold">
                {dict.layout.faqSheet.title}
              </SheetTitle>
            </SheetHeader>
            <div className="mt-6">
              <FAQ dict={dict.faq} />
            </div>
          </SheetContent>
        </Sheet>
      </div>
    </>
  );
};

export const QuestionnaireSidebar: React.FC<QuestionnaireSidebarProps> = (
  props
) => {
  return (
    <aside className="w-full lg:w-96 bg-gradient-to-b from-white to-gray-100/60 border-e-2 border-gray-200/80 flex flex-col h-screen sticky top-0">
      <_QuestionnaireSidebar {...props} />
    </aside>
  );
};
--- End of Content for QuestionnaireSidebar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\layout\WorldsMap.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/layout/WorldsMap.tsx

'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import Link from 'next/link';
import { motion, AnimatePresence, useInView } from 'framer-motion';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  Scroll,
  Heart,
  Users,
  User,
  CheckCircle2,
  Lock,
  ArrowRight,
  Star,
  UserCheck,
  Sparkles,
  Edit3,
  Award,
  BookUser,
  ChevronDown,
  Compass,
  Map,
  Check,
  Clock,
  ArrowLeft,
  Trophy,
  Target,
  Zap,
  TrendingUp,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useSession } from 'next-auth/react';
import type { WorldsMapDict, WorldsMapWorldContent } from '@/types/dictionary';
import type { QuestionnaireAnswer, WorldId } from '../types/types';

// Visual configuration (icons, colors)
const worldsConfig = {
  PERSONALITY: { icon: User, order: 1, themeColor: 'sky' },
  VALUES: { icon: Heart, order: 2, themeColor: 'rose' },
  RELATIONSHIP: {
    icon: Users,
    order: 3,
    themeColor: 'purple',
  },
  PARTNER: {
    icon: UserCheck,
    order: 4,
    themeColor: 'teal',
  },
  RELIGION: { icon: Scroll, order: 5, themeColor: 'amber' },
} as const;

// Ensure this matches your WorldId type definition
const WORLD_ORDER: WorldId[] = [
  'PERSONALITY',
  'VALUES',
  'RELATIONSHIP',
  'PARTNER',
  'RELIGION',
];

type WorldStatus =
  | 'completed'
  | 'recommended'
  | 'active'
  | 'available'
  | 'locked';

// Component Props Interfaces
interface WorldsMapProps {
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  answers: QuestionnaireAnswer[];
  worldStats: Record<WorldId, { questionCount: number }>;
  className?: string;
  dict: WorldsMapDict;
  locale: 'he' | 'en';
}

interface WorldCardProps {
  worldId: WorldId;
  status: WorldStatus;
  onSelect: () => void;
  dict: WorldsMapDict['worldCard'];
  fullContent: WorldsMapWorldContent; // <--- התיקון: שימוש בטיפוס הישיר
  stats: { questionCount: number; estimatedTime: number };
  progress: { completed: number; total: number };
  locale: 'he' | 'en';
  worldNumber: number;
}


interface ProgressHeaderProps {
  userName?: string | null;
  completionPercent: number;
  completedCount: number;
  totalCount: number;
  nextRecommendedWorld?: WorldId;
  onGoToRecommended: () => void;
  dict: WorldsMapDict['progressHeader'];
  worldLabels: WorldsMapDict['worldLabels'];
  totalAnswered: number;
  totalQuestions: number;
}

// Enhanced Background Component
const EnhancedBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none">
    <div className="absolute inset-0 opacity-30">
      <div className="absolute top-10 left-10 w-64 h-64 bg-teal-300/20 rounded-full blur-3xl animate-float-slow" />
      <div
        className="absolute top-1/3 right-20 w-56 h-56 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      />
      <div
        className="absolute bottom-20 left-1/3 w-72 h-72 bg-rose-300/15 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      />
      <div
        className="absolute bottom-1/4 right-1/4 w-48 h-48 bg-amber-200/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '6s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:32px_32px]" />
    <svg
      className="absolute inset-0 w-full h-full opacity-5"
      viewBox="0 0 1000 1000"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#0d9488" stopOpacity="0.2" />{' '}
          {/* Teal */}
          <stop offset="50%" stopColor="#f97316" stopOpacity="0.15" />{' '}
          {/* Orange */}
          <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.1" />{' '}
          {/* Rose */}
        </linearGradient>
      </defs>
      <path
        d="M0,250 Q250,150 500,250 T1000,250 L1000,0 L0,0 Z"
        fill="url(#bgGrad)"
        className="animate-pulse-slow"
      />
      <path
        d="M0,750 Q250,850 500,750 T1000,750 L1000,1000 L0,1000 Z"
        fill="url(#bgGrad)"
        className="animate-pulse-slow"
        style={{ animationDelay: '3s' }}
      />
    </svg>
  </div>
);

// Enhanced Progress Header
const ProgressHeader: React.FC<ProgressHeaderProps> = ({
  userName,
  completionPercent,
  completedCount,
  totalCount,
  nextRecommendedWorld,
  onGoToRecommended,
  dict,
  worldLabels,
  totalAnswered,
  totalQuestions,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  return (
    <motion.div
      ref={ref}
      className="relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border-2 border-white/60 overflow-hidden"
      initial={{ opacity: 0, y: -30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: -30 }}
      transition={{ duration: 0.6, ease: 'easeOut' }}
    >
      {/* Decorative elements */}
      <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-teal-200/30 to-transparent rounded-bl-full blur-2xl" />
      <div className="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-tr-full blur-xl" />

      <div className="relative z-10 p-6 sm:p-8 space-y-6">
        {/* Header Section */}
        <div className="flex items-start justify-between gap-4">
          <div className="flex-1">
            <div className="inline-flex items-center gap-2 bg-gradient-to-r from-teal-100 to-orange-100 rounded-full px-4 py-2 mb-4">
              <Map className="w-4 h-4 text-teal-600" />
              <span className="text-sm font-bold text-teal-700">
                {dict.mapTitle}
              </span>
            </div>
            <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2 leading-tight">
              {userName ? (
                <>
                  {dict.greeting.replace('{{name}}', userName)}
                  <br />
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                    {dict.journeyQuestion}
                  </span>
                </>
              ) : (
                <>
                  {dict.greetingNoName}
                  <br />
                  <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600">
                    {dict.journeyTitle}
                  </span>
                </>
              )}
            </h1>
            <p className="text-base text-gray-600">
              {dict.progressText
                .replace('{{completedCount}}', completedCount.toString())
                .replace('{{totalCount}}', totalCount.toString())
                .replace('{{totalAnswered}}', totalAnswered.toString())
                .replace('{{totalQuestions}}', totalQuestions.toString())}
            </p>
          </div>

          {/* Completion Badge */}
          {completionPercent > 0 && (
            <motion.div
              initial={{ scale: 0, rotate: -180 }}
              animate={{ scale: 1, rotate: 0 }}
              transition={{ type: 'spring', stiffness: 200, damping: 15 }}
              className="flex-shrink-0"
            >
              <div className="relative">
                <div className="w-20 h-20 rounded-full bg-gradient-to-br from-teal-400 to-orange-500 flex items-center justify-center shadow-lg">
                  <span className="text-2xl font-extrabold text-white">
                    {completionPercent}%
                  </span>
                </div>
                {completionPercent === 100 && (
                  <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ delay: 0.3 }}
                    className="absolute -top-1 -right-1"
                  >
                    <Trophy className="w-7 h-7 text-amber-500 fill-amber-400" />
                  </motion.div>
                )}
              </div>
            </motion.div>
          )}
        </div>

        {/* Progress Bar */}
        <div className="space-y-3">
          <div className="flex items-center gap-4">
            <Progress
              value={completionPercent}
              className="h-3 rounded-full flex-1 bg-gray-200/80"
              indicatorClassName="bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 transition-all duration-500 rounded-full"
            />
          </div>

          {/* Milestones */}
          <div className="flex justify-between text-xs text-gray-500 px-1">
            <span
              className={
                completionPercent >= 20 ? 'text-teal-600 font-bold' : ''
              }
            >
              {dict.milestones.start}
            </span>
            <span
              className={
                completionPercent >= 40 ? 'text-teal-600 font-bold' : ''
              }
            >
              {dict.milestones.onTrack}
            </span>
            <span
              className={
                completionPercent >= 60 ? 'text-orange-600 font-bold' : ''
              }
            >
              {dict.milestones.inProgress}
            </span>
            <span
              className={
                completionPercent >= 80 ? 'text-orange-600 font-bold' : ''
              }
            >
              {dict.milestones.almostThere}
            </span>
            <span
              className={
                completionPercent === 100 ? 'text-amber-600 font-bold' : ''
              }
            >
              {dict.milestones.completed}
            </span>
          </div>
        </div>

        {/* Next Recommended Action */}
        {nextRecommendedWorld && completionPercent < 100 && (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="pt-4 border-t border-gray-200/60"
          >
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div className="flex items-start gap-3">
                <div className="p-2 bg-gradient-to-br from-teal-400 to-orange-500 rounded-lg flex-shrink-0">
                  <Compass className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="font-bold text-gray-800 mb-1">
                    {dict.nextStepTitle}
                  </h3>
                  <p className="text-sm text-gray-600">
                    {dict.nextStepPrompt.replace(
                      '{{worldName}}',
                      worldLabels[nextRecommendedWorld]
                    )}
                  </p>
                </div>
              </div>
              <Button
                size="lg"
                onClick={onGoToRecommended}
                className="w-full sm:w-auto bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white font-bold shadow-xl hover:shadow-2xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1"
              >
                <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
                <div className="relative z-10 flex items-center gap-2">
                  <Sparkles className="h-5 w-5 fill-current" />
                  <span>{dict.ctaButton}</span>
                  <ArrowLeft className="h-4 w-4 group-hover:-translate-x-1 transition-transform" />
                </div>
              </Button>
            </div>
          </motion.div>
        )}

        {/* Completion Message */}
        {completionPercent === 100 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="pt-4 border-t border-gray-200/60"
          >
            <div className="text-center p-6 bg-gradient-to-r from-teal-50 via-orange-50 to-amber-50 rounded-2xl">
              <Trophy className="w-12 h-12 mx-auto mb-3 text-amber-500 fill-amber-400" />
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                {dict.completionTitle}
              </h3>
              <p className="text-gray-600">{dict.completionSubtitle}</p>
            </div>
          </motion.div>
        )}
      </div>
    </motion.div>
  );
};

// Enhanced World Card
const WorldCard: React.FC<WorldCardProps> = ({
  worldId,
  status,
  onSelect,
  dict,
  fullContent,
  locale,
  stats,
  progress,
  worldNumber,
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const config = worldsConfig[worldId];
  const { icon: Icon, themeColor } = config;
  const isRTL = locale === 'he';
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.2 });

  const ForwardArrow = isRTL ? ArrowLeft : ArrowRight;

  const progressPercent =
    progress.total > 0
      ? Math.round((progress.completed / progress.total) * 100)
      : 0;

  const colorMap = {
    sky: {
      gradient: 'from-sky-400 to-blue-500',
      bg: 'bg-sky-100',
      text: 'text-sky-600',
      border: 'border-sky-300',
      glow: 'shadow-sky-400/30',
    },
    rose: {
      gradient: 'from-rose-400 to-pink-500',
      bg: 'bg-rose-100',
      text: 'text-rose-600',
      border: 'border-rose-300',
      glow: 'shadow-rose-400/30',
    },
    purple: {
      gradient: 'from-purple-400 to-indigo-500',
      bg: 'bg-purple-100',
      text: 'text-purple-600',
      border: 'border-purple-300',
      glow: 'shadow-purple-400/30',
    },
    teal: {
      gradient: 'from-teal-400 to-emerald-500',
      bg: 'bg-teal-100',
      text: 'text-teal-600',
      border: 'border-teal-300',
      glow: 'shadow-teal-400/30',
    },
    amber: {
      gradient: 'from-amber-400 to-orange-500',
      bg: 'bg-amber-100',
      text: 'text-amber-600',
      border: 'border-amber-300',
      glow: 'shadow-amber-400/30',
    },
  };

  const colors = colorMap[themeColor as keyof typeof colorMap];

  const statusInfo = {
    completed: {
      Icon: CheckCircle2,
      text: dict.statuses.completed,
      badge: 'bg-green-100 text-green-700 border-green-300',
      action: dict.actions.edit,
      ActionIcon: Edit3,
      cardStyle: 'border-green-300 bg-white/90',
    },
    recommended: {
      Icon: Star,
      text: dict.statuses.recommended,
      badge:
        'bg-gradient-to-r from-teal-100 to-orange-100 text-teal-700 border-teal-300 font-bold animate-pulse-glow',
      action: dict.actions.startRecommended,
      ActionIcon: Zap,
      cardStyle:
        'border-teal-400 bg-gradient-to-br from-white via-teal-50/30 to-orange-50/30 shadow-2xl scale-[1.02] ring-2 ring-teal-300/50',
    },
    active: {
      Icon: Target,
      text: dict.statuses.active,
      badge: `${colors.bg} ${colors.text} ${colors.border}`,
      action: dict.actions.continue,
      ActionIcon: ForwardArrow,
      cardStyle: `${colors.border} bg-white/90`,
    },
    available: {
      Icon: Compass,
      text: dict.statuses.available,
      badge: 'bg-gray-100 text-gray-700 border-gray-300',
      action: dict.actions.start,
      ActionIcon: ForwardArrow,
      cardStyle: 'border-gray-300 bg-white/80',
    },
    locked: {
      Icon: Lock,
      text: dict.statuses.locked,
      badge: 'bg-gray-200 text-gray-500 border-gray-300',
      action: dict.actions.locked,
      ActionIcon: Lock,
      cardStyle: 'border-gray-300 bg-gray-50/80 opacity-60',
    },
  }[status];

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.5, delay: worldNumber * 0.1 }}
      whileHover={
        status !== 'locked'
          ? { y: -8, scale: 1.02, transition: { duration: 0.3 } }
          : undefined
      }
    >
      <Card
        className={cn(
          'relative overflow-hidden transition-all duration-300 ease-out h-full backdrop-blur-sm border-2',
          statusInfo.cardStyle,
          status === 'locked' && 'cursor-not-allowed',
          status === 'recommended' && 'animate-float-gentle'
        )}
      >
        {/* Decorative background elements */}
        <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-white/40 to-transparent rounded-bl-full blur-xl" />
        <div className="absolute bottom-0 left-0 w-20 h-20 bg-gradient-to-tr from-white/30 to-transparent rounded-tr-full blur-lg" />

        {/* Recommended Badge Ribbon */}
        {status === 'recommended' && (
          <div className="absolute top-4 -right-10 rotate-45 bg-gradient-to-r from-teal-500 to-orange-500 text-white text-xs font-bold px-12 py-1 shadow-lg z-20">
            {dict.recommendedRibbon}
          </div>
        )}

        <div className="relative z-10 p-6 space-y-4">
          {/* Header Section */}
          <div className="flex items-start justify-between gap-4">
            {/* Icon */}
            <motion.div
              className={cn(
                'relative p-4 rounded-2xl flex-shrink-0 bg-gradient-to-br shadow-lg',
                colors.gradient
              )}
              whileHover={{ rotate: 12, scale: 1.1 }}
              transition={{ type: 'spring', stiffness: 300 }}
            >
              <div className="absolute inset-0 rounded-2xl bg-white/20 backdrop-blur-sm" />
              <Icon className="relative z-10 w-8 h-8 text-white" />
            </motion.div>

            {/* Status Badge */}
            <Badge
              variant="outline"
              className={cn(
                'font-semibold text-xs px-3 py-1 border-2',
                statusInfo.badge
              )}
            >
              <statusInfo.Icon className="w-3 h-3 me-1.5 inline" />
              {statusInfo.text}
            </Badge>
          </div>

          {/* World Number */}
          <div className="flex items-center gap-2">
            <div className="inline-flex items-center gap-1.5 bg-gray-100 rounded-full px-3 py-1">
              <span className="text-xs font-bold text-gray-600">
                {dict.worldNumberLabel.replace(
                  '{{number}}',
                  worldNumber.toString()
                )}
              </span>
            </div>
            {status === 'completed' && (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ type: 'spring', stiffness: 200 }}
              >
                <Check className="w-4 h-4 text-green-500" />
              </motion.div>
            )}
          </div>

          {/* Title */}
          <div>
            <h3 className="text-2xl font-bold text-gray-800 mb-2 leading-tight">
              {fullContent.title}
            </h3>
            <p className="text-sm text-gray-600 leading-relaxed">
              {fullContent.description}
            </p>
          </div>

          {/* Progress Bar (for active/in-progress worlds) */}
          {(status === 'active' ||
            (status === 'completed' && progressPercent < 100)) && (
            <div className="space-y-2">
              <div className="flex items-center justify-between text-xs">
                <span className="text-gray-600 font-medium">
                  {dict.progressLabel
                    .replace('{{completed}}', progress.completed.toString())
                    .replace('{{total}}', progress.total.toString())}
                </span>
                <span className={cn('font-bold', colors.text)}>
                  {progressPercent}%
                </span>
              </div>
              <Progress
                value={progressPercent}
                className="h-2 rounded-full bg-gray-200/80"
                indicatorClassName={cn(
                  'bg-gradient-to-r transition-all duration-500',
                  colors.gradient
                )}
              />
            </div>
          )}

          {/* Stats */}
          <div className="flex items-center gap-4 pt-2 border-t border-gray-200/60">
            <div className="flex items-center gap-2 text-sm text-gray-600">
              <div className={cn('p-1.5 rounded-lg', colors.bg)}>
                <BookUser className={cn('w-4 h-4', colors.text)} />
              </div>
              <span className="font-medium">
                {stats.questionCount} {dict.questionsLabel}
              </span>
            </div>
            <div className="flex items-center gap-2 text-sm text-gray-600">
              <div className={cn('p-1.5 rounded-lg', colors.bg)}>
                <Clock className={cn('w-4 h-4', colors.text)} />
              </div>
              <span className="font-medium">
                ~{stats.estimatedTime} {dict.minutesLabel}
              </span>
            </div>
          </div>

          {/* Expandable Details */}
          {fullContent.benefits && fullContent.benefits.length > 0 && (
            <div className="pt-2">
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors w-full"
                disabled={status === 'locked'}
              >
                <span>{dict.expandButton}</span>
                <motion.div
                  animate={{ rotate: isExpanded ? 180 : 0 }}
                  transition={{ duration: 0.3 }}
                >
                  <ChevronDown className="w-4 h-4" />
                </motion.div>
              </button>

              <AnimatePresence>
                {isExpanded && (
                  <motion.div
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: 'auto', opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.3 }}
                    className="overflow-hidden"
                  >
                    <ul className="mt-3 space-y-2">
                      {fullContent.benefits.map((benefit, idx) => (
                        <motion.li
                          key={idx}
                          initial={{ opacity: 0, x: -10 }}
                          animate={{ opacity: 1, x: 0 }}
                          transition={{ delay: idx * 0.1 }}
                          className="flex items-start gap-2 text-sm text-gray-600"
                        >
                          <Check
                            className={cn(
                              'w-4 h-4 mt-0.5 flex-shrink-0',
                              colors.text
                            )}
                          />
                          <span>{benefit}</span>
                        </motion.li>
                      ))}
                    </ul>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          )}

          {/* Action Button */}
          <Button
            className={cn(
              'w-full font-bold shadow-md hover:shadow-xl transition-all duration-300 group relative overflow-hidden',
              status === 'completed' &&
                'bg-white border-2 border-green-300 text-green-700 hover:bg-green-50',
              status === 'recommended' &&
                // Updated Recommended CTA
                'bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white',
              (status === 'active' || status === 'available') &&
                `bg-gradient-to-r ${colors.gradient} hover:opacity-90 text-white`,
              status === 'locked' &&
                'bg-gray-200 text-gray-500 cursor-not-allowed hover:bg-gray-200'
            )}
            onClick={onSelect}
            disabled={status === 'locked'}
          >
            {(status === 'recommended' ||
              status === 'active' ||
              status === 'available') && (
              <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/25 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
            )}
            <span className="relative z-10 flex items-center justify-center gap-2">
              <statusInfo.ActionIcon className="w-4 h-4" />
              {statusInfo.action}
            </span>
          </Button>
        </div>
      </Card>
    </motion.div>
  );
};

// Review Card Component
const ReviewCard: React.FC<{
  dict: WorldsMapDict['reviewCard'];
  locale: 'he' | 'en';
}> = ({ dict, locale }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });
  const isRTL = locale === 'he';
  const ReviewButtonArrow = isRTL ? ArrowLeft : ArrowRight;

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 20 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 20 }}
      transition={{ duration: 0.5, delay: 0.2 }}
    >
      {/* Updated Review Card Colors */}
      <Card className="relative overflow-hidden bg-gradient-to-br from-white via-teal-50/40 to-white backdrop-blur-md shadow-xl border-2 border-teal-200/60">
        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-teal-200/30 to-transparent rounded-bl-full blur-2xl" />
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-tr-full blur-xl" />

        <CardContent className="relative z-10 p-6 flex flex-col sm:flex-row items-center justify-between gap-6">
          <div className="flex items-start gap-4">
            <div className="p-4 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-2xl shadow-lg flex-shrink-0">
              <BookUser className="w-7 h-7 text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-gray-800 mb-2">
                {dict.title}
              </h3>
              <p className="text-sm text-gray-600 leading-relaxed">
                {dict.description}
              </p>
            </div>
          </div>
          <Link href={`/${locale}/profile?tab=questionnaire`}>
            <Button
              size="lg"
              variant="outline"
              className="w-full sm:w-auto bg-white/90 border-2 border-teal-300 text-teal-700 hover:bg-teal-50 hover:border-teal-400 font-bold shadow-md hover:shadow-lg transition-all duration-300 group"
            >
              <ReviewButtonArrow className="w-5 h-5 me-2 group-hover:-translate-x-1 transition-transform" />
              {dict.button}
            </Button>
          </Link>
        </CardContent>
      </Card>
    </motion.div>
  );
};

// Completion Banner Component
const CompletionBanner: React.FC<{
  userName?: string | null;
  dict: WorldsMapDict['completionBanner'];
}> = ({ userName, dict }) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, scale: 0.9 }}
      animate={isInView ? { opacity: 1, scale: 1 } : { opacity: 0, scale: 0.9 }}
      transition={{ duration: 0.6, type: 'spring' }}
    >
      <Card className="relative overflow-hidden bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white text-center shadow-2xl border-0">
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-10 left-10 w-40 h-40 bg-white rounded-full blur-3xl animate-float-slow" />
          <div
            className="absolute bottom-10 right-10 w-32 h-32 bg-white rounded-full blur-2xl animate-float-slow"
            style={{ animationDelay: '2s' }}
          />
        </div>

        <CardContent className="relative z-10 p-12">
          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={
              isInView ? { scale: 1, rotate: 0 } : { scale: 0, rotate: -180 }
            }
            transition={{ type: 'spring', stiffness: 150, delay: 0.2 }}
          >
            <Trophy className="w-20 h-20 mx-auto mb-6 text-amber-300 fill-amber-200" />
          </motion.div>

          <h2 className="text-4xl font-extrabold mb-4">
            {userName
              ? dict.title.replace('{{name}}', userName)
              : dict.titleNoName}
          </h2>
          <p className="text-xl font-semibold mb-2 opacity-95">
            {dict.subtitle}
          </p>
          <p className="text-base opacity-90 max-w-2xl mx-auto leading-relaxed">
            {dict.description}
          </p>

          <motion.div
            className="mt-8 flex items-center justify-center gap-6"
            initial={{ opacity: 0, y: 20 }}
            animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 20 }}
            transition={{ delay: 0.4 }}
          >
            <div className="flex items-center gap-2">
              <div className="p-2 bg-white/20 rounded-lg">
                <Check className="w-5 h-5" />
              </div>
              <span className="font-semibold">{dict.statWorlds}</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="p-2 bg-white/20 rounded-lg">
                <TrendingUp className="w-5 h-5" />
              </div>
              <span className="font-semibold">{dict.statReport}</span>
            </div>
          </motion.div>
        </CardContent>
      </Card>
    </motion.div>
  );
};

// Main Component
export default function WorldsMap({
  currentWorld,
  completedWorlds,
  onWorldChange,
  className = '',
  dict,
  locale,
  answers,
  worldStats,
}: WorldsMapProps) {
  const { data: session } = useSession();
  const isRTL = locale === 'he';

  useEffect(() => {
    console.log(
      `%c[WorldsMap] Language is now: ${locale}`,
      'color: #14b8a6; font-weight: bold; font-size: 14px;'
    );
  }, [locale]);

  const worldsProgress = useMemo(() => {
    const progressMap: Record<WorldId, { completed: number; total: number }> = {
      PERSONALITY: {
        completed: 0,
        total: worldStats.PERSONALITY.questionCount,
      },
      VALUES: { completed: 0, total: worldStats.VALUES.questionCount },
      RELATIONSHIP: {
        completed: 0,
        total: worldStats.RELATIONSHIP.questionCount,
      },
      PARTNER: { completed: 0, total: worldStats.PARTNER.questionCount },
      RELIGION: { completed: 0, total: worldStats.RELIGION.questionCount },
    };

    for (const worldId of WORLD_ORDER) {
      const answeredQuestionsInWorld = new Set(
        answers.filter((a) => a.worldId === worldId).map((a) => a.questionId)
      );
      progressMap[worldId].completed = answeredQuestionsInWorld.size;
    }

    return progressMap;
  }, [answers, worldStats]);

  const totalQuestions = useMemo(
    () => WORLD_ORDER.reduce((sum, w) => sum + worldStats[w].questionCount, 0),
    [worldStats]
  );

  const totalAnswered = useMemo(
    () => WORLD_ORDER.reduce((sum, w) => sum + worldsProgress[w].completed, 0),
    [worldsProgress]
  );

  const completionPercent = Math.round(
    (completedWorlds.length / WORLD_ORDER.length) * 100
  );

  const nextRecommendedWorld = WORLD_ORDER.find(
    (world) => !completedWorlds.includes(world)
  );

  const getWorldStatus = (worldId: WorldId): WorldStatus => {
    if (completedWorlds.includes(worldId)) return 'completed';
    if (worldId === nextRecommendedWorld) return 'recommended';
    if (worldId === currentWorld) return 'active';
    return 'available';
  };

  return (
    <div
      className={cn(
        'relative min-h-screen p-4 sm:p-6 lg:p-8 bg-gradient-to-b from-slate-50 via-teal-50/30 to-slate-50 overflow-hidden',
        className
      )}
      dir={isRTL ? 'rtl' : 'ltr'}
    >
      <EnhancedBackground />

      <div className="relative max-w-7xl mx-auto space-y-8 z-10">
        {/* Progress Header */}
        <ProgressHeader
          userName={session?.user?.firstName}
          completionPercent={completionPercent}
          completedCount={completedWorlds.length}
          totalCount={WORLD_ORDER.length}
          nextRecommendedWorld={nextRecommendedWorld}
          onGoToRecommended={() =>
            nextRecommendedWorld && onWorldChange(nextRecommendedWorld)
          }
          dict={dict.progressHeader}
          worldLabels={dict.worldLabels}
          totalAnswered={totalAnswered}
          totalQuestions={totalQuestions}
        />

        {/* Review Card (shown after completing at least one world) */}
        {completedWorlds.length > 0 && completionPercent < 100 && (
          <ReviewCard dict={dict.reviewCard} locale={locale} />
        )}

        {/* Worlds Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {WORLD_ORDER.map((worldId, index) => {
            const stats = {
              questionCount: worldStats[worldId].questionCount,
              estimatedTime: Math.max(
                5,
                Math.round(worldStats[worldId].questionCount * 0.4)
              ),
            };
            return (
              <WorldCard
                key={worldId}
                worldId={worldId}
                worldNumber={index + 1}
                status={getWorldStatus(worldId)}
                onSelect={() => onWorldChange(worldId)}
                dict={dict.worldCard}
                fullContent={dict.worldsContent[worldId]}
                stats={stats}
                locale={locale}
                progress={worldsProgress[worldId]}
              />
            );
          })}
        </div>

        {/* Completion Banner */}
        {completionPercent === 100 && (
          <CompletionBanner
            userName={session?.user?.firstName}
            dict={dict.completionBanner}
          />
        )}
      </div>

      <style>{`
        @keyframes pulse-slow {
          0%, 100% { opacity: 0.8; }
          50% { opacity: 1; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-glow {
          0%, 100% { 
            box-shadow: 0 0 5px rgba(20, 184, 166, 0.3);
          }
          50% { 
            box-shadow: 0 0 20px rgba(20, 184, 166, 0.6), 0 0 30px rgba(249, 115, 22, 0.4);
          }
        }
        .animate-pulse-glow {
          animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes float-slow {
          0%, 100% { 
            transform: translateY(0) translateX(0); 
          }
          25% { 
            transform: translateY(-25px) translateX(15px); 
          }
          50% { 
            transform: translateY(-10px) translateX(25px); 
          }
          75% { 
            transform: translateY(-20px) translateX(10px); 
          }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }

        @keyframes float-gentle {
          0%, 100% { 
            transform: translateY(0); 
          }
          50% { 
            transform: translateY(-5px); 
          }
        }
        .animate-float-gentle {
          animation: float-gentle 3s ease-in-out infinite;
        }

        @keyframes shimmer {
          100% { 
            transform: translateX(100%); 
          }
        }
        .animate-shimmer {
          animation: shimmer 2.5s infinite;
        }
      `}</style>
    </div>
  );
}
--- End of Content for WorldsMap.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\pages
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\pages\QuestionnaireLandingPage.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/pages/QuestionnaireLandingPage.tsx
'use client';

import React, { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import {
  Heart,
  User,
  Users,
  Scroll,
  Clock,
  ArrowRight,
  Star,
  Shield,
  CheckCircle,
  Lock,
  ArrowLeft,
  Loader2,
  Sparkles,
  UserCheck,
  Target,
  Lightbulb,
  FileText,
  Zap,
  AlertCircle,
  MessageCircle,
  Calendar,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useSession } from 'next-auth/react';
import { useIsMobile } from '../hooks/useMediaQuery';
import { motion, useInView } from 'framer-motion';
import type { QuestionnaireLandingPageDict } from '@/types/dictionary';
import type { WorldId } from '../types/types';

// --- Props Interface ---
interface QuestionnaireLandingPageProps {
  onStartQuestionnaire: () => void;
  hasSavedProgress: boolean;
  isLoading?: boolean;
  dict: QuestionnaireLandingPageDict;
  locale: string;
}

// --- Animation Variants ---
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.1, delayChildren: 0.2 },
  },
};

const fadeInUp = {
  hidden: { opacity: 0, y: 30 },
  visible: {
    opacity: 1,
    y: 0,
    transition: { duration: 0.6, ease: 'easeOut' },
  },
};

const staggeredCardVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.15, delayChildren: 0.1 },
  },
};

// --- Enhanced Background Component ---
const DynamicBackground: React.FC = () => (
  <div className="absolute inset-0 overflow-hidden pointer-events-none">
    <div className="absolute inset-0 opacity-30">
      <div className="absolute top-10 left-10 w-72 h-72 bg-teal-300/20 rounded-full blur-3xl animate-float-slow" />
      <div
        className="absolute top-1/3 right-20 w-64 h-64 bg-orange-300/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '2s' }}
      />
      <div
        className="absolute bottom-20 left-1/3 w-80 h-80 bg-rose-300/15 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '4s' }}
      />
      <div
        className="absolute bottom-1/4 right-1/4 w-56 h-56 bg-amber-200/20 rounded-full blur-3xl animate-float-slow"
        style={{ animationDelay: '6s' }}
      />
    </div>
    <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#14b8a6_1px,transparent_1px)] [background-size:30px_30px]" />
    <svg
      className="absolute inset-0 w-full h-full opacity-5"
      viewBox="0 0 1000 1000"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#0d9488" stopOpacity="0.2" />
          <stop offset="50%" stopColor="#f97316" stopOpacity="0.15" />
          <stop offset="100%" stopColor="#f43f5e" stopOpacity="0.1" />
        </linearGradient>
      </defs>
      <path
        d="M0,300 Q250,200 500,300 T1000,300 L1000,0 L0,0 Z"
        fill="url(#grad1)"
        className="animate-pulse-slow"
      />
      <path
        d="M0,700 Q250,800 500,700 T1000,700 L1000,1000 L0,1000 Z"
        fill="url(#grad1)"
        className="animate-pulse-slow"
        style={{ animationDelay: '3s' }}
      />
    </svg>
  </div>
);

// --- Problem Card Component ---
interface ProblemCardProps {
  icon: React.ReactNode;
  title: string;
  description: string;
  delay?: number;
}

const ProblemCard: React.FC<ProblemCardProps> = ({
  icon,
  title,
  description,
  delay = 0,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.3 });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, x: -30 }}
      animate={isInView ? { opacity: 1, x: 0 } : { opacity: 0, x: -30 }}
      transition={{ duration: 0.6, delay }}
      className="flex items-start gap-4 p-6 bg-rose-50/80 backdrop-blur-sm rounded-2xl border-2 border-rose-200/60 shadow-sm hover:shadow-lg transition-all duration-300 group"
    >
      <div className="flex-shrink-0 p-3 rounded-xl bg-gradient-to-br from-rose-400 to-red-500 text-white shadow-md group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-rose-500/25">
        {icon}
      </div>
      <div className="flex-1">
        <h4 className="font-bold text-lg text-gray-800 mb-2">{title}</h4>
        <p className="text-gray-600 leading-relaxed">{description}</p>
      </div>
    </motion.div>
  );
};

// --- Solution Card Component ---
interface SolutionCardProps {
  icon: React.ReactNode;
  title: string;
  description: string;
  gradient: string;
  shadowColor: string;
  bgGradient: string;
  delay?: number;
}

const SolutionCard: React.FC<SolutionCardProps> = ({
  icon,
  title,
  description,
  gradient,
  shadowColor,
  bgGradient,
  delay = 0,
}) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, amount: 0.3 });

  return (
    <motion.div
      ref={ref}
      initial={{ opacity: 0, y: 30 }}
      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 30 }}
      transition={{ duration: 0.6, delay }}
      whileHover={{ y: -8, scale: 1.02 }}
      className={`group relative overflow-hidden rounded-3xl bg-gradient-to-br ${bgGradient} p-8 ${shadowColor} shadow-xl hover:shadow-2xl border border-white/60 transition-all duration-500 h-full`}
    >
      <div className="absolute top-4 right-4 w-20 h-20 rounded-full bg-gradient-to-br from-white/30 to-transparent blur-xl" />
      <div className="absolute bottom-4 left-4 w-12 h-12 rounded-full bg-gradient-to-br from-white/40 to-transparent blur-lg" />

      <div className="relative z-10 flex flex-col h-full">
        <div className="flex items-center justify-center mb-6">
          <div
            className={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${gradient} flex items-center justify-center text-white shadow-xl transform group-hover:rotate-12 transition-transform duration-500`}
          >
            {icon}
            <div className="absolute inset-0 rounded-2xl bg-white/15 backdrop-blur-sm" />
          </div>
        </div>
        <h4 className="font-bold text-gray-800 text-xl mb-4 text-center leading-tight">
          {title}
        </h4>
        <p className="text-gray-600 text-base leading-relaxed text-center flex-1">
          {description}
        </p>
        <div className="mt-6 w-12 h-1 bg-gradient-to-r from-transparent via-white/60 to-transparent rounded-full mx-auto" />
      </div>
    </motion.div>
  );
};

// --- Main Component ---
export default function QuestionnaireLandingPage({
  onStartQuestionnaire,
  hasSavedProgress,
  isLoading = false,
  dict,
  locale,
}: QuestionnaireLandingPageProps) {
  const { status, data: session } = useSession();
  const isMobile = useIsMobile();
  const isRTL = locale === 'he';

  const [showBottomCta, setShowBottomCta] = useState(false);
  const topCtaRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!isMobile || !topCtaRef.current) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        setShowBottomCta(!entry.isIntersecting);
      },
      {
        threshold: 0,
        rootMargin: '0px',
      }
    );

    observer.observe(topCtaRef.current);

    return () => {
      observer.disconnect();
    };
  }, [isMobile]);

  const worldVisuals = [
    { id: 'PERSONALITY', icon: <User className="h-7 w-7" />, color: 'blue' },
    { id: 'VALUES', icon: <Heart className="h-7 w-7" />, color: 'rose' },
    {
      id: 'RELATIONSHIP',
      icon: <Users className="h-7 w-7" />,
      color: 'purple',
    },
    { id: 'PARTNER', icon: <UserCheck className="h-7 w-7" />, color: 'teal' },
    { id: 'RELIGION', icon: <Scroll className="h-7 w-7" />, color: 'amber' },
  ] as const;

  const getCtaText = () => {
    if (hasSavedProgress) return dict.cta.continue;
    if (session?.user?.firstName)
      return dict.cta.startAsUser.replace('{{name}}', session.user.firstName);
    return dict.cta.startDefault;
  };

  const CtaIcon = hasSavedProgress ? CheckCircle : Heart;
  const ArrowIcon = isRTL ? ArrowLeft : ArrowRight;

  return (
    <div
      className={cn(
        'relative min-h-screen overflow-hidden bg-gradient-to-b from-slate-50 via-teal-50/30 to-orange-50/20',
        isRTL ? 'dir-rtl text-right' : 'dir-ltr text-left',
        isMobile && 'pb-28'
      )}
    >
      <DynamicBackground />

      {/* SECTION 1: HERO */}
      <motion.section
        className="relative py-16 sm:py-20 px-4 text-center"
        initial="hidden"
        animate="visible"
        variants={containerVariants}
      >
        <div className="max-w-5xl mx-auto">
          <motion.div
            className="inline-flex items-center gap-3 bg-white/90 backdrop-blur-sm rounded-full px-6 py-3 shadow-lg border border-white/60 mb-8"
            variants={fadeInUp}
          >
            <Sparkles className="w-5 h-5 text-teal-500" />
            <span className="text-teal-700 font-bold text-sm">
              {dict.hero.badge}
            </span>
          </motion.div>

          <motion.h1
            className="text-4xl sm:text-5xl lg:text-6xl font-extrabold mb-6 tracking-tight leading-tight"
            variants={fadeInUp}
          >
            <span className="text-gray-800">{dict.hero.title1}</span>
            <br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 animate-gradient">
              {dict.hero.title2}
            </span>
          </motion.h1>

          <motion.p
            className="text-xl md:text-2xl text-gray-700 max-w-3xl mx-auto leading-relaxed mb-4"
            variants={fadeInUp}
          >
            {dict.hero.subtitle1}
            <br className="hidden sm:inline" />
            {dict.hero.subtitle2}{' '}
            <span className="font-bold text-teal-700">
              {dict.hero.subtitleHighlight}
            </span>{' '}
            {dict.hero.subtitle3}
          </motion.p>

          <motion.div
            className="inline-flex items-center gap-2 bg-amber-100/80 rounded-full px-5 py-2 border border-amber-300/60 mb-10"
            variants={fadeInUp}
          >
            <Clock className="w-4 h-4 text-amber-700" />
            <span className="text-amber-800 font-semibold text-sm">
              {dict.hero.timeEstimate}
            </span>
          </motion.div>

          <motion.div
            ref={topCtaRef}
            className="flex flex-col sm:flex-row gap-4 justify-center items-center"
            variants={fadeInUp}
          >
            <Button
              size="lg"
              className="w-full sm:w-auto text-lg font-bold px-10 py-7 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1"
              onClick={onStartQuestionnaire}
              disabled={isLoading}
            >
              <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
              <div className="relative z-10 flex items-center justify-center gap-2">
                {isLoading ? (
                  <Loader2 className="h-6 w-6 animate-spin" />
                ) : (
                  <>
                    <CtaIcon className="h-6 w-6 fill-white" />
                    <span>{getCtaText()}</span>
                    <ArrowIcon className="h-5 w-5" />
                  </>
                )}
              </div>
            </Button>

            {status !== 'authenticated' && (
              <Link href="/auth/signin">
                <Button
                  variant="outline"
                  size="lg"
                  className="w-full sm:w-auto text-base font-medium px-8 py-6 border-2 border-teal-200 text-teal-700 hover:bg-teal-50 hover:border-teal-300 rounded-full transition-all duration-300 bg-white/80 backdrop-blur-sm"
                >
                  <Lock className={cn('h-5 w-5', isRTL ? 'ms-2' : 'me-2')} />
                  {dict.cta.login}
                </Button>
              </Link>
            )}
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 2: THE PROBLEM */}
      <motion.section
        className="py-20 px-4 relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <div className="inline-flex items-center gap-3 bg-rose-100/80 backdrop-blur-sm rounded-full px-6 py-3 shadow-md border border-rose-200/60 mb-6">
              <AlertCircle className="w-5 h-5 text-rose-600" />
              <span className="text-rose-700 font-bold">
                {dict.problemSection.badge}
              </span>
            </div>
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
              {dict.problemSection.title1}
              <br />
              <span className="text-2xl sm:text-3xl text-gray-600 font-normal">
                {dict.problemSection.title2}
              </span>
            </h2>
          </motion.div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto mb-12">
            <ProblemCard
              icon={<MessageCircle className="w-6 h-6" />}
              title={dict.problemSection.cards.generalAnswers.title}
              description={dict.problemSection.cards.generalAnswers.description}
              delay={0}
            />
            <ProblemCard
              icon={<Calendar className="w-6 h-6" />}
              title={dict.problemSection.cards.wastedTime.title}
              description={dict.problemSection.cards.wastedTime.description}
              delay={0.15}
            />
            <ProblemCard
              icon={<Target className="w-6 h-6" />}
              title={dict.problemSection.cards.lackOfFocus.title}
              description={dict.problemSection.cards.lackOfFocus.description}
              delay={0.3}
            />
            <ProblemCard
              icon={<AlertCircle className="w-6 h-6" />}
              title={dict.problemSection.cards.frustration.title}
              description={dict.problemSection.cards.frustration.description}
              delay={0.45}
            />
          </div>

          <motion.div
            className="text-center"
            initial={{ opacity: 0, scale: 0.9 }}
            whileInView={{ opacity: 1, scale: 1 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.6 }}
          >
            <div className="inline-block bg-gradient-to-r from-amber-50 via-orange-50 to-rose-50 rounded-3xl px-8 py-5 shadow-xl border-2 border-amber-200/60">
              <p className="text-xl md:text-2xl font-bold text-gray-800">
                {dict.problemSection.insight}
              </p>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 3: THE SOLUTION */}
      <motion.section
        className="py-20 px-4 relative bg-white/40 backdrop-blur-sm"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <div className="inline-flex items-center gap-3 bg-teal-50 backdrop-blur-sm rounded-full px-6 py-3 shadow-md border border-teal-200 mb-6">
              <Lightbulb className="w-5 h-5 text-teal-600" />
              <span className="text-teal-700 font-bold">
                {dict.solutionSection.badge}
              </span>
            </div>
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
              {dict.solutionSection.title}{' '}
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500">
                {dict.solutionSection.titleHighlight}
              </span>
            </h2>
            <p className="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
              {dict.solutionSection.subtitle1}
              <br className="hidden sm:inline" />
              {dict.solutionSection.subtitle2}
            </p>
          </motion.div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <SolutionCard
              icon={<Heart className="w-8 h-8" />}
              title={dict.solutionSection.cards.selfDiscovery.title}
              description={dict.solutionSection.cards.selfDiscovery.description}
              gradient="from-rose-400 via-pink-500 to-red-500"
              shadowColor="shadow-rose-500/25"
              bgGradient="from-rose-50 via-white to-red-50"
              delay={0}
            />
            <SolutionCard
              icon={<FileText className="w-8 h-8" />}
              title={dict.solutionSection.cards.fullPicture.title}
              description={dict.solutionSection.cards.fullPicture.description}
              gradient="from-teal-400 via-teal-500 to-emerald-500"
              shadowColor="shadow-teal-500/25"
              bgGradient="from-teal-50 via-white to-emerald-50"
              delay={0.15}
            />
            <SolutionCard
              icon={<Target className="w-8 h-8" />}
              title={dict.solutionSection.cards.focusedSearch.title}
              description={dict.solutionSection.cards.focusedSearch.description}
              gradient="from-orange-400 via-amber-500 to-yellow-500"
              shadowColor="shadow-orange-500/25"
              bgGradient="from-orange-50 via-white to-amber-50"
              delay={0.3}
            />
          </div>

          <motion.div
            className="mt-16 text-center"
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.5 }}
          >
            <div className="inline-block bg-gradient-to-r from-teal-50 via-white to-orange-50 rounded-2xl p-8 shadow-lg border border-teal-100/60">
              <div className="flex items-center justify-center gap-3 mb-4">
                <Zap className="w-6 h-6 text-orange-500" />
                <h3 className="text-2xl font-bold text-gray-800">
                  {dict.solutionSection.result.title}
                </h3>
                <Zap className="w-6 h-6 text-orange-500" />
              </div>
              <p className="text-lg text-gray-600 leading-relaxed max-w-2xl">
                {dict.solutionSection.result.description}
              </p>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 4: THE WORLDS */}
      <motion.section
        className="py-20 px-4 relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-6xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <h2 className="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">
              {dict.worldsSection.title}
            </h2>
            <div className="w-24 h-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 mx-auto rounded-full mb-6" />
            <p className="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
              {dict.worldsSection.subtitle}
            </p>
          </motion.div>

          <motion.div
            className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6"
            variants={staggeredCardVariants}
          >
            {worldVisuals.map((world, index) => {
              const colorClasses = {
                blue: 'from-sky-400 to-blue-500',
                rose: 'from-rose-400 to-red-500',
                purple: 'from-purple-400 to-indigo-500',
                teal: 'from-teal-400 to-emerald-500',
                amber: 'from-amber-400 to-yellow-500',
              };

              const worldInfo = dict.worldsSection.worlds[world.id as WorldId];

              return (
                <motion.div key={world.id} variants={fadeInUp}>
                  <div className="relative overflow-hidden rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 bg-white/95 backdrop-blur-sm border-2 border-white/60 flex flex-col h-full group p-8 text-center items-center">
                    <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-white/50 to-transparent rounded-bl-full blur-xl" />
                    <div
                      className={cn(
                        'relative p-5 rounded-2xl bg-gradient-to-br text-white shadow-xl mb-6 group-hover:scale-110 group-hover:rotate-6 transition-all duration-300',
                        colorClasses[world.color]
                      )}
                    >
                      <div className="absolute inset-0 rounded-2xl bg-white/20 backdrop-blur-sm" />
                      <div className="relative z-10">{world.icon}</div>
                    </div>
                    <div className="inline-flex items-center justify-center px-3 py-1 rounded-full bg-gray-100 mb-4">
                      <span className="text-xs font-bold text-gray-600">
                        {dict.worldsSection.worldLabel.replace(
                          '{{number}}',
                          (index + 1).toString()
                        )}
                      </span>
                    </div>
                    <h3 className="text-xl font-bold text-gray-800 mb-3 leading-tight">
                      {worldInfo.title}
                    </h3>
                    <p className="text-sm text-gray-600 leading-relaxed">
                      {worldInfo.description}
                    </p>
                  </div>
                </motion.div>
              );
            })}
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 5: FEATURES */}
      <motion.section
        className="py-20 px-4 bg-gradient-to-b from-white/80 to-teal-50/40"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
        variants={containerVariants}
      >
        <div className="max-w-5xl mx-auto">
          <motion.div className="text-center mb-16" variants={fadeInUp}>
            <h2 className="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">
              {dict.featuresSection.title}
            </h2>
            <div className="w-24 h-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 mx-auto rounded-full mb-6" />
          </motion.div>

          <motion.div
            className="grid grid-cols-1 md:grid-cols-3 gap-8 text-center"
            variants={staggeredCardVariants}
          >
            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-teal-400 to-emerald-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-teal-500/25">
                <Clock className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.fast.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.fast.description}
              </p>
            </motion.div>

            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-orange-400 to-amber-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-orange-500/25">
                <Shield className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.private.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.private.description}
              </p>
            </motion.div>

            <motion.div
              className="flex flex-col items-center p-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 border border-white/60 group"
              variants={fadeInUp}
            >
              <div className="p-5 rounded-2xl mb-6 bg-gradient-to-br from-rose-400 to-red-500 shadow-lg group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-rose-500/25">
                <Star className="h-8 w-8 text-white" />
              </div>
              <h3 className="font-bold text-xl mb-3 text-gray-800">
                {dict.featuresSection.cards.instantResult.title}
              </h3>
              <p className="text-base text-gray-600 leading-relaxed">
                {dict.featuresSection.cards.instantResult.description}
              </p>
            </motion.div>
          </motion.div>
        </div>
      </motion.section>

      {/* SECTION 6: FINAL CTA */}
      <motion.section
        className="py-24 px-4 text-center relative"
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.15 }}
        variants={containerVariants}
      >
        <div className="max-w-4xl mx-auto">
          <motion.div
            className="relative bg-gradient-to-br from-white/95 via-teal-50/80 to-orange-50/80 backdrop-blur-xl rounded-3xl p-12 md:p-16 shadow-2xl border-2 border-white/60"
            variants={fadeInUp}
          >
            <div className="absolute -top-6 left-1/2 -translate-x-1/2">
              <div className="bg-gradient-to-r from-teal-500 via-orange-500 to-rose-500 rounded-full p-4 shadow-xl">
                <Sparkles className="w-8 h-8 text-white" />
              </div>
            </div>

            <div className="absolute top-4 right-8 w-24 h-24 bg-gradient-to-br from-teal-200/30 to-transparent rounded-full blur-2xl" />
            <div className="absolute bottom-4 left-8 w-32 h-32 bg-gradient-to-tr from-orange-200/30 to-transparent rounded-full blur-2xl" />

            <div className="relative z-10">
              <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold mb-6 text-gray-800 leading-tight">
                {dict.finalCta.title1}
                <br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-600 to-amber-600">
                  {dict.finalCta.title2}
                </span>
              </h2>
              <p className="text-xl text-gray-600 mb-10 leading-relaxed max-w-2xl mx-auto whitespace-pre-line">
                {dict.finalCta.subtitle}
              </p>

              <motion.div variants={fadeInUp}>
                <Button
                  size="lg"
                  onClick={onStartQuestionnaire}
                  disabled={isLoading}
                  className="text-xl font-bold px-12 py-8 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 group relative overflow-hidden transform hover:-translate-y-1 hover:scale-105"
                >
                  <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/40 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
                  <div className="relative z-10 flex items-center justify-center gap-3">
                    {isLoading ? (
                      <Loader2 className="h-7 w-7 animate-spin" />
                    ) : (
                      <>
                        <FileText className="h-7 w-7 group-hover:rotate-12 transition-transform" />
                        <span>{dict.finalCta.buttonText}</span>
                        <ArrowIcon className="h-6 w-6 group-hover:-translate-x-1 transition-transform" />
                      </>
                    )}
                  </div>
                </Button>
              </motion.div>

              <motion.div
                className="mt-8 flex items-center justify-center gap-3 text-gray-600"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.4 }}
              >
                <CheckCircle className="w-5 h-5 text-teal-500" />
                <span className="font-medium">{dict.finalCta.assurance}</span>
              </motion.div>
            </div>
          </motion.div>
        </div>
      </motion.section>

      {/* MOBILE STICKY CTA */}
      {isMobile && showBottomCta && (
        <motion.div
          initial={{ y: 100, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          exit={{ y: 100, opacity: 0 }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          className="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-xl border-t-2 border-teal-200/80 shadow-2xl z-50"
        >
          <Button
            size="lg"
            className="w-full text-base font-bold py-4 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 text-white rounded-xl shadow-xl hover:shadow-2xl transition-all group relative overflow-hidden"
            onClick={onStartQuestionnaire}
            disabled={isLoading}
          >
            <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-white/0 via-white/30 to-white/0 transform -translate-x-full group-hover:animate-shimmer"></span>
            <div className="relative z-10 flex items-center justify-center gap-2">
              {isLoading ? (
                <Loader2 className="h-5 w-5 animate-spin" />
              ) : (
                <>
                  <CtaIcon className="h-5 w-5 fill-white" />
                  <span>{getCtaText()}</span>
                </>
              )}
            </div>
          </Button>
        </motion.div>
      )}

      <footer className="text-center py-8 text-gray-500 text-sm bg-slate-50/80">
        {dict.footer.copyright.replace(
          '{{year}}',
          new Date().getFullYear().toString()
        )}
      </footer>

      <style>{`
        @keyframes float-slow {
          0%, 100% { transform: translateY(0) translateX(0); }
          25% { transform: translateY(-25px) translateX(15px); }
          50% { transform: translateY(-10px) translateX(25px); }
          75% { transform: translateY(-20px) translateX(10px); }
        }
        .animate-float-slow {
          animation: float-slow 20s ease-in-out infinite;
        }
        
        @keyframes pulse-slow {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        .animate-pulse-slow {
          animation: pulse-slow 6s ease-in-out infinite;
        }
        
        @keyframes shimmer {
          100% { transform: translateX(100%); }
        }
        .animate-shimmer {
          animation: shimmer 2.5s infinite;
        }
        
        @keyframes gradient {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
        }
        .animate-gradient {
          background-size: 200% 200%;
          animation: gradient 4s ease-in-out infinite;
        }

        .shadow-3xl {
          box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3);
        }
      `}</style>
    </div>
  );
}
--- End of Content for QuestionnaireLandingPage.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions
================================================================================

(This directory contains subdirectories but no files directly. See subdirectories below.)

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\partner
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\partner\partnerQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/partner/partnerQuestions.tsx
import { Question } from '../../types/types';
import {
  Heart,
  Brain,
  Smile,
  ShieldCheck,
  Star,
  Users,
  Moon,
  Home,
  Target,
  Scale,
  BookOpen,
  Scroll,
  Activity,
  Coffee,
  Eye,
  Car,
  Flag,
  Globe,
  HandHeart,
  Lightbulb,
  Briefcase,
  PiggyBank,
  Info,
  Sparkles,
  Palette,
  Headphones,
  MessageCircle,
  TrendingUp,
  Building2,
  Mountain,
  TreePine,
  MapPin,
  DollarSign,
  HelpCircle,
} from 'lucide-react';

export const partnerQuestions: Question[] = [
  {
    worldId: 'PARTNER',
    id: 'partner_initial_impression_priorities_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'appearance_style', icon: <Eye /> },
      { value: 'smile_energy', icon: <Smile /> },
      { value: 'conversation_chemistry', icon: <MessageCircle /> },
      { value: 'wit_depth', icon: <Brain /> },
      { value: 'sense_of_security', icon: <ShieldCheck /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_appearance_importance_scale_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_intelligence_types',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'emotional', icon: <Heart /> },
      { value: 'analytical', icon: <Brain /> },
      { value: 'life_smarts', icon: <Sparkles /> },
      { value: 'creative', icon: <Lightbulb /> },
      { value: 'spiritual_torah', icon: <BookOpen /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_core_character_traits_essential_revised',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'integrity', icon: <ShieldCheck /> },
      { value: 'warmth', icon: <Heart /> },
      { value: 'optimism', icon: <Smile /> },
      { value: 'maturity', icon: <Target /> },
      { value: 'ambition', icon: <Star /> },
      { value: 'communication', icon: <HandHeart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_completion_trait',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 20,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_emotional_expression_preference',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'open_verbal' },
        { value: 'action_oriented' },
        { value: 'balanced' },
        { value: 'not_critical' },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PARTNER',
    id: 'partner_dating_persona',
    category: 'partner',
    subcategory: 'first_impression_basics',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'observer_listener', icon: <Headphones /> },
      { value: 'storyteller_initiator', icon: <MessageCircle /> },
      { value: 'humorous_light', icon: <Smile /> },
      { value: 'deep_serious', icon: <Brain /> },
      { value: 'shy_reserved', icon: <Moon /> },
    ],
    metadata: { estimatedTime: 3 },
  },

  {
    worldId: 'PARTNER',
    id: 'partner_lifestyle_pace_preference_revised',
    category: 'partner',
    subcategory: 'lifestyle_social',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'dynamic_active', icon: <Activity /> },
      { value: 'calm_serene', icon: <Home /> },
      { value: 'balanced', icon: <Scale /> },
      { value: 'adventurous_spontaneous', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_financial_habits_scale',
    category: 'partner',
    subcategory: 'career_finance_education',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_career_ambition_preference_revised',
    category: 'partner',
    subcategory: 'career_finance_education',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'ambition_focus', icon: <Star /> },
      { value: 'work_life_balance', icon: <Scale /> },
      { value: 'personal_satisfaction', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_deal_breakers_open_text_revised',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_common_disqualifiers',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_personality_clash',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_red_flag_vs_quirk',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_in_laws_conflict',
    category: 'partner',
    subcategory: 'family_background',
    type: 'iconChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'loyalty_to_couple', icon: <ShieldCheck /> },
      { value: 'mediation_compromise', icon: <Scale /> },
      { value: 'diplomacy', icon: <Users /> },
      { value: 'loyalty_to_family_of_origin', icon: <Home /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_family_connection_importance',
    category: 'partner',
    subcategory: 'family_background',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PARTNER',
    id: 'partner_must_have_quality_final_revised',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 10,
    maxLength: 150,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PARTNER',
    id: 'partner_romantic_past_comfort',
    category: 'partner',
    subcategory: 'non_negotiables',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'no_past' },
        { value: 'short_term_ok' },
        { value: 'long_term_ok' },
        { value: 'past_is_past' },
    ],
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'PARTNER',
    id: 'partner_what_you_bring',
    category: 'partner',
    subcategory: 'self_perception',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
},

];
--- End of Content for partnerQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\personality
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\personality\personalityQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/personality/personalityQuestions.tsx
import { Question } from '../../types/types';
import {
  Sun,
  Moon,
  Users,
  Brain,
  Heart,
  Target,
  Compass,
  Cloud,
  Leaf,
  Home,
  Watch,
  Scale,
  Coffee,
  MessageCircle,
  HandHeart,
  Lightbulb,
  Sparkles,
  Star,
   BatteryCharging,
    Phone,
  Smile,
  ShieldCheck,
  BookOpen,
  Palette,
  Headphones,
  Mountain,
  Bed,
  Utensils,
  Activity,
  Edit,
  HelpCircle,
  Anchor,
  Feather,
} from 'lucide-react';

export const personalityQuestions: Question[] = [
  {
    worldId: 'PERSONALITY',
    id: 'personality_core_trait_selection_revised',
    category: 'personality',
    subcategory: 'self_perception',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'empathetic_sensitive', icon: <Heart /> },
      { value: 'honest_reliable', icon: <ShieldCheck /> },
      { value: 'optimistic_cheerful', icon: <Sun /> },
      { value: 'humorous', icon: <Smile /> },
      { value: 'intelligent_curious', icon: <Brain /> },
      { value: 'ambitious_motivated', icon: <Star /> },
      { value: 'easygoing_flexible', icon: <Feather /> },
      { value: 'responsible_organized', icon: <Target /> },
      { value: 'creative_original', icon: <Lightbulb /> },
      { value: 'stable_grounded', icon: <Anchor /> },
      { value: 'decisive_confident', icon: <Compass /> },
      { value: 'generous_caring', icon: <HandHeart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_social_battery_recharge',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'scenario',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'quiet_evening_home', icon: <Moon /> },
      { value: 'intimate_gathering', icon: <Coffee /> },
      { value: 'energetic_social_outing', icon: <Users /> },
      { value: 'flexible_combination', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_loneliness_coping',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'recharge_renew', icon: <BatteryCharging /> },
      { value: 'productivity_focus', icon: <Brain /> },
      { value: 'mild_loneliness', icon: <Phone /> },
      { value: 'discomfort', icon: <Users /> },
    ],
    metadata: { estimatedTime: 1 },
},
  {
    worldId: 'PERSONALITY',
    id: 'personality_biological_clock',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
{
        worldId: 'PERSONALITY',
        id: 'personality_sleep_flexibility',
        category: 'personality',
        subcategory: 'lifestyle',
        type: 'singleChoice',
        depth: 'ADVANCED',
        isRequired: false,
        options: [
            { value: 'very_flexible' },
            { value: 'somewhat_flexible' },
            { value: 'not_flexible' },
        ],
        metadata: { estimatedTime: 1 },
    },

  {
    worldId: 'PERSONALITY',
    id: 'personality_daily_structure_revised',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'order_planning', icon: <Watch /> },
      { value: 'flexibility_flow', icon: <Cloud /> },
      { value: 'task_oriented', icon: <Target /> },
      { value: 'balance', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_social_situation_revised',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'initiator', icon: <Users /> },
      { value: 'joiner', icon: <Coffee /> },
      { value: 'deep_diver', icon: <MessageCircle /> },
      { value: 'observer', icon: <Compass /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
        worldId: 'PERSONALITY',
        id: 'personality_pressure_pattern',
        category: 'personality',
        subcategory: 'emotional_coping',
        type: 'iconChoice',
        depth: 'ADVANCED',
        isRequired: false,
        options: [
            { value: 'need_space', icon: <Moon /> },
            { value: 'seek_support', icon: <Users /> },
            { value: 'action_oriented', icon: <Target /> },
            { value: 'avoidance_distraction', icon: <Cloud /> },
        ],
        metadata: { estimatedTime: 1 },
    },
    {
        worldId: 'PERSONALITY',
        id: 'personality_life_pace',
        category: 'personality',
        subcategory: 'lifestyle',
        type: 'singleChoice',
        depth: 'BASIC',
        isRequired: false,
        options: [
            { value: 'planned_efficient' },
            { value: 'organized_spontaneous' },
            { value: 'flexible_flow' },
            { value: 'minimalist_calm' },
        ],
        metadata: { estimatedTime: 1 },
    },

  {
    worldId: 'PERSONALITY',
    id: 'personality_self_portrayal_revised',
    category: 'personality',
    subcategory: 'self_perception',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 70,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_unproductive_day_feeling',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'self_compassion', icon: <Heart /> },
      { value: 'criticism_action', icon: <Target /> },
      { value: 'analysis_learning', icon: <Brain /> },
      { value: 'immediate_fix', icon: <Activity /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_plan_change_reaction',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_stress_management_revised',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'multiSelectWithOther',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'movement_sport', icon: <Activity /> },
      { value: 'talk_vent', icon: <Users /> },
      { value: 'alone_time_rest', icon: <Bed /> },
      { value: 'nature', icon: <Leaf /> },
      { value: 'creative_hobby', icon: <Palette /> },
      { value: 'order_organization', icon: <Brain /> },
      { value: 'media_disconnect', icon: <Headphones /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_friendship_in_action',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_friend_in_crisis',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'emotional_support', icon: <Heart /> },
      { value: 'problem_solving', icon: <Brain /> },
      { value: 'clarification_analysis', icon: <MessageCircle /> },
      { value: 'distraction', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_seeking_help',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'solve_alone' },
      { value: 'share_selectively' },
      { value: 'consult_trusted_circle' },
      { value: 'seek_professional_guidance' },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'PERSONALITY',
    id: 'personality_handling_criticism_revised',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_communication_style_revised',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'direct_clear', icon: <Target /> },
      { value: 'empathetic_listening', icon: <HandHeart /> },
      { value: 'logic_facts', icon: <Brain /> },
      { value: 'humor_lightness', icon: <Smile /> },
      { value: 'openness_emotional_sharing', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_humor_type',
    category: 'personality',
    subcategory: 'social_communication',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 2,
    options: [
      { value: 'cynical_witty' },
      { value: 'puns_wordplay' },
      { value: 'situational_sitcom' },
      { value: 'self_deprecating' },
      { value: 'silly_light' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_learning_process',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_failure_lesson',
    category: 'personality',
    subcategory: 'emotional_coping',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_good_vs_perfect_day',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_vacation_compass',
    category: 'personality',
    subcategory: 'lifestyle',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'relaxation', icon: <Bed /> },
      { value: 'adventure', icon: <Mountain /> },
      { value: 'city_life', icon: <Sparkles /> },
      { value: 'social_time', icon: <Users /> },
      { value: 'romance', icon: <Heart /> },
      { value: 'enrichment', icon: <BookOpen /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_primary_motivation_revised',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'achieving_goals', icon: <Star /> },
      { value: 'building_connections', icon: <Heart /> },
      { value: 'giving_impact', icon: <HandHeart /> },
      { value: 'learning_curiosity', icon: <BookOpen /> },
      { value: 'creativity_expression', icon: <Sparkles /> },
      { value: 'security_stability', icon: <ShieldCheck /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'PERSONALITY',
    id: 'personality_strengths_and_weaknesses_revised',
    category: 'personality',
    subcategory: 'growth_aspirations',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 70,
    maxLength: 600,
    metadata: { estimatedTime: 3 },
  },
];
--- End of Content for personalityQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\relationship
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\relationship\relationshipQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/relationship/relationshipQuestions.tsx
import { Question } from '../../types/types';
import {
  Briefcase,
  BookOpen,
  Target,
  Heart,
  Users,
  Home,
  MessageCircle,
  Scale,
  Brain,
  Moon,
  Sparkles,
  HandHeart,
  ShieldCheck,
  Link,
  Map,
  Clock,
  Award,
  Baby,
  Coffee,
  Bed,
  Smile,
  Gift,
  Info,
  HelpCircle,
} from 'lucide-react';

export const relationshipQuestions: Question[] = [
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_core_meaning_revised',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'deep_emotional_connection', icon: <Heart /> },
      { value: 'friendship_support', icon: <Users /> },
      { value: 'commitment_security', icon: <Link /> },
      { value: 'shared_growth', icon: <Sparkles /> },
      { value: 'building_home_family', icon: <Home /> },
    ],
    minSelections: 1,
    maxSelections: 2,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_key_feelings_from_partner_revised',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelectWithOther',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'support_understanding', icon: <HandHeart /> },
      { value: 'appreciation_respect', icon: <Award /> },
      { value: 'security_trust', icon: <ShieldCheck /> },
      { value: 'desire_attraction', icon: <Sparkles /> },
      { value: 'lightness_fun', icon: <Smile /> },
      { value: 'intellectual_partnership', icon: <Brain /> },
    ],
    minSelections: 1,
    maxSelections: 3,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_love_languages',
    category: 'relationship',
    subcategory: 'core_expectations',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    minSelections: 1,
    maxSelections: 2,
    options: [
      { value: 'words_of_affirmation' },
      { value: 'quality_time' },
      { value: 'physical_touch' },
      { value: 'acts_of_service' },
      { value: 'receiving_gifts' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_communication_ideal_revised',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'openness_directness', icon: <MessageCircle /> },
      { value: 'sensitivity_empathy', icon: <Heart /> },
      { value: 'solution_focused', icon: <Brain /> },
      { value: 'balance', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_handling_partner_disappointment_revised',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'withdraw_process', icon: <Moon /> },
      { value: 'immediate_talk', icon: <MessageCircle /> },
      { value: 'suppression', icon: <ShieldCheck /> },
      { value: 'logical_analysis', icon: <Brain /> },
      { value: 'not_sure', icon: <HelpCircle /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_repair_mechanism',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'processing_talk', icon: <MessageCircle /> },
      { value: 'hug_move_on', icon: <HandHeart /> },
      { value: 'time_out', icon: <Clock /> },
      { value: 'change_of_scenery', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_meaningful_apology',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'express_remorse', icon: <Heart /> },
      { value: 'take_responsibility', icon: <ShieldCheck /> },
      { value: 'offer_to_fix', icon: <Target /> },
      { value: 'saying_sorry', icon: <MessageCircle /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_silent_treatment_view',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_expressing_needs',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
        { value: 'keep_inside' },
        { value: 'wait_for_right_moment' },
        { value: 'direct_conversation' },
        { value: 'hint_repeatedly' },
    ],
    metadata: { estimatedTime: 1 },
},

{
    worldId: 'RELATIONSHIP',
    id: 'relationship_physical_intimacy_importance',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'scale',
    depth: 'EXPERT',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'RELATIONSHIP',
    id: 'relationship_screen_time_approach',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'very_limited' },
        { value: 'balanced_usage' },
        { value: 'flexible_usage' },
    ],
    metadata: { estimatedTime: 1 },
},
{
    worldId: 'RELATIONSHIP',
    id: 'relationship_argument_style',
    category: 'relationship',
    subcategory: 'communication_intimacy',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
        { value: 'expressive_emotive' },
        { value: 'need_time_to_process' },
        { value: 'immediate_resolution' },
        { value: 'conflict_avoidant' },
    ],
    metadata: { estimatedTime: 1 },
},


  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_partner_bad_day',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'listen_contain', icon: <Heart /> },
      { value: 'analyze_solve', icon: <Brain /> },
      { value: 'give_space', icon: <Home /> },
      { value: 'distract', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_receiving_support',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'need_to_vent', icon: <MessageCircle /> },
      { value: 'need_solutions', icon: <Brain /> },
      { value: 'need_distraction', icon: <Sparkles /> },
      { value: 'need_space', icon: <Home /> },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_household_philosophy',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_daily_togetherness_vs_autonomy_revised',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_role_in_growth',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'scale',
    depth: 'EXPERT',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_celebrating_success',
    category: 'relationship',
    subcategory: 'daily_life_partnership',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_family_vision_children_revised',
    category: 'relationship',
    subcategory: 'family_future_vision',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'central_part', icon: <Baby /> },
      { value: 'see_myself_as_parent', icon: <Home /> },
      { value: 'open_but_not_essential', icon: <Scale /> },
      { value: 'less_relevant', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_deal_breaker_summary_final_revised',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_dating_journey_reflection',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'new_to_process', icon: <Sparkles /> },
      { value: 'some_experience', icon: <Map /> },
      { value: 'long_journey', icon: <Clock /> },
      { value: 'taking_a_break', icon: <Moon /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELATIONSHIP',
    id: 'relationship_dating_journey_lesson',
    category: 'relationship',
    subcategory: 'growth_challenges',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
];
--- End of Content for relationshipQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion\faithQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/religion/faithQuestions.tsx - (גרסה מתוקנת)
import { Question } from '../../types/types';

export const faithQuestions: Question[] = [
  // Spiritual and Religious Values
  {
    worldId: 'RELIGION',
    id: 'spiritualMoment',
    category: 'values',
    subcategory: 'spiritual',
    question: 'מהו הרגע הכי רוחני שחווית בחייך?',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    placeholder: 'ספר/י על חוויה משמעותית...',
    minLength: 20,
    maxLength: 500,
  },
  {
    worldId: 'RELIGION',
    id: 'favoriteHoliday',
    category: 'values',
    subcategory: 'spiritual',
    question: 'איזה חג יהודי הכי משמעותי עבורך?',
    type: 'singleChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'ראש השנה', text: 'ראש השנה' },
      { value: 'יום כיפור', text: 'יום כיפור' },
      { value: 'פסח', text: 'פסח' },
      { value: 'שבועות', text: 'שבועות' },
    ],
  },

  // Personal Values
  {
    worldId: 'RELIGION',
    id: 'coreValues',
    category: 'values',
    subcategory: 'personal',
    question: 'מהם שלושת הערכים החשובים ביותר בחייך?',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'יושר ואמת', text: 'יושר ואמת' },
      { value: 'משפחה', text: 'משפחה' },
      { value: 'לימוד והתפתחות', text: 'לימוד והתפתחות' },
      { value: 'חסד', text: 'חסד' },
      { value: 'מסורת', text: 'מסורת' },
      { value: 'הצלחה', text: 'הצלחה' },
    ],
    minSelections: 1,
    maxSelections: 3,
  },
  {
    worldId: 'RELIGION',
    id: 'lifeGoals',
    category: 'values',
    subcategory: 'personal',
    question: 'מהי המטרה העיקרית שלך בחיים?',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    placeholder: 'שתף/י במטרות החיים שלך...',
    minLength: 30,
    maxLength: 500,
  },

  // Community Values
  {
    worldId: 'RELIGION',
    id: 'communityRole',
    category: 'values',
    subcategory: 'community',
    question: 'איזה תפקיד אתה רואה לעצמך בקהילה?',
    type: 'multiSelect',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'מנהיג/מוביל', text: 'מנהיג/מוביל' },
      { value: 'תומך ומסייע', text: 'תומך ומסייע' },
      { value: 'מחנך/מלמד', text: 'מחנך/מלמד' },
      { value: 'משתתף פעיל', text: 'משתתף פעיל' },
    ],
    minSelections: 1,
    maxSelections: 2,
  },
  {
    worldId: 'RELIGION',
    id: 'givingPhilosophy',
    category: 'values',
    subcategory: 'community',
    question: 'מהי תפיסת עולמך בנושא נתינה וצדקה?',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    placeholder: 'תאר/י את גישתך לנתינה...',
    minLength: 30,
    maxLength: 500,
  },

  // Future Values
  {
    worldId: 'RELIGION',
    id: 'nextGeneration',
    category: 'values',
    subcategory: 'future',
    question: 'מה הערכים החשובים ביותר שתרצה להעביר לדור הבא?',
    type: 'multiSelect',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'תורה ומסורת', text: 'תורה ומסורת' },
      { value: 'מוסר וערכים', text: 'מוסר וערכים' },
      { value: 'חינוך והשכלה', text: 'חינוך והשכלה' },
      { value: 'עצמאות', text: 'עצמאות' },
      { value: 'קהילתיות', text: 'קהילתיות' },
    ],
    minSelections: 1,
    maxSelections: 3,
  },
  {
    worldId: 'RELIGION',
    id: 'israelVision',
    category: 'values',
    subcategory: 'future',
    question: 'מהו החזון שלך למדינת ישראל?',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    placeholder: 'שתף/י את חזונך...',
    minLength: 50,
    maxLength: 1000,
  },
];
--- End of Content for faithQuestions.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion\practicalReligionQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/religion/practicalReligionQuestions.tsx - (גרסה מתוקנת)
import { Question } from "../../types/types";

export const practicalQuestions: Question[] = [
  // Basic Principles
  {worldId: "RELIGION",
    id: "religiousWorldview",
    category: "religiousLifestyle",
    subcategory: "basicPrinciples",
    question: "מהי השקפת עולמך הדתית?",
    type: "openText",
    depth: "BASIC",
    isRequired: false,
    placeholder: "תאר/י את תפיסת עולמך הדתית...",
    minLength: 20,
    maxLength: 500,
  },
  {worldId: "RELIGION",
    id: "religiousIdentity",
    category: "religiousLifestyle",
    subcategory: "basicPrinciples",
    question: "איך אתה מגדיר את זהותך הדתית?",
    type: "singleChoice",
    depth: "BASIC",
    isRequired: false,
    options: [
      { value: "חרדי", text: "חרדי" },
      { value: "דתי לאומי", text: "דתי לאומי" },
      { value: "מסורתי", text: "מסורתי" },
      { value: "אחר", text: "אחר" },
    ],
  },
  {worldId: "RELIGION",
    id: "halachaImportance",
    category: "religiousLifestyle",
    subcategory: "basicPrinciples",
    question: "מה מקומה של ההלכה בחיי היומיום שלך?",
    type: "openText",
    depth: "BASIC",
    isRequired: false,
    placeholder: "תאר/י את מקום ההלכה בחייך...",
    minLength: 20,
    maxLength: 500,
  },

  // Prayer and Learning
  {worldId: "RELIGION",
    id: "minyanImportance",
    category: "religiousLifestyle",
    subcategory: "prayerAndLearning",
    question: "מהי חשיבות התפילה במניין בחייך?",
    type: "singleChoice",
    depth: "BASIC",
    isRequired: false,
    options: [
      { value: "חשוב מאוד - משתדל להתפלל כל תפילה במניין", text: "חשוב מאוד - משתדל להתפלל כל תפילה במניין" },
      { value: "חשוב - משתדל לפחות פעם ביום", text: "חשוב - משתדל לפחות פעם ביום" },
      { value: "לעיתים - בעיקר בשבתות וחגים", text: "לעיתים - בעיקר בשבתות וחגים" },
      { value: "פחות חשוב לי", text: "פחות חשוב לי" },
    ],
  },
  {worldId: "RELIGION",
    id: "dailyLearning",
    category: "religiousLifestyle",
    subcategory: "prayerAndLearning",
    question: "איך נראה סדר הלימוד היומי שלך?",
    type: "multiSelect",
    depth: "BASIC",
    isRequired: false,
    options: [
      { value: "דף יומי", text: "דף יומי" },
      { value: "הלכה יומית", text: "הלכה יומית" },
      { value: "פרשת שבוע", text: "פרשת שבוע" },
      { value: "חסידות", text: "חסידות" },
      { value: "מוסר", text: "מוסר" },
      { value: "אחר", text: "אחר" },
    ],
    minSelections: 1,
    maxSelections: 4,
  },
  
  // Shabbat and Holidays
  {worldId: "RELIGION",
    id: "idealShabbat",
    category: "religiousLifestyle",
    subcategory: "shabbatAndHolidays",
    question: "איך נראית השבת האידיאלית בעיניך?",
    type: "openText",
    depth: "BASIC",
    isRequired: false,
    placeholder: "תאר/י את השבת המושלמת עבורך...",
    minLength: 20,
    maxLength: 500,
  },
  {worldId: "RELIGION",
    id: "shabbatRestrictions",
    category: "religiousLifestyle",
    subcategory: "shabbatAndHolidays",
    question: "מה יחסך לחומרות בהלכות שבת?",
    type: "multiSelect",
    depth: "ADVANCED",
    isRequired: false,
    options: [
      { value: "מחמיר בהלכות שבת", text: "מחמיר בהלכות שבת" },
      { value: "שומר על ההלכות הבסיסיות", text: "שומר על ההלכות הבסיסיות" },
      { value: "גמיש יותר בפרשנות", text: "גמיש יותר בפרשנות" },
      { value: "תלוי במצב ובנסיבות", text: "תלוי במצב ובנסיבות" },
    ],
    minSelections: 1,
    maxSelections: 2,
  },

  // Kashrut and Halacha
  {worldId: "RELIGION",
    id: "kashrutLevel",
    category: "religiousLifestyle",
    subcategory: "kashrutAndHalacha",
    question: "מה רמת ההקפדה שלך בכשרות?",
    type: "singleChoice",
    depth: "BASIC",
    isRequired: false,
    options: [
      { value: "מהדרין בלבד", text: "מהדרין בלבד" },
      { value: "כשרות רגילה", text: "כשרות רגילה" },
      { value: "כשרות בסיסית", text: "כשרות בסיסית" },
      { value: "גמיש יותר", text: "גמיש יותר" },
    ],
  },
  {worldId: "RELIGION",
    id: "eatingOut",
    category: "religiousLifestyle",
    subcategory: "kashrutAndHalacha",
    question: "איך אתה מתייחס לאכילה מחוץ לבית?",
    type: "multiSelect",
    depth: "BASIC",
    isRequired: false,
    options: [
      { value: "רק במסעדות כשרות", text: "רק במסעדות כשרות" },
      { value: "אוכל בבתים של משפחה", text: "אוכל בבתים של משפחה" },
      { value: "אוכל אצל חברים", text: "אוכל אצל חברים" },
      { value: "גמיש בהתאם לנסיבות", text: "גמיש בהתאם לנסיבות" },
    ],
    minSelections: 1,
    maxSelections: 3,
  },

  // Modesty and Public Space
  {worldId: "RELIGION",
    id: "modestyView",
    category: "religiousLifestyle",
    subcategory: "modestyAndPublic",
    question: "מהי השקפתך בענייני צניעות?",
    type: "openText",
    depth: "BASIC",
    isRequired: false,
    placeholder: "תאר/י את תפיסתך בנושא צניעות...",
    minLength: 20,
    maxLength: 500,
  },
  {worldId: "RELIGION",
    id: "genderSeparation",
    category: "religiousLifestyle",
    subcategory: "modestyAndPublic",
    question: "איך אתה מתייחס להפרדה בין גברים לנשים?",
    type: "singleChoice",
    depth: "ADVANCED",
    isRequired: false,
    options: [
      { value: "תומך בהפרדה מלאה", text: "תומך בהפרדה מלאה" },
      { value: "תלוי בנסיבות ובמקום", text: "תלוי בנסיבות ובמקום" },
      { value: "גמיש יותר בנושא", text: "גמיש יותר בנושא" },
      { value: "מתנגד להפרדה", text: "מתנגד להפרדה" },
    ],
  },
];
--- End of Content for practicalReligionQuestions.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\religion\religionQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/religion/religionQuestions.tsx
import { Question } from '../../types/types';
import {
  Scroll,
  BookOpen,
  Users,
  Home,
  Target,
  Scale,
  Heart,
  Sparkles,
  ShieldCheck,
  Flag,
  X,
  HandHeart,
  Lightbulb,
  Info,
  PocketKnife,
  Bed,
  Smile,
  Brain,
} from 'lucide-react';

export const religionQuestions: Question[] = [
  {
    worldId: 'RELIGION',
    id: 'religion_core_feeling_of_faith',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'security_stability', icon: <ShieldCheck /> },
      { value: 'meaning_belonging', icon: <Target /> },
      { value: 'joy_gratitude', icon: <Sparkles /> },
      { value: 'challenge_growth', icon: <Brain /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_my_personal_prayer',
    category: 'religion',
    subcategory: 'personal_reflection',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_rabbinic_guidance_role_revised',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_shabbat_experience',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'family_time', icon: <Home /> },
      { value: 'spiritual_ascension', icon: <BookOpen /> },
      { value: 'rest_recharge', icon: <Bed /> },
      { value: 'community_social', icon: <Users /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_daily_spiritual_connection',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 3,
    options: [
      { value: 'torah_study' },
      { value: 'personal_prayer' },
      { value: 'nature_gratitude' },
      { value: 'acts_of_kindness' },
      { value: 'song_music' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_kashrut_observance_details_revised',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_modesty_personal_approach_revised',
    category: 'religion',
    subcategory: 'practical_observance',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_secular_culture_scenario',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'avoid', icon: <X /> },
      { value: 'filter_check', icon: <Info /> },
      { value: 'social_inclusion', icon: <Users /> },
      { value: 'suggest_alternative', icon: <Smile /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_general_culture_consumption',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_community_role',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'central' },
      { value: 'important' },
      { value: 'secondary' },
      { value: 'not_seeking' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_partner_torah_learning_expectation',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'dedicated_daily' },
      { value: 'regularly_flexible' },
      { value: 'when_possible' },
      { value: 'not_a_focus' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_army_service_attitude',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'essential_for_men' },
      { value: 'meaningful_service' },
      { value: 'torah_is_protection' },
      { value: 'flexible_personal_choice' },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_zionism_importance',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_intergroup_friendships',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'large_part' },
      { value: 'some_friends' },
      { value: 'mostly_homogeneous' },
    ],
    metadata: { estimatedTime: 1 },
  },

  {
    worldId: 'RELIGION',
    id: 'religion_doubts_and_struggles',
    category: 'religion',
    subcategory: 'identity_belief',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_partner_ideal_religious_profile_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_flexibility_religious_differences_partner_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_gender_roles_philosophy',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'budgetAllocation',
    depth: 'EXPERT',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'traditional', icon: <Scroll /> },
      { value: 'egalitarian', icon: <Scale /> },
      { value: 'flexible', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_children_education_religious_vision_revised',
    category: 'religion',
    subcategory: 'relationship_family',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'RELIGION',
    id: 'religion_other_denominations_attitude',
    category: 'religion',
    subcategory: 'community_influence',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
      { value: 'decline' },
      { value: 'conditional_participation' },
      { value: 'accept_openly' },
      { value: 'depends_on_context' },
    ],
    metadata: { estimatedTime: 1 },
  },
];
--- End of Content for religionQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\values
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\questions\values\valuesQuestions.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/questions/values/valuesQuestions.tsx
import { Question } from '../../types/types';
import {
  Heart,
  Scale,
  Brain,
  BookOpen,
  Users,
  Home,
  Briefcase,
  Target,
  PiggyBank,
  HandHeart,
  TrendingUp,
  Leaf,
  Sparkles,
  ShieldCheck,
  Flag,
  HelpCircle,
  Info,
  Scroll,
  DollarSign,
  Activity,
  MessageCircle,
} from 'lucide-react';

export const valuesQuestions: Question[] = [
  {
    worldId: 'VALUES',
    id: 'values_core_identification_revised',
    category: 'values',
    subcategory: 'core_values',
    type: 'budgetAllocation',
    depth: 'BASIC',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'family_connections', icon: <Heart /> },
      { value: 'integrity_honesty', icon: <ShieldCheck /> },
      { value: 'spirituality_faith', icon: <BookOpen /> },
      { value: 'personal_growth', icon: <TrendingUp /> },
      { value: 'giving_contribution', icon: <HandHeart /> },
      { value: 'career_fulfillment', icon: <Briefcase /> },
      { value: 'financial_security', icon: <PiggyBank /> },
      { value: 'creativity_expression', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_core_elaboration_revised',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 70,
    maxLength: 600,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_childhood_home_atmosphere',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 10,
    maxLength: 150,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_quiet_heroes',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_childhood_shaping_experience',
    category: 'values',
    subcategory: 'core_values',
    type: 'multiSelect',
    depth: 'ADVANCED',
    isRequired: false,
    minSelections: 1,
    maxSelections: 3,
    options: [
      { value: 'financial_struggle_or_abundance', icon: <DollarSign /> },
      { value: 'parental_relationship_dynamics', icon: <Home /> },
      { value: 'social_challenges_school', icon: <Users /> },
      { value: 'health_or_loss_experiences', icon: <Heart /> },
      { value: 'academic_pressure_or_freedom', icon: <BookOpen /> },
      { value: 'religious_environment_strict_or_open', icon: <Scroll /> },
    ],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_strength_from_challenge',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },

  {
    worldId: 'VALUES',
    id: 'values_two_job_offers',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'scenario',
    depth: 'EXPERT',
    isRequired: false,
    options: [{ value: 'offer_a' }, { value: 'offer_b' }],
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_life_priorities_allocation_revised',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'budgetAllocation',
    depth: 'ADVANCED',
    isRequired: false,
    totalPoints: 100,
    categories: [
      { value: 'relationship', icon: <Heart /> },
      { value: 'family', icon: <Home /> },
      { value: 'career', icon: <Briefcase /> },
      { value: 'spirituality', icon: <BookOpen /> },
      { value: 'community', icon: <Users /> },
      { value: 'leisure', icon: <Sparkles /> },
    ],
    metadata: { estimatedTime: 4 },
  },
  {
    worldId: 'VALUES',
    id: 'values_health_lifestyle_importance',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_risk_attitude',
    category: 'values',
    subcategory: 'life_priorities',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'VALUES',
    id: 'values_feeling_of_home',
    category: 'values',
    subcategory: 'community_social',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_definition_of_rich_life',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_attitude_towards_money_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'security_tool', icon: <PiggyBank /> },
      { value: 'means_for_experiences', icon: <Sparkles /> },
      { value: 'balance_responsibility', icon: <Scale /> },
      { value: 'simplicity', icon: <Leaf /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_definition_of_success',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 40,
    maxLength: 400,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_extended_family_involvement',
    category: 'values',
    subcategory: 'community_social',
    type: 'singleChoice',
    depth: 'EXPERT',
    isRequired: false,
    options: [
        { value: 'high_involvement' },
        { value: 'healthy_boundaries' },
        { value: 'minimal_involvement' },
        { value: 'depends_on_dynamics' },
    ],
    metadata: { estimatedTime: 1 },
},

  {
    worldId: 'VALUES',
    id: 'values_lost_wallet',
    category: 'values',
    subcategory: 'core_values',
    type: 'openText',
    depth: 'BASIC',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
  {
    worldId: 'VALUES',
    id: 'values_moral_dilemma',
    category: 'values',
    subcategory: 'core_values',
    type: 'scenario',
    depth: 'EXPERT',
    isRequired: false,
    options: [
        { value: 'express_discomfort' },
        { value: 'listen_without_judgment' },
        { value: 'challenge_and_advise' },
        { value: 'do_not_intervene' },
    ],
    metadata: { estimatedTime: 2 },
},

  {
    worldId: 'VALUES',
    id: 'values_giving_tzedaka_importance_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'scale',
    depth: 'BASIC',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_education_pursuit_revised',
    category: 'values',
    subcategory: 'material_intellectual',
    type: 'iconChoice',
    depth: 'BASIC',
    isRequired: false,
    options: [
      { value: 'lifelong_learning', icon: <BookOpen /> },
      { value: 'goal_oriented_learning', icon: <Target /> },
      { value: 'experiential_learning', icon: <Sparkles /> },
      { value: 'appreciative_but_passive', icon: <Scale /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_parents_tradition_conflict',
    category: 'values',
    subcategory: 'challenges_conflicts',
    type: 'openText',
    depth: 'EXPERT',
    isRequired: false,
    minLength: 50,
    maxLength: 500,
    metadata: { estimatedTime: 3 },
  },
  {
    worldId: 'VALUES',
    id: 'values_social_political_stance_importance_partner_revised',
    category: 'values',
    subcategory: 'community_social',
    type: 'scale',
    depth: 'ADVANCED',
    isRequired: false,
    min: 1,
    max: 10,
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_dealing_with_disagreement_partner_revised',
    category: 'values',
    subcategory: 'challenges_conflicts',
    type: 'iconChoice',
    depth: 'ADVANCED',
    isRequired: false,
    options: [
      { value: 'discussion_understanding', icon: <MessageCircle /> },
      { value: 'finding_common_ground', icon: <Brain /> },
      { value: 'seeking_compromise', icon: <Scale /> },
      { value: 'agree_to_disagree', icon: <Heart /> },
    ],
    metadata: { estimatedTime: 1 },
  },
  {
    worldId: 'VALUES',
    id: 'values_non_negotiable_for_partner_revised',
    category: 'values',
    subcategory: 'summary_future',
    type: 'openText',
    depth: 'ADVANCED',
    isRequired: false,
    minLength: 30,
    maxLength: 300,
    metadata: { estimatedTime: 2 },
  },
];
--- End of Content for valuesQuestions.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\types\types.ts
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/types/types.ts

// Basic type definitions
export type WorldId =
  | 'VALUES'
  | 'RELATIONSHIP'
  | 'PERSONALITY'
  | 'PARTNER'
  | 'RELIGION';

export type QuestionType =
  | 'singleChoice'
  | 'multiChoice'
  | 'multiSelect'
  | 'openText'
  | 'scale'
  | 'iconChoice'
  | 'budgetAllocation'
  | 'ranking'
  | 'scenario'
  | 'multiSelectWithOther';

export type QuestionDepth = 'BASIC' | 'ADVANCED' | 'EXPERT';

export type AnswerValue = string | number | string[] | number[] | Record<string, number> | { text: string; lang: string } | undefined;

export type AnswerStatus = 'COMPLETE' | 'PARTIAL' | 'SKIPPED';

// --- UPDATED INTERFACES ---

export interface Option {
  value: string; // This is the key for the dictionary
  icon?: React.ReactNode;
  text?: string; // Re-added as optional
  description?: string; // Re-added as optional
  allowFreeText?: boolean;
  placeholder?: string;
}

export interface BudgetCategory {
  value: string; // The key for the dictionary
  label?: string; // Re-added as optional
  icon?: React.ReactNode;
  description?: string; // Re-added as optional
  min?: number;
  max?: number;
}

export interface QuestionMetadata {
  estimatedTime?: number;
  tags?: string[];
  helpText?: string; // Re-added as optional
}

export interface ScaleLabels {
  min: string;
  max: string;
  middle?: string;
}

export interface ScaleDescriptions {
  min?: string;
  max?: string;
  middle?: string;
  [key: number]: string;
}

export interface Question {
  worldId: string;
  id: string;
  category: string;
  subcategory?: string;
  question?: string; // Re-added as optional
  type: QuestionType;
  depth: QuestionDepth;
  isRequired?: boolean;
  options?: Option[];
  placeholder?: string; // Re-added as optional
  description?: string; // Re-added as optional
  minLength?: number;
  maxLength?: number;
  minSelections?: number;
  maxSelections?: number;
  min?: number;
  max?: number;
  step?: number;
  labels?: ScaleLabels;
  scaleDescriptions?: ScaleDescriptions;
  categories?: BudgetCategory[];
  totalPoints?: number;
  metadata?: QuestionMetadata;
  items?: Option[];
  icon?: React.ReactNode;
}

// --- Answer-related interfaces ---

export interface QuestionnaireAnswer {
  questionId: string;
  worldId: WorldId;
  value: AnswerValue;
  answeredAt: string;
  isVisible?: boolean;
  language?: 'en' | 'he'; 
}

export interface Answer extends QuestionnaireAnswer {
  status?: AnswerStatus;
}

// --- Component Props interfaces ---

export interface WorldComponentProps {
  onAnswer: (questionId: string, value: AnswerValue) => void;
  onComplete: () => void;
  onBack: () => void;
  answers: QuestionnaireAnswer[];
  isCompleted?: boolean;
  language?: string;
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
}

export interface AnswerInputProps {
  question: Question;
  value?: AnswerValue;
  onChange?: (value: AnswerValue) => void;
  onClear?: () => void;
  language?: string;
  showValidation?: boolean;
  className?: string;
  validationError?: string;
}

export interface QuestionnaireLayoutProps {
  children: React.ReactNode;
  currentWorld: WorldId;
  completedWorlds: WorldId[];
  onWorldChange: (worldId: WorldId) => void;
  onExit?: () => void;
  language?: string;
  onSaveProgress?: () => Promise<void>;
  isLoggedIn?: boolean;
}

// --- Data storage interfaces ---

export interface QuestionnaireSubmission {
  userId: string;
  answers: QuestionnaireAnswer[];
  worldsCompleted: WorldId[];
  completed: boolean;
  startedAt: string;
  completedAt?: string;
    currentQuestionIndices?: Record<WorldId, number>;
}
--- End of Content for types.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\worlds
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\questionnaire\worlds\WorldComponent.tsx
--------------------------------------------------------------------------------
Content:
// src/components/questionnaire/worlds/WorldComponent.tsx
'use client';

import { CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import QuestionCard from '../common/QuestionCard';
import AnswerInput from '../common/AnswerInput';
import QuestionsList from '../common/QuestionsList';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import {
  ArrowLeft,
  ArrowRight,
  AlertCircle,
  CheckCircle,
  List,
  Loader2,
  ListChecks,
  Sparkles,
  Target,
  Star,
  Award,
  Heart,
  Compass,
} from 'lucide-react';
import { Card } from '@/components/ui/card';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from '@/components/ui/sheet';
import type {
  AnswerValue,
  Question,
  QuestionnaireAnswer,
  WorldId,
} from '../types/types';
import { cn } from '@/lib/utils';
import { useMediaQuery } from '../hooks/useMediaQuery';
import { motion, AnimatePresence } from 'framer-motion';
import type {
  WorldComponentDict,
  QuestionCardDict,
  AnswerInputDict,
  InteractiveScaleDict,
  QuestionsListDict,
  QuestionsDictionary,
} from '@/types/dictionary';

// Questions Imports
import { personalityQuestions } from '../questions/personality/personalityQuestions';
import { valuesQuestions } from '../questions/values/valuesQuestions';
import { relationshipQuestions } from '../questions/relationship/relationshipQuestions';
import { partnerQuestions } from '../questions/partner/partnerQuestions';
import { religionQuestions } from '../questions/religion/religionQuestions';

const worldConfig: Record<
  WorldId,
  {
    questions: Question[];
    themeColor: 'sky' | 'rose' | 'purple' | 'teal' | 'amber';
    icon: React.ReactNode;
    gradient: string;
  }
> = {
  PERSONALITY: {
    questions: personalityQuestions,
    themeColor: 'sky',
    icon: <Sparkles className="w-5 h-5" />,
    gradient: 'from-cyan-400 via-sky-500 to-blue-500',
  },
  VALUES: {
    questions: valuesQuestions,
    themeColor: 'rose',
    icon: <Heart className="w-5 h-5" />,
    gradient: 'from-rose-400 via-pink-500 to-red-500',
  },
  RELATIONSHIP: {
    questions: relationshipQuestions,
    themeColor: 'purple',
    icon: <Target className="w-5 h-5" />,
    gradient: 'from-purple-400 via-violet-500 to-indigo-500',
  },
  PARTNER: {
    questions: partnerQuestions,
    themeColor: 'teal',
    icon: <Star className="w-5 h-5" />,
    gradient: 'from-teal-400 via-emerald-500 to-green-500',
  },
  RELIGION: {
    questions: religionQuestions,
    themeColor: 'amber',
    icon: <Award className="w-5 h-5" />,
    gradient: 'from-amber-400 via-orange-500 to-yellow-500',
  },
};

const getQuestionWithText = (
  questionStructure: Question,
  dict: WorldComponentDynamicProps['dict']
): Question => {
  const qContent =
    dict.questions[questionStructure.worldId as WorldId]?.[
      questionStructure.id
    ];

  if (!qContent) {
    console.error(
      `Missing dictionary entry for question: ${questionStructure.id}`
    );
    return {
      ...questionStructure,
      question: `Error: Missing text for ${questionStructure.id}`,
    };
  }

  const optionsWithText = questionStructure.options?.map((opt) => {
    const optionContent = qContent.options?.[opt.value];
    if (typeof optionContent === 'string') {
      return { ...opt, text: optionContent };
    }
    if (typeof optionContent === 'object' && optionContent !== null) {
      return {
        ...opt,
        text: optionContent.text,
        description: optionContent.description,
      };
    }
    return { ...opt, text: opt.value };
  });

  const categoriesWithText = questionStructure.categories?.map((cat) => {
    const categoryContent = qContent.categories?.[cat.value];
    if (typeof categoryContent === 'string') {
      return { ...cat, label: categoryContent };
    }
    if (typeof categoryContent === 'object' && categoryContent !== null) {
      return {
        ...cat,
        label: categoryContent.label,
        description: categoryContent.description,
      };
    }
    return { ...cat, label: cat.value };
  });

  return {
    ...questionStructure,
    question: qContent.question,
    placeholder: qContent.placeholder,
    metadata: {
      ...questionStructure.metadata,
      helpText: qContent.helpText,
    },
    options: optionsWithText,
    categories: categoriesWithText,
    labels: qContent.labels || questionStructure.labels,
  };
};

interface WorldComponentDynamicProps {
  worldId: WorldId;
  onAnswer: (worldId: WorldId, questionId: string, value: AnswerValue) => void;
  onVisibilityChange: (
    worldId: WorldId,
    questionId: string,
    isVisible: boolean
  ) => void;
  onComplete: () => void;
  onBack: () => void;
  answers: QuestionnaireAnswer[];
  currentQuestionIndex: number;
  setCurrentQuestionIndex: (index: number) => void;
  onSave?: () => void;
  isSaving?: boolean;
  lastSaved?: Date | null;
  isDirectNavigation?: boolean;
  dict: {
    world: WorldComponentDict;
    questionCard: QuestionCardDict;
    answerInput: AnswerInputDict;
    interactiveScale: InteractiveScaleDict;
    questionsList: QuestionsListDict;
    questions: QuestionsDictionary;
    worldLabels: Record<WorldId, string>;
  };
  locale: 'he' | 'en';
  onMobileMenuOpen?: () => void;
}

export default function WorldComponent({
  worldId,
  onAnswer,
  onVisibilityChange,
  onComplete,
  onBack,
  answers,
  currentQuestionIndex,
  setCurrentQuestionIndex,
  onSave,
  isSaving,
  lastSaved,
  isDirectNavigation = false,
  dict,
  locale,
  onMobileMenuOpen,
}: WorldComponentDynamicProps) {
  const worldDict = dict.world;
  const validationDict = worldDict.errors.validation;

  const [validationErrors, setValidationErrors] = useState<
    Record<string, string>
  >({});
  const isDesktop = useMediaQuery('(min-width: 1024px)');
  const [isListVisible, setIsListVisible] = useState(true);
  const isRTL = locale === 'he';
  const [animateError, setAnimateError] = useState(false);
  const [showCelebration, setShowCelebration] = useState(false);
  const [isCompleting, setIsCompleting] = useState(false);

  const {
    questions: allQuestionsStructure,
    themeColor,
    icon,
    gradient,
  } = worldConfig[worldId];

  const allQuestions = useMemo(
    () =>
      allQuestionsStructure.map((qStruct) =>
        getQuestionWithText(qStruct, dict)
      ),
    [allQuestionsStructure, dict]
  );

  const title = dict.worldLabels[worldId];

  const answeredQuestions = allQuestions.filter((q) =>
    answers.find((a) => a.questionId === q.id && a.value !== undefined)
  ).length;
  const requiredAnswered = allQuestions.filter(
    (q) =>
      q.isRequired &&
      answers.find((a) => a.questionId === q.id && a.value !== undefined)
  ).length;
  const totalRequired = allQuestions.filter((q) => q.isRequired).length;

  const remainingTimeMinutes = useMemo(() => {
    let totalMinutes = 0;
    for (let i = currentQuestionIndex; i < allQuestions.length; i++) {
      totalMinutes += allQuestions[i].metadata?.estimatedTime || 1;
    }
    return Math.max(1, Math.round(totalMinutes));
  }, [currentQuestionIndex, allQuestions]);

  useEffect(() => {
    if (currentQuestionIndex < 0) {
      setCurrentQuestionIndex(0);
    } else if (currentQuestionIndex >= allQuestions.length) {
      setCurrentQuestionIndex(allQuestions.length - 1);
    }
  }, [currentQuestionIndex, allQuestions.length, setCurrentQuestionIndex]);

  const handleAnswer = useCallback(
    (value: AnswerValue) => {
      const currentQuestion = allQuestions[currentQuestionIndex];
      onAnswer(worldId, currentQuestion.id, value);

      const newErrors = { ...validationErrors };
      delete newErrors[currentQuestion.id];
      setValidationErrors(newErrors);
    },
    [
      currentQuestionIndex,
      allQuestions,
      worldId,
      onAnswer,
      validationErrors,
      setValidationErrors,
    ]
  );

  const handleNext = useCallback(async () => {
    const currentQuestion = allQuestions[currentQuestionIndex];
    const currentAnswer = answers.find(
      (a) => a.questionId === currentQuestion.id
    );

    if (
      currentQuestion.isRequired &&
      (!currentAnswer?.value ||
        (Array.isArray(currentAnswer.value) &&
          currentAnswer.value.length === 0))
    ) {
      setValidationErrors({
        [currentQuestion.id]: validationDict.required,
      });
      setAnimateError(true);
      setTimeout(() => setAnimateError(false), 500);
      return;
    }

    if (currentQuestionIndex < allQuestions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);

      const progress = Math.round(
        ((currentQuestionIndex + 2) / allQuestions.length) * 100
      );
      if ([25, 50, 75].includes(progress)) {
        setShowCelebration(true);
        setTimeout(() => setShowCelebration(false), 3000);
      }
    } else {
      if (requiredAnswered < totalRequired) {
        setValidationErrors({
          general: validationDict.generalRequired
            .replace('{{current}}', requiredAnswered.toString())
            .replace('{{total}}', totalRequired.toString()),
        });
        setAnimateError(true);
        setTimeout(() => setAnimateError(false), 500);
        return;
      }

      setIsCompleting(true);
      setShowCelebration(true);
      await new Promise((resolve) => setTimeout(resolve, 2000));
      onComplete();
      setIsCompleting(false);
    }
  }, [
    currentQuestionIndex,
    allQuestions,
    answers,
    setCurrentQuestionIndex,
    onComplete,
    validationDict,
    requiredAnswered,
    totalRequired,
  ]);

  const handlePrevious = useCallback(() => {
    if (currentQuestionIndex > 0) {
      setCurrentQuestionIndex(currentQuestionIndex - 1);
    } else {
      onBack();
    }
  }, [currentQuestionIndex, setCurrentQuestionIndex, onBack]);

  const overallProgress = (answeredQuestions / allQuestions.length) * 100;
  const currentQuestion = allQuestions[currentQuestionIndex];
  const currentAnswer = answers.find(
    (a) => a.questionId === currentQuestion?.id
  );

  const renderQuestionCard = () => {
    if (!currentQuestion) {
      return (
        <Card className="rounded-3xl shadow-xl border-2 border-gray-200 p-8">
          <div className="text-center text-gray-500">
            <AlertCircle className="w-12 h-12 mx-auto mb-4" />
            <p>{worldDict.errors.noQuestionFound}</p>
          </div>
        </Card>
      );
    }

    return (
      <motion.div
        key={currentQuestion.id}
        initial={{ opacity: 0, x: isRTL ? -50 : 50 }}
        animate={{
          opacity: 1,
          x: 0,
          scale: animateError ? [1, 1.02, 1] : 1,
        }}
        exit={{ opacity: 0, x: isRTL ? 50 : -50 }}
        transition={{ duration: 0.3 }}
      >
        <QuestionCard
          question={currentQuestion}
          depth={currentQuestion.depth}
          isRequired={currentQuestion.isRequired}
          validationError={validationErrors[currentQuestion.id]}
          locale={locale}
          themeColor={themeColor}
          isVisible={currentAnswer?.isVisible ?? true}
          onVisibilityChange={(isVisible) =>
            onVisibilityChange(worldId, currentQuestion.id, isVisible)
          }
          dict={dict.questionCard}
          currentQuestionNumber={currentQuestionIndex + 1}
          totalQuestions={allQuestions.length}
          estimatedTimeMinutes={remainingTimeMinutes}
        >
          <AnswerInput
            question={currentQuestion}
            value={currentAnswer?.value}
            onChange={handleAnswer}
            locale={locale}
            themeColor={themeColor}
            dict={{
              answerInput: dict.answerInput,
              interactiveScale: dict.interactiveScale,
            }}
          />
          {validationErrors[currentQuestion.id] && (
            <motion.div
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              className="mt-4 p-4 bg-red-50 border-2 border-red-200 rounded-2xl"
            >
              <div className="flex items-center gap-3">
                <AlertCircle className="h-5 w-5 text-red-600 flex-shrink-0" />
                <p className="text-sm font-medium text-red-800">
                  {validationErrors[currentQuestion.id]}
                </p>
              </div>
            </motion.div>
          )}
        </QuestionCard>
      </motion.div>
    );
  };

  const renderNavigationButtons = () => {
    const PrevIcon = isRTL ? ArrowRight : ArrowLeft;
    const NextIcon = isRTL ? ArrowLeft : ArrowRight;

    if (isDesktop) {
      return (
        <motion.div
          className="flex items-center justify-between gap-4 mt-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
        >
          <Button
            variant="outline"
            onClick={handlePrevious}
            className="flex items-center gap-3 rounded-2xl px-6 py-6 text-base font-semibold border-2 hover:bg-gray-50 transition-all duration-300"
          >
            <PrevIcon className="h-5 w-5" />
            <span>
              {currentQuestionIndex === 0
                ? worldDict.buttons.backToMap
                : worldDict.buttons.previous}
            </span>
          </Button>

          {currentQuestionIndex < allQuestions.length - 1 ? (
            <Button
              variant="default"
              onClick={handleNext}
              className={cn(
                'flex items-center gap-3 rounded-2xl px-8 py-6 text-base font-bold shadow-lg',
                'bg-gradient-to-r text-white hover:opacity-90 transition-all duration-300',
                gradient
              )}
            >
              <span>{worldDict.buttons.next}</span>
              <NextIcon className="h-5 w-5" />
            </Button>
          ) : (
            <Button
              onClick={handleNext}
              disabled={isCompleting}
              className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white flex items-center gap-3 rounded-2xl px-8 py-6 text-base font-bold shadow-lg transition-all duration-300 disabled:opacity-70 disabled:cursor-not-allowed"
            >
              {isCompleting ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin" />
                  <span>{worldDict.buttons.completing}</span>
                </>
              ) : (
                <>
                  <span>{worldDict.buttons.finish}</span>
                  <CheckCircle className="h-5 w-5" />
                </>
              )}
            </Button>
          )}
        </motion.div>
      );
    }

    // Mobile buttons
    return (
      <motion.div
        className="fixed bottom-4 left-0 right-0 z-40 px-4"
        initial={{ opacity: 0, y: 100 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3, type: 'spring', stiffness: 100 }}
      >
        <div className="max-w-2xl mx-auto flex items-center justify-between gap-3">
          <Button
            variant="outline"
            onClick={handlePrevious}
            className="flex items-center gap-2 rounded-full px-5 py-6 bg-white/95 backdrop-blur-sm border-2 shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300"
          >
            <PrevIcon className="h-5 w-5" />
            <span className="font-semibold text-sm">
              {currentQuestionIndex === 0
                ? worldDict.buttons.backToMap
                : worldDict.buttons.prevShort}
            </span>
          </Button>

          <div className="flex items-center gap-2 px-4 py-3 bg-white/95 backdrop-blur-sm rounded-full border-2 border-gray-200 shadow-lg">
            <span className="text-xs font-bold text-gray-600">
              {currentQuestionIndex + 1}/{allQuestions.length}
            </span>
          </div>

          {currentQuestionIndex < allQuestions.length - 1 ? (
            <Button
              onClick={handleNext}
              className={cn(
                'flex items-center gap-2 rounded-full px-5 py-6 font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300',
                'bg-gradient-to-r text-white',
                gradient
              )}
            >
              <span className="text-sm">{worldDict.buttons.nextShort}</span>
              <NextIcon className="h-5 w-5" />
            </Button>
          ) : (
            <Button
              onClick={handleNext}
              disabled={isCompleting}
              className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white flex items-center gap-2 rounded-full px-5 py-6 font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 disabled:opacity-70 disabled:scale-100"
            >
              {isCompleting ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin" />
                  <span className="text-sm">
                    {worldDict.buttons.completing}
                  </span>
                </>
              ) : (
                <>
                  <span className="text-sm">
                    {worldDict.buttons.finishShort}
                  </span>
                  <CheckCircle className="h-5 w-5" />
                </>
              )}
            </Button>
          )}
        </div>
      </motion.div>
    );
  };

  const renderCelebration = () => {
    if (!showCelebration) return null;

    const progressPercent = Math.round(
      (answeredQuestions / allQuestions.length) * 100
    );
    let message = '';
    if (progressPercent === 25) message = worldDict.celebration.quarter;
    else if (progressPercent === 50) message = worldDict.celebration.half;
    else if (progressPercent === 75)
      message = worldDict.celebration.threeQuarters;
    else if (progressPercent >= 100) message = worldDict.celebration.complete;

    if (!message) return null;

    return (
      <AnimatePresence>
        <motion.div
          initial={{ opacity: 0, scale: 0.8, y: 50 }}
          animate={{ opacity: 1, scale: 1, y: 0 }}
          exit={{ opacity: 0, scale: 0.8, y: 50 }}
          className={cn(
            'fixed left-1/2 transform -translate-x-1/2 z-50',
            isDesktop ? 'bottom-8' : 'bottom-24'
          )}
        >
          <div
            className={cn(
              'bg-gradient-to-r text-white px-8 py-4 rounded-full shadow-2xl border-4 border-white',
              gradient
            )}
          >
            <p className="text-xl font-bold text-center">{message}</p>
          </div>
        </motion.div>
      </AnimatePresence>
    );
  };

  const MobileWorldHeader = () => {
    const formatLastSaved = (date: Date | null) => {
      if (!date) return null;
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) {
        return worldDict.header.lastSaved.now;
      } else if (diffMins === 1) {
        return worldDict.header.lastSaved.minuteAgo;
      } else if (diffMins < 60) {
        return worldDict.header.lastSaved.minutesAgo.replace(
          '{{count}}',
          diffMins.toString()
        );
      } else {
        const diffHours = Math.floor(diffMins / 60);
        return worldDict.header.lastSaved.hoursAgo.replace(
          '{{count}}',
          diffHours.toString()
        );
      }
    };

    const lastSavedText = formatLastSaved(lastSaved || null);

    return (
      <div className="bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-lg border-2 border-white mb-6">
        <div className="flex items-center justify-between gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={onMobileMenuOpen}
            className="p-2.5 bg-white border-2 border-gray-300 rounded-xl flex-shrink-0 transition-all duration-200 hover:scale-105 hover:bg-gray-50 hover:border-gray-400 shadow-sm"
          >
            <Compass className="h-5 w-5 text-gray-700" />
          </Button>

          <div className="flex items-center gap-2 flex-1 min-w-0">
            <div
              className={cn(
                'p-2 rounded-xl bg-gradient-to-br text-white flex-shrink-0',
                gradient
              )}
            >
              {icon}
            </div>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2">
                <h2 className="font-bold text-base text-gray-800 truncate">
                  {title}
                </h2>
                {(isSaving || lastSavedText) && (
                  <div className="flex items-center gap-1">
                    {isSaving ? (
                      <>
                        <Loader2 className="h-3 w-3 text-blue-500 animate-spin" />
                        <span className="text-xs text-blue-600 font-medium whitespace-nowrap">
                          {worldDict.buttons.saving}
                        </span>
                      </>
                    ) : lastSavedText ? (
                      <>
                        <CheckCircle className="h-3 w-3 text-green-500" />
                        <span className="text-xs text-green-600 font-medium whitespace-nowrap">
                          {lastSavedText}
                        </span>
                      </>
                    ) : null}
                  </div>
                )}
              </div>
              <span className="text-xs text-gray-500 font-medium">
                {worldDict.header.questionLabel
                  .replace('{{current}}', (currentQuestionIndex + 1).toString())
                  .replace('{{total}}', allQuestions.length.toString())}
              </span>
            </div>
          </div>

          <Sheet>
            <SheetTrigger asChild>
              <Button
                variant="outline"
                size="sm"
                className="gap-1.5 font-medium rounded-xl flex-shrink-0 px-2 sm:px-3 transition-all duration-200 hover:scale-105"
              >
                <List className="h-4 w-4" />
                <span className="hidden sm:inline">
                  {worldDict.buttons.questionList}
                </span>
              </Button>
            </SheetTrigger>
            <SheetContent
              side={isRTL ? 'left' : 'right'}
              className="w-[300px] sm:w-[400px] flex flex-col p-0"
            >
              <SheetHeader className="p-4 border-b">
                <SheetTitle>
                  <div className="flex items-center gap-3">
                    <div
                      className={cn(
                        'p-2 rounded-lg bg-gradient-to-br text-white',
                        gradient
                      )}
                    >
                      <ListChecks className="h-5 w-5" />
                    </div>
                    <span className="text-lg">
                      {worldDict.listSheet.title.replace(
                        '{{worldTitle}}',
                        title
                      )}
                    </span>
                  </div>
                </SheetTitle>
              </SheetHeader>
              <div className="flex-1 overflow-hidden">
                <QuestionsList
                  allQuestions={allQuestions}
                  currentQuestionIndex={currentQuestionIndex}
                  setCurrentQuestionIndex={setCurrentQuestionIndex}
                  answers={answers}
                  locale={locale}
                  themeColor={themeColor}
                  className="h-full"
                  dict={dict.questionsList}
                />
              </div>
            </SheetContent>
          </Sheet>
        </div>

        <div className="mt-3 space-y-1">
          <div className="flex justify-between text-xs font-medium">
            <span className="text-gray-600">
              {worldDict.header.overallProgress}
            </span>
            <span className={cn('font-bold', `text-${themeColor}-600`)}>
              {Math.round(overallProgress)}%
            </span>
          </div>
          <Progress
            value={overallProgress}
            className="h-2"
            indicatorClassName={cn('bg-gradient-to-r', gradient)}
          />
        </div>
      </div>
    );
  };

  if (isDesktop) {
    return (
      <div className="w-full" dir={isRTL ? 'rtl' : 'ltr'}>
        <div
          className={cn(
            'transition-all duration-500 ease-in-out',
            isListVisible ? 'grid grid-cols-12 gap-8' : 'flex justify-center'
          )}
        >
          <div
            className={cn(
              'space-y-6',
              isListVisible
                ? 'col-span-12 lg:col-span-7 xl:col-span-8'
                : 'w-full max-w-5xl mx-auto'
            )}
          >
            {renderQuestionCard()}
            {renderNavigationButtons()}
          </div>

          <AnimatePresence>
            {isListVisible && (
              <motion.div
                className="col-span-12 lg:col-span-5 xl:col-span-4"
                initial={{ opacity: 0, width: 0 }}
                animate={{ opacity: 1, width: 'auto' }}
                exit={{ opacity: 0, width: 0 }}
                transition={{ duration: 0.4, ease: 'easeInOut' }}
              >
                <div className="sticky top-8">
                  <Card className="rounded-3xl shadow-2xl border-2 border-white overflow-hidden h-[calc(100vh-4rem)]">
                    <div className={cn('h-2 bg-gradient-to-r', gradient)} />
                    <CardHeader
                      className={cn(
                        'pb-4 pt-6 border-b-2 bg-gradient-to-br',
                        `from-${themeColor}-50/50 to-${themeColor}-50/30`
                      )}
                    >
                      <CardTitle className="text-xl font-bold flex items-center gap-3 text-gray-800">
                        <div
                          className={cn(
                            'p-2 rounded-xl bg-gradient-to-br text-white',
                            gradient
                          )}
                        >
                          <ListChecks className="h-5 w-5" />
                        </div>
                        <span>
                          {worldDict.listSheet.title.replace(
                            '{{worldTitle}}',
                            title
                          )}
                        </span>
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="p-2 overflow-hidden h-[calc(100%-100px)]">
                      <QuestionsList
                        allQuestions={allQuestions}
                        currentQuestionIndex={currentQuestionIndex}
                        setCurrentQuestionIndex={setCurrentQuestionIndex}
                        answers={answers}
                        locale={locale}
                        themeColor={themeColor}
                        className="h-full"
                        dict={dict.questionsList}
                      />
                    </CardContent>
                  </Card>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
        {renderCelebration()}
      </div>
    );
  } else {
    // Mobile view
    return (
      <div
        className="max-w-2xl mx-auto p-2 sm:p-4 space-y-6 pb-32 min-h-screen"
        dir={isRTL ? 'rtl' : 'ltr'}
      >
        <MobileWorldHeader />
        {renderQuestionCard()}
        {renderNavigationButtons()}
        {renderCelebration()}
      </div>
    );
  }
}
--- End of Content for WorldComponent.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\MatchSuggestionsContainer.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/MatchSuggestionsContainer.tsx

'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { useParams } from 'next/navigation';

import {
  History,
  AlertCircle,
  RefreshCw,
  Bell,
  CheckCircle,
  Target,
  Sparkles,
  Heart,
  Zap,
  XCircle,
  Loader2,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';
import type { MatchSuggestion } from '@prisma/client';

import SuggestionsList from './list/SuggestionsList';
import type { ExtendedMatchSuggestion } from './types';
import { cn } from '@/lib/utils';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';

import type {
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary';

// --- Skeleton Loading Updated to Hero Colors (Teal/Orange) ---
const LoadingSkeleton: React.FC<{
  dict: SuggestionsDictionary['container']['loading'];
}> = ({ dict }) => (
  <div className="min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/20 to-orange-50/20">
    <div className="container mx-auto px-4 py-8">
      {/* Hero Skeleton */}
      <div className="mb-8">
        <div className="text-center mb-8">
          <div className="inline-flex items-center gap-3 mb-4">
            <div className="p-3 rounded-full bg-gradient-to-r from-teal-100 to-orange-100 animate-pulse">
              <div className="w-8 h-8 bg-gray-300 rounded-full animate-pulse"></div>
            </div>
          </div>
          <div className="space-y-4">
            <div className="h-12 bg-gradient-to-r from-gray-200 to-gray-300 rounded-2xl mx-auto w-80 animate-pulse"></div>
            <div className="h-6 bg-gray-200 rounded-xl mx-auto w-96 animate-pulse"></div>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {Array.from({ length: 3 }).map((_, index) => (
            <div
              key={index}
              className="border-0 shadow-lg overflow-hidden bg-white rounded-2xl animate-pulse"
            >
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <div className="p-3 rounded-xl bg-gray-200 w-12 h-12"></div>
                  <div className="text-right">
                    <div className="w-16 h-8 bg-gray-200 rounded-lg mb-2"></div>
                  </div>
                </div>
                <div className="space-y-2">
                  <div className="h-6 bg-gray-200 rounded-lg w-3/4"></div>
                  <div className="h-4 bg-gray-200 rounded-lg w-1/2"></div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Main Card Skeleton */}
      <div className="shadow-2xl border-0 bg-white/95 backdrop-blur-sm overflow-hidden rounded-3xl">
        <div className="px-8 py-6 bg-gradient-to-r from-teal-50/80 via-white to-orange-50/30 border-b border-gray-100">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gray-200 rounded-full animate-pulse"></div>
            </div>
            <div className="h-6 bg-gray-200 rounded-lg w-32 animate-pulse"></div>
            <div className="w-16 h-4"></div>
          </div>
        </div>

        <div className="p-6">
          <div className="flex justify-center mb-6">
            <div className="grid grid-cols-3 bg-teal-50/50 rounded-2xl p-1 h-14 w-fit gap-2">
              {Array.from({ length: 3 }).map((_, index) => (
                <div
                  key={index}
                  className="px-6 py-3 rounded-xl bg-gray-200 animate-pulse w-24 h-10"
                ></div>
              ))}
            </div>
          </div>

          <div className="flex flex-col items-center justify-center min-h-[400px] text-center space-y-6">
            <div className="relative">
              <div className="w-24 h-24 rounded-full bg-gradient-to-br from-teal-100 via-orange-100 to-rose-100 animate-pulse border-4 border-white shadow-xl"></div>
              <div className="absolute inset-0 flex items-center justify-center">
                <Loader2 className="w-12 h-12 text-teal-600 animate-spin" />
              </div>
              <div className="absolute inset-0 rounded-full bg-gradient-to-r from-teal-400 via-orange-400 to-rose-400 opacity-20 animate-ping"></div>
            </div>

            <div className="space-y-3">
              <h3 className="text-2xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-rose-600 bg-clip-text text-transparent">
                {dict.title}
              </h3>
              <p className="text-gray-600 max-w-md leading-relaxed">
                {dict.subtitle}
              </p>
            </div>

            <div className="flex items-center gap-2">
              {Array.from({ length: 3 }).map((_, index) => (
                <div
                  key={index}
                  className="w-3 h-3 rounded-full bg-gradient-to-r from-teal-500 to-orange-500 animate-bounce"
                  style={{ animationDelay: `${index * 0.2}s` }}
                ></div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
);

// --- Stats Component Updated to Hero Colors ---
const WelcomeStats: React.FC<{
  activeSuggestions: ExtendedMatchSuggestion[];
  historySuggestions: ExtendedMatchSuggestion[];
  userId: string;
  dict: SuggestionsDictionary['container']['stats'];
}> = ({ activeSuggestions, historySuggestions, userId, dict }) => {
  const approvedCount = [...activeSuggestions, ...historySuggestions].filter(
    (s) =>
      s.status === 'FIRST_PARTY_APPROVED' ||
      s.status === 'SECOND_PARTY_APPROVED'
  ).length;

  const myTurnCount = activeSuggestions.filter((s) => {
    const isFirstParty = s.firstPartyId === userId;
    return (
      (s.status === 'PENDING_FIRST_PARTY' && isFirstParty) ||
      (s.status === 'PENDING_SECOND_PARTY' && !isFirstParty)
    );
  }).length;

  const stats = [
    {
      label: dict.new,
      value: activeSuggestions.length,
      icon: <Sparkles className="w-5 h-5" />,
      // Teal/Emerald -> New/Fresh (Knowledge)
      color: 'from-teal-400 via-teal-500 to-emerald-500',
      description: dict.newDesc,
    },
    {
      label: dict.yourTurn,
      value: myTurnCount,
      icon: <Zap className="w-5 h-5" />,
      // Orange/Amber -> Action/Warmth (Privacy/Focus)
      color: 'from-orange-400 via-amber-500 to-yellow-500',
      description: dict.yourTurnDesc,
      pulse: myTurnCount > 0,
    },
    {
      label: dict.approved,
      value: approvedCount,
      icon: <Heart className="w-5 h-5" />, // Changed to Heart to match Rose
      // Rose/Pink -> Love/Connection (Personal)
      color: 'from-rose-400 via-pink-500 to-red-500',
      description: dict.approvedDesc,
    },
  ];

  return (
    <div className="mb-8">
      <div className="text-center mb-8">
        <div className="inline-flex items-center gap-3 mb-4">
          <div className="p-3 rounded-full bg-gradient-to-r from-teal-100 to-orange-100">
            <Target className="w-8 h-8 text-teal-600" />
          </div>
        </div>
        <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-amber-600 bg-clip-text text-transparent mb-3">
          {dict.title}
        </h1>
        <p className="text-lg text-gray-600 max-w-2xl mx-auto">
          {dict.subtitle}
        </p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {stats.map((stat, index) => (
          <Card
            key={index}
            className="border-0 shadow-lg overflow-hidden bg-white hover:shadow-xl transition-all duration-300 group"
          >
            <CardContent className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div
                  className={cn(
                    'p-3 rounded-xl bg-gradient-to-br text-white shadow-lg group-hover:scale-110 transition-transform duration-300',
                    stat.color,
                    stat.pulse && 'animate-pulse'
                  )}
                >
                  {stat.icon}
                </div>
                <div className="text-right">
                  <div
                    className={cn(
                      'text-3xl font-bold text-gray-900',
                      stat.pulse && 'animate-bounce'
                    )}
                  >
                    {stat.value}
                  </div>
                </div>
              </div>
              <div className="space-y-1">
                <h3 className="font-bold text-lg text-gray-800">
                  {stat.label}
                </h3>
                <p className="text-sm text-gray-600">{stat.description}</p>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
};

interface MatchSuggestionsContainerProps {
  userId: string;
  className?: string;
  suggestionsDict: SuggestionsDictionary;
  profileCardDict: ProfileCardDict;
}

// --- Main Container Updated ---
const MatchSuggestionsContainer: React.FC<MatchSuggestionsContainerProps> = ({
  userId,
  className,
  suggestionsDict,
  profileCardDict,
}) => {
  const params = useParams();
  const locale = (
    Array.isArray(params.lang) ? params.lang[0] : params.lang || 'en'
  ) as 'he' | 'en';

  const [activeSuggestions, setActiveSuggestions] = useState<
    ExtendedMatchSuggestion[]
  >([]);
  const [historySuggestions, setHistorySuggestions] = useState<
    ExtendedMatchSuggestion[]
  >([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState('active');
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [hasNewSuggestions, setHasNewSuggestions] = useState(false);
  const [isUserInActiveProcess, setIsUserInActiveProcess] = useState(false);

  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [suggestionForAction, setSuggestionForAction] =
    useState<ExtendedMatchSuggestion | null>(null);
  const [actionType, setActionType] = useState<'approve' | 'decline' | null>(
    null
  );

  const myTurnCount = activeSuggestions.filter((s) => {
    const isFirstParty = s.firstPartyId === userId;
    return (
      (s.status === 'PENDING_FIRST_PARTY' && isFirstParty) ||
      (s.status === 'PENDING_SECOND_PARTY' && !isFirstParty)
    );
  }).length;

  const fetchSuggestions = useCallback(
    async (showLoadingState = true) => {
      try {
        if (showLoadingState) {
          setIsLoading(true);
        } else {
          setIsRefreshing(true);
        }
        setError(null);

        const [activeResponse, historyResponse] = await Promise.all([
          fetch(`/api/suggestions/active`),
          fetch(`/api/suggestions/history`),
        ]);

        if (!activeResponse.ok || !historyResponse.ok) {
          throw new Error('Failed to fetch suggestions');
        }

        const activeData = await activeResponse.json();
        const historyData = await historyResponse.json();

        if (
          !showLoadingState &&
          activeData.suggestions.length > activeSuggestions.length
        ) {
          setHasNewSuggestions(true);
          toast.success(suggestionsDict.container.toasts.newSuggestionsTitle, {
            description:
              suggestionsDict.container.toasts.newSuggestionsDescription,
            duration: 5000,
          });
        }

        setActiveSuggestions(activeData.suggestions);
        setHistorySuggestions(historyData.suggestions);
      } catch (error) {
        const errorMessage =
          error instanceof Error
            ? error.message
            : suggestionsDict.container.main.unknownError;
        setError(
          suggestionsDict.container.main.errorLoading.replace(
            '{error}',
            errorMessage
          )
        );
        toast.error(suggestionsDict.container.toasts.errorTitle, {
          description: suggestionsDict.container.toasts.errorDescription,
        });
      } finally {
        setIsLoading(false);
        setIsRefreshing(false);
      }
    },
    [activeSuggestions.length, suggestionsDict]
  );

  const handleStatusChange = useCallback(
    async (suggestionId: string, newStatus: string, notes?: string) => {
      try {
        const response = await fetch(
          `/api/suggestions/${suggestionId}/status`,
          {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus, notes }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            errorData.error || 'Failed to update suggestion status'
          );
        }

        await fetchSuggestions(false);

        const statusMessages: Record<string, string> = {
          FIRST_PARTY_APPROVED:
            suggestionsDict.container.toasts.approvedSuccess,
          SECOND_PARTY_APPROVED:
            suggestionsDict.container.toasts.approvedSuccess,
          FIRST_PARTY_DECLINED:
            suggestionsDict.container.toasts.declinedSuccess,
          SECOND_PARTY_DECLINED:
            suggestionsDict.container.toasts.declinedSuccess,
        };

        let description: string;
        if (newStatus === 'FIRST_PARTY_APPROVED') {
          description = suggestionsDict.container.toasts.approvedFirstPartyDesc;
        } else if (newStatus === 'SECOND_PARTY_APPROVED') {
          description =
            suggestionsDict.container.toasts.approvedSecondPartyDesc;
        } else if (newStatus.includes('DECLINED')) {
          description = suggestionsDict.container.toasts.declinedDesc;
        } else {
          description = suggestionsDict.container.toasts.matchmakerNotified;
        }

        toast.success(
          statusMessages[newStatus] ||
            suggestionsDict.container.toasts.statusUpdateSuccess,
          { description }
        );
      } catch (error) {
        const errorMessage =
          error instanceof Error
            ? error.message
            : suggestionsDict.container.main.unknownError;
        toast.error(
          suggestionsDict.container.toasts.statusUpdateError.replace(
            '{error}',
            errorMessage
          )
        );
      }
    },
    [fetchSuggestions, suggestionsDict]
  );

  const handleRequestAction = useCallback(
    (suggestion: ExtendedMatchSuggestion, action: 'approve' | 'decline') => {
      setSuggestionForAction(suggestion);
      setActionType(action);
      setShowConfirmDialog(true);
    },
    []
  );

  const handleConfirmAction = useCallback(async () => {
    if (!suggestionForAction || !actionType) return;

    const isFirstParty = suggestionForAction.firstPartyId === userId;
    let newStatus = '';
    if (actionType === 'approve') {
      newStatus = isFirstParty
        ? 'FIRST_PARTY_APPROVED'
        : 'SECOND_PARTY_APPROVED';
    } else {
      newStatus = isFirstParty
        ? 'FIRST_PARTY_DECLINED'
        : 'SECOND_PARTY_DECLINED';
    }

    await handleStatusChange(suggestionForAction.id, newStatus);

    setShowConfirmDialog(false);
    setSuggestionForAction(null);
    setActionType(null);
  }, [suggestionForAction, actionType, userId, handleStatusChange]);

  useEffect(() => {
    fetchSuggestions();
    const intervalId = setInterval(
      () => fetchSuggestions(false),
      5 * 60 * 1000
    );
    return () => clearInterval(intervalId);
  }, [userId, fetchSuggestions]);

  useEffect(() => {
    const activeProcessStatuses: MatchSuggestion['status'][] = [
      'FIRST_PARTY_APPROVED',
      'SECOND_PARTY_APPROVED',
      'AWAITING_MATCHMAKER_APPROVAL',
      'CONTACT_DETAILS_SHARED',
      'AWAITING_FIRST_DATE_FEEDBACK',
      'THINKING_AFTER_DATE',
      'PROCEEDING_TO_SECOND_DATE',
      'MEETING_PENDING',
      'MEETING_SCHEDULED',
      'MATCH_APPROVED',
      'DATING',
      'ENGAGED',
    ];
    const hasActiveProcess = activeSuggestions.some((s) =>
      activeProcessStatuses.includes(s.status)
    );
    setIsUserInActiveProcess(hasActiveProcess);
  }, [activeSuggestions]);

  useEffect(() => {
    if (activeTab === 'active') {
      setHasNewSuggestions(false);
    }
  }, [activeTab]);

  const handleRefresh = useCallback(async () => {
    await fetchSuggestions(false);
    toast.success(suggestionsDict.container.toasts.refreshSuccessTitle, {
      description: suggestionsDict.container.toasts.refreshSuccessDescription,
    });
  }, [fetchSuggestions, suggestionsDict]);

  if (isLoading) {
    return <LoadingSkeleton dict={suggestionsDict.container.loading} />;
  }

  return (
    <div
      className={cn(
        // Updated Background to match Hero
        'min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/20 to-orange-50/20',
        className
      )}
      dir={locale === 'he' ? 'rtl' : 'ltr'}
    >
      <div className="container mx-auto px-4 py-8">
        <WelcomeStats
          activeSuggestions={activeSuggestions}
          historySuggestions={historySuggestions}
          userId={userId}
          dict={suggestionsDict.container.stats}
        />
        <Card className="shadow-2xl border-0 bg-white/95 backdrop-blur-sm overflow-hidden">
          <CardHeader className="pb-4 bg-gradient-to-r from-white via-teal-50/30 to-orange-50/30 border-b border-gray-100">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={handleRefresh}
                  disabled={isRefreshing}
                  className="rounded-full h-10 w-10 hover:bg-teal-100 transition-colors"
                  aria-label={suggestionsDict.container.main.refreshAriaLabel}
                >
                  <RefreshCw
                    className={cn(
                      'h-5 w-5 text-teal-600',
                      isRefreshing && 'animate-spin'
                    )}
                  />
                </Button>
                {hasNewSuggestions && (
                  <Badge className="bg-gradient-to-r from-orange-500 to-amber-500 text-white border-0 shadow-xl animate-pulse">
                    <Bell
                      className={cn(
                        'w-3 h-3',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                    {suggestionsDict.container.main.newSuggestions}
                  </Badge>
                )}
              </div>
              <div className="text-center flex-grow">
                <CardTitle className="text-xl font-bold text-gray-800">
                  {suggestionsDict.container.main.title}
                </CardTitle>
              </div>
              <div className="w-16"></div>
            </div>
          </CardHeader>
          <CardContent className="p-6">
            <Tabs
              value={activeTab}
              onValueChange={setActiveTab}
              dir={locale === 'he' ? 'rtl' : 'ltr'}
              className="space-y-6"
            >
              <div className="flex justify-center">
                <TabsList className="grid grid-cols-3 bg-teal-50/50 rounded-2xl p-1 h-14 w-fit">
                  {/* Tab: Active (Teal) */}
                  <TabsTrigger
                    value="active"
                    className="relative flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                  >
                    <Target className="w-5 h-5 text-teal-500" />
                    <span className="group-data-[state=active]:text-teal-700">
                      {suggestionsDict.container.main.tabs.active}
                    </span>
                    {activeSuggestions.length > 0 && (
                      <Badge className="bg-teal-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6">
                        {activeSuggestions.length}
                      </Badge>
                    )}
                  </TabsTrigger>

                  {/* Tab: Urgent (Orange) */}
                  {myTurnCount > 0 && (
                    <TabsTrigger
                      value="urgent"
                      className="flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                    >
                      <Zap className="w-5 h-5 text-orange-500" />
                      <span className="group-data-[state=active]:text-orange-700">
                        {suggestionsDict.container.main.tabs.urgent}
                      </span>
                      <Badge className="bg-gradient-to-r from-orange-500 to-amber-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6 animate-pulse shadow-lg">
                        {myTurnCount}
                      </Badge>
                    </TabsTrigger>
                  )}

                  {/* Tab: History (Gray/Rose) */}
                  <TabsTrigger
                    value="history"
                    className="flex items-center gap-3 px-6 py-3 rounded-xl transition-all data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold text-base"
                  >
                    <History className="w-5 h-5 text-gray-500" />
                    <span>{suggestionsDict.container.main.tabs.history}</span>
                    {historySuggestions.length > 0 && (
                      <Badge className="bg-gray-500 text-white border-0 px-2 py-1 text-xs font-bold rounded-full min-w-[24px] h-6">
                        {historySuggestions.length}
                      </Badge>
                    )}
                  </TabsTrigger>
                </TabsList>
              </div>
              {error && (
                <Alert
                  variant="destructive"
                  className="border-red-200 bg-red-50"
                  dir={locale === 'he' ? 'rtl' : 'ltr'}
                >
                  <AlertCircle
                    className={cn('h-5 w-5', locale === 'he' ? 'ml-2' : 'mr-2')}
                  />
                  <AlertDescription className="text-red-800 font-medium">
                    {error}
                  </AlertDescription>
                </Alert>
              )}
              <TabsContent value="active" className="space-y-6">
                <SuggestionsList
                  locale={locale}
                  suggestions={activeSuggestions}
                  userId={userId}
                  viewMode={viewMode}
                  isLoading={isRefreshing}
                  onStatusChange={handleStatusChange}
                  onActionRequest={handleRequestAction}
                  onRefresh={handleRefresh}
                  isUserInActiveProcess={isUserInActiveProcess}
                  suggestionsDict={suggestionsDict}
                  profileCardDict={profileCardDict}
                />
              </TabsContent>
              <TabsContent value="history" className="space-y-6">
                <SuggestionsList
                  locale={locale}
                  suggestions={historySuggestions}
                  userId={userId}
                  viewMode={viewMode}
                  isLoading={isRefreshing}
                  isHistory={true}
                  onStatusChange={handleStatusChange}
                  onActionRequest={handleRequestAction}
                  onRefresh={handleRefresh}
                  isUserInActiveProcess={isUserInActiveProcess}
                  suggestionsDict={suggestionsDict}
                  profileCardDict={profileCardDict}
                />
              </TabsContent>
              <TabsContent value="urgent" className="space-y-6">
                <SuggestionsList
                  locale={locale}
                  suggestions={activeSuggestions.filter((s) => {
                    const isFirstParty = s.firstPartyId === userId;
                    return (
                      (s.status === 'PENDING_FIRST_PARTY' && isFirstParty) ||
                      (s.status === 'PENDING_SECOND_PARTY' && !isFirstParty)
                    );
                  })}
                  userId={userId}
                  viewMode={viewMode}
                  isLoading={isRefreshing}
                  onStatusChange={handleStatusChange}
                  onActionRequest={handleRequestAction}
                  onRefresh={handleRefresh}
                  isUserInActiveProcess={isUserInActiveProcess}
                  suggestionsDict={suggestionsDict}
                  profileCardDict={profileCardDict}
                />
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
      </div>
      <AlertDialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>
        <AlertDialogContent className="border-0 shadow-2xl rounded-2xl z-[9999]">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-xl font-bold text-center">
              {actionType === 'approve'
                ? suggestionsDict.container.dialogs.approveTitle
                : suggestionsDict.container.dialogs.declineTitle}
            </AlertDialogTitle>
            <AlertDialogDescription className="text-center text-gray-600 leading-relaxed">
              {actionType === 'approve'
                ? suggestionsDict.container.dialogs.approveDescription
                : suggestionsDict.container.dialogs.declineDescription}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-3">
            <AlertDialogCancel className="rounded-xl">
              {suggestionsDict.container.dialogs.cancel}
            </AlertDialogCancel>
            <AlertDialogAction
              onClick={handleConfirmAction}
              className={cn(
                'rounded-xl font-medium shadow-lg hover:shadow-xl transition-all duration-300',
                actionType === 'approve'
                  ? // Approve: Teal/Green gradient
                    'bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700'
                  : // Decline: Rose/Red gradient
                    'bg-gradient-to-r from-rose-500 to-red-600 hover:from-rose-600 hover:to-red-700'
              )}
            >
              {actionType === 'approve' ? (
                <>
                  <CheckCircle
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                  />
                  {suggestionsDict.container.dialogs.confirmApproval}
                </>
              ) : (
                <>
                  <XCircle
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                  />
                  {suggestionsDict.container.dialogs.confirmDecline}
                </>
              )}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default MatchSuggestionsContainer;
--- End of Content for MatchSuggestionsContainer.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\types.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/suggestions/types.ts

import type {
  MatchSuggestion,
  Profile as PrismaProfile, // שינינו את השם כדי למנוע התנגשות
  User,
  UserImage,
  QuestionnaireResponse as PrismaQuestionnaireResponse,
  TestimonialStatus, // ייבוא הטיפוסים הנדרשים
  SubmissionSource,   // ייבוא הטיפוסים הנדרשים
} from '@prisma/client';
import { QuestionnaireResponse as CustomQuestionnaireResponse } from '@/types/next-auth';

// 1. הגדרת טיפוס עבור המלצת חבר בודדת
export interface FriendTestimonial {
  id: string;
  authorName: string;
  relationship: string;
  content: string;
  authorPhone?: string | null;
  isPhoneVisibleToMatch: boolean;
  status: TestimonialStatus;
  submittedBy: SubmissionSource;
  createdAt: Date;
}

// 2. הגדרת הטיפוס UserProfile כך שירחיב את הטיפוס של פריזמה ויוסיף את ההמלצות
export interface UserProfile extends PrismaProfile {
  testimonials?: FriendTestimonial[]; // הוספנו את השדה החסר כאן
}

// הגדרת טיפוס מרכזי לעולמות השאלון
export type WorldId =
  | 'values'
  | 'personality'
  | 'relationship'
  | 'partner'
  | 'religion';

export type QuestionnaireResponse = CustomQuestionnaireResponse;

// PartyInfo עכשיו ישתמש ב-UserProfile המעודכן שלנו
export interface PartyInfo {
  // Fields from User model
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  isProfileComplete: boolean;

  // Relation to Profile (which can be null)
  profile: UserProfile | null; // כאן יבוא לידי ביטוי התיקון

  // Relation to Images (which is a full UserImage array)
  images: UserImage[];

  questionnaireResponses?: QuestionnaireResponse[];
}

export interface StatusHistoryItem {
  id: string;
  suggestionId: string;
  status: string;
  notes?: string | null;
  createdAt: Date | string;
}

export interface ExtendedMatchSuggestion
  extends Omit<MatchSuggestion, 'firstParty' | 'secondParty' | 'matchmaker'> {
  matchmaker: {
    firstName: string;
    lastName: string;
  };
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  statusHistory: StatusHistoryItem[];
}
--- End of Content for types.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\cards
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\cards\MinimalSuggestionCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/cards/MinimalSuggestionCard.tsx

import React from 'react';
import Image from 'next/image';
import { subDays } from 'date-fns';
import {
  User,
  Eye,
  XCircle,
  ChevronRight,
  MessageCircle,
  Heart,
  AlertTriangle,
  Sparkles,
  ChevronLeft,
  Quote,
  Zap,
} from 'lucide-react';
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { getRelativeCloudinaryPath, getInitials } from '@/lib/utils';
import {
  getEnhancedStatusInfo,
  getPartyIndicator,
} from '@/lib/utils/suggestionUtils';
import type { ExtendedMatchSuggestion } from '../types';
import type { SuggestionsCardDict } from '@/types/dictionary';

interface MinimalSuggestionCardProps {
  suggestion: ExtendedMatchSuggestion;
  userId: string;
  onClick: (suggestion: ExtendedMatchSuggestion) => void;
  onApprove?: (suggestion: ExtendedMatchSuggestion) => void;
  onInquiry?: (suggestion: ExtendedMatchSuggestion) => void;
  onDecline?: (suggestion: ExtendedMatchSuggestion) => void;
  className?: string;
  isHistory?: boolean;
  isApprovalDisabled?: boolean;
  dict: SuggestionsCardDict;
  locale: 'he' | 'en';
}

const calculateAge = (birthDate?: Date | string | null): number | null => {
  if (!birthDate) return null;
  const today = new Date();
  const birth = new Date(birthDate);
  if (isNaN(birth.getTime())) return null;
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age > 0 ? age : null;
};

const MinimalSuggestionCard: React.FC<MinimalSuggestionCardProps> = ({
  suggestion,
  userId,
  onClick,
  onApprove,
  onInquiry,
  onDecline,
  className,
  isHistory = false,
  isApprovalDisabled = false,
  dict,
  locale,
}) => {
  const targetParty =
    suggestion.firstPartyId === userId
      ? suggestion.secondParty
      : suggestion.firstParty;
  const isFirstParty = suggestion.firstPartyId === userId;

  if (!targetParty || !targetParty.profile) {
    return null;
  }

  const mainImage = targetParty.images?.find((img) => img.isMain);
  const age = calculateAge(targetParty.profile.birthDate);
  const statusInfo = getEnhancedStatusInfo(
    suggestion.status,
    isFirstParty,
    dict
  );
  const partyIndicator = getPartyIndicator(
    suggestion.status,
    isFirstParty,
    dict
  );

  const hasDeadline =
    suggestion.decisionDeadline &&
    new Date(suggestion.decisionDeadline) > new Date();
  const isUrgent =
    hasDeadline &&
    subDays(new Date(suggestion.decisionDeadline!), 2) < new Date();

  const reasonTeaser = suggestion.matchingReason
    ? suggestion.matchingReason.length > 100
      ? `${suggestion.matchingReason.substring(0, 100)}...`
      : suggestion.matchingReason
    : dict.reasonTeaserDefault;

  const handleCardClick = () => {
    onClick(suggestion);
  };

  return (
    <Card
      className={cn(
        'group w-full rounded-2xl overflow-hidden shadow-lg border-0 bg-white transition-all duration-500 hover:shadow-xl hover:-translate-y-1',
        // Urgent Ring: Orange (Action)
        isUrgent && 'ring-2 ring-orange-400 ring-opacity-60',
        className
      )}
    >
      {/* Header Gradient: Teal -> White -> Orange */}
      <div className="relative p-4 bg-gradient-to-r from-teal-50/80 via-white to-orange-50/50 border-b border-teal-100/50">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Avatar className="w-10 h-10 border-2 border-white shadow-md">
              {/* Avatar: Teal (Professional/Knowledge) */}
              <AvatarFallback className="bg-gradient-to-br from-teal-500 to-teal-600 text-white font-bold text-sm">
                {getInitials(
                  `${suggestion.matchmaker.firstName} ${suggestion.matchmaker.lastName}`
                )}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="text-xs text-teal-600 font-medium">
                {dict.suggestedBy}
              </p>
              <p className="text-sm font-bold text-gray-800">
                {suggestion.matchmaker.firstName}{' '}
                {suggestion.matchmaker.lastName}
              </p>
            </div>
          </div>
          <div className="flex flex-col items-end gap-1">
            <Badge
              className={cn(
                'flex items-center gap-1.5 border shadow-sm font-semibold text-xs',
                statusInfo.className,
                statusInfo.pulse && 'animate-pulse'
              )}
            >
              <statusInfo.icon className="w-3 h-3" aria-hidden="true" />
              <span>{statusInfo.shortLabel}</span>
            </Badge>
            {partyIndicator.show && (
              <Badge
                className={cn(
                  'text-xs px-2 py-0.5 font-bold shadow-sm',
                  partyIndicator.className
                )}
              >
                {partyIndicator.text === dict.yourTurn && (
                  <Zap
                    className={cn(
                      'w-2.5 h-2.5',
                      locale === 'he' ? 'ml-1' : 'mr-1'
                    )}
                    aria-hidden="true"
                  />
                )}
                {partyIndicator.text}
              </Badge>
            )}
          </div>
        </div>
        {isUrgent && (
          <div className="absolute top-2 left-2">
            {/* Urgent Badge: Orange/Red */}
            <Badge className="flex items-center gap-1.5 bg-gradient-to-r from-orange-500 to-red-500 text-white border-0 shadow-lg animate-pulse">
              <AlertTriangle className="w-3 h-3" />
              <span className="font-semibold text-xs">{dict.urgent}</span>
            </Badge>
          </div>
        )}
      </div>

      {/* Image Section */}
      <button
        type="button"
        onClick={handleCardClick}
        aria-label={dict.viewDetailsAria.replace(
          '{{name}}',
          targetParty.firstName
        )}
        className="block w-full text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
      >
        <div className="relative h-64">
          {mainImage?.url ? (
            <Image
              src={getRelativeCloudinaryPath(mainImage.url)}
              alt={`תמונה של ${targetParty.firstName}`}
              fill
              className="object-cover object-center transition-transform duration-700 group-hover:scale-105"
              sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            />
          ) : (
            <div className="w-full h-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
              <User className="w-20 h-20 text-slate-400" />
            </div>
          )}
          <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
          <div className="absolute bottom-4 right-4 left-4 text-white">
            <div className="flex items-end justify-between">
              <div>
                <h3 className="text-2xl font-bold tracking-tight [text-shadow:0_2px_8px_rgba(0,0,0,0.8)]">
                  {targetParty.firstName}
                </h3>
                {age && (
                  <p className="text-lg font-medium text-white/90 [text-shadow:0_1px_4px_rgba(0,0,0,0.8)]">
                    {age}
                  </p>
                )}
              </div>
              <div className="p-2 rounded-full bg-white/20 backdrop-blur-sm">
                <Sparkles className="w-5 h-5 text-white" />
              </div>
            </div>
          </div>
        </div>
      </button>

      <div onClick={handleCardClick} className="cursor-pointer">
        <CardContent className="p-5 space-y-4">
          {statusInfo.description && (
            <div className="p-3 bg-gradient-to-r from-slate-50 to-gray-50 rounded-lg border border-slate-200">
              <div className="flex items-start gap-2">
                <statusInfo.icon className="w-4 h-4 text-slate-600 mt-0.5 flex-shrink-0" />
                <p className="text-sm text-slate-700 font-medium leading-relaxed">
                  {statusInfo.description}
                </p>
              </div>
            </div>
          )}

          <div className="grid grid-cols-2 gap-3">
            {/* Note: Assuming children or specific grid content was here in original, keeping layout structure */}
          </div>

          {/* "Why Special" / Teaser Box - Changed to Orange/Amber (Personal/Warmth) */}
          <div className="relative p-4 bg-gradient-to-r from-orange-50/50 to-amber-50/50 border border-orange-100/50 rounded-xl">
            <div className="flex items-start gap-3">
              <Quote className="w-4 h-4 text-orange-500 mt-1 flex-shrink-0" />
              <div className="flex-1">
                <h4 className="text-sm font-bold text-orange-800 mb-1">
                  {dict.whySpecial}
                </h4>
                <p className="text-sm text-orange-900/80 leading-relaxed">
                  {reasonTeaser}
                </p>
              </div>
            </div>
            <div className="absolute top-0 right-0 w-6 h-6 bg-gradient-to-br from-orange-200/50 to-amber-200/50 rounded-bl-xl"></div>
          </div>

          <div className="text-center py-2">
            <p className="text-xs text-gray-500 font-medium">
              {dict.clickForDetails}
            </p>
          </div>
        </CardContent>
      </div>

      {!isHistory && (
        <CardFooter className="p-4 bg-gradient-to-r from-gray-50/50 to-slate-50/50 border-t border-gray-100">
          {(suggestion.status === 'PENDING_FIRST_PARTY' && isFirstParty) ||
          (suggestion.status === 'PENDING_SECOND_PARTY' && !isFirstParty) ? (
            <div className="grid grid-cols-2 gap-3 w-full">
              {/* Decline: Rose (Pink/Red) */}
              <Button
                size="sm"
                variant="outline"
                className="w-full text-rose-600 hover:text-rose-700 hover:bg-rose-50 border-rose-200 rounded-xl font-medium transition-all duration-300"
                onClick={(e) => {
                  e.stopPropagation();
                  onDecline?.(suggestion);
                }}
              >
                <XCircle
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {dict.buttons.decline}
              </Button>

              <TooltipProvider>
                <Tooltip delayDuration={100}>
                  <TooltipTrigger asChild>
                    <div className="w-full">
                      {/* Approve: Teal -> Emerald */}
                      <Button
                        size="sm"
                        variant="default"
                        className="w-full bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-600 hover:to-emerald-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-medium"
                        disabled={isApprovalDisabled}
                        onClick={(e) => {
                          e.stopPropagation();
                          if (isApprovalDisabled) {
                            toast.info('לא ניתן לאשר הצעה חדשה', {
                              description: 'יש לך כבר הצעה אחרת בתהליך פעיל.',
                            });
                          } else {
                            onApprove?.(suggestion);
                          }
                        }}
                      >
                        <Heart
                          className={cn(
                            'w-4 h-4',
                            locale === 'he' ? 'ml-2' : 'mr-2'
                          )}
                        />
                        {dict.buttons.approve}
                      </Button>
                    </div>
                  </TooltipTrigger>
                  {isApprovalDisabled && (
                    <TooltipContent>
                      <p>{dict.buttons.approveDisabledTooltip}</p>
                    </TooltipContent>
                  )}
                </Tooltip>
              </TooltipProvider>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3 w-full">
              {/* Ask Matchmaker: Teal accent */}
              <Button
                size="sm"
                variant="outline"
                className="w-full border-gray-200 hover:bg-teal-50 hover:border-teal-200 text-gray-700 hover:text-teal-700 rounded-xl font-medium transition-all duration-300"
                onClick={(e) => {
                  e.stopPropagation();
                  onInquiry?.(suggestion);
                }}
              >
                <MessageCircle
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {dict.buttons.askMatchmaker}
              </Button>

              {/* View Details: Teal Gradient */}
              <Button
                size="sm"
                variant="default"
                className="w-full bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-medium"
                onClick={() => onClick(suggestion)}
              >
                <Eye
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {dict.buttons.viewDetails}
                {locale === 'he' ? (
                  <ChevronLeft className="w-3 h-3 mr-2" />
                ) : (
                  <ChevronRight className="w-3 h-3 ml-2" />
                )}
              </Button>
            </div>
          )}
        </CardFooter>
      )}
    </Card>
  );
};
export default MinimalSuggestionCard;
--- End of Content for MinimalSuggestionCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\cards\SuggestionQuickView.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/suggestions/cards/SuggestionQuickView.tsx

import React from 'react';
import { Button } from '@/components/ui/button';
import {
  Heart,
  User,
  Clock,
  Eye,
  Scroll,
  GraduationCap,
  Briefcase,
  MapPin,
  MessageCircle,
  CheckCircle,
  XCircle,
} from 'lucide-react';
import type { ExtendedMatchSuggestion } from '../types';
import type { SuggestionsQuickViewDict } from '@/types/dictionary'; // ✨ Import dictionary type

interface SuggestionQuickViewProps {
  suggestion: ExtendedMatchSuggestion;
  userId?: string;
  onAction: (action: 'approve' | 'reject' | 'ask' | 'view') => void;
  dict: SuggestionsQuickViewDict; // ✨ Add dict prop
}

const SuggestionQuickView: React.FC<SuggestionQuickViewProps> = ({
  suggestion,
  userId,
  onAction,
  dict, // ✨ Destructure dict
}) => {
  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
  };

  const profile = userId
    ? suggestion.firstPartyId === userId
      ? suggestion.secondParty.profile
      : suggestion.firstParty.profile
    : suggestion.secondParty.profile;

  if (!profile) {
    return null;
  }

  return (
    <div
      className="bg-white/95 backdrop-blur-sm p-4 rounded-lg shadow-lg flex flex-col"
      onClick={handleClick}
    >
      <div className="flex-1 space-y-4 text-right overflow-y-auto max-h-96">
        <div className="grid grid-cols-2 gap-3">
          {profile.height && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>
                {profile.height} {dict.unitCm}
              </span>
              <User className="w-4 h-4" />
            </div>
          )}

          {profile.maritalStatus && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>{profile.maritalStatus}</span>
              <Heart className="w-4 h-4" />
            </div>
          )}

          {profile.religiousLevel && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>{profile.religiousLevel}</span>
              <Scroll className="w-4 h-4" />
            </div>
          )}

          {profile.education && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>{profile.education}</span>
              <GraduationCap className="w-4 h-4" />
            </div>
          )}
        </div>

        {profile.about && (
          <div className="border-t border-gray-100 pt-3">
            <h4 className="text-sm font-medium mb-1">{dict.aboutTitle}</h4>
            <p className="text-sm text-gray-600 leading-relaxed line-clamp-3">
              {profile.about}
            </p>
          </div>
        )}

        {suggestion.matchingReason && (
          <div className="border-t border-gray-100 pt-3">
            <h4 className="text-sm font-medium mb-1">{dict.reasonTitle}</h4>
            <p className="text-sm text-gray-600 leading-relaxed line-clamp-3">
              {suggestion.matchingReason}
            </p>
          </div>
        )}

        <div className="border-t border-gray-100 pt-3 space-y-2">
          {profile.city && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>{profile.city}</span>
              <MapPin className="w-4 h-4" />
            </div>
          )}

          {profile.occupation && (
            <div className="flex items-center justify-end gap-2 text-sm text-gray-600">
              <span>{profile.occupation}</span>
              <Briefcase className="w-4 h-4" />
            </div>
          )}
        </div>

        {suggestion.decisionDeadline && (
          <div className="border-t border-gray-100 pt-3">
            <div className="flex items-center justify-end gap-2 text-sm text-yellow-600">
              <span>
                {dict.deadlineText.replace(
                  '{{date}}',
                  new Date(suggestion.decisionDeadline).toLocaleDateString(
                    'he-IL'
                  )
                )}
              </span>
              <Clock className="w-4 h-4" />
            </div>
          </div>
        )}
      </div>

      <div className="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-gray-100">
        <Button
          variant="default"
          className="w-full"
          onClick={() => onAction('view')}
        >
          <Eye className="w-4 h-4 ml-2" />
          {dict.buttons.viewProfile}
        </Button>

        <Button
          variant="default"
          className="w-full bg-green-600 hover:bg-green-700"
          onClick={() => onAction('approve')}
        >
          <CheckCircle className="w-4 h-4 ml-2" />
          {dict.buttons.approve}
        </Button>

        <Button
          variant="outline"
          className="w-full text-red-600 hover:text-red-700 hover:bg-red-50"
          onClick={() => onAction('reject')}
        >
          <XCircle className="w-4 h-4 ml-2" />
          {dict.buttons.decline}
        </Button>

        <Button
          variant="outline"
          className="w-full"
          onClick={() => onAction('ask')}
        >
          <MessageCircle className="w-4 h-4 ml-2" />
          {dict.buttons.ask}
        </Button>
      </div>
    </div>
  );
};

export default SuggestionQuickView;
--- End of Content for SuggestionQuickView.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\compatibility
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\compatibility\MatchCompatibilityView.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/suggestions/compatibility/MatchCompatibilityView.tsx

import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  User,
  Scroll,
  GraduationCap,
  MapPin,
  BookOpen,
  Home,
  Languages,
  Star,
  CheckCircle,
  XCircle,
  AlertTriangle,
  TrendingUp,
  Target,
  Users,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import type { PartyInfo } from '../types';
import type { SuggestionsCompatibilityDict } from '@/types/dictionary';

interface CompatibilityItem {
  criterion: string;
  icon: React.ReactNode;
  compatible: boolean;
  reason: string;
  first?: string | number | null;
  second?: string | number | null;
  importance: 'high' | 'medium' | 'low';
  category: 'basic' | 'lifestyle' | 'values' | 'preferences';
}

interface MatchCompatibilityProps {
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  matchingReason?: string | null;
  className?: string;
  dict: SuggestionsCompatibilityDict;
}

const calculateAge = (birthDate?: Date | string | null): number | null => {
  if (!birthDate) return null;
  try {
    const today = new Date();
    const birth = new Date(birthDate);
    if (isNaN(birth.getTime())) return null;
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age >= 0 ? age : null;
  } catch (error) {
    console.error('Error calculating age:', error);
    return null;
  }
};

const getImportanceColor = (importance: string) => {
  switch (importance) {
    case 'high':
      return 'from-red-400 to-red-500';
    case 'medium':
      return 'from-amber-400 to-orange-500';
    case 'low':
      return 'from-cyan-400 to-blue-500';
    default:
      return 'from-gray-400 to-gray-500';
  }
};

const getCategoryColor = (category: string) => {
  switch (category) {
    case 'basic':
      return 'from-cyan-50 to-blue-50';
    case 'lifestyle':
      return 'from-emerald-50 to-green-50';
    case 'values':
      return 'from-blue-50 to-cyan-50';
    case 'preferences':
      return 'from-green-50 to-emerald-50';
    default:
      return 'from-gray-50 to-slate-50';
  }
};

const CompatibilityCard: React.FC<{
  item: CompatibilityItem;
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  dict: SuggestionsCompatibilityDict;
}> = ({ item, firstParty, secondParty, dict }) => {
  const importanceColor = getImportanceColor(item.importance);
  const categoryColor = getCategoryColor(item.category);

  return (
    <Card
      className={cn(
        'border-0 shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 overflow-hidden bg-gradient-to-br',
        categoryColor
      )}
    >
      <CardContent className="p-5">
        <div className="flex items-start gap-4">
          <div
            className={cn(
              'flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br text-white flex items-center justify-center shadow-md',
              item.compatible
                ? 'from-emerald-500 to-green-500'
                : 'from-red-400 to-rose-500'
            )}
          >
            {item.icon}
          </div>
          <div className="flex-1 space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-1">
                  <h4 className="font-bold text-gray-800 text-base">
                    {item.criterion}
                  </h4>
                  <Badge
                    variant="outline"
                    className={cn(
                      'text-xs px-2 py-0.5 font-semibold border-0 text-white',
                      importanceColor
                    )}
                  >
                    {item.importance === 'high'
                      ? dict.importance.high
                      : item.importance === 'medium'
                        ? dict.importance.medium
                        : dict.importance.low}
                  </Badge>
                </div>
                <p
                  className={cn(
                    'text-sm font-medium leading-relaxed',
                    item.compatible ? 'text-emerald-700' : 'text-red-700'
                  )}
                >
                  {item.reason}
                </p>
              </div>
              <div className="flex-shrink-0">
                {item.compatible ? (
                  <CheckCircle className="w-6 h-6 text-emerald-500" />
                ) : (
                  <XCircle className="w-6 h-6 text-red-500" />
                )}
              </div>
            </div>
            {(item.first != null || item.second != null) && (
              <div className="grid grid-cols-2 gap-3 pt-3 border-t border-white/50">
                <div className="text-center bg-white/60 backdrop-blur-sm rounded-lg p-2">
                  <div className="text-xs text-gray-500 font-medium mb-1">
                    {firstParty.firstName}
                  </div>
                  <div className="font-semibold text-gray-800 text-sm">
                    {item.first ?? dict.card.notSpecified}
                  </div>
                </div>
                <div className="text-center bg-white/60 backdrop-blur-sm rounded-lg p-2">
                  <div className="text-xs text-gray-500 font-medium mb-1">
                    {secondParty.firstName}
                  </div>
                  <div className="font-semibold text-gray-800 text-sm">
                    {item.second ?? dict.card.notSpecified}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

const CategorySection: React.FC<{
  title: string;
  icon: React.ElementType;
  items: CompatibilityItem[];
  color: string;
  firstParty: PartyInfo;
  secondParty: PartyInfo;
  dict: SuggestionsCompatibilityDict;
}> = ({ title, icon: Icon, items, color, firstParty, secondParty, dict }) => {
  const compatibleCount = items.filter((item) => item.compatible).length;
  const compatibilityRate =
    items.length > 0 ? (compatibleCount / items.length) * 100 : 0;

  if (items.length === 0) return null;

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div
            className={cn(
              'p-2 rounded-lg bg-gradient-to-r text-white shadow-md',
              color
            )}
          >
            <Icon className="w-5 h-5" />
          </div>
          <div>
            <h3 className="text-lg font-bold text-gray-800">{title}</h3>
            <p className="text-sm text-gray-600">
              {dict.categorySubtitle
                .replace('{{compatibleCount}}', compatibleCount.toString())
                .replace('{{totalCount}}', items.length.toString())}
            </p>
          </div>
        </div>
        <div className="text-center">
          <div
            className={cn(
              'text-2xl font-bold',
              compatibilityRate >= 70
                ? 'text-emerald-600'
                : compatibilityRate >= 50
                  ? 'text-amber-600'
                  : 'text-red-600'
            )}
          >
            {Math.round(compatibilityRate)}%
          </div>
          <div className="text-xs text-gray-500">{dict.compatibilityLabel}</div>
        </div>
      </div>
      <ul className="grid gap-4">
        {items.map((item, index) => (
          <li key={index}>
            <CompatibilityCard
              item={item}
              firstParty={firstParty}
              secondParty={secondParty}
              dict={dict}
            />
          </li>
        ))}
      </ul>
    </div>
  );
};

const MatchCompatibilityView: React.FC<MatchCompatibilityProps> = ({
  firstParty,
  secondParty,
  matchingReason,
  className,
  dict,
}) => {
  if (!firstParty.profile || !secondParty.profile) {
    return (
      <Card className={cn('shadow-xl border-0 overflow-hidden', className)}>
        <CardHeader className="bg-gradient-to-r from-cyan-50/80 via-white to-emerald-50/50 border-b border-gray-100">
          <CardTitle className="flex items-center gap-3 text-2xl">
            <div className="p-3 rounded-xl bg-gradient-to-r from-cyan-500 to-emerald-500 text-white shadow-lg">
              <Heart className="w-6 h-6" />
            </div>
            <div>
              <span className="font-bold text-gray-800">{dict.mainTitle}</span>
            </div>
          </CardTitle>
        </CardHeader>
        <CardContent className="p-8">
          <div className="text-center py-12">
            <AlertTriangle className="w-16 h-16 mx-auto mb-4 text-gray-400" />
            <h3 className="text-lg font-semibold text-gray-600 mb-2">
              {dict.errorTitle}
            </h3>
            <p className="text-gray-500 max-w-md mx-auto">
              {dict.errorDescription}
            </p>
          </div>
        </CardContent>
      </Card>
    );
  }

  const firstProfile = firstParty.profile;
  const secondProfile = secondParty.profile;

  const firstPartyAge = calculateAge(firstProfile.birthDate);
  const secondPartyAge = calculateAge(secondProfile.birthDate);

  const isWithinRange = (
    value: number | null | undefined,
    min: number | null | undefined,
    max: number | null | undefined
  ): boolean => {
    if (value == null) return false;
    const minOk = min == null || value >= min;
    const maxOk = max == null || value <= max;
    return minOk && maxOk;
  };

  const isInPreferredList = (
    value: string | null | undefined,
    preferredList: string[] | null | undefined
  ): boolean => {
    if (value == null) return false;
    if (preferredList == null || preferredList.length === 0) return true;
    return preferredList.includes(value);
  };

  const calculateCompatibilityItems = (): CompatibilityItem[] => {
    const items: CompatibilityItem[] = [];

    // Age
    if (firstPartyAge != null && secondPartyAge != null) {
      const compatible =
        isWithinRange(
          secondPartyAge,
          firstProfile.preferredAgeMin,
          firstProfile.preferredAgeMax
        ) &&
        isWithinRange(
          firstPartyAge,
          secondProfile.preferredAgeMin,
          secondProfile.preferredAgeMax
        );
      items.push({
        criterion: dict.criteria.age,
        icon: <User className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace('{{criterion}}', dict.criteria.age)
          : dict.reasons.mismatch.replace('{{criterion}}', dict.criteria.age),
        first: firstPartyAge,
        second: secondPartyAge,
        importance: 'high',
        category: 'basic',
      });
    }

    // Height
    if (firstProfile.height != null && secondProfile.height != null) {
      const compatible =
        isWithinRange(
          secondProfile.height,
          firstProfile.preferredHeightMin,
          firstProfile.preferredHeightMax
        ) &&
        isWithinRange(
          firstProfile.height,
          secondProfile.preferredHeightMin,
          secondProfile.preferredHeightMax
        );
      items.push({
        criterion: dict.criteria.height,
        icon: <TrendingUp className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace(
              '{{criterion}}',
              dict.criteria.height
            )
          : dict.reasons.mismatch.replace(
              '{{criterion}}',
              dict.criteria.height
            ),
        first: `${firstProfile.height} ${dict.unitCm}`,
        second: `${secondProfile.height} ${dict.unitCm}`,
        importance: 'medium',
        category: 'basic',
      });
    }

    // Location
    if (firstProfile.city != null && secondProfile.city != null) {
      const compatible =
        isInPreferredList(
          secondProfile.city,
          firstProfile.preferredLocations
        ) &&
        isInPreferredList(firstProfile.city, secondProfile.preferredLocations);
      items.push({
        criterion: dict.criteria.location,
        icon: <MapPin className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace(
              '{{criterion}}',
              dict.criteria.location
            )
          : dict.reasons.mismatch.replace(
              '{{criterion}}',
              dict.criteria.location
            ),
        first: firstProfile.city,
        second: secondProfile.city,
        importance: 'high',
        category: 'lifestyle',
      });
    }

    // Religious Level
    if (
      firstProfile.religiousLevel != null &&
      secondProfile.religiousLevel != null
    ) {
      const compatible =
        isInPreferredList(
          secondProfile.religiousLevel,
          firstProfile.preferredReligiousLevels
        ) &&
        isInPreferredList(
          firstProfile.religiousLevel,
          secondProfile.preferredReligiousLevels
        );
      items.push({
        criterion: dict.criteria.religiousLevel,
        icon: <Scroll className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace(
              '{{criterion}}',
              dict.criteria.religiousLevel
            )
          : dict.reasons.mismatch.replace(
              '{{criterion}}',
              dict.criteria.religiousLevel
            ),
        first: firstProfile.religiousLevel,
        second: secondProfile.religiousLevel,
        importance: 'high',
        category: 'values',
      });
    }

    // Education
    if (firstProfile.education != null && secondProfile.education != null) {
      const compatible =
        isInPreferredList(
          secondProfile.education,
          firstProfile.preferredEducation
        ) &&
        isInPreferredList(
          firstProfile.education,
          secondProfile.preferredEducation
        );
      items.push({
        criterion: dict.criteria.education,
        icon: <GraduationCap className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace(
              '{{criterion}}',
              dict.criteria.education
            )
          : dict.reasons.mismatch.replace(
              '{{criterion}}',
              dict.criteria.education
            ),
        first: firstProfile.education,
        second: secondProfile.education,
        importance: 'medium',
        category: 'preferences',
      });
    }

    // Occupation
    if (firstProfile.occupation != null && secondProfile.occupation != null) {
      const compatible =
        isInPreferredList(
          secondProfile.occupation,
          firstProfile.preferredOccupations
        ) &&
        isInPreferredList(
          firstProfile.occupation,
          secondProfile.preferredOccupations
        );
      items.push({
        criterion: dict.criteria.occupation,
        icon: <BookOpen className="w-6 h-6" />,
        compatible,
        reason: compatible
          ? dict.reasons.mutualMatch.replace(
              '{{criterion}}',
              dict.criteria.occupation
            )
          : dict.reasons.mismatch.replace(
              '{{criterion}}',
              dict.criteria.occupation
            ),
        first: firstProfile.occupation,
        second: secondProfile.occupation,
        importance: 'medium',
        category: 'lifestyle',
      });
    }

    // Origin
    if (firstProfile.origin != null && secondProfile.origin != null) {
      items.push({
        criterion: dict.criteria.origin,
        icon: <Home className="w-6 h-6" />,
        compatible: true,
        reason:
          firstProfile.origin === secondProfile.origin
            ? dict.reasons.sameOrigin
            : dict.reasons.differentOrigin,
        first: firstProfile.origin,
        second: secondProfile.origin,
        importance: 'low',
        category: 'values',
      });
    }

    // Language
    if (
      firstProfile.nativeLanguage != null &&
      secondProfile.nativeLanguage != null
    ) {
      const sharedLanguage =
        firstProfile.nativeLanguage === secondProfile.nativeLanguage ||
        (firstProfile.additionalLanguages?.includes(
          secondProfile.nativeLanguage
        ) ??
          false) ||
        (secondProfile.additionalLanguages?.includes(
          firstProfile.nativeLanguage
        ) ??
          false);
      items.push({
        criterion: dict.criteria.language,
        icon: <Languages className="w-6 h-6" />,
        compatible: sharedLanguage,
        reason: sharedLanguage
          ? dict.reasons.sharedLanguage
          : dict.reasons.noSharedLanguage,
        first: firstProfile.nativeLanguage,
        second: secondProfile.nativeLanguage,
        importance: 'medium',
        category: 'lifestyle',
      });
    }

    return items;
  };

  const compatibilityItems = calculateCompatibilityItems();
  const compatibleCount = compatibilityItems.filter(
    (item) => item.compatible
  ).length;
  const compatibilityScore =
    compatibilityItems.length > 0
      ? Math.round((compatibleCount / compatibilityItems.length) * 100)
      : 0;

  const basicItems = compatibilityItems.filter(
    (item) => item.category === 'basic'
  );
  const lifestyleItems = compatibilityItems.filter(
    (item) => item.category === 'lifestyle'
  );
  const valuesItems = compatibilityItems.filter(
    (item) => item.category === 'values'
  );
  const preferencesItems = compatibilityItems.filter(
    (item) => item.category === 'preferences'
  );

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-emerald-600';
    if (score >= 60) return 'text-cyan-600';
    if (score >= 40) return 'text-amber-600';
    return 'text-red-600';
  };

  const getScoreDescription = (score: number) => {
    if (score >= 80) return dict.overallScore.descriptionExcellent;
    if (score >= 60) return dict.overallScore.descriptionGood;
    if (score >= 40) return dict.overallScore.descriptionModerate;
    return dict.overallScore.descriptionChallenging;
  };

  return (
    <Card className={cn('shadow-xl border-0 overflow-hidden', className)}>
      <CardHeader className="bg-gradient-to-r from-cyan-50/80 via-white to-emerald-50/50 border-b border-gray-100">
        <CardTitle className="flex items-center gap-3 text-2xl">
          <div className="p-3 rounded-xl bg-gradient-to-r from-cyan-500 to-emerald-500 text-white shadow-lg">
            <Heart className="w-6 h-6" />
          </div>
          <div>
            <span className="font-bold text-gray-800">{dict.mainTitle}</span>
            <p className="text-sm text-gray-600 font-normal mt-1">
              {dict.mainSubtitle}
            </p>
          </div>
        </CardTitle>
      </CardHeader>

      <CardContent className="p-8 space-y-8">
        <Card className="border-0 shadow-lg bg-gradient-to-r from-slate-50 to-gray-50">
          <CardContent className="p-6">
            <div className="text-center space-y-4">
              <div className="flex items-center justify-center gap-3">
                <Star className="w-8 h-8 text-yellow-500 fill-current" />
                <div>
                  <div
                    className={cn(
                      'text-4xl font-bold',
                      getScoreColor(compatibilityScore)
                    )}
                  >
                    {compatibilityScore}%
                  </div>
                  <div className="text-lg font-semibold text-gray-700">
                    {getScoreDescription(compatibilityScore)}
                  </div>
                </div>
              </div>
              <Progress value={compatibilityScore} className="h-3" />
              <div className="flex justify-between text-sm text-gray-600">
                <span>
                  {dict.overallScore.progressText
                    .replace('{{compatibleCount}}', compatibleCount.toString())
                    .replace(
                      '{{totalCount}}',
                      compatibilityItems.length.toString()
                    )}
                </span>
                <span>
                  {dict.overallScore.overallScoreLabel.replace(
                    '{{score}}',
                    compatibilityScore.toString()
                  )}
                </span>
              </div>
            </div>
          </CardContent>
        </Card>

        {compatibilityItems.length > 0 ? (
          <div className="space-y-8">
            <CategorySection
              title={dict.categoryTitles.basic}
              icon={User}
              items={basicItems}
              color="from-cyan-500 to-blue-500"
              firstParty={firstParty}
              secondParty={secondParty}
              dict={dict}
            />
            <CategorySection
              title={dict.categoryTitles.values}
              icon={Heart}
              items={valuesItems}
              color="from-emerald-500 to-green-500"
              firstParty={firstParty}
              secondParty={secondParty}
              dict={dict}
            />
            <CategorySection
              title={dict.categoryTitles.lifestyle}
              icon={Target}
              items={lifestyleItems}
              color="from-blue-500 to-cyan-500"
              firstParty={firstParty}
              secondParty={secondParty}
              dict={dict}
            />
            <CategorySection
              title={dict.categoryTitles.preferences}
              icon={Star}
              items={preferencesItems}
              color="from-green-500 to-emerald-500"
              firstParty={firstParty}
              secondParty={secondParty}
              dict={dict}
            />
          </div>
        ) : (
          <div className="text-center py-12">
            <AlertTriangle className="w-16 h-16 mx-auto mb-4 text-gray-400" />
            <h3 className="text-lg font-semibold text-gray-600 mb-2">
              {dict.noDataTitle}
            </h3>
            <p className="text-gray-500 max-w-md mx-auto">
              {dict.noDataDescription}
            </p>
          </div>
        )}

        {matchingReason && (
          <Card className="border-0 shadow-lg bg-gradient-to-r from-cyan-50 to-emerald-50">
            <CardContent className="p-6">
              <div className="flex items-start gap-4">
                <div className="p-3 rounded-xl bg-gradient-to-r from-cyan-500 to-emerald-500 text-white shadow-md flex-shrink-0">
                  <Users className="w-6 h-6" />
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-cyan-800 text-lg mb-2">
                    {dict.matchmakerRationaleTitle}
                  </h3>
                  <p className="text-cyan-700 leading-relaxed">
                    {matchingReason}
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        )}
      </CardContent>
    </Card>
  );
};

export default MatchCompatibilityView;
--- End of Content for MatchCompatibilityView.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\compatibility\UserAiAnalysisDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/suggestions/compatibility/UserAiAnalysisDisplay.tsx
'use client';

import React from 'react';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import {
  Heart,
  Lightbulb,
  MessageSquareQuote,
  Sparkles,
  Target,
  Brain,
  CheckCircle,
  AlertCircle,
  Star,
} from 'lucide-react';
import type { AiSuggestionAnalysisResult } from '@/lib/services/aiService';
import { cn } from '@/lib/utils';

interface UserAiAnalysisDisplayProps {
  analysis: AiSuggestionAnalysisResult;
}

// Score color helper עם הפלטה החדשה
const getScoreColor = (score: number) => {
  if (score >= 85)
    return {
      text: 'text-emerald-600',
      bg: 'from-emerald-50 to-green-50',
      progress: 'bg-gradient-to-r from-emerald-500 to-green-500',
      badge: 'bg-gradient-to-r from-emerald-500 to-green-500',
    };
  if (score >= 70)
    return {
      text: 'text-cyan-600',
      bg: 'from-cyan-50 to-blue-50',
      progress: 'bg-gradient-to-r from-cyan-500 to-blue-500',
      badge: 'bg-gradient-to-r from-cyan-500 to-blue-500',
    };
  if (score >= 55)
    return {
      text: 'text-blue-600',
      bg: 'from-blue-50 to-cyan-50',
      progress: 'bg-gradient-to-r from-blue-500 to-cyan-500',
      badge: 'bg-gradient-to-r from-blue-500 to-cyan-500',
    };
  return {
    text: 'text-amber-600',
    bg: 'from-amber-50 to-orange-50',
    progress: 'bg-gradient-to-r from-amber-500 to-orange-500',
    badge: 'bg-gradient-to-r from-amber-500 to-orange-500',
  };
};

// Score interpretation helper
const getScoreInterpretation = (score: number) => {
  if (score >= 85)
    return {
      level: 'התאמה מעולה',
      description: 'רמת התאמה גבוהה מאוד עם פוטנציאל רב להצלחה',
      icon: <Star className="w-5 h-5" fill="currentColor" />,
    };
  if (score >= 70)
    return {
      level: 'התאמה טובה',
      description: 'בסיס חזק לקשר משמעותי עם אתגרים מינימליים',
      icon: <CheckCircle className="w-5 h-5" />,
    };
  if (score >= 55)
    return {
      level: 'התאמה בינונית',
      description: 'פוטנציאל טוב עם נקודות לעבודה משותפת',
      icon: <Target className="w-5 h-5" />,
    };
  return {
    level: 'התאמה מאתגרת',
    description: 'דורש השקעה ותקשורת מעמיקה יותר',
    icon: <AlertCircle className="w-5 h-5" />,
  };
};

const Section: React.FC<{
  title: string;
  icon: React.ElementType;
  iconColorClass: string;
  bgColorClass: string;
  children: React.ReactNode;
}> = ({ title, icon: Icon, iconColorClass, bgColorClass, children }) => (
  <Card className={cn('overflow-hidden border-0 shadow-lg', bgColorClass)}>
    <CardHeader className="pb-4">
      <CardTitle className="flex items-center gap-3 text-xl">
        <div
          className={cn(
            'p-3 rounded-xl shadow-md',
            iconColorClass.replace('text-', 'bg-').replace('-600', '-100')
          )}
        >
          <Icon className={cn('w-6 h-6', iconColorClass)} />
        </div>
        <span className="font-bold text-gray-800">{title}</span>
      </CardTitle>
    </CardHeader>
    <CardContent className="pt-0">{children}</CardContent>
  </Card>
);

const CompatibilityPoint: React.FC<{
  point: { area: string; explanation: string };
  index: number;
}> = ({ point, index }) => (
  <div className="group p-4 bg-white/70 backdrop-blur-sm rounded-xl border border-emerald-100 shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-1">
    <div className="flex items-start gap-3">
      <div className="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-emerald-400 to-green-500 text-white flex items-center justify-center text-sm font-bold shadow-md">
        {index + 1}
      </div>
      <div className="flex-1 space-y-2">
        <h4 className="font-semibold text-emerald-800 text-base leading-tight">
          {point.area}
        </h4>
        <p className="text-sm text-emerald-900/80 leading-relaxed">
          {point.explanation}
        </p>
      </div>
    </div>
  </div>
);

const ConsiderationPoint: React.FC<{
  point: { area: string; explanation: string };
  index: number;
}> = ({ point, index }) => (
  <div className="group p-4 bg-white/70 backdrop-blur-sm rounded-xl border border-cyan-100 shadow-sm hover:shadow-md transition-all duration-300 hover:-translate-y-1">
    <div className="flex items-start gap-3">
      <div className="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white flex items-center justify-center text-sm font-bold shadow-md">
        {index + 1}
      </div>
      <div className="flex-1 space-y-2">
        <h4 className="font-semibold text-cyan-800 text-base leading-tight">
          {point.area}
        </h4>
        <p className="text-sm text-cyan-900/80 leading-relaxed">
          {point.explanation}
        </p>
      </div>
    </div>
  </div>
);

const ConversationStarter: React.FC<{
  starter: string;
  index: number;
}> = ({ starter, index }) => (
  <div className="group flex items-start gap-3 p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-blue-100 hover:bg-white/80 transition-all duration-300 hover:shadow-sm">
    <div className="flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-r from-blue-400 to-cyan-500 text-white flex items-center justify-center text-xs font-bold shadow-sm">
      {index + 1}
    </div>
    <p className="text-sm text-blue-900 leading-relaxed font-medium">
      {starter}
    </p>
  </div>
);

const UserAiAnalysisDisplay: React.FC<UserAiAnalysisDisplayProps> = ({
  analysis,
}) => {
  const scoreColors = getScoreColor(analysis.overallScore);
  const scoreInterpretation = getScoreInterpretation(analysis.overallScore);

  return (
    <div className="space-y-8 p-2">
      {/* Header Summary */}
      <Card
        className={cn(
          'text-center border-0 shadow-xl overflow-hidden bg-gradient-to-br',
          scoreColors.bg
        )}
      >
        <CardContent className="p-8 relative">
          {/* Background decoration */}
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
          <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>

          <div className="relative z-10 space-y-6">
            <div className="flex justify-center mb-4">
              <div
                className={cn('p-4 rounded-2xl shadow-lg', scoreColors.badge)}
              >
                <Brain className="w-8 h-8 text-white" />
              </div>
            </div>

            <div className="space-y-3">
              <h2 className="text-3xl font-bold text-gray-800 tracking-tight">
                {analysis.matchTitle}
              </h2>
              <p className="text-lg text-gray-700 max-w-2xl mx-auto leading-relaxed">
                {analysis.matchSummary}
              </p>
            </div>

            <div className="space-y-4">
              <div className="flex items-center justify-center gap-3">
                {scoreInterpretation.icon}
                <Badge
                  className={cn(
                    'text-xl font-bold px-6 py-3 rounded-2xl text-white border-0 shadow-lg',
                    scoreColors.badge
                  )}
                >
                  ציון התאמה: {analysis.overallScore}%
                </Badge>
              </div>

              <div className="max-w-md mx-auto space-y-2">
                <Progress
                  value={analysis.overallScore}
                  className="h-3 bg-white/50"
                />
                <div className="flex justify-between text-sm font-medium text-gray-600">
                  <span>{scoreInterpretation.level}</span>
                  <span>{analysis.overallScore}%</span>
                </div>
                <p className="text-sm text-gray-600 text-center">
                  {scoreInterpretation.description}
                </p>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Compatibility Points */}
      <Section
        title="נקודות חיבור חזקות"
        icon={Heart}
        iconColorClass="text-emerald-600"
        bgColorClass="bg-gradient-to-br from-emerald-50/80 to-green-50/60"
      >
        <ul className="space-y-4">
          {analysis.compatibilityPoints.length > 0 ? (
            analysis.compatibilityPoints.map((point, index) => (
              // Each item is now a <li>
              <li key={index}>
                <CompatibilityPoint point={point} index={index} />
              </li>
            ))
          ) : (
            <div className="text-center py-8 text-gray-500">
              <Heart className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>לא נמצאו נקודות חיבור ספציפיות בניתוח</p>
            </div>
          )}
        </ul>
      </Section>

      {/* Points to Consider */}
      <Section
        title="נקודות למחשבה וצמיחה"
        icon={Lightbulb}
        iconColorClass="text-cyan-600"
        bgColorClass="bg-gradient-to-br from-cyan-50/80 to-blue-50/60"
      >
        <div className="space-y-4">
          {analysis.pointsToConsider.length > 0 ? (
            analysis.pointsToConsider.map((point, index) => (
              <ConsiderationPoint key={index} point={point} index={index} />
            ))
          ) : (
            <div className="text-center py-8 text-gray-500">
              <Lightbulb className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>לא נמצאו נקודות מיוחדות לתשומת לב</p>
            </div>
          )}
        </div>
      </Section>

      {/* Conversation Starters */}
      <Section
        title="נושאים מומלצים לפתיחת שיחה"
        icon={MessageSquareQuote}
        iconColorClass="text-blue-600"
        bgColorClass="bg-gradient-to-br from-blue-50/80 to-cyan-50/60"
      >
        <ul className="space-y-3">
          {analysis.suggestedConversationStarters.length > 0 ? (
            analysis.suggestedConversationStarters.map((starter, index) => (
              // Each item is now a <li>
              <li key={index}>
                <ConversationStarter starter={starter} index={index} />
              </li>
            ))
          ) : (
            <div className="text-center py-8 text-gray-500">
              <MessageSquareQuote className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>לא נמצאו הצעות ספציפיות לפתיחת שיחה</p>
            </div>
          )}
        </ul>
      </Section>

      {/* Bottom Note */}
      <Card className="border-0 shadow-lg bg-gradient-to-r from-cyan-50 to-emerald-50">
        <CardContent className="p-6 text-center">
          <div className="flex items-center justify-center gap-2 mb-3">
            <Sparkles className="w-5 h-5 text-cyan-600" />
            <span className="font-semibold text-cyan-800">הערה חשובה</span>
          </div>
          <p className="text-sm text-cyan-700 leading-relaxed max-w-2xl mx-auto">
            זכרו, ניתוח זה הוא כלי עזר והמלצה בלבד. הוא נועד להאיר נקודות למחשבה
            ולעורר שיחה. הכימיה האמיתית והחיבור העמוק נוצרים במפגש האנושי.
          </p>
        </CardContent>
      </Card>
    </div>
  );
};

export default UserAiAnalysisDisplay;
--- End of Content for UserAiAnalysisDisplay.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\dialogs
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\dialogs\AskMatchmakerDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/dialogs/AskMatchmakerDialog.tsx
import React, { useState, useMemo } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  MessageCircle,
  Send,
  AlertCircle,
  Heart,
  Users,
  BookOpen,
  Calendar,
  Lightbulb,
  Clock,
  Sparkles,
} from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import type { AskMatchmakerDict } from '@/types/dictionary';

interface AskMatchmakerDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (question: string) => Promise<void>;
  matchmakerName?: string;
  dict: AskMatchmakerDict;
}

const iconMap: { [key: string]: React.ElementType } = {
  values: Heart,
  family: Users,
  career: BookOpen,
  personality: Sparkles,
  future: Calendar,
  other: Lightbulb,
};

// Updated Color Map to match Hero Palette (Teal, Orange, Rose)
const colorMap: { [key: string]: string } = {
  values: 'from-teal-400 to-emerald-500',    // Teal/Emerald -> Knowledge/Truth
  family: 'from-orange-400 to-amber-500',    // Orange/Amber -> Warmth/Home
  career: 'from-blue-500 to-teal-500',       // Blue/Teal -> Professional
  personality: 'from-rose-400 to-pink-500',  // Rose/Pink -> Personal/Emotion
  future: 'from-amber-400 to-orange-500',    // Amber/Orange -> Ambition
  other: 'from-gray-500 to-slate-500',       // Neutral
};

export const AskMatchmakerDialog: React.FC<AskMatchmakerDialogProps> = ({
  isOpen,
  onClose,
  onSubmit,
  matchmakerName,
  dict,
}) => {
  const [question, setQuestion] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [selectedTopic, setSelectedTopic] = useState<string | null>(null);

  const questionTopics = useMemo(() => {
    return Object.keys(dict.topics).map((key) => ({
      id: key,
      label: dict.topics[key as keyof typeof dict.topics].label,
      description: dict.topics[key as keyof typeof dict.topics].description,
      questions: dict.topics[key as keyof typeof dict.topics].questions,
      icon: iconMap[key],
      color: colorMap[key],
    }));
  }, [dict]);

  const handleSubmit = async () => {
    if (!question.trim()) return;

    try {
      setIsSubmitting(true);
      setError(null);
      await onSubmit(question);
      setQuestion('');
      setSelectedTopic(null);
      onClose();
    } catch (error) {
      console.error('Error submitting question:', error);
      setError(dict.errorSubmitting);
    } finally {
      setIsSubmitting(false);
    }
  };

  const getInitials = (name?: string) => {
    if (!name) return 'שד';
    const parts = name.split(' ');
    if (parts.length === 1) return parts[0].charAt(0);
    return `${parts[0].charAt(0)}${parts[parts.length - 1].charAt(0)}`;
  };

  const selectedTopicData = questionTopics.find((t) => t.id === selectedTopic);
  const dialogTitle = matchmakerName
    ? dict.title.replace('{{name}}', matchmakerName)
    : dict.titleDefault;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] flex flex-col p-0 border-0 shadow-2xl rounded-3xl bg-white overflow-hidden z-[9999]">
        {/* Header: Teal -> White -> Orange Gradient */}
        <DialogHeader className="px-8 py-6 bg-gradient-to-r from-teal-50/80 via-white to-orange-50/50 border-b border-gray-100">
          <div className="flex items-center gap-4 mb-4">
            <Avatar className="w-16 h-16 border-4 border-white shadow-lg">
              {/* Avatar: Teal Gradient */}
              <AvatarFallback className="bg-gradient-to-br from-teal-500 to-emerald-600 text-white text-xl font-bold">
                {getInitials(matchmakerName)}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1">
              <DialogTitle className="text-2xl font-bold text-gray-800 mb-1">
                {dialogTitle}
              </DialogTitle>
              <DialogDescription className="text-gray-600 text-base">
                {dict.description}
              </DialogDescription>
            </div>
            {/* Badge: Teal/Emerald */}
            <Badge className="bg-gradient-to-r from-teal-500 to-emerald-500 text-white border-0 shadow-md px-3 py-1">
              <Clock className="w-3 h-3 ml-1" />
              {dict.statusBadge}
            </Badge>
          </div>
        </DialogHeader>

        <div className="flex-1 overflow-y-auto p-8 space-y-6">
          {error && (
            <Alert variant="destructive" className="border-red-200 bg-red-50">
              <AlertCircle className="h-5 w-5" />
              <AlertDescription className="text-red-800 font-medium">
                {error}
              </AlertDescription>
            </Alert>
          )}

          <div className="space-y-4">
            <div className="text-center">
              <h3 className="text-lg font-semibold text-gray-800 mb-2">
                {dict.topicSelect.title}
              </h3>
              <p className="text-sm text-gray-600">
                {dict.topicSelect.subtitle}
              </p>
            </div>

            <div className="grid grid-cols-2 lg:grid-cols-3 gap-3">
              {questionTopics.map((topic) => (
                <Card
                  key={topic.id}
                  className={cn(
                    'cursor-pointer transition-all duration-300 border-2 hover:shadow-lg hover:-translate-y-1',
                    // Selection state: Teal
                    selectedTopic === topic.id
                      ? 'border-teal-300 bg-teal-50 shadow-md'
                      : 'border-gray-200 hover:border-teal-200'
                  )}
                  onClick={() => setSelectedTopic(topic.id)}
                >
                  <CardContent className="p-4 text-center">
                    <div
                      className={cn(
                        'w-12 h-12 rounded-xl mx-auto mb-3 flex items-center justify-center bg-gradient-to-r text-white shadow-md',
                        topic.color
                      )}
                    >
                      <topic.icon className="w-6 h-6" />
                    </div>
                    <h4 className="font-semibold text-gray-800 text-sm mb-1">
                      {topic.label}
                    </h4>
                    <p className="text-xs text-gray-600 leading-relaxed">
                      {topic.description}
                    </p>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>

          {selectedTopicData && (
            // Sample Questions: Teal/Orange Gradient
            <Card className="bg-gradient-to-r from-teal-50/50 to-orange-50/50 border-teal-200/50">
              <CardContent className="p-6">
                <div className="flex items-center gap-2 mb-4">
                  <selectedTopicData.icon className="w-5 h-5 text-teal-600" />
                  <h4 className="font-semibold text-teal-800">
                    {dict.sampleQuestions.title.replace(
                      '{{topic}}',
                      selectedTopicData.label
                    )}
                  </h4>
                </div>
                <div className="space-y-2 max-h-32 overflow-y-auto scrollbar-elegant">
                  {selectedTopicData.questions.map((q, index) => (
                    <Button
                      key={index}
                      variant="ghost"
                      className="w-full justify-end text-right hover:bg-teal-100 hover:text-teal-800 transition-colors rounded-lg p-3 h-auto"
                      onClick={() => setQuestion(q)}
                    >
                      <span className="text-sm leading-relaxed">{q}</span>
                    </Button>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          <div className="space-y-3">
            <Label
              htmlFor="question"
              className="text-base font-semibold text-gray-800"
            >
              {dict.input.label}
            </Label>
            {/* Textarea Focus: Teal */}
            <Textarea
              id="question"
              value={question}
              onChange={(e) => setQuestion(e.target.value)}
              placeholder={dict.input.placeholder}
              className="min-h-[120px] text-right border-gray-200 focus:border-teal-300 focus:ring-teal-200 rounded-xl text-base leading-relaxed resize-none"
            />
            <div className="flex justify-between items-center text-xs text-gray-500">
              <span>
                {dict.input.charCount.replace(
                  '{{count}}',
                  question.length.toString()
                )}
              </span>
              <span>{dict.input.info}</span>
            </div>
          </div>
        </div>
        <DialogFooter className="px-8 py-6 border-t border-gray-100 bg-gray-50/50">
          <div className="flex gap-3 w-full">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={isSubmitting}
              className="flex-1 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
            >
              {dict.buttons.cancel}
            </Button>
            {/* Submit Button: Hero Gradient (Teal -> Orange -> Amber) */}
            <Button
              type="submit"
              onClick={handleSubmit}
              disabled={!question.trim() || isSubmitting}
              className="flex-1 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-medium"
            >
              {isSubmitting ? (
                <>
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2" />
                  {dict.buttons.submitting}
                </>
              ) : (
                <>
                  <Send className="w-4 h-4 ml-2" />
                  {dict.buttons.submit}
                </>
              )}
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
export default AskMatchmakerDialog;
--- End of Content for AskMatchmakerDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\dialogs\UserAiAnalysisDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/dialogs/UserAiAnalysisDialog.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Loader2,
  Sparkles,
  AlertTriangle,
  Bot,
  Brain,
  Heart,
  Users,
  Target,
  ArrowLeft,
  CheckCircle,
  Info,
  MessageSquare,
  X,
  XCircle,
  ArrowRight,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import type { AiSuggestionAnalysisResult } from '@/lib/services/aiService';
import type { AiAnalysisDict } from '@/types/dictionary';

// --- Interfaces ---
interface UserAiAnalysisDialogProps {
  suggestedUserId: string;
  isDemo?: boolean;
  demoAnalysisData?: AiSuggestionAnalysisResult | null;
  currentUserName?: string;
  suggestedUserName?: string;
  dict: AiAnalysisDict;
  locale: 'he' | 'en';
}

// --- Demo Data ---
const mockAnalysisResult: AiSuggestionAnalysisResult = {
  overallScore: 91,
  matchTitle: 'A Partnership of Stability and Creativity',
  matchSummary:
    "The connection between Daniel and Noa shows particularly high potential, based on a fascinating balance between shared core values and complementary personalities. The combination of Daniel's practical, ambitious nature and Noa's emotional depth and creativity creates a solid foundation for a long-term partnership.",
  compatibilityPoints: [
    {
      area: 'Shared Values and Worldview',
      explanation:
        'You both see a relationship as a "true partnership" and family as a core value. Noa\'s desire for "kindness" and Daniel\'s emphasis on "integrity and responsibility" connect perfectly to form the basis of a healthy, mature relationship.',
    },
    {
      area: 'Intellectual and Emotional Compatibility',
      explanation:
        'Noa\'s desire for "deep conversations" and her search for intelligence and curiosity align with Daniel\'s analytical and scholarly nature. There is potential for a fascinating intellectual connection and conversations late into the night.',
    },
    {
      area: 'Stability and Reliability',
      explanation:
        'Daniel\'s emphasis on integrity and responsibility, being a "man of action," meets the need for security and stability that are important in building a serious relationship.',
    },
    {
      area: 'Balanced Lifestyle',
      explanation:
        'You both appreciate a balance between activity and rest, and between going out and quiet quality time. The shared love for nature hikes can be a source of many common experiences.',
    },
  ],
  pointsToConsider: [
    {
      area: 'Observing Touch (Shomer Negiah)',
      explanation:
        "Noa, it's important to know that Daniel observes 'shomer negiah'. This is a significant point to discuss openly and respectfully to understand the implications for both of you.",
    },
    {
      area: 'Geographical Location',
      explanation:
        'Daniel lives in Jerusalem and you are in Tel Aviv. This is a gap that needs to be considered and discussed regarding your flexibility for a future place of residence.',
    },
    {
      area: 'Different Career Ambitions',
      explanation:
        "Daniel's path in high-tech is very demanding, while you are looking for a balance with the world of creativity. This is an opportunity to talk about how to support each other's different aspirations.",
    },
  ],
  suggestedConversationStarters: [
    'What is a "true partnership" in your eyes, and how does it manifest in daily life?',
    'How do you balance your professional ambitions with the desire for a full personal, spiritual, and creative life?',
    'Tell me about a project or challenge you took on and what you learned from the process.',
    'What is the most important thing for you that your partner understands about you right from the start?',
  ],
};

// --- Sub-components ---

const AnalysisItem: React.FC<{
  icon: React.ElementType;
  iconColor: string;
  area: string;
  explanation: string;
}> = ({ icon: Icon, iconColor, area, explanation }) => (
  <div className="flex items-start gap-4 p-3 rounded-lg hover:bg-slate-50 transition-colors">
    <div
      className={cn(
        'mt-1 flex-shrink-0 rounded-full p-2 bg-opacity-10',
        iconColor.replace('text-', 'bg-')
      )}
    >
      <Icon className={cn('h-5 w-5', iconColor)} />
    </div>
    <div>
      <h4 className="font-semibold text-gray-800">{area}</h4>
      <p className="text-sm text-gray-600 leading-relaxed">{explanation}</p>
    </div>
  </div>
);

// --- Loading Screen Updated (Teal/Orange/Rose) ---
const LoadingScreen: React.FC<{
  progress: number;
  step: number;
  dict: AiAnalysisDict;
  locale: 'he' | 'en';
}> = ({ progress, step, dict, locale }) => {
  const loadingSteps = [
    { icon: Brain, label: dict.loadingSteps.step1 },
    { icon: Heart, label: dict.loadingSteps.step2 },
    { icon: Users, label: dict.loadingSteps.step3 },
    { icon: Target, label: dict.loadingSteps.step4 },
    { icon: Sparkles, label: dict.loadingSteps.step5 },
  ];

  return (
    <div className="flex flex-col items-center justify-center h-full text-center space-y-8 p-8">
      <div className="relative">
        {/* Spinner Background: Teal -> Orange -> Rose */}
        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-teal-100 via-orange-50 to-rose-100 animate-pulse border-4 border-white shadow-xl" />
        <div className="absolute inset-0 flex items-center justify-center">
          <Loader2 className="w-12 h-12 text-teal-600 animate-spin" />
        </div>
      </div>
      <div className="space-y-3">
        {/* Text Gradient: Teal -> Orange -> Rose */}
        <h3 className="text-2xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-rose-600 bg-clip-text text-transparent">
          {dict.loadingTitle}
        </h3>
        <p className="text-gray-600 max-w-md text-lg">
          {dict.loadingDescription}
        </p>
      </div>
      <div className="w-full max-w-md space-y-4">
        <Progress value={progress} className="h-3 bg-gray-200" />
        <p className="text-sm text-gray-500 font-medium">
          {progress}% {locale === 'he' ? 'הושלם' : 'Completed'}
        </p>
      </div>
      {step < loadingSteps.length && (
        <motion.div
          key={step}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="flex items-center gap-4 p-4 bg-white rounded-xl shadow-lg border border-gray-100"
        >
          {/* Step Icon: Teal -> Orange */}
          <div className="p-3 rounded-full bg-gradient-to-br from-teal-500 to-orange-500 text-white shadow-lg">
            {React.createElement(loadingSteps[step].icon, {
              className: 'w-5 h-5',
            })}
          </div>
          <p className="font-semibold text-gray-800">
            {loadingSteps[step].label}
          </p>
        </motion.div>
      )}
    </div>
  );
};

const ErrorScreen: React.FC<{
  error: string;
  onRetry: () => void;
  dict: AiAnalysisDict;
  locale: 'he' | 'en';
}> = ({ error, onRetry, dict, locale }) => (
  <div className="flex flex-col items-center justify-center h-full text-center space-y-6 p-8">
    <XCircle className="w-16 h-16 text-rose-400" />
    <div className="space-y-4 max-w-md">
      <h3 className="text-2xl font-bold text-gray-800">{dict.errorTitle}</h3>
      <Alert variant="destructive">
        <AlertTriangle className="h-5 w-5" />
        <AlertTitle className="font-semibold">
          {dict.errorAlertTitle}
        </AlertTitle>
        <AlertDescription className="mt-2">
          {error || dict.errorAlertDescription}
        </AlertDescription>
      </Alert>
    </div>
    <Button onClick={onRetry} className="bg-teal-600 hover:bg-teal-700 text-white">
      <Brain className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')} />
      {dict.retryButton}
    </Button>
  </div>
);

// --- DialogBody component ---
export const DialogBody: React.FC<
  UserAiAnalysisDialogProps & { onOpenChange: (open: boolean) => void }
> = ({
  suggestedUserId,
  isDemo = false,
  demoAnalysisData = null,
  currentUserName,
  suggestedUserName,
  onOpenChange,
  dict,
  locale,
}) => {
  const [analysis, setAnalysis] = useState<AiSuggestionAnalysisResult | null>(
    null
  );
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [currentStep, setCurrentStep] = useState(0);

  const fetchAnalysis = async () => {
    setIsLoading(true);
    setError(null);
    setLoadingProgress(0);
    setCurrentStep(0);

    if (isDemo) {
      const timer = setInterval(() => {
        setLoadingProgress((prev) => {
          const newProgress = Math.min(prev + 2, 100);
          setCurrentStep(Math.floor(newProgress / 20));
          return newProgress;
        });
      }, 80);
      setTimeout(() => {
        clearInterval(timer);
        setAnalysis(demoAnalysisData || mockAnalysisResult);
        setIsLoading(false);
      }, 4000);
      return;
    }

    try {
      const response = await fetch('/api/ai/analyze-suggestion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ suggestedUserId }),
      });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'שגיאה בקבלת ניתוח ההצעה.');
      }
      setAnalysis(result.data);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : 'אירעה שגיאה לא צפויה.';
      setError(errorMessage);
      toast.error('שגיאה בתהליך הניתוח', { description: errorMessage });
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchAnalysis();
  }, [suggestedUserId, isDemo]);

  const BackButtonIcon = locale === 'he' ? ArrowRight : ArrowLeft;
  const directionArrow = locale === 'he' ? '⟵' : '⟶';

  return (
    <>
      <DialogHeader className="relative p-6 border-b text-center bg-gradient-to-b from-slate-50 to-white flex-shrink-0">
        <div className="flex flex-col items-center gap-2">
          {/* Bot Icon: Teal -> Orange -> Rose */}
          <div className="p-3 rounded-full bg-gradient-to-br from-teal-500 via-orange-500 to-rose-500 text-white shadow-lg">
            <Bot className="w-7 h-7" />
          </div>
          {/* Title: Teal -> Orange -> Rose */}
          <DialogTitle className="text-2xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-rose-600 bg-clip-text text-transparent">
            {dict.dialogTitle}
          </DialogTitle>
          <DialogDescription className="text-base text-gray-500">
            {currentUserName} {directionArrow} {suggestedUserName}
          </DialogDescription>
        </div>
        <div
          className={cn(
            'absolute top-4',
            locale === 'he' ? 'left-4' : 'right-4'
          )}
        >
          <Button
            variant="ghost"
            size="icon"
            onClick={() => onOpenChange(false)}
            className="rounded-full"
          >
            <X className="h-5 w-5 text-gray-500" />
          </Button>
        </div>
      </DialogHeader>

      <main className="flex-1 flex flex-col min-h-0 bg-white">
        <AnimatePresence mode="wait">
          {isLoading ? (
            <motion.div key="loading" exit={{ opacity: 0 }} className="flex-1">
              <LoadingScreen
                progress={loadingProgress}
                step={currentStep}
                dict={dict}
                locale={locale}
              />
            </motion.div>
          ) : error ? (
            <motion.div key="error" exit={{ opacity: 0 }} className="flex-1">
              <ErrorScreen
                error={error}
                onRetry={fetchAnalysis}
                dict={dict}
                locale={locale}
              />
            </motion.div>
          ) : analysis ? (
            <motion.div
              key="content"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              className="flex-1 flex flex-col min-h-0"
            >
              <Tabs
                defaultValue="summary"
                className="flex-1 flex flex-col min-h-0"
              >
                <TabsList className="mx-4 mt-4 bg-slate-100 p-1 rounded-lg flex-shrink-0">
                  <TabsTrigger value="summary">{dict.tabs.summary}</TabsTrigger>
                  <TabsTrigger value="consider">
                    {dict.tabs.consider}
                  </TabsTrigger>
                  <TabsTrigger value="conversation">
                    {dict.tabs.conversation}
                  </TabsTrigger>
                </TabsList>

                <ScrollArea className="flex-1">
                  <div className={cn('p-6', locale === 'en' && 'text-left')}>
                    <TabsContent value="summary" className="space-y-6 mt-0">
                      <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        {/* Match Title: Teal */}
                        <h3 className="font-semibold text-gray-800 mb-2 flex items-center gap-2 text-teal-600">
                          <Info className="w-5 h-5" />
                          {analysis.matchTitle}
                        </h3>
                        <p className="text-sm text-gray-600 leading-relaxed">
                          {analysis.matchSummary}
                        </p>
                      </div>
                      <div>
                        {/* Strength: Emerald (Success) */}
                        <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                          <CheckCircle className="w-5 h-5 text-emerald-500" />
                          {dict.summaryTab.strengthTitle}
                        </h3>
                        <div className="space-y-4">
                          {analysis.compatibilityPoints.map((point) => (
                            <AnalysisItem
                              key={point.area}
                              icon={CheckCircle}
                              iconColor="text-emerald-500"
                              {...point}
                            />
                          ))}
                        </div>
                      </div>
                    </TabsContent>

                    <TabsContent value="consider" className="mt-0">
                      {/* Considerations: Amber/Orange */}
                      <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <AlertTriangle className="w-5 h-5 text-orange-500" />
                        {dict.considerTab.title}
                      </h3>
                      <div className="space-y-4">
                        {analysis.pointsToConsider.map((point) => (
                          <AnalysisItem
                            key={point.area}
                            icon={AlertTriangle}
                            iconColor="text-orange-500"
                            {...point}
                          />
                        ))}
                      </div>
                    </TabsContent>

                    <TabsContent value="conversation" className="mt-0">
                      {/* Conversation: Teal */}
                      <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <MessageSquare className="w-5 h-5 text-teal-500" />
                        {dict.conversationTab.title}
                      </h3>
                      <ul className="space-y-3 list-inside">
                        {analysis.suggestedConversationStarters.map(
                          (starter, index) => (
                            <li
                              key={index}
                              className="flex items-start gap-2 p-2 rounded-md hover:bg-teal-50/50"
                            >
                              <MessageSquare className="w-4 h-4 text-teal-400 mt-1 flex-shrink-0" />
                              <span className="text-sm text-gray-700">
                                {starter}
                              </span>
                            </li>
                          )
                        )}
                      </ul>
                    </TabsContent>
                  </div>
                </ScrollArea>
              </Tabs>
            </motion.div>
          ) : null}
        </AnimatePresence>
      </main>
      <div className="p-4 bg-gray-50/80 border-t flex justify-end flex-shrink-0">
        <Button variant="ghost" onClick={() => onOpenChange(false)}>
          <BackButtonIcon
            className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
          />
          {dict.backButton}
        </Button>
      </div>
    </>
  );
};

// --- Main exported wrapper component ---
export const UserAiAnalysisDialog: React.FC<UserAiAnalysisDialogProps> = (
  props
) => {
  const [isOpen, setIsOpen] = useState(false);
  const { dict, locale } = props;

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>
        {/* Trigger Button: Teal -> Orange -> Rose */}
        <Button
          variant="outline"
          size="lg"
          className="relative overflow-hidden group bg-gradient-to-r from-teal-50 via-orange-50 to-rose-50 border-2 border-teal-200 text-teal-700 hover:from-teal-100 hover:to-rose-100 hover:border-teal-300 transition-all duration-300 shadow-lg hover:shadow-xl rounded-xl"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent transform -translate-x-full group-hover:animate-shimmer" />
          <div className="relative z-10 flex items-center gap-3">
            <div className="relative">
              <Brain className="w-6 h-6 transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110 text-teal-600" />
              <Sparkles className="w-3 h-3 absolute -top-1 -right-1 text-orange-500 opacity-0 group-hover:opacity-100" />
            </div>
            <span className="text-lg font-bold">{dict.triggerButton}</span>
          </div>
        </Button>
      </DialogTrigger>
      <DialogContent
        className="max-w-4xl w-[95vw] h-[90vh] flex flex-col p-0 overflow-hidden shadow-2xl rounded-2xl bg-gray-50 z-[9999]"
        dir={locale === 'he' ? 'rtl' : 'ltr'}
        style={{ zIndex: 9999 }}
      >
        {isOpen && <DialogBody {...props} onOpenChange={handleOpenChange} />}
      </DialogContent>
      <style>{`
        @keyframes shimmer {
          100% {
            transform: translateX(100%);
          }
        }
        .animate-shimmer {
          animation: shimmer 2s infinite;
        }
        
        [data-radix-dialog-overlay] {
          z-index: 9998 !important;
        }
        
        [data-radix-dialog-content] {
          z-index: 9999 !important;
        }
      `}</style>
    </Dialog>
  );
};
--- End of Content for UserAiAnalysisDialog.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\inquiries
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\inquiries\InquiryThreadView.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/inquiries/InquiryThreadView.tsx

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { useSession } from 'next-auth/react';
import { UserRole } from '@prisma/client';
import { format } from 'date-fns';
import { he } from 'date-fns/locale';
import { toast } from 'sonner';

import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardFooter,
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { Label } from '@/components/ui/label';
import {
  Send,
  MessageCircle,
  Loader2,
  CheckCircle,
  Clock,
  AlertTriangle,
  User,
  MessageSquare,
  Sparkles,
} from 'lucide-react';
import { cn, getInitials } from '@/lib/utils';
import type { InquiryThreadDict } from '@/types/dictionary';

// --- Interfaces ---
interface Inquiry {
  id: string;
  suggestionId: string;
  fromUserId: string;
  toUserId: string;
  question: string;
  answer: string | null;
  status: 'PENDING' | 'ANSWERED' | 'CLOSED';
  createdAt: string | Date;
  answeredAt: string | Date | null;
  fromUser: { id: string; firstName: string; lastName: string };
  toUser: { id: string; firstName: string; lastName: string };
}

interface InquiryThreadViewProps {
  suggestionId: string;
  userId: string;
  showComposer?: boolean;
  className?: string;
  isDemo?: boolean;
  dict: InquiryThreadDict;
}

// --- Sub-components ---

const MatchmakerReplyForm: React.FC<{
  inquiryId: string;
  suggestionId: string;
  onAnswerSent: () => void;
  dict: InquiryThreadDict;
}> = ({ inquiryId, suggestionId, onAnswerSent, dict }) => {
  const [answer, setAnswer] = useState('');
  const [isReplying, setIsReplying] = useState(false);

  const handleSendAnswer = async () => {
    if (!answer.trim()) return;
    setIsReplying(true);
    try {
      const response = await fetch(
        `/api/suggestions/${suggestionId}/inquiries`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inquiryId, answer }),
        }
      );
      if (!response.ok) throw new Error('Failed to send answer');
      toast.success(dict.toasts.replySuccess);
      setAnswer('');
      onAnswerSent();
    } catch (error) {
      console.error('Error sending answer:', error);
      toast.error(dict.toasts.replyError);
    } finally {
      setIsReplying(false);
    }
  };

  return (
    // Reply Form: Orange Tint
    <div className="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-xl space-y-3">
      <h4 className="font-semibold text-orange-800 text-sm flex items-center gap-2">
        <Sparkles className="w-4 h-4" /> {dict.replyForm.title}
      </h4>
      <Textarea
        value={answer}
        onChange={(e) => setAnswer(e.target.value)}
        placeholder={dict.replyForm.placeholder}
        className="bg-white rounded-lg focus:ring-orange-200 border-orange-200"
        disabled={isReplying}
      />
      <div className="flex justify-end">
        <Button
          onClick={handleSendAnswer}
          disabled={!answer.trim() || isReplying}
          size="sm"
          className="bg-orange-500 hover:bg-orange-600 text-white"
        >
          {isReplying ? (
            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
          ) : (
            <Send className="w-4 h-4 mr-2" />
          )}
          {isReplying
            ? dict.replyForm.sendingButton
            : dict.replyForm.sendButton}
        </Button>
      </div>
    </div>
  );
};

const MessageBubble: React.FC<{
  inquiry: Inquiry;
  userId: string;
  userRole: UserRole;
  isLatest: boolean;
  suggestionId: string;
  onAnswerSent: () => void;
  dict: InquiryThreadDict;
}> = ({
  inquiry,
  userId,
  userRole,
  isLatest,
  suggestionId,
  onAnswerSent,
  dict,
}) => {
  const isMyQuestion = inquiry.fromUserId === userId;

  const getStatusInfo = (status: Inquiry['status']) => {
    switch (status) {
      case 'PENDING':
        return {
          label: dict.status.pending,
          icon: Clock,
          // Pending: Amber
          className: 'bg-amber-100 text-amber-800 border-amber-200',
          pulse: true,
        };
      case 'ANSWERED':
        return {
          label: dict.status.answered,
          icon: CheckCircle,
          // Answered: Teal
          className: 'bg-teal-100 text-teal-800 border-teal-200',
          pulse: false,
        };
      case 'CLOSED':
        return {
          label: dict.status.closed,
          icon: MessageCircle,
          className: 'bg-gray-100 text-gray-700 border-gray-200',
          pulse: false,
        };
      default:
        return {
          label: String(status),
          icon: AlertTriangle,
          className: 'bg-gray-100 text-gray-700 border-gray-200',
          pulse: false,
        };
    }
  };

  const formatDate = (date: string | Date | null) => {
    if (!date) return '';
    try {
      return format(new Date(date), 'dd בMMMM yyyy, HH:mm', { locale: he });
    } catch (e) {
      console.error('Error formatting date:', date, e);
      return dict.invalidDate;
    }
  };

  return (
    <div
      className={cn(
        'relative transition-all duration-300',
        isLatest && 'animate-fade-in-up'
      )}
    >
      {/* Question */}
      <div
        className={cn(
          'flex gap-4 mb-4',
          isMyQuestion ? 'flex-row-reverse' : 'flex-row'
        )}
      >
        <Avatar className="w-10 h-10 flex-shrink-0 shadow-md">
          <AvatarFallback
            className={cn(
              'font-bold text-sm',
              isMyQuestion
                ? // My Avatar: Teal Gradient
                  'bg-gradient-to-br from-teal-500 to-cyan-500 text-white'
                : // Other Avatar: Rose Gradient
                  'bg-gradient-to-br from-rose-400 to-pink-500 text-white'
            )}
          >
            {getInitials(
              `${inquiry.fromUser.firstName} ${inquiry.fromUser.lastName}`
            )}
          </AvatarFallback>
        </Avatar>
        <div
          className={cn(
            'flex-1 max-w-[85%]',
            isMyQuestion ? 'ml-auto' : 'mr-auto'
          )}
        >
          <div
            className={cn(
              'flex items-center gap-2 mb-2',
              isMyQuestion
                ? 'flex-row-reverse justify-start'
                : 'flex-row justify-start'
            )}
          >
            <span className="font-semibold text-gray-800 text-sm">
              {inquiry.fromUser.firstName} {inquiry.fromUser.lastName}
            </span>
            <span className="text-xs text-gray-400">
              {formatDate(inquiry.createdAt)}
            </span>
          </div>
          <div
            className={cn(
              'p-4 rounded-2xl shadow-md relative',
              isMyQuestion
                ? // My Bubble: Teal Gradient
                  'bg-gradient-to-r from-teal-500 to-cyan-500 text-white rounded-br-md'
                : 'bg-white border border-gray-200 text-gray-800 rounded-bl-md'
            )}
          >
            <p className="text-sm leading-relaxed whitespace-pre-wrap break-words">
              {inquiry.question}
            </p>
            <div
              className={cn(
                'absolute top-4 w-3 h-3 transform rotate-45',
                isMyQuestion
                  ? '-right-1.5 bg-teal-600'
                  : '-left-1.5 bg-white border-l border-b border-gray-200'
              )}
            />
          </div>
        </div>
      </div>

      {/* Answer */}
      {inquiry.answer && inquiry.answeredAt ? (
        <div className="flex gap-4 mt-6 mb-2">
          <Avatar className="w-10 h-10 flex-shrink-0 shadow-md">
            {/* Answer Avatar: Orange/Amber */}
            <AvatarFallback className="bg-gradient-to-br from-orange-400 to-amber-500 text-white font-bold text-sm">
              {getInitials(
                `${inquiry.toUser.firstName} ${inquiry.toUser.lastName}`
              )}
            </AvatarFallback>
          </Avatar>
          <div className="flex-1 max-w-[85%]">
            <div className="flex items-center gap-2 mb-2">
              <span className="font-semibold text-gray-800 text-sm">
                {inquiry.toUser.firstName} {inquiry.toUser.lastName}
              </span>
              <Badge className="bg-gradient-to-r from-teal-500 to-emerald-500 text-white border-0 text-xs px-2 py-1 font-medium">
                <CheckCircle className="w-3 h-3 mr-1" /> {dict.answerBadge}
              </Badge>
              <span className="text-xs text-gray-400">
                {formatDate(inquiry.answeredAt)}
              </span>
            </div>
            {/* Answer Bubble: Light Orange */}
            <div className="p-4 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-2xl rounded-bl-md shadow-md relative">
              <p className="text-sm text-orange-900 leading-relaxed whitespace-pre-wrap break-words">
                {inquiry.answer}
              </p>
              <div className="absolute top-4 -left-1.5 w-3 h-3 bg-orange-50 border-l border-b border-orange-200 transform rotate-45" />
            </div>
          </div>
        </div>
      ) : (
        userRole !== 'CANDIDATE' &&
        inquiry.status === 'PENDING' &&
        !isMyQuestion && (
          <MatchmakerReplyForm
            inquiryId={inquiry.id}
            suggestionId={suggestionId}
            onAnswerSent={onAnswerSent}
            dict={dict}
          />
        )
      )}
      {!isLatest && (
        <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent my-6" />
      )}
    </div>
  );
};

// --- Main Component ---
const InquiryThreadView: React.FC<InquiryThreadViewProps> = ({
  suggestionId,
  userId,
  showComposer = true,
  className,
  isDemo = false,
  dict,
}) => {
  const [inquiries, setInquiries] = useState<Inquiry[]>([]);
  const [isLoading, setIsLoading] = useState(!isDemo);
  const [newQuestion, setNewQuestion] = useState('');
  const [isSending, setIsSending] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { data: session } = useSession();
  const userRole = session?.user?.role as UserRole;
  const scrollAreaRef = useRef<HTMLDivElement>(null);

  const fetchInquiries = useCallback(async () => {
    // Logic remains...
    // Mocking fetch for brevity in this response context, assuming logic exists in original file
    if (isDemo) {
      setIsLoading(false);
      return;
    }
    try {
      setIsLoading(true);
      const res = await fetch(`/api/suggestions/${suggestionId}/inquiries`);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      setInquiries(data);
    } catch (e) {
      setError('Failed to load');
    } finally {
      setIsLoading(false);
    }
  }, [suggestionId, isDemo]);

  useEffect(() => {
    fetchInquiries();
  }, [fetchInquiries]);

  useEffect(() => {
    if (scrollAreaRef.current) {
      setTimeout(() => {
        scrollAreaRef.current!.scrollTop = scrollAreaRef.current!.scrollHeight;
      }, 100);
    }
  }, [inquiries]);

  const handleSendQuestion = async () => {
    if (!newQuestion.trim()) return;
    setIsSending(true);
    setError(null);
    try {
      const response = await fetch(
        `/api/suggestions/${suggestionId}/inquiries`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: newQuestion }),
        }
      );
      if (!response.ok)
        throw new Error(`Failed to send inquiry (${response.status})`);
      await fetchInquiries();
      setNewQuestion('');
      toast.success(dict.toasts.sendSuccessTitle, {
        description: dict.toasts.sendSuccessDescription,
      });
    } catch (error) {
      setError(dict.loadingError);
      toast.error(dict.toasts.sendError);
    } finally {
      setIsSending(false);
    }
  };

  return (
    <Card
      className={cn(
        'shadow-xl border-0 bg-white overflow-hidden flex flex-col max-h-[80vh] min-h-[500px]',
        className
      )}
    >
      {/* Header: Teal/White/Orange Gradient */}
      <CardHeader className="pb-4 bg-gradient-to-r from-teal-50/80 via-white to-orange-50/50 border-b border-gray-100">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg bg-gradient-to-r from-teal-500 to-orange-500 text-white shadow-md">
            <MessageSquare className="w-5 h-5" />
          </div>
          <div>
            <CardTitle className="text-xl font-bold text-gray-800">
              {dict.title}
            </CardTitle>
            <p className="text-sm text-gray-600 mt-1">{dict.subtitle}</p>
          </div>
        </div>
      </CardHeader>
      <div
        ref={scrollAreaRef}
        className="flex-1 p-6 space-y-6 scrollbar-elegant overflow-y-auto"
        aria-live="polite"
        aria-atomic="false"
      >
        {isLoading ? (
          Array.from({ length: 2 }).map((_, i) => (
            <div key={i} className="flex gap-4">
              <Skeleton className="h-10 w-10 rounded-full" />
              <div className="space-y-2 flex-1">
                <Skeleton className="h-4 w-24" />
                <Skeleton className="h-16 w-full rounded-2xl" />
              </div>
            </div>
          ))
        ) : error ? (
          <div className="text-center py-8">
            <AlertTriangle className="w-8 h-8 text-rose-500 mx-auto mb-4" />
            <h3 className="font-semibold text-rose-800 mb-2">
              {dict.loadingError}
            </h3>
            <p className="text-rose-600 text-sm mb-4">{error}</p>
            <Button variant="outline" size="sm" onClick={fetchInquiries}>
              {dict.retryButton}
            </Button>
          </div>
        ) : inquiries.length === 0 ? (
          <div className="text-center py-12">
            <MessageCircle className="w-10 h-10 text-teal-500 mx-auto mb-6" />
            <h3 className="text-xl font-semibold text-gray-700 mb-2">
              {dict.emptyState.title}
            </h3>
            <p className="text-gray-500 max-w-md mx-auto leading-relaxed">
              {dict.emptyState.description}
            </p>
          </div>
        ) : (
          inquiries.map((inquiry, index) => (
            <MessageBubble
              key={inquiry.id}
              inquiry={inquiry}
              userId={userId}
              userRole={userRole}
              isLatest={index === inquiries.length - 1}
              suggestionId={suggestionId}
              onAnswerSent={fetchInquiries}
              dict={dict}
            />
          ))
        )}
      </div>
      {showComposer && userRole === 'CANDIDATE' && (
        <CardFooter className="p-6 border-t border-gray-100 bg-gradient-to-r from-gray-50 to-white">
          <div className="w-full space-y-3">
            <Label
              htmlFor="new-question"
              className="flex items-center gap-2 text-sm font-semibold text-gray-600"
            >
              <User className="w-4 h-4 text-teal-500" />
              {dict.composer.label}
            </Label>
            <Textarea
              id="new-question"
              placeholder={dict.composer.placeholder}
              value={newQuestion}
              onChange={(e) => setNewQuestion(e.target.value)}
              disabled={isSending}
              // Focus ring: Teal
              className="text-right border-gray-200 focus:border-teal-300 focus:ring-teal-200 rounded-xl resize-none"
              rows={3}
            />
            <div className="flex justify-between items-center">
              <span className="text-xs text-gray-500">
                {dict.composer.charCount.replace(
                  '{{count}}',
                  newQuestion.length.toString()
                )}
              </span>
              <Button
                onClick={handleSendQuestion}
                disabled={!newQuestion.trim() || isSending}
                // Send Button: Teal -> Orange Gradient
                className="bg-gradient-to-r from-teal-500 to-orange-500 text-white shadow-lg rounded-xl"
              >
                {isSending ? (
                  <>
                    <Loader2 className="h-4 w-4 ml-2 animate-spin" />
                    {dict.composer.sendingButton}
                  </>
                ) : (
                  <>
                    <Send className="h-4 w-4 ml-2" />
                    {dict.composer.sendButton}
                  </>
                )}
              </Button>
            </div>
          </div>
        </CardFooter>
      )}
    </Card>
  );
};

export default InquiryThreadView;
--- End of Content for InquiryThreadView.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\list
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\list\SuggestionsList.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/list/SuggestionsList.tsx

'use client';
import React, { useState, useEffect } from 'react';
import {
  Search,
  Filter,
  SortAsc,
  SortDesc,
  Calendar,
  Check,
  XCircle,
  Sparkles,
  Heart,
  Clock,
  Users,
  TrendingUp,
  BarChart3,
} from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import { toast } from 'sonner';
import MinimalSuggestionCard from '../cards/MinimalSuggestionCard';
import SuggestionDetailsModal from '../modals/SuggestionDetailsModal';
import AskMatchmakerDialog from '../dialogs/AskMatchmakerDialog';
import { cn } from '@/lib/utils';
import type { ExtendedMatchSuggestion } from '../types';
import type {
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary';

interface SuggestionsListProps {
  suggestions: ExtendedMatchSuggestion[];
  userId: string;
  locale: 'he' | 'en';
  isHistory?: boolean;
  viewMode: 'grid' | 'list';
  isLoading?: boolean;
  className?: string;
  onStatusChange?: (
    suggestionId: string,
    newStatus: string,
    notes?: string
  ) => Promise<void>;
  onRefresh?: () => void;
  isUserInActiveProcess?: boolean;
  onActionRequest: (
    suggestion: ExtendedMatchSuggestion,
    action: 'approve' | 'decline'
  ) => void;
  suggestionsDict: SuggestionsDictionary;
  profileCardDict: ProfileCardDict;
}

type SortOption = 'newest' | 'oldest' | 'deadline' | 'priority';
type FilterOption =
  | 'all'
  | 'pending'
  | 'accepted'
  | 'declined'
  | 'contact_shared';

// --- Empty State Updated to Teal/Orange/Rose ---
const EmptyState: React.FC<{
  isFiltered: boolean;
  isHistory: boolean;
  onClearFilters: () => void;
  dict: SuggestionsDictionary['list']['emptyState'];
}> = ({ isFiltered, isHistory, onClearFilters, dict }) => (
  <div className="flex flex-col items-center justify-center min-h-[400px] text-center p-8">
    <div className="relative mb-8">
      {/* Background Gradient: Teal -> Orange */}
      <div className="w-32 h-32 rounded-full bg-gradient-to-br from-teal-100 to-orange-100 flex items-center justify-center shadow-lg">
        {isFiltered ? (
          <Search className="w-16 h-16 text-teal-500" />
        ) : isHistory ? (
          <Clock className="w-16 h-16 text-gray-400" />
        ) : (
          <Heart className="w-16 h-16 text-rose-400" />
        )}
      </div>
      {!isFiltered && !isHistory && (
        <div className="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-gradient-to-r from-orange-400 to-amber-500 flex items-center justify-center shadow-lg">
          <Sparkles className="w-4 h-4 text-white" />
        </div>
      )}
    </div>
    <h3 className="text-2xl font-bold text-gray-800 mb-3">
      {isFiltered
        ? dict.noResultsTitle
        : isHistory
          ? dict.noHistoryTitle
          : dict.noActiveTitle}
    </h3>
    <p className="text-gray-600 max-w-md mx-auto mb-6 leading-relaxed">
      {isFiltered
        ? dict.noResultsDescription
        : isHistory
          ? dict.noHistoryDescription
          : dict.noActiveDescription}
    </p>
    {isFiltered && (
      <Button
        onClick={onClearFilters}
        className="bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-600 hover:to-emerald-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl"
      >
        <XCircle className="w-4 h-4 ml-2" />
        {dict.clearFilters}
      </Button>
    )}
  </div>
);

// --- Stats Bar Updated to Teal/Indigo/Orange/Green ---
const StatsBar: React.FC<{
  total: number;
  filtered: number;
  pending: number;
  isHistory: boolean;
  dict: SuggestionsDictionary['list']['stats'];
}> = ({ total, filtered, pending, isHistory, dict }) => (
  <Card className="mb-6 border-0 shadow-lg bg-gradient-to-r from-white via-teal-50/50 to-orange-50/50">
    <CardContent className="p-4">
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="text-center">
          <div className="flex items-center justify-center gap-2 mb-1">
            <BarChart3 className="w-4 h-4 text-teal-500" />
            <span className="text-2xl font-bold text-teal-600">{filtered}</span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.showing}</p>
        </div>
        <div className="text-center">
          <div className="flex items-center justify-center gap-2 mb-1">
            <Users className="w-4 h-4 text-indigo-500" />
            <span className="text-2xl font-bold text-indigo-600">{total}</span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.total}</p>
        </div>
        {!isHistory && (
          <div className="text-center">
            <div className="flex items-center justify-center gap-2 mb-1">
              {/* Pending: Orange (Action) */}
              <Clock className="w-4 h-4 text-orange-500" />
              <span className="text-2xl font-bold text-orange-600">
                {pending}
              </span>
            </div>
            <p className="text-xs text-gray-600 font-medium">{dict.pending}</p>
          </div>
        )}
        <div className="text-center">
          <div className="flex items-center justify-center gap-2 mb-1">
            <TrendingUp className="w-4 h-4 text-emerald-500" />
            <span className="text-2xl font-bold text-emerald-600">
              {total > 0 ? Math.round(((total - pending) / total) * 100) : 0}%
            </span>
          </div>
          <p className="text-xs text-gray-600 font-medium">{dict.progress}</p>
        </div>
      </div>
    </CardContent>
  </Card>
);

const SuggestionsList: React.FC<SuggestionsListProps> = ({
  suggestions: initialSuggestions,
  isHistory = false,
  viewMode: initialViewMode,
  isLoading = false,
  userId,
  locale,
  className,
  onActionRequest,
  isUserInActiveProcess,
  suggestionsDict,
  profileCardDict,
}) => {
  const [selectedSuggestion, setSelectedSuggestion] =
    useState<ExtendedMatchSuggestion | null>(null);
  const [showAskDialog, setShowAskDialog] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortOption, setSortOption] = useState<SortOption>('newest');
  const [filterOption, setFilterOption] = useState<FilterOption>('all');
  const [viewMode, setViewMode] = useState<'grid' | 'list'>(initialViewMode);
  const [filteredSuggestions, setFilteredSuggestions] =
    useState<ExtendedMatchSuggestion[]>(initialSuggestions);

  const pendingCount = initialSuggestions.filter(
    (s) =>
      s.status === 'PENDING_FIRST_PARTY' || s.status === 'PENDING_SECOND_PARTY'
  ).length;

  useEffect(() => {
    let result = [...initialSuggestions];

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      result = result.filter((suggestion) => {
        const targetParty =
          suggestion.firstPartyId === userId
            ? suggestion.secondParty
            : suggestion.firstParty;
        return (
          targetParty.firstName.toLowerCase().includes(query) ||
          targetParty.lastName.toLowerCase().includes(query) ||
          targetParty.profile?.city?.toLowerCase().includes(query) ||
          targetParty.profile?.occupation?.toLowerCase().includes(query) ||
          targetParty.profile?.religiousLevel?.toLowerCase().includes(query)
        );
      });
    }

    if (filterOption !== 'all') {
      switch (filterOption) {
        case 'pending':
          result = result.filter(
            (s) =>
              s.status === 'PENDING_FIRST_PARTY' ||
              s.status === 'PENDING_SECOND_PARTY'
          );
          break;
        case 'accepted':
          result = result.filter(
            (s) =>
              s.status === 'FIRST_PARTY_APPROVED' ||
              s.status === 'SECOND_PARTY_APPROVED'
          );
          break;
        case 'declined':
          result = result.filter(
            (s) =>
              s.status === 'FIRST_PARTY_DECLINED' ||
              s.status === 'SECOND_PARTY_DECLINED'
          );
          break;
        case 'contact_shared':
          result = result.filter((s) => s.status === 'CONTACT_DETAILS_SHARED');
          break;
      }
    }

    switch (sortOption) {
      case 'newest':
        result.sort(
          (a, b) =>
            new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
        );
        break;
      case 'oldest':
        result.sort(
          (a, b) =>
            new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()
        );
        break;
      case 'deadline':
        result.sort((a, b) => {
          if (!a.decisionDeadline) return 1;
          if (!b.decisionDeadline) return -1;
          return (
            new Date(a.decisionDeadline).getTime() -
            new Date(b.decisionDeadline).getTime()
          );
        });
        break;
    case 'priority': {
        const priorityOrder = { URGENT: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };
        result.sort(
          (a, b) =>
            (priorityOrder[a.priority as keyof typeof priorityOrder] || 4) -
            (priorityOrder[b.priority as keyof typeof priorityOrder] || 4)
        );
        break;
    }
     }
    setFilteredSuggestions(result);
  }, [initialSuggestions, searchQuery, sortOption, filterOption, userId]);

  const handleOpenDetails = (suggestion: ExtendedMatchSuggestion) => {
    setSelectedSuggestion(suggestion);
  };

  const handleInquiry = (suggestion: ExtendedMatchSuggestion) => {
    setSelectedSuggestion(suggestion);
    setShowAskDialog(true);
  };

  const handleStatusAction = (
    suggestion: ExtendedMatchSuggestion,
    action: 'approve' | 'decline'
  ) => {
    onActionRequest(suggestion, action);
  };

  const handleSendQuestion = async (questionText: string) => {
    if (!selectedSuggestion) return;
    try {
      const response = await fetch(
        `/api/suggestions/${selectedSuggestion.id}/inquiries`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: questionText }),
        }
      );
      if (!response.ok) throw new Error('Failed to send inquiry');
      toast.success('השאלה נשלחה בהצלחה לשדכן', {
        description: 'השדכן יחזור אליך עם תשובה בהקדם',
      });
      setShowAskDialog(false);
    } catch (error) {
      toast.error('אירעה שגיאה בשליחת השאלה');
    }
  };

  const clearFilters = () => {
    setSearchQuery('');
    setFilterOption('all');
  };

  if (isLoading) {
    return (
      <div className={cn('space-y-6', className)}>
        {/* Skeleton content... */}
      </div>
    );
  }

  return (
    <>
      <div className={cn('space-y-6', className)}>
        <StatsBar
          total={initialSuggestions.length}
          filtered={filteredSuggestions.length}
          pending={pendingCount}
          isHistory={isHistory}
          dict={suggestionsDict.list.stats}
        />

        <Card className="border-0 shadow-lg bg-white/80 backdrop-blur-sm">
          <CardContent className="p-6">
            <div className="flex flex-col gap-4">
              <div className="flex items-center gap-3">
                <div className="relative flex-1">
                  <Search className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <Input
                    type="text"
                    placeholder={
                      suggestionsDict.list.controls.searchPlaceholder
                    }
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pr-12 text-right border-gray-200 focus:border-teal-300 focus:ring-teal-200 rounded-xl h-12"
                  />
                </div>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="icon"
                      className="h-12 w-12 border-gray-200 hover:border-teal-300 hover:bg-teal-50 rounded-xl transition-colors"
                    >
                      <Filter className="h-5 w-5" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end" className="w-56">
                    <DropdownMenuLabel className="text-right">
                      {suggestionsDict.list.controls.filterLabel}
                    </DropdownMenuLabel>
                    <DropdownMenuGroup>
                      <DropdownMenuItem onClick={() => setFilterOption('all')}>
                        <Check
                          className={cn(
                            'mr-2 h-4 w-4',
                            filterOption === 'all' ? 'opacity-100' : 'opacity-0'
                          )}
                        />
                        {suggestionsDict.list.controls.filterAll}
                      </DropdownMenuItem>
                      <DropdownMenuItem
                        onClick={() => setFilterOption('pending')}
                      >
                        <Check
                          className={cn(
                            'mr-2 h-4 w-4',
                            filterOption === 'pending'
                              ? 'opacity-100'
                              : 'opacity-0'
                          )}
                        />
                        {suggestionsDict.list.controls.filterPending}
                      </DropdownMenuItem>
                      <DropdownMenuItem
                        onClick={() => setFilterOption('accepted')}
                      >
                        <Check
                          className={cn(
                            'mr-2 h-4 w-4',
                            filterOption === 'accepted'
                              ? 'opacity-100'
                              : 'opacity-0'
                          )}
                        />
                        {suggestionsDict.list.controls.filterAccepted}
                      </DropdownMenuItem>
                      <DropdownMenuItem
                        onClick={() => setFilterOption('declined')}
                      >
                        <Check
                          className={cn(
                            'mr-2 h-4 w-4',
                            filterOption === 'declined'
                              ? 'opacity-100'
                              : 'opacity-0'
                          )}
                        />
                        {suggestionsDict.list.controls.filterDeclined}
                      </DropdownMenuItem>
                      <DropdownMenuItem
                        onClick={() => setFilterOption('contact_shared')}
                      >
                        <Check
                          className={cn(
                            'mr-2 h-4 w-4',
                            filterOption === 'contact_shared'
                              ? 'opacity-100'
                              : 'opacity-0'
                          )}
                        />
                        {suggestionsDict.list.controls.filterContactShared}
                      </DropdownMenuItem>
                    </DropdownMenuGroup>
                  </DropdownMenuContent>
                </DropdownMenu>
                <Select
                  value={sortOption}
                  onValueChange={(value) => setSortOption(value as SortOption)}
                >
                  <SelectTrigger className="w-48 h-12 border-gray-200 focus:border-teal-300 rounded-xl">
                    <SelectValue
                      placeholder={
                        suggestionsDict.list.controls.sortPlaceholder
                      }
                    />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="newest">
                      <div className="flex items-center gap-2">
                        <SortDesc className="h-4 w-4" />
                        {suggestionsDict.list.controls.sortNewest}
                      </div>
                    </SelectItem>
                    <SelectItem value="oldest">
                      <div className="flex items-center gap-2">
                        <SortAsc className="h-4 w-4" />
                        {suggestionsDict.list.controls.sortOldest}
                      </div>
                    </SelectItem>
                    <SelectItem value="deadline">
                      <div className="flex items-center gap-2">
                        <Calendar className="h-4 w-4" />
                        {suggestionsDict.list.controls.sortDeadline}
                      </div>
                    </SelectItem>
                    <SelectItem value="priority">
                      <div className="flex items-center gap-2">
                        <Filter className="h-4 w-4" />
                        {suggestionsDict.list.controls.sortPriority}
                      </div>
                    </SelectItem>
                  </SelectContent>
                </Select>
              </div>
              {(searchQuery || filterOption !== 'all') && (
                <div className="flex items-center gap-2 pt-2 border-t border-gray-100">
                  <span className="text-sm text-gray-500 font-medium">
                    {suggestionsDict.list.activeFilters.title}
                  </span>
                  {searchQuery && (
                    <Badge
                      variant="outline"
                      className="flex items-center gap-1 bg-teal-50 text-teal-700 border-teal-200"
                    >
                      {suggestionsDict.list.activeFilters.search} {searchQuery}
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-4 w-4 p-0 hover:bg-transparent"
                        onClick={() => setSearchQuery('')}
                      >
                        <XCircle className="h-3 w-3" />
                      </Button>
                    </Badge>
                  )}
                  {filterOption !== 'all' && (
                    <Badge
                      variant="outline"
                      className="flex items-center gap-1 bg-orange-50 text-orange-700 border-orange-200"
                    >
                      {filterOption === 'pending' &&
                        suggestionsDict.list.controls.filterPending}
                      {filterOption === 'accepted' &&
                        suggestionsDict.list.controls.filterAccepted}
                      {filterOption === 'declined' &&
                        suggestionsDict.list.controls.filterDeclined}
                      {filterOption === 'contact_shared' &&
                        suggestionsDict.list.controls.filterContactShared}
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-4 w-4 p-0 hover:bg-transparent"
                        onClick={() => setFilterOption('all')}
                      >
                        <XCircle className="h-3 w-3" />
                      </Button>
                    </Badge>
                  )}
                  <Button
                    variant="ghost"
                    size="sm"
                    className="text-xs text-gray-500 hover:text-gray-700"
                    onClick={clearFilters}
                  >
                    {suggestionsDict.list.activeFilters.clearAll}
                  </Button>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        <div className="flex justify-between items-center text-sm text-gray-600">
          <span>
            {filteredSuggestions.length === 1
              ? suggestionsDict.list.resultsCount.showingSingle
                  .replace('{{count}}', '1')
                  .replace('{{total}}', initialSuggestions.length.toString())
              : suggestionsDict.list.resultsCount.showingMultiple
                  .replace('{{count}}', filteredSuggestions.length.toString())
                  .replace('{{total}}', initialSuggestions.length.toString())}
          </span>
          {filteredSuggestions.length > 0 && (
            <div className="flex items-center gap-2">
              <Sparkles className="w-4 h-4 text-rose-500" />
              <span className="font-medium">
                {suggestionsDict.list.resultsCount.qualityMatches}
              </span>
            </div>
          )}
        </div>

        {filteredSuggestions.length === 0 ? (
          <EmptyState
            isFiltered={searchQuery !== '' || filterOption !== 'all'}
            isHistory={isHistory}
            onClearFilters={clearFilters}
            dict={suggestionsDict.list.emptyState}
          />
        ) : (
          <div
            className={cn(
              viewMode === 'grid'
                ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
                : 'space-y-6',
              'animate-fade-in-up'
            )}
          >
            {filteredSuggestions.map((suggestion, index) => (
              <div
                key={suggestion.id}
                className="animate-scale-in"
                style={{
                  animationDelay: `${index * 100}ms`,
                  animationFillMode: 'both',
                }}
              >
                <MinimalSuggestionCard
                  suggestion={suggestion}
                  locale={locale}
                  userId={userId}
                  onClick={() => handleOpenDetails(suggestion)}
                  onInquiry={() => handleInquiry(suggestion)}
                  onApprove={() => handleStatusAction(suggestion, 'approve')}
                  onDecline={() => handleStatusAction(suggestion, 'decline')}
                  isHistory={isHistory}
                  isApprovalDisabled={isUserInActiveProcess}
                  className={cn(
                    'card-hover-elegant',
                    viewMode === 'list' ? 'flex' : ''
                  )}
                  dict={suggestionsDict.card}
                />
              </div>
            ))}
          </div>
        )}
      </div>

      <SuggestionDetailsModal
        suggestion={selectedSuggestion}
        userId={userId}
        locale={locale}
        isOpen={!!selectedSuggestion && !showAskDialog}
        onClose={() => setSelectedSuggestion(null)}
        onActionRequest={onActionRequest}
        questionnaire={
          selectedSuggestion?.secondParty?.questionnaireResponses?.[0] || null
        }
        dict={{
          suggestions: suggestionsDict,
          profileCard: profileCardDict,
        }}
      />

      <AskMatchmakerDialog
        isOpen={showAskDialog}
        onClose={() => setShowAskDialog(false)}
        onSubmit={handleSendQuestion}
        matchmakerName={selectedSuggestion?.matchmaker.firstName}
        dict={suggestionsDict.askMatchmaker}
      />
    </>
  );
};

export default SuggestionsList;
--- End of Content for SuggestionsList.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\modals
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\modals\SuggestionDetailsModal.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/modals/SuggestionDetailsModal.tsx
'use client';

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import Image from 'next/image';
import { useSearchParams } from 'next/navigation';

import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card, CardContent } from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import {
  XCircle,
  MessageCircle,
  X,
  Loader2,
  Sparkles,
  User,
  Info,
  Heart,
  Quote,
  ArrowLeft,
  ChevronUp,
  GitCompareArrows,
  Calendar,
  ArrowRight,
  Lightbulb,
  Puzzle,
  Telescope,
  ChevronDown,
  Maximize,
  Minimize,
  AlertTriangle,
  Bot,
  PartyPopper,
  Wand2,
  TrendingUp,
  Network,
  Compass,
} from 'lucide-react';
import { toast } from 'sonner';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { getInitials, cn, getRelativeCloudinaryPath } from '@/lib/utils';
import type { QuestionnaireResponse } from '@/types/next-auth';
import type { AiSuggestionAnalysisResult } from '@/lib/services/aiService';

import { ProfileCard } from '@/components/profile';
import SuggestionTimeline from '../timeline/SuggestionTimeline';
import InquiryThreadView from '../inquiries/InquiryThreadView';
import { AskMatchmakerDialog } from '../dialogs/AskMatchmakerDialog';
import { UserAiAnalysisDialog } from '../dialogs/UserAiAnalysisDialog';
import type { ExtendedMatchSuggestion } from '../types';
import type {
  SuggestionsDictionary,
  ProfileCardDict,
} from '@/types/dictionary';

interface SuggestionDetailsModalProps {
  suggestion: ExtendedMatchSuggestion | null;
  userId: string;
  isOpen: boolean;
  onClose: () => void;
  onActionRequest: (
    suggestion: ExtendedMatchSuggestion,
    action: 'approve' | 'decline'
  ) => void;
  locale: 'he' | 'en';
  questionnaire: QuestionnaireResponse | null;
  isDemo?: boolean;
  demoAnalysisData?: AiSuggestionAnalysisResult | null;
  dict: {
    suggestions: SuggestionsDictionary;
    profileCard: ProfileCardDict;
  };
}

const useIsMobile = () => {
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const checkDevice = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkDevice();
    window.addEventListener('resize', checkDevice);
    return () => window.removeEventListener('resize', checkDevice);
  }, []);
  return isMobile;
};

const useFullscreenModal = (isOpen: boolean) => {
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const toggleFullscreen = useCallback(() => {
    setIsTransitioning(true);
    setIsFullscreen((prev) => !prev);
    setTimeout(() => setIsTransitioning(false), 300);
  }, []);
  useEffect(() => {
    if (!isOpen) {
      setIsFullscreen(false);
      setIsTransitioning(false);
    }
  }, [isOpen]);
  return { isFullscreen, isTransitioning, toggleFullscreen };
};

// --- Hero Section Updated (Teal/Orange/Rose) ---
const EnhancedHeroSection: React.FC<{
  matchmaker: { firstName: string; lastName: string };
  targetParty: ExtendedMatchSuggestion['secondParty'];
  personalNote?: string | null;
  matchingReason?: string | null;
  locale: 'he' | 'en';
  onViewProfile: () => void;
  onStartConversation: () => void;
  dict: SuggestionsDictionary['modal']['header'];
}> = ({
  matchmaker,
  targetParty,
  personalNote,
  matchingReason,
  onViewProfile,
  onStartConversation,
  dict,
  locale,
}) => {
  const age = targetParty.profile?.birthDate
    ? new Date().getFullYear() -
      new Date(targetParty.profile.birthDate).getFullYear()
    : null;
  const mainImage = targetParty.images?.find((img) => img.isMain)?.url;

  return (
    <div className="relative min-h-screen bg-gradient-to-br from-slate-50 via-teal-50/20 to-orange-50/20 overflow-hidden">
      {/* Background elements - Teal/Orange/Rose Blobs */}
      <div className="absolute inset-0">
        <div className="absolute top-10 right-10 w-72 h-72 bg-gradient-to-br from-teal-200/40 to-emerald-200/40 rounded-full blur-3xl animate-float"></div>
        <div
          className="absolute bottom-10 left-10 w-64 h-64 bg-gradient-to-br from-orange-200/40 to-rose-200/40 rounded-full blur-2xl animate-float"
          style={{ animationDelay: '2s' }}
        ></div>
      </div>

      <div className="relative z-10 p-4 md:p-8 lg:p-12">
        <div className="text-center mb-8 lg:mb-12">
          {/* Matchmaker Badge - Teal */}
          <div className="inline-flex items-center gap-2 mb-6 p-3 bg-white/90 backdrop-blur-lg rounded-2xl shadow-lg border border-teal-100 animate-fade-in-up">
            <Avatar className="w-12 h-12 border-2 border-white shadow-lg">
              <AvatarFallback className="bg-gradient-to-br from-teal-500 to-teal-700 text-white text-sm font-bold">
                {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
              </AvatarFallback>
            </Avatar>
            <div className={cn(locale === 'he' ? 'text-right' : 'text-left')}>
              <p className="text-xs font-medium text-teal-600 mb-1">
                {dict.suggestedBy}
              </p>
              <p className="text-lg font-bold text-gray-800">
                {matchmaker.firstName} {matchmaker.lastName}
              </p>
            </div>
          </div>
          <div className="max-w-4xl mx-auto mb-8">
            {/* Title Gradient - Teal/Orange/Rose */}
            <h1
              className="text-4xl md:text-5xl lg:text-6xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-rose-600 bg-clip-text text-transparent mb-6 leading-tight animate-fade-in-up"
              style={{ animationDelay: '0.5s' }}
            >
              {dict.title}
            </h1>
            <p
              className="text-xl md:text-2xl text-gray-700 leading-relaxed font-medium animate-fade-in-up"
              style={{ animationDelay: '1s' }}
            >
              {dict.subtitleLine1}
              <br />
              {dict.subtitleLine2}
            </p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 mb-12">
          {/* Image Card */}
          <div
            className="relative group animate-fade-in-up"
            style={{ animationDelay: '1.5s' }}
          >
            {/* Glow Effect - Teal/Orange */}
            <div className="absolute -inset-4 bg-gradient-to-r from-teal-400/50 via-orange-400/50 to-rose-400/50 rounded-3xl blur-lg opacity-70 group-hover:opacity-100 transition-opacity animate-pulse"></div>
            <Card className="relative overflow-hidden shadow-2xl border-0 bg-white/95 backdrop-blur-sm">
              <div className="relative h-96 lg:h-[600px]">
                {mainImage ? (
                  <Image
                    src={getRelativeCloudinaryPath(mainImage)}
                    alt={`Image of ${targetParty.firstName}`}
                    fill
                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                    sizes="(max-width: 1024px) 100vw, 50vw"
                  />
                ) : (
                  <div className="w-full h-full bg-gradient-to-br from-teal-100 via-white to-orange-100 flex items-center justify-center">
                    <User className="w-24 h-24 text-teal-400" />
                  </div>
                )}
                <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent" />
                <div className="absolute bottom-0 right-0 left-0 p-6">
                  <div className="bg-white/95 backdrop-blur-lg rounded-2xl p-6 shadow-2xl">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h2 className="text-4xl font-bold text-gray-900 mb-2 tracking-tight">
                          {targetParty.firstName}
                        </h2>
                        {age && (
                          // Age Badge - Orange/Rose
                          <Badge className="bg-gradient-to-r from-orange-500 to-rose-500 text-white border-0 shadow-lg text-lg px-4 py-2">
                            <Calendar
                              className={cn(
                                'w-4 h-4',
                                locale === 'he' ? 'ml-2' : 'mr-2'
                              )}
                            />
                            {dict.ageInYears.replace('{{age}}', age.toString())}
                          </Badge>
                        )}
                      </div>
                      <div className="text-center">
                        <div className="w-16 h-16 rounded-full bg-gradient-to-r from-teal-400 to-emerald-500 flex items-center justify-center shadow-lg mb-2">
                          <Telescope className="w-8 h-8 text-white" />
                        </div>
                        {/* Discover More - Teal */}
                        <Button
                          onClick={onViewProfile}
                          className="bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-600 hover:to-emerald-600 text-white shadow-xl rounded-full px-6 py-3 font-bold text-base"
                        >
                          {dict.discoverMore}
                        </Button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </Card>
          </div>

          <div
            className="space-y-8 animate-fade-in-up"
            style={{ animationDelay: '2s' }}
          >
            {/* Story Card - Teal/Rose */}
            <Card className="border-0 shadow-2xl bg-gradient-to-br from-teal-50 via-white to-rose-50 overflow-hidden">
              <CardContent className="p-8 relative">
                <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-teal-200/30 to-rose-200/30 rounded-full blur-2xl"></div>
                <div className="relative z-10">
                  <h2 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-teal-600 via-orange-600 to-rose-600 bg-clip-text text-transparent mb-4 leading-tight text-center">
                    {dict.matchStoryTitle}
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    {/* View Profile - Teal/Orange */}
                    <Button
                      onClick={onViewProfile}
                      size="lg"
                      className="bg-gradient-to-r from-teal-500 to-orange-500 hover:from-teal-600 hover:to-orange-600 text-white shadow-xl rounded-xl h-14 font-bold text-base transform hover:scale-105 transition-all"
                    >
                      <User
                        className={cn(
                          'w-5 h-5',
                          locale === 'he' ? 'ml-2' : 'mr-2'
                        )}
                      />
                      {dict.viewFullProfile}
                      {locale === 'he' ? (
                        <ArrowLeft className="w-4 h-4 mr-2" />
                      ) : (
                        <ArrowRight className="w-4 h-4 ml-2" />
                      )}
                    </Button>
                    {/* Questions - Teal Outline */}
                    <Button
                      onClick={onStartConversation}
                      variant="outline"
                      size="lg"
                      className="border-2 border-teal-300 text-teal-700 hover:bg-teal-50 shadow-lg rounded-xl h-14 font-bold text-base transform hover:scale-105 transition-all"
                    >
                      <MessageCircle
                        className={cn(
                          'w-5 h-5',
                          locale === 'he' ? 'ml-2' : 'mr-2'
                        )}
                      />
                      {dict.iHaveQuestions}
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>

            {(personalNote || matchingReason) && (
              // Insights Card - Orange/Teal
              <Card className="border-0 shadow-xl bg-gradient-to-br from-orange-50 to-teal-50 overflow-hidden">
                <CardContent className="p-6 relative">
                  <div
                    className={cn(
                      'flex items-start gap-4',
                      locale === 'he' ? 'flex-row-reverse' : 'flex-row'
                    )}
                  >
                    <div className="p-4 rounded-full bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg flex-shrink-0">
                      <Lightbulb className="w-7 h-7" />
                    </div>
                    <div
                      className={cn(
                        'flex-1',
                        locale === 'he' ? 'text-right' : 'text-left'
                      )}
                    >
                      <h3 className="font-bold text-orange-900 text-xl mb-4">
                        {dict.matchmakerInsight}
                      </h3>
                      {personalNote && (
                        // Personal Note - Orange tint
                        <div
                          className="mb-4 p-4 bg-white/70 rounded-xl shadow-inner border border-orange-100"
                          dir={locale === 'he' ? 'rtl' : 'ltr'}
                        >
                          <div
                            className={cn(
                              'flex items-start gap-2',
                              locale === 'he' ? 'flex-row-reverse' : 'flex-row'
                            )}
                          >
                            <Quote
                              className={cn(
                                'w-5 h-5 text-orange-500 mt-1 flex-shrink-0',
                                locale === 'he' ? 'ml-2' : 'mr-2'
                              )}
                            />
                            <div>
                              <h4
                                className={cn(
                                  'font-semibold text-orange-800 mb-2',
                                  locale === 'he' ? 'text-right' : 'text-left'
                                )}
                              >
                                {dict.whyYou}
                              </h4>
                              <p
                                className={cn(
                                  'text-orange-900 leading-relaxed italic font-medium',
                                  locale === 'he' ? 'text-right' : 'text-left'
                                )}
                              >
                                “{personalNote}”
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                      {matchingReason && (
                        // Matching Reason - Teal tint
                        <div
                          className="p-4 bg-white/70 rounded-xl shadow-inner border border-teal-100"
                          dir={locale === 'he' ? 'rtl' : 'ltr'}
                        >
                          <div
                            className={cn(
                              'flex items-start gap-2',
                              locale === 'he' ? 'flex-row-reverse' : 'flex-row'
                            )}
                          >
                            <Puzzle
                              className={cn(
                                'w-5 h-5 text-teal-500 mt-1 flex-shrink-0',
                                locale === 'he' ? 'ml-2' : 'mr-2'
                              )}
                            />
                            <div>
                              <h4
                                className={cn(
                                  'font-semibold text-teal-800 mb-2',
                                  locale === 'he' ? 'text-right' : 'text-left'
                                )}
                              >
                                {dict.ourConnection}
                              </h4>
                              <p
                                className={cn(
                                  'text-teal-900 leading-relaxed font-medium',
                                  locale === 'he' ? 'text-right' : 'text-left'
                                )}
                              >
                                “{matchingReason}”
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// --- Quick Actions Updated (Rose/Teal) ---
const EnhancedQuickActions: React.FC<{
  isExpanded: boolean;
  onToggleExpand: () => void;
  canAct: boolean;
  isSubmitting: boolean;
  onApprove: () => void;
  onDecline: () => void;
  onAskQuestion: () => void;
  locale: 'he' | 'en';
  dict: SuggestionsDictionary['modal']['actions'];
}> = ({
  isExpanded,
  onToggleExpand,
  canAct,
  isSubmitting,
  onApprove,
  onDecline,
  onAskQuestion,
  dict,
  locale,
}) => (
  <div
    className={cn(
      'flex-shrink-0 bg-gradient-to-r from-white via-teal-50/50 to-orange-50/50 backdrop-blur-sm border-t border-teal-100 transition-all duration-500 ease-in-out relative z-10',
      isExpanded ? 'p-4 md:p-6' : 'py-3 px-4 md:px-6'
    )}
  >
    <div className="max-w-4xl mx-auto relative z-10">
      <div
        className="flex justify-between items-center cursor-pointer group"
        onClick={onToggleExpand}
      >
        <div className="flex items-center gap-3">
          {/* Main Icon - Rose/Orange (Celebration) */}
          <div className="w-10 h-10 rounded-full bg-gradient-to-r from-rose-400 to-orange-500 flex items-center justify-center shadow-lg">
            <PartyPopper className="w-5 h-5 text-white" />
          </div>
          <div>
            <p className="text-base font-bold text-teal-900">
              {isExpanded ? dict.titleExpanded : dict.titleCollapsed}
            </p>
            {isExpanded && (
              <p className="text-sm text-gray-600 mt-1">{dict.subtitle}</p>
            )}
          </div>
        </div>
        <Button
          variant="ghost"
          size="icon"
          className="rounded-full h-10 w-10 text-teal-600 hover:bg-teal-100/50 group-hover:scale-110 transition-all"
        >
          {isExpanded ? (
            <ChevronDown className="w-5 h-5" />
          ) : (
            <ChevronUp className="w-5 h-5" />
          )}
        </Button>
      </div>
      {isExpanded && (
        <div className="mt-6 animate-in fade-in-50 slide-in-from-bottom-4 duration-500">
          <div className="grid grid-cols-1 gap-4 md:flex md:gap-6">
            {canAct && (
              // Approve - Teal/Emerald (Success)
              <Button
                className="relative w-full md:flex-1 bg-gradient-to-r from-teal-500 via-emerald-500 to-teal-600 hover:from-teal-600 hover:via-emerald-600 hover:to-teal-700 text-white shadow-2xl hover:shadow-3xl transition-all duration-300 rounded-2xl h-16 font-bold text-lg transform hover:scale-105"
                disabled={isSubmitting}
                onClick={onApprove}
              >
                {isSubmitting ? (
                  <>
                    <Loader2
                      className={cn(
                        'w-6 h-6 animate-spin',
                        locale === 'he' ? 'ml-3' : 'mr-3'
                      )}
                    />
                    <span>{dict.sending}</span>
                  </>
                ) : (
                  <>
                    <Heart
                      className={cn(
                        'w-6 h-6 animate-pulse',
                        locale === 'he' ? 'ml-3' : 'mr-3'
                      )}
                    />
                    <span>{dict.approve}</span>
                    <Sparkles
                      className={cn(
                        'w-5 h-5',
                        locale === 'he' ? 'mr-2' : 'ml-2'
                      )}
                    />
                  </>
                )}
              </Button>
            )}
            {/* Ask - Teal Outline */}
            <Button
              variant="outline"
              onClick={onAskQuestion}
              disabled={isSubmitting}
              className="w-full md:flex-1 border-2 border-teal-200 text-teal-700 hover:bg-teal-50 hover:border-teal-300 transition-all duration-300 rounded-2xl h-16 font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105"
            >
              <MessageCircle
                className={cn('w-6 h-6', locale === 'he' ? 'ml-3' : 'mr-3')}
              />
              <span>{dict.ask}</span>
            </Button>
            {canAct && (
              // Decline - Ghost/Rose hover
              <Button
                variant="ghost"
                className="w-full md:flex-1 text-gray-600 hover:bg-rose-50 hover:text-rose-700 transition-all duration-300 rounded-2xl h-16 font-bold text-lg transform hover:scale-105"
                disabled={isSubmitting}
                onClick={onDecline}
              >
                {isSubmitting ? (
                  <>
                    <Loader2
                      className={cn(
                        'w-5 h-5 animate-spin',
                        locale === 'he' ? 'ml-2' : 'mr-2'
                      )}
                    />
                    <span>{dict.updating}</span>
                  </>
                ) : (
                  <>
                    <XCircle
                      className={cn(
                        'w-5 h-5 text-rose-500',
                        locale === 'he' ? 'ml-3' : 'mr-3'
                      )}
                    />
                    <span>{dict.decline}</span>
                  </>
                )}
              </Button>
            )}
          </div>
          {canAct && (
            <p className="mt-4 text-center text-sm text-gray-600 leading-relaxed">
              <span className="font-semibold text-teal-600">💡</span>{' '}
              {dict.reminder}
            </p>
          )}
        </div>
      )}
    </div>
  </div>
);

// --- Tabs Updated (Orange/Rose/Teal) ---
const EnhancedTabsSection: React.FC<{
  activeTab: string;
  onTabChange: (tab: string) => void;
  onClose: () => void;
  isFullscreen: boolean;
  onToggleFullscreen: () => void;
  isMobile: boolean;
  isTransitioning?: boolean;
  dict: SuggestionsDictionary['modal']['tabs'];
}> = ({
  activeTab,
  onTabChange,
  onClose,
  isFullscreen,
  onToggleFullscreen,
  isMobile,
  isTransitioning = false,
  dict,
}) => (
  <div className="border-b border-teal-100 px-2 sm:px-6 pt-4 bg-gradient-to-r from-teal-50/80 to-orange-50/80 backdrop-blur-sm sticky top-0 z-20">
    <div className="flex items-center justify-between mb-4">
      <TabsList className="grid w-full grid-cols-4 bg-white/90 backdrop-blur-sm rounded-3xl p-2 h-20 shadow-xl border-2 border-teal-100 overflow-hidden">
        {/* Presentation - Rose/Orange */}
        <TabsTrigger
          value="presentation"
          className="flex flex-col items-center justify-center gap-1.5 rounded-2xl text-xs sm:text-sm data-[state=active]:bg-gradient-to-br data-[state=active]:from-rose-500 data-[state=active]:to-orange-500 data-[state=active]:text-white data-[state=active]:shadow-xl font-bold"
        >
          <Sparkles className="w-5 h-5 sm:w-6 sm:h-6" />
          <span className="hidden sm:inline">{dict.presentation}</span>
          <span className="sm:hidden">{dict.presentationShort}</span>
        </TabsTrigger>
        {/* Profile - Teal/Emerald */}
        <TabsTrigger
          value="profile"
          className="flex flex-col items-center justify-center gap-1.5 rounded-2xl text-xs sm:text-sm data-[state=active]:bg-gradient-to-br data-[state=active]:from-teal-500 data-[state=active]:to-emerald-500 data-[state=active]:text-white data-[state=active]:shadow-xl font-bold"
        >
          <User className="w-5 h-5 sm:w-6 sm:h-6" />
          <span className="hidden sm:inline">{dict.profile}</span>
          <span className="sm:hidden">{dict.profileShort}</span>
        </TabsTrigger>
        {/* Compatibility - Indigo/Teal */}
        <TabsTrigger
          value="compatibility"
          className="flex flex-col items-center justify-center gap-1.5 rounded-2xl text-xs sm:text-sm data-[state=active]:bg-gradient-to-br data-[state=active]:from-indigo-500 data-[state=active]:to-teal-500 data-[state=active]:text-white data-[state=active]:shadow-xl font-bold"
        >
          <GitCompareArrows className="w-5 h-5 sm:w-6 sm:h-6" />
          <span className="hidden sm:inline">{dict.compatibility}</span>
          <span className="sm:hidden">{dict.compatibilityShort}</span>
        </TabsTrigger>
        {/* Details - Slate */}
        <TabsTrigger
          value="details"
          className="flex flex-col items-center justify-center gap-1.5 rounded-2xl text-xs sm:text-sm data-[state=active]:bg-gradient-to-br data-[state=active]:from-slate-500 data-[state=active]:to-gray-500 data-[state=active]:text-white data-[state=active]:shadow-xl font-bold"
        >
          <Info className="w-5 h-5 sm:w-6 sm:h-6" />
          <span className="hidden sm:inline">{dict.details}</span>
          <span className="sm:hidden">{dict.detailsShort}</span>
        </TabsTrigger>
      </TabsList>
      <div className="flex items-center gap-2 ml-4">
        {!isMobile && (
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={onToggleFullscreen}
                  className="rounded-full h-12 w-12 text-teal-600 hover:text-teal-700 hover:bg-teal-50"
                  disabled={isTransitioning}
                >
                  {isFullscreen ? (
                    <Minimize className="w-6 h-6" />
                  ) : (
                    <Maximize className="w-6 h-6" />
                  )}
                </Button>
              </TooltipTrigger>
              <TooltipContent side="bottom">
                <p>{isFullscreen ? dict.exitFullscreen : dict.fullscreen}</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        )}
        <Button
          variant="ghost"
          size="icon"
          onClick={onClose}
          className="rounded-full h-12 w-12 text-gray-400 hover:text-gray-600 hover:bg-gray-100"
        >
          <X className="w-6 h-6" />
        </Button>
      </div>
    </div>
  </div>
);

const SuggestionDetailsModal: React.FC<SuggestionDetailsModalProps> = ({
  suggestion,
  userId,
  locale,
  isOpen,
  onClose,
  onActionRequest,
  questionnaire,
  isDemo = false,
  demoAnalysisData = null,
  dict,
}) => {
  const [activeTab, setActiveTab] = useState('presentation');
  const [showAskDialog, setShowAskDialog] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isQuestionnaireLoading, setIsQuestionnaireLoading] = useState(false);
  const [isActionsExpanded, setIsActionsExpanded] = useState(false);

  const isMobile = useIsMobile();
  const { isFullscreen, isTransitioning, toggleFullscreen } =
    useFullscreenModal(isOpen);
  const searchParams = useSearchParams();
  useEffect(() => {
    if (isOpen && (isMobile || isFullscreen)) {
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    };
  }, [isOpen, isMobile, isFullscreen]);

  useEffect(() => {
    if (isOpen) {
      const view = searchParams.get('view');
      setActiveTab(view === 'chat' ? 'details' : 'presentation');
      setIsActionsExpanded(false);
    }
  }, [isOpen, searchParams, suggestion?.id]);

  const isFirstParty = suggestion?.firstPartyId === userId;
  const targetParty = suggestion
    ? isFirstParty
      ? suggestion.secondParty
      : suggestion.firstParty
    : null;
  const profileWithUser = useMemo(() => {
    if (!targetParty || !targetParty.profile) {
      return null;
    }
    return {
      ...targetParty.profile,
      user: {
        firstName: targetParty.firstName,
        lastName: targetParty.lastName,
      },
    };
  }, [targetParty]);
  const canActOnSuggestion =
    (isFirstParty && suggestion?.status === 'PENDING_FIRST_PARTY') ||
    (!isFirstParty && suggestion?.status === 'PENDING_SECOND_PARTY');

  const handleSendQuestion = async (question: string) => {
    if (!suggestion) return;
    setIsSubmitting(true);
    try {
      await fetch(`/api/suggestions/${suggestion.id}/inquiries`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question }),
      });
      toast.success('Question sent!');
      setShowAskDialog(false);
    } catch (error) {
      toast.error('Failed to send question.');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!suggestion || !targetParty || !profileWithUser) return null;

  const handleApprove = () => {
    onActionRequest(suggestion, 'approve');
    onClose();
  };
  const handleDecline = () => {
    onActionRequest(suggestion, 'decline');
    onClose();
  };

  const getModalClasses = () => {
    const baseClasses =
      'p-0 shadow-2xl border-0 bg-white overflow-hidden z-[50] flex flex-col transition-all duration-300 ease-in-out';
    if (isMobile) {
      return `${baseClasses} !w-screen !h-screen !max-w-none !max-h-none !rounded-none !fixed !inset-0`;
    } else if (isFullscreen) {
      return `${baseClasses} !w-screen !h-screen !max-w-none !max-h-none !rounded-none !fixed !inset-0 !m-0 !translate-x-0 !translate-y-0 !transform-none`;
    } else {
      return `${baseClasses} md:max-w-7xl md:w-[95vw] md:h-[95vh] md:rounded-3xl`;
    }
  };
  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent
          className={cn(getModalClasses())}
          dir={locale === 'he' ? 'rtl' : 'ltr'}
          onOpenAutoFocus={(e) => e.preventDefault()}
          data-fullscreen={isFullscreen}
          data-mobile={isMobile}
        >
          <ScrollArea className="flex-grow min-h-0 modal-scroll">
            <Tabs
              value={activeTab}
              onValueChange={setActiveTab}
              className="h-full"
            >
              <EnhancedTabsSection
                activeTab={activeTab}
                onTabChange={setActiveTab}
                onClose={onClose}
                isFullscreen={isFullscreen}
                onToggleFullscreen={toggleFullscreen}
                isMobile={isMobile}
                isTransitioning={isTransitioning}
                dict={dict.suggestions.modal.tabs}
              />
              <TabsContent value="presentation" className="mt-0">
                <EnhancedHeroSection
                  matchmaker={suggestion.matchmaker}
                  targetParty={targetParty}
                  locale={locale}
                  personalNote={
                    isFirstParty
                      ? suggestion.firstPartyNotes
                      : suggestion.secondPartyNotes
                  }
                  matchingReason={suggestion.matchingReason}
                  onViewProfile={() => setActiveTab('profile')}
                  onStartConversation={() => setShowAskDialog(true)}
                  dict={dict.suggestions.modal.header}
                />
              </TabsContent>
              <TabsContent
                value="profile"
                className="mt-0 p-4 md:p-6 bg-gradient-to-br from-slate-50 to-teal-50"
              >
                {isQuestionnaireLoading ? (
                  <div className="flex justify-center items-center h-64">
                    <div className="text-center">
                      <Loader2 className="w-12 h-12 animate-spin text-teal-600 mx-auto mb-4" />
                      <p className="text-lg font-semibold text-gray-700">
                        {dict.suggestions.modal.profile.loading}
                      </p>
                      <p className="text-sm text-gray-500 mt-2">
                        {dict.suggestions.modal.profile.loadingDescription}
                      </p>
                    </div>
                  </div>
                ) : profileWithUser ? (
                  <ProfileCard
                    profile={profileWithUser}
                    isProfileComplete={targetParty.isProfileComplete}
                    images={targetParty.images}
                    questionnaire={questionnaire}
                    viewMode="candidate"
                    dict={dict.profileCard}
                    locale={locale}
                  />
                ) : (
                  <div className="text-center p-12">
                    <div className="w-24 h-24 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-6">
                      <AlertTriangle className="w-12 h-12 text-red-500" />
                    </div>
                    <h3 className="text-2xl font-bold text-gray-800 mb-4">
                      {dict.suggestions.modal.profile.errorTitle}
                    </h3>
                    <p className="text-gray-600 max-w-md mx-auto leading-relaxed">
                      {dict.suggestions.modal.profile.errorDescription}
                    </p>
                    <Button
                      onClick={() => setShowAskDialog(true)}
                      className="mt-6 bg-gradient-to-r from-orange-500 to-rose-500 text-white"
                    >
                      <MessageCircle className="w-4 h-4 ml-2" />
                      {dict.suggestions.modal.profile.contactMatchmaker}
                    </Button>
                  </div>
                )}
              </TabsContent>
              <TabsContent
                value="compatibility"
                className="mt-0 p-4 md:p-6 bg-gradient-to-br from-slate-50 to-indigo-50"
              >
                <div className="flex flex-col items-center justify-center h-full min-h-[600px] text-center space-y-8 p-6">
                  <div className="relative">
                    {/* Bot Icon - Teal */}
                    <div className="w-32 h-32 rounded-full bg-gradient-to-br from-teal-100 to-emerald-100 flex items-center justify-center mx-auto shadow-2xl">
                      <Bot className="w-16 h-16 text-teal-600" />
                    </div>
                    {/* Badge - Orange */}
                    <div className="absolute -top-4 -right-4 w-12 h-12 bg-gradient-to-r from-orange-400 to-amber-500 rounded-full flex items-center justify-center shadow-lg animate-bounce">
                      <Wand2 className="w-6 h-6 text-white" />
                    </div>
                  </div>
                  <div className="space-y-4 max-w-2xl">
                    <h3 className="text-3xl font-bold text-gray-800">
                      {dict.suggestions.modal.aiAnalysisCta.title}
                    </h3>
                    <p className="text-xl text-gray-600 leading-relaxed">
                      {dict.suggestions.modal.aiAnalysisCta.description}
                    </p>
                    <div className="flex items-center justify-center gap-4 text-sm text-gray-500 font-medium">
                      <div className="flex items-center gap-2">
                        <TrendingUp className="w-4 h-4 text-emerald-500" />
                        <span>
                          {dict.suggestions.modal.aiAnalysisCta.feature1}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Network className="w-4 h-4 text-teal-500" />
                        <span>
                          {dict.suggestions.modal.aiAnalysisCta.feature2}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Compass className="w-4 h-4 text-orange-500" />
                        <span>
                          {dict.suggestions.modal.aiAnalysisCta.feature3}
                        </span>
                      </div>
                    </div>
                  </div>
                  <UserAiAnalysisDialog
                    suggestedUserId={targetParty.id}
                    dict={dict.suggestions.aiAnalysis}
                    isDemo={isDemo}
                    demoAnalysisData={demoAnalysisData}
                    currentUserName={
                      isFirstParty
                        ? suggestion.firstParty.firstName
                        : suggestion.secondParty.firstName
                    }
                    suggestedUserName={targetParty.firstName}
                    locale={locale}
                  />
                </div>
              </TabsContent>
              <TabsContent
                value="details"
                className="mt-0 p-6 md:p-8 space-y-8 bg-gradient-to-br from-slate-50 to-gray-50"
              >
                <div className="max-w-6xl mx-auto space-y-8">
                  <SuggestionTimeline
                    statusHistory={suggestion.statusHistory}
                    dict={dict.suggestions.timeline}
                  />
                  <InquiryThreadView
                    suggestionId={suggestion.id}
                    userId={userId}
                    showComposer={true}
                    isDemo={isDemo}
                    dict={dict.suggestions.inquiryThread}
                  />
                </div>
              </TabsContent>
            </Tabs>
          </ScrollArea>
          <EnhancedQuickActions
            isExpanded={isActionsExpanded}
            onToggleExpand={() => setIsActionsExpanded((prev) => !prev)}
            canAct={canActOnSuggestion}
            isSubmitting={isSubmitting}
            onApprove={handleApprove}
            onDecline={handleDecline}
            onAskQuestion={() => setShowAskDialog(true)}
            dict={dict.suggestions.modal.actions}
            locale={locale}
          />
        </DialogContent>
      </Dialog>
      <AskMatchmakerDialog
        isOpen={showAskDialog}
        onClose={() => setShowAskDialog(false)}
        onSubmit={handleSendQuestion}
        matchmakerName={`${suggestion.matchmaker.firstName} ${suggestion.matchmaker.lastName}`}
        dict={dict.suggestions.askMatchmaker}
      />
    </>
  );
};

export default SuggestionDetailsModal;
--- End of Content for SuggestionDetailsModal.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\presentation
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\presentation\CompatibilityHighlights.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/presentation/CompatibilityHighlights.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Check, BookOpen, Scroll, MapPin, Heart } from 'lucide-react';
import { cn } from '@/lib/utils'; // Assuming cn utility is available or just use template literals

interface ProfileData {
  religiousLevel?: string | null;
  education?: string | null;
  city?: string | null;
  occupation?: string | null;
}

interface CompatibilityHighlightsProps {
  firstPartyProfile: ProfileData;
  secondPartyProfile: ProfileData;
  matchingReason?: string | null;
}

interface Highlight {
  icon: React.ElementType;
  title: string;
  description: string;
  color: 'teal' | 'orange' | 'rose' | 'emerald' | 'amber'; // Constrained to palette
}

// Helper to get classes based on color name
const getColorClasses = (color: string) => {
  const map: Record<string, string> = {
    teal: 'border-teal-200 bg-teal-50 text-teal-800 icon-bg-teal-500',
    orange: 'border-orange-200 bg-orange-50 text-orange-800 icon-bg-orange-500',
    rose: 'border-rose-200 bg-rose-50 text-rose-800 icon-bg-rose-500',
    emerald: 'border-emerald-200 bg-emerald-50 text-emerald-800 icon-bg-emerald-500',
    amber: 'border-amber-200 bg-amber-50 text-amber-800 icon-bg-amber-500',
  };
  return map[color] || map.teal;
};

const CompatibilityHighlights: React.FC<CompatibilityHighlightsProps> = ({ firstPartyProfile, secondPartyProfile, matchingReason }) => {
  const highlights: Highlight[] = [];

  // 1. Religious Level -> Teal (Faith/Knowledge)
  if (firstPartyProfile.religiousLevel && firstPartyProfile.religiousLevel === secondPartyProfile.religiousLevel) {
    highlights.push({ icon: Scroll, title: "השקפת עולם דומה", description: `שניכם הגדרתם את עצמכם כ: ${firstPartyProfile.religiousLevel}`, color: 'teal' });
  }

  // 2. Location -> Orange (Physical/Place)
  if (firstPartyProfile.city && firstPartyProfile.city === secondPartyProfile.city) {
    highlights.push({ icon: MapPin, title: "קירבה גיאוגרפית", description: `שניכם גרים ב${firstPartyProfile.city}`, color: 'orange' });
  }

  // 3. Education -> Amber (Achievement)
  if (firstPartyProfile.education && secondPartyProfile.education) {
     highlights.push({ icon: BookOpen, title: "רקע והשכלה", description: `רקע לימודי ותעסוקתי שמשתלב היטב`, color: 'amber' });
  }
  
  // 4. From matching reason text -> Rose (Heart/Personality)
  const reasonText = matchingReason?.toLowerCase() || '';
  if (reasonText.includes('אופי') || reasonText.includes('אישיות')) {
     highlights.push({ icon: Heart, title: "התאמה אישיותית", description: 'השדכן/ית זיהו פוטנציאל לחיבור עמוק ברמה האישית.', color: 'rose' });
  }

  if (highlights.length === 0) {
      // Default -> Emerald (Positive)
      highlights.push({ icon: Check, title: "פוטנציאל להתאמה", description: 'השדכן/ית זיהו כאן הזדמנות שכדאי לבדוק!', color: 'emerald' });
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-xl text-center">נקודות החיבור המרכזיות</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {highlights.slice(0, 3).map((item, index) => {
             const classes = getColorClasses(item.color);
             // Extracting the bg color for the icon from the string (simplified approach)
             const iconBgClass = `bg-${item.color}-500`; 

             return (
              <div key={index} className={cn("p-4 rounded-lg border-2 text-center transition-transform hover:scale-105", classes)}>
                <div className={cn("mx-auto w-12 h-12 rounded-full text-white flex items-center justify-center mb-3 shadow-lg", iconBgClass)}>
                  <item.icon className="w-6 h-6" />
                </div>
                <h4 className="font-bold text-lg">{item.title}</h4>
                <p className="text-sm opacity-80 mt-1">{item.description}</p>
              </div>
            );
          })}
        </div>
      </CardContent>
    </Card>
  );
};

export default CompatibilityHighlights;
--- End of Content for CompatibilityHighlights.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\presentation\MatchPresentationView.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/presentation/MatchPresentationView.tsx
'use client';
import React from 'react';
import Image from 'next/image';
import {
  Heart,
  Sparkles,
  User,
  GraduationCap,
  Scroll,
  MapPin,
  Briefcase,
  Quote,
  ChevronLeft,
  ChevronRight, // הוספתי לייבוא כי היה חסר בחלק מהמקרים
} from 'lucide-react';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { UserAiAnalysisDialog } from '../dialogs/UserAiAnalysisDialog';
import { getInitials } from '@/lib/utils';
import { cn } from '@/lib/utils';
import type { ExtendedMatchSuggestion } from '../types';
import type {
  SuggestionsPresentationDict,
  AiAnalysisDict,
} from '@/types/dictionary';

// --- Sub-components Updated ---

const HeroIntroduction: React.FC<{
  matchmaker: { firstName: string; lastName: string };
  personalNote?: string | null;
  dict: SuggestionsPresentationDict['hero'];
}> = ({ matchmaker, personalNote, dict }) => (
  // Background: Teal -> Orange -> Rose (Soft)
  <div className="text-center p-6 rounded-2xl bg-gradient-to-br from-teal-100/50 via-orange-100/50 to-rose-100/50 border border-teal-200/40 shadow-lg">
    <div className="flex justify-center mb-4">
      <Avatar className="w-16 h-16 border-4 border-white shadow-md">
        {/* Avatar: Teal Gradient */}
        <AvatarFallback className="bg-gradient-to-br from-teal-500 to-teal-600 text-white text-xl font-bold">
          {getInitials(`${matchmaker.firstName} ${matchmaker.lastName}`)}
        </AvatarFallback>
      </Avatar>
    </div>
    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 tracking-tight">
      {dict.title}
    </h2>
    <p className="text-gray-600 mt-2">
      {dict.matchmakerThoughts.replace('{{name}}', matchmaker.firstName)}
    </p>
    {personalNote && (
      <div className="mt-4 max-w-2xl mx-auto">
        {/* Quote Box: Orange Tint */}
        <div className="relative bg-white/60 p-4 rounded-xl shadow-inner border border-orange-100">
          <Quote className="absolute top-2 right-2 w-8 h-8 text-orange-200/80 transform scale-x-[-1]" />
          <p className="text-lg text-orange-900 italic font-medium leading-relaxed">
            {personalNote}
          </p>
          <Quote className="absolute bottom-2 left-2 w-8 h-8 text-orange-200/80" />
        </div>
      </div>
    )}
  </div>
);

const ProfilePeek: React.FC<{
  targetParty: ExtendedMatchSuggestion['secondParty'];
  onViewProfileClick: () => void;
  dict: SuggestionsPresentationDict['peek'];
  locale: 'he' | 'en'; // Added locale for direction
}> = ({ targetParty, onViewProfileClick, dict, locale }) => {
  const age = targetParty.profile?.birthDate
    ? new Date().getFullYear() -
      new Date(targetParty.profile.birthDate).getFullYear()
    : null;
  const mainImage = targetParty.images?.find((img) => img.isMain)?.url;
  return (
    <Card className="overflow-hidden shadow-xl transition-all hover:shadow-2xl border-0">
      <div className="grid grid-cols-1 md:grid-cols-3">
        <div className="relative h-64 md:h-auto">
          {mainImage ? (
            <Image
              src={mainImage}
              alt={`תמונה של ${targetParty.firstName}`}
              fill
              className="object-cover"
            />
          ) : (
            <div className="w-full h-full bg-slate-200 flex items-center justify-center">
              <User className="w-16 h-16 text-slate-400" />
            </div>
          )}
        </div>
        <div className="md:col-span-2 p-6 flex flex-col justify-between bg-white">
          <div>
            <p className="text-sm font-semibold text-teal-600">
              {dict.opportunity}
            </p>
            <h3 className="text-3xl font-extrabold text-gray-900 mt-1">
              {targetParty.firstName} {targetParty.lastName}
              {age && (
                <span className="text-2xl font-bold text-gray-500 mx-2">
                  {dict.age.replace('{{age}}', age.toString())}
                </span>
              )}
            </h3>
            <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
              <div className="flex items-center gap-2 text-gray-700">
                <MapPin className="w-4 h-4 text-orange-500" />
                <span>{targetParty.profile?.city || dict.notSpecified}</span>
              </div>
              <div className="flex items-center gap-2 text-gray-700">
                <Briefcase className="w-4 h-4 text-teal-500" />
                <span>
                  {targetParty.profile?.occupation || dict.notSpecified}
                </span>
              </div>
            </div>
          </div>
          <div className={cn("mt-6", locale === 'he' ? 'text-left' : 'text-right')}>
            <Button
              onClick={onViewProfileClick}
              size="lg"
              className="font-bold bg-teal-600 hover:bg-teal-700 text-white rounded-xl shadow-lg hover:shadow-xl transition-all"
            >
              {dict.viewProfileButton}
              {locale === 'he' ? <ChevronLeft className="w-5 h-5 mr-2" /> : <ChevronRight className="w-5 h-5 ml-2" />}
            </Button>
          </div>
        </div>
      </div>
    </Card>
  );
};

const KeyIngredients: React.FC<{
  matchingReason?: string | null;
  dict: SuggestionsPresentationDict['ingredients'];
}> = ({ matchingReason, dict }) => {
  const getHighlightsFromReason = () => {
    const highlights: { icon: React.ElementType; text: string }[] = [];
    const reason = matchingReason?.toLowerCase() || '';
    if (
      reason.includes('ערכים') ||
      reason.includes('השקפה') ||
      reason.includes('values')
    ) {
      highlights.push({ icon: Scroll, text: dict.values });
    }
    if (
      reason.includes('אישיות') ||
      reason.includes('אופי') ||
      reason.includes('personality')
    ) {
      highlights.push({ icon: Heart, text: dict.personality });
    }
    if (
      reason.includes('רקע') ||
      reason.includes('השכלה') ||
      reason.includes('background')
    ) {
      highlights.push({ icon: GraduationCap, text: dict.background });
    }
    if (highlights.length === 0 && matchingReason) {
      highlights.push({ icon: Sparkles, text: dict.spark });
    }
    return highlights;
  };

  const highlights = getHighlightsFromReason();

  if (highlights.length === 0) return null;

  return (
    <div className="text-center">
      <h3 className="text-2xl font-bold text-gray-800 mb-6">{dict.title}</h3>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {highlights.map((item, index) => (
          <div
            key={index}
            // Card: White with Orange Top Border
            className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500 transform transition-transform hover:-translate-y-2"
          >
            {/* Icon: Orange Light Background */}
            <div className="mx-auto w-14 h-14 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-4">
              <item.icon className="w-7 h-7" />
            </div>
            <h4 className="font-bold text-xl text-gray-800">{item.text}</h4>
          </div>
        ))}
      </div>
      {matchingReason && (
        // Notes Card: Teal Tint
        <Card className="mt-6 bg-teal-50 border-teal-200">
          <CardContent className="p-4">
            <p className="text-teal-900 text-center">
              <span className="font-semibold">{dict.matchmakerNotes}</span>{' '}
              {matchingReason}
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

// --- Main Component ---
interface MatchPresentationViewProps {
  suggestion: ExtendedMatchSuggestion;
  userId: string;
  onSwitchTab: (tab: 'profile' | 'details' | 'compatibility') => void;
  dict: SuggestionsPresentationDict;
  aiAnalysisDict: AiAnalysisDict;
  locale: 'he' | 'en';
}

const MatchPresentationView: React.FC<MatchPresentationViewProps> = ({
  suggestion,
  userId,
  onSwitchTab,
  dict,
  aiAnalysisDict,
  locale,
}) => {
  const isFirstParty = suggestion.firstPartyId === userId;
  const targetParty = isFirstParty
    ? suggestion.secondParty
    : suggestion.firstParty;
  
  const currentUserParty = isFirstParty
    ? suggestion.firstParty
    : suggestion.secondParty;

  const handleViewProfile = () => {
    onSwitchTab('profile');
  };

  return (
    <div className="p-4 md:p-8 space-y-8 bg-gradient-to-b from-slate-50 to-orange-50/20">
      <HeroIntroduction
        matchmaker={suggestion.matchmaker}
        personalNote={
          isFirstParty
            ? suggestion.firstPartyNotes
            : suggestion.secondPartyNotes
        }
        dict={dict.hero}
      />

      <ProfilePeek
        targetParty={targetParty}
        onViewProfileClick={handleViewProfile}
        dict={dict.peek}
        locale={locale}
      />

      <KeyIngredients
        matchingReason={suggestion.matchingReason}
        dict={dict.ingredients}
      />

      <div className="text-center pt-4 border-t border-gray-200">
        <h3 className="text-xl font-semibold text-gray-700 mb-3">
          {dict.aiCta.title}
        </h3>
        <p className="text-gray-600 max-w-xl mx-auto mb-4">
          {dict.aiCta.description}
        </p>
        <UserAiAnalysisDialog
          suggestedUserId={targetParty.id}
          dict={aiAnalysisDict}
          locale={locale}
          currentUserName={currentUserParty.firstName}
          suggestedUserName={targetParty.firstName}
        />
      </div>
    </div>
  );
};

export default MatchPresentationView;
--- End of Content for MatchPresentationView.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\presentation\MatchmakerRationale.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/presentation/MatchmakerRationale.tsx
import React from 'react';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Heart, Sparkles } from 'lucide-react';
import { getInitials } from '@/lib/utils';
import type { SuggestionsPresentationDict } from '@/types/dictionary';

interface MatchmakerRationaleProps {
  matchmaker: { firstName: string; lastName: string };
  generalReason?: string | null;
  personalNote?: string | null;
  dict: SuggestionsPresentationDict['rationale'];
}

const MatchmakerRationale: React.FC<MatchmakerRationaleProps> = ({
  matchmaker,
  generalReason,
  personalNote,
  dict,
}) => {
  const fullName = `${matchmaker.firstName} ${matchmaker.lastName}`;

  return (
    // Background: Teal -> Orange -> Rose
    <Card className="bg-gradient-to-br from-teal-50 via-orange-50 to-rose-50 shadow-xl border-teal-200/50">
      <CardHeader className="text-center">
        <div className="flex justify-center items-center gap-3 mb-3">
          <Avatar className="w-12 h-12 border-2 border-white shadow-lg">
            {/* Avatar: Teal */}
            <AvatarFallback className="bg-teal-500 text-white font-bold">
              {getInitials(fullName)}
            </AvatarFallback>
          </Avatar>
          <div>
            <CardDescription className="text-sm text-teal-800">
              {dict.description.replace('{{name}}', fullName)}
            </CardDescription>
            <CardTitle className="text-2xl font-bold text-gray-800">
              {dict.title}
            </CardTitle>
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-6 text-center">
        {personalNote && (
          // Personal Note: Rose Tint (Love/Heart)
          <div className="bg-white/70 p-4 rounded-xl shadow-inner border border-rose-100">
            <h3 className="font-semibold text-lg text-rose-700 flex items-center justify-center gap-2 mb-2">
              <Heart className="w-5 h-5" />
              {dict.personalNoteTitle}
            </h3>
            <p className="text-gray-700 text-base leading-relaxed italic">
              {personalNote}
            </p>
          </div>
        )}

        {generalReason && (
          // General Reason: Teal Tint (Sparkles/Magic)
          <div className="bg-white/70 p-4 rounded-xl shadow-inner border border-teal-100">
            <h3 className="font-semibold text-lg text-teal-700 flex items-center justify-center gap-2 mb-2">
              <Sparkles className="w-5 h-5" />
              {dict.generalReasonTitle}
            </h3>
            <p className="text-gray-600 text-base leading-relaxed">
              {generalReason}
            </p>
          </div>
        )}

        {!personalNote && !generalReason && (
          <p className="text-gray-500">{dict.noReasonText}</p>
        )}
      </CardContent>
    </Card>
  );
};

export default MatchmakerRationale;
--- End of Content for MatchmakerRationale.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\timeline
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\suggestions\timeline\SuggestionTimeline.tsx
--------------------------------------------------------------------------------
Content:
// src/components/suggestions/timeline/SuggestionTimeline.tsx

import React from 'react';
import { format, differenceInCalendarDays } from 'date-fns';
import { he } from 'date-fns/locale';
import {
  Clock,
  MessageCircle,
  User,
  Check,
  Zap,
  XCircle,
  Heart,
  Phone,
  Calendar,
  Users,
  Award,
  Star,
  TimerOff,
  Edit3,
  UserX,
  Archive,
  Ban,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent } from '@/components/ui/card';
import type { MatchSuggestionStatus } from '@prisma/client';
import type { SuggestionTimelineDict } from '@/types/dictionary';

interface StatusHistoryItem {
  id: string;
  status: string;
  notes?: string | null;
  createdAt: Date | string;
}

interface SuggestionTimelineProps {
  statusHistory: StatusHistoryItem[];
  className?: string;
  dict: SuggestionTimelineDict;
}

const getStatusVisuals = (status: MatchSuggestionStatus) => {
  const statusMap: {
    [key in MatchSuggestionStatus]?: {
      icon: React.ElementType;
      category: string;
    };
  } = {
    DRAFT: { icon: Edit3, category: 'pending' },
    PENDING_FIRST_PARTY: { icon: User, category: 'pending' },
    PENDING_SECOND_PARTY: { icon: User, category: 'pending' },
    FIRST_PARTY_APPROVED: { icon: Check, category: 'approved' },
    SECOND_PARTY_APPROVED: { icon: Check, category: 'approved' },
    FIRST_PARTY_DECLINED: { icon: XCircle, category: 'declined' },
    SECOND_PARTY_DECLINED: { icon: XCircle, category: 'declined' },
    AWAITING_MATCHMAKER_APPROVAL: { icon: Zap, category: 'progress' },
    CONTACT_DETAILS_SHARED: { icon: Phone, category: 'progress' },
    AWAITING_FIRST_DATE_FEEDBACK: { icon: MessageCircle, category: 'progress' },
    THINKING_AFTER_DATE: { icon: Clock, category: 'pending' },
    PROCEEDING_TO_SECOND_DATE: { icon: Heart, category: 'approved' },
    ENDED_AFTER_FIRST_DATE: { icon: UserX, category: 'declined' },
    MEETING_PENDING: { icon: Calendar, category: 'progress' },
    MEETING_SCHEDULED: { icon: Calendar, category: 'progress' },
    MATCH_APPROVED: { icon: Award, category: 'completed' },
    MATCH_DECLINED: { icon: XCircle, category: 'declined' },
    DATING: { icon: Heart, category: 'completed' },
    ENGAGED: { icon: Star, category: 'completed' },
    MARRIED: { icon: Star, category: 'completed' },
    EXPIRED: { icon: TimerOff, category: 'declined' },
    CLOSED: { icon: Archive, category: 'declined' },
    CANCELLED: { icon: Ban, category: 'declined' },
  };
  return statusMap[status] || { icon: Clock, category: 'default' };
};

// Updated Category Border Colors
const getCategoryColor = (category: string) => {
  switch (category) {
    case 'pending':
      return 'border-orange-200'; // Waiting -> Orange
    case 'approved':
      return 'border-teal-200'; // Approved -> Teal
    case 'progress':
      return 'border-blue-200'; // Progress -> Blue
    case 'completed':
      return 'border-amber-200'; // Completed -> Amber (Gold)
    case 'declined':
      return 'border-rose-200'; // Declined -> Rose
    default:
      return 'border-gray-200';
  }
};

const TimelineNode: React.FC<{
  IconComponent: React.ElementType;
  isLatest: boolean;
  isLast: boolean;
  category: string;
}> = ({ IconComponent, isLatest, isLast, category }) => {
  // Updated Gradient Map to match Hero Palette
  const gradientMap: { [key: string]: string } = {
    pending: 'bg-gradient-to-br from-orange-400 to-amber-500', // Orange/Amber
    approved: 'bg-gradient-to-br from-teal-400 to-emerald-500', // Teal/Emerald
    progress: 'bg-gradient-to-br from-blue-400 to-teal-500', // Blue/Teal
    completed: 'bg-gradient-to-br from-amber-400 to-yellow-500', // Amber/Gold
    declined: 'bg-gradient-to-br from-rose-400 to-red-500', // Rose/Red
    default: 'bg-gradient-to-br from-gray-400 to-gray-500',
  };

  return (
    <div className="relative flex items-center">
      {!isLast && (
        <div
          className={cn(
            'absolute top-12 right-6 w-0.5 h-16 bg-gradient-to-b rounded-full',
            // Connecting Line: Teal for active, Gray for past
            isLatest ? 'from-teal-300 to-teal-100' : 'from-gray-300 to-gray-100'
          )}
        />
      )}
      <div
        className={cn(
          'relative z-10 w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-white',
          gradientMap[category],
          // Active Ring: Teal
          isLatest && 'ring-4 ring-teal-200 animate-pulse-subtle'
        )}
      >
        <IconComponent className="w-6 h-6" />
      </div>
    </div>
  );
};

const SuggestionTimeline: React.FC<SuggestionTimelineProps> = ({
  statusHistory,
  className,
  dict,
}) => {
  const sortedHistory = [...statusHistory].sort(
    (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
  );

  if (sortedHistory.length === 0) {
    return (
      <Card className={cn('border-0 shadow-lg', className)}>
        <CardContent className="p-8 text-center">
          <Clock className="w-12 h-12 mx-auto mb-4 text-gray-400" />
          <h3 className="text-lg font-semibold text-gray-600 mb-2">
            {dict.emptyState.title}
          </h3>
          <p className="text-gray-500">{dict.emptyState.description}</p>
        </CardContent>
      </Card>
    );
  }

  const latestStatusVisuals = getStatusVisuals(
    sortedHistory[0].status as MatchSuggestionStatus
  );

  return (
    <Card className={cn('border-0 shadow-lg overflow-hidden', className)}>
      <CardContent className="p-6">
        <div className="flex items-center gap-3 mb-6">
          {/* Header Icon: Teal Gradient */}
          <div className="p-2 rounded-lg bg-gradient-to-r from-teal-500 to-emerald-500 text-white shadow-md">
            <Clock className="w-5 h-5" />
          </div>
          <div>
            <h3 className="text-xl font-bold text-gray-800">{dict.title}</h3>
            <p className="text-sm text-gray-600">{dict.subtitle}</p>
          </div>
        </div>
        <div className="space-y-6">
          {sortedHistory.map((item, index) => {
            const statusKey = item.status as MatchSuggestionStatus;
            const statusInfo = dict.statuses[statusKey] || {
              label: item.status,
              description: '',
            };
            const statusVisuals = getStatusVisuals(statusKey);
            const isLatest = index === 0;
            const isLast = index === sortedHistory.length - 1;
            const formattedDate = format(
              new Date(item.createdAt),
              'dd בMMMM yyyy',
              { locale: he }
            );
            const formattedTime = format(new Date(item.createdAt), 'HH:mm', {
              locale: he,
            });

            return (
              <div key={item.id} className="flex gap-4">
                <TimelineNode
                  IconComponent={statusVisuals.icon}
                  isLatest={isLatest}
                  isLast={isLast}
                  category={statusVisuals.category}
                />
                <div className="flex-1 pb-4">
                  <Card
                    className={cn(
                      'border-2 transition-all duration-300 hover:shadow-md',
                      getCategoryColor(statusVisuals.category),
                      isLatest && 'shadow-md'
                    )}
                  >
                    <CardContent className="p-4">
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <Badge
                              className={cn('border-0 shadow-sm font-semibold')}
                            >
                              {statusInfo.label}
                            </Badge>
                            {isLatest && (
                              <Badge
                                variant="outline"
                                className="bg-white/80 text-teal-600 border-teal-200 text-xs"
                              >
                                {dict.latestBadge}
                              </Badge>
                            )}
                          </div>
                          <p className="text-sm font-medium mb-2">
                            {statusInfo.description}
                          </p>
                        </div>
                        <div className="text-left text-xs text-gray-500 space-y-1">
                          <div className="font-medium">{formattedDate}</div>
                          <div className="flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {formattedTime}
                          </div>
                        </div>
                      </div>
                      {item.notes && (
                        <div className="mt-3 p-3 bg-white/60 backdrop-blur-sm rounded-lg border border-white/40">
                          <div className="flex items-start gap-2">
                            <MessageCircle className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
                            <p className="text-sm text-gray-700 leading-relaxed">
                              {item.notes}
                            </p>
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>
              </div>
            );
          })}
        </div>
        <div className="mt-8 pt-6 border-t border-gray-200">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            {/* Stats Colors Updated */}
            <div className="space-y-1">
              <div className="text-2xl font-bold text-teal-600">
                {sortedHistory.length}
              </div>
              <div className="text-xs text-gray-500 font-medium">
                {dict.summary.totalSteps}
              </div>
            </div>
            <div className="space-y-1">
              <div className="text-2xl font-bold text-emerald-600">
                {differenceInCalendarDays(
                  new Date(),
                  new Date(sortedHistory[sortedHistory.length - 1].createdAt)
                ) + 1}
              </div>
              <div className="text-xs text-gray-500 font-medium">
                {dict.summary.activeDays}
              </div>
            </div>
            <div className="space-y-1">
              <div className="text-2xl font-bold text-blue-600">
                {
                  sortedHistory.filter((s) => s.status.includes('APPROVED'))
                    .length
                }
              </div>
              <div className="text-xs text-gray-500 font-medium">
                {dict.summary.approvals}
              </div>
            </div>
            <div className="space-y-1">
              <div className="text-2xl font-bold text-amber-600">
                {latestStatusVisuals.category === 'completed'
                  ? '🎉'
                  : latestStatusVisuals.category === 'progress'
                    ? '⏳'
                    : latestStatusVisuals.category === 'approved'
                      ? '✅'
                      : '📋'}
              </div>
              <div className="text-xs text-gray-500 font-medium">
                {dict.summary.currentStatus}
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default SuggestionTimeline;
--- End of Content for SuggestionTimeline.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\CookieBanner.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/CookieBanner.tsx
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { Button } from './button';
import { Shield, X, Cookie } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import type { CookieBannerDict } from '@/types/dictionary';

// --- Type Definition for Component Props ---
interface CookieBannerProps {
  dict: CookieBannerDict;
}

const CookieBanner: React.FC<CookieBannerProps> = ({ dict }) => {
  const [consent, setConsent] = useState<string | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    const storedConsent = localStorage.getItem('cookie_consent');
    setConsent(storedConsent);

    if (!storedConsent) {
      const timer = setTimeout(() => setIsVisible(true), 1000);
      return () => clearTimeout(timer);
    }
  }, []);

  const handleAccept = () => {
    setConsent('true');
    localStorage.setItem('cookie_consent', 'true');
    setIsVisible(false);
    // Reload to apply analytics scripts if they depend on consent
    window.location.reload();
  };

  const handleDecline = () => {
    setConsent('false');
    localStorage.setItem('cookie_consent', 'false');
    setIsVisible(false);
  };

  const handleDismiss = () => {
    setIsVisible(false);
  };

  if (consent === 'true' || consent === 'false') {
    return null;
  }

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ opacity: 0, y: 100 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: 100 }}
          transition={{
            type: 'spring',
            stiffness: 300,
            damping: 30,
            duration: 0.6,
          }}
          className="fixed bottom-0 left-0 right-0 z-[100] pointer-events-none"
        >
          <div className="absolute inset-0 bg-gradient-to-t from-slate-900/95 via-slate-800/90 to-transparent backdrop-blur-md pointer-events-none" />

          <div className="relative pointer-events-auto">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <motion.div
                initial={{ scale: 0.95 }}
                animate={{ scale: 1 }}
                transition={{ delay: 0.2 }}
                className="relative bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/20 p-6 md:p-8"
              >
                <div className="absolute inset-0 bg-gradient-to-br from-cyan-50/80 via-white/90 to-pink-50/80 rounded-2xl" />
                <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-cyan-200/20 to-transparent rounded-full transform translate-x-16 -translate-y-16" />
                <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-pink-200/20 to-transparent rounded-full transform -translate-x-12 translate-y-12" />

                <button
                  onClick={handleDismiss}
                  className="absolute top-4 left-4 p-2 rounded-full bg-gray-100/80 hover:bg-gray-200/80 transition-colors duration-200 group"
                  aria-label={dict.aria_close}
                >
                  <X className="w-4 h-4 text-gray-600 group-hover:text-gray-800" />
                </button>

                <div className="relative grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                  <div className="lg:col-span-2 flex items-start gap-4">
                    <motion.div
                      initial={{ rotate: -10, scale: 0.8 }}
                      animate={{ rotate: 0, scale: 1 }}
                      transition={{
                        delay: 0.3,
                        type: 'spring',
                        stiffness: 200,
                      }}
                      className="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-cyan-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg"
                    >
                      <Cookie className="w-6 h-6 text-white" />
                    </motion.div>

                    <div className="flex-1 min-w-0">
                      <motion.h3
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.4 }}
                        className="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2"
                      >
                        <Shield className="w-5 h-5 text-cyan-600" />
                        {dict.title}
                      </motion.h3>

                      <motion.p
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.5 }}
                        className="text-gray-700 leading-relaxed text-sm md:text-base"
                      >
                        {dict.text_part1}
                        <Link
                          href="/legal/privacy-policy"
                          className="text-cyan-600 hover:text-cyan-700 font-medium mx-1 underline decoration-2 underline-offset-2 hover:decoration-cyan-700 transition-colors"
                        >
                          {dict.privacy_policy_link}
                        </Link>
                        {dict.text_part2}
                      </motion.p>
                    </div>
                  </div>

                  <motion.div
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.6 }}
                    className="flex flex-col sm:flex-row lg:flex-col gap-3 lg:items-stretch"
                  >
                    <Button
                      onClick={handleAccept}
                      className="relative overflow-hidden bg-gradient-to-r from-cyan-500 to-pink-500 hover:from-cyan-600 hover:to-pink-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 group flex-1 lg:flex-none"
                    >
                      <span className="relative z-10 font-semibold">
                        {dict.accept_button}
                      </span>
                      <div className="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                    </Button>

                    <Button
                      onClick={handleDecline}
                      variant="outline"
                      className="border-2 border-gray-300 text-gray-700 bg-white/80 hover:bg-gray-50 hover:border-gray-400 rounded-xl transition-all duration-300 flex-1 lg:flex-none"
                    >
                      <span className="font-medium">{dict.decline_button}</span>
                    </Button>
                  </motion.div>
                </div>

                <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-20 h-1 bg-gradient-to-r from-cyan-400 via-pink-400 to-cyan-400 rounded-full" />
              </motion.div>
            </div>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default CookieBanner;
--- End of Content for CookieBanner.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\ProfileModal.tsx
--------------------------------------------------------------------------------
Content:
import React, { ReactNode } from 'react';
import { Dialog } from '@/components/ui/dialog';
import { DialogContent } from '@/components/ui/dialog';

interface ProfileModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: ReactNode;
}

const ProfileModal = ({ isOpen, onClose, children }: ProfileModalProps) => {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-h-[80vh] overflow-y-auto sm:max-w-2xl">
        {children}
      </DialogContent>
    </Dialog>
  );
};

export default ProfileModal;
--- End of Content for ProfileModal.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\SimpleToast.tsx
--------------------------------------------------------------------------------
Content:
import React from 'react';
import { cn } from "@/lib/utils";

interface ToastProps {
  message: string;
  type?: 'success' | 'error' | 'info';
  onClose?: () => void;
  isVisible: boolean;
}

export function SimpleToast({ message, type = 'info', onClose, isVisible }: ToastProps) {
  if (!isVisible) return null;

  const baseClasses = "fixed bottom-4 left-4 p-4 rounded-md shadow-lg z-50 transition-all duration-300";
  const typeClasses = {
    success: "bg-green-500 text-white",
    error: "bg-red-500 text-white",
    info: "bg-blue-500 text-white"
  };

  return (
    <div className={cn(baseClasses, typeClasses[type])}>
      <div className="flex items-center justify-between">
        <p>{message}</p>
        {onClose && (
          <button
            onClick={onClose}
            className="ml-4 text-white hover:text-gray-200"
          >
            ×
          </button>
        )}
      </div>
    </div>
  );
}
--- End of Content for SimpleToast.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\VisibilityToggleButton.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/VisibilityToggleButton.tsx (ייתכן שהנתיב מעט שונה אצלך)

'use client';

import { Button } from '@/components/ui/button';
import { Eye, EyeOff } from 'lucide-react';
import { cn } from '@/lib/utils';

interface VisibilityToggleButtonProps {
  isVisible: boolean;
  onToggle: () => void;
  disabled?: boolean;
  // --- START: הוספת props חדשים ---
  visibleText: string;
  hiddenText: string;
  // --- END: הוספת props חדשים ---
}

export const VisibilityToggleButton: React.FC<VisibilityToggleButtonProps> = ({
  isVisible,
  onToggle,
  disabled,
  // --- START: קבלת ה-props החדשים ---
  visibleText,
  hiddenText,
  // --- END: קבלת ה-props החדשים ---
}) => {
  const text = isVisible ? visibleText : hiddenText;
  const Icon = isVisible ? Eye : EyeOff;

  return (
    <Button
      type="button"
      role="switch"
      aria-checked={isVisible}
      variant="outline"
      size="sm"
      onClick={onToggle}
      disabled={disabled}
      className={cn(
        'flex items-center gap-2 rounded-full transition-all duration-200 text-xs',
        isVisible
          ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100'
          : 'bg-slate-100 text-slate-600 border-slate-200 hover:bg-slate-200'
      )}
    >
      <Icon className="h-4 w-4" />
      <span className="font-medium">{text}</span>
    </Button>
  );
};
--- End of Content for VisibilityToggleButton.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\accordion.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion";
import { ChevronDown } from "lucide-react";
import { cn } from "@/lib/utils";

const Accordion = AccordionPrimitive.Root;

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
));
AccordionItem.displayName = "AccordionItem";

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
));
AccordionTrigger.displayName = "AccordionTrigger";

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className={cn(
      "overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",
      className
    )}
    {...props}
  >
    <div className="pb-4 pt-0">{children}</div>
  </AccordionPrimitive.Content>
));
AccordionContent.displayName = "AccordionContent";

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };
--- End of Content for accordion.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\alert-dialog.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/ui/alert-dialog.tsx
"use client";

import React, { 
  createContext, 
  useContext, 
  useCallback, 
  useState, 
  cloneElement, 
  isValidElement 
} from "react";
import { cn } from "@/lib/utils";

// --- Context Definition ---
type AlertDialogContextType = {
  open: boolean;
  setOpen: (open: boolean) => void;
};

const AlertDialogContext = createContext<AlertDialogContextType | undefined>(undefined);

const useAlertDialog = () => {
  const context = useContext(AlertDialogContext);
  if (!context) {
    throw new Error("useAlertDialog must be used within an AlertDialog provider");
  }
  return context;
};

// --- Main AlertDialog Component (The Provider) ---
type AlertDialogProps = {
  children: React.ReactNode;
  open?: boolean; 
  onOpenChange?: (open: boolean) => void;
};

const AlertDialog = ({
  children,
  open: controlledOpen,
  onOpenChange
}: AlertDialogProps) => { // הסר את ': JSX.Element'
  const [internalOpen, setInternalOpen] = useState(false);

  const isControlled = controlledOpen !== undefined;
  const open = isControlled ? controlledOpen : internalOpen;

  const setOpen = useCallback((newOpen: boolean) => {
    if (!isControlled) {
      setInternalOpen(newOpen);
    }
    onOpenChange?.(newOpen);
  }, [isControlled, onOpenChange]);

  const contextValue = {
    open,
    setOpen,
  };

  return (
    <AlertDialogContext.Provider value={contextValue}>
      {children}
    </AlertDialogContext.Provider>
  );
};


// --- AlertDialogTrigger Component (Corrected) ---
interface AlertDialogTriggerProps extends React.HTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode;
  asChild?: boolean;
}

const AlertDialogTrigger = React.forwardRef<HTMLButtonElement, AlertDialogTriggerProps>(
  ({ children, asChild = false, ...props }, ref) => {
    const { setOpen } = useAlertDialog();

    if (asChild) {
      if (isValidElement(children)) {
        // By casting 'children' here, we inform TypeScript that it's a valid React element
        // with a 'props' object, which resolves the chain of type errors.
        const child = children as React.ReactElement<any>;
        
        return cloneElement(
          child,
          {
            ...props,
            ...child.props,
            ref,
            onClick: (event: React.MouseEvent<HTMLElement>) => {
              // Call the child's own onClick handler if it exists.
              child.props.onClick?.(event);
              // If the event wasn't prevented by the child's handler, run our logic.
              if (!event.defaultPrevented) {
                setOpen(true);
              }
            },
          }
        );
      }
    }

    return (
      <button
        ref={ref}
        onClick={() => setOpen(true)}
        {...props}
      >
        {children}
      </button>
    );
  }
);
AlertDialogTrigger.displayName = "AlertDialogTrigger";


// --- AlertDialogContent Component (The Dialog itself) ---
const AlertDialogContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, children, ...props }, ref) => {
    const { open } = useAlertDialog();

    if (!open) return null;

    return (
      <>
        {/* Overlay */}
        <div className="fixed inset-0 z-50 bg-black/80 animate-in fade-in-0" />
        
        {/* Dialog Content */}
        <div
          ref={ref}
          className={cn(
            "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 animate-in fade-in-0 zoom-in-95 slide-in-from-left-1/2 slide-in-from-top-[48%] sm:rounded-lg",
            className
          )}
          {...props}
        >
          {children}
        </div>
      </>
    );
  }
);
AlertDialogContent.displayName = "AlertDialogContent";

// --- Other structural components ---
const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("flex flex-col space-y-2 text-center sm:text-left", className)}
    {...props}
  />
);
AlertDialogHeader.displayName = "AlertDialogHeader";

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 rtl:space-x-reverse", className)}
    {...props}
  />
);
AlertDialogFooter.displayName = "AlertDialogFooter";

const AlertDialogTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h2
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
));
AlertDialogTitle.displayName = "AlertDialogTitle";

const AlertDialogDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
AlertDialogDescription.displayName = "AlertDialogDescription";

// --- Action and Cancel Buttons ---
const AlertDialogAction = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement>
>(({ className, onClick, ...props }, ref) => {
  const { setOpen } = useAlertDialog();
  
  return (
    <button
      ref={ref}
      className={cn("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2", className)}
      onClick={(e) => {
        onClick?.(e);
        setOpen(false);
      }}
      {...props}
    />
  );
});
AlertDialogAction.displayName = "AlertDialogAction";

const AlertDialogCancel = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement>
>(({ className, onClick, ...props }, ref) => {
  const { setOpen } = useAlertDialog();
  
  return (
    <button
      ref={ref}
      className={cn("mt-2 sm:mt-0 inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2", className)}
      onClick={(e) => {
        onClick?.(e);
        setOpen(false);
      }}
      {...props}
    />
  );
});
AlertDialogCancel.displayName = "AlertDialogCancel";

// --- Final Exports ---
export {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};
--- End of Content for alert-dialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\alert.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
));
Alert.displayName = "Alert";

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
));
AlertTitle.displayName = "AlertTitle";

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
));
AlertDescription.displayName = "AlertDescription";

export { Alert, AlertTitle, AlertDescription };
--- End of Content for alert.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\avatar.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import * as AvatarPrimitive from "@radix-ui/react-avatar";

import { cn } from "@/lib/utils";

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
));
Avatar.displayName = AvatarPrimitive.Root.displayName;

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
));
AvatarImage.displayName = AvatarPrimitive.Image.displayName;

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
));
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName;

export { Avatar, AvatarImage, AvatarFallback };
--- End of Content for avatar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\badge.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/badge.tsx
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
        success:
          "border-transparent bg-green-500 text-white hover:bg-green-600",
        warning:
          "border-transparent bg-yellow-500 text-white hover:bg-yellow-600",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  );
}

export { Badge, badgeVariants };
--- End of Content for badge.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\button.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/button.tsx
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
        // הוספת האפשרות xs
        xs: "h-7 rounded-md px-2.5 text-xs", // אפשר להתאים את הערכים לפי הצורך
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
Button.displayName = "Button";

export { Button, buttonVariants };
--- End of Content for button.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\calendar.tsx
--------------------------------------------------------------------------------
Content:
import React, { useEffect, useState } from "react";
import { DayPicker, DayPickerProps } from "react-day-picker";
import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";
import "react-day-picker/dist/style.css";

export type CalendarProps = DayPickerProps;

export function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  // Fix for server-side rendering
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) {
    return null;
  }

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-gray-500 rounded-md w-9 font-normal text-[0.8rem] dark:text-gray-400",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-gray-100/50 [&:has([aria-selected])]:bg-gray-100 first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20 dark:[&:has([aria-selected].day-outside)]:bg-gray-800/50 dark:[&:has([aria-selected])]:bg-gray-800",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-50",
        day_outside:
          "day-outside text-gray-500 opacity-50 aria-selected:bg-gray-100/50 aria-selected:text-gray-500 aria-selected:opacity-30 dark:text-gray-400 dark:aria-selected:bg-gray-800/50 dark:aria-selected:text-gray-400",
        day_disabled: "text-gray-500 opacity-50 dark:text-gray-400",
        day_range_middle:
          "aria-selected:bg-gray-100 aria-selected:text-gray-900 dark:aria-selected:bg-gray-800 dark:aria-selected:text-gray-50",
        day_hidden: "invisible",
        ...classNames,
      }}
      {...props}
    />
  );
}
--- End of Content for calendar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\card.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import { cn } from "@/lib/utils";

type CardProps = React.HTMLAttributes<HTMLDivElement>;

const CardFooter = React.forwardRef<HTMLDivElement, CardProps>((props, ref) => {
  const { className, ...rest } = props;
  return (
    <div
      ref={ref}
      className={cn("flex items-center p-6 pt-0", className)}
      {...rest}
    />
  );
});

CardFooter.displayName = "CardFooter";

const Card = React.forwardRef<HTMLDivElement, CardProps>((props, ref) => {
  const { className, ...rest } = props;
  return (
    <div
      ref={ref}
      className={cn(
        "rounded-xl border bg-card text-card-foreground shadow",
        className
      )}
      {...rest}
    />
  );
});

const CardHeader = React.forwardRef<HTMLDivElement, CardProps>((props, ref) => {
  const { className, ...rest } = props;
  return (
    <div
      ref={ref}
      className={cn("flex flex-col space-y-1.5 p-6", className)}
      {...rest}
    />
  );
});

const CardTitle = React.forwardRef<
  HTMLHeadingElement,
  React.HTMLAttributes<HTMLHeadingElement>
>((props, ref) => {
  const { className, ...rest } = props;
  return (
    <h3
      ref={ref}
      className={cn("font-semibold leading-none tracking-tight", className)}
      {...rest}
    />
  );
});

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>((props, ref) => {
  const { className, ...rest } = props;
  return (
    <p
      ref={ref}
      className={cn("text-sm text-muted-foreground", className)}
      {...rest}
    />
  );
});

const CardContent = React.forwardRef<HTMLDivElement, CardProps>(
  (props, ref) => {
    const { className, ...rest } = props;
    return <div ref={ref} className={cn("p-6 pt-0", className)} {...rest} />;
  }
);

Card.displayName = "Card";
CardHeader.displayName = "CardHeader";
CardTitle.displayName = "CardTitle";
CardContent.displayName = "CardContent";
CardDescription.displayName = "CardDescription";

export {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  CardFooter,
  CardDescription,
};
--- End of Content for card.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\checkbox.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
--- End of Content for checkbox.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\collapsible.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/collapsible.tsx
"use client";

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

const Collapsible = CollapsiblePrimitive.Root;

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger;

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent;

export { Collapsible, CollapsibleTrigger, CollapsibleContent };
--- End of Content for collapsible.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\command.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import { DialogProps } from "@radix-ui/react-dialog";
import { Command as CommandPrimitive } from "cmdk";
import { cn } from "@/lib/utils";
import { Dialog, DialogContent } from "@/components/ui/dialog";

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
));
Command.displayName = CommandPrimitive.displayName;

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Input
    ref={ref}
    className={cn(
      "flex h-10 w-full rounded-md bg-transparent px-3 py-2 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
      className
    )}
    {...props}
  />
));
CommandInput.displayName = CommandPrimitive.Input.displayName;

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
));
CommandList.displayName = CommandPrimitive.List.displayName;

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
));
CommandEmpty.displayName = CommandPrimitive.Empty.displayName;

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
));
CommandGroup.displayName = CommandPrimitive.Group.displayName;

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
));
CommandSeparator.displayName = CommandPrimitive.Separator.displayName;

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  />
));
CommandItem.displayName = CommandPrimitive.Item.displayName;

// Removed the empty interface and directly used DialogProps
const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
};

export {
  Command,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandSeparator,
  CommandDialog,
};
--- End of Content for command.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\date-picker.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/date-picker.tsx (או הנתיב שלך)
"use client"; // אם רלוונטי לסביבה שלך

import React, { useState, useMemo } from "react";
import { format } from "date-fns";
import { he } from "date-fns/locale"; // Locale מ-date-fns
import { Calendar as CalendarIcon } from "lucide-react";
import { cn } from "@/lib/utils"; // ודא שהנתיב נכון
import { Button } from "@/components/ui/button";
import { Calendar, CalendarProps } from "@/components/ui/calendar"; // CalendarProps הוא בעצם DayPickerProps
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import type {
  DateRange,
  SelectRangeEventHandler,
  SelectSingleEventHandler,
  // אין צורך לייבא טיפוסים נוספים מ-react-day-picker לצורך CommonOnlyCalendarProps בגישת ה-Pick
} from "react-day-picker";

interface DatePickerProps {
  value?: {
    from?: Date;
    to?: Date; // ישמש רק אם isRange=true
  };
  onChange?: (date: { from: Date | undefined; to: Date | undefined }) => void;
  isRange?: boolean;
  placeholder?: string;
  className?: string;
  disabled?: CalendarProps["disabled"]; // CalendarProps["disabled"] הוא Matcher | Matcher[] | ...
}

// הגדרת טיפוס למאפיינים המשותפים באמצעות Pick
// נבחר במפורש את המאפיינים שאנו רוצים שיהיו חלק מ-commonCalendarProps.
// הבסיס הוא CalendarProps (שהוא DayPickerProps).
type CommonOnlyCalendarProps = Pick<
  CalendarProps,
  | "defaultMonth"
  | "locale"
  | "className" // className של הקומפוננטה הפנימית של react-day-picker
  | "classNames" // classNames של הקומפוננטה הפנימית
  | "captionLayout"
  | "fromYear"
  | "toYear"
  | "fromMonth"
  | "toMonth"
  | "fromDate"
  | "toDate"
  | "disabled"
  | "hidden"
  | "showOutsideDays"
  | "pagedNavigation"
  | "fixedWeeks"
  | "weekStartsOn"
  | "ISOWeek"
  // ניתן להוסיף עוד מאפיינים בסיסיים שתרצה להעביר דרך commonCalendarProps
  // כמו: 'modifiers', 'modifiersClassNames', 'formatters', 'labels' וכו'
  // הימנע מהוספת: 'mode', 'selected', 'onSelect', 'numberOfMonths', 'onDayClick'
  // שאותם אנו מגדירים בנפרד.
>;

export const DatePicker: React.FC<DatePickerProps> = ({
  value,
  onChange,
  isRange = false,
  placeholder = "בחר תאריך",
  className, // זהו ה-className שמועבר לרכיב ה-Button החיצוני
  disabled, // זהו ה-disabled שמועבר ל-Calendar הפנימי
}) => {
  const [isOpen, setIsOpen] = useState(false);

  const handleSelectSingle: SelectSingleEventHandler = (day) => {
    if (onChange) {
      onChange({ from: day, to: undefined });
    }
    if (day) {
      setIsOpen(false);
    }
  };

  const handleSelectRange: SelectRangeEventHandler = (range) => {
    if (onChange) {
      onChange({ from: range?.from, to: range?.to });
    }
  };

  const displayValue = useMemo(() => {
    const fromDate = value?.from;
    const toDate = value?.to;

    if (!fromDate) return placeholder;

    const formatStringSingle = "d בMMMM yyyy";
    const formatStringRange = "d MMM yy";

    if (isRange && toDate) {
      return `${format(fromDate, formatStringRange, { locale: he })} - ${format(
        toDate,
        formatStringRange,
        { locale: he }
      )}`;
    }
    return format(fromDate, formatStringSingle, { locale: he });
  }, [value, isRange, placeholder]);

  const currentYear = new Date().getFullYear();
  const fromYearDatePicker = currentYear - 120; // שינוי שם כדי למנוע התנגשות עם fromYear מ-props
  const toYearDatePicker = currentYear + 10; // שינוי שם

  // מאפיינים משותפים לשני מצבי ה-Calendar
  const commonCalendarProps: CommonOnlyCalendarProps = {
    defaultMonth: value?.from || new Date(),
    locale: he,
    className: "rounded-md border shadow-sm", // זה ה-className של Calendar הפנימי
    captionLayout: "dropdown",
    fromYear: fromYearDatePicker, // שימוש בשם המתוקן
    toYear: toYearDatePicker, // שימוש בשם המתוקן
    disabled: disabled, // ה-disabled prop שהועבר
    showOutsideDays: true,
    // אין צורך להגדיר את כל המאפיינים מ-CommonOnlyCalendarProps,
    // רק את אלו שאנו רוצים להעביר ערכים עבורם.
    // מאפיינים שלא יוגדרו כאן יקבלו את ערכי ברירת המחדל של react-day-picker
    // או שיהיו undefined.
  };

  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <Button
          dir="rtl"
          variant="outline"
          className={cn( // כאן משתמשים ב-className החיצוני שהועבר ל-DatePicker
            "w-full justify-between text-right font-normal",
            !value?.from && "text-muted-foreground",
            className
          )}
        >
          <span>{displayValue}</span>
          <CalendarIcon className="mr-auto h-4 w-4" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start" dir="rtl">
        {isRange ? (
          <Calendar
            mode="range"
            selected={value as DateRange | undefined}
            onSelect={handleSelectRange}
            numberOfMonths={2}
            {...commonCalendarProps}
          />
        ) : (
          <Calendar
            mode="single"
            selected={value?.from}
            onSelect={handleSelectSingle}
            numberOfMonths={1}
            {...commonCalendarProps}
          />
        )}
      </PopoverContent>
    </Popover>
  );
};
--- End of Content for date-picker.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\dialog-provider.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/dialog-provider.tsx
"use client"
 
import {
  DialogPortal,
  DialogOverlay,
  DialogContent,
} from "@/components/ui/dialog"
import { cn } from "@/lib/utils"
 
function DialogProvider({
  children,
  className,
}: {
  children: React.ReactNode
  className?: string
}) {
  return (
    <DialogPortal>
      <DialogOverlay />
      <DialogContent className={cn(className)}>
        {children}
      </DialogContent>
    </DialogPortal>
  )
}
 
export { DialogProvider }
--- End of Content for dialog-provider.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\dialog.tsx
--------------------------------------------------------------------------------
Content:
// components/ui/dialog.tsx

"use client";

import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog"; // ייבוא כל המודול
import { cn } from "@/lib/utils";

const Dialog = DialogPrimitive.Root;
const DialogTrigger = DialogPrimitive.Trigger;
const DialogPortal = DialogPrimitive.Portal; // אפשר להשתמש ישירות
const DialogOverlay = React.forwardRef< // Overlay ו-Content צריכים עיטוף עם forwardRef ו-styling
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/50 backdrop-blur-sm transition-all duration-100 data-[state=closed]:animate-out data-[state=closed]:fade-out data-[state=open]:fade-in",
      className
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  // ה-DialogPortal הקודם שכתבת היה מעט מיותר כי DialogPrimitive.Portal כבר קיים
  // אבל אם אתה רוצה את העיטוף הנוסף ל-centering, אפשר להשאיר אותו או להטמיע את הלוגיקה כאן.
  // לצורך הפשטות וההתאמה ל-shadcn, נשתמש ב-DialogPrimitive.Portal ישירות עם Content.
  <DialogPrimitive.Portal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=open]:fade-in-0 data-[state=open]:zoom-in-95 data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        "max-h-[85vh] overflow-y-auto", // הוספתי גלילה אם התוכן ארוך
        className // מאפשר דריסה של קלאסים
      )}
      {...props}
    >
      {children}
      {/* אין צורך ב-X כאן, DialogPrimitive.Close משמש לסגירה מכל מקום */}
    </DialogPrimitive.Content>
  </DialogPrimitive.Portal>
));
DialogContent.displayName = DialogPrimitive.Content.displayName;


const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-right", // שיניתי ל-text-right כברירת מחדל
      className
    )}
    {...props}
  />
);
DialogHeader.displayName = "DialogHeader";

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 sm:space-x-reverse", // הוספתי space-x-reverse לכיווניות
      className
    )}
    {...props}
  />
);
DialogFooter.displayName = "DialogFooter";

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight text-right", // שיניתי ל-text-right
      className
    )}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground text-right", className)} // שיניתי ל-text-right
    {...props}
  />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

// זהו החלק החשוב לתיקון השגיאה שלך:
const DialogClose = DialogPrimitive.Close; // הקצאה פשוטה של הקומפוננטה

export {
  Dialog,
  DialogPortal, // אם אתה עדיין רוצה את העיטוף המותאם אישית שלך
  DialogOverlay,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
  DialogClose, // עכשיו DialogClose מיוצא כראוי
  DialogPrimitive, // אופציונלי: אם אתה רוצה גישה לכל DialogPrimitive במקומות אחרים
};
--- End of Content for dialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\dropdown-menu.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/dropdown-menu.tsx
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  );
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
--- End of Content for dropdown-menu.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\image-viewer.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/image-viewer.tsx
"use client";

import React from "react";
import { Dialog, DialogContent, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ChevronLeft, ChevronRight, X } from "lucide-react";
import Image from "next/image";

interface ImageViewerProps {
  images: { id: string; url: string; isMain?: boolean }[];
  selectedIndex: number | null;
  onClose: () => void;
  title?: string;
}

const ImageViewer: React.FC<ImageViewerProps> = ({
  images,
  selectedIndex,
  onClose,
  title = "תצוגת תמונה",
}) => {
  const handlePreviousImage = () => {
    if (selectedIndex !== null) {
      const newIndex =
        selectedIndex === 0 ? images.length - 1 : selectedIndex - 1;
      setCurrentIndex(newIndex);
    }
  };

  const handleNextImage = () => {
    if (selectedIndex !== null) {
      const newIndex =
        selectedIndex === images.length - 1 ? 0 : selectedIndex + 1;
      setCurrentIndex(newIndex);
    }
  };

  const [currentIndex, setCurrentIndex] = React.useState(selectedIndex);

  React.useEffect(() => {
    setCurrentIndex(selectedIndex);
  }, [selectedIndex]);

  if (selectedIndex === null || currentIndex === null) return null;

  return (
    <Dialog open={selectedIndex !== null} onOpenChange={onClose}>
      <DialogContent className="max-w-screen-lg h-screen flex items-center justify-center">
        <DialogTitle className="sr-only">{title}</DialogTitle>

        <Button
          variant="ghost"
          size="icon"
          className="absolute left-4 top-1/2 transform -translate-y-1/2"
          onClick={handlePreviousImage}
          aria-label="תמונה קודמת"
        >
          <ChevronLeft className="h-8 w-8" />
        </Button>

        <div className="relative w-full h-[80vh]">
          <Image
            src={images[currentIndex].url}
            alt={`תמונה ${currentIndex + 1} מתוך ${images.length}`}
            fill
            className="object-contain"
            priority
          />
        </div>

        <Button
          variant="ghost"
          size="icon"
          className="absolute right-4 top-1/2 transform -translate-y-1/2"
          onClick={handleNextImage}
          aria-label="תמונה הבאה"
        >
          <ChevronRight className="h-8 w-8" />
        </Button>

        <Button
          variant="ghost"
          size="icon"
          className="absolute right-4 top-4"
          onClick={onClose}
          aria-label="סגור תצוגת תמונה"
        >
          <X className="h-6 w-6" />
        </Button>
      </DialogContent>
    </Dialog>
  );
};

export default ImageViewer;
--- End of Content for image-viewer.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\input.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";

import { cn } from "@/lib/utils";

export type InputProps = React.InputHTMLAttributes<HTMLInputElement>;

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Input.displayName = "Input";

export { Input };
--- End of Content for input.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\label.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
);

type LabelElement = React.ElementRef<typeof LabelPrimitive.Root>;
type LabelProps = React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
  VariantProps<typeof labelVariants> & {
    className?: string;
  };

const Label = React.forwardRef<LabelElement, LabelProps>(
  ({ className, ...props }: LabelProps, ref) => (
    <LabelPrimitive.Root
      ref={ref}
      className={cn(labelVariants(), className)}
      {...props}
    />
  )
);

Label.displayName = "Label";

export { Label };
--- End of Content for label.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\loading-spinner.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/loading-spinner.tsx
import React from "react";
import { cn } from "@/lib/utils";
import { Loader2 } from "lucide-react";

interface LoadingSpinnerProps {
  className?: string;
  size?: "sm" | "md" | "lg";
}

const sizeClasses = {
  sm: "w-4 h-4",
  md: "w-8 h-8",
  lg: "w-12 h-12",
};

const LoadingSpinner: React.FC<LoadingSpinnerProps> = ({ 
  className,
  size = "md" 
}) => {
  return (
    <div className="flex items-center justify-center w-full min-h-[100px]">
      <Loader2 
        className={cn(
          "animate-spin text-primary",
          sizeClasses[size],
          className
        )} 
      />
    </div>
  );
};

export default LoadingSpinner;
--- End of Content for loading-spinner.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\multi-select.tsx
--------------------------------------------------------------------------------
Content:
"use client";

import * as React from "react";
import { Check, X } from "lucide-react";
import { cn } from "@/lib/utils";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from "@/components/ui/command";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";

export type Option = {
  value: string;
  label: string;
};

interface MultiSelectProps {
  options: Option[];
  selected: string[];
  onChange: (values: string[]) => void;
  placeholder?: string;
  className?: string;
  disabled?: boolean;
}

export function MultiSelect({
  options,
  selected,
  onChange,
  placeholder = "בחר פריטים...",
  className,
  disabled = false,
}: MultiSelectProps) {
  const [open, setOpen] = React.useState(false);

  const handleUnselect = (value: string) => {
    onChange(selected.filter((item) => item !== value));
  };

  return (
    <Popover open={open} onOpenChange={setOpen} modal={true}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          className={cn("w-full justify-between", className)}
          onClick={() => setOpen(!open)}
          disabled={disabled}
        >
          <div className="flex flex-wrap gap-1">
            {selected.length > 0 ? (
              selected.map((value) => (
                <Badge
                  key={value}
                  variant="secondary"
                  className="ml-1"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleUnselect(value);
                  }}
                >
                  {options.find((opt) => opt.value === value)?.label || value}
                  <button
                    className="ml-1 ring-offset-background rounded-full outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                    onKeyDown={(e) => {
                      if (e.key === "Enter") {
                        handleUnselect(value);
                      }
                    }}
                    onMouseDown={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                    }}
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      handleUnselect(value);
                    }}
                  >
                    <X className="h-3 w-3 text-muted-foreground hover:text-foreground" />
                  </button>
                </Badge>
              ))
            ) : (
              <span className="text-muted-foreground">{placeholder}</span>
            )}
          </div>
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-full p-0" align="start">
        <Command className="w-full">
          <CommandInput placeholder={placeholder} />
          <CommandEmpty>לא נמצאו תוצאות.</CommandEmpty>
          <CommandGroup className="max-h-64 overflow-auto">
            {options.map((option) => (
              <CommandItem
                key={option.value}
                onSelect={() => {
                  onChange(
                    selected.includes(option.value)
                      ? selected.filter((item) => item !== option.value)
                      : [...selected, option.value]
                  );
                }}
              >
                <Check
                  className={cn(
                    "mr-2 h-4 w-4",
                    selected.includes(option.value)
                      ? "opacity-100"
                      : "opacity-0"
                  )}
                />
                {option.label}
              </CommandItem>
            ))}
          </CommandGroup>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
--- End of Content for multi-select.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\popover.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import * as React from 'react';
import * as PopoverPrimitive from '@radix-ui/react-popover';

import { cn } from '@/lib/utils';

const Popover = PopoverPrimitive.Root;

const PopoverTrigger = PopoverPrimitive.Trigger;

// --- START OF FIX: Add PopoverAnchor export ---
const PopoverAnchor = PopoverPrimitive.Anchor;
// --- END OF FIX ---

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = 'center', sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        'z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
));
PopoverContent.displayName = PopoverPrimitive.Content.displayName;

// --- START OF FIX: Add PopoverAnchor to the export list ---
export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };
// --- END OF FIX ---
--- End of Content for popover.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\progress-indicator.tsx
--------------------------------------------------------------------------------
Content:
import React from "react";

interface ProgressIndicatorProps {
  currentStep: number;
  totalSteps: number;
  className?: string;
}

export function ProgressIndicator({ 
  currentStep, 
  totalSteps, 
  className = "" 
}: ProgressIndicatorProps) {
  const percentage = ((currentStep + 1) / totalSteps) * 100;

  return (
    <div className={`w-full ${className}`}>
      <div className="flex justify-between mb-1 text-sm text-gray-500">
        <span>התקדמות</span>
        <span>{Math.round(percentage)}%</span>
      </div>
      <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className="h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-300 ease-in-out"
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}
--- End of Content for progress-indicator.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\progress.tsx
--------------------------------------------------------------------------------
Content:
// components/ui/progress.tsx
"use client";

import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress";

import { cn } from "@/lib/utils";

// Define a new interface for props that includes indicatorClassName
interface CustomProgressProps
  extends React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root> {
  indicatorClassName?: string;
}

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  CustomProgressProps // Use the new CustomProgressProps interface
>(({ className, value, indicatorClassName, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-gray-100", // As per your provided file
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className={cn(
        "h-full w-full flex-1 bg-blue-600 transition-all", // As per your provided file
        indicatorClassName // Apply the indicatorClassName here
      )}
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }} // Corrected transform for left-to-right fill
    />
  </ProgressPrimitive.Root>
));
Progress.displayName = ProgressPrimitive.Root.displayName;

export { Progress };
--- End of Content for progress.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\radio-group.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { cn } from "@/lib/utils";
import { Circle } from "lucide-react";

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  );
});
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName;

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
});
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName;

export { RadioGroup, RadioGroupItem };
--- End of Content for radio-group.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\resizable.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/resizable.tsx
"use client";

import { GripVertical } from "lucide-react";
import * as ResizablePrimitive from "react-resizable-panels";
import { cn } from "@/lib/utils";

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
);

const ResizablePanel = ResizablePrimitive.Panel;

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
);

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };
--- End of Content for resizable.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\scroll-area.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/scroll-area.tsx
"use client";

import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area";

import { cn } from "@/lib/utils";

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
));
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName;

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
));
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName;

export { ScrollArea, ScrollBar };
--- End of Content for scroll-area.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\select.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/select.tsx
import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { Check, ChevronDown } from "lucide-react";
import { cn } from "@/lib/utils";

const Select = SelectPrimitive.Root;

const SelectGroup = SelectPrimitive.Group;

const SelectValue = SelectPrimitive.Value;

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
      dir="rtl"
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
      className
    )}
    {...props}
  >
    {children}
    <ChevronDown className="h-4 w-4 opacity-50" />
  </SelectPrimitive.Trigger>
));
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName;

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      dir="rtl"
      className={cn(
        "relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectPrimitive.Viewport
        className={cn(
          "p-1 text-right", // הוספנו text-right
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
));
SelectContent.displayName = SelectPrimitive.Content.displayName;

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    dir="rtl"
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
));
SelectItem.displayName = SelectPrimitive.Item.displayName;

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
));
SelectSeparator.displayName = SelectPrimitive.Separator.displayName;

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectItem,
  SelectSeparator,
};
--- End of Content for select.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\separator.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator";

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={`shrink-0 bg-border ${
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]"
      } ${className}`}
      {...props}
    />
  )
);
Separator.displayName = SeparatorPrimitive.Root.displayName;

export { Separator };
--- End of Content for separator.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\sheet.tsx
--------------------------------------------------------------------------------
Content:
"use client";

import * as React from "react";
import * as SheetPrimitive from "@radix-ui/react-dialog";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";

const Sheet = SheetPrimitive.Root;

const SheetTrigger = SheetPrimitive.Trigger;

const SheetClose = SheetPrimitive.Close;

// Fix: Remove className from the type definition and from the component props
const SheetPortal = (props: SheetPrimitive.DialogPortalProps) => (
  <SheetPrimitive.Portal {...props} />
);
SheetPortal.displayName = SheetPrimitive.Portal.displayName;

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-background/80 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
));
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName;

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
);

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">סגור</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
));
SheetContent.displayName = SheetPrimitive.Content.displayName;

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
);
SheetHeader.displayName = "SheetHeader";

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
);
SheetFooter.displayName = "SheetFooter";

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
));
SheetTitle.displayName = SheetPrimitive.Title.displayName;

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
SheetDescription.displayName = SheetPrimitive.Description.displayName;

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
};
--- End of Content for sheet.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\skeleton.tsx
--------------------------------------------------------------------------------
Content:
// @/components/ui/skeleton.tsx
"use client";

import { cn } from "@/lib/utils";

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  );
}

export { Skeleton };
--- End of Content for skeleton.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\slider.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-1.5 w-full grow overflow-hidden rounded-full bg-gray-100">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))

Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
--- End of Content for slider.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\split-pane.tsx
--------------------------------------------------------------------------------
Content:
// components/ui/split-pane.tsx
"use client";
import React, { useState, useRef, useEffect, useCallback } from "react";
import { cn } from "@/lib/utils";

interface SplitPaneProps {
  children: [React.ReactNode, React.ReactNode];
  split?: "vertical" | "horizontal";
  defaultSize?: number;
  minSize?: number;
  maxSize?: number;
  onChange?: (size: number) => void;
  className?: string;
}

export function SplitPane({
  children,
  split = "vertical",
  defaultSize = 50,
  minSize = 20,
  maxSize = 80,
  onChange,
  className,
}: SplitPaneProps) {
  const [size, setSize] = useState(defaultSize);
  const [isDragging, setIsDragging] = useState(false);
  const splitPaneRef = useRef<HTMLDivElement>(null);
  const resizerRef = useRef<HTMLDivElement>(null);

  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    e.preventDefault();
    setIsDragging(true);
  }, []);

  const handleMouseUp = useCallback(() => {
    setIsDragging(false);
  }, []);

  const handleMouseMove = useCallback(
    (e: MouseEvent) => {
      if (!isDragging || !splitPaneRef.current) return;

      const rect = splitPaneRef.current.getBoundingClientRect();
      let newSize;

      if (split === "vertical") {
        newSize = ((e.clientX - rect.left) / rect.width) * 100;
      } else {
        newSize = ((e.clientY - rect.top) / rect.height) * 100;
      }

      newSize = Math.max(minSize, Math.min(maxSize, newSize));
      setSize(newSize);
      onChange?.(newSize);
    },
    [isDragging, split, minSize, maxSize, onChange]
  );

  useEffect(() => {
    if (isDragging) {
      window.addEventListener("mousemove", handleMouseMove);
      window.addEventListener("mouseup", handleMouseUp);
    } else {
      window.removeEventListener("mousemove", handleMouseMove);
      window.removeEventListener("mouseup", handleMouseUp);
    }

    return () => {
      window.removeEventListener("mousemove", handleMouseMove);
      window.removeEventListener("mouseup", handleMouseUp);
    };
  }, [isDragging, handleMouseMove, handleMouseUp]);

  return (
    <div
      ref={splitPaneRef}
      className={cn(
        "flex",
        split === "vertical" ? "flex-row" : "flex-col",
        className
      )}
    >
      <div
        className={cn("overflow-auto", split === "vertical" ? "h-full" : "")}
        style={{
          [split === "vertical" ? "width" : "height"]: `${size}%`,
        }}
      >
        {children[0]}
      </div>

      <div
        ref={resizerRef}
        className={cn(
          "bg-gray-200 hover:bg-blue-500 transition-colors duration-150",
          "cursor-col-resize",
          split === "vertical" ? "w-1 my-1 hover:w-1" : "h-1 mx-1 hover:h-1",
          isDragging && "bg-blue-500"
        )}
        onMouseDown={handleMouseDown}
      />

      <div
        className={cn("overflow-auto", split === "vertical" ? "h-full" : "")}
        style={{
          [split === "vertical" ? "width" : "height"]: `${100 - size}%`,
        }}
      >
        {children[1]}
      </div>
    </div>
  );
}
--- End of Content for split-pane.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\stats-card.tsx
--------------------------------------------------------------------------------
Content:
import React from 'react';
import { LucideIcon } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/card';

interface StatsCardProps {
  icon: LucideIcon;
  title: string;
  value: string;
}

const StatsCard = ({ icon: Icon, title, value }: StatsCardProps) => {
  // Special styling for availability status
  const isAvailabilityCard = title === "סטטוס פניות";
  const isAvailable = value?.toLowerCase() === "available";
  
  return (
    <Card className="overflow-hidden">
      <CardContent className="p-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-4 space-x-reverse">
            <div className="p-2 bg-primary/10 rounded-full">
              <Icon className="w-5 h-5 text-primary" />
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">
                {title}
              </p>
              {isAvailabilityCard ? (
                <div className="mt-1">
                  <span className={`
                    inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
                    ${isAvailable ? 
                      'bg-green-100 text-green-800' : 
                      'bg-gray-100 text-gray-800'
                    }
                  `}>
                    {value || "לא צוין"}
                  </span>
                </div>
              ) : (
                <p className="text-2xl font-semibold mt-1">
                  {value || "לא צוין"}
                </p>
              )}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default StatsCard;
--- End of Content for stats-card.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\steps.tsx
--------------------------------------------------------------------------------
Content:
import React from 'react'
import { LucideIcon } from 'lucide-react'

interface Step {
  title: string
  description: string
  icon: LucideIcon
}

interface StepsProps {
  steps: Step[]
  currentStep: number
}

export function Steps({ steps, currentStep }: StepsProps) {
  return (
    <div className="flex w-full">
      {steps.map((step, index) => {
        const Icon = step.icon
        const isActive = currentStep === index + 1
        const isCompleted = currentStep > index + 1

        return (
          <React.Fragment key={step.title}>
            <div className="flex flex-1 flex-col items-center">
              <div
                className={`flex h-10 w-10 items-center justify-center rounded-full border-2 ${
                  isActive
                    ? 'border-primary bg-primary text-primary-foreground'
                    : isCompleted
                    ? 'border-primary bg-primary text-primary-foreground'
                    : 'border-border bg-background'
                }`}
              >
                <Icon className="h-5 w-5" />
              </div>
              <div className="mt-2 text-center">
                <div className="text-sm font-medium">{step.title}</div>
                <div className="text-sm text-muted-foreground">
                  {step.description}
                </div>
              </div>
            </div>
            {index < steps.length - 1 && (
              <div className="flex flex-1 items-center">
                <div
                  className={`h-[2px] w-full ${
                    currentStep > index + 1 ? 'bg-primary' : 'bg-border'
                  }`}
                />
              </div>
            )}
          </React.Fragment>
        )
      })}
    </div>
  )
}

export type { Step }
--- End of Content for steps.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\switch.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/switch.tsx
import * as React from 'react';
import * as SwitchPrimitives from '@radix-ui/react-switch';
import { cn } from '@/lib/utils';

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      'peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50',
      'data-[state=checked]:bg-green-500',
      'data-[state=unchecked]:bg-slate-300',
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        'pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform',

        // --- START: התיקון המרכזי כאן ---
        // הגדרה מפורשת למצב כבוי (תמיד באותו מקום)
        'data-[state=unchecked]:translate-x-0',

        // הגדרה מפורשת למצב דלוק, תלוית כיווניות
        'ltr:data-[state=checked]:translate-x-4', // במצב LTR, הזז ימינה
        'rtl:data-[state=checked]:-translate-x-4' // במצב RTL, הזז שמאלה
        // --- END: התיקון המרכזי ---
      )}
    />
  </SwitchPrimitives.Root>
));

Switch.displayName = SwitchPrimitives.Root.displayName;

export { Switch };
--- End of Content for switch.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\tabs.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/tabs.tsx
"use client";

import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";
import { cn } from "@/lib/utils";

const Tabs = TabsPrimitive.Root;

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    dir="rtl"
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    dir="rtl"
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    dir="rtl"
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export { Tabs, TabsList, TabsTrigger, TabsContent };
--- End of Content for tabs.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\textarea.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react";
import { cn } from "@/lib/utils";

// Remove empty interface and use type directly
type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>;

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = "Textarea";

export { Textarea };
--- End of Content for textarea.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\timeline.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/timeline.tsx
import * as React from "react";
import { LucideIcon } from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { he } from "date-fns/locale";
import { cn } from "@/lib/utils";

export interface TimelineItem {
  title: string;
  description?: string;
  date: Date;
  icon: LucideIcon;
  status?: "default" | "success" | "warning" | "error";
}

interface TimelineProps extends React.HTMLAttributes<HTMLDivElement> {
  items: TimelineItem[];
}

const statusStyles = {
  default: "bg-primary/10 text-primary",
  success: "bg-green-100 text-green-600",
  warning: "bg-yellow-100 text-yellow-600",
  error: "bg-red-100 text-red-600",
};

export function Timeline({ items, className, ...props }: TimelineProps) {
  return (
    <div className={cn("relative space-y-8", className)} {...props}>
      {items.map((item, index) => (
        <div key={index} className="flex gap-4 items-start">
          {/* Icon Container */}
          <div className="relative">
            <div
              className={cn(
                "w-8 h-8 rounded-full flex items-center justify-center",
                statusStyles[item.status || "default"]
              )}
            >
              {React.createElement(item.icon, { className: "w-4 h-4" })}
            </div>
            {index !== items.length - 1 && (
              <div className="absolute top-8 left-4 w-[2px] h-16 bg-gray-200" />
            )}
          </div>

          {/* Content */}
          <div className="flex-1">
            <div className="flex items-center justify-between">
              <h4 className="font-medium">{item.title}</h4>
              <time className="text-sm text-gray-500">
                {formatDistanceToNow(item.date, {
                  addSuffix: true,
                  locale: he,
                })}
              </time>
            </div>
            {item.description && (
              <p className="mt-1 text-sm text-gray-600">{item.description}</p>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}
--- End of Content for timeline.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\toggle-group.tsx
--------------------------------------------------------------------------------
Content:
"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3",
        sm: "h-9 px-2.5",
        lg: "h-11 px-5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("inline-flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        "data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem, toggleVariants }
--- End of Content for toggle-group.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\tooltip.tsx
--------------------------------------------------------------------------------
Content:
// src/components/ui/tooltip.tsx

import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip";

import { cn } from "@/lib/utils";

const TooltipProvider = TooltipPrimitive.Provider;

const Tooltip = TooltipPrimitive.Root;

const TooltipTrigger = TooltipPrimitive.Trigger;

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };
--- End of Content for tooltip.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\virtual-grid.tsx
--------------------------------------------------------------------------------
Content:
// components/ui/virtual-grid.tsx
"use client";
import React, { useEffect, useRef, useState } from "react";
import { cn } from "@/lib/utils";

interface VirtualGridProps<T> {
  items: T[];
  renderItem: (item: T) => React.ReactNode;
  className?: string;
  itemHeight?: number;
  itemWidth?: number;
  overscan?: number;
}

export function VirtualGrid<T>({
  items,
  renderItem,
  className,
  itemHeight = 300,
  itemWidth = 250,
  overscan = 5,
}: VirtualGridProps<T>) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 20 });
  const [containerWidth, setContainerWidth] = useState(0);

  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const calculateVisibleItems = () => {
      const rect = container.getBoundingClientRect();
      setContainerWidth(rect.width);

      const itemsPerRow = Math.max(1, Math.floor(rect.width / itemWidth));
      const rowHeight = itemHeight;
      const totalRows = Math.ceil(items.length / itemsPerRow);

      const scrollTop = container.scrollTop;
      const viewportHeight = container.clientHeight;

      const startRow = Math.max(
        0,
        Math.floor(scrollTop / rowHeight) - overscan
      );
      const endRow = Math.min(
        totalRows,
        Math.ceil((scrollTop + viewportHeight) / rowHeight) + overscan
      );

      const start = startRow * itemsPerRow;
      const end = Math.min(items.length, (endRow + 1) * itemsPerRow);

      setVisibleRange({ start, end });
    };

    // Set up ResizeObserver
    const observer = new ResizeObserver(calculateVisibleItems);
    observer.observe(container);

    // Set up scroll listener
    container.addEventListener("scroll", calculateVisibleItems);
    calculateVisibleItems();

    // Cleanup
    return () => {
      observer.disconnect();
      container.removeEventListener("scroll", calculateVisibleItems);
    };
  }, [items.length, itemHeight, itemWidth, overscan]);

  const itemsPerRow = Math.max(1, Math.floor(containerWidth / itemWidth));
  const totalHeight = Math.ceil(items.length / itemsPerRow) * itemHeight;

  const visibleItems = items.slice(visibleRange.start, visibleRange.end);
  const paddingTop = Math.floor(visibleRange.start / itemsPerRow) * itemHeight;

  return (
    <div
      ref={containerRef}
      className={cn("overflow-auto h-full relative", className)}
      style={{ WebkitOverflowScrolling: "touch" }}
    >
      <div
        style={{
          height: totalHeight,
          position: "relative",
        }}
      >
        <div
          style={{
            position: "absolute",
            top: paddingTop,
            display: "grid",
            gridTemplateColumns: `repeat(auto-fill, minmax(${itemWidth}px, 1fr))`,
            gap: "1rem",
            width: "100%",
          }}
        >
          {visibleItems.map(renderItem)}
        </div>
      </div>
    </div>
  );
}
--- End of Content for virtual-grid.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\visually-hidden.tsx
--------------------------------------------------------------------------------
Content:
import * as React from "react"
import { cn } from "@/lib/utils"

const VisuallyHidden = React.forwardRef<
  HTMLSpanElement,
  React.HTMLAttributes<HTMLSpanElement>
>(({ className, ...props }, ref) => {
  return (
    <span
      ref={ref}
      className={cn(
        "absolute w-[1px] h-[1px] p-0 -m-[1px] overflow-hidden clip-rect-0 border-0 whitespace-nowrap",
        className
      )}
      {...props}
    />
  )
})

VisuallyHidden.displayName = "VisuallyHidden"

export { VisuallyHidden }
--- End of Content for visually-hidden.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\form
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\form\form.tsx
--------------------------------------------------------------------------------
Content:
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  ControllerProps,
  FieldPath,
  FieldValues,
  FormProvider,
  useFormContext,
} from "react-hook-form"

import { Label } from "@/components/ui/label"
import { cn } from "@/lib/utils"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message) : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
--- End of Content for form.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\toast
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\toast\toast.d.ts
--------------------------------------------------------------------------------
Content:
import * as React from "react"

export type ToastProps = {
  id?: string
  className?: string
  title?: React.ReactNode
  description?: React.ReactNode
  variant?: "default" | "destructive"
  action?: ToastActionElement
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

export type ToastActionElement = React.ReactElement<{
  className?: string
  altText?: string
  onClick?: () => void
}>
--- End of Content for toast.d.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\ui\toast\use-toast.ts
--------------------------------------------------------------------------------
Content:
"use client";
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

type ActionType = {
  ADD_TOAST: "ADD_TOAST"
  UPDATE_TOAST: "UPDATE_TOAST"
  DISMISS_TOAST: "DISMISS_TOAST"
  REMOVE_TOAST: "REMOVE_TOAST"
}

const actionTypes: ActionType = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
}

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_VALUE
  return count.toString()
}

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: actionTypes.REMOVE_TOAST,
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case actionTypes.ADD_TOAST:
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case actionTypes.UPDATE_TOAST:
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case actionTypes.DISMISS_TOAST: {
      const { toastId } = action

      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case actionTypes.REMOVE_TOAST:
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: actionTypes.UPDATE_TOAST,
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: actionTypes.DISMISS_TOAST, toastId: id })

  dispatch({
    type: actionTypes.ADD_TOAST,
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: actionTypes.DISMISS_TOAST, toastId }),
  }
}

export { useToast, toast }
--- End of Content for use-toast.ts ---

