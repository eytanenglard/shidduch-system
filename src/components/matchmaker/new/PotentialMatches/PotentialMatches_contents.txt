################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches
# Generated on: 2026-02-13 12:33:48
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\AllReasoningsDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/AllReasoningsDisplay.tsx

'use client';

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from '@/components/ui/tabs';
import {
  Brain,
  Sparkles,
  Clock,
  CheckCircle2,
  ChevronDown,
  BarChart3,
} from 'lucide-react';
import type { PotentialMatch, ScoreBreakdown } from './types/potentialMatches';

// =============================================================================
// TYPES
// =============================================================================

interface ScanMethodInfo {
  key: string;
  label: string;
  icon: string;
  description: string;
  bgColor: string;
  textColor: string;
  borderColor: string;
  score: number | null;
  reasoning: string | null;
  scannedAt: Date | null;
  scoreBreakdown: ScoreBreakdown | null;
}

interface AllReasoningsDisplayProps {
  match: PotentialMatch;
  isOpen: boolean;
  onClose: () => void;
}

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

const getScoreColor = (score: number): string => {
  if (score >= 85) return 'text-emerald-600';
  if (score >= 75) return 'text-blue-600';
  if (score >= 70) return 'text-amber-600';
  return 'text-gray-600';
};

const getScanMethods = (match: PotentialMatch): ScanMethodInfo[] => {
  const methods: ScanMethodInfo[] = [
    {
      key: 'hybrid',
      label: '×”×™×‘×¨×™×“×™',
      icon: 'ğŸ”¥',
      description: '×¡×¨×™×§×” ×”×™×‘×¨×™×“×™×ª (4 ×©×œ×‘×™×) - ×”×›×™ ××§×™×£',
      bgColor: 'bg-emerald-50',
      textColor: 'text-emerald-700',
      borderColor: 'border-emerald-200',
      score: match.hybridScore ?? null,
      reasoning: match.hybridReasoning ?? null,
      scannedAt: match.hybridScannedAt ?? null,
      scoreBreakdown: match.hybridScoreBreakdown ?? null,
    },
    {
      key: 'algorithmic',
      label: 'AI ××ª×§×“×',
      icon: 'ğŸ§ ',
      description: '× ×™×ª×•×— AI ××¢××™×§ ×¢× ×”×‘× ×ª ×”×§×©×¨',
      bgColor: 'bg-purple-50',
      textColor: 'text-purple-700',
      borderColor: 'border-purple-200',
      score: match.algorithmicScore ?? null,
      reasoning: match.algorithmicReasoning ?? null,
      scannedAt: match.algorithmicScannedAt ?? null,
      scoreBreakdown: match.algorithmicScoreBreakdown ?? null,
    },
    {
      key: 'vector',
      label: '×¡×¨×™×§×” ××”×™×¨×”',
      icon: 'âš¡',
      description: '×¡×¨×™×§×” ×•×§×˜×•×¨×™×ª ××”×™×¨×” ×œ×¤×™ ×“××™×•×Ÿ ×˜×§×¡×˜×•××œ×™',
      bgColor: 'bg-blue-50',
      textColor: 'text-blue-700',
      borderColor: 'border-blue-200',
      score: match.vectorScore ?? null,
      reasoning: match.vectorReasoning ?? null,
      scannedAt: match.vectorScannedAt ?? null,
      scoreBreakdown: null, // ×•×§×˜×•×¨×™ ××™×Ÿ ×œ×• breakdown
    },
    {
      key: 'metricsV2',
      label: '××˜×¨×™×§×•×ª V2',
      icon: 'ğŸ¯',
      description: '× ×™×ª×•×— ×œ×¤×™ ××“×“×™× ××¡×¤×¨×™×™× ××“×•×™×§×™×',
      bgColor: 'bg-indigo-50',
      textColor: 'text-indigo-700',
      borderColor: 'border-indigo-200',
      score: match.metricsV2Score ?? null,
      reasoning: match.metricsV2Reasoning ?? null,
      scannedAt: match.metricsV2ScannedAt ?? null,
      scoreBreakdown: match.metricsV2ScoreBreakdown ?? null,
    },
  ];

  // ××¡× ×Ÿ ×¨×§ ×©×™×˜×•×ª ×©×™×© ×œ×”×Ÿ ×¦×™×•×Ÿ ××• × ×™××•×§
  return methods.filter(m => m.score !== null || m.reasoning);
};

// =============================================================================
// SCORE BREAKDOWN COMPONENT - ××©×•×¤×¨
// =============================================================================

const ScoreBreakdownDisplay: React.FC<{ 
  breakdown: ScoreBreakdown;
  methodKey?: string;
}> = ({ breakdown, methodKey }) => {
  const categories = [
    { key: 'religious', label: '×”×ª×××” ×“×ª×™×ª', max: 25, color: 'bg-purple-500' },
    { key: 'ageCompatibility', label: '×”×ª×××ª ×’×™×œ', max: 10, color: 'bg-blue-500' },
    { key: 'careerFamily', label: '×§×¨×™×™×¨×”-××©×¤×—×”', max: 15, color: 'bg-cyan-500' },
    { key: 'lifestyle', label: '×¡×’× ×•×Ÿ ×—×™×™×', max: 10, color: 'bg-green-500' },
    { key: 'socioEconomic', label: '×¡×•×¦×™×•-××§×•× ×•××™', max: 10, color: 'bg-orange-500' },
    { key: 'education', label: '×”×©×›×œ×”', max: 10, color: 'bg-pink-500' },
    { key: 'background', label: '×¨×§×¢ ×ª×¨×‘×•×ª×™', max: 10, color: 'bg-amber-500' },
    { key: 'values', label: '×¢×¨×›×™× ×•×ª×§×©×•×¨×ª', max: 10, color: 'bg-indigo-500' },
  ];

  // ××¡× ×Ÿ ×§×˜×’×•×¨×™×•×ª ×©×™×© ×œ×”×Ÿ ×¢×¨×š
  const availableCategories = categories.filter(
    cat => breakdown[cat.key as keyof ScoreBreakdown] !== undefined && 
           breakdown[cat.key as keyof ScoreBreakdown] !== null
  );

  if (availableCategories.length === 0) {
    return (
      <div className="text-center py-3 text-sm text-gray-400 italic">
        ××™×Ÿ ×¤×™×¨×•×˜ × ×™×§×•×“ ×–××™×Ÿ ×œ×©×™×˜×” ×–×•
      </div>
    );
  }

  // ×—×™×©×•×‘ ×¡×”"×›
  const totalScore = availableCategories.reduce(
    (sum, cat) => sum + (breakdown[cat.key as keyof ScoreBreakdown] || 0),
    0
  );
  const maxTotal = availableCategories.reduce((sum, cat) => sum + cat.max, 0);

  return (
    <div className="space-y-3 mt-4 p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
      <div className="flex items-center justify-between mb-3">
        <h5 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <BarChart3 className="w-4 h-4 text-indigo-500" />
          ×¤×™×¨×•×˜ ×”× ×™×§×•×“
        </h5>
        <Badge variant="outline" className="text-xs">
          ×¡×”×´×›: {totalScore}/{maxTotal}
        </Badge>
      </div>
      
      <div className="space-y-2.5">
        {availableCategories.map((cat) => {
          const value = breakdown[cat.key as keyof ScoreBreakdown] || 0;
          const percentage = (value / cat.max) * 100;

          return (
            <div key={cat.key} className="group">
              <div className="flex items-center justify-between mb-1">
                <span className="text-xs text-gray-600 font-medium">{cat.label}</span>
                <span className="text-xs text-gray-500 font-semibold">
                  {value}/{cat.max}
                </span>
              </div>
              <div className="h-2.5 bg-gray-100 rounded-full overflow-hidden">
                <motion.div
                  initial={{ width: 0 }}
                  animate={{ width: `${percentage}%` }}
                  transition={{ duration: 0.6, delay: 0.1, ease: "easeOut" }}
                  className={cn(
                    'h-full rounded-full transition-all',
                    cat.color,
                    'group-hover:opacity-90'
                  )}
                />
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// =============================================================================
// REASONING CONTENT COMPONENT
// =============================================================================

const ReasoningContent: React.FC<{ reasoning: string | null }> = ({ reasoning }) => {
  if (!reasoning) {
    return (
      <p className="text-sm text-gray-400 italic text-center py-4">
        ××™×Ÿ × ×™××•×§ ×–××™×Ÿ ×œ×©×™×˜×” ×–×•
      </p>
    );
  }

  const paragraphs = reasoning.split(/\n\n+/).filter(p => p.trim());

  return (
    <div className="space-y-2">
      {paragraphs.map((para, index) => {
        const isList = para.includes('\n- ') || para.includes('\nâ€¢ ') || para.includes('\n* ');
        
        if (isList) {
          const lines = para.split('\n').filter(l => l.trim());
          return (
            <ul key={index} className="space-y-1.5 my-2">
              {lines.map((line, i) => {
                const cleanLine = line.replace(/^[*\-â€¢]\s*/, '').trim();
                if (!cleanLine) return null;
                return (
                  <li key={i} className="flex items-start gap-2 text-sm text-gray-700">
                    <span className="text-purple-400 mt-1">â€¢</span>
                    <span className="leading-relaxed">{cleanLine}</span>
                  </li>
                );
              })}
            </ul>
          );
        }

        return (
          <p key={index} className="text-sm text-gray-700 leading-relaxed">
            {para.trim()}
          </p>
        );
      })}
    </div>
  );
};

// =============================================================================
// SINGLE METHOD TAB CONTENT - ××©×•×¤×¨
// =============================================================================

const MethodTabContent: React.FC<{ 
  method: ScanMethodInfo; 
  isCurrentMethod: boolean;
}> = ({ method, isCurrentMethod }) => {
  
  // Debug log ×œ×‘×“×™×§×”
  console.log(`[MethodTabContent] ${method.key}:`, {
    score: method.score,
    hasReasoning: !!method.reasoning,
    hasBreakdown: !!method.scoreBreakdown,
    breakdown: method.scoreBreakdown
  });

  return (
    <div className="space-y-4">
      {/* Header with score and time */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <span className="text-2xl">{method.icon}</span>
          <div>
            <h4 className="font-bold text-gray-800">{method.label}</h4>
            <p className="text-xs text-gray-500">{method.description}</p>
          </div>
        </div>
        
        <div className="text-left">
          {method.score !== null && (
            <div className={cn('text-2xl font-bold', getScoreColor(method.score))}>
              {Math.round(method.score)}
            </div>
          )}
          {method.scannedAt && (
            <div className="text-xs text-gray-400 flex items-center gap-1">
              <Clock className="w-3 h-3" />
              {formatDistanceToNow(new Date(method.scannedAt), {
                addSuffix: true,
                locale: he,
              })}
            </div>
          )}
        </div>
      </div>

      {/* Current method badge */}
      {isCurrentMethod && (
        <Badge className="bg-emerald-100 text-emerald-700 border-emerald-200">
          <CheckCircle2 className="w-3 h-3 ml-1" />
          ×”×©×™×˜×” ×”× ×•×›×—×™×ª (×”×¦×™×•×Ÿ ×”××•×¦×’)
        </Badge>
      )}

      {/* Reasoning */}
      <div className={cn(
        'p-4 rounded-xl border',
        method.bgColor,
        method.borderColor
      )}>
        <div className="flex items-center gap-2 mb-3">
          <Brain className="w-4 h-4 text-gray-600" />
          <span className="text-sm font-medium text-gray-700">× ×™××•×§ ×”×”×ª×××”</span>
        </div>
        <ReasoningContent reasoning={method.reasoning} />
      </div>

      {/* Score Breakdown - ×ª××™×“ ××•×¦×’ ×× ×§×™×™× */}
      {method.scoreBreakdown && Object.keys(method.scoreBreakdown).length > 0 ? (
        <ScoreBreakdownDisplay 
          breakdown={method.scoreBreakdown} 
          methodKey={method.key}
        />
      ) : (
        method.key !== 'vector' && ( // ×•×§×˜×•×¨×™ ×œ× ×××•×¨ ×œ×”×™×•×ª ×œ×• breakdown
          <div className="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-100 text-center">
            <p className="text-xs text-gray-400">
              ×¤×™×¨×•×˜ × ×™×§×•×“ ×œ× ×–××™×Ÿ ×œ×©×™×˜×” ×–×•
            </p>
          </div>
        )
      )}
    </div>
  );
};

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const AllReasoningsDisplay: React.FC<AllReasoningsDisplayProps> = ({
  match,
  isOpen,
  onClose,
}) => {
  const methods = getScanMethods(match);
  
  // ×§×•×‘×¢ ××ª ×”×˜××‘ ×”×¤×¢×™×œ ×œ×¤×™ ×”×©×™×˜×” ×”××—×¨×•× ×” ××• ×”×¨××©×•× ×” ×‘×–××™× ×•×ª
  const getInitialTab = () => {
    if (match.lastScanMethod) {
      // ×”××¨×” ×-metrics_v2 ×œ-metricsV2 ×× ×¦×¨×™×š
      const normalizedMethod = match.lastScanMethod === 'metrics_v2' 
        ? 'metricsV2' 
        : match.lastScanMethod;
      
      if (methods.some(m => m.key === normalizedMethod)) {
        return normalizedMethod;
      }
    }
    return methods[0]?.key || 'hybrid';
  };
  
  const [activeTab, setActiveTab] = useState(getInitialTab());

  // Debug log
  console.log('[AllReasoningsDisplay] Match data:', {
    id: match.id,
    lastScanMethod: match.lastScanMethod,
    metricsV2Score: match.metricsV2Score,
    metricsV2ScoreBreakdown: match.metricsV2ScoreBreakdown,
    methods: methods.map(m => ({ key: m.key, hasBreakdown: !!m.scoreBreakdown }))
  });

  if (methods.length === 0) {
    return null;
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[90vh]" dir="rtl">
        <DialogHeader className="pb-4 border-b">
          <DialogTitle className="flex items-center gap-2 text-lg">
            <div className="p-2 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-500">
              <Brain className="w-5 h-5 text-white" />
            </div>
            × ×™×ª×•×—×™ AI ×œ×›×œ ×©×™×˜×•×ª ×”×¡×¨×™×§×”
          </DialogTitle>
          <p className="text-sm text-gray-500 mt-1">
            ×¦×¤×” ×‘× ×™××•×§×™×, ×¦×™×•× ×™× ×•×¤×™×¨×•×˜ ××›×œ ×©×™×˜×ª ×¡×¨×™×§×” ×©×”×•×¨×¦×”
          </p>
        </DialogHeader>

        <div className="py-4">
          <Tabs value={activeTab} onValueChange={setActiveTab} dir="rtl">
            {/* Tab List */}
            <TabsList 
              className="grid w-full mb-4" 
              style={{ gridTemplateColumns: `repeat(${methods.length}, 1fr)` }}
            >
              {methods.map((method) => {
                const isCurrentMethod = 
                  method.key === match.lastScanMethod ||
                  (method.key === 'metricsV2' && match.lastScanMethod === 'metrics_v2');
                
                return (
                  <TabsTrigger
                    key={method.key}
                    value={method.key}
                    className={cn(
                      'flex items-center gap-1.5 text-xs',
                      isCurrentMethod && 'ring-2 ring-emerald-400 ring-offset-1'
                    )}
                  >
                    <span>{method.icon}</span>
                    <span className="hidden sm:inline">{method.label}</span>
                    {method.score !== null && (
                      <Badge variant="secondary" className="text-[10px] px-1.5 py-0 h-5">
                        {Math.round(method.score)}
                      </Badge>
                    )}
                    {/* ××™× ×“×™×§×˜×•×¨ ×œ×¤×™×¨×•×˜ × ×™×§×•×“ */}
                    {method.scoreBreakdown && (
                      <BarChart3 className="w-3 h-3 text-indigo-400" />
                    )}
                  </TabsTrigger>
                );
              })}
            </TabsList>

            {/* Tab Contents */}
            <div className="max-h-[50vh] overflow-y-auto">
              {methods.map((method) => {
                const isCurrentMethod = 
                  method.key === match.lastScanMethod ||
                  (method.key === 'metricsV2' && match.lastScanMethod === 'metrics_v2');
                
                return (
                  <TabsContent key={method.key} value={method.key} className="mt-0">
                    <MethodTabContent
                      method={method}
                      isCurrentMethod={isCurrentMethod}
                    />
                  </TabsContent>
                );
              })}
            </div>
          </Tabs>
        </div>

        {/* Footer */}
        <div className="pt-4 border-t flex justify-between items-center">
          <div className="text-xs text-gray-400 flex items-center gap-2">
            <span>{methods.length} ×©×™×˜×•×ª ×¡×¨×™×§×” ×–××™× ×•×ª</span>
            {methods.some(m => m.scoreBreakdown) && (
              <Badge variant="outline" className="text-[10px]">
                <BarChart3 className="w-3 h-3 ml-1" />
                ×›×•×œ×œ ×¤×™×¨×•×˜ × ×™×§×•×“
              </Badge>
            )}
          </div>
          <Button variant="outline" size="sm" onClick={onClose}>
            ×¡×’×•×¨
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default AllReasoningsDisplay;
--- End of Content for AllReasoningsDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\BatchScanButtons.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/BatchScanButtons.tsx

'use client';

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import {
  Moon,
  Brain,
  Zap,
  Users,
  Target,
  Loader2,
  X,
  CheckCircle2,
  Clock,
  Rocket,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type ScanMethod = 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2';

interface ScanProgress {
  phase?: string;
  method?: ScanMethod;
  currentUserIndex?: number;
  totalUsers?: number;
  currentUserName?: string;
  progressPercent?: number;
  matchesFoundSoFar?: number;
  newMatchesFoundSoFar?: number;
  usersScanned?: number;
  message?: string;
  stats?: {
    matchesFoundSoFar?: number;
  };
  preparationStats?: {
    currentIndex: number;
    totalNeedingUpdate: number;
    currentUserName?: string;
    updated: number;
    skipped?: number;
    failed: number;
    aiCallsMade?: number;
    embeddingCallsMade?: number;
  };
}

interface ScanResult {
  matchesFound?: number;
  newMatches?: number;
  totalMatchesFound?: number;
  newMatchesFound?: number;
}

interface BatchScanButtonsProps {
  isScanning: boolean;
  scanProgress: ScanProgress | null;
  scanResult: ScanResult | null;
  onStartScan: (method: ScanMethod, skipPreparation: boolean) => void;
  onCancelScan: () => void;
  lastScanInfo?: {
    date: Date;
    matchCount: number;
  } | null;
  className?: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Method Configurations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const METHOD_CONFIG: Record<
  ScanMethod,
  {
    label: string;
    icon: typeof Brain;
    gradient: string;
    hoverGradient: string;
    time: string;
    fastTime: string;
  }
> = {
  algorithmic: {
    label: 'AI ××ª×§×“×',
    icon: Brain,
    gradient: 'from-purple-500 to-purple-600',
    hoverGradient: 'hover:from-purple-600 hover:to-purple-700',
    time: '~5 ×“×§',
    fastTime: '~2 ×“×§',
  },
  vector: {
    label: '×“××™×•×Ÿ ××”×™×¨ âš¡',
    icon: Zap,
    gradient: 'from-blue-500 to-cyan-500',
    hoverGradient: 'hover:from-blue-600 hover:to-cyan-600',
    time: '~1 ×“×§',
    fastTime: '~20 ×©× ',
  },
  hybrid: {
    label: '×”×™×‘×¨×™×“×™ ğŸ”¥',
    icon: Users,
    gradient: 'from-emerald-500 to-teal-500',
    hoverGradient: 'hover:from-emerald-600 hover:to-teal-600',
    time: '~3 ×“×§',
    fastTime: '~1 ×“×§',
  },
  metrics_v2: {
    label: '××“×“×™× V2 ğŸ¯',
    icon: Target,
    gradient: 'from-indigo-500 to-violet-500',
    hoverGradient: 'hover:from-indigo-600 hover:to-violet-600',
    time: '~4 ×“×§',
    fastTime: '~1.5 ×“×§',
  },
};

const METHODS_ORDER: ScanMethod[] = [
  'algorithmic',
  'vector',
  'hybrid',
  'metrics_v2',
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BatchScanButtons: React.FC<BatchScanButtonsProps> = ({
  isScanning,
  scanProgress,
  scanResult,
  onStartScan,
  onCancelScan,
  lastScanInfo,
  className,
}) => {
  const [skipPreparation, setSkipPreparation] = useState(false);
  const currentMethod = scanProgress?.method;

  const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString('he-IL', {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Render: Progress State
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (isScanning && scanProgress) {
    const config = METHOD_CONFIG[currentMethod || 'hybrid'];

    return (
      <Card className={cn('p-4', className)}>
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="space-y-4"
        >
          {/* Header */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div
                className={cn(
                  'p-2.5 rounded-xl bg-gradient-to-r shadow-lg',
                  config.gradient
                )}
              >
                <Loader2 className="w-5 h-5 text-white animate-spin" />
              </div>
              <div>
                <h3 className="font-bold text-gray-800 flex items-center gap-2">
                  ×¡×¨×™×§×ª{' '}
                  {config.label
                    .replace(' ğŸ”¥', '')
                    .replace(' âš¡', '')
                    .replace(' ğŸ¯', '')}
                  {scanProgress.phase !== 'preparing' &&
                    scanProgress.currentUserName && (
                      <Badge
                        variant="secondary"
                        className="font-normal text-xs"
                      >
                        {scanProgress.currentUserName}
                      </Badge>
                    )}
                </h3>
                {/* âœ… ×ª×•×§×Ÿ: ×”×•×¦×× ×• ××ª ×”-div ××ª×•×š ×”-p */}
                <p className="text-sm text-gray-500">
                  {scanProgress.phase === 'preparing'
                    ? '××›×™×Ÿ × ×ª×•× ×™×...'
                    : scanProgress.message || '××¢×‘×“...'}
                </p>
              </div>
            </div>

            <Button
              variant="ghost"
              size="sm"
              onClick={onCancelScan}
              className="text-red-500 hover:text-red-700 hover:bg-red-50"
            >
              <X className="w-4 h-4 ml-1" />
              ×‘×˜×œ
            </Button>
          </div>

          {/* âœ… Preparation Stats - ×”×•×¢×‘×¨ ×œ××§×•× × ×¤×¨×“ */}
          {scanProgress.phase === 'preparing' &&
            scanProgress.preparationStats && (
              <div className="space-y-3 p-3 bg-amber-50 rounded-lg border border-amber-100">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2 text-amber-700">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    <span className="font-medium text-sm">
                      ××›×™×Ÿ × ×ª×•× ×™× ({scanProgress.preparationStats.currentIndex}/
                      {scanProgress.preparationStats.totalNeedingUpdate})
                    </span>
                  </div>
                  {scanProgress.preparationStats.currentUserName && (
                    <Badge variant="outline" className="text-xs bg-white">
                      {scanProgress.preparationStats.currentUserName}
                    </Badge>
                  )}
                </div>

                {/* Progress Bar for Preparation */}
                <Progress
                  value={
                    scanProgress.preparationStats.totalNeedingUpdate > 0
                      ? (scanProgress.preparationStats.currentIndex /
                          scanProgress.preparationStats.totalNeedingUpdate) *
                        100
                      : 0
                  }
                  className="h-2"
                />

                {/* Stats Grid */}
                <div className="grid grid-cols-4 gap-2 text-xs">
                  <div className="text-center p-1.5 bg-emerald-100 rounded">
                    <div className="font-bold text-emerald-700">
                      {scanProgress.preparationStats.updated}
                    </div>
                    <div className="text-emerald-600">×¢×•×“×›× ×•</div>
                  </div>
                  <div className="text-center p-1.5 bg-blue-100 rounded">
                    <div className="font-bold text-blue-700">
                      {scanProgress.preparationStats.skipped || 0}
                    </div>
                    <div className="text-blue-600">×“×•×œ×’×•</div>
                  </div>
                  <div className="text-center p-1.5 bg-red-100 rounded">
                    <div className="font-bold text-red-700">
                      {scanProgress.preparationStats.failed}
                    </div>
                    <div className="text-red-600">× ×›×©×œ×•</div>
                  </div>
                  <div className="text-center p-1.5 bg-purple-100 rounded">
                    <div className="font-bold text-purple-700">
                      {scanProgress.preparationStats.aiCallsMade || 0}
                    </div>
                    <div className="text-purple-600">×§×¨×™××•×ª AI</div>
                  </div>
                </div>
              </div>
            )}

          {/* Progress Bar - Only show in scanning phase */}
          {scanProgress.phase !== 'preparing' && (
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">
                  {scanProgress.currentUserIndex || 0} /{' '}
                  {scanProgress.totalUsers || '?'} ××©×ª××©×™×
                </span>
                <span className="font-medium text-gray-800">
                  {scanProgress.progressPercent || 0}%
                </span>
              </div>
              <Progress
                value={scanProgress.progressPercent || 0}
                className="h-3"
              />
            </div>
          )}

          {/* Stats - Only show in scanning phase */}
          {scanProgress.phase !== 'preparing' && (
            <div className="grid grid-cols-3 gap-3">
              <div className="flex items-center gap-2 p-2 rounded-lg bg-blue-50 border border-blue-100">
                <Users className="w-4 h-4 text-blue-600" />
                <div className="flex flex-col">
                  <span className="text-xs text-blue-600">× ×¡×¨×§×•</span>
                  <span className="font-bold text-blue-800">
                    {scanProgress.usersScanned ||
                      scanProgress.currentUserIndex ||
                      0}
                  </span>
                </div>
              </div>
              <div className="flex items-center gap-2 p-2 rounded-lg bg-emerald-50 border border-emerald-100">
                <CheckCircle2 className="w-4 h-4 text-emerald-600" />
                <div className="flex flex-col">
                  <span className="text-xs text-emerald-600">×”×ª×××•×ª</span>
                  <span className="font-bold text-emerald-800">
                    {scanProgress.matchesFoundSoFar ||
                      scanProgress.stats?.matchesFoundSoFar ||
                      0}
                  </span>
                </div>
              </div>
              <div className="flex items-center gap-2 p-2 rounded-lg bg-purple-50 border border-purple-100">
                <Target className="w-4 h-4 text-purple-600" />
                <div className="flex flex-col">
                  <span className="text-xs text-purple-600">×—×“×©×•×ª</span>
                  <span className="font-bold text-purple-800">
                    {scanProgress.newMatchesFoundSoFar || 0}
                  </span>
                </div>
              </div>
            </div>
          )}
        </motion.div>
      </Card>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Render: Buttons (idle state)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return (
    <Card className={cn('p-4', className)}>
      <div className="space-y-4">
        {/* Header & Toggle */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 shadow-lg">
              <Moon className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="font-bold text-gray-800">×¡×¨×™×§×” ×œ×™×œ×™×ª</h3>
              <p className="text-xs text-gray-500">
                {skipPreparation
                  ? '××¦×‘ ××”×™×¨ ×¤×¢×™×œ'
                  : '××¦×‘ ×¨×’×™×œ (×›×•×œ×œ ×¢×“×›×•×Ÿ × ×ª×•× ×™×)'}
              </p>
            </div>
          </div>

          {/* Quick Scan Toggle */}
          <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100">
            <Checkbox
              id="skip-prep"
              checked={skipPreparation}
              onCheckedChange={(checked) =>
                setSkipPreparation(checked as boolean)
              }
              className={cn(
                'data-[state=checked]:bg-orange-500 data-[state=checked]:border-orange-500',
                'w-5 h-5'
              )}
            />
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Label
                    htmlFor="skip-prep"
                    className="text-xs font-medium cursor-pointer flex items-center gap-1.5"
                  >
                    <Rocket
                      className={cn(
                        'w-3.5 h-3.5',
                        skipPreparation ? 'text-orange-500' : 'text-gray-400'
                      )}
                    />
                    ×¡×¨×™×§×” ××”×™×¨×”
                  </Label>
                </TooltipTrigger>
                <TooltipContent>
                  <p className="text-xs max-w-[200px]">
                    ××“×œ×’ ×¢×œ ×¢×“×›×•×Ÿ ××“×“×™× ×•× ×ª×•× ×™ AI ×œ××•×¢××“×™× (×—×•×¡×š ×–××Ÿ ××©××¢×•×ª×™, ××š
                    ×”× ×ª×•× ×™× ×¢×©×•×™×™× ×œ×”×™×•×ª ×¤×—×•×ª ×¢×“×›× ×™×™×)
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>
        </div>

        {/* Buttons Row */}
        <div className="flex gap-2 flex-wrap">
          {METHODS_ORDER.map((method) => {
            const config = METHOD_CONFIG[method];
            const Icon = config.icon;

            return (
              <motion.div
                key={method}
                className="flex-1 min-w-[120px]"
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                <Button
                  onClick={() => onStartScan(method, skipPreparation)}
                  className={cn(
                    'w-full h-11 font-bold transition-all duration-300 shadow-lg px-2 sm:px-4 flex-col gap-0',
                    `bg-gradient-to-r ${config.gradient} ${config.hoverGradient} text-white`,
                    skipPreparation && 'ring-2 ring-orange-400 ring-offset-1'
                  )}
                >
                  <div className="flex items-center gap-1.5">
                    <Icon className="w-4 h-4" />
                    <span className="truncate text-xs sm:text-sm">
                      {config.label}
                    </span>
                  </div>
                </Button>
              </motion.div>
            );
          })}
        </div>

        {/* Time estimates */}
        <div className="flex gap-2 text-[10px] text-gray-400 px-1">
          {METHODS_ORDER.map((method) => (
            <span
              key={method}
              className="flex-1 text-center truncate min-w-[120px]"
            >
              {skipPreparation
                ? METHOD_CONFIG[method].fastTime
                : METHOD_CONFIG[method].time}
            </span>
          ))}
        </div>

        {/* Completion Banner */}
        <AnimatePresence>
          {scanResult && (
            <motion.div
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="p-3 rounded-lg bg-emerald-50 border border-emerald-200 mt-2"
            >
              <div className="flex items-center gap-2">
                <CheckCircle2 className="w-5 h-5 text-emerald-600" />
                <span className="font-medium text-emerald-800">
                  ×”×¡×¨×™×§×” ×”×•×©×œ××”!
                </span>
              </div>
              <p className="text-sm text-emerald-700 mt-1">
                × ××¦××•{' '}
                {scanResult.matchesFound || scanResult.totalMatchesFound || 0}{' '}
                ×”×ª×××•×ª (
                {scanResult.newMatches || scanResult.newMatchesFound || 0}{' '}
                ×—×“×©×•×ª)
              </p>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Last Scan Info */}
        {lastScanInfo && !scanResult && (
          <div className="flex items-center gap-2 text-xs text-gray-400 pt-3 border-t">
            <Clock className="w-3.5 h-3.5" />
            <span>
              ×¡×¨×™×§×” ××—×¨×•× ×”: {formatDate(lastScanInfo.date)}(
              {lastScanInfo.matchCount} ×”×ª×××•×ª)
            </span>
          </div>
        )}
      </div>
    </Card>
  );
};

export default BatchScanButtons;
--- End of Content for BatchScanButtons.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\HiddenCandidatesDrawer.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/HiddenCandidatesDrawer.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
  SheetDescription,
} from '@/components/ui/sheet';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  EyeOff,
  Undo2,
  Calendar,
  MapPin,
  User,
  Edit2,
  Check,
  X,
  Loader2,
  Users,
} from 'lucide-react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import type { HiddenCandidateInfo } from './hooks/useHiddenCandidates';

// =============================================================================
// TYPES
// =============================================================================

interface HiddenCandidatesDrawerProps {
  hiddenCandidates: HiddenCandidateInfo[];
  onUnhide: (hiddenRecordId: string) => Promise<boolean>;
  onUpdateReason: (hiddenRecordId: string, reason: string) => Promise<boolean>;
  isLoading?: boolean;
  className?: string;
}

// =============================================================================
// SUB-COMPONENTS
// =============================================================================

// ×›×¨×˜×™×¡ ××•×¢××“ ××•×¡×ª×¨ ×‘×•×“×“
const HiddenCandidateCard: React.FC<{
  candidate: HiddenCandidateInfo;
  onUnhide: () => void;
  onUpdateReason: (reason: string) => void;
  isUnhiding: boolean;
}> = ({ candidate, onUnhide, onUpdateReason, isUnhiding }) => {
  const [isEditingReason, setIsEditingReason] = useState(false);
  const [editedReason, setEditedReason] = useState(candidate.reason || '');
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);

  const handleSaveReason = () => {
    onUpdateReason(editedReason);
    setIsEditingReason(false);
  };

  const genderIcon = candidate.candidate.gender === 'MALE' ? 'ğŸ‘¨' : 'ğŸ‘©';
  const borderColor =
    candidate.candidate.gender === 'MALE'
      ? 'border-blue-200 hover:border-blue-300'
      : 'border-pink-200 hover:border-pink-300';

  return (
    <>
      <motion.div
        layout
        initial={{ opacity: 0, x: 20 }}
        animate={{ opacity: 1, x: 0 }}
        exit={{ opacity: 0, x: -20 }}
        className={cn(
          'relative p-3 rounded-xl border-2 bg-white/80 backdrop-blur-sm transition-all duration-200',
          borderColor
        )}
      >
        <div className="flex items-start gap-3">
          {/* ×ª××•× ×” */}
          <div className="relative w-12 h-12 rounded-full overflow-hidden border-2 border-white shadow-sm flex-shrink-0">
            {candidate.candidate.mainImage ? (
              <Image
                src={getRelativeCloudinaryPath(candidate.candidate.mainImage)}
                alt={`${candidate.candidate.firstName} ${candidate.candidate.lastName}`}
                fill
                className="object-cover"
              />
            ) : (
              <div className="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-lg">
                {genderIcon}
              </div>
            )}
          </div>

          {/* ×¤×¨×˜×™× */}
          <div className="flex-1 min-w-0">
            <h4 className="font-semibold text-gray-800 truncate">
              {candidate.candidate.firstName} {candidate.candidate.lastName}
            </h4>

            <div className="flex items-center gap-2 text-xs text-gray-500 mt-0.5">
              {candidate.candidate.city && (
                <span className="flex items-center gap-0.5">
                  <MapPin className="w-3 h-3" />
                  {candidate.candidate.city}
                </span>
              )}
            </div>

            {/* ×¡×™×‘×ª ×”×¡×ª×¨×” */}
            <div className="mt-2">
              {isEditingReason ? (
                <div className="flex items-center gap-1">
                  <Input
                    value={editedReason}
                    onChange={(e) => setEditedReason(e.target.value)}
                    placeholder="×¡×™×‘×” ×œ×”×¡×ª×¨×”..."
                    className="h-7 text-xs flex-1"
                    autoFocus
                  />
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-7 w-7 text-green-600 hover:bg-green-50"
                    onClick={handleSaveReason}
                  >
                    <Check className="w-3.5 h-3.5" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-7 w-7 text-gray-400 hover:bg-gray-100"
                    onClick={() => {
                      setIsEditingReason(false);
                      setEditedReason(candidate.reason || '');
                    }}
                  >
                    <X className="w-3.5 h-3.5" />
                  </Button>
                </div>
              ) : (
                <div className="flex items-center gap-1">
                  {candidate.reason ? (
                    <Badge
                      variant="secondary"
                      className="text-[10px] bg-amber-50 text-amber-700 border border-amber-200"
                    >
                      {candidate.reason}
                    </Badge>
                  ) : (
                    <span className="text-[10px] text-gray-400 italic">
                      ×œ×œ× ×¡×™×‘×”
                    </span>
                  )}
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-5 w-5 text-gray-400 hover:text-gray-600"
                          onClick={() => setIsEditingReason(true)}
                        >
                          <Edit2 className="w-3 h-3" />
                        </Button>
                      </TooltipTrigger>
                      <TooltipContent>
                        <p>×¢×¨×•×š ×¡×™×‘×”</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </div>
              )}
            </div>

            {/* ×ª××¨×™×š ×”×¡×ª×¨×” */}
            <div className="flex items-center gap-1 text-[10px] text-gray-400 mt-1">
              <Calendar className="w-3 h-3" />
              ×”×•×¡×ª×¨{' '}
              {formatDistanceToNow(new Date(candidate.hiddenAt), {
                addSuffix: true,
                locale: he,
              })}
            </div>
          </div>

          {/* ×›×¤×ª×•×¨ ×”×—×–×¨×” */}
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="outline"
                  size="icon"
                  className="h-9 w-9 rounded-full border-2 border-green-200 text-green-600 hover:bg-green-50 hover:border-green-300 transition-all flex-shrink-0"
                  onClick={() => setShowConfirmDialog(true)}
                  disabled={isUnhiding}
                >
                  {isUnhiding ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Undo2 className="w-4 h-4" />
                  )}
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>×”×—×–×¨ ×œ×¨×©×™××ª ×”×”×¦×¢×•×ª</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        </div>
      </motion.div>

      {/* ×“×™××œ×•×’ ××™×©×•×¨ */}
      <AlertDialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>
              ×œ×”×—×–×™×¨ ××ª {candidate.candidate.firstName} ×œ×¨×©×™××”?
            </AlertDialogTitle>
            <AlertDialogDescription>
              ×”×”×¦×¢×•×ª ×”×¤×•×˜× ×¦×™××œ×™×•×ª ×¢× {candidate.candidate.firstName}{' '}
              {candidate.candidate.lastName} ×™×—×–×¨×• ×œ×”×•×¤×™×¢ ×‘×¨×©×™××”.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>×‘×™×˜×•×œ</AlertDialogCancel>
            <AlertDialogAction
              onClick={onUnhide}
              className="bg-green-600 hover:bg-green-700"
            >
              ×”×—×–×¨ ×œ×¨×©×™××”
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
};

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const HiddenCandidatesDrawer: React.FC<HiddenCandidatesDrawerProps> = ({
  hiddenCandidates,
  onUnhide,
  onUpdateReason,
  isLoading = false,
  className,
}) => {
  const [unhidingId, setUnhidingId] = useState<string | null>(null);
  const [isOpen, setIsOpen] = useState(false);

  const handleUnhide = async (hiddenRecordId: string) => {
    setUnhidingId(hiddenRecordId);
    const success = await onUnhide(hiddenRecordId);
    setUnhidingId(null);

    // ×× ×–×” ×”×™×” ×”××—×¨×•×Ÿ, ×¡×’×•×¨ ××ª ×”-drawer
    if (success && hiddenCandidates.length === 1) {
      setIsOpen(false);
    }
  };

  const count = hiddenCandidates.length;

  return (
    <Sheet open={isOpen} onOpenChange={setIsOpen}>
      <SheetTrigger asChild>
        <Button
          variant="outline"
          className={cn(
            'gap-2 border-2 transition-all',
            count > 0
              ? 'border-amber-200 bg-amber-50 text-amber-700 hover:bg-amber-100 hover:border-amber-300'
              : 'border-gray-200 text-gray-500',
            className
          )}
        >
          <EyeOff className="w-4 h-4" />
          <span className="hidden sm:inline">××•×¡×ª×¨×™×</span>
          {count > 0 && (
            <Badge
              variant="secondary"
              className="bg-amber-200 text-amber-800 h-5 min-w-5 text-xs"
            >
              {count}
            </Badge>
          )}
        </Button>
      </SheetTrigger>

      <SheetContent
        side="left"
        className="w-full sm:max-w-md p-0 flex flex-col"
      >
        <SheetHeader className="p-4 pb-2 border-b bg-gradient-to-br from-amber-50 to-orange-50">
          <div className="flex items-center justify-between">
            <SheetTitle className="flex items-center gap-2 text-amber-800">
              <EyeOff className="w-5 h-5" />
              ××•×¢××“×™× ××•×¡×ª×¨×™×
              {count > 0 && (
                <Badge className="bg-amber-600 text-white">{count}</Badge>
              )}
            </SheetTitle>

            {/* ×›×¤×ª×•×¨ ×¡×’×™×¨×” ×™×“× ×™ - X */}
            <Button
              variant="ghost"
              size="icon"
              className="-ml-2 text-amber-800 hover:bg-amber-100 rounded-full"
              onClick={() => setIsOpen(false)}
            >
              <X className="w-5 h-5" />
            </Button>
          </div>

          <SheetDescription className="text-amber-700/70 text-sm">
            ××•×¢××“×™× ×©×”×¡×ª×¨×ª ×œ× ×™×•×¤×™×¢×• ×‘×”×¦×¢×•×ª ×”×¤×•×˜× ×¦×™××œ×™×•×ª
          </SheetDescription>
        </SheetHeader>

        <ScrollArea className="flex-1 p-4">
          {isLoading ? (
            <div className="flex flex-col items-center justify-center py-12 text-gray-400">
              <Loader2 className="w-8 h-8 animate-spin mb-2" />
              <p className="text-sm">×˜×•×¢×Ÿ...</p>
            </div>
          ) : count === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-gray-400">
              <Users className="w-12 h-12 mb-3 opacity-50" />
              <p className="text-sm font-medium">××™×Ÿ ××•×¢××“×™× ××•×¡×ª×¨×™×</p>
              <p className="text-xs mt-1 text-center px-4">
                ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×”×¡×ª×¨×” ×œ×™×“ ×©× ×”××•×¢××“ ×‘×›×¨×˜×™×¡ ×”×”×¦×¢×” ×›×“×™ ×œ×”×¡×ª×™×¨ ××•×ª×•
                ×–×× ×™×ª
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              <AnimatePresence mode="popLayout">
                {hiddenCandidates.map((candidate) => (
                  <HiddenCandidateCard
                    key={candidate.id}
                    candidate={candidate}
                    onUnhide={() => handleUnhide(candidate.id)}
                    onUpdateReason={(reason) =>
                      onUpdateReason(candidate.id, reason)
                    }
                    isUnhiding={unhidingId === candidate.id}
                  />
                ))}
              </AnimatePresence>
            </div>
          )}
        </ScrollArea>

        {/* Footer ×¢× ×›×¤×ª×•×¨ ×¡×’×™×¨×” ×•×˜×™×¤ */}
        <div className="p-3 border-t bg-gray-50 flex flex-col gap-3">
          {count > 0 && (
            <p className="text-[10px] text-gray-500 text-center">
              ğŸ’¡ ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×”×—×–×¨×” ×›×“×™ ×œ×”×¦×™×’ ×©×•×‘ ××ª ×”×”×¦×¢×•×ª ×¢× ×”××•×¢××“
            </p>
          )}

          <Button
            variant="outline"
            className="w-full border-gray-300"
            onClick={() => setIsOpen(false)}
          >
            ×¡×’×•×¨
          </Button>
        </div>
      </SheetContent>
    </Sheet>
  );
};

export default HiddenCandidatesDrawer;
--- End of Content for HiddenCandidatesDrawer.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\HideCandidateDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/HideCandidateDialog.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { EyeOff, Loader2 } from 'lucide-react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';

// =============================================================================
// TYPES
// =============================================================================

export interface CandidateToHide {
  id: string;
  firstName: string;
  lastName: string;
  mainImage?: string | null;
  gender?: 'MALE' | 'FEMALE' | null;
}

interface HideCandidateDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  candidate: CandidateToHide | null;
  onConfirm: (candidateId: string, reason?: string) => Promise<boolean>;
}

// =============================================================================
// PRESET REASONS
// =============================================================================

const PRESET_REASONS = [
  { value: 'dating', label: 'ğŸ’‘ ×‘×“×™×™×˜×™× ×›×¨×’×¢' },
  { value: 'waiting', label: 'â³ ×××ª×™×Ÿ ×œ×ª×©×•×‘×”' },
  { value: 'break', label: 'â˜• ×‘×”×¤×¡×§×” ××—×™×¤×•×©×™×' },
  { value: 'not_ready', label: 'ğŸš« ×œ× ××•×›×Ÿ ×œ×”×¦×¢×•×ª' },
  { value: 'custom', label: 'âœï¸ ×¡×™×‘×” ××—×¨×ª...' },
  { value: 'none', label: 'â– ×œ×œ× ×¡×™×‘×”' },
];

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const HideCandidateDialog: React.FC<HideCandidateDialogProps> = ({
  open,
  onOpenChange,
  candidate,
  onConfirm,
}) => {
  const [selectedReason, setSelectedReason] = useState<string>('none');
  const [customReason, setCustomReason] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleConfirm = async () => {
    if (!candidate) return;

    setIsSubmitting(true);

    // ×§×‘×™×¢×ª ×”×¡×™×‘×” ×”×¡×•×¤×™×ª
    let finalReason: string | undefined;
    if (selectedReason === 'custom' && customReason.trim()) {
      finalReason = customReason.trim();
    } else if (selectedReason !== 'none' && selectedReason !== 'custom') {
      finalReason = PRESET_REASONS.find(r => r.value === selectedReason)?.label.replace(/^[^\s]+ /, '');
    }

    const success = await onConfirm(candidate.id, finalReason);
    
    setIsSubmitting(false);

    if (success) {
      // Reset state
      setSelectedReason('none');
      setCustomReason('');
      onOpenChange(false);
    }
  };

  const handleClose = () => {
    if (!isSubmitting) {
      setSelectedReason('none');
      setCustomReason('');
      onOpenChange(false);
    }
  };

  if (!candidate) return null;

  const genderIcon = candidate.gender === 'MALE' ? 'ğŸ‘¨' : 'ğŸ‘©';

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <EyeOff className="w-5 h-5 text-amber-600" />
            ×”×¡×ª×¨×ª ××•×¢××“/×ª
          </DialogTitle>
          <DialogDescription>
            ×›×œ ×”×”×¦×¢×•×ª ×”×¤×•×˜× ×¦×™××œ×™×•×ª ×¢× ××•×¢××“/×ª ×–×”/×–×• ×œ× ×™×•×¤×™×¢×• ×‘×¨×©×™××”
          </DialogDescription>
        </DialogHeader>

        {/* ×¤×¨×˜×™ ×”××•×¢××“ */}
        <div className="flex items-center gap-3 p-3 rounded-lg bg-gray-50 border">
          <div className="relative w-12 h-12 rounded-full overflow-hidden border-2 border-white shadow-sm">
            {candidate.mainImage ? (
              <Image
                src={getRelativeCloudinaryPath(candidate.mainImage)}
                alt={`${candidate.firstName} ${candidate.lastName}`}
                fill
                className="object-cover"
              />
            ) : (
              <div className="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-lg">
                {genderIcon}
              </div>
            )}
          </div>
          <div>
            <p className="font-semibold text-gray-800">
              {candidate.firstName} {candidate.lastName}
            </p>
            <p className="text-xs text-gray-500">
              ×™×•×¡×ª×¨/×ª×•×¡×ª×¨ ××›×œ ×”×”×¦×¢×•×ª ×”×¤×•×˜× ×¦×™××œ×™×•×ª
            </p>
          </div>
        </div>

        {/* ×‘×—×™×¨×ª ×¡×™×‘×” */}
        <div className="space-y-3">
          <Label className="text-sm font-medium">×¡×™×‘×” ×œ×”×¡×ª×¨×” (××•×¤×¦×™×•× ×œ×™)</Label>
          
          <RadioGroup
            value={selectedReason}
            onValueChange={setSelectedReason}
            className="grid grid-cols-2 gap-2"
          >
            {PRESET_REASONS.map((reason) => (
              <div key={reason.value}>
                <RadioGroupItem
                  value={reason.value}
                  id={reason.value}
                  className="peer sr-only"
                />
                <Label
                  htmlFor={reason.value}
                  className={cn(
                    'flex items-center justify-center rounded-lg border-2 p-2.5 text-xs cursor-pointer transition-all',
                    'hover:bg-amber-50 hover:border-amber-200',
                    'peer-data-[state=checked]:bg-amber-100 peer-data-[state=checked]:border-amber-400 peer-data-[state=checked]:text-amber-800'
                  )}
                >
                  {reason.label}
                </Label>
              </div>
            ))}
          </RadioGroup>

          {/* ×©×“×” ×¡×™×‘×” ××•×ª×××ª ××™×©×™×ª */}
          {selectedReason === 'custom' && (
            <Input
              placeholder="×”×§×œ×“ ×¡×™×‘×”..."
              value={customReason}
              onChange={(e) => setCustomReason(e.target.value)}
              className="mt-2"
              autoFocus
            />
          )}
        </div>

        <DialogFooter className="flex gap-2 sm:gap-2">
          <Button
            variant="outline"
            onClick={handleClose}
            disabled={isSubmitting}
            className="flex-1 sm:flex-none"
          >
            ×‘×™×˜×•×œ
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={isSubmitting}
            className="flex-1 sm:flex-none bg-amber-600 hover:bg-amber-700 text-white gap-2"
          >
            {isSubmitting ? (
              <>
                <Loader2 className="w-4 h-4 animate-spin" />
                ××¡×ª×™×¨...
              </>
            ) : (
              <>
                <EyeOff className="w-4 h-4" />
                ×”×¡×ª×¨
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};

export default HideCandidateDialog;
--- End of Content for HideCandidateDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\MatchmakerDashboard.tsx
--------------------------------------------------------------------------------
Content:
// =============================================================================
// ğŸ“ src/components/matchmaker/new/PotentialMatches/MatchmakerDashboard.tsx
// =============================================================================

'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Users,
  UserPlus,
  Heart,
  Bell,
  AlertTriangle,
  Clock,
  RefreshCw,
  ChevronRight,
  TrendingUp,
  Calendar,
  CheckCircle,
  XCircle,
  MessageSquare,
  Sparkles,
  BarChart,
  PlayCircle, // ××™×™×§×•×Ÿ ×—×“×© ×œ×›×¤×ª×•×¨ ×”×˜×¢×™× ×”
} from 'lucide-react';

// ... (×›×œ ×”-Interfaces × ×©××¨×™× ××•×ª×• ×“×‘×¨, ××™×Ÿ ×©×™× ×•×™ ×‘-Types)
interface DashboardStats {
  totalActiveUsers: number;
  maleCount: number;
  femaleCount: number;
  newUsersThisWeek: number;
  newUsersToday: number;
  totalPotentialMatches: number;
  pendingMatches: number;
  sentSuggestions: number;
  activeMatches: number;
  matchesThisWeek: number;
  suggestionsThisWeek: number;
  acceptanceRate: number;
  usersWithNoMatches: number;
  usersWaitingLong: number;
  incompleteProfiles: number;
}

interface PriorityUserCard {
  userId: string;
  firstName: string;
  lastName: string;
  gender: 'MALE' | 'FEMALE';
  age: number | null;
  city: string | null;
  mainImage: string | null;
  priorityScore: number;
  category: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  isNewUser: boolean;
  isNeglected: boolean;
  hasNoPendingMatches: boolean;
  daysSinceRegistration: number;
  daysSinceLastSuggestion: number | null;
  pendingMatchesCount: number;
  profileCompleteness: number;
  tags: string[];
}

interface AlertResult {
  id: string;
  userId: string;
  type: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO';
  title: string;
  message: string;
  createdAt: string;
  isRead: boolean;
  user?: {
    firstName: string;
    lastName: string;
    gender: string;
    mainImage: string | null;
    city: string | null;
  };
}

interface RecentActivity {
  id: string;
  type: string;
  title: string;
  description: string;
  timestamp: string;
  userId?: string;
}

interface DashboardData {
  stats: DashboardStats;
  criticalUsers: PriorityUserCard[];
  highPriorityUsers: PriorityUserCard[];
  alerts: {
    total: number;
    unread: number;
    bySeverity: {
      critical: number;
      high: number;
      medium: number;
      low: number;
      info: number;
    };
    alerts: AlertResult[];
  };
  recentActivity: RecentActivity[];
  quickActions: {
    newUsersToReview: number;
    matchesToReview: number;
    suggestionsToFollow: number;
  };
  lastScan: {
    timestamp: string | null;
    matchesFound: number;
    duration: number | null;
  } | null;
  generatedAt: string;
}

// ... (Sub-Components × ×©××¨×™× ×œ×œ× ×©×™× ×•×™: StatCard, PriorityUserCardComponent, AlertItem, ActivityItem, formatTimeAgo)

const StatCard: React.FC<{
  title: string;
  value: number | string;
  subtitle?: string;
  icon: React.ReactNode;
  color: string;
  trend?: number;
}> = ({ title, value, subtitle, icon, color, trend }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    className={`bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow`}
  >
    <div className="flex items-start justify-between">
      <div>
        <p className="text-sm text-gray-500">{title}</p>
        <p className="text-2xl font-bold text-gray-800 mt-1">{value}</p>
        {subtitle && <p className="text-xs text-gray-400 mt-1">{subtitle}</p>}
        {trend !== undefined && (
          <div
            className={`flex items-center mt-2 text-xs ${trend >= 0 ? 'text-green-600' : 'text-red-600'}`}
          >
            <TrendingUp size={12} className={trend < 0 ? 'rotate-180' : ''} />
            <span className="mr-1">{Math.abs(trend)}%</span>
            <span className="text-gray-400">××”×©×‘×•×¢ ×©×¢×‘×¨</span>
          </div>
        )}
      </div>
      <div className={`p-3 rounded-xl ${color}`}>{icon}</div>
    </div>
  </motion.div>
);

const PriorityUserCardComponent: React.FC<{
  user: PriorityUserCard;
  onClick: (userId: string) => void;
}> = ({ user, onClick }) => {
  const categoryColors = {
    CRITICAL: 'bg-red-50 border-red-200',
    HIGH: 'bg-orange-50 border-orange-200',
    MEDIUM: 'bg-yellow-50 border-yellow-200',
    LOW: 'bg-green-50 border-green-200',
  };

  const categoryBadge = {
    CRITICAL: 'bg-red-500 text-white',
    HIGH: 'bg-orange-500 text-white',
    MEDIUM: 'bg-yellow-500 text-white',
    LOW: 'bg-green-500 text-white',
  };

  return (
    <motion.div
      initial={{ opacity: 0, x: -20 }}
      animate={{ opacity: 1, x: 0 }}
      whileHover={{ scale: 1.02 }}
      onClick={() => onClick(user.userId)}
      className={`p-3 rounded-lg border cursor-pointer transition-all ${categoryColors[user.category]}`}
    >
      <div className="flex items-center gap-3">
        <div className="relative">
          <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden">
            {user.mainImage ? (
              <img
                src={user.mainImage}
                alt=""
                className="w-full h-full object-cover"
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-gray-400">
                <Users size={20} />
              </div>
            )}
          </div>
          <div
            className={`absolute -bottom-1 -left-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${categoryBadge[user.category]}`}
          >
            {user.priorityScore}
          </div>
        </div>

        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <p className="font-medium text-gray-800 truncate">
              {user.firstName} {user.lastName}
            </p>
            {user.gender === 'FEMALE' && (
              <span className="text-pink-500">â™€</span>
            )}
            {user.gender === 'MALE' && (
              <span className="text-blue-500">â™‚</span>
            )}
          </div>
          <div className="flex flex-wrap gap-1 mt-1">
            {user.tags.slice(0, 3).map((tag, idx) => (
              <span
                key={idx}
                className="text-[10px] bg-white/50 px-1.5 py-0.5 rounded"
              >
                {tag}
              </span>
            ))}
          </div>
        </div>
        <ChevronRight size={16} className="text-gray-400" />
      </div>
    </motion.div>
  );
};

const AlertItem: React.FC<{
  alert: AlertResult;
  onDismiss: (id: string) => void;
  onMarkRead: (id: string) => void;
}> = ({ alert, onDismiss, onMarkRead }) => {
  const severityColors = {
    CRITICAL: 'border-r-4 border-r-red-500 bg-red-50',
    HIGH: 'border-r-4 border-r-orange-500 bg-orange-50',
    MEDIUM: 'border-r-4 border-r-yellow-500 bg-yellow-50',
    LOW: 'border-r-4 border-r-green-500 bg-green-50',
    INFO: 'border-r-4 border-r-blue-500 bg-blue-50',
  };

  const severityIcons = {
    CRITICAL: <AlertTriangle size={16} className="text-red-500" />,
    HIGH: <AlertTriangle size={16} className="text-orange-500" />,
    MEDIUM: <Clock size={16} className="text-yellow-600" />,
    LOW: <Bell size={16} className="text-green-500" />,
    INFO: <Bell size={16} className="text-blue-500" />,
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, x: 100 }}
      className={`p-3 rounded-lg ${severityColors[alert.severity]} ${!alert.isRead ? 'font-medium' : 'opacity-80'}`}
    >
      <div className="flex items-start gap-2">
        <div className="mt-0.5">{severityIcons[alert.severity]}</div>
        <div className="flex-1 min-w-0">
          <p className="text-sm text-gray-800">{alert.title}</p>
          <p className="text-xs text-gray-600 mt-0.5 truncate">
            {alert.message}
          </p>
        </div>
        <div className="flex items-center gap-1">
          {!alert.isRead && (
            <button
              onClick={() => onMarkRead(alert.id)}
              className="p-1 hover:bg-white/50 rounded"
              title="×¡××Ÿ ×›× ×§×¨×"
            >
              <Users size={14} className="text-gray-400" />
            </button>
          )}
          <button
            onClick={() => onDismiss(alert.id)}
            className="p-1 hover:bg-white/50 rounded"
            title="×“×—×” ×”×ª×¨××”"
          >
            <XCircle size={14} className="text-gray-400" />
          </button>
        </div>
      </div>
    </motion.div>
  );
};

const ActivityItem: React.FC<{ activity: RecentActivity }> = ({ activity }) => {
  const typeConfig: Record<string, { icon: React.ReactNode; color: string }> = {
    new_user: {
      icon: <UserPlus size={14} />,
      color: 'text-green-500 bg-green-50',
    },
    new_match: { icon: <Heart size={14} />, color: 'text-pink-500 bg-pink-50' },
    suggestion_sent: {
      icon: <MessageSquare size={14} />,
      color: 'text-blue-500 bg-blue-50',
    },
    suggestion_accepted: {
      icon: <CheckCircle size={14} />,
      color: 'text-green-500 bg-green-50',
    },
    suggestion_declined: {
      icon: <XCircle size={14} />,
      color: 'text-red-500 bg-red-50',
    },
  };

  const config = typeConfig[activity.type] || typeConfig.new_user;

  return (
    <div className="flex items-center gap-3 py-2">
      <div className={`p-2 rounded-full ${config.color}`}>{config.icon}</div>
      <div className="flex-1 min-w-0">
        <p className="text-sm text-gray-700">{activity.title}</p>
        <p className="text-xs text-gray-500 truncate">{activity.description}</p>
      </div>
      <span className="text-xs text-gray-400">
        {formatTimeAgo(activity.timestamp)}
      </span>
    </div>
  );
};

function formatTimeAgo(timestamp: string): string {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return '×¢×›×©×™×•';
  if (diffMins < 60) return `×œ×¤× ×™ ${diffMins} ×“×§'`;
  if (diffHours < 24) return `×œ×¤× ×™ ${diffHours} ×©×¢'`;
  if (diffDays < 7) return `×œ×¤× ×™ ${diffDays} ×™××™×`;
  return date.toLocaleDateString('he-IL');
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export default function MatchmakerDashboard() {
  const [data, setData] = useState<DashboardData | null>(null);
  const [loading, setLoading] = useState(false); // ×©×•× ×” ×œ-false ×›×‘×¨×™×¨×ª ××—×“×œ
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'priority' | 'alerts'>('priority');

  // Fetch dashboard data
  const fetchData = useCallback(async (showRefresh = false) => {
    try {
      if (showRefresh) setRefreshing(true);
      else setLoading(true);

      const response = await fetch('/api/matchmaker/dashboard');

      if (!response.ok) {
        throw new Error('Failed to fetch dashboard data');
      }

      const dashboardData = await response.json();
      setData(dashboardData);
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, []);

  // Removed immediate useEffect call.
  // Now it only runs interval if data is present.
  useEffect(() => {
    if (!data) return; // ×¨×§ ×× ×™×© ×“××˜×”, × ×¤×¢×™×œ ×˜×™×™××¨ ×œ×¨×¢× ×•×Ÿ

    // Auto refresh every 2 minutes
    const interval = setInterval(() => fetchData(true), 120000);
    return () => clearInterval(interval);
  }, [fetchData, data]);

  // Handle alert dismiss
  const handleDismissAlert = async (alertId: string) => {
    try {
      await fetch('/api/matchmaker/alerts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'dismiss', alertId }),
      });

      // Update local state
      if (data) {
        setData({
          ...data,
          alerts: {
            ...data.alerts,
            alerts: data.alerts.alerts.filter((a) => a.id !== alertId),
            total: data.alerts.total - 1,
          },
        });
      }
    } catch (err) {
      console.error('Failed to dismiss alert:', err);
    }
  };

  // Handle mark as read
  const handleMarkRead = async (alertId: string) => {
    try {
      await fetch('/api/matchmaker/alerts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'mark_read', alertId }),
      });

      // Update local state
      if (data) {
        setData({
          ...data,
          alerts: {
            ...data.alerts,
            alerts: data.alerts.alerts.map((a) =>
              a.id === alertId ? { ...a, isRead: true } : a
            ),
            unread: Math.max(0, data.alerts.unread - 1),
          },
        });
      }
    } catch (err) {
      console.error('Failed to mark as read:', err);
    }
  };

  // Navigate to user
  const handleUserClick = (userId: string) => {
    window.location.href = `/matchmaker/candidates/${userId}`;
  };

  // --- ××¦×‘ 1: ×¢×“×™×™×Ÿ ×œ× × ×˜×¢×Ÿ ×“××˜×” ×•×œ× ×˜×•×¢×Ÿ ×›×¨×’×¢ (Initial State) ---
  if (!data && !loading && !error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[400px] p-8 text-center space-y-6">
        <div className="p-6 bg-indigo-50 rounded-full animate-pulse-slow">
          <BarChart className="w-16 h-16 text-indigo-600" />
        </div>
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-2">
            ×“×©×‘×•×¨×“ ×•× ×™×ª×•×— × ×ª×•× ×™×
          </h2>
          <p className="text-gray-500 max-w-md mx-auto">
            ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×˜×¢×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª, ×”×ª×¨××•×ª ×•××©×ª××©×™× ×‘×¢×“×™×¤×•×ª ×’×‘×•×”×”.
            ×¤×¢×•×œ×” ×–×• ××‘×¦×¢×ª × ×™×ª×•×— ××¢××™×§ ×•×œ×›×Ÿ ××™× ×” ××•×¤×¢×œ×ª ××•×˜×•××˜×™×ª.
          </p>
        </div>
        <button
          onClick={() => fetchData()}
          className="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all text-lg font-medium"
        >
          <PlayCircle size={24} />
          ×˜×¢×Ÿ × ×ª×•× ×™ ×“×©×‘×•×¨×“
        </button>
      </div>
    );
  }

  // --- ××¦×‘ 2: ×˜×•×¢×Ÿ (Loading State) ---
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="flex flex-col items-center gap-3">
          <RefreshCw className="w-8 h-8 text-primary animate-spin" />
          <p className="text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™× ×•×× ×ª×— ×”×ª×¨××•×ª...</p>
        </div>
      </div>
    );
  }

  // --- ××¦×‘ 3: ×©×’×™××” (Error State) ---
  if (error) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <AlertTriangle className="w-12 h-12 text-red-500 mx-auto mb-3" />
          <p className="text-red-600 font-medium">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×©×‘×•×¨×“</p>
          <p className="text-gray-500 text-sm mt-1">{error}</p>
          <button
            onClick={() => fetchData()}
            className="mt-4 px-4 py-2 bg-primary text-white rounded-lg"
          >
            × ×¡×” ×©×•×‘
          </button>
        </div>
      </div>
    );
  }

  if (!data) return null;

  // --- ××¦×‘ 4: ×”×¦×’×ª ×”×“×©×‘×•×¨×“ (Dashboard View) ---
  return (
    <div className="space-y-6 p-4 md:p-6" dir="rtl">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <Sparkles className="text-primary" />
            ×“×©×‘×•×¨×“ ×©×“×›×Ÿ
          </h1>
          <p className="text-sm text-gray-500 mt-1">
            ×¢×•×“×›×Ÿ {new Date(data.generatedAt).toLocaleTimeString('he-IL')}
          </p>
        </div>
        <button
          onClick={() => fetchData(true)}
          disabled={refreshing}
          className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
        >
          <RefreshCw size={16} className={refreshing ? 'animate-spin' : ''} />
          <span>×¨×¢× ×Ÿ × ×ª×•× ×™×</span>
        </button>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          title="××©×ª××©×™× ×¤×¢×™×œ×™×"
          value={data.stats.totalActiveUsers}
          subtitle={`${data.stats.maleCount}â™‚ / ${data.stats.femaleCount}â™€`}
          icon={<Users size={20} className="text-white" />}
          color="bg-blue-500"
        />
        <StatCard
          title="×—×“×©×™× ×”×©×‘×•×¢"
          value={data.stats.newUsersThisWeek}
          subtitle={`${data.stats.newUsersToday} ×”×™×•×`}
          icon={<UserPlus size={20} className="text-white" />}
          color="bg-green-500"
        />
        <StatCard
          title="×”×ª×××•×ª ×××ª×™× ×•×ª"
          value={data.stats.pendingMatches}
          icon={<Heart size={20} className="text-white" />}
          color="bg-pink-500"
        />
        <StatCard
          title="××—×•×– ×”×¦×œ×—×”"
          value={`${data.stats.acceptanceRate}%`}
          subtitle={`${data.stats.suggestionsThisWeek} ×”×¦×¢×•×ª ×”×©×‘×•×¢`}
          icon={<TrendingUp size={20} className="text-white" />}
          color="bg-purple-500"
        />
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-3 gap-3">
        {data.quickActions.newUsersToReview > 0 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            className="bg-green-50 border border-green-200 rounded-xl p-4 cursor-pointer hover:bg-green-100 transition-colors"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-500 rounded-lg">
                <UserPlus size={20} className="text-white" />
              </div>
              <div>
                <p className="text-2xl font-bold text-green-700">
                  {data.quickActions.newUsersToReview}
                </p>
                <p className="text-sm text-green-600">××©×ª××©×™× ×—×“×©×™× ×œ×‘×“×™×§×”</p>
              </div>
            </div>
          </motion.div>
        )}

        {data.quickActions.matchesToReview > 0 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.1 }}
            className="bg-pink-50 border border-pink-200 rounded-xl p-4 cursor-pointer hover:bg-pink-100 transition-colors"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-pink-500 rounded-lg">
                <Heart size={20} className="text-white" />
              </div>
              <div>
                <p className="text-2xl font-bold text-pink-700">
                  {data.quickActions.matchesToReview}
                </p>
                <p className="text-sm text-pink-600">×”×ª×××•×ª ×œ×‘×“×™×§×”</p>
              </div>
            </div>
          </motion.div>
        )}

        {data.quickActions.suggestionsToFollow > 0 && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2 }}
            className="bg-orange-50 border border-orange-200 rounded-xl p-4 cursor-pointer hover:bg-orange-100 transition-colors"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-orange-500 rounded-lg">
                <Clock size={20} className="text-white" />
              </div>
              <div>
                <p className="text-2xl font-bold text-orange-700">
                  {data.quickActions.suggestionsToFollow}
                </p>
                <p className="text-sm text-orange-600">×”×¦×¢×•×ª ×××ª×™× ×•×ª ×œ××¢×§×‘</p>
              </div>
            </div>
          </motion.div>
        )}
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Priority Users / Alerts - Left Column */}
        <div className="lg:col-span-2 space-y-4">
          {/* Tab Selector */}
          <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
            <button
              onClick={() => setActiveTab('priority')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors ${
                activeTab === 'priority'
                  ? 'bg-white text-gray-800 shadow-sm'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              <span className="flex items-center justify-center gap-2">
                <Users size={16} />
                ××©×ª××©×™× ×œ×˜×™×¤×•×œ (
                {data.criticalUsers.length + data.highPriorityUsers.length})
              </span>
            </button>
            <button
              onClick={() => setActiveTab('alerts')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors ${
                activeTab === 'alerts'
                  ? 'bg-white text-gray-800 shadow-sm'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              <span className="flex items-center justify-center gap-2">
                <Bell size={16} />
                ×”×ª×¨××•×ª
                {data.alerts.unread > 0 && (
                  <span className="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full">
                    {data.alerts.unread}
                  </span>
                )}
              </span>
            </button>
          </div>

          <AnimatePresence mode="wait">
            {activeTab === 'priority' ? (
              <motion.div
                key="priority"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className="space-y-4"
              >
                {/* Critical Users */}
                {data.criticalUsers.length > 0 && (
                  <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-bold text-red-600 mb-3 flex items-center gap-2">
                      <AlertTriangle size={18} />
                      ğŸ”´ ×“×—×•×£ ({data.criticalUsers.length})
                    </h3>
                    <div className="space-y-2">
                      {data.criticalUsers.slice(0, 5).map((user) => (
                        <PriorityUserCardComponent
                          key={user.userId}
                          user={user}
                          onClick={handleUserClick}
                        />
                      ))}
                    </div>
                    {data.criticalUsers.length > 5 && (
                      <button className="w-full mt-3 text-sm text-red-600 hover:text-red-700">
                        ×”×¦×’ ×¢×•×“ {data.criticalUsers.length - 5} â†’
                      </button>
                    )}
                  </div>
                )}

                {/* High Priority Users */}
                {data.highPriorityUsers.length > 0 && (
                  <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <h3 className="text-lg font-bold text-orange-600 mb-3 flex items-center gap-2">
                      <Clock size={18} />
                      ğŸŸ  ×¢×“×™×¤×•×ª ×’×‘×•×”×” ({data.highPriorityUsers.length})
                    </h3>
                    <div className="space-y-2">
                      {data.highPriorityUsers.slice(0, 5).map((user) => (
                        <PriorityUserCardComponent
                          key={user.userId}
                          user={user}
                          onClick={handleUserClick}
                        />
                      ))}
                    </div>
                    {data.highPriorityUsers.length > 5 && (
                      <button className="w-full mt-3 text-sm text-orange-600 hover:text-orange-700">
                        ×”×¦×’ ×¢×•×“ {data.highPriorityUsers.length - 5} â†’
                      </button>
                    )}
                  </div>
                )}

                {/* No Priority Users */}
                {data.criticalUsers.length === 0 &&
                  data.highPriorityUsers.length === 0 && (
                    <div className="bg-green-50 rounded-xl p-8 text-center">
                      <CheckCircle
                        size={48}
                        className="text-green-500 mx-auto mb-3"
                      />
                      <p className="text-green-700 font-medium">
                        ×›×œ ×”××©×ª××©×™× ××˜×•×¤×œ×™×! ğŸ‰
                      </p>
                      <p className="text-green-600 text-sm mt-1">
                        ××™×Ÿ ××©×ª××©×™× ×“×—×•×¤×™× ×›×¨×’×¢
                      </p>
                    </div>
                  )}
              </motion.div>
            ) : (
              <motion.div
                key="alerts"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className="bg-white rounded-xl p-4 shadow-sm border border-gray-100"
              >
                {/* Alerts Summary */}
                <div className="flex items-center gap-4 mb-4 pb-4 border-b">
                  <div className="flex items-center gap-2 text-sm">
                    <span className="w-3 h-3 bg-red-500 rounded-full" />
                    <span>{data.alerts.bySeverity.critical} ×§×¨×™×˜×™</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <span className="w-3 h-3 bg-orange-500 rounded-full" />
                    <span>{data.alerts.bySeverity.high} ×’×‘×•×”</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <span className="w-3 h-3 bg-yellow-500 rounded-full" />
                    <span>{data.alerts.bySeverity.medium} ×‘×™× ×•× ×™</span>
                  </div>
                </div>

                {/* Alerts List */}
                <div className="space-y-2 max-h-[400px] overflow-y-auto">
                  <AnimatePresence>
                    {data.alerts.alerts.slice(0, 10).map((alert) => (
                      <AlertItem
                        key={alert.id}
                        alert={alert}
                        onDismiss={handleDismissAlert}
                        onMarkRead={handleMarkRead}
                      />
                    ))}
                  </AnimatePresence>

                  {data.alerts.alerts.length === 0 && (
                    <div className="text-center py-8 text-gray-500">
                      <Bell size={32} className="mx-auto mb-2 opacity-50" />
                      <p>××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª</p>
                    </div>
                  )}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>

        {/* Right Column - Activity & Info */}
        <div className="space-y-4">
          {/* Last Scan Info */}
          {data.lastScan && (
            <div className="bg-gradient-to-br from-primary/10 to-primary/5 rounded-xl p-4 border border-primary/20">
              <h3 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                <Calendar size={16} />
                ×¡×¨×™×§×” ××—×¨×•× ×”
              </h3>
              <div className="space-y-1 text-sm">
                {data.lastScan.timestamp && (
                  <p className="text-gray-600">
                    {new Date(data.lastScan.timestamp).toLocaleString('he-IL')}
                  </p>
                )}
                <p className="text-gray-600">
                  × ××¦××• {data.lastScan.matchesFound} ×”×ª×××•×ª ×—×“×©×•×ª
                </p>
                {data.lastScan.duration && (
                  <p className="text-gray-500 text-xs">
                    ××©×š: {(data.lastScan.duration / 1000 / 60).toFixed(1)} ×“×§×•×ª
                  </p>
                )}
              </div>
            </div>
          )}

          {/* Recent Activity */}
          <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <h3 className="font-medium text-gray-700 mb-3 flex items-center gap-2">
              <Clock size={16} />
              ×¤×¢×™×œ×•×ª ××—×¨×•× ×”
            </h3>
            <div className="divide-y">
              {data.recentActivity.slice(0, 6).map((activity) => (
                <ActivityItem key={activity.id} activity={activity} />
              ))}

              {data.recentActivity.length === 0 && (
                <p className="text-gray-400 text-sm text-center py-4">
                  ××™×Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”
                </p>
              )}
            </div>
          </div>

          {/* Problems Summary */}
          <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <h3 className="font-medium text-gray-700 mb-3 flex items-center gap-2">
              <AlertTriangle size={16} />
              ×‘×¢×™×•×ª ×œ×˜×™×¤×•×œ
            </h3>
            <div className="space-y-2">
              {data.stats.usersWaitingLong > 0 && (
                <div className="flex items-center justify-between p-2 bg-orange-50 rounded-lg">
                  <span className="text-sm text-orange-700">
                    ×××ª×™× ×™× 10+ ×™××™×
                  </span>
                  <span className="font-bold text-orange-600">
                    {data.stats.usersWaitingLong}
                  </span>
                </div>
              )}
              {data.stats.usersWithNoMatches > 0 && (
                <div className="flex items-center justify-between p-2 bg-yellow-50 rounded-lg">
                  <span className="text-sm text-yellow-700">×œ×œ× ×”×ª×××•×ª</span>
                  <span className="font-bold text-yellow-600">
                    {data.stats.usersWithNoMatches}
                  </span>
                </div>
              )}
              {data.stats.incompleteProfiles > 0 && (
                <div className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <span className="text-sm text-gray-700">×¤×¨×•×¤×™×œ×™× ×—×œ×§×™×™×</span>
                  <span className="font-bold text-gray-600">
                    {data.stats.incompleteProfiles}
                  </span>
                </div>
              )}
              {data.stats.usersWaitingLong === 0 &&
                data.stats.usersWithNoMatches === 0 &&
                data.stats.incompleteProfiles === 0 && (
                  <p className="text-green-600 text-sm text-center py-2">
                    âœ… ××™×Ÿ ×‘×¢×™×•×ª ×›×¨×’×¢
                  </p>
                )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
--- End of Content for MatchmakerDashboard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\PotentialMatchCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/PotentialMatchCard.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { Card } from '@/components/ui/card';
import AllReasoningsDisplay from './AllReasoningsDisplay';

import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import type { CandidateToHide } from './HideCandidateDialog';

import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  AlertTriangle,
  Heart,
  HeartHandshake,
  MapPin,
  EyeOff,
  Bookmark,
  Eye,
  MoreHorizontal,
  Send,
  X,
  Brain,
  Calendar,
  Sparkles,
  Clock,
  UserCheck,
  ChevronDown,
  ChevronUp,
  ExternalLink,
  Undo,
  MessageCircle,
  Mail,
  Briefcase,
  Ruler,
  Languages,
  ThumbsDown,
  MessageSquareX,
  Search, // ×”×•×¡×¤×ª×™ ××ª ×”×™×™×‘×•× ×”×–×” ×œ×©×™××•×© ×‘×›×¤×ª×•×¨ ×”×¡×™× ×•×Ÿ
} from 'lucide-react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import type { PotentialMatch, ScoreBreakdown } from './types/potentialMatches';

import RejectionFeedbackModal, {
  useRejectionFeedback,
} from './RejectionFeedbackModal';

// =============================================================================
// TYPES
// =============================================================================

interface PotentialMatchCardProps {
  match: PotentialMatch;
  onCreateSuggestion: (matchId: string) => void;
  onDismiss: (matchId: string) => void;
  onReview: (matchId: string) => void;
  onRestore: (matchId: string) => void;
  onSave: (matchId: string) => void;
  onViewProfile: (userId: string) => void;
  onAnalyzeCandidate: (candidate: any) => void;
  onProfileFeedback: (candidate: any) => void;
  isSelected?: boolean;
  onToggleSelect?: (matchId: string) => void;
  showSelection?: boolean;
  className?: string;
  onHideCandidate: (candidate: CandidateToHide) => void;
  hiddenCandidateIds?: Set<string>;
  onFilterByUser: (fullName: string) => void; // ×”×•×¡×¤×ª×™ ××ª ×”×¤×•× ×§×¦×™×” ×”×–×•
}

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

const getScoreColor = (score: number): string => {
  if (score >= 85) return 'text-emerald-600';
  if (score >= 75) return 'text-blue-600';
  if (score >= 70) return 'text-amber-600';
  return 'text-gray-600';
};

const getScoreBgColor = (score: number): string => {
  if (score >= 85) return 'from-emerald-500 to-green-500';
  if (score >= 75) return 'from-blue-500 to-cyan-500';
  if (score >= 70) return 'from-amber-500 to-yellow-500';
  return 'from-gray-500 to-slate-500';
};

const getStatusBadge = (status: string) => {
  switch (status) {
    case 'PENDING':
      return {
        label: '×××ª×™×Ÿ',
        color: 'bg-yellow-100 text-yellow-700',
        icon: Clock,
      };
    case 'REVIEWED':
      return { label: '× ×‘×“×§', color: 'bg-blue-100 text-blue-700', icon: Eye };
    case 'SENT':
      return {
        label: '× ×©×œ×—×” ×”×¦×¢×”',
        color: 'bg-green-100 text-green-700',
        icon: Send,
      };
    case 'DISMISSED':
      return { label: '× ×“×—×”', color: 'bg-gray-100 text-gray-700', icon: X };
    case 'SHORTLISTED':
      return {
        label: '×©××•×¨ ×‘×¦×“',
        color: 'bg-purple-100 text-purple-700',
        icon: Bookmark,
      };
    default:
      return { label: status, color: 'bg-gray-100 text-gray-700', icon: Clock };
  }
};

const getReligiousLevelLabel = (level: string | null): string => {
  if (!level) return '×œ× ×¦×•×™×Ÿ';
  const labels: Record<string, string> = {
    dati_leumi_torani: '×“×ª×™ ×œ××•××™ ×ª×•×¨× ×™',
    dati_leumi_standard: '×“×ª×™ ×œ××•××™',
    dati_leumi_liberal: '×“×ª×™ ×œ××•××™ ×œ×™×‘×¨×œ×™',
    charedi_modern: '×—×¨×“×™ ××•×“×¨× ×™',
    masorti_strong: '××¡×•×¨×ª×™ ×—×–×§',
    masorti_light: '××¡×•×¨×ª×™',
    secular_traditional_connection: '×—×™×œ×•× ×™ ×¢× ×§×©×¨ ×œ××¡×•×¨×ª',
    secular: '×—×™×œ×•× ×™',
  };
  return labels[level] || level;
};

const formatLanguages = (
  native: string | null | undefined,
  additional: string[] | null | undefined
): string => {
  const langMap: Record<string, string> = {
    hebrew: '×¢×‘×¨×™×ª',
    english: '×× ×’×œ×™×ª',
    russian: '×¨×•×¡×™×ª',
    french: '×¦×¨×¤×ª×™×ª',
    spanish: '×¡×¤×¨×“×™×ª',
    amharic: '×××”×¨×™×ª',
    arabic: '×¢×¨×‘×™×ª',
    german: '×’×¨×× ×™×ª',
    italian: '××™×˜×œ×§×™×ª',
  };

  const langs = [native, ...(additional || [])].filter(Boolean) as string[];

  return langs
    .map((lang) => langMap[lang.toLowerCase()] || lang)
    .slice(0, 3)
    .join(', ');
};

const getMaritalStatusLabel = (status: string | null | undefined): string => {
  if (!status) return '';
  const map: Record<string, string> = {
    single: '×¨×•×•×§/×”',
    divorced: '×’×¨×•×©/×”',
    widowed: '××œ××Ÿ/×”',
    divorced_with_children: '×’×¨×•×©/×” +',
    widowed_with_children: '××œ××Ÿ/×” +',
  };
  return map[status.toLowerCase()] || status;
};

// =============================================================================
// ALL SCORES DISPLAY - ×”×¦×’×ª ×¦×™×•× ×™× ××›×œ ×”×©×™×˜×•×ª
// =============================================================================

const AllScoresDisplay: React.FC<{
  match: PotentialMatch;
}> = ({ match }) => {
  const scores = [
    {
      key: 'hybrid',
      label: '×”×™×‘×¨×™×“×™',
      description: '×¡×¨×™×§×” ×”×™×‘×¨×™×“×™×ª (4 ×©×œ×‘×™×)',
      score: match.hybridScore,
      icon: 'ğŸ”¥',
      bgColor: 'bg-emerald-50',
      textColor: 'text-emerald-700',
      borderColor: 'border-emerald-200',
    },
    {
      key: 'algorithmic',
      label: 'AI',
      description: '× ×™×ª×•×— AI ××¢××™×§',
      score: match.algorithmicScore,
      icon: 'ğŸ§ ',
      bgColor: 'bg-purple-50',
      textColor: 'text-purple-700',
      borderColor: 'border-purple-200',
    },
    {
      key: 'vector',
      label: '××”×™×¨',
      description: '×¡×¨×™×§×” ×•×§×˜×•×¨×™×ª ××”×™×¨×”',
      score: match.vectorScore,
      icon: 'âš¡',
      bgColor: 'bg-blue-50',
      textColor: 'text-blue-700',
      borderColor: 'border-blue-200',
    },
    {
      key: 'metricsV2',
      label: 'V2',
      description: '××˜×¨×™×§×•×ª ×’×¨×¡×” 2',
      score: match.metricsV2Score,
      icon: 'ğŸ¯',
      bgColor: 'bg-indigo-50',
      textColor: 'text-indigo-700',
      borderColor: 'border-indigo-200',
    },
  ].filter((s) => s.score !== null && s.score !== undefined);

  if (scores.length === 0) {
    return (
      <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/90 backdrop-blur-sm shadow-sm">
        <Sparkles className={cn('w-4 h-4', getScoreColor(match.aiScore))} />
        <span className={cn('text-xl font-bold', getScoreColor(match.aiScore))}>
          {Math.round(match.aiScore)}
        </span>
      </div>
    );
  }

  return (
    <div className="flex flex-wrap gap-1.5">
      {scores.map(
        ({
          key,
          label,
          description,
          score,
          icon,
          bgColor,
          textColor,
          borderColor,
        }) => {
          const isCurrentMethod =
            key === match.lastScanMethod ||
            (key === 'metricsV2' && match.lastScanMethod === 'metrics_v2');

          return (
            <TooltipProvider key={key}>
              <Tooltip>
                <TooltipTrigger asChild>
                  <div
                    className={cn(
                      'flex items-center gap-1 px-2 py-1 rounded-lg border text-xs cursor-help transition-all hover:scale-105',
                      bgColor,
                      borderColor,
                      isCurrentMethod && 'ring-2 ring-offset-1 ring-emerald-400'
                    )}
                  >
                    <span>{icon}</span>
                    <span className={cn('font-bold', textColor)}>
                      {Math.round(score!)}
                    </span>
                  </div>
                </TooltipTrigger>
                <TooltipContent side="top" className="text-center">
                  <p className="font-bold">{label}</p>
                  <p className="text-xs text-gray-400">{description}</p>
                  <p className="text-sm mt-1">{Math.round(score!)} × ×§×•×“×•×ª</p>
                  {isCurrentMethod && (
                    <p className="text-emerald-400 text-xs mt-1 font-medium">
                      âœ“ ×©×™×˜×ª ×”×¡×¨×™×§×” ×”××—×¨×•× ×”
                    </p>
                  )}
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          );
        }
      )}
    </div>
  );
};
// =============================================================================
// SUB-COMPONENTS
// =============================================================================

const CandidatePreview: React.FC<{
  candidate: any;
  gender: 'male' | 'female';
  activeSuggestion: any;
  onViewProfile: () => void;
  onAnalyze: () => void;
  onFeedback: () => void;
  onHide: (candidate: CandidateToHide) => void;
  onFilterByName: () => void; // ×”×•×¡×¤×ª×™ ××ª ×”×¤×•× ×§×¦×™×” ×”×–×•
}> = ({
  candidate,
  gender,
  activeSuggestion,
  onViewProfile,
  onAnalyze,
  onFeedback,
  onHide,
  onFilterByName,
}) => {
  const genderIcon = gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
  const borderColor = gender === 'male' ? 'border-blue-200' : 'border-pink-200';
  const bgGradient =
    gender === 'male' ? 'from-blue-50 to-cyan-50' : 'from-pink-50 to-rose-50';

  const languagesStr = formatLanguages(
    candidate.nativeLanguage,
    candidate.additionalLanguages
  );

  const handleWhatsApp = (e: React.MouseEvent) => {
    e.stopPropagation();

    let cleanPhone = candidate.phone?.replace(/\D/g, '') || '';
    if (cleanPhone.startsWith('0')) {
      cleanPhone = '972' + cleanPhone.substring(1);
    }

    if (cleanPhone) {
      const message = `×”×™×™ ${candidate.firstName} ×–×” ××™×ª×Ÿ ×× ×©××”×˜×§. ×× ×™ ×××•×“ ×©××— ×©× ×¨×©××ª ×œ××¢×¨×›×ª ×©×œ× ×• ×•×× ×™ ××§×•×•×” ×××•×“ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª ×”×–×•×’×™×•×ª ×©×ª××™×“ ×—×œ××ª ×¢×œ×™×”`;
      const encodedMessage = encodeURIComponent(message);
      window.open(
        `https://wa.me/${cleanPhone}?text=${encodedMessage}`,
        '_blank'
      );
    }
  };

  const handleEmail = (e: React.MouseEvent) => {
    e.stopPropagation();

    const subject = `×”×™×™ ${candidate.firstName} ×× ×©××”×˜×§ ğŸ’œ`;
    const body = `×”×™×™ ${candidate.firstName},
×–×” ××™×ª×Ÿ ×× ×©××”×˜×§.

×× ×™ ×××•×“ ×©××— ×©× ×¨×©××ª ×œ××¢×¨×›×ª ×©×œ× ×• ×•×× ×™ ××§×•×•×” ×××•×“ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª ×”×–×•×’×™×•×ª ×©×ª××™×“ ×—×œ××ª ×¢×œ×™×”.

××™×ª×Ÿ
× ×©××”×˜×§`;

    const encodedSubject = encodeURIComponent(subject);
    const encodedBody = encodeURIComponent(body);

    window.open(
      `mailto:${candidate.email || ''}?subject=${encodedSubject}&body=${encodedBody}`,
      '_blank'
    );
  };

  return (
    <div
      className={cn(
        'relative flex-1 min-w-0 overflow-hidden p-3 rounded-xl border-2 transition-all duration-300 hover:shadow-md flex flex-col',
        borderColor,
        `bg-gradient-to-br ${bgGradient}`
      )}
      onClick={onViewProfile}
    >
      <div className="flex-1 cursor-pointer min-w-0 w-full">
        {/* ×ª××•× ×” ×•×¡×˜×˜×•×¡ */}
        <div className="relative w-16 h-16 mx-auto mb-2 rounded-full overflow-hidden border-2 border-white shadow-md">
          {candidate.mainImage ? (
            <Image
              src={getRelativeCloudinaryPath(candidate.mainImage)}
              alt={`${candidate.firstName} ${candidate.lastName}`}
              fill
              className="object-cover"
            />
          ) : (
            <div className="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-xl">
              {genderIcon}
            </div>
          )}

          {candidate.isVerified && (
            <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center border-2 border-white">
              <UserCheck className="w-3 h-3 text-white" />
            </div>
          )}
        </div>

        {/* ×©× */}
        <h4
          className="text-center font-bold text-gray-800 text-sm mb-1 truncate px-1"
          title={`${candidate.firstName} ${candidate.lastName}`}
        >
          {candidate.firstName} {candidate.lastName}
        </h4>

        {/* ××–×•×¨ ×”××™×“×¢ */}
        <div className="flex flex-col gap-1.5 mb-2 w-full overflow-hidden">
          {/* ×©×•×¨×” 1: ×’×™×œ | ×¡×˜×˜×•×¡ | ×’×•×‘×” */}
          <div className="flex items-center justify-center gap-2 text-xs text-gray-700 flex-wrap">
            <span className="font-medium">{candidate.age}</span>

            {candidate.maritalStatus && (
              <>
                <span className="text-gray-300">|</span>
                <span
                  className="truncate max-w-[80px]"
                  title={getMaritalStatusLabel(candidate.maritalStatus)}
                >
                  {getMaritalStatusLabel(candidate.maritalStatus)}
                </span>
              </>
            )}

            {candidate.height && (
              <>
                <span className="text-gray-300">|</span>
                <span
                  className="flex items-center gap-0.5 shrink-0"
                  title="×’×•×‘×”"
                >
                  {candidate.height} <Ruler className="w-3 h-3 text-gray-400" />
                </span>
              </>
            )}
          </div>

          {/* ×©×•×¨×” 2: ×¢×™×¨ */}
          {candidate.city && (
            <div className="flex items-center justify-center gap-1 text-xs text-gray-600 w-full min-w-0 px-2">
              <MapPin className="w-3 h-3 text-gray-400 shrink-0" />
              <span className="truncate" title={candidate.city}>
                {candidate.city}
              </span>
            </div>
          )}

          {/* ×©×•×¨×” 3: ×¢×™×¡×•×§ */}
          {candidate.occupation && (
            <div className="flex items-center justify-center gap-1 text-xs text-gray-600 w-full min-w-0 px-2">
              <Briefcase className="w-3 h-3 text-gray-400 shrink-0" />
              <span className="truncate" title={candidate.occupation}>
                {candidate.occupation}
              </span>
            </div>
          )}

          {/* ×©×•×¨×” 4: ×©×¤×•×ª */}
          {languagesStr && (
            <div className="flex items-center justify-center gap-1 text-[10px] text-gray-500 w-full min-w-0 px-2">
              <Languages className="w-3 h-3 text-gray-400 shrink-0" />
              <span className="truncate" title={languagesStr}>
                {languagesStr}
              </span>
            </div>
          )}
        </div>

        {/* ×¨××” ×“×ª×™×ª */}
        <div className="flex justify-center w-full px-2">
          <div
            className="text-center text-[10px] text-purple-600 font-medium bg-purple-50 rounded-full py-0.5 px-2 max-w-full truncate"
            title={getReligiousLevelLabel(candidate.religiousLevel)}
          >
            {getReligiousLevelLabel(candidate.religiousLevel)}
          </div>
        </div>
      </div>

      {/* Actions */}
      <div className="mt-2 pt-2 border-t border-gray-200/50 flex items-center justify-center gap-2">
        {/* ×›×¤×ª×•×¨ ×¡×™× ×•×Ÿ ×œ×¤×™ ×©× (×—×“×©) */}
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="h-7 w-7 rounded-full bg-white/60 hover:bg-indigo-100 hover:text-indigo-600 shadow-sm border border-transparent hover:border-indigo-200 transition-all"
                onClick={(e) => {
                  e.stopPropagation();
                  onFilterByName();
                }}
              >
                <Search className="w-3.5 h-3.5" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>
              <p>×¡× ×Ÿ ×œ×¤×™ ×©× ××•×¢××“</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>

        {candidate.phone && (
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-7 w-7 rounded-full bg-white/60 hover:bg-green-100 hover:text-green-600 shadow-sm border border-transparent hover:border-green-200 transition-all"
                  onClick={handleWhatsApp}
                >
                  <MessageCircle className="w-3.5 h-3.5" />
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>×©×œ×— ×•×•××˜×¡××¤</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        )}

        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="h-7 w-7 rounded-full bg-white/60 hover:bg-purple-100 hover:text-purple-600 shadow-sm border border-transparent hover:border-purple-200 transition-all"
                onClick={(e) => {
                  e.stopPropagation();
                  onAnalyze();
                }}
              >
                <Sparkles className="w-3.5 h-3.5" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>
              <p>× ×™×ª×•×— ×¤×¨×•×¤×™×œ AI</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>

        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="h-7 w-7 rounded-full bg-white/60 hover:bg-blue-100 hover:text-blue-600 shadow-sm border border-transparent hover:border-blue-200 transition-all"
                onClick={handleEmail}
              >
                <Mail className="w-3.5 h-3.5" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>
              <p>×©×œ×— ××™×™×œ</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </div>

      <TooltipProvider>
        <Tooltip>
          <TooltipTrigger asChild>
            <Button
              variant="ghost"
              size="icon"
              className="h-7 w-7 rounded-full bg-white/60 hover:bg-amber-100 hover:text-amber-600 shadow-sm border border-transparent hover:border-amber-200 transition-all absolute top-2 right-2"
              onClick={(e) => {
                e.stopPropagation();
                onHide({
                  id: candidate.id,
                  firstName: candidate.firstName,
                  lastName: candidate.lastName,
                  mainImage: candidate.mainImage,
                  gender: gender === 'male' ? 'MALE' : 'FEMALE',
                });
              }}
            >
              <EyeOff className="w-3.5 h-3.5" />
            </Button>
          </TooltipTrigger>
          <TooltipContent>
            <p>×”×¡×ª×¨ ×–×× ×™×ª</p>
          </TooltipContent>
        </Tooltip>
      </TooltipProvider>

      {activeSuggestion && (
        <div className="mt-2 text-center">
          <Badge
            variant="outline"
            className="text-[10px] bg-amber-50 text-amber-700 border-amber-200 px-1 py-0 h-5"
          >
            <AlertTriangle className="w-2.5 h-2.5 mr-1" />
            ×‘×”×¦×¢×” ×¤×¢×™×œ×”
          </Badge>
        </div>
      )}
    </div>
  );
};

// Score Breakdown Component
const ScoreBreakdownDisplay: React.FC<{
  breakdown: ScoreBreakdown;
}> = ({ breakdown }) => {
  // PotentialMatchCard.tsx - ScoreBreakdownDisplay
  const categories = [
    { key: 'religious', label: '×”×ª×××” ×“×ª×™×ª', max: 25, color: 'bg-purple-500' },
    {
      key: 'ageCompatibility',
      label: '×”×ª×××ª ×’×™×œ',
      max: 10,
      color: 'bg-blue-500',
    },
    {
      key: 'careerFamily',
      label: '×§×¨×™×™×¨×”-××©×¤×—×”',
      max: 15,
      color: 'bg-cyan-500',
    },
    { key: 'lifestyle', label: '×¡×’× ×•×Ÿ ×—×™×™×', max: 10, color: 'bg-green-500' },
    {
      key: 'socioEconomic',
      label: '×¡×•×¦×™×•-××§×•× ×•××™',
      max: 10,
      color: 'bg-orange-500',
    }, // ğŸ†•
    { key: 'education', label: '×”×©×›×œ×”', max: 10, color: 'bg-pink-500' }, // ğŸ†•
    { key: 'background', label: '×¨×§×¢ ×ª×¨×‘×•×ª×™', max: 10, color: 'bg-amber-500' }, // ğŸ†•
    { key: 'values', label: '×¢×¨×›×™×', max: 10, color: 'bg-indigo-500' },
  ];

  return (
    <div className="space-y-2">
      {categories.map((cat) => {
        const value = breakdown[cat.key as keyof ScoreBreakdown] || 0;
        const percentage = (value / cat.max) * 100;

        return (
          <div key={cat.key} className="flex items-center gap-2">
            <span className="text-xs text-gray-600 w-24 truncate">
              {cat.label}
            </span>
            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${percentage}%` }}
                transition={{ duration: 0.5, delay: 0.1 }}
                className={cn('h-full rounded-full', cat.color)}
              />
            </div>
            <span className="text-xs text-gray-500 w-12 text-left">
              {value}/{cat.max}
            </span>
          </div>
        );
      })}
    </div>
  );
};

// ×§×•××¤×•× × ×˜×ª ×¢×–×¨ ×œ×¤×•×¨××˜ ×”× ×™××•×§
const ReasoningContent: React.FC<{ reasoning: string | null | undefined }> = ({
  reasoning,
}) => {
  if (!reasoning) return null;

  const paragraphs = reasoning.split(/\n\n+/).filter((p) => p.trim());

  const formatParagraph = (text: string, index: number) => {
    const isHeader = /^[-â€¢]?\s*[\u0590-\u05FF\w\s]+:$/.test(text.trim());

    const isList =
      text.includes('\n- ') || text.includes('\nâ€¢ ') || text.includes('\n* ');

    if (isHeader) {
      return (
        <h4
          key={index}
          className="font-semibold text-purple-800 text-sm mt-3 first:mt-0"
        >
          {text.replace(/^[*\-â€¢]\s*/, '')}
        </h4>
      );
    }

    if (isList) {
      const lines = text.split('\n').filter((l) => l.trim());
      return (
        <ul key={index} className="space-y-1.5 my-2">
          {lines.map((line, i) => {
            const cleanLine = line.replace(/^[*\-â€¢]\s*/, '').trim();
            if (!cleanLine) return null;
            return (
              <li
                key={i}
                className="flex items-start gap-2 text-sm text-gray-700"
              >
                <span className="text-purple-400 mt-1">â€¢</span>
                <span className="leading-relaxed">{cleanLine}</span>
              </li>
            );
          })}
        </ul>
      );
    }

    return (
      <p
        key={index}
        className="text-sm text-gray-700 leading-relaxed my-2 first:mt-0"
      >
        {text.trim()}
      </p>
    );
  };

  return (
    <div className="space-y-1">
      {paragraphs.map((para, index) => formatParagraph(para, index))}
    </div>
  );
};

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const PotentialMatchCard: React.FC<PotentialMatchCardProps> = ({
  match,
  onCreateSuggestion,
  onDismiss,
  onReview,
  onRestore,
  onViewProfile,
  onAnalyzeCandidate,
  onProfileFeedback,
  onSave,
  isSelected = false,
  onToggleSelect,
  showSelection = false,
  className,
  onHideCandidate,
  onFilterByUser, // Destructuring
}) => {
  const [showDetails, setShowDetails] = useState(false);
  const [showReasoningDialog, setShowReasoningDialog] = useState(false);
  const [showAllReasonings, setShowAllReasonings] = useState(false);

  const rejectionFeedback = useRejectionFeedback();

  const statusBadge = getStatusBadge(match.status);
  const StatusIcon = statusBadge.icon;

  const isDismissed = match.status === 'DISMISSED';
  const isSent = match.status === 'SENT';

  const handleDismissWithFeedback = () => {
    rejectionFeedback.open({
      partyA: {
        id: match.male.id,
        profileId: match.male.profileId,
        firstName: match.male.firstName,
        lastName: match.male.lastName,
        gender: 'MALE',
      },
      partyB: {
        id: match.female.id,
        profileId: match.female.profileId,
        firstName: match.female.firstName,
        lastName: match.female.lastName,
        gender: 'FEMALE',
      },
      defaultRejectingParty: 'A',
      potentialMatchId: match.id,
    });
  };

  const handleFeedbackSubmit = async (data: any) => {
    try {
      await rejectionFeedback.submit(data);
      onDismiss(match.id);
    } catch (error) {
      console.error('Failed to submit feedback', error);
    }
  };

  // ×¤×¢×•×œ×” ×œ×“×—×™×™×” ××”×™×¨×”
  const handleQuickDismiss = (e: React.MouseEvent) => {
    e.stopPropagation();
    onDismiss(match.id);
  };

  return (
    <>
      <motion.div
        layout
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -20 }}
        className={className}
      >
        <Card
          className={cn(
            'group relative overflow-hidden transition-all duration-300',
            'hover:shadow-xl border-0',
            isDismissed && 'opacity-60',
            isSelected && 'ring-2 ring-blue-500',
            match.hasActiveWarning && !isDismissed && 'ring-2 ring-amber-400'
          )}
        >
          {/* Gradient Background */}
          <div
            className={cn(
              'absolute inset-0 opacity-30',
              `bg-gradient-to-br ${getScoreBgColor(match.aiScore)}`
            )}
          />

          {/* Content */}
          <div className="relative p-4">
            {/* Header */}
            <div className="flex items-center justify-between mb-4">
              {/* Selection Checkbox */}
              {showSelection && onToggleSelect && (
                <div className="flex items-center gap-2">
                  <Checkbox
                    checked={isSelected}
                    onCheckedChange={() => onToggleSelect(match.id)}
                    className="border-2"
                  />
                </div>
              )}

              {/* Score Badges - All Methods */}
              <AllScoresDisplay match={match} />

              {/* Status Badge */}
              <Badge className={cn('gap-1', statusBadge.color)}>
                <StatusIcon className="w-3 h-3" />
                {statusBadge.label}
              </Badge>

              {/* Actions Menu */}
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="icon" className="h-8 w-8">
                    <MoreHorizontal className="w-4 h-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  {!isSent && !isDismissed && (
                    <>
                      <DropdownMenuItem
                        onClick={() => onCreateSuggestion(match.id)}
                      >
                        <HeartHandshake className="w-4 h-4 ml-2 text-green-600" />
                        ×¦×•×¨ ×”×¦×¢×”
                      </DropdownMenuItem>

                      <DropdownMenuItem onClick={() => onReview(match.id)}>
                        <Eye className="w-4 h-4 ml-2 text-blue-600" />
                        ×¡××Ÿ ×›× ×‘×“×§
                      </DropdownMenuItem>
                      <DropdownMenuSeparator />
                      <DropdownMenuItem
                        onClick={handleQuickDismiss}
                        className="text-orange-600"
                      >
                        <ThumbsDown className="w-4 h-4 ml-2" />
                        ×“×—×™×™×” ××”×™×¨×”
                      </DropdownMenuItem>
                      <DropdownMenuItem
                        onClick={handleDismissWithFeedback}
                        className="text-red-600"
                      >
                        <MessageSquareX className="w-4 h-4 ml-2" />
                        ×“×—×™×™×” ×¢× ×¤×™×¨×•×˜
                      </DropdownMenuItem>
                    </>
                  )}
                  {isDismissed && (
                    <DropdownMenuItem onClick={() => onRestore(match.id)}>
                      <Undo className="w-4 h-4 ml-2 text-blue-600" />
                      ×©×—×–×¨ ×”×ª×××”
                    </DropdownMenuItem>
                  )}
                </DropdownMenuContent>
              </DropdownMenu>
            </div>

            {/* Candidates Preview Row */}
            <div className="flex gap-3 mb-4">
              <CandidatePreview
                candidate={match.male}
                gender="male"
                activeSuggestion={match.maleActiveSuggestion}
                onViewProfile={() => onViewProfile(match.male.id)}
                onAnalyze={() => onAnalyzeCandidate(match.male)}
                onFeedback={() => onProfileFeedback(match.male)}
                onHide={onHideCandidate}
                onFilterByName={() =>
                  onFilterByUser(
                    `${match.male.firstName} ${match.male.lastName}`
                  )
                }
              />

              {/* Heart Connector */}
              <div className="flex flex-col justify-center items-center gap-1 z-10">
                <div
                  className={cn(
                    'w-8 h-8 rounded-full flex items-center justify-center',
                    'bg-gradient-to-br from-pink-500 to-red-500 shadow-lg'
                  )}
                >
                  <Heart className="w-4 h-4 text-white fill-white" />
                </div>
              </div>

              <CandidatePreview
                candidate={match.female}
                gender="female"
                activeSuggestion={match.femaleActiveSuggestion}
                onViewProfile={() => onViewProfile(match.female.id)}
                onAnalyze={() => onAnalyzeCandidate(match.female)}
                onFeedback={() => onProfileFeedback(match.female)}
                onHide={onHideCandidate}
                onFilterByName={() =>
                  onFilterByUser(
                    `${match.female.firstName} ${match.female.lastName}`
                  )
                }
              />
            </div>

            {/* Reasoning Preview */}
            {match.shortReasoning && (
              <div
                className="p-3 rounded-lg bg-gradient-to-br from-purple-50/80 to-indigo-50/80 backdrop-blur-sm cursor-pointer hover:from-purple-100/90 hover:to-indigo-100/90 transition-all duration-200 border border-purple-100 shadow-sm"
                onClick={() => setShowAllReasonings(true)} // ğŸ†• ×©×™× ×•×™ ×›××Ÿ
              >
                <div className="flex items-start gap-2.5">
                  <div className="p-1.5 rounded-lg bg-purple-100">
                    <Brain className="w-4 h-4 text-purple-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between mb-1">
                      <p className="text-xs font-medium text-purple-700">
                        × ×™××•×§ AI ×œ×”×ª×××”
                      </p>
                      {/* ğŸ†• ×”×¦×’×ª ×›××” ×©×™×˜×•×ª ×–××™× ×•×ª */}
                      <Badge
                        variant="outline"
                        className="text-[10px] bg-white/50"
                      >
                        {
                          [
                            match.hybridReasoning,
                            match.algorithmicReasoning,
                            match.vectorReasoning,
                            match.metricsV2Reasoning,
                          ].filter(Boolean).length
                        }{' '}
                        ×©×™×˜×•×ª
                      </Badge>
                    </div>
                    <p className="text-sm text-gray-700 line-clamp-3 leading-relaxed">
                      {match.shortReasoning}
                    </p>
                    <p className="text-xs text-purple-500 mt-1.5 flex items-center gap-1">
                      <span>×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×›×œ ×”× ×™××•×§×™×</span>
                      <ChevronDown className="w-3 h-3" />
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* ğŸ†• All Reasonings Dialog */}
            <AllReasoningsDisplay
              match={match}
              isOpen={showAllReasonings}
              onClose={() => setShowAllReasonings(false)}
            />

            {/* Footer: Date & Details Toggle */}
            <div className="flex items-center justify-between mt-3 pt-2">
              <span className="text-[10px] text-gray-400 flex items-center gap-1">
                <Calendar className="w-3 h-3" />
                {formatDistanceToNow(new Date(match.scannedAt), {
                  addSuffix: true,
                  locale: he,
                })}
              </span>

              <Button
                variant="ghost"
                size="sm"
                className="h-6 text-xs text-gray-500 hover:text-gray-800"
                onClick={() => setShowDetails(!showDetails)}
              >
                {showDetails ? (
                  <>
                    ×”×¡×ª×¨ ×¤×¨×˜×™× <ChevronUp className="w-3 h-3 ml-1" />
                  </>
                ) : (
                  <>
                    ×”×¦×’ × ×™×§×•×“ ××œ× <ChevronDown className="w-3 h-3 ml-1" />
                  </>
                )}
              </Button>
            </div>

            {/* Score Breakdown */}
            {showDetails && match.scoreBreakdown && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="mt-3 p-3 rounded-lg bg-white/80 backdrop-blur-sm border border-gray-100"
              >
                <ScoreBreakdownDisplay breakdown={match.scoreBreakdown} />
              </motion.div>
            )}

            {/* Main Action Buttons (Bottom) */}
            {!isDismissed && !isSent && (
              <div className="flex gap-2 mt-4 pt-2 border-t border-gray-100">
                <Button
                  className="flex-1 h-9 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white shadow-sm text-sm"
                  onClick={() => onCreateSuggestion(match.id)}
                >
                  <HeartHandshake className="w-4 h-4 ml-2" />
                  ×¦×•×¨ ×”×¦×¢×”
                </Button>
                {match.status !== 'SHORTLISTED' && (
                  <Button
                    variant="outline"
                    className="h-9 px-3 text-purple-600 border-purple-200 hover:bg-purple-50"
                    onClick={() => onSave(match.id)}
                    title="×©××•×¨ ×‘×¦×“"
                  >
                    <Bookmark className="w-4 h-4" />
                  </Button>
                )}

                {/* Quick Reject Button */}
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="outline"
                        className="h-9 w-9 px-0 text-red-500 border-red-200 hover:bg-red-50 hover:text-red-600 hover:border-red-300"
                        onClick={handleQuickDismiss}
                      >
                        <ThumbsDown className="w-4 h-4" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>×“×—×™×™×” ××”×™×¨×” (×—×•×¡×¨ ×”×ª×××”)</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>

                {/* Detailed Reject Button */}
                <Button
                  variant="outline"
                  className="flex-1 h-9 text-sm"
                  onClick={handleDismissWithFeedback}
                >
                  <MessageSquareX className="w-4 h-4 ml-2" />
                  ×“×—×” + ×¤×™×¨×•×˜
                </Button>
              </div>
            )}

            {/* Link to Suggestion if sent */}
            {isSent && match.suggestionId && (
              <div className="mt-4 p-2 rounded-lg bg-green-50 border border-green-200 text-center">
                <Button
                  variant="link"
                  size="sm"
                  className="text-green-700 p-0 h-auto font-medium"
                  onClick={() =>
                    (window.location.href = `/matchmaker/suggestions?id=${match.suggestionId}`)
                  }
                >
                  ×¢×‘×•×¨ ×œ×”×¦×¢×” <ExternalLink className="w-3 h-3 mr-1" />
                </Button>
              </div>
            )}
          </div>
        </Card>
      </motion.div>

      {/* Reasoning Dialog */}
      <Dialog open={showReasoningDialog} onOpenChange={setShowReasoningDialog}>
        <DialogContent className="max-w-2xl max-h-[85vh]" dir="rtl">
          <DialogHeader className="pb-4 border-b">
            <DialogTitle className="flex items-center gap-2 text-lg">
              <div className="p-2 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-500">
                <Brain className="w-5 h-5 text-white" />
              </div>
              × ×™××•×§ AI ×œ×”×ª×××”
            </DialogTitle>
            <div className="flex items-center gap-2 mt-2">
              <span className="text-sm text-gray-500">×¦×™×•×Ÿ ×”×ª×××”:</span>
              <span
                className={cn(
                  'text-lg font-bold',
                  getScoreColor(match.aiScore)
                )}
              >
                {Math.round(match.aiScore)}
              </span>
            </div>
          </DialogHeader>

          <div className="space-y-5 max-h-[55vh] overflow-y-auto py-4">
            <div className="bg-gradient-to-br from-purple-50 to-indigo-50 p-5 rounded-xl border border-purple-100">
              <ReasoningContent
                reasoning={match.detailedReasoning || match.shortReasoning}
              />
            </div>

            {match.scoreBreakdown && (
              <div className="space-y-3">
                <h4 className="font-medium text-gray-700 flex items-center gap-2">
                  <Sparkles className="w-4 h-4 text-purple-500" />
                  ×¤×™×¨×•×˜ ×”× ×™×§×•×“
                </h4>
                <div className="bg-white p-4 rounded-xl border border-gray-100">
                  <ScoreBreakdownDisplay breakdown={match.scoreBreakdown} />
                </div>
              </div>
            )}
          </div>

          <div className="pt-4 border-t flex justify-between items-center">
            <span className="text-xs text-gray-400">
              × ×¡×¨×§{' '}
              {formatDistanceToNow(new Date(match.scannedAt), {
                addSuffix: true,
                locale: he,
              })}
            </span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowReasoningDialog(false)}
            >
              ×¡×’×•×¨
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Rejection Feedback Modal Integration */}
      {rejectionFeedback.context && (
        <RejectionFeedbackModal
          isOpen={rejectionFeedback.isOpen}
          onClose={rejectionFeedback.close}
          onSubmit={handleFeedbackSubmit}
          partyA={rejectionFeedback.context.partyA}
          partyB={rejectionFeedback.context.partyB}
          defaultRejectingParty={
            rejectionFeedback.context.defaultRejectingParty
          }
          potentialMatchId={rejectionFeedback.context.potentialMatchId}
        />
      )}
    </>
  );
};

export default PotentialMatchCard;
--- End of Content for PotentialMatchCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\PotentialMatchesDashboard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/PotentialMatchesDashboard.tsx

'use client';
import React, {
  useMemo,
  useState,
  useCallback,
  useEffect,
  useRef,
} from 'react';

import BatchScanButtons from './BatchScanButtons';

import { motion, AnimatePresence } from 'framer-motion';
import PotentialMatchesFilters from './PotentialMatchesFilters';

import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useHiddenCandidates } from './hooks/useHiddenCandidates';
import HiddenCandidatesDrawer from './HiddenCandidatesDrawer';
import MatchmakerEditProfile from '../MatchmakerEditProfile';
import HideCandidateDialog, { CandidateToHide } from './HideCandidateDialog';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Textarea } from '@/components/ui/textarea';
import {
  HeartHandshake,
  Search,
  RefreshCw,
  Moon,
  Check,
  MessageCircle,
  ArrowLeftRight,
  ChevronLeft,
  ChevronRight,
  Loader2,
  AlertTriangle,
  Eye,
  Clock,
  Send,
  X,
  Trash2,
  Bookmark,
  LayoutGrid,
  List,
  CheckCircle,
  Heart,
  Sparkles,
  BarChart2,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { toast } from 'sonner';

// Components
import PotentialMatchCard from './PotentialMatchCard';
import PotentialMatchesStats from './PotentialMatchesStats';
import { ProfileCard } from '@/components/profile';

// Import New V2 Dashboard
import MatchmakerDashboardV2 from './MatchmakerDashboard';

// Import Dialogs
import { AiMatchmakerProfileAdvisorDialog } from '../dialogs/AiMatchmakerProfileAdvisorDialog';
import { ProfileFeedbackDialog } from '../dialogs/ProfileFeedbackDialog';

// Hooks
import { usePotentialMatches } from './hooks/usePotentialMatches';

// Types
import type {
  PotentialMatchFilterStatus,
  PotentialMatchSortBy,
  PotentialMatchesStats as FullStatsType,
  LastScanInfo as FullLastScanInfo,
} from './types/potentialMatches';
import type { ProfilePageDictionary } from '@/types/dictionary';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// Helper function to safely get main image
const getMainImage = (user: any) => {
  if (user?.images && Array.isArray(user.images)) {
    const main = user.images.find((img: any) => img.isMain);
    return main?.url || user.images[0]?.url || null;
  }
  return null;
};

// =============================================================================
// TYPES
// =============================================================================

interface PotentialMatchesDashboardProps {
  locale?: string;
  profileDict: ProfilePageDictionary;
  matchmakerDict: MatchmakerPageDictionary;
}

const STATUS_OPTIONS: {
  value: PotentialMatchFilterStatus;
  label: string;
  icon: React.ElementType;
}[] = [
  { value: 'all', label: '×”×›×œ', icon: Heart },
  { value: 'pending', label: '×××ª×™× ×•×ª', icon: Clock },
  { value: 'reviewed', label: '× ×‘×“×§×•', icon: Eye },
  { value: 'sent', label: '× ×©×œ×—×•', icon: Send },
  { value: 'shortlisted', label: '×©××•×¨×™× ×‘×¦×“', icon: Bookmark },
  { value: 'dismissed', label: '× ×“×—×•', icon: X },
  { value: 'with_warnings', label: '×¢× ××–×”×¨×•×ª', icon: AlertTriangle },
  { value: 'no_warnings', label: '×œ×œ× ××–×”×¨×•×ª', icon: CheckCircle },
];

const SORT_OPTIONS: { value: PotentialMatchSortBy; label: string }[] = [
  { value: 'score_desc', label: '×¦×™×•×Ÿ (×’×‘×•×” ×œ× ××•×š)' },
  { value: 'score_asc', label: '×¦×™×•×Ÿ (× ××•×š ×œ×’×‘×•×”)' },
  { value: 'date_desc', label: '×ª××¨×™×š (×—×“×© ×œ×™×©×Ÿ)' },
  { value: 'date_asc', label: '×ª××¨×™×š (×™×©×Ÿ ×œ×—×“×©)' },
  { value: 'male_waiting_time', label: '×–××Ÿ ×”××ª× ×” (×’×‘×¨)' },
  { value: 'female_waiting_time', label: '×–××Ÿ ×”××ª× ×” (××™×©×”)' },
];

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const PotentialMatchesDashboard: React.FC<PotentialMatchesDashboardProps> = ({
  locale = 'he',
  profileDict,
  matchmakerDict,
}) => {
  // --- View Mode (Tabs) ---
  const [activeTab, setActiveTab] = useState<'overview' | 'matches'>(
    'overview'
  );
  // × ×™×”×•×œ ×”×—×œ×¤×ª ×¦×“×“×™× (False = ×’×‘×¨ ×¦×“ ×', True = ××™×©×” ×¦×“ ×')
  const [isPartiesSwapped, setIsPartiesSwapped] = useState(false);

  // × ×™×”×•×œ ××•×¤×Ÿ ×”×©×œ×™×—×” (××™×™×œ ××•×˜×•××˜×™ ××• ×•×•××˜×¡××¤ ×™×“× ×™)
  const [notificationMethod, setNotificationMethod] = useState<
    'EMAIL' | 'WHATSAPP_MANUAL'
  >('EMAIL');
  // State for Matches List
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');

  // × ×™×”×•×œ ×—×™×¤×•×© ××§×•××™ ×¢×‘×•×¨ Debounce
  const [localSearchTerm, setLocalSearchTerm] = useState('');

  // × ×™×”×•×œ ×“×¤×“×•×£ ×™×“× ×™ (Input)
  const [pageInput, setPageInput] = useState('1');

  // × ×™×”×•×œ ××™×§×•× ×’×œ×™×œ×”
  const scrollPositionRef = useRef(0);

  const [showBulkActions, setShowBulkActions] = useState(false);

  // Dialogs
  const [confirmScanDialog, setConfirmScanDialog] = useState(false);
  const [confirmBulkDismissDialog, setConfirmBulkDismissDialog] =
    useState(false);
  const [createSuggestionDialog, setCreateSuggestionDialog] = useState<
    string | null
  >(null);
  const [dismissDialog, setDismissDialog] = useState<string | null>(null);
  const [dismissReason, setDismissReason] = useState('');

  // --- Profile View State ---
  const [viewProfileId, setViewProfileId] = useState<string | null>(null);
  const [fullProfileData, setFullProfileData] = useState<any | null>(null);
  const [questionnaireData, setQuestionnaireData] = useState<any | null>(null);
  const [isLoadingProfile, setIsLoadingProfile] = useState(false);
  const [isMatchmakerView, setIsMatchmakerView] = useState(true);

  // --- AI Analysis & Feedback State ---
  const [analyzedCandidate, setAnalyzedCandidate] = useState<any | null>(null);
  const [feedbackCandidate, setFeedbackCandidate] = useState<any | null>(null);
  const [editProfileCandidate, setEditProfileCandidate] = useState<any | null>(
    null
  );

  // Suggestion form state
  const [suggestionPriority, setSuggestionPriority] = useState<
    'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'
  >('MEDIUM');
  const [suggestionNotes, setSuggestionNotes] = useState('');
  const [confirmBulkCreateDialog, setConfirmBulkCreateDialog] = useState(false);
  const [bulkCreatePriority, setBulkCreatePriority] = useState<
    'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'
  >('MEDIUM');

  // Hook for Matches
  const {
    matches,
    stats,
    lastScanInfo,
    pagination,
    isLoading,
    isRefreshing,
    isActioning,
    filters,
    setFilters,
    resetFilters,
    setPage,
    setPageSize,
    refresh,
    reviewMatch,
    dismissMatch,
    restoreMatch,
    saveMatch,
    createSuggestion,
    bulkDismiss,
    bulkReview,
    startScan,
    scanProgress,
    isScanning,
    selectedMatchIds,
    toggleSelection,
    selectAll,
    clearSelection,
    isSelected,
    bulkCreateSuggestions,
    error,
    cancelScan,
    scanResult,
  } = usePotentialMatches({
    initialFilters: { status: 'pending' },
    autoRefresh: true,
    refreshInterval: 60000,
  });

  // Hook for Hidden Candidates
  const {
    hiddenCandidates,
    hiddenCandidateIds,
    isLoading: isLoadingHidden,
    hideCandidate,
    unhideCandidate,
    updateReason,
  } = useHiddenCandidates();

  const [candidateToHide, setCandidateToHide] =
    useState<CandidateToHide | null>(null);
  const [showHideDialog, setShowHideDialog] = useState(false);

  // ==========================================================================
  // SYNC PAGE INPUT
  // ==========================================================================
  useEffect(() => {
    setPageInput(String(pagination.page));
  }, [pagination.page]);

  const handleFilterByUser = useCallback((name: string) => {
    setLocalSearchTerm(name);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    toast.info(`××¦×™×’ ×”×ª×××•×ª ×¢×‘×•×¨: ${name}`);
  }, []);

  // ==========================================================================
  // SERVER SIDE SEARCH EFFECT
  // ==========================================================================
  useEffect(() => {
    const timer = setTimeout(() => {
      const term = localSearchTerm.trim();
      if (term.length > 0) {
        setFilters({
          searchTerm: term,
          status: 'all',
        });
      } else {
        setFilters({ searchTerm: '' });
      }
    }, 600);

    return () => clearTimeout(timer);
  }, [localSearchTerm, setFilters]);

  // ==========================================================================
  // PROFILE LOADING EFFECT
  // ==========================================================================
  useEffect(() => {
    const loadProfileData = async () => {
      if (!viewProfileId) {
        setFullProfileData(null);
        setQuestionnaireData(null);
        return;
      }

      setIsLoadingProfile(true);
      try {
        const profileResponse = await fetch(
          `/api/matchmaker/candidates/${viewProfileId}`
        );
        const profileJson = await profileResponse.json();

        if (profileJson.success) {
          const formattedData = {
            ...profileJson,
            profile: {
              ...profileJson.profile,
              user: profileJson.user,
            },
          };
          setFullProfileData(formattedData);
        } else {
          toast.error('×œ× × ×™×ª×Ÿ ×”×™×” ×œ×˜×¢×•×Ÿ ××ª ×”×¤×¨×•×¤×™×œ');
        }

        const questionnaireResponse = await fetch(
          `/api/profile/questionnaire?userId=${viewProfileId}&locale=${locale}`
        );
        const questionnaireJson = await questionnaireResponse.json();

        if (
          questionnaireJson.success &&
          questionnaireJson.questionnaireResponse
        ) {
          setQuestionnaireData(questionnaireJson.questionnaireResponse);
        }
      } catch (err) {
        console.error('Failed to load full profile:', err);
        toast.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×•×¤×™×œ ×”××•×¢××“');
      } finally {
        setIsLoadingProfile(false);
      }
    };

    loadProfileData();
  }, [viewProfileId, locale]);

  // ==========================================================================
  // HANDLERS
  // ==========================================================================
  const filteredMatches = useMemo(() => {
    let result = matches;

    if (hiddenCandidateIds.size > 0) {
      result = result.filter(
        (match) =>
          !hiddenCandidateIds.has(match.male.id) &&
          !hiddenCandidateIds.has(match.female.id)
      );
    }

    // âŒ ××—×§× ×• ××›××Ÿ ××ª ×”×‘×œ×•×§ ×©×œ if (localSearchTerm && ...)
    // ×›×“×™ ×©×”×¤×¨×•× ×˜× ×“ ×œ× ×™×¡× ×Ÿ ×©×•×‘ ××ª ×”×ª×•×¦××•×ª ×©××’×™×¢×•×ª ××”×©×¨×ª.

    return result;
  }, [matches, hiddenCandidateIds]); // âŒ ××—×§× ×• ×’× ××ª localSearchTerm ××”×¡×•×’×¨×™×™×

   const handleStartScan = (
    method: 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2',
    skipPreparation: boolean // ×”×•×¡×¤× ×• ××ª ×”×¤×¨××˜×¨ ×”×–×”
  ) => {
    startScan({
      action: 'full_scan',
      method,
      forceRefresh: false,
      skipPreparation, // ××¢×‘×™×¨×™× ××•×ª×• ×œ-HOOK
    });
};

  const handleHideCandidate = (candidate: CandidateToHide) => {
    setCandidateToHide(candidate);
    setShowHideDialog(true);
  };

  const handleConfirmHide = async (candidateId: string, reason?: string) => {
    return await hideCandidate(candidateId, reason);
  };

  const handleCreateSuggestion = useCallback(async () => {
    if (!createSuggestionDialog) return;

    const suggestionId = await createSuggestion(createSuggestionDialog, {
      priority: suggestionPriority,
      matchingReason: suggestionNotes || undefined,
      suppressNotifications: notificationMethod === 'WHATSAPP_MANUAL',
      swapParties: isPartiesSwapped,
    });

    if (suggestionId) {
      setCreateSuggestionDialog(null);
      setSuggestionPriority('MEDIUM');
      setSuggestionNotes('');
      setNotificationMethod('EMAIL');
      setIsPartiesSwapped(false);

      if (notificationMethod === 'WHATSAPP_MANUAL') {
        toast.info('×”×”×¦×¢×” × ×•×¦×¨×”. ×–×›×•×¨ ×œ×©×œ×•×— ××ª ×”×”×•×“×¢×” ×‘×•×•××˜×¡××¤!', {
          duration: 5000,
          icon: <MessageCircle className="w-5 h-5 text-green-500" />,
        });
      }
    }
  }, [
    createSuggestionDialog,
    createSuggestion,
    suggestionPriority,
    suggestionNotes,
    notificationMethod,
    isPartiesSwapped,
  ]);

  const handleDismiss = useCallback(async () => {
    if (!dismissDialog) return;

    await dismissMatch(dismissDialog, dismissReason || undefined);
    setDismissDialog(null);
    setDismissReason('');
  }, [dismissDialog, dismissMatch, dismissReason]);

  const handleBulkDismiss = useCallback(async () => {
    setConfirmBulkDismissDialog(false);
    await bulkDismiss(selectedMatchIds, '×“×—×™×™×” ××¨×•×‘×”');
  }, [bulkDismiss, selectedMatchIds]);

  const handleViewProfile = useCallback((userId: string) => {
    scrollPositionRef.current = window.scrollY;
    setViewProfileId(userId);
  }, []);
  const handleEditProfile = useCallback((candidate: any) => {
    scrollPositionRef.current = window.scrollY;
    setEditProfileCandidate(candidate);
  }, []);

  const handleCloseEditProfile = useCallback(() => {
    const savedPosition = scrollPositionRef.current;
    setEditProfileCandidate(null);
    requestAnimationFrame(() => {
      window.scrollTo(0, savedPosition);
    });
  }, []);
  const handleResetFilters = useCallback(() => {
    setLocalSearchTerm('');
    resetFilters();
  }, [resetFilters]);

  const handlePageInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPageInput(e.target.value);
  };

  const handlePageInputSubmit = () => {
    const newPage = parseInt(pageInput);
    if (!isNaN(newPage) && newPage >= 1 && newPage <= pagination.totalPages) {
      setPage(newPage);
    } else {
      setPageInput(String(pagination.page));
      toast.error(`× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¢××•×“ ×‘×™×Ÿ 1 ×œ-${pagination.totalPages}`);
    }
  };

  const handlePageInputKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      handlePageInputSubmit();
    }
  };

  // ××¦×™××ª ×”×”×ª×××” ×©×¢×œ×™×” ×œ×—×¦× ×• ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×ª××•× ×•×ª ×•×”×©××•×ª ×‘×“×™××œ×•×’
  const activeMatchForSuggestion = useMemo(
    () => matches.find((m) => m.id === createSuggestionDialog),
    [matches, createSuggestionDialog]
  );

  // ==========================================================================
  // RENDER
  // ==========================================================================

  return (
    <div
      className="min-h-screen bg-gradient-to-br from-gray-50 via-purple-50/30 to-pink-50/30"
      dir="rtl"
    >
      {/* Header */}
      <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-sm border-b shadow-sm">
        <div className="container mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            {/* Title & Tabs */}
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-xl bg-gradient-to-br from-pink-500 to-rose-500 text-white shadow-lg">
                <HeartHandshake className="w-6 h-6" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-800">
                  ××¢×¨×›×ª ×”×©×™×“×•×›×™×
                </h1>

                {/* Tabs Navigation */}
                <div className="flex gap-2 mt-1">
                  <button
                    onClick={() => setActiveTab('overview')}
                    className={`flex items-center gap-1 text-sm px-2 py-0.5 rounded transition-all ${activeTab === 'overview' ? 'bg-indigo-50 text-indigo-700 font-bold shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}
                  >
                    <BarChart2 className="w-3.5 h-3.5" />
                    ××‘×˜ ×¢×œ
                  </button>
                  <button
                    onClick={() => setActiveTab('matches')}
                    className={`flex items-center gap-1 text-sm px-2 py-0.5 rounded transition-all ${activeTab === 'matches' ? 'bg-indigo-50 text-indigo-700 font-bold shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}
                  >
                    <Sparkles className="w-3.5 h-3.5" />
                    × ×™×”×•×œ ×”×ª×××•×ª ({stats ? stats.pending : '...'})
                  </button>
                </div>
              </div>
            </div>

            {/* Actions - Only visible when in Matches tab */}
            {activeTab === 'matches' && (
              <div className="flex items-center gap-3">
                <HiddenCandidatesDrawer
                  hiddenCandidates={hiddenCandidates}
                  onUnhide={unhideCandidate}
                  onUpdateReason={updateReason}
                  isLoading={isLoadingHidden}
                />
                <BatchScanButtons
                  isScanning={isScanning}
                  scanProgress={scanProgress}
                  scanResult={scanResult}
                  onStartScan={handleStartScan}
                  onCancelScan={cancelScan}
                  lastScanInfo={lastScanInfo}
                />

                <Button
                  variant="outline"
                  onClick={refresh}
                  disabled={isRefreshing}
                >
                  <RefreshCw
                    className={cn(
                      'w-4 h-4 ml-2',
                      isRefreshing && 'animate-spin'
                    )}
                  />
                  ×¨×¢× ×Ÿ
                </Button>
              </div>
            )}
          </div>
        </div>
      </header>

      <main className="container mx-auto px-6 py-6 space-y-6">
        {/* Conditional Rendering based on Tab */}
        {activeTab === 'overview' ? (
          <MatchmakerDashboardV2 />
        ) : (
          <>
            {/* Stats */}
            <PotentialMatchesStats
              stats={stats as unknown as FullStatsType}
              lastScanInfo={lastScanInfo as unknown as FullLastScanInfo}
              isScanRunning={isScanning}
              scanProgress={scanProgress?.progressPercent || 0}
            />

            {/* Filters & Controls */}
            <Card className="p-4 border-0 shadow-lg">
              <div className="flex flex-wrap items-center gap-4">
                {/* Search */}
                <div className="flex-1 min-w-[200px] max-w-md relative">
                  <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                  <Input
                    placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× (×œ×“×•×’××”: ×™×©×¨××œ ×™×©×¨××œ×™)..."
                    value={localSearchTerm}
                    onChange={(e) => setLocalSearchTerm(e.target.value)}
                    className="pr-10"
                  />
                </div>
                {/* Advanced Filters */}
                <PotentialMatchesFilters
                  filters={filters}
                  onFiltersChange={setFilters}
                  onReset={resetFilters}
                />
                {/* Status Filter */}
                <Select
                  value={filters.status}
                  onValueChange={(value) =>
                    setFilters({ status: value as PotentialMatchFilterStatus })
                  }
                >
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="×¡×˜×˜×•×¡" />
                  </SelectTrigger>
                  <SelectContent>
                    {STATUS_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className="flex items-center gap-2">
                          <option.icon className="w-4 h-4" />
                          {option.label}
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {/* Sort */}
                <Select
                  value={filters.sortBy}
                  onValueChange={(value) =>
                    setFilters({ sortBy: value as any })
                  }
                >
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="××™×•×Ÿ" />
                  </SelectTrigger>
                  <SelectContent>
                    {SORT_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>

                {/* Score Range */}
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">×¦×™×•×Ÿ:</span>
                  <Input
                    type="number"
                    min={0}
                    max={100}
                    value={filters.minScore}
                    onChange={(e) =>
                      setFilters({ minScore: parseInt(e.target.value) || 0 })
                    }
                    className="w-16 text-center"
                  />
                  <span>-</span>
                  <Input
                    type="number"
                    min={0}
                    max={100}
                    value={filters.maxScore}
                    onChange={(e) =>
                      setFilters({ maxScore: parseInt(e.target.value) || 100 })
                    }
                    className="w-16 text-center"
                  />
                </div>

                {/* View Mode */}
                <div className="flex items-center gap-1 border rounded-lg p-1">
                  <Button
                    variant={viewMode === 'grid' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('grid')}
                  >
                    <LayoutGrid className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={viewMode === 'list' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('list')}
                  >
                    <List className="w-4 h-4" />
                  </Button>
                </div>

                {/* Bulk Selection Toggle */}
                <Button
                  variant={showBulkActions ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => {
                    setShowBulkActions(!showBulkActions);
                    if (showBulkActions) clearSelection();
                  }}
                >
                  <Check className="w-4 h-4 ml-1" />
                  ×‘×—×™×¨×” ××¨×•×‘×”
                </Button>

                {/* Reset Filters */}
                <Button variant="ghost" size="sm" onClick={handleResetFilters}>
                  <X className="w-4 h-4 ml-1" />
                  × ×§×” ×¤×™×œ×˜×¨×™×
                </Button>
              </div>

              {/* Bulk Actions Bar */}
              {/* Bulk Actions Bar */}
              <AnimatePresence>
                {showBulkActions && selectedMatchIds.length > 0 && (
                  <motion.div
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: 'auto' }}
                    exit={{ opacity: 0, height: 0 }}
                    className="mt-4 pt-4 border-t"
                  >
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="text-sm text-gray-600 font-medium">
                        × ×‘×—×¨×•{' '}
                        <span className="font-bold text-purple-600">
                          {selectedMatchIds.length}
                        </span>{' '}
                        ×”×ª×××•×ª
                      </span>

                      <Button size="sm" variant="outline" onClick={selectAll}>
                        ×‘×—×¨ ×”×›×œ
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={clearSelection}
                      >
                        ×‘×˜×œ ×‘×—×™×¨×”
                      </Button>

                      <div className="flex-1" />

                      {/* ğŸ†• ×›×¤×ª×•×¨ ×—×“×© - ×©×œ×™×—×ª ×”×¦×¢×•×ª ××¨×•×‘×•×ª */}
                      <Button
                        size="sm"
                        className="bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white shadow-lg"
                        onClick={() => setConfirmBulkCreateDialog(true)}
                        disabled={isActioning}
                      >
                        <Send className="w-4 h-4 ml-1" />
                        ×©×œ×— ×”×¦×¢×•×ª ({selectedMatchIds.length})
                      </Button>

                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => bulkReview(selectedMatchIds)}
                        disabled={isActioning}
                      >
                        <Eye className="w-4 h-4 ml-1" />
                        ×¡××Ÿ ×›× ×‘×“×§×•
                      </Button>

                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => setConfirmBulkDismissDialog(true)}
                        disabled={isActioning}
                      >
                        <Trash2 className="w-4 h-4 ml-1" />
                        ×“×—×” ×”×›×œ
                      </Button>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </Card>

            {/* Error State */}
            {error && (
              <Card className="p-6 bg-red-50 border-red-200">
                <div className="flex items-center gap-3 text-red-700">
                  <AlertTriangle className="w-5 h-5" />
                  <span>{error}</span>
                  <Button variant="outline" size="sm" onClick={refresh}>
                    × ×¡×” ×©×•×‘
                  </Button>
                </div>
              </Card>
            )}

            {/* Loading State */}
            {isLoading && (
              <div className="flex items-center justify-center py-20">
                <Loader2 className="w-8 h-8 animate-spin text-purple-500" />
              </div>
            )}

            {/* Empty State */}
            {!isLoading && matches.length === 0 && (
              <Card className="p-12 text-center border-0 shadow-lg">
                <Heart className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                <h3 className="text-xl font-bold text-gray-700 mb-2">
                  ×œ× × ××¦××• ×”×ª×××•×ª
                </h3>
                <p className="text-gray-500 mb-6">
                  {localSearchTerm
                    ? '×œ× × ××¦××• ×ª×•×¦××•×ª ×”×ª×•×××•×ª ××ª ×”×—×™×¤×•×© ×©×œ×š.'
                    : filters.status !== 'all'
                      ? '× ×¡×” ×œ×©× ×•×ª ××ª ×”×¤×™×œ×˜×¨×™× ××• ×œ×—×¤×© ×‘×›×œ ×”×”×ª×××•×ª.'
                      : '×”×¤×¢×œ ×¡×¨×™×§×” ×œ×™×œ×™×ª ×œ××¦×™××ª ×”×ª×××•×ª ×—×“×©×•×ª.'}
                </p>
                {localSearchTerm || filters.status !== 'all' ? (
                  <Button variant="outline" onClick={handleResetFilters}>
                    × ×§×” ×—×™×¤×•×© ×•×¤×™×œ×˜×¨×™×
                  </Button>
                ) : (
                  <Button onClick={() => setConfirmScanDialog(true)}>
                    <Moon className="w-4 h-4 ml-2" />
                    ×”×¤×¢×œ ×¡×¨×™×§×”
                  </Button>
                )}
              </Card>
            )}

            {/* Matches Grid */}
            {!isLoading && matches.length > 0 && (
              <>
                <div
                  className={cn(
                    'grid gap-6',
                    viewMode === 'grid'
                      ? 'grid-cols-1 md:grid-cols-2 xl:grid-cols-3'
                      : 'grid-cols-1'
                  )}
                >
                  <AnimatePresence mode="popLayout">
                    {filteredMatches.map((match) => (
                      <PotentialMatchCard
                        key={match.id}
                        match={match as any}
                        onCreateSuggestion={(id) =>
                          setCreateSuggestionDialog(id)
                        }
                        onDismiss={(id) => dismissMatch(id)}
                        onReview={reviewMatch}
                        onRestore={restoreMatch}
                        onSave={saveMatch}
                        onViewProfile={handleViewProfile}
                        onAnalyzeCandidate={(candidate) =>
                          setAnalyzedCandidate(candidate)
                        }
                        onProfileFeedback={(candidate) =>
                          setFeedbackCandidate(candidate)
                        }
                        isSelected={isSelected(match.id)}
                        onToggleSelect={
                          showBulkActions ? toggleSelection : undefined
                        }
                        showSelection={showBulkActions}
                        onHideCandidate={handleHideCandidate}
                        hiddenCandidateIds={hiddenCandidateIds}
                        // ---> ×”×ª×™×§×•×Ÿ ×›××Ÿ: ×”×•×¡×¤×ª×™ ××ª ×”×¤×•× ×§×¦×™×” ×”×—×¡×¨×”
                        onFilterByUser={handleFilterByUser}
                      />
                    ))}
                  </AnimatePresence>
                </div>

                {/* Pagination */}
                <Card className="p-4 border-0 shadow-lg">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-600">
                        ××¦×™×’ {(pagination.page - 1) * pagination.pageSize + 1} -{' '}
                        {Math.min(
                          pagination.page * pagination.pageSize,
                          pagination.total
                        )}{' '}
                        ××ª×•×š {pagination.total}
                      </span>
                    </div>

                    <div className="flex items-center gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPage(pagination.page - 1)}
                        disabled={pagination.page <= 1}
                      >
                        <ChevronRight className="w-4 h-4" />
                      </Button>

                      <div className="flex items-center gap-1 mx-2">
                        <span className="text-sm text-gray-600">×¢××•×“</span>
                        <Input
                          className="h-8 w-12 text-center p-0"
                          value={pageInput}
                          onChange={handlePageInputChange}
                          onBlur={handlePageInputSubmit}
                          onKeyDown={handlePageInputKeyDown}
                        />
                        <span className="text-sm text-gray-600">
                          ××ª×•×š {pagination.totalPages}
                        </span>
                      </div>

                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPage(pagination.page + 1)}
                        disabled={pagination.page >= pagination.totalPages}
                      >
                        <ChevronLeft className="w-4 h-4" />
                      </Button>
                    </div>

                    <Select
                      value={String(pagination.pageSize)}
                      onValueChange={(value) => setPageSize(parseInt(value))}
                    >
                      <SelectTrigger className="w-[100px]">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="10">10</SelectItem>
                        <SelectItem value="20">20</SelectItem>
                        <SelectItem value="50">50</SelectItem>
                        <SelectItem value="100">100</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </Card>
              </>
            )}
          </>
        )}
      </main>

      {/* ======================================================================== */}
      {/* DIALOGS */}
      {/* ======================================================================== */}

      {/* Profile Dialog */}
      <Dialog
        open={!!viewProfileId}
        onOpenChange={(open) => {
          if (!open) {
            // ×©××•×¨ ××ª ×”××™×§×•× ×œ×¤× ×™ ××™×¤×•×¡
            const savedPosition = scrollPositionRef.current;

            setViewProfileId(null);
            setFullProfileData(null);
            setQuestionnaireData(null);

            // ×©×—×–×¨ ××™×“ ×‘-requestAnimationFrame
            requestAnimationFrame(() => {
              window.scrollTo(0, savedPosition);
            });
          }
        }}
      >
        <DialogContent
          className="max-w-6xl max-h-[90vh] overflow-y-auto p-0"
          dir={locale === 'he' ? 'rtl' : 'ltr'}
          onCloseAutoFocus={(e) => {
            e.preventDefault();
          }}
        >
          {/* Custom Header */}
          <div className="sticky top-0 z-50 flex items-center justify-between px-6 py-4 bg-white/95 backdrop-blur-sm border-b border-gray-100">
            <DialogTitle className="text-xl font-bold text-gray-800">
              {fullProfileData
                ? `${fullProfileData.profile?.user?.firstName || ''} ${fullProfileData.profile?.user?.lastName || ''}`
                : '×˜×•×¢×Ÿ ×¤×¨×•×¤×™×œ...'}
            </DialogTitle>

            <div className="flex items-center gap-2">
              <Select
                value={isMatchmakerView ? 'matchmaker' : 'candidate'}
                onValueChange={(value) =>
                  setIsMatchmakerView(value === 'matchmaker')
                }
              >
                <SelectTrigger className="w-[140px] h-9">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="candidate">×ª×¦×•×’×ª ××•×¢××“</SelectItem>
                  <SelectItem value="matchmaker">×ª×¦×•×’×ª ×©×“×›×Ÿ</SelectItem>
                </SelectContent>
              </Select>

              <Button
                variant="ghost"
                size="icon"
                onClick={() => setViewProfileId(null)}
                className="h-9 w-9 rounded-full hover:bg-red-50 hover:text-red-600"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>
          </div>

          <div className="p-0">
            {isLoadingProfile ? (
              <div className="flex flex-col items-center justify-center py-20">
                <Loader2 className="w-10 h-10 animate-spin text-purple-500 mb-4" />
                <p className="text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™ ×¤×¨×•×¤×™×œ...</p>
              </div>
            ) : fullProfileData ? (
              <ProfileCard
                profile={fullProfileData.profile}
                images={fullProfileData.images}
                questionnaire={questionnaireData}
                viewMode={isMatchmakerView ? 'matchmaker' : 'candidate'}
                isProfileComplete={
                  fullProfileData.profile?.isProfileComplete || false
                }
                locale={locale}
                onClose={() => setViewProfileId(null)}
                dict={profileDict.profileCard}
              />
            ) : (
              <div className="p-10 text-center text-gray-500">
                ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×¤×¨×•×¤×™×œ
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* --- AI Analysis Dialog --- */}
      <AiMatchmakerProfileAdvisorDialog
        isOpen={!!analyzedCandidate}
        onClose={() => setAnalyzedCandidate(null)}
        candidate={analyzedCandidate}
        dict={matchmakerDict.candidatesManager.aiProfileAdvisor}
        locale={locale}
      />

      {/* --- Profile Feedback Dialog --- */}
      <ProfileFeedbackDialog
        isOpen={!!feedbackCandidate}
        onClose={() => setFeedbackCandidate(null)}
        candidate={feedbackCandidate}
        locale={locale}
        dict={matchmakerDict.candidatesManager.profileFeedbackDialog}
      />

      {/* Confirm Scan Dialog */}
      <AlertDialog open={confirmScanDialog} onOpenChange={setConfirmScanDialog}>
        <AlertDialogContent dir="rtl">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2">
              <Moon className="w-5 h-5 text-indigo-600" />
              ×”×¤×¢×œ×ª ×¡×¨×™×§×” ×œ×™×œ×™×ª
            </AlertDialogTitle>
            <AlertDialogDescription>
              ×”×¡×¨×™×§×” ×ª×¢×‘×•×¨ ×¢×œ ×›×œ ×”××•×¢××“×™× ×‘××¢×¨×›×ª ×•×ª××¦× ×”×ª×××•×ª ×¤×•×˜× ×¦×™××œ×™×•×ª ×—×“×©×•×ª.
              ×”×ª×”×œ×™×š ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×“×§×•×ª.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-2">
            <AlertDialogCancel>×‘×™×˜×•×œ</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => handleStartScan('hybrid', false)} 
              className="bg-gradient-to-r from-indigo-500 to-purple-500"
            >
              <HeartHandshake className="w-4 h-4 ml-2" />
              ×”×ª×—×œ ×¡×¨×™×§×”
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Confirm Bulk Dismiss Dialog */}
      <AlertDialog
        open={confirmBulkDismissDialog}
        onOpenChange={setConfirmBulkDismissDialog}
      >
        <AlertDialogContent dir="rtl">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2 text-red-600">
              <Trash2 className="w-5 h-5" />
              ×“×—×™×™×ª {selectedMatchIds.length} ×”×ª×××•×ª
            </AlertDialogTitle>
            <AlertDialogDescription>
              ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×“×—×•×ª ××ª ×›×œ ×”×”×ª×××•×ª ×©× ×‘×—×¨×•? × ×™×ª×Ÿ ×™×”×™×” ×œ×©×—×–×¨
              ××•×ª×Ÿ ×‘×”××©×š.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-2">
            <AlertDialogCancel>×‘×™×˜×•×œ</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleBulkDismiss}
              className="bg-red-600 hover:bg-red-700"
            >
              ×“×—×” ×”×›×œ
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Create Suggestion Dialog - Updated Version */}
      <Dialog
        open={!!createSuggestionDialog}
        onOpenChange={(open) => {
          if (!open) {
            setCreateSuggestionDialog(null);
            setIsPartiesSwapped(false);
            setNotificationMethod('EMAIL');
          }
        }}
      >
        <DialogContent dir="rtl" className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <HeartHandshake className="w-5 h-5 text-green-600" />
              ×™×¦×™×¨×ª ×”×¦×¢×”
            </DialogTitle>
            <DialogDescription>
              ×§×‘×¢ ××ª ×¡×“×¨ ×”×¤× ×™×™×” ×•××•×¤×Ÿ ×”×©×œ×™×—×”
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-5">
            {/* --- ××–×•×¨ 1: ×•×™×–×•××œ×™×–×¦×™×” ×•×”×—×œ×¤×ª ×¦×“×“×™× --- */}
            {activeMatchForSuggestion &&
              (() => {
                // Calculate images once
                const firstPartyImage = isPartiesSwapped
                  ? getMainImage(activeMatchForSuggestion.female)
                  : getMainImage(activeMatchForSuggestion.male);

                const secondPartyImage = isPartiesSwapped
                  ? getMainImage(activeMatchForSuggestion.male)
                  : getMainImage(activeMatchForSuggestion.female);

                return (
                  <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div className="flex items-center justify-between gap-2">
                      {/* ×¦×“ ×' (×¤× ×™×™×” ×¨××©×•× ×”) */}
                      <div className="flex-1 flex flex-col items-center text-center">
                        <span className="text-xs font-bold text-blue-600 mb-1">
                          ×¦×“ × (×¨××©×•×Ÿ)
                        </span>
                        <div className="w-14 h-14 rounded-full overflow-hidden border-2 border-blue-200 bg-white shadow-sm mb-1">
                          {firstPartyImage ? (
                            <img
                              src={firstPartyImage}
                              alt=""
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <span className="flex items-center justify-center h-full text-xl">
                              {isPartiesSwapped ? 'ğŸ‘©' : 'ğŸ‘¨'}
                            </span>
                          )}
                        </div>
                        <span className="text-sm font-medium text-gray-800">
                          {isPartiesSwapped
                            ? activeMatchForSuggestion.female.firstName
                            : activeMatchForSuggestion.male.firstName}
                        </span>
                      </div>

                      {/* ×›×¤×ª×•×¨ ×”×—×œ×¤×” ×‘×××¦×¢ */}
                      <div className="flex flex-col items-center px-2">
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => setIsPartiesSwapped(!isPartiesSwapped)}
                          className="rounded-full shadow-sm hover:bg-white hover:border-indigo-300 transition-all active:scale-95"
                          title="×”×—×œ×£ ×¦×“×“×™×"
                        >
                          <ArrowLeftRight className="w-4 h-4 text-indigo-600" />
                        </Button>
                        <span className="text-[10px] text-gray-400 mt-1">
                          ×”×—×œ×£
                        </span>
                      </div>

                      {/* ×¦×“ ×‘' (×¤× ×™×™×” ×©× ×™×™×”) */}
                      <div className="flex-1 flex flex-col items-center text-center opacity-70">
                        <span className="text-xs font-bold text-gray-500 mb-1">
                          ×¦×“ ×‘ (×©× ×™)
                        </span>
                        <div className="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-white shadow-sm mb-1">
                          {secondPartyImage ? (
                            <img
                              src={secondPartyImage}
                              alt=""
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <span className="flex items-center justify-center h-full text-xl">
                              {isPartiesSwapped ? 'ğŸ‘¨' : 'ğŸ‘©'}
                            </span>
                          )}
                        </div>
                        <span className="text-sm font-medium text-gray-600">
                          {isPartiesSwapped
                            ? activeMatchForSuggestion.male.firstName
                            : activeMatchForSuggestion.female.firstName}
                        </span>
                      </div>
                    </div>
                  </div>
                );
              })()}

            {/* --- ××–×•×¨ 2: ×‘×—×™×¨×ª ×¢×¨×•×¥ ×©×œ×™×—×” --- */}
            <div>
              <label className="text-sm font-medium text-gray-700 mb-2 block">
                ××™×š ×œ×©×œ×•×— ××ª ×”×”×¦×¢×”?
              </label>
              <div className="grid grid-cols-2 gap-3">
                <div
                  onClick={() => setNotificationMethod('EMAIL')}
                  className={cn(
                    'cursor-pointer p-3 rounded-xl border-2 flex flex-col items-center justify-center gap-1 transition-all',
                    notificationMethod === 'EMAIL'
                      ? 'border-blue-500 bg-blue-50 text-blue-700'
                      : 'border-gray-100 bg-white hover:bg-gray-50'
                  )}
                >
                  <Send className="w-5 h-5 mb-1" />
                  <span className="text-sm font-bold">××•×˜×•××˜×™ (××™×™×œ)</span>
                </div>

                <div
                  onClick={() => setNotificationMethod('WHATSAPP_MANUAL')}
                  className={cn(
                    'cursor-pointer p-3 rounded-xl border-2 flex flex-col items-center justify-center gap-1 transition-all',
                    notificationMethod === 'WHATSAPP_MANUAL'
                      ? 'border-green-500 bg-green-50 text-green-700'
                      : 'border-gray-100 bg-white hover:bg-gray-50'
                  )}
                >
                  <MessageCircle className="w-5 h-5 mb-1" />
                  <span className="text-sm font-bold">×™×“× ×™ (×•×•××˜×¡××¤)</span>
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-2">
                {notificationMethod === 'EMAIL'
                  ? "×”××¢×¨×›×ª ×ª×©×œ×— ××™×™×œ ×œ×¦×“ ×' (×”×¨××©×•×Ÿ) ×‘××•×¤×Ÿ ××•×˜×•××˜×™."
                  : '×”×”×¦×¢×” ×ª×™×•×•×¦×¨ ×‘××¢×¨×›×ª, ××š ×œ× ×™×™×©×œ×— ××™×™×œ. ×‘××—×¨×™×•×ª×š ×œ×©×œ×•×— ×”×•×“×¢×”.'}
              </p>
            </div>

            {/* --- ××–×•×¨ 3: ×¤×¨×˜×™× × ×•×¡×¤×™× --- */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm font-medium text-gray-700 mb-1 block">
                  ×¢×“×™×¤×•×ª
                </label>
                <Select
                  value={suggestionPriority}
                  onValueChange={(value) => setSuggestionPriority(value as any)}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="LOW">× ××•×›×”</SelectItem>
                    <SelectItem value="MEDIUM">×‘×™× ×•× ×™×ª</SelectItem>
                    <SelectItem value="HIGH">×’×‘×•×”×”</SelectItem>
                    <SelectItem value="URGENT">×“×—×•×¤×”</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div>
              <label className="text-sm font-medium text-gray-700 mb-1 block">
                ×”×¢×¨×•×ª ×¤× ×™××™×•×ª (××•×¤×¦×™×•× ×œ×™)
              </label>
              <Textarea
                value={suggestionNotes}
                onChange={(e) => setSuggestionNotes(e.target.value)}
                placeholder="×”×•×¡×£ ×”×¢×¨×•×ª..."
                rows={2}
              />
            </div>
          </div>

          <DialogFooter className="gap-2 mt-4">
            <Button
              variant="outline"
              onClick={() => setCreateSuggestionDialog(null)}
            >
              ×‘×™×˜×•×œ
            </Button>
            <Button
              onClick={handleCreateSuggestion}
              disabled={isActioning}
              className="bg-gradient-to-r from-green-500 to-emerald-500 min-w-[120px]"
            >
              {isActioning ? (
                <Loader2 className="w-4 h-4 ml-2 animate-spin" />
              ) : (
                <HeartHandshake className="w-4 h-4 ml-2" />
              )}
              ×¦×•×¨ ×”×¦×¢×”
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <HideCandidateDialog
        open={showHideDialog}
        onOpenChange={setShowHideDialog}
        candidate={candidateToHide}
        onConfirm={handleConfirmHide}
      />

      {/* Dismiss Dialog */}
      <Dialog
        open={!!dismissDialog}
        onOpenChange={(open) => !open && setDismissDialog(null)}
      >
        <DialogContent dir="rtl" className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2 text-red-600">
              <X className="w-5 h-5" />
              ×“×—×™×™×ª ×”×ª×××”
            </DialogTitle>
            <DialogDescription>
              × ×™×ª×Ÿ ×œ×¦×™×™×Ÿ ×¡×™×‘×” ×œ×“×—×™×™×” (××•×¤×¦×™×•× ×œ×™)
            </DialogDescription>
          </DialogHeader>

          <div>
            <Textarea
              value={dismissReason}
              onChange={(e) => setDismissReason(e.target.value)}
              placeholder="×¡×™×‘×ª ×”×“×—×™×™×”..."
              rows={3}
            />
          </div>

          <DialogFooter className="gap-2">
            <Button variant="outline" onClick={() => setDismissDialog(null)}>
              ×‘×™×˜×•×œ
            </Button>
            <Button
              onClick={handleDismiss}
              disabled={isActioning}
              variant="destructive"
            >
              {isActioning ? (
                <Loader2 className="w-4 h-4 ml-2 animate-spin" />
              ) : (
                <X className="w-4 h-4 ml-2" />
              )}
              ×“×—×”
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
      {/* Confirm Bulk Create Suggestions Dialog */}
      <AlertDialog
        open={confirmBulkCreateDialog}
        onOpenChange={setConfirmBulkCreateDialog}
      >
        <AlertDialogContent dir="rtl" className="max-w-md">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2 text-lg">
              <div className="p-2 rounded-full bg-gradient-to-r from-emerald-500 to-green-500 text-white">
                <Send className="w-5 h-5" />
              </div>
              ×©×œ×™×—×ª {selectedMatchIds.length} ×”×¦×¢×•×ª
            </AlertDialogTitle>
            <AlertDialogDescription>
              ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×œ×•×— {selectedMatchIds.length} ×”×¦×¢×•×ª?
            </AlertDialogDescription>
          </AlertDialogHeader>

          {/* ×ª×•×›×Ÿ × ×•×¡×£ - ××—×•×¥ ×œ-Header */}
          <div className="space-y-4">
            {/* ×‘×—×™×¨×ª ×¢×“×™×¤×•×ª */}
            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span className="text-sm font-medium text-gray-700">×¢×“×™×¤×•×ª:</span>
              <Select
                value={bulkCreatePriority}
                onValueChange={(v: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT') =>
                  setBulkCreatePriority(v)
                }
              >
                <SelectTrigger className="w-[140px]">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="LOW">
                    <span className="flex items-center gap-2">
                      <span className="w-2 h-2 rounded-full bg-gray-400" />
                      × ××•×›×”
                    </span>
                  </SelectItem>
                  <SelectItem value="MEDIUM">
                    <span className="flex items-center gap-2">
                      <span className="w-2 h-2 rounded-full bg-blue-500" />
                      ×¨×’×™×œ×”
                    </span>
                  </SelectItem>
                  <SelectItem value="HIGH">
                    <span className="flex items-center gap-2">
                      <span className="w-2 h-2 rounded-full bg-orange-500" />
                      ×’×‘×•×”×”
                    </span>
                  </SelectItem>
                  <SelectItem value="URGENT">
                    <span className="flex items-center gap-2">
                      <span className="w-2 h-2 rounded-full bg-red-500" />
                      ×“×—×•×¤×”
                    </span>
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* ×”×¢×¨×” */}
            <div className="p-3 bg-amber-50 rounded-lg border border-amber-200">
              <div className="flex items-start gap-2">
                <AlertTriangle className="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0" />
                <div className="text-sm text-amber-800">
                  <p className="font-medium">×©×™× ×œ×‘:</p>
                  <p className="mt-1">
                    ×›×œ ×”×¦×¢×” ×ª×™×©×œ×— ×œ×©× ×™ ×”×¦×“×“×™× ×‘× ×¤×¨×“. ××™×™×œ×™× ×™×™×©×œ×—×• ××•×˜×•××˜×™×ª.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <AlertDialogFooter className="gap-2 mt-4">
            <AlertDialogCancel className="flex-1">×‘×™×˜×•×œ</AlertDialogCancel>
            <AlertDialogAction
              className="flex-1 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white"
              onClick={async () => {
                const result = await bulkCreateSuggestions(selectedMatchIds, {
                  priority: bulkCreatePriority,
                });
                setConfirmBulkCreateDialog(false);
                setBulkCreatePriority('MEDIUM');
              }}
            >
              <Send className="w-4 h-4 ml-2" />
              ×©×œ×— {selectedMatchIds.length} ×”×¦×¢×•×ª
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Edit Profile Sheet */}
      <MatchmakerEditProfile
        isOpen={!!editProfileCandidate}
        onClose={handleCloseEditProfile}
        candidate={editProfileCandidate}
        dict={matchmakerDict.candidatesManager.editProfile}
        profileDict={profileDict}
        locale={locale}
      />
    </div>
  );
};

export default PotentialMatchesDashboard;
--- End of Content for PotentialMatchesDashboard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\PotentialMatchesFilters.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Filter,
  ChevronDown,
  ChevronUp,
  X,
  User,
  Calendar,
  Scroll,
  Target,
  Zap,
  Brain,
  Sparkles,
  Users,
  Crown,
  Search,
  RotateCcw,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import type { PotentialMatchFilters } from './hooks/usePotentialMatches';

// --- Constants ---
const RELIGIOUS_OPTIONS = [
  { value: 'charedi_litvak', label: '×—×¨×“×™/×ª ×œ×™×˜××™/×ª' },
  { value: 'charedi_hasidic', label: '×—×¨×“×™/×ª ×—×¡×™×“×™/×ª' },
  { value: 'charedi_sephardic', label: '×—×¨×“×™/×ª ×¡×¤×¨×“×™/×ª' },
  { value: 'charedi_modern', label: '×—×¨×“×™/×ª ××•×“×¨× ×™/×ª' },
  { value: 'chabad', label: '×—×‘×´×“' },
  { value: 'breslov', label: '×‘×¨×¡×œ×‘' },
  { value: 'dati_leumi_torani', label: '×“×ª×™/×” ×œ××•××™/×ª ×ª×•×¨× ×™/×ª' },
  { value: 'dati_leumi_standard', label: '×“×ª×™/×” ×œ××•××™/×ª (×¡×˜× ×“×¨×˜×™)' },
  { value: 'dati_leumi_liberal', label: '×“×ª×™/×” ×œ××•××™/×ª ×œ×™×‘×¨×œ×™/×ª' },
  { value: 'masorti_strong', label: '××¡×•×¨×ª×™/×ª (×§×¨×•×‘/×” ×œ×“×ª)' },
  { value: 'masorti_light', label: '××¡×•×¨×ª×™/×ª (×§×©×¨ ×§×œ ×œ××¡×•×¨×ª)' },
  { value: 'secular_traditional_connection', label: '×—×™×œ×•× ×™/×ª ×¢× ×–×™×§×” ×œ××¡×•×¨×ª' },
  { value: 'secular', label: '×—×™×œ×•× ×™/×ª' },
  { value: 'spiritual_not_religious', label: '×¨×•×—× ×™/×ª (×œ××• ×“×•×•×§× ×“×ª×™/×”)' },
  { value: 'other', label: '××—×¨' },
];

const AGE_RANGE = { min: 18, max: 99, default: { min: 18, max: 50 } };

// --- Interfaces ---
interface PotentialMatchesFiltersProps {
  filters: PotentialMatchFilters;
  onFiltersChange: (filters: Partial<PotentialMatchFilters>) => void;
  onReset: () => void;
  className?: string;
}

// --- Sub-Components ---

// Safe Number Input
const SafeNumberInput: React.FC<{
  value: number;
  min: number;
  max: number;
  onCommit: (value: number) => void;
  className?: string;
}> = ({ value, min, max, onCommit, className }) => {
  const [localValue, setLocalValue] = useState<string>(value?.toString() || '');

  React.useEffect(() => {
    setLocalValue(value?.toString() || '');
  }, [value]);

  const handleCommit = () => {
    let num = parseInt(localValue);
    if (isNaN(num)) num = min;
    if (num < min) num = min;
    if (num > max) num = max;
    setLocalValue(num.toString());
    onCommit(num);
  };

  return (
    <input
      type="number"
      value={localValue}
      onChange={(e) => setLocalValue(e.target.value)}
      onBlur={handleCommit}
      onKeyDown={(e) => {
        if (e.key === 'Enter') (e.target as HTMLInputElement).blur();
      }}
      className={className}
    />
  );
};

// Religious Multi-Select
const ReligiousMultiSelect: React.FC<{
  selectedValues: string[];
  onChange: (values: string[]) => void;
  label?: string;
}> = ({ selectedValues = [], onChange, label }) => {
  const [searchTerm, setSearchTerm] = useState('');

  const toggleValue = (value: string) => {
    const newValues = selectedValues.includes(value)
      ? selectedValues.filter((v) => v !== value)
      : [...selectedValues, value];
    onChange(newValues);
  };

  const filteredOptions = RELIGIOUS_OPTIONS.filter((opt) =>
    opt.label.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-sm border border-gray-100 space-y-2">
      {label && <p className="text-sm font-medium text-gray-700 mb-2">{label}</p>}
      <div className="relative">
        <Search className="absolute right-3 top-2.5 h-4 w-4 text-gray-400" />
        <Input
          placeholder="×—×¤×© ×¨××” ×“×ª×™×ª..."
          className="pr-9 bg-white border-gray-200 h-9 text-sm"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
      </div>
      <ScrollArea className="h-36 rounded-md border border-gray-100 bg-white p-2">
        <div className="space-y-1">
          {filteredOptions.map((option) => {
            const isSelected = selectedValues.includes(option.value);
            return (
              <div
                key={option.value}
                onClick={() => toggleValue(option.value)}
                className={cn(
                  'flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-colors text-sm',
                  isSelected
                    ? 'bg-amber-50 text-amber-900'
                    : 'hover:bg-gray-50 text-gray-700'
                )}
              >
                <Checkbox
                  checked={isSelected}
                  onCheckedChange={() => toggleValue(option.value)}
                  className="data-[state=checked]:bg-amber-500 data-[state=checked]:border-amber-500"
                />
                <span className="flex-1">{option.label}</span>
              </div>
            );
          })}
        </div>
      </ScrollArea>
      {selectedValues.length > 0 && (
        <div className="flex flex-wrap gap-1 pt-1">
          {selectedValues.map((val) => {
            const label = RELIGIOUS_OPTIONS.find((o) => o.value === val)?.label;
            return (
              <Badge
                key={val}
                variant="secondary"
                className="text-xs bg-amber-100 text-amber-800 hover:bg-amber-200"
              >
                {label}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    toggleValue(val);
                  }}
                  className="mr-1 hover:text-amber-900"
                >
                  <X className="h-3 w-3" />
                </button>
              </Badge>
            );
          })}
        </div>
      )}
    </div>
  );
};

// Filter Section
const FilterSection: React.FC<{
  title: string;
  icon: React.ReactNode;
  children: React.ReactNode;
  defaultOpen?: boolean;
  badge?: number;
  gradient?: string;
}> = ({ title, icon, children, defaultOpen = false, badge, gradient = 'from-gray-500 to-gray-600' }) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <Collapsible open={isOpen} onOpenChange={setIsOpen}>
      <CollapsibleTrigger asChild>
        <div className="flex items-center justify-between p-3 bg-white/60 rounded-xl cursor-pointer hover:bg-white/80 transition-colors border border-gray-100">
          <div className="flex items-center gap-3">
            <div className={cn('p-2 rounded-lg bg-gradient-to-r text-white', gradient)}>
              {icon}
            </div>
            <span className="font-medium text-gray-700">{title}</span>
            {badge && badge > 0 && (
              <Badge className="bg-red-500 text-white text-xs">{badge}</Badge>
            )}
          </div>
          {isOpen ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
        </div>
      </CollapsibleTrigger>
      <CollapsibleContent>
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="pt-3 pb-1"
        >
          {children}
        </motion.div>
      </CollapsibleContent>
    </Collapsible>
  );
};

// --- Main Component ---
const PotentialMatchesFilters: React.FC<PotentialMatchesFiltersProps> = ({
  filters,
  onFiltersChange,
  onReset,
  className,
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [activeGender, setActiveGender] = useState<'male' | 'female' | 'both'>('both');

  // Count active filters
  const countActiveFilters = () => {
    let count = 0;
    if (filters.gender) count++;
        if (filters.scanMethod) count++; // ğŸ‘ˆ ×”×•×¡×£ ××ª ×”×©×•×¨×” ×”×–×•

    if (filters.maleAgeRange) count++;
    if (filters.femaleAgeRange) count++;
    if (filters.maleReligiousLevel && filters.maleReligiousLevel.length > 0) count++;
    if (filters.femaleReligiousLevel && filters.femaleReligiousLevel.length > 0) count++;
    if (filters.religiousLevel && filters.religiousLevel.length > 0) count++;
    return count;
  };

  const activeCount = countActiveFilters();

  return (
    <Card className={cn('border-0 shadow-lg overflow-hidden', className)}>
      {/* Header */}
      <div
        className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 cursor-pointer hover:from-indigo-100 hover:to-purple-100 transition-colors"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
              <Filter className="w-5 h-5" />
            </div>
            <div>
              <h3 className="font-bold text-gray-800">×¤×™×œ×˜×¨×™× ××ª×§×“××™×</h3>
              <p className="text-sm text-gray-500">×¡× ×Ÿ ×”×¦×¢×•×ª ×œ×¤×™ ××’×“×¨, ×’×™×œ ×•×¨××” ×“×ª×™×ª</p>
            </div>
            {activeCount > 0 && (
              <Badge className="bg-indigo-500 text-white">{activeCount} ×¤×™×œ×˜×¨×™× ×¤×¢×™×œ×™×</Badge>
            )}
          </div>
          <div className="flex items-center gap-2">
            {activeCount > 0 && (
              <Button
                variant="ghost"
                size="sm"
                onClick={(e) => {
                  e.stopPropagation();
                  onReset();
                }}
                className="text-gray-500 hover:text-gray-700"
              >
                <RotateCcw className="w-4 h-4 ml-1" />
                × ×§×”
              </Button>
            )}
            {isExpanded ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
          </div>
        </div>
      </div>

      {/* Content */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="overflow-hidden"
          >
            <div className="p-4 space-y-4 bg-gradient-to-b from-white to-gray-50/50">
                            {/* ğŸ‘‡ ×—×“×©: ×‘×—×™×¨×ª ×©×™×˜×ª ×¡×¨×™×§×” */}
              <div className="bg-white/80 rounded-xl p-4 shadow-sm border border-gray-100">
                <div className="flex items-center gap-2 mb-3">
                  <Sparkles className="w-4 h-4 text-purple-600" />
                  <p className="text-sm font-medium text-gray-700">××§×•×¨ ×”×”×ª×××” (×©×™×˜×ª ×¡×¨×™×§×”)</p>
                </div>
                
                <div className="flex flex-wrap gap-2">
                  {[
                    { value: null, label: '×”×›×œ', icon: null },
                    { value: 'hybrid', label: '×”×™×‘×¨×™×“×™', icon: Users },
                    { value: 'algorithmic', label: 'AI ××ª×§×“×', icon: Brain },
                    { value: 'vector', label: '×“××™×•×Ÿ ××”×™×¨', icon: Zap },
                    { value: 'metrics_v2', label: '××“×“×™× V2', icon: Target },
                  ].map((option) => {
                    const isActive = filters.scanMethod === option.value || (option.value === null && !filters.scanMethod);
                    const Icon = option.icon;
                    
                    return (
                      <Button
                        key={option.label}
                        variant={isActive ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => onFiltersChange({ scanMethod: option.value as any })}
                        className={cn(
                          'rounded-lg text-xs h-8 transition-all',
                          isActive 
                            ? 'bg-purple-600 text-white hover:bg-purple-700 border-purple-600 shadow-md' 
                            : 'bg-white hover:bg-gray-50 text-gray-600 border-gray-200'
                        )}
                      >
                        {Icon && <Icon className="w-3 h-3 ml-1.5 opacity-80" />}
                        {option.label}
                      </Button>
                    );
                  })}
                </div>
              </div>


              {/* Gender Toggle - Show which gender to filter */}
              <div className="bg-white/80 rounded-xl p-4 shadow-sm border border-gray-100">
                <p className="text-sm font-medium text-gray-700 mb-3">×”×¦×’ ×”×¦×¢×•×ª ×¢×:</p>
                <div className="grid grid-cols-3 gap-2">
                  <Button
                    variant={activeGender === 'both' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => {
                      setActiveGender('both');
                      onFiltersChange({ gender: null });
                    }}
                    className={cn(
                      'rounded-xl transition-all',
                      activeGender === 'both' && 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white'
                    )}
                  >
                    ×©× ×™×”×
                  </Button>
                  <Button
                    variant={activeGender === 'male' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => {
                      setActiveGender('male');
                      onFiltersChange({ gender: 'MALE' });
                    }}
                    className={cn(
                      'rounded-xl transition-all',
                      activeGender === 'male' && 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white'
                    )}
                  >
                    <Target className="w-4 h-4 ml-1" />
                    ×‘× ×™× ×‘×œ×‘×“
                  </Button>
                  <Button
                    variant={activeGender === 'female' ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => {
                      setActiveGender('female');
                      onFiltersChange({ gender: 'FEMALE' });
                    }}
                    className={cn(
                      'rounded-xl transition-all',
                      activeGender === 'female' && 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                    )}
                  >
                    <Crown className="w-4 h-4 ml-1" />
                    ×‘× ×•×ª ×‘×œ×‘×“
                  </Button>
                </div>
              </div>

              {/* Separate Filters by Gender */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Male Filters */}
                {(activeGender === 'both' || activeGender === 'male') && (
                  <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-100">
                    <div className="flex items-center gap-2 mb-4">
                      <div className="p-2 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white">
                        <Target className="w-4 h-4" />
                      </div>
                      <h4 className="font-bold text-blue-800">×¤×™×œ×˜×¨×™× ×œ×‘× ×™×</h4>
                    </div>

                    {/* Age Range */}
                    <FilterSection
                      title="×˜×•×•×— ×’×™×œ"
                      icon={<Calendar className="w-4 h-4" />}
                      gradient="from-blue-500 to-cyan-500"
                      badge={filters.maleAgeRange ? 1 : undefined}
                    >
                      <div className="flex items-center gap-3">
                        <div className="flex-1 text-center">
                          <p className="text-xs text-blue-600 mb-1">××™× ×™××•×</p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={filters.maleAgeRange?.min || AGE_RANGE.default.min}
                            onCommit={(val) => {
                              const currentMax = filters.maleAgeRange?.max || AGE_RANGE.default.max;
                              onFiltersChange({
                                maleAgeRange: { min: Math.min(val, currentMax), max: currentMax },
                              });
                            }}
                            className="w-full text-center border rounded-lg p-2 text-lg font-bold text-blue-700"
                          />
                        </div>
                        <span className="text-gray-400">â€”</span>
                        <div className="flex-1 text-center">
                          <p className="text-xs text-blue-600 mb-1">××§×¡×™××•×</p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={filters.maleAgeRange?.max || AGE_RANGE.default.max}
                            onCommit={(val) => {
                              const currentMin = filters.maleAgeRange?.min || AGE_RANGE.default.min;
                              onFiltersChange({
                                maleAgeRange: { min: currentMin, max: Math.max(val, currentMin) },
                              });
                            }}
                            className="w-full text-center border rounded-lg p-2 text-lg font-bold text-blue-700"
                          />
                        </div>
                      </div>
                      {filters.maleAgeRange && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => onFiltersChange({ maleAgeRange: undefined })}
                          className="w-full mt-2 text-gray-500 hover:text-gray-700"
                        >
                          × ×§×” ×¡×™× ×•×Ÿ ×’×™×œ
                        </Button>
                      )}
                    </FilterSection>

                    {/* Religious Level */}
                    <div className="mt-3">
                      <FilterSection
                        title="×¨××” ×“×ª×™×ª"
                        icon={<Scroll className="w-4 h-4" />}
                        gradient="from-blue-500 to-cyan-500"
                        badge={filters.maleReligiousLevel?.length || undefined}
                      >
                        <ReligiousMultiSelect
                          selectedValues={filters.maleReligiousLevel || []}
                          onChange={(values) => onFiltersChange({ maleReligiousLevel: values })}
                        />
                      </FilterSection>
                    </div>
                  </div>
                )}

                {/* Female Filters */}
                {(activeGender === 'both' || activeGender === 'female') && (
                  <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                    <div className="flex items-center gap-2 mb-4">
                      <div className="p-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                        <Crown className="w-4 h-4" />
                      </div>
                      <h4 className="font-bold text-purple-800">×¤×™×œ×˜×¨×™× ×œ×‘× ×•×ª</h4>
                    </div>

                    {/* Age Range */}
                    <FilterSection
                      title="×˜×•×•×— ×’×™×œ"
                      icon={<Calendar className="w-4 h-4" />}
                      gradient="from-purple-500 to-pink-500"
                      badge={filters.femaleAgeRange ? 1 : undefined}
                    >
                      <div className="flex items-center gap-3">
                        <div className="flex-1 text-center">
                          <p className="text-xs text-purple-600 mb-1">××™× ×™××•×</p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={filters.femaleAgeRange?.min || AGE_RANGE.default.min}
                            onCommit={(val) => {
                              const currentMax = filters.femaleAgeRange?.max || AGE_RANGE.default.max;
                              onFiltersChange({
                                femaleAgeRange: { min: Math.min(val, currentMax), max: currentMax },
                              });
                            }}
                            className="w-full text-center border rounded-lg p-2 text-lg font-bold text-purple-700"
                          />
                        </div>
                        <span className="text-gray-400">â€”</span>
                        <div className="flex-1 text-center">
                          <p className="text-xs text-purple-600 mb-1">××§×¡×™××•×</p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={filters.femaleAgeRange?.max || AGE_RANGE.default.max}
                            onCommit={(val) => {
                              const currentMin = filters.femaleAgeRange?.min || AGE_RANGE.default.min;
                              onFiltersChange({
                                femaleAgeRange: { min: currentMin, max: Math.max(val, currentMin) },
                              });
                            }}
                            className="w-full text-center border rounded-lg p-2 text-lg font-bold text-purple-700"
                          />
                        </div>
                      </div>
                      {filters.femaleAgeRange && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => onFiltersChange({ femaleAgeRange: undefined })}
                          className="w-full mt-2 text-gray-500 hover:text-gray-700"
                        >
                          × ×§×” ×¡×™× ×•×Ÿ ×’×™×œ
                        </Button>
                      )}
                    </FilterSection>

                    {/* Religious Level */}
                    <div className="mt-3">
                      <FilterSection
                        title="×¨××” ×“×ª×™×ª"
                        icon={<Scroll className="w-4 h-4" />}
                        gradient="from-purple-500 to-pink-500"
                        badge={filters.femaleReligiousLevel?.length || undefined}
                      >
                        <ReligiousMultiSelect
                          selectedValues={filters.femaleReligiousLevel || []}
                          onChange={(values) => onFiltersChange({ femaleReligiousLevel: values })}
                        />
                      </FilterSection>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </Card>
  );
};

export default PotentialMatchesFilters;
--- End of Content for PotentialMatchesFilters.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\PotentialMatchesStats.tsx
--------------------------------------------------------------------------------
Content:
// =============================================================================
// src/components/matchmaker/PotentialMatches/PotentialMatchesStats.tsx
// ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”×ª×××•×ª ×¤×•×˜× ×¦×™××œ×™×•×ª
// =============================================================================

'use client';

import React from 'react';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import {
  Clock,
  Eye,
  Send,
  X,
  AlertTriangle,
  TrendingUp,
  Star,
  Heart,
  CheckCircle,
  Calendar,
  Timer,
  Sparkles,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';
import type { PotentialMatchesStats as StatsType, LastScanInfo } from './types/potentialMatches';

// =============================================================================
// TYPES
// =============================================================================

interface PotentialMatchesStatsProps {
  stats: StatsType | null;
  lastScanInfo: LastScanInfo | null;
  isScanRunning?: boolean;
  scanProgress?: number;
  className?: string;
}

// =============================================================================
// SUB-COMPONENTS
// =============================================================================

interface StatCardProps {
  icon: React.ElementType;
  label: string;
  value: number | string;
  subValue?: string;
  gradient: string;
  iconColor: string;
  onClick?: () => void;
}

const StatCard: React.FC<StatCardProps> = ({
  icon: Icon,
  label,
  value,
  subValue,
  gradient,
  iconColor,
  onClick,
}) => (
  <Card
    className={cn(
      'relative overflow-hidden p-4 border-0 shadow-lg transition-all duration-300',
      'hover:shadow-xl hover:scale-105 cursor-pointer',
      `bg-gradient-to-br ${gradient}`
    )}
    onClick={onClick}
  >
    {/* Background Pattern */}
    <div className="absolute top-0 right-0 w-20 h-20 opacity-10">
      <svg viewBox="0 0 80 80" fill="currentColor">
        <circle cx="60" cy="20" r="40" />
      </svg>
    </div>

    <div className="relative flex items-start justify-between">
      <div>
        <p className="text-sm font-medium text-gray-600 mb-1">{label}</p>
        <p className="text-3xl font-bold text-gray-800">{value}</p>
        {subValue && (
          <p className="text-xs text-gray-500 mt-1">{subValue}</p>
        )}
      </div>
      <div className={cn(
        'p-3 rounded-xl shadow-lg',
        iconColor
      )}>
        <Icon className="w-6 h-6 text-white" />
      </div>
    </div>
  </Card>
);

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const PotentialMatchesStats: React.FC<PotentialMatchesStatsProps> = ({
  stats,
  lastScanInfo,
  isScanRunning = false,
  scanProgress = 0,
  className,
}) => {
  if (!stats) {
    return (
      <div className={cn('grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4', className)}>
        {[...Array(6)].map((_, i) => (
          <Card key={i} className="p-4 animate-pulse">
            <div className="h-4 w-20 bg-gray-200 rounded mb-2" />
            <div className="h-8 w-16 bg-gray-200 rounded" />
          </Card>
        ))}
      </div>
    );
  }

  return (
    <div className={cn('space-y-6', className)}>
      {/* Main Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <StatCard
          icon={Heart}
          label="×¡×”×´×› ×”×ª×××•×ª"
          value={stats.total}
          gradient="from-pink-50 to-rose-100"
          iconColor="bg-gradient-to-br from-pink-500 to-rose-500"
        />
        
        <StatCard
          icon={Clock}
          label="×××ª×™× ×•×ª"
          value={stats.pending}
          subValue="×˜×¨× × ×‘×“×§×•"
          gradient="from-amber-50 to-yellow-100"
          iconColor="bg-gradient-to-br from-amber-500 to-yellow-500"
        />
        
        <StatCard
          icon={Eye}
          label="× ×‘×“×§×•"
          value={stats.reviewed}
          gradient="from-blue-50 to-cyan-100"
          iconColor="bg-gradient-to-br from-blue-500 to-cyan-500"
        />
        
        <StatCard
          icon={Send}
          label="× ×©×œ×—×• ×”×¦×¢×•×ª"
          value={stats.sent}
          gradient="from-green-50 to-emerald-100"
          iconColor="bg-gradient-to-br from-green-500 to-emerald-500"
        />
        
        <StatCard
          icon={X}
          label="× ×“×—×•"
          value={stats.dismissed}
          gradient="from-gray-50 to-slate-100"
          iconColor="bg-gradient-to-br from-gray-500 to-slate-500"
        />
        
        <StatCard
          icon={AlertTriangle}
          label="×¢× ××–×”×¨×•×ª"
          value={stats.withWarnings}
          subValue="×‘×”×¦×¢×” ×¤×¢×™×œ×”"
          gradient="from-orange-50 to-amber-100"
          iconColor="bg-gradient-to-br from-orange-500 to-amber-500"
        />
      </div>

      {/* Score Distribution & Last Scan */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Score Distribution */}
        <Card className="p-6 border-0 shadow-lg bg-gradient-to-br from-white to-purple-50">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-500">
              <Star className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="font-bold text-gray-800">×”×ª×¤×œ×’×•×ª ×¦×™×•× ×™×</h3>
              <p className="text-sm text-gray-500">×¦×™×•×Ÿ ×××•×¦×¢: {stats.avgScore}</p>
            </div>
          </div>

          <div className="space-y-4">
            {/* High Score (85+) */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm font-medium text-emerald-700 flex items-center gap-1">
                  <Sparkles className="w-4 h-4" />
                  ×¦×™×•×Ÿ ×’×‘×•×” (85+)
                </span>
                <span className="text-sm text-gray-600">{stats.highScore}</span>
              </div>
              <Progress 
                value={(stats.highScore / (stats.total || 1)) * 100} 
                className="h-2 bg-gray-200"
              />
            </div>

            {/* Medium Score (70-85) */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm font-medium text-blue-700 flex items-center gap-1">
                  <TrendingUp className="w-4 h-4" />
                  ×¦×™×•×Ÿ ×‘×™× ×•× ×™ (70-84)
                </span>
                <span className="text-sm text-gray-600">{stats.mediumScore}</span>
              </div>
              <Progress 
                value={(stats.mediumScore / (stats.total || 1)) * 100} 
                className="h-2 bg-gray-200"
              />
            </div>

            {/* Pie visualization */}
            <div className="flex items-center justify-center gap-4 mt-4 pt-4 border-t">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-emerald-500" />
                <span className="text-xs text-gray-600">×’×‘×•×”</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-blue-500" />
                <span className="text-xs text-gray-600">×‘×™× ×•× ×™</span>
              </div>
            </div>
          </div>
        </Card>

        {/* Last Scan Info */}
        <Card className="p-6 border-0 shadow-lg bg-gradient-to-br from-white to-cyan-50">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-500">
              <Calendar className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="font-bold text-gray-800">×¡×¨×™×§×” ××—×¨×•× ×”</h3>
              <p className="text-sm text-gray-500">
                {lastScanInfo ? (
                  formatDistanceToNow(new Date(lastScanInfo.startedAt), { 
                    addSuffix: true, 
                    locale: he 
                  })
                ) : '×œ× ×‘×•×¦×¢×” ×¢×“×™×™×Ÿ'}
              </p>
            </div>
          </div>

          {/* Scan Running Progress */}
          {isScanRunning && (
            <div className="mb-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium text-blue-700 flex items-center gap-2">
                  <Timer className="w-4 h-4 animate-spin" />
                  ×¡×¨×™×§×” ×‘×ª×”×œ×™×š...
                </span>
                <span className="text-sm text-blue-600">{scanProgress}%</span>
              </div>
              <Progress value={scanProgress} className="h-2" />
            </div>
          )}

          {lastScanInfo && !isScanRunning && (
            <div className="space-y-3">
              {/* Status */}
              <div className="flex items-center justify-between p-3 rounded-lg bg-white/60">
                <span className="text-sm text-gray-600">×¡×˜×˜×•×¡</span>
                <Badge className={cn(
                  lastScanInfo.status === 'completed' 
                    ? 'bg-green-100 text-green-700' 
                    : lastScanInfo.status === 'partial'
                    ? 'bg-amber-100 text-amber-700'
                    : 'bg-red-100 text-red-700'
                )}>
                  {lastScanInfo.status === 'completed' ? '×”×•×©×œ×' : 
                   lastScanInfo.status === 'partial' ? '×”×•×©×œ× ×—×œ×§×™×ª' : '× ×›×©×œ'}
                </Badge>
              </div>

              {/* Candidates Scanned */}
              <div className="flex items-center justify-between p-3 rounded-lg bg-white/60">
                <span className="text-sm text-gray-600">××•×¢××“×™× ×©× ×¡×¨×§×•</span>
                <span className="font-medium text-gray-800">
                  {lastScanInfo.candidatesScanned} / {lastScanInfo.totalCandidates}
                </span>
              </div>

              {/* Matches Found */}
              <div className="flex items-center justify-between p-3 rounded-lg bg-white/60">
                <span className="text-sm text-gray-600">×”×ª×××•×ª ×©× ××¦××•</span>
                <span className="font-medium text-gray-800 flex items-center gap-1">
                  <Heart className="w-4 h-4 text-pink-500" />
                  {lastScanInfo.matchesFound}
                </span>
              </div>

              {/* New Matches */}
              <div className="flex items-center justify-between p-3 rounded-lg bg-white/60">
                <span className="text-sm text-gray-600">×”×ª×××•×ª ×—×“×©×•×ª</span>
                <span className="font-medium text-emerald-600 flex items-center gap-1">
                  <CheckCircle className="w-4 h-4" />
                  {lastScanInfo.newMatches}
                </span>
              </div>

              {/* Duration */}
              {lastScanInfo.durationMs && (
                <div className="flex items-center justify-between p-3 rounded-lg bg-white/60">
                  <span className="text-sm text-gray-600">××©×š ×”×¡×¨×™×§×”</span>
                  <span className="font-medium text-gray-800">
                    {Math.round(lastScanInfo.durationMs / 1000 / 60)} ×“×§×•×ª
                  </span>
                </div>
              )}
            </div>
          )}

          {!lastScanInfo && !isScanRunning && (
            <div className="text-center py-8 text-gray-500">
              <Calendar className="w-12 h-12 mx-auto mb-2 opacity-50" />
              <p>×˜×¨× ×‘×•×¦×¢×” ×¡×¨×™×§×”</p>
              <p className="text-sm">×”×¤×¢×œ ×¡×¨×™×§×” ×œ×™×œ×™×ª ×œ××¦×™××ª ×”×ª×××•×ª</p>
            </div>
          )}
        </Card>
      </div>
    </div>
  );
};

export default PotentialMatchesStats;
--- End of Content for PotentialMatchesStats.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\PotentialMatches_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\RejectionFeedbackModal.tsx
--------------------------------------------------------------------------------
Content:
// =============================================================================
// ğŸ“ src/components/matchmaker/new/PotentialMatches/RejectionFeedbackModal.tsx
// =============================================================================
// ğŸ¯ Rejection Feedback Modal V2.2 - NeshamaTech
//
// ××•×“×œ ××”×™×¨ ×œ×ª×™×¢×•×“ ×¡×™×‘×ª ×“×—×™×™×” - ×§×˜×’×•×¨×™×•×ª ×œ×¤× ×™ ×˜×§×¡×˜ ×—×•×¤×©×™
// =============================================================================

'use client';

import React, { useState, useCallback, memo } from 'react';
import { X, Check, ChevronDown, ArrowLeftRight } from 'lucide-react';

// =============================================================================
// TYPES
// =============================================================================

type RejectionCategory =
  | 'AGE_GAP'
  | 'RELIGIOUS_GAP'
  | 'BACKGROUND_GAP'
  | 'EDUCATION_GAP'
  | 'GEOGRAPHIC_GAP'
  | 'KNOWS_PERSONALLY'
  | 'NOT_ATTRACTED'
  | 'NOT_INTERESTING'
  | 'NO_CONNECTION'
  | 'GUT_FEELING'
  | 'SOMETHING_OFF'
  | 'NOT_AVAILABLE_NOW'
  | 'IN_PROCESS_WITH_OTHER'
  | 'NEEDS_TIME'
  | 'EXTERNAL_PRESSURE'
  | 'INCONSISTENT_STORY'
  | 'PROBLEMATIC_BEHAVIOR'
  | 'UNREALISTIC_EXPECTATIONS'
  | 'CONCERNING_HISTORY'
  | 'OTHER';

interface PartyInfo {
  id: string; // User ID
  profileId: string; // Profile ID - ×–×” ××” ×©×”-DB ×¦×¨×™×š!
  firstName: string;
  lastName: string;
  gender?: 'MALE' | 'FEMALE';
}

interface RejectionFeedbackModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: RejectionFeedbackData) => Promise<void>;

  // ×©× ×™ ×”×¦×“×“×™×
  partyA: PartyInfo;
  partyB: PartyInfo;

  // ×‘×¨×™×¨×ª ××—×“×œ - ××™ ×“×—×” (A ××• B)
  defaultRejectingParty?: 'A' | 'B';

  suggestionId?: string;
  potentialMatchId?: string;
}

export interface RejectionFeedbackData {
  rejectedProfileId: string;
  rejectingProfileId: string;
  rejectedUserId: string;
  rejectingUserId: string;
  suggestionId?: string;
  potentialMatchId?: string;
  category: RejectionCategory;
  subcategory?: string;
  freeText?: string;
  wasExpected?: boolean;
}

// =============================================================================
// QUICK CATEGORIES - ××¡×•×“×¨ ×œ×¤×™ ×©×›×™×—×•×ª
// =============================================================================

const QUICK_CATEGORIES: {
  value: RejectionCategory;
  label: string;
  emoji: string;
}[] = [
  { value: 'NOT_ATTRACTED', label: '×œ× ××•×©×š/×ª', emoji: 'ğŸ’”' },
  { value: 'AGE_GAP', label: '×¤×¢×¨ ×’×™×œ', emoji: 'ğŸ“…' },
  { value: 'RELIGIOUS_GAP', label: '×¤×¢×¨ ×“×ª×™', emoji: 'âœ¡ï¸' },
  { value: 'NO_CONNECTION', label: '××™×Ÿ ×—×™×‘×•×¨', emoji: 'ğŸ”—' },
  { value: 'GEOGRAPHIC_GAP', label: '××¨×—×§ ×’×™××•×’×¨×¤×™', emoji: 'ğŸ“' },
  { value: 'KNOWS_PERSONALLY', label: '××›×™×¨/×” ××™×©×™×ª', emoji: 'ğŸ‘‹' },
  { value: 'IN_PROCESS_WITH_OTHER', label: '×‘×ª×”×œ×™×š ××—×¨', emoji: 'â³' },
  { value: 'GUT_FEELING', label: '×ª×—×•×©×ª ×‘×˜×Ÿ', emoji: 'ğŸ¤”' },
  { value: 'BACKGROUND_GAP', label: '×¤×¢×¨ ×¨×§×¢', emoji: 'ğŸ ' },
  { value: 'NOT_AVAILABLE_NOW', label: '×œ× ×–××™×Ÿ/×” ×›×¨×’×¢', emoji: 'ğŸš«' },
  { value: 'OTHER', label: '×¡×™×‘×” ××—×¨×ª', emoji: 'ğŸ“' },
];

// =============================================================================
// COMPONENT
// =============================================================================

function RejectionFeedbackModal({
  isOpen,
  onClose,
  onSubmit,
  partyA,
  partyB,
  defaultRejectingParty = 'A',
  suggestionId,
  potentialMatchId,
}: RejectionFeedbackModalProps) {
  const [rejectingParty, setRejectingParty] = useState<'A' | 'B'>(
    defaultRejectingParty
  );
  const [selectedCategory, setSelectedCategory] =
    useState<RejectionCategory | null>(null);
  const [freeText, setFreeText] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [showAllCategories, setShowAllCategories] = useState(false);

  // ×—×™×©×•×‘ ××™ ×“×•×—×” ×•××™ × ×“×—×”
  const rejectingUser = rejectingParty === 'A' ? partyA : partyB;
  const rejectedUser = rejectingParty === 'A' ? partyB : partyA;

  // Reset state when modal closes
  const handleClose = useCallback(() => {
    setSelectedCategory(null);
    setFreeText('');
    setShowAllCategories(false);
    setRejectingParty(defaultRejectingParty);
    onClose();
  }, [onClose, defaultRejectingParty]);

  // ×”×—×œ×¤×ª ×¦×“×“×™×
  const handleSwapParties = useCallback(() => {
    setRejectingParty((prev) => (prev === 'A' ? 'B' : 'A'));
  }, []);

  // Handle submit
  const handleSubmit = useCallback(async () => {
    if (!selectedCategory && !freeText.trim()) {
      return;
    }

    setSubmitting(true);

    try {
      await onSubmit({
        rejectedProfileId: rejectedUser.profileId,
        rejectingProfileId: rejectingUser.profileId,
        rejectedUserId: rejectedUser.id,
        rejectingUserId: rejectingUser.id,
        suggestionId,
        potentialMatchId,
        category: selectedCategory || 'OTHER',
        freeText: freeText.trim() || undefined,
      });

      handleClose();
    } catch (err) {
      console.error('Failed to submit rejection feedback:', err);
    } finally {
      setSubmitting(false);
    }
  }, [
    selectedCategory,
    freeText,
    rejectedUser,
    rejectingUser,
    suggestionId,
    potentialMatchId,
    onSubmit,
    handleClose,
  ]);

  if (!isOpen) return null;

  const visibleCategories = showAllCategories
    ? QUICK_CATEGORIES
    : QUICK_CATEGORIES.slice(0, 6);

  const canSubmit = selectedCategory || freeText.trim().length > 0;

  // ×ª×•×•×™×•×ª ×œ×¤×™ ××’×“×¨
  const getGenderVerb = (gender?: 'MALE' | 'FEMALE') => {
    if (gender === 'MALE') return '×××¨';
    if (gender === 'FEMALE') return '×××¨×”';
    return '×××¨/×”';
  };

  const getAboutLabel = (rejectedGender?: 'MALE' | 'FEMALE') => {
    if (rejectedGender === 'MALE') return '×¢×œ×™×•';
    if (rejectedGender === 'FEMALE') return '×¢×œ×™×”';
    return '×¢×œ×™×•/×”';
  };

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black/50 z-50 animate-in fade-in duration-150"
        onClick={handleClose}
      />

      {/* Modal */}
      <div
        className="fixed inset-4 max-h-[calc(100vh-32px)] md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[500px] md:max-h-[85vh] bg-white rounded-2xl shadow-2xl z-50 flex flex-col animate-in zoom-in-95 duration-200"
        dir="rtl"
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b flex-shrink-0">
          <div>
            <h2 className="text-lg font-bold text-gray-800">
              ×ª×™×¢×•×“ ×¡×™×‘×ª ×“×—×™×™×”
            </h2>
          </div>
          <button
            onClick={handleClose}
            className="p-2 hover:bg-gray-100 rounded-full transition-colors"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4 space-y-5 min-h-0">
          {/* Party Selector - ××™ ×“×—×” ××ª ××™ */}
          <div className="space-y-2">
            <label className="text-sm font-semibold text-gray-700">
              ××™ ×“×—×” ××ª ××™?
            </label>

            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
              {/* Rejecting party */}
              <div className="flex-1 p-3 rounded-lg text-center bg-red-50 border-2 border-red-200">
                <div className="text-2xl mb-1">
                  {rejectingUser.gender === 'MALE' ? 'ğŸ‘¨' : 'ğŸ‘©'}
                </div>
                <div className="font-bold text-gray-800 text-sm truncate">
                  {rejectingUser.firstName}
                </div>
                <div className="text-xs text-red-600 font-medium">×“×—×”/×ª×”</div>
              </div>

              {/* Swap button */}
              <button
                onClick={handleSwapParties}
                className="p-2.5 bg-white rounded-full shadow-md hover:shadow-lg transition-all hover:scale-110 active:scale-95 border border-gray-200"
                title="×”×—×œ×£ ×¦×“×“×™×"
              >
                <ArrowLeftRight size={18} className="text-gray-600" />
              </button>

              {/* Rejected party */}
              <div className="flex-1 p-3 rounded-lg text-center bg-blue-50 border-2 border-blue-200">
                <div className="text-2xl mb-1">
                  {rejectedUser.gender === 'MALE' ? 'ğŸ‘¨' : 'ğŸ‘©'}
                </div>
                <div className="font-bold text-gray-800 text-sm truncate">
                  {rejectedUser.firstName}
                </div>
                <div className="text-xs text-blue-600 font-medium">× ×“×—×”/×ª×”</div>
              </div>
            </div>
          </div>

          {/* Quick Categories - ×¨××©×•×Ÿ! */}
          <div className="space-y-2">
            <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
              <span className="text-lg">ğŸ·ï¸</span>
              ×¡×™×‘×ª ×”×“×—×™×™×”
            </label>

            <div className="flex flex-wrap gap-2">
              {visibleCategories.map((cat) => (
                <button
                  key={cat.value}
                  onClick={() =>
                    setSelectedCategory(
                      selectedCategory === cat.value ? null : cat.value
                    )
                  }
                  className={`
                    px-3 py-2 rounded-full text-sm font-medium transition-all
                    ${
                      selectedCategory === cat.value
                        ? 'bg-primary text-white shadow-md scale-105'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:scale-95'
                    }
                  `}
                >
                  <span className="ml-1">{cat.emoji}</span>
                  {cat.label}
                </button>
              ))}
            </div>

            {!showAllCategories && (
              <button
                onClick={() => setShowAllCategories(true)}
                className="text-sm text-primary hover:underline flex items-center gap-1 mt-1"
              >
                <ChevronDown size={14} />
                ×¢×•×“ ××¤×©×¨×•×™×•×ª
              </button>
            )}
          </div>

          {/* Free Text - ××—×¨×™ ×”×§×˜×’×•×¨×™×•×ª */}
          <div className="space-y-2">
            <label className="text-sm font-semibold text-gray-700 flex items-center gap-2">
              <span className="text-lg">ğŸ’¬</span>
              ××” {rejectingUser.firstName} {getGenderVerb(rejectingUser.gender)}{' '}
              {getAboutLabel(rejectedUser.gender)}? (××•×¤×¦×™×•× ×œ×™)
            </label>
            <textarea
              value={freeText}
              onChange={(e) => setFreeText(e.target.value)}
              placeholder={`"×œ× ××¨×’×™×© ×œ×™ ××ª××™× ×›×™..."\n"××©×”×• ×‘×ª××•× ×•×ª ×œ× ×“×™×‘×¨ ××œ×™×™..."`}
              rows={3}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm resize-none focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all placeholder:text-gray-400"
            />
          </div>
        </div>

        {/* Footer */}
        <div className="p-4 border-t bg-gray-50 flex gap-3 flex-shrink-0">
          <button
            onClick={handleClose}
            className="flex-1 py-3 px-4 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-100 transition-colors active:scale-98"
          >
            ×‘×™×˜×•×œ
          </button>
          <button
            onClick={handleSubmit}
            disabled={!canSubmit || submitting}
            className="flex-1 py-3 px-4 bg-primary text-white rounded-xl font-medium hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-98 flex items-center justify-center gap-2"
          >
            {submitting ? (
              <>
                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                ×©×•××¨...
              </>
            ) : (
              <>
                <Check size={18} />
                ×©××•×¨ ×•×“×—×”
              </>
            )}
          </button>
        </div>
      </div>
    </>
  );
}

export default memo(RejectionFeedbackModal);

// =============================================================================
// HOOK FOR EASY USAGE
// =============================================================================

export function useRejectionFeedback() {
  const [isOpen, setIsOpen] = useState(false);
  const [context, setContext] = useState<{
    partyA: PartyInfo;
    partyB: PartyInfo;
    defaultRejectingParty?: 'A' | 'B';
    suggestionId?: string;
    potentialMatchId?: string;
  } | null>(null);

  const open = useCallback((data: NonNullable<typeof context>) => {
    setContext(data);
    setIsOpen(true);
  }, []);

  const close = useCallback(() => {
    setIsOpen(false);
    setTimeout(() => setContext(null), 200);
  }, []);

  const submit = useCallback(async (data: RejectionFeedbackData) => {
    const response = await fetch('/api/matchmaker/rejection-feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        // ×©×œ×™×—×ª Profile IDs - ×–×” ××” ×©×”-DB ×¦×¨×™×š!
        rejectedUserId: data.rejectedProfileId,
        rejectingUserId: data.rejectingProfileId,
        suggestionId: data.suggestionId,
        potentialMatchId: data.potentialMatchId,
        category: data.category,
        freeText: data.freeText,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to save rejection feedback');
    }

    return response.json();
  }, []);

  return {
    isOpen,
    context,
    open,
    close,
    submit,
  };
}
--- End of Content for RejectionFeedbackModal.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\index.ts
--------------------------------------------------------------------------------
Content:
// =============================================================================
// src/components/matchmaker/PotentialMatches/index.ts
// Export file for PotentialMatches components
// =============================================================================

// Main Dashboard Component
export { default as PotentialMatchesDashboard } from './PotentialMatchesDashboard';
export { default } from './PotentialMatchesDashboard';

// Sub-components
export { default as PotentialMatchCard } from './PotentialMatchCard';
export { default as PotentialMatchesStats } from './PotentialMatchesStats';

// Hooks
export { usePotentialMatches } from './hooks/usePotentialMatches';

// Re-export types
export type {
  PotentialMatch,
  PotentialMatchesResponse,
  LastScanInfo,
  PotentialMatchFilters,
  PotentialMatchSortBy,
  PotentialMatchFilterStatus,
  PotentialMatchAction,
  BatchScanResponse,
  BatchScanProgress,
  ScoreBreakdown,
  CandidateBasicInfo,
  ActiveSuggestionInfo,
} from './types/potentialMatches';
--- End of Content for index.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\hooks\useHiddenCandidates.ts
--------------------------------------------------------------------------------
Content:
// src/hooks/useHiddenCandidates.ts

import { useState, useEffect, useCallback } from 'react';
import { toast } from 'sonner';

// =============================================================================
// TYPES
// =============================================================================

export interface HiddenCandidateInfo {
  id: string; // ID ×©×œ ×¨×©×•××ª ×”×”×¡×ª×¨×”
  candidateId: string;
  reason: string | null;
  hiddenAt: string;
  candidate: {
    id: string;
    firstName: string;
    lastName: string;
    phone: string | null;
    mainImage: string | null;
    gender: 'MALE' | 'FEMALE' | null;
    city: string | null;
    religiousLevel: string | null;
    availabilityStatus: string | null;
  };
}

interface UseHiddenCandidatesReturn {
  // State
  hiddenCandidates: HiddenCandidateInfo[];
  hiddenCandidateIds: Set<string>;
  isLoading: boolean;
  error: string | null;
  
  // Actions
  hideCandidate: (candidateId: string, reason?: string) => Promise<boolean>;
  unhideCandidate: (hiddenRecordId: string) => Promise<boolean>;
  updateReason: (hiddenRecordId: string, reason: string) => Promise<boolean>;
  refreshHiddenCandidates: () => Promise<void>;
  
  // Helpers
  isHidden: (candidateId: string) => boolean;
  getHiddenRecord: (candidateId: string) => HiddenCandidateInfo | undefined;
}

// =============================================================================
// HOOK
// =============================================================================

export function useHiddenCandidates(): UseHiddenCandidatesReturn {
  const [hiddenCandidates, setHiddenCandidates] = useState<HiddenCandidateInfo[]>([]);
  const [hiddenCandidateIds, setHiddenCandidateIds] = useState<Set<string>>(new Set());
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // =============================================================================
  // FETCH HIDDEN CANDIDATES
  // =============================================================================
  const refreshHiddenCandidates = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      const response = await fetch('/api/matchmaker/hidden-candidates');
      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to fetch hidden candidates');
      }

      setHiddenCandidates(data.hiddenCandidates);
      setHiddenCandidateIds(new Set(data.hiddenCandidates.map((hc: HiddenCandidateInfo) => hc.candidateId)));

    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      setError(errorMessage);
      console.error('Error fetching hidden candidates:', err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Initial fetch
  useEffect(() => {
    refreshHiddenCandidates();
  }, [refreshHiddenCandidates]);

  // =============================================================================
  // HIDE CANDIDATE
  // =============================================================================
  const hideCandidate = useCallback(async (candidateId: string, reason?: string): Promise<boolean> => {
    try {
      const response = await fetch('/api/matchmaker/hidden-candidates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ candidateId, reason }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to hide candidate');
      }

      // Optimistic update
      setHiddenCandidateIds(prev => new Set([...prev, candidateId]));
      
      // Refresh full list
      await refreshHiddenCandidates();

      toast.success(data.message || '×”××•×¢××“ ×”×•×¡×ª×¨ ×‘×”×¦×œ×—×”');
      return true;

    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      toast.error(`×©×’×™××” ×‘×”×¡×ª×¨×ª ×”××•×¢××“: ${errorMessage}`);
      console.error('Error hiding candidate:', err);
      return false;
    }
  }, [refreshHiddenCandidates]);

  // =============================================================================
  // UNHIDE CANDIDATE
  // =============================================================================
  const unhideCandidate = useCallback(async (hiddenRecordId: string): Promise<boolean> => {
    try {
      // Find the candidate ID before deletion for optimistic update
      const record = hiddenCandidates.find(hc => hc.id === hiddenRecordId);
      const candidateId = record?.candidateId;

      const response = await fetch(`/api/matchmaker/hidden-candidates/${hiddenRecordId}`, {
        method: 'DELETE',
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to unhide candidate');
      }

      // Optimistic update
      if (candidateId) {
        setHiddenCandidateIds(prev => {
          const newSet = new Set(prev);
          newSet.delete(candidateId);
          return newSet;
        });
        setHiddenCandidates(prev => prev.filter(hc => hc.id !== hiddenRecordId));
      }

      toast.success(data.message || '×”××•×¢××“ ×”×•×—×–×¨ ×œ×¨×©×™××”');
      return true;

    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      toast.error(`×©×’×™××” ×‘×”×—×–×¨×ª ×”××•×¢××“: ${errorMessage}`);
      console.error('Error unhiding candidate:', err);
      return false;
    }
  }, [hiddenCandidates]);

  // =============================================================================
  // UPDATE REASON
  // =============================================================================
  const updateReason = useCallback(async (hiddenRecordId: string, reason: string): Promise<boolean> => {
    try {
      const response = await fetch(`/api/matchmaker/hidden-candidates/${hiddenRecordId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to update reason');
      }

      // Update local state
      setHiddenCandidates(prev => 
        prev.map(hc => 
          hc.id === hiddenRecordId 
            ? { ...hc, reason } 
            : hc
        )
      );

      toast.success('×”×¡×™×‘×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
      return true;

    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      toast.error(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×™×‘×”: ${errorMessage}`);
      console.error('Error updating reason:', err);
      return false;
    }
  }, []);

  // =============================================================================
  // HELPERS
  // =============================================================================
  const isHidden = useCallback((candidateId: string): boolean => {
    return hiddenCandidateIds.has(candidateId);
  }, [hiddenCandidateIds]);

  const getHiddenRecord = useCallback((candidateId: string): HiddenCandidateInfo | undefined => {
    return hiddenCandidates.find(hc => hc.candidateId === candidateId);
  }, [hiddenCandidates]);

  // =============================================================================
  // RETURN
  // =============================================================================
  return {
    hiddenCandidates,
    hiddenCandidateIds,
    isLoading,
    error,
    hideCandidate,
    unhideCandidate,
    updateReason,
    refreshHiddenCandidates,
    isHidden,
    getHiddenRecord,
  };
}

export default useHiddenCandidates;
--- End of Content for useHiddenCandidates.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\hooks\usePotentialMatches.ts
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/PotentialMatches/hooks/usePotentialMatches.ts
// ğŸ†• V2.3: Added active scan detection on page load

import { useState, useEffect, useCallback, useRef } from 'react';
import { toast } from 'sonner';

// =============================================================================
// TYPES
// =============================================================================

export interface PotentialMatch {
  id: string;
  maleUserId: string;
  femaleUserId: string;
  aiScore: number;
  scoreForMale?: number | null;
  scoreForFemale?: number | null;
  shortReasoning?: string | null;
  status: 'PENDING' | 'REVIEWED' | 'SHORTLISTED' | 'SENT' | 'DECLINED';
  scannedAt: Date;
  hasWarning?: boolean;
  male: {
    id: string;
    firstName: string;
    lastName: string;
    profile?: any;
    images?: Array<{ url: string; isMain: boolean }>;
  };
  female: {
    id: string;
    firstName: string;
    lastName: string;
    profile?: any;
    images?: Array<{ url: string; isMain: boolean }>;
  };
}

export interface PotentialMatchesStats {
  total: number;
  pending: number;
  reviewed: number;
  shortlisted: number;
  sent: number;
  declined: number;
}

export interface LastScanInfo {
  date: Date;
  matchCount: number;
  durationMs: number;
}

export type PotentialMatchSortBy = 'score_desc' | 'score_asc' | 'date_desc' | 'date_asc';

export interface PotentialMatchFilters {
  searchTerm?: string;
  status: string;
  minScore: number;
  maxScore: number;
  religiousLevel: string | null;
  city: string | null;
  hasWarning: boolean | null;
  scannedAfter: Date | null;
  sortBy: PotentialMatchSortBy;
  gender?: 'MALE' | 'FEMALE' | null;
  maleAgeRange?: { min: number; max: number };
  femaleAgeRange?: { min: number; max: number };
  maleReligiousLevel?: string[];
  femaleReligiousLevel?: string[];
  scanMethod: string | null;
}

export interface ScanProgress {
  phase: string;
  method?: 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2';
  currentUserIndex: number;
  totalUsers: number;
  currentUserName?: string;
  progressPercent: number;
  pairsEvaluated: number;
  pairsPassedQuickFilter: number;
  pairsPassedVectorFilter: number;
  pairsSentToAi: number;
  matchesFoundSoFar: number;
  // ğŸ†• V2.3: New fields
  newMatchesFoundSoFar?: number;
  usersScanned?: number;
  preparationStats?: {
    totalNeedingUpdate: number;
    currentIndex: number;
    currentUserName: string;
    updated: number;
    failed: number;
    skipped: number;              // ğŸ†•
    currentStep: 'checking' | 'ai_summary' | 'metrics' | 'vectors' | 'done';  // ğŸ†•
    aiCallsMade: number;          // ğŸ†•
    embeddingCallsMade: number;   // ğŸ†•
  };

  scanId: string;
  status: 'running' | 'completed' | 'failed' | 'partial' | 'cancelled' | 'resuming';
  message?: string;
  error?: string | null;
}

export interface ScanResult {
  matchesFound: number;
  newMatches: number;
  updatedMatches: number;
  durationMs: number;
}

interface ScanOptions {
  useStreaming?: boolean;
  action?: 'full_scan' | 'scan_new_users' | 'scan_single';
  method?: 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2';
  forceRefresh?: boolean;
  incremental?: boolean;
  userId?: string;
  userIds?: string[];
  skipPreparation?: boolean;
}

interface UsePotentialMatchesReturn {
  matches: PotentialMatch[];
  stats: PotentialMatchesStats | null;
  lastScanInfo: LastScanInfo | null;
  pagination: {
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  };
  isLoading: boolean;
  isRefreshing: boolean;
  isActioning: boolean;
  isScanning: boolean;
  scanProgress: ScanProgress | null;
  scanResult: ScanResult | null;
  filters: PotentialMatchFilters;
  setFilters: (filters: Partial<PotentialMatchFilters>) => void;
  resetFilters: () => void;
  setPage: (page: number) => void;
  setPageSize: (size: number) => void;
  refresh: () => Promise<void>;
  reviewMatch: (matchId: string) => Promise<boolean>;
  dismissMatch: (matchId: string, reason?: string) => Promise<boolean>;
  restoreMatch: (matchId: string) => Promise<boolean>;
  saveMatch: (matchId: string) => Promise<boolean>;
  createSuggestion: (matchId: string, data?: {
    priority?: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
    firstPartyNotes?: string;
    secondPartyNotes?: string;
    matchingReason?: string;
    suppressNotifications?: boolean;
    swapParties?: boolean;
  }) => Promise<string | null>;
  bulkDismiss: (matchIds: string[], reason?: string) => Promise<number>;
  bulkReview: (matchIds: string[]) => Promise<number>;
  bulkRestore: (matchIds: string[]) => Promise<number>;
  bulkCreateSuggestions: (matchIds: string[], options?: {
    priority?: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
    suppressNotifications?: boolean;
  }) => Promise<{ success: number; failed: number; suggestionIds: string[] }>;
  startScan: (options?: ScanOptions) => Promise<string | null>;
  cancelScan: () => Promise<boolean>;
  selectedMatchIds: string[];
  toggleSelection: (matchId: string) => void;
  selectAll: () => void;
  clearSelection: () => void;
  isSelected: (matchId: string) => boolean;
  error: string | null;
  // ğŸ†• V2.3: New property to indicate if we're reconnecting to an existing scan
  isReconnecting: boolean;
}

// =============================================================================
// CONSTANTS & DEFAULTS
// =============================================================================

const API_BASE_SCAN = '/api/ai/batch-scan-all';
const API_BASE_MATCHES = '/api/matchmaker/potential-matches';
const POLLING_INTERVAL = 3000;

const DEFAULT_FILTERS: PotentialMatchFilters = {
  status: 'pending',
  minScore: 70,
  maxScore: 100,
  religiousLevel: null,
  city: null,
  hasWarning: null,
  scannedAfter: null,
  sortBy: 'score_desc',
  gender: null,
  scanMethod: null,
  maleAgeRange: undefined,
  femaleAgeRange: undefined,
  maleReligiousLevel: [],
  femaleReligiousLevel: [],
};

const DEFAULT_PAGINATION = {
  total: 0,
  page: 1,
  pageSize: 20,
  totalPages: 0,
};

// =============================================================================
// HOOK IMPLEMENTATION
// =============================================================================

export function usePotentialMatches(options: {
  initialFilters?: Partial<PotentialMatchFilters>;
  autoRefresh?: boolean;
  refreshInterval?: number;
} = {}): UsePotentialMatchesReturn {
  const {
    initialFilters = {},
    autoRefresh = false,
    refreshInterval = 30000,
  } = options;

  // --- State: Data & UI ---
  const [matches, setMatches] = useState<PotentialMatch[]>([]);
  const [stats, setStats] = useState<PotentialMatchesStats | null>(null);
  const [lastScanInfo, setLastScanInfo] = useState<LastScanInfo | null>(null);
  const [pagination, setPagination] = useState(DEFAULT_PAGINATION);
  const [filters, setFiltersState] = useState<PotentialMatchFilters>({
    ...DEFAULT_FILTERS,
    ...initialFilters,
  });
  const [selectedMatchIds, setSelectedMatchIds] = useState<string[]>([]);
  const [error, setError] = useState<string | null>(null);

  // --- State: Loading ---
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [isActioning, setIsActioning] = useState(false);

  // --- State: Scanning ---
  const [isScanning, setIsScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState<ScanProgress | null>(null);
  const [scanResult, setScanResult] = useState<ScanResult | null>(null);
  const [activeScanId, setActiveScanId] = useState<string | null>(null);
  
  // ğŸ†• V2.3: State for reconnection
  const [isReconnecting, setIsReconnecting] = useState(false);
  const [hasCheckedForActiveScan, setHasCheckedForActiveScan] = useState(false);

  // --- Refs ---
  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const eventSourceRef = useRef<EventSource | null>(null);
  const lastFiltersRef = useRef<PotentialMatchFilters>(filters);

  useEffect(() => {
    lastFiltersRef.current = filters;
  }, [filters]);

  useEffect(() => {
    return () => {
      if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
      if (eventSourceRef.current) eventSourceRef.current.close();
    };
  }, []);

  // ==========================================================================
  // ğŸ†• V2.3: CHECK FOR ACTIVE SCAN ON PAGE LOAD
  // ==========================================================================
  
  const checkForActiveScan = useCallback(async () => {
    if (hasCheckedForActiveScan) return;
    
    try {
      setIsReconnecting(true);
      console.log('[usePotentialMatches] Checking for active scan...');
      
      const response = await fetch(`${API_BASE_SCAN}?checkActive=true`);
      const data = await response.json();
      
      if (data.success && data.hasActiveScan && data.scan) {
        console.log('[usePotentialMatches] Found active scan:', data.scan.id);
        
        // Set scanning state
        setIsScanning(true);
        setActiveScanId(data.scan.id);
        
        // Update progress from existing scan
        setScanProgress({
          phase: data.scan.phase || 'scanning',
          method: data.scan.method,
          currentUserIndex: data.scan.currentUserIndex || 0,
          totalUsers: data.scan.totalUsers || 0,
          currentUserName: data.scan.currentUserName,
          progressPercent: data.scan.progressPercent || 0,
          pairsEvaluated: data.scan.usersScanned || 0,
          pairsPassedQuickFilter: 0,
          pairsPassedVectorFilter: 0,
          pairsSentToAi: 0,
          matchesFoundSoFar: data.scan.matchesFoundSoFar || 0,
          newMatchesFoundSoFar: data.scan.newMatchesFoundSoFar || 0,
          usersScanned: data.scan.usersScanned || 0,
          preparationStats: data.scan.preparationStats,
          scanId: data.scan.id,
          status: 'running',
          message: data.scan.message || '××ª×—×‘×¨ ×œ×¡×¨×™×§×” ×¤×¢×™×œ×”...',
        });
        
        // Start polling
        startPolling(data.scan.id);
        
        toast.info('××ª×—×‘×¨ ×œ×¡×¨×™×§×” ×¤×¢×™×œ×”...', {
          description: `× ××¦××” ×¡×¨×™×§×” ×©×¨×¦×” ×‘×¨×§×¢`,
        });
      } else {
        console.log('[usePotentialMatches] No active scan found');
      }
    } catch (err) {
      console.error('[usePotentialMatches] Error checking for active scan:', err);
    } finally {
      setIsReconnecting(false);
      setHasCheckedForActiveScan(true);
    }
  }, [hasCheckedForActiveScan]);

  // Check for active scan on mount
  useEffect(() => {
    checkForActiveScan();
  }, [checkForActiveScan]);

  // ==========================================================================
  // FETCH DATA
  // ==========================================================================
  
  const fetchMatches = useCallback(async (showLoadingState = true) => {
    if (showLoadingState) setIsLoading(true);
    else setIsRefreshing(true);
    
    setError(null);

    try {
      const params = new URLSearchParams();
      params.set('page', String(pagination.page));
      params.set('pageSize', String(pagination.pageSize));
      
      if (filters.searchTerm) params.set('searchTerm', filters.searchTerm);
      params.set('status', filters.status);
      params.set('minScore', String(filters.minScore));
      params.set('maxScore', String(filters.maxScore));
      params.set('sortBy', filters.sortBy);
      if (filters.scanMethod) {
        params.set('lastScanMethod', filters.scanMethod);
      }
      if (filters.hasWarning !== null) params.set('hasWarning', String(filters.hasWarning));
      if (filters.religiousLevel) params.set('religiousLevel', filters.religiousLevel);
      if (filters.city) params.set('city', filters.city);
      if (filters.maleAgeRange) {
        params.set('maleAgeMin', String(filters.maleAgeRange.min));
        params.set('maleAgeMax', String(filters.maleAgeRange.max));
      }
      if (filters.femaleAgeRange) {
        params.set('femaleAgeMin', String(filters.femaleAgeRange.min));
        params.set('femaleAgeMax', String(filters.femaleAgeRange.max));
      }
      if (filters.maleReligiousLevel && filters.maleReligiousLevel.length > 0) {
        params.set('maleReligiousLevel', filters.maleReligiousLevel.join(','));
      }
      if (filters.femaleReligiousLevel && filters.femaleReligiousLevel.length > 0) {
        params.set('femaleReligiousLevel', filters.femaleReligiousLevel.join(','));
      }
      
      const response = await fetch(`${API_BASE_MATCHES}?${params.toString()}`);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to fetch matches');
      }

      setMatches(data.matches);
      setStats(data.stats);
      setLastScanInfo(data.lastScanInfo);
      setPagination(data.pagination);

    } catch (err) {
      const message = err instanceof Error ? err.message : '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×ª×××•×ª';
      setError(message);
      if (showLoadingState) toast.error(message);
    } finally {
      setIsLoading(false);
      setIsRefreshing(false);
    }
  }, [filters, pagination.page, pagination.pageSize]);

  useEffect(() => {
    fetchMatches(true);
  }, [fetchMatches]);

  useEffect(() => {
    if (!autoRefresh) return;
    const interval = setInterval(() => {
      fetchMatches(false);
    }, refreshInterval);
    return () => clearInterval(interval);
  }, [autoRefresh, refreshInterval, fetchMatches]);

  // ==========================================================================
  // FILTERS & PAGINATION
  // ==========================================================================
  
  const setFilters = useCallback((newFilters: Partial<PotentialMatchFilters>) => {
    setFiltersState(prev => ({ ...prev, ...newFilters }));
    setPagination(prev => ({ ...prev, page: 1 }));
  }, []);

  const resetFilters = useCallback(() => {
    setFiltersState(DEFAULT_FILTERS);
    setPagination(prev => ({ ...prev, page: 1 }));
  }, []);

  const setPage = useCallback((page: number) => {
    setPagination(prev => ({ ...prev, page }));
  }, []);

  const setPageSize = useCallback((pageSize: number) => {
    setPagination(prev => ({ ...prev, pageSize, page: 1 }));
  }, []);

  // ==========================================================================
  // SINGLE ACTIONS
  // ==========================================================================
  
  const performAction = useCallback(async (
    matchId: string,
    action: string,
    additionalData?: any
  ): Promise<boolean> => {
    setIsActioning(true);
    try {
      const response = await fetch(API_BASE_MATCHES, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ matchId, action, ...additionalData }),
      });

      const data = await response.json();

      if (!data.success) throw new Error(data.error || 'Action failed');

      setMatches(prev => {
        if (action === 'dismiss') return prev.filter(m => m.id !== matchId);
        
        const statusMap: Record<string, any> = {
          'review': 'REVIEWED',
          'restore': 'PENDING',
          'save': 'SHORTLISTED',
          'create_suggestion': 'SENT'
        };

        if (statusMap[action]) {
          return prev.map(m => m.id === matchId ? { ...m, status: statusMap[action] } : m);
        }
        return prev;
      });

      if (action === 'dismiss') {
        setSelectedMatchIds(prev => prev.filter(id => id !== matchId));
      }

      return true;
    } catch (err) {
      const message = err instanceof Error ? err.message : '×”×¤×¢×•×œ×” × ×›×©×œ×”';
      toast.error(message);
      return false;
    } finally {
      setIsActioning(false);
    }
  }, []);

  const reviewMatch = (id: string) => performAction(id, 'review');
  
  const dismissMatch = async (id: string, reason?: string) => {
    const success = await performAction(id, 'dismiss', { reason });
    if (success) toast.success('×”×”×ª×××” × ×“×—×ª×”');
    return success;
  };
  
  const restoreMatch = async (id: string) => {
    const success = await performAction(id, 'restore');
    if (success) toast.success('×”×”×ª×××” ×©×•×—×–×¨×”');
    return success;
  };
  
  const saveMatch = async (id: string) => {
    const success = await performAction(id, 'save');
    if (success) toast.success('×”×”×ª×××” × ×©××¨×”');
    return success;
  };

  const createSuggestion = useCallback(async (matchId: string, data?: {
    priority?: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
    firstPartyNotes?: string;
    secondPartyNotes?: string;
    matchingReason?: string;
    suppressNotifications?: boolean;
    swapParties?: boolean; 
  }) => {
    setIsActioning(true);
    try {
      const response = await fetch(API_BASE_MATCHES, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          matchId, 
          action: 'create_suggestion', 
          ...data 
        }),
      });
      const result = await response.json();
      
      if (!result.success) throw new Error(result.error);
      
      setMatches(prev => prev.map(m => m.id === matchId ? { ...m, status: 'SENT' } : m));
      toast.success('×”×¦×¢×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
      return result.suggestionId;
    } catch (err) {
      toast.error(err instanceof Error ? err.message : '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¦×¢×”');
      return null;
    } finally {
      setIsActioning(false);
    }
  }, []);

  // ==========================================================================
  // BULK ACTIONS
  // ==========================================================================
  
  const performBulkAction = useCallback(async (
    matchIds: string[],
    action: 'dismiss' | 'review' | 'restore',
    reason?: string
  ): Promise<number> => {
    if (matchIds.length === 0) return 0;
    setIsActioning(true);

    try {
      const response = await fetch(API_BASE_MATCHES, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ matchIds, action, reason }),
      });

      const data = await response.json();
      if (!data.success) throw new Error(data.error);

      await fetchMatches(false);
      setSelectedMatchIds([]);
      return data.processed;
    } catch (err) {
      toast.error(err instanceof Error ? err.message : '×¤×¢×•×œ×” ××¨×•×‘×” × ×›×©×œ×”');
      return 0;
    } finally {
      setIsActioning(false);
    }
  }, [fetchMatches]);

  const bulkDismiss = (ids: string[], reason?: string) => performBulkAction(ids, 'dismiss', reason).then(c => { if(c) toast.success(`${c} ×”×ª×××•×ª × ×“×—×•`); return c; });
  const bulkReview = (ids: string[]) => performBulkAction(ids, 'review').then(c => { if(c) toast.success(`${c} ×”×ª×××•×ª ×¡×•×× ×•`); return c; });
  const bulkRestore = (ids: string[]) => performBulkAction(ids, 'restore').then(c => { if(c) toast.success(`${c} ×”×ª×××•×ª ×©×•×—×–×¨×•`); return c; });

  const bulkCreateSuggestions = useCallback(async (
    matchIds: string[],
    options?: {
      priority?: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
      suppressNotifications?: boolean;
    }
  ): Promise<{ success: number; failed: number; suggestionIds: string[] }> => {
    if (matchIds.length === 0) {
      return { success: 0, failed: 0, suggestionIds: [] };
    }

    setIsActioning(true);
    const results = { success: 0, failed: 0, suggestionIds: [] as string[] };

    try {
      const chunkSize = 5;
      
      for (let i = 0; i < matchIds.length; i += chunkSize) {
        const chunk = matchIds.slice(i, i + chunkSize);
        
        const promises = chunk.map(async (matchId) => {
          try {
            const response = await fetch(API_BASE_MATCHES, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                matchId,
                action: 'create_suggestion',
                priority: options?.priority || 'MEDIUM',
                suppressNotifications: options?.suppressNotifications ?? false,
              }),
            });
            
            const result = await response.json();
            
            if (result.success && result.suggestionId) {
              results.success++;
              results.suggestionIds.push(result.suggestionId);
              return { success: true, matchId };
            } else {
              results.failed++;
              return { success: false, matchId, error: result.error };
            }
          } catch (err) {
            results.failed++;
            return { success: false, matchId, error: err };
          }
        });

        await Promise.all(promises);
      }

      setMatches(prev => prev.map(m => 
        matchIds.includes(m.id) ? { ...m, status: 'SENT' as const } : m
      ));

      setSelectedMatchIds([]);

      if (results.success > 0) {
        toast.success(`× ×•×¦×¨×• ${results.success} ×”×¦×¢×•×ª ×‘×”×¦×œ×—×”!`, {
          description: results.failed > 0 ? `${results.failed} × ×›×©×œ×•` : undefined,
        });
      } else if (results.failed > 0) {
        toast.error(`×›×œ ${results.failed} ×”×”×¦×¢×•×ª × ×›×©×œ×•`);
      }

      await fetchMatches(false);

      return results;

    } catch (err) {
      const msg = err instanceof Error ? err.message : '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¦×¢×•×ª ××¨×•×‘×•×ª';
      toast.error(msg);
      return results;
    } finally {
      setIsActioning(false);
    }
  }, [fetchMatches]);

  // ==========================================================================
  // SCAN LOGIC - ğŸ†• V2.3: With persistence support
  // ==========================================================================
  
  const updateScanState = useCallback((data: any) => {
    if (!data) return;
    
    setScanProgress({
      phase: data.phase || 'running',
      method: data.method,
      currentUserIndex: data.currentUserIndex || 0,
      totalUsers: data.totalUsers || 0,
      currentUserName: data.currentUserName,
      progressPercent: data.progressPercent || 0,
      pairsEvaluated: data.usersScanned || data.candidatesScanned || 0,
      pairsPassedQuickFilter: data.stats?.pairsPassedQuickFilter || 0,
      pairsPassedVectorFilter: data.stats?.pairsPassedVectorFilter || 0,
      pairsSentToAi: data.stats?.pairsSentToAi || 0,
      matchesFoundSoFar: data.matchesFoundSoFar || data.stats?.matchesFoundSoFar || 0,
      newMatchesFoundSoFar: data.newMatchesFoundSoFar || 0,
      usersScanned: data.usersScanned || 0,
      preparationStats: data.preparationStats,
      scanId: data.scanId || data.id,
      status: data.status || 'running',
      message: data.message,
      error: data.error
    });
  }, []);

  const handleScanCompletion = useCallback((result: ScanResult | null) => {
    setIsScanning(false);
    setActiveScanId(null);
    setScanResult(result);
    
    if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
    if (eventSourceRef.current) eventSourceRef.current.close();

    const matchesFound = result?.matchesFound ?? 0;
    const newMatches = result?.newMatches ?? 0;
    
    toast.success('×”×¡×¨×™×§×” ×”×•×©×œ××”!', {
      description: `× ××¦××• ${matchesFound} ×”×ª×××•×ª (${newMatches} ×—×“×©×•×ª)`,
      duration: 5000,
    });
    
    fetchMatches(false);
  }, [fetchMatches]);

  const startPolling = useCallback((scanId: string) => {
    if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
    
    const poll = async () => {
      try {
        const res = await fetch(`${API_BASE_SCAN}?scanId=${scanId}`);
        const data = await res.json();
        
        if (data.success && data.scan) {
          updateScanState(data.scan);
          
          if (['completed', 'failed', 'partial', 'cancelled'].includes(data.scan.status) ||
              ['completed', 'failed', 'cancelled'].includes(data.scan.phase)) {
            if (data.scan.status === 'failed' || data.scan.phase === 'failed') {
              setIsScanning(false);
              setActiveScanId(null);
              if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
              toast.error(data.scan.error || '×”×¡×¨×™×§×” × ×›×©×œ×”');
            } else if (data.scan.status === 'cancelled' || data.scan.phase === 'cancelled') {
              setIsScanning(false);
              setActiveScanId(null);
              if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
              toast.info('×”×¡×¨×™×§×” ×‘×•×˜×œ×”');
            } else {
              handleScanCompletion({
                matchesFound: data.scan.matchesFoundSoFar || 0,
                newMatches: data.scan.newMatchesFoundSoFar || 0,
                updatedMatches: 0,
                durationMs: 0
              });
            }
          }
        }
      } catch (err) {
        console.error('Polling error:', err);
      }
    };
    
    pollingIntervalRef.current = setInterval(poll, POLLING_INTERVAL);
    poll();
  }, [updateScanState, handleScanCompletion]);

  const startSSETracking = useCallback((scanId: string) => {
    if (eventSourceRef.current) eventSourceRef.current.close();

    const evtSource = new EventSource(`${API_BASE_SCAN}?scanId=${scanId}&stream=true`);
    eventSourceRef.current = evtSource;

    evtSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        
        if (data.type === 'progress') {
          updateScanState(data);
        } else if (data.type === 'complete') {
          handleScanCompletion(data.result);
        } else if (data.type === 'error') {
          setIsScanning(false);
          toast.error('×©×’×™××” ×‘×¡×¨×™×§×”', { description: data.error });
          evtSource.close();
        }
      } catch (e) {
        console.error('SSE Parse Error', e);
      }
    };

    evtSource.onerror = () => {
      console.warn('SSE disconnected, falling back to polling');
      evtSource.close();
      startPolling(scanId);
    };
  }, [updateScanState, handleScanCompletion, startPolling]);

  const getMethodLabel = (method: string): string => {
    const labels: Record<string, string> = {
      hybrid: '×”×™×‘×¨×™×“×™×ª',
      algorithmic: 'AI ××ª×§×“×',
      vector: '×“××™×•×Ÿ ××”×™×¨',
      metrics_v2: '××“×“×™× V2',
    };
    return labels[method] || method;
  };

  const startScan = useCallback(async (opts: ScanOptions = {}): Promise<string | null> => {
    if (isScanning) {
      toast.warning('×¡×¨×™×§×” ×›×‘×¨ ×¨×¦×”');
      return activeScanId;
    }

    setIsScanning(true);
    setScanResult(null);
    setScanProgress(null);

    const {
      useStreaming = true,
      action = 'full_scan',
      method = 'hybrid',
      forceRefresh = false,
      incremental = false,
      userId, 
      userIds,
      skipPreparation = false
    } = opts;

    try {
      const response = await fetch(API_BASE_SCAN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action,
          method,
          forceRefresh,
          incremental,
          userId,
          userIds,
          skipPreparation
        }),
      });

      const data = await response.json();

      if (!data.success) {
        // ğŸ†• V2.3: Handle already running or resuming
        if (data.status === 'already_running' || data.status === 'resuming') {
          toast.info(data.status === 'resuming' ? '×××©×™×š ×¡×¨×™×§×” ×§×•×“××ª...' : '×¡×¨×™×§×” ×›×‘×¨ ×¨×¦×” ×‘×¨×§×¢');
          setActiveScanId(data.scanId);
          
          // If we have progress data, update state
          if (data.progress) {
            updateScanState(data.progress);
          }
          
          startPolling(data.scanId);
          return data.scanId;
        }
        throw new Error(data.error || 'Failed to start scan');
      }

      toast.info(`×¡×¨×™×§×ª ${getMethodLabel(method)} ×”×—×œ×”!`);
      setActiveScanId(data.scanId);

      if (useStreaming && typeof EventSource !== 'undefined') {
        startSSETracking(data.scanId);
      } else {
        startPolling(data.scanId);
      }

      return data.scanId;

    } catch (err) {
      const msg = err instanceof Error ? err.message : '×”×¤×¢×œ×ª ×”×¡×¨×™×§×” × ×›×©×œ×”';
      toast.error(msg);
      setIsScanning(false);
      return null;
    }
  }, [isScanning, activeScanId, startSSETracking, startPolling, updateScanState]);

  const cancelScan = useCallback(async (): Promise<boolean> => {
    if (!activeScanId) return false;
    try {
      await fetch(API_BASE_SCAN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'cancel', scanId: activeScanId }),
      });
      
      setIsScanning(false);
      setActiveScanId(null);
      if (pollingIntervalRef.current) clearInterval(pollingIntervalRef.current);
      if (eventSourceRef.current) eventSourceRef.current.close();
      
      toast.info('×”×¡×¨×™×§×” ×‘×•×˜×œ×”');
      return true;
    } catch (err) {
      console.error('Cancel error:', err);
      return false;
    }
  }, [activeScanId]);

  // ==========================================================================
  // SELECTION HELPERS
  // ==========================================================================
  
  const toggleSelection = useCallback((matchId: string) => {
    setSelectedMatchIds(prev =>
      prev.includes(matchId) ? prev.filter(id => id !== matchId) : [...prev, matchId]
    );
  }, []);

  const selectAll = useCallback(() => setSelectedMatchIds(matches.map(m => m.id)), [matches]);
  const clearSelection = useCallback(() => setSelectedMatchIds([]), []);
  const isSelected = useCallback((matchId: string) => selectedMatchIds.includes(matchId), [selectedMatchIds]);

  // ==========================================================================
  // RETURN
  // ==========================================================================
  return {
    matches,
    stats,
    lastScanInfo,
    pagination,
    isLoading,
    isRefreshing,
    isActioning,
    error,
    isScanning,
    scanProgress,
    scanResult,
    filters,
    setFilters,
    resetFilters,
    setPage,
    setPageSize,
    refresh: () => fetchMatches(false),
    reviewMatch,
    dismissMatch,
    restoreMatch,
    saveMatch,
    createSuggestion,
    bulkDismiss,
    bulkReview,
    bulkRestore,
    startScan,
    cancelScan,
    selectedMatchIds,
    toggleSelection,
    selectAll,
    clearSelection,
    isSelected,
    bulkCreateSuggestions,
    // ğŸ†• V2.3
    isReconnecting,
  };
}

export default usePotentialMatches;
--- End of Content for usePotentialMatches.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\PotentialMatches\types\potentialMatches.ts
--------------------------------------------------------------------------------
Content:
// =============================================================================
// src/types/potentialMatches.ts
// ×˜×™×¤×•×¡×™× ××œ××™× ×œ××¢×¨×›×ª ×”×”×ª×××•×ª ×”×¤×•×˜× ×¦×™××œ×™×•×ª ×•×”×¡×¨×™×§×” ×”×œ×™×œ×™×ª
// =============================================================================

// =============================================================================
// ENUMS (××§×‘×™×œ×™× ×œ-Prisma)
// =============================================================================

export type PotentialMatchStatus = 
  | 'PENDING'      // ×˜×¨× × ×‘×“×§
  | 'REVIEWED'     // × ×‘×“×§ ××š ×œ× ×”×•×—×œ×˜
  | 'SENT'         // × ×©×œ×—×” ×”×¦×¢×”
  | 'DISMISSED'    // × ×“×—×” ×¢"×™ ×”×©×“×›×Ÿ
  | 'EXPIRED'
    | 'SHORTLISTED';     // ×¤×’ ×ª×•×§×£
  

export type AvailabilityStatus = 
  | 'AVAILABLE' 
  | 'NOT_LOOKING' 
  | 'PAUSED' 
  | 'DATING' 
  | 'ENGAGED';

// =============================================================================
// SCORE BREAKDOWN - ×¤×™×¨×•×˜ ×¦×™×•×Ÿ AI
// =============================================================================

export interface ScoreBreakdown {
  religious?: number;          // ×”×ª×××” ×“×ª×™×ª (××§×¡ 25)
  ageCompatibility?: number;   // ×”×ª×××ª ×’×™×œ (××§×¡ 10)
  careerFamily?: number;       // ××™×–×•×Ÿ ×§×¨×™×™×¨×”-××©×¤×—×” (××§×¡ 15)
  lifestyle?: number;          // ×¡×’× ×•×Ÿ ×—×™×™× (××§×¡ 10)
  socioEconomic?: number;      // ×”×ª×××” ×¡×•×¦×™×•-××§×•× ×•××™×ª (××§×¡ 10) ğŸ†•
  education?: number;          // ×”×ª×××ª ×”×©×›×œ×” (××§×¡ 10) ğŸ†•
  background?: number;         // ×¨×§×¢ ×ª×¨×‘×•×ª×™/×©×¤×” (××§×¡ 10) ğŸ†•
  values?: number;             // ×¢×¨×›×™× ×•×ª×§×©×•×¨×ª (××§×¡ 10)
  
  // ğŸ”„ ×ª××™××•×ª ×œ××—×•×¨ - ×©×“×•×ª ×™×©× ×™× (deprecated)
  ambition?: number;           // @deprecated - use careerFamily
  communication?: number;      // @deprecated - use values
}


// =============================================================================
// CANDIDATE INFO - ××™×“×¢ ×‘×¡×™×¡×™ ×¢×œ ××•×¢××“
// =============================================================================

export interface CandidateBasicInfo {
  id: string;
  profileId: string; 
  firstName: string;
  lastName: string;
  age: number;
  city: string | null;
  religiousLevel: string | null;
  occupation: string | null;
  mainImage: string | null;
  isVerified: boolean;
  isProfileComplete: boolean;
  availabilityStatus: AvailabilityStatus;
  lastActive?: Date | null;
  registeredAt?: Date;
  phone?: string | null;
   height?: number | null;
  maritalStatus?: string | null;
  nativeLanguage?: string | null;
  additionalLanguages?: string[] | null;
}

// =============================================================================
// ACTIVE SUGGESTION INFO - ××™×“×¢ ×¢×œ ×”×¦×¢×” ×¤×¢×™×œ×”
// =============================================================================

export interface ActiveSuggestionInfo {
  suggestionId: string;
  status: string;
  withCandidateName: string;
  withCandidateId: string;
  createdAt: Date;
  isBlocking: boolean;
}

// =============================================================================
// POTENTIAL MATCH - ×”×ª×××” ×¤×•×˜× ×¦×™××œ×™×ª ××œ××”
// =============================================================================

export interface PotentialMatch {
  id: string;
  
  // ×”×–×•×’
  male: CandidateBasicInfo;
  female: CandidateBasicInfo;
  
  // ×¦×™×•× ×™× ×›×œ×œ×™×™×
  aiScore: number;
  firstPassScore: number | null;
  scoreBreakdown: ScoreBreakdown | null;
  
  // × ×™××•×§×™× ×›×œ×œ×™×™×
  shortReasoning: string | null;
  detailedReasoning: string | null;
  
  // ×¨×§×¢
  backgroundCompatibility: 'excellent' | 'good' | 'possible' | 'problematic' | 'not_recommended' | null;
  backgroundMultiplier: number | null;
  ageScore: number | null;
  
  // ×¡×˜×˜×•×¡
  status: PotentialMatchStatus;
  
  // ×ª××¨×™×›×™×
  scannedAt: Date;
  reviewedAt: Date | null;
  
  // ××–×”×¨×•×ª ×¢×œ ×”×¦×¢×•×ª ×¤×¢×™×œ×•×ª
  maleActiveSuggestion: ActiveSuggestionInfo | null;
  femaleActiveSuggestion: ActiveSuggestionInfo | null;
  hasActiveWarning: boolean;
  
  // ×§×™×©×•×¨ ×œ×”×¦×¢×” ×©× ×•×¦×¨×” (×× ×™×©)
  suggestionId: string | null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ†• ×¦×™×•× ×™× ×•× ×™××•×§×™× ×œ×¤×™ ×©×™×˜×ª ×¡×¨×™×§×”
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Hybrid Method (4-tier) - ×”×›×™ ××§×™×£
  hybridScore: number | null;
  hybridReasoning: string | null;
  hybridScannedAt: Date | null;
  hybridScoreBreakdown: ScoreBreakdown | null;
  
  // Algorithmic Method (AI Deep)
  algorithmicScore: number | null;
  algorithmicReasoning: string | null;
  algorithmicScannedAt: Date | null;
  algorithmicScoreBreakdown: ScoreBreakdown | null;
  
  // Vector Method (Fast similarity)
  vectorScore: number | null;
  vectorReasoning: string | null;
  vectorScannedAt: Date | null;
  
  // Metrics V2 Method
  metricsV2Score: number | null;
  metricsV2Reasoning: string | null;
  metricsV2ScannedAt: Date | null;
  metricsV2ScoreBreakdown: ScoreBreakdown | null;
  
  // ×”×©×™×˜×” ×”××—×¨×•× ×” ×©×¨×¦×”
  lastScanMethod: 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2' | string | null;
}


// =============================================================================
// PAGINATION
// =============================================================================

export interface Pagination {
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
}

// =============================================================================
// STATS - ×¡×˜×˜×™×¡×˜×™×§×•×ª
// =============================================================================

export interface PotentialMatchesStats {
  total: number;
  pending: number;
  reviewed: number;
  sent: number;
  dismissed: number;
  expired: number;
  withWarnings: number;
  avgScore: number;
  highScore: number;   // 85+
  mediumScore: number; // 70-85
}

// =============================================================================
// LAST SCAN INFO - ××™×“×¢ ×¢×œ ×”×¡×¨×™×§×” ×”××—×¨×•× ×”
// =============================================================================

export interface LastScanInfo {
  id: string;
  startedAt: Date;
  completedAt: Date | null;
  status: 'running' | 'completed' | 'failed' | 'partial';
  totalCandidates: number;
  candidatesScanned: number;
  matchesFound: number;
  newMatches: number;
  updatedMatches?: number;
  durationMs: number | null;
  method?: string;
}

// =============================================================================
// API RESPONSES
// =============================================================================

export interface PotentialMatchesResponse {
  success: boolean;
  matches: PotentialMatch[];
  pagination: Pagination;
  stats: PotentialMatchesStats;
  lastScanInfo: LastScanInfo | null;
  error?: string;
}

export interface PotentialMatchActionResponse {
  success: boolean;
  message: string;
  match?: {
    id: string;
    status: PotentialMatchStatus;
  };
  suggestionId?: string;
  error?: string;
}

export interface BulkActionResponse {
  success: boolean;
  processed: number;
  message: string;
  error?: string;
}

// =============================================================================
// BATCH SCAN TYPES
// =============================================================================

export interface BatchScanRequest {
  method?: 'algorithmic' | 'vector' | 'hybrid';
  minScoreThreshold?: number;
  maxCandidates?: number;
  forceRefresh?: boolean;
}

export interface BatchScanResponse {
  success: boolean;
  status: 'started' | 'already_running' | 'completed' | 'partial' | 'failed';
  scanId: string;
  message: string;
  stats?: {
    totalCandidates: number;
    maleCandidates: number;
    femaleCandidates: number;
    candidatesScanned: number;
    matchesFound: number;
    newMatches: number;
    updatedMatches: number;
    expiredMatches: number;
    durationMs: number;
    durationMinutes: number;
    errors: number;
  };
  topResults?: Array<{
    candidate: string;
    matches: number;
    new: number;
  }>;
  error?: string;
}

export interface BatchScanProgress {
  scanId: string;
  status: 'running' | 'completed' | 'failed' | 'partial';
  progress: number;
  currentCandidate: string | null;
  candidatesScanned: number;
  totalCandidates: number;
  matchesFound: number;
  elapsedMs: number;
  estimatedRemainingMs: number | null;
  error: string | null;
}

// =============================================================================
// FILTER & SORT OPTIONS
// =============================================================================

export type PotentialMatchSortBy = 
  | 'score_desc' 
  | 'score_asc' 
  | 'date_desc' 
  | 'date_asc'
  | 'male_waiting_time'
  | 'female_waiting_time';

export type PotentialMatchFilterStatus = 
  | 'all' 
  | 'pending' 
  | 'reviewed' 
  | 'sent' 
  | 'dismissed'
  | 'shortlisted'
  | 'expired'
  | 'with_warnings'
  | 'no_warnings';

export interface PotentialMatchFilters {
  status: PotentialMatchFilterStatus;
  minScore: number;
  maxScore: number;
  religiousLevel: string | null;
  city: string | null;
  hasWarning: boolean | null;
  scannedAfter: Date | null;
  sortBy: PotentialMatchSortBy;
  searchTerm?: string;
  candidateId?: string;
    scanMethod?: 'hybrid' | 'algorithmic' | 'vector' | 'metrics_v2' | null;

}

export interface ScanMethodData {
  score: number | null;
  reasoning: string | null;
  scannedAt: Date | null;
  scoreBreakdown?: ScoreBreakdown | null;
}

// =============================================================================
// ACTION TYPES
// =============================================================================

export type PotentialMatchAction = 
  | 'review'
  | 'dismiss'
  | 'restore'
  | 'create_suggestion'
   | 'save';;

export interface PotentialMatchActionRequest {
  matchId: string;
  action: PotentialMatchAction;
  reason?: string;
  suggestionData?: {
    priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
    firstPartyNotes?: string;
    secondPartyNotes?: string;
    matchingReason?: string;
  };
}

export interface BulkActionRequest {
  matchIds: string[];
  action: 'dismiss' | 'review' | 'restore';
  reason?: string;
}

// =============================================================================
// RELIGIOUS LEVELS (×œ×ª×¦×•×’×”)
// =============================================================================

export const RELIGIOUS_LEVEL_LABELS: Record<string, string> = {
  'charedi_hasidic': '×—×¨×“×™ ×—×¡×™×“×™',
  'charedi_litvak': '×—×¨×“×™ ×œ×™×˜××™',
  'charedi_sephardic': '×—×¨×“×™ ×¡×¤×¨×“×™',
  'chabad': '×—×‘"×“',
  'breslov': '×‘×¨×¡×œ×‘',
  'charedi_modern': '×—×¨×“×™ ××•×“×¨× ×™',
  'dati_leumi_torani': '×“×ª×™ ×œ××•××™ ×ª×•×¨× ×™',
  'dati_leumi_standard': '×“×ª×™ ×œ××•××™',
  'dati_leumi_liberal': '×“×ª×™ ×œ××•××™ ×œ×™×‘×¨×œ×™',
  'masorti_strong': '××¡×•×¨×ª×™ ×—×–×§',
  'masorti_light': '××¡×•×¨×ª×™',
  'secular_traditional_connection': '×—×™×œ×•× ×™ ×¢× ×§×©×¨ ×œ××¡×•×¨×ª',
  'secular': '×—×™×œ×•× ×™',
  'spiritual_not_religious': '×¨×•×—× ×™ ×œ× ×“×ª×™',
  'other': '××—×¨',
};

export function getReligiousLevelLabel(level: string | null): string {
  if (!level) return '×œ× ×¦×•×™×Ÿ';
  return RELIGIOUS_LEVEL_LABELS[level] || level;
}

// =============================================================================
// BACKGROUND COMPATIBILITY (×œ×ª×¦×•×’×”)
// =============================================================================

export const BACKGROUND_COMPATIBILITY_LABELS: Record<string, { label: string; color: string }> = {
  'excellent': { label: '×¨×§×¢ ××¦×•×™×Ÿ', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' },
  'good': { label: '×¨×§×¢ ×˜×•×‘', color: 'bg-blue-100 text-blue-700 border-blue-200' },
  'possible': { label: '×¨×§×¢ ××¤×©×¨×™', color: 'bg-amber-100 text-amber-700 border-amber-200' },
  'problematic': { label: '×¤×¢×¨ ×¨×§×¢', color: 'bg-orange-100 text-orange-700 border-orange-200' },
  'not_recommended': { label: '×¨×§×¢ ×‘×¢×™×™×ª×™', color: 'bg-red-100 text-red-700 border-red-200' },
};

export function getBackgroundBadge(compatibility: string | null): { label: string; color: string } | null {
  if (!compatibility) return null;
  return BACKGROUND_COMPATIBILITY_LABELS[compatibility] || null;
}

// =============================================================================
// STATUS (×œ×ª×¦×•×’×”)
// =============================================================================

export const STATUS_LABELS: Record<PotentialMatchStatus, { label: string; color: string }> = {
  'PENDING': { label: '×××ª×™×Ÿ', color: 'bg-yellow-100 text-yellow-700' },
  'REVIEWED': { label: '× ×‘×“×§', color: 'bg-blue-100 text-blue-700' },
  'SENT': { label: '× ×©×œ×—×” ×”×¦×¢×”', color: 'bg-green-100 text-green-700' },
  'DISMISSED': { label: '× ×“×—×”', color: 'bg-gray-100 text-gray-700' },
  'EXPIRED': { label: '×¤×’ ×ª×•×§×£', color: 'bg-red-100 text-red-700' },
   'SHORTLISTED': { label: '×©××•×¨ ×‘×¦×“', color: 'bg-purple-100 text-purple-700' },
};

export function getStatusBadge(status: PotentialMatchStatus): { label: string; color: string } {
  return STATUS_LABELS[status] || { label: status, color: 'bg-gray-100 text-gray-700' };
}

// =============================================================================
// SCORE UTILITIES
// =============================================================================

export function getScoreColor(score: number): string {
  if (score >= 85) return 'text-emerald-600';
  if (score >= 75) return 'text-blue-600';
  if (score >= 70) return 'text-amber-600';
  return 'text-gray-600';
}

export function getScoreBgGradient(score: number): string {
  if (score >= 85) return 'from-emerald-500 to-green-500';
  if (score >= 75) return 'from-blue-500 to-cyan-500';
  if (score >= 70) return 'from-amber-500 to-yellow-500';
  return 'from-gray-500 to-slate-500';
}

export function getScoreLabel(score: number): string {
  if (score >= 90) return '××¦×•×™×Ÿ';
  if (score >= 85) return '×’×‘×•×” ×××•×“';
  if (score >= 80) return '×’×‘×•×”';
  if (score >= 75) return '×˜×•×‘ ×××•×“';
  if (score >= 70) return '×˜×•×‘';
  return '×‘×™× ×•× ×™';
}

// =============================================================================
// SCAN METHOD UTILITIES
// =============================================================================

export const SCAN_METHOD_INFO: Record<string, { 
  label: string; 
  icon: string; 
  description: string;
  bgColor: string;
  textColor: string;
  borderColor: string;
}> = {
  hybrid: {
    label: '×”×™×‘×¨×™×“×™',
    icon: 'ğŸ”¥',
    description: '×¡×¨×™×§×” ×”×™×‘×¨×™×“×™×ª (4 ×©×œ×‘×™×) - ×”×›×™ ××§×™×£',
    bgColor: 'bg-emerald-50',
    textColor: 'text-emerald-700',
    borderColor: 'border-emerald-200',
  },
  algorithmic: {
    label: 'AI ××ª×§×“×',
    icon: 'ğŸ§ ',
    description: '× ×™×ª×•×— AI ××¢××™×§ ×¢× ×”×‘× ×ª ×”×§×©×¨',
    bgColor: 'bg-purple-50',
    textColor: 'text-purple-700',
    borderColor: 'border-purple-200',
  },
  vector: {
    label: '×¡×¨×™×§×” ××”×™×¨×”',
    icon: 'âš¡',
    description: '×¡×¨×™×§×” ×•×§×˜×•×¨×™×ª ××”×™×¨×” ×œ×¤×™ ×“××™×•×Ÿ ×˜×§×¡×˜×•××œ×™',
    bgColor: 'bg-blue-50',
    textColor: 'text-blue-700',
    borderColor: 'border-blue-200',
  },
  metrics_v2: {
    label: '××˜×¨×™×§×•×ª V2',
    icon: 'ğŸ¯',
    description: '× ×™×ª×•×— ×œ×¤×™ ××“×“×™× ××¡×¤×¨×™×™× ××“×•×™×§×™×',
    bgColor: 'bg-indigo-50',
    textColor: 'text-indigo-700',
    borderColor: 'border-indigo-200',
  },
};

export function getScanMethodInfo(method: string | null) {
  if (!method) return null;
  return SCAN_METHOD_INFO[method] || null;
}

export function getAllMethodScores(match: PotentialMatch): ScanMethodData[] {
  return [
    {
      score: match.hybridScore,
      reasoning: match.hybridReasoning,
      scannedAt: match.hybridScannedAt,
      scoreBreakdown: match.hybridScoreBreakdown,
    },
    {
      score: match.algorithmicScore,
      reasoning: match.algorithmicReasoning,
      scannedAt: match.algorithmicScannedAt,
      scoreBreakdown: match.algorithmicScoreBreakdown,
    },
    {
      score: match.vectorScore,
      reasoning: match.vectorReasoning,
      scannedAt: match.vectorScannedAt,
      scoreBreakdown: null,
    },
    {
      score: match.metricsV2Score,
      reasoning: match.metricsV2Reasoning,
      scannedAt: match.metricsV2ScannedAt,
      scoreBreakdown: match.metricsV2ScoreBreakdown,
    },
  ].filter(m => m.score !== null);
}

// =============================================================================
// SCORE BREAKDOWN CATEGORIES - ×§×˜×’×•×¨×™×•×ª ×”× ×™×§×•×“ (×œ×ª×¦×•×’×”)
// =============================================================================

export const SCORE_BREAKDOWN_CATEGORIES = [
  { key: 'religious', label: '×”×ª×××” ×“×ª×™×ª', max: 25, color: 'bg-purple-500' },
  { key: 'ageCompatibility', label: '×”×ª×××ª ×’×™×œ', max: 10, color: 'bg-blue-500' },
  { key: 'careerFamily', label: '×§×¨×™×™×¨×”-××©×¤×—×”', max: 15, color: 'bg-cyan-500' },
  { key: 'lifestyle', label: '×¡×’× ×•×Ÿ ×—×™×™×', max: 10, color: 'bg-green-500' },
  { key: 'socioEconomic', label: '×¡×•×¦×™×•-××§×•× ×•××™', max: 10, color: 'bg-orange-500' },
  { key: 'education', label: '×”×©×›×œ×”', max: 10, color: 'bg-pink-500' },
  { key: 'background', label: '×¨×§×¢ ×ª×¨×‘×•×ª×™', max: 10, color: 'bg-amber-500' },
  { key: 'values', label: '×¢×¨×›×™× ×•×ª×§×©×•×¨×ª', max: 10, color: 'bg-indigo-500' },
] as const;
--- End of Content for potentialMatches.ts ---

