################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new
# Generated on: 2026-01-15 09:58:58
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\MatchingJobFloatingStatus.tsx
--------------------------------------------------------------------------------
Content:
// ===========================================
// src/components/matching/MatchingJobFloatingStatus.tsx
// ===========================================
//  拽驻 爪驻 砖爪 转 住住 -Job  拽 驻拽爪
// 住祝 转 -layout 专砖

'use client';

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Loader2,
  CheckCircle2,
  XCircle,
  Brain,
  Zap,
  ChevronDown,
  ChevronUp,
  X,
  Sparkles,
  Users,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { cn } from '@/lib/utils';
import { useMatchingJobContextOptional } from '@/app/[locale]/contexts/MatchingJobContext';
import { usePathname, useRouter } from 'next/navigation';

// ============================================================================
// FLOATING STATUS COMPONENT
// ============================================================================

// 拽抓 MatchingJobFloatingStatus.tsx
// 祝 转  -return statement

export const MatchingJobFloatingStatus: React.FC = () => {
  const context = useMatchingJobContextOptional();
  const pathname = usePathname();
  const router = useRouter();
  const [isExpanded, setIsExpanded] = useState(true);
  const [isDismissed, setIsDismissed] = useState(false);

  useEffect(() => {
    if (context?.isJobRunning) {
      setIsDismissed(false);
      setIsExpanded(true);
    }
  }, [context?.isJobRunning]);

  if (!context) return null;

  const { currentJob, isJobRunning, hasResults, cancelJob } = context;

  const isOnMatchmakerPage = pathname?.includes('/matchmaker/clients');

  //  转拽: 注专转  拽 转 shouldShow
  const shouldShow =
    currentJob.status !== 'idle' &&
    !isDismissed &&
    !(isOnMatchmakerPage && isJobRunning);

  const isVector = currentJob.method === 'vector';

  const handleViewResults = () => {
    const locale = pathname?.split('/')[1] || 'he';
    router.push(`/${locale}/matchmaker/clients`);
    setTimeout(() => {
      window.dispatchEvent(new CustomEvent('matching-job-view-results'));
    }, 500);
  };

  //  转拽: handleDismiss 注 转,  专拽 -completed/failed
  const handleDismiss = () => {
    setIsDismissed(true);
  };

  //  转拽: AnimatePresence 注祝 转 转,  驻
  return (
    <AnimatePresence>
      {shouldShow && (
        <motion.div
          key="matching-job-floating-status" //  住驻转 key
          initial={{ opacity: 0, y: 100, scale: 0.9 }}
          animate={{ opacity: 1, y: 0, scale: 1 }}
          exit={{ opacity: 0, y: 100, scale: 0.9 }}
          className={cn(
            'fixed z-[100] bottom-6 left-6 w-80 rounded-xl shadow-2xl border overflow-hidden',
            'bg-white/95 backdrop-blur-sm',
            currentJob.status === 'completed' && 'border-green-200',
            currentJob.status === 'failed' && 'border-red-200',
            isJobRunning && 'border-gray-200'
          )}
        >
          {/* Header */}
          <div
            className={cn(
              'p-3 flex items-center justify-between cursor-pointer transition-colors',
              currentJob.status === 'completed' && 'bg-green-50',
              currentJob.status === 'failed' && 'bg-red-50',
              isJobRunning && (isVector ? 'bg-blue-50' : 'bg-purple-50')
            )}
            onClick={() => setIsExpanded(!isExpanded)}
          >
            <div className="flex items-center gap-2">
              {isJobRunning ? (
                <Loader2
                  className={cn(
                    'w-5 h-5 animate-spin',
                    isVector ? 'text-blue-600' : 'text-purple-600'
                  )}
                />
              ) : currentJob.status === 'completed' ? (
                <CheckCircle2 className="w-5 h-5 text-green-600" />
              ) : (
                <XCircle className="w-5 h-5 text-red-600" />
              )}

              <div>
                <span className="font-medium text-sm">
                  {isJobRunning
                    ? `驻砖 注专 ${currentJob.targetName || '注'}...`
                    : currentJob.status === 'completed'
                      ? `爪 ${currentJob.result?.matches.length || 0} 转转!`
                      : '驻砖 砖'}
                </span>
                {isJobRunning && (
                  <div className="text-xs text-gray-500">
                    {isVector ? '驻砖 专' : 'AI 转拽'}
                  </div>
                )}
              </div>
            </div>

            <div className="flex items-center gap-1">
              {isExpanded ? (
                <ChevronDown className="w-4 h-4 text-gray-400" />
              ) : (
                <ChevronUp className="w-4 h-4 text-gray-400" />
              )}
              {/*  转拽: 驻转专 X 驻注 转 */}
              <Button
                variant="ghost"
                size="sm"
                onClick={(e) => {
                  e.stopPropagation();
                  handleDismiss();
                }}
                className="h-6 w-6 p-0 hover:bg-gray-200"
              >
                <X className="w-3 h-3" />
              </Button>
            </div>
          </div>

          {/* Content - 砖专  砖 */}
          <AnimatePresence>
            {isExpanded && (
              <motion.div
                initial={{ height: 0 }}
                animate={{ height: 'auto' }}
                exit={{ height: 0 }}
                className="overflow-hidden"
              >
                <div className="p-3 space-y-3">
                  {isJobRunning && (
                    <>
                      <Progress value={currentJob.progress} className="h-2" />
                      <div className="flex justify-between text-xs text-gray-500">
                        <span>{currentJob.progressMessage || '注...'}</span>
                        <span>{currentJob.progress}%</span>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={cancelJob}
                        className="w-full text-gray-600"
                      >
                        <X className="w-4 h-4 ml-2" />
                         驻砖
                      </Button>
                    </>
                  )}

                  {currentJob.status === 'completed' && (
                    <>
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <Users className="w-4 h-4" />
                        <span>注专: {currentJob.targetName}</span>
                      </div>
                      <Button
                        onClick={handleViewResults}
                        className="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white"
                      >
                        <Sparkles className="w-4 h-4 ml-2" />
                        爪 转爪转
                      </Button>
                    </>
                  )}

                  {currentJob.status === 'failed' && (
                    <p className="text-sm text-red-600">
                      {currentJob.error || '专注 砖 驻砖'}
                    </p>
                  )}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default MatchingJobFloatingStatus;
--- End of Content for MatchingJobFloatingStatus.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\MatchingJobStatus.tsx
--------------------------------------------------------------------------------
Content:
// ===========================================
// src/components/matching/MatchingJobStatus.tsx
// ===========================================
//  拽驻转 爪转 住住 Job
//  Progress Bar, Banner, -Notification

'use client';

import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Loader2, 
  CheckCircle2, 
  XCircle, 
  Brain, 
  Zap,
  ChevronDown,
  ChevronUp,
  Clock,
  Users,
  Sparkles,
  X
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { cn } from '@/lib/utils';
import type { JobStatus, SearchMethod, MatchResult } from './hooks/useMatchingJob';

// ============================================================================
// Progress Bar Component
// ============================================================================

interface MatchingProgressBarProps {
  progress: number;
  progressMessage: string;
  method: SearchMethod;
  isLoading: boolean;
  onCancel?: () => void;
  className?: string;
}

export const MatchingProgressBar: React.FC<MatchingProgressBarProps> = ({
  progress,
  progressMessage,
  method,
  isLoading,
  onCancel,
  className
}) => {
  if (!isLoading) return null;

  const isVector = method === 'vector';
  const gradientClass = isVector 
    ? 'from-blue-500 to-cyan-500' 
    : 'from-purple-500 to-pink-500';
  const bgClass = isVector ? 'bg-blue-50' : 'bg-purple-50';
  const Icon = isVector ? Zap : Brain;

  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      className={cn(
        'rounded-xl p-4 border shadow-lg',
        bgClass,
        className
      )}
    >
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <div className={cn(
            'p-2 rounded-lg bg-gradient-to-r text-white',
            gradientClass
          )}>
            <Icon className="w-4 h-4" />
          </div>
          <div>
            <p className="font-medium text-gray-900">
              {isVector ? '驻砖 专' : '转 转拽'}
            </p>
            <p className="text-sm text-gray-500">{progressMessage}</p>
          </div>
        </div>
        
        {onCancel && (
          <Button
            variant="ghost"
            size="sm"
            onClick={onCancel}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="w-4 h-4" />
          </Button>
        )}
      </div>

      <div className="relative">
        <Progress 
          value={progress} 
          className="h-3 bg-gray-200"
        />
        <motion.div
          className={cn(
            'absolute inset-0 h-3 rounded-full bg-gradient-to-r opacity-30',
            gradientClass
          )}
          animate={{
            x: ['-100%', '100%'],
          }}
          transition={{
            duration: 1.5,
            repeat: Infinity,
            ease: 'linear'
          }}
          style={{ width: '50%' }}
        />
      </div>

      <div className="flex justify-between mt-2 text-sm text-gray-500">
        <span>{progress}%</span>
        <span className="flex items-center gap-1">
          <Loader2 className="w-3 h-3 animate-spin" />
          注...
        </span>
      </div>
    </motion.div>
  );
};

// ============================================================================
// Completion Banner Component
// ============================================================================

interface MatchingCompleteBannerProps {
  matchesCount: number;
  totalCandidates?: number;
  fromCache: boolean;
  completedAt?: Date;
  onViewResults: () => void;
  onDismiss: () => void;
  className?: string;
}

export const MatchingCompleteBanner: React.FC<MatchingCompleteBannerProps> = ({
  matchesCount,
  totalCandidates,
  fromCache,
  completedAt,
  onViewResults,
  onDismiss,
  className
}) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: -20, scale: 0.95 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, y: -20, scale: 0.95 }}
      className={cn(
        'rounded-xl p-4 bg-gradient-to-r from-green-50 to-emerald-50',
        'border border-green-200 shadow-lg',
        className
      )}
    >
      <div className="flex items-start justify-between">
        <div className="flex items-start gap-3">
          <div className="p-2 rounded-full bg-green-500 text-white">
            <CheckCircle2 className="w-5 h-5" />
          </div>
          
          <div>
            <h3 className="font-bold text-green-800 text-lg">
              砖! 爪 {matchesCount} 转转
            </h3>
            
            <div className="flex flex-wrap gap-3 mt-2 text-sm text-green-600">
              {totalCandidates && (
                <span className="flex items-center gap-1">
                  <Users className="w-4 h-4" />
                  住专拽 {totalCandidates} 注
                </span>
              )}
              
              {fromCache && (
                <span className="flex items-center gap-1 text-amber-600">
                  <Clock className="w-4 h-4" />
                  专
                </span>
              )}
              
              {completedAt && (
                <span className="flex items-center gap-1">
                  <Clock className="w-4 h-4" />
                  {formatTimeAgo(completedAt)}
                </span>
              )}
            </div>
          </div>
        </div>

        <Button
          variant="ghost"
          size="sm"
          onClick={onDismiss}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-4 h-4" />
        </Button>
      </div>

      <div className="mt-4 flex gap-2">
        <Button
          onClick={onViewResults}
          className="bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:from-green-600 hover:to-emerald-600"
        >
          <Sparkles className="w-4 h-4 ml-2" />
          爪 转爪转
        </Button>
      </div>
    </motion.div>
  );
};

// ============================================================================
// Error Banner Component
// ============================================================================

interface MatchingErrorBannerProps {
  error: string;
  onRetry?: () => void;
  onDismiss: () => void;
  className?: string;
}

export const MatchingErrorBanner: React.FC<MatchingErrorBannerProps> = ({
  error,
  onRetry,
  onDismiss,
  className
}) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      className={cn(
        'rounded-xl p-4 bg-red-50 border border-red-200 shadow-lg',
        className
      )}
    >
      <div className="flex items-start justify-between">
        <div className="flex items-start gap-3">
          <div className="p-2 rounded-full bg-red-500 text-white">
            <XCircle className="w-5 h-5" />
          </div>
          
          <div>
            <h3 className="font-bold text-red-800">驻砖 砖</h3>
            <p className="text-sm text-red-600 mt-1">{error}</p>
          </div>
        </div>

        <Button
          variant="ghost"
          size="sm"
          onClick={onDismiss}
          className="text-gray-400 hover:text-gray-600"
        >
          <X className="w-4 h-4" />
        </Button>
      </div>

      {onRetry && (
        <div className="mt-4">
          <Button
            onClick={onRetry}
            variant="outline"
            className="border-red-300 text-red-700 hover:bg-red-100"
          >
            住 砖
          </Button>
        </div>
      )}
    </motion.div>
  );
};

// ============================================================================
// Floating Notification Component
// ============================================================================

interface MatchingNotificationProps {
  status: JobStatus;
  matchesCount?: number;
  progressMessage?: string;
  progress?: number;
  onViewResults?: () => void;
  onDismiss: () => void;
  position?: 'top-right' | 'bottom-right' | 'top-left' | 'bottom-left';
}

export const MatchingNotification: React.FC<MatchingNotificationProps> = ({
  status,
  matchesCount = 0,
  progressMessage,
  progress = 0,
  onViewResults,
  onDismiss,
  position = 'bottom-right'
}) => {
  const [isExpanded, setIsExpanded] = useState(true);

  const positionClasses = {
    'top-right': 'top-4 right-4',
    'bottom-right': 'bottom-4 right-4',
    'top-left': 'top-4 left-4',
    'bottom-left': 'bottom-4 left-4'
  };

  if (status === 'idle') return null;

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      exit={{ opacity: 0, scale: 0.9, y: 20 }}
      className={cn(
        'fixed z-50 w-80 rounded-xl shadow-2xl border overflow-hidden',
        positionClasses[position],
        status === 'completed' ? 'bg-white border-green-200' :
        status === 'failed' ? 'bg-white border-red-200' :
        'bg-white border-gray-200'
      )}
    >
      {/* Header */}
      <div 
        className={cn(
          'p-3 flex items-center justify-between cursor-pointer',
          status === 'completed' ? 'bg-green-50' :
          status === 'failed' ? 'bg-red-50' :
          'bg-gray-50'
        )}
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center gap-2">
          {status === 'processing' || status === 'pending' ? (
            <Loader2 className="w-5 h-5 animate-spin text-purple-600" />
          ) : status === 'completed' ? (
            <CheckCircle2 className="w-5 h-5 text-green-600" />
          ) : (
            <XCircle className="w-5 h-5 text-red-600" />
          )}
          
          <span className="font-medium">
            {status === 'processing' || status === 'pending' ? '驻砖 转转...' :
             status === 'completed' ? `爪 ${matchesCount} 转转!` :
             '驻砖 砖'}
          </span>
        </div>

        <div className="flex items-center gap-1">
          {isExpanded ? (
            <ChevronDown className="w-4 h-4 text-gray-400" />
          ) : (
            <ChevronUp className="w-4 h-4 text-gray-400" />
          )}
          <Button
            variant="ghost"
            size="sm"
            onClick={(e) => {
              e.stopPropagation();
              onDismiss();
            }}
            className="h-6 w-6 p-0"
          >
            <X className="w-3 h-3" />
          </Button>
        </div>
      </div>

      {/* Content */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: 'auto' }}
            exit={{ height: 0 }}
            className="overflow-hidden"
          >
            <div className="p-3">
              {(status === 'processing' || status === 'pending') && (
                <>
                  <Progress value={progress} className="h-2 mb-2" />
                  <p className="text-sm text-gray-500">{progressMessage || '注...'}</p>
                  <p className="text-xs text-gray-400 mt-1">{progress}%</p>
                </>
              )}

              {status === 'completed' && (
                <Button
                  onClick={onViewResults}
                  className="w-full bg-gradient-to-r from-green-500 to-emerald-500"
                >
                  <Sparkles className="w-4 h-4 ml-2" />
                  爪 转爪转
                </Button>
              )}

              {status === 'failed' && (
                <p className="text-sm text-red-600">
                  专注 砖 驻砖. 住 砖 专 转专.
                </p>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

// ============================================================================
// Helper Functions
// ============================================================================

function formatTimeAgo(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return '注砖';
  if (diffMins < 60) return `驻 ${diffMins} 拽转`;
  if (diffHours < 24) return `驻 ${diffHours} 砖注转`;
  if (diffDays < 7) return `驻 ${diffDays} `;
  
  return date.toLocaleDateString('he-IL');
}

// ============================================================================
// Export All
// ============================================================================

export default {
  MatchingProgressBar,
  MatchingCompleteBanner,
  MatchingErrorBanner,
  MatchingNotification
};
--- End of Content for MatchingJobStatus.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\MatchmakerEditProfile.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/MatchmakerEditProfile.tsx
'use client';
import React, { useState, useEffect, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { toast } from 'sonner';
import { ProfileSection } from '@/components/profile';
import { PhotosSection } from '@/components/profile';
import { PreferencesSection } from '@/components/profile';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Loader2,
  X,
  UserCog,
  Sparkles,
  Award,
  Image as ImageIcon,
  Sliders,
  Trash2,
  AlertCircle,
  Send,
  Save,
  MessageSquare,
  Phone,
  Mail,
  FileText,
  Copy, // 住驻 拽 注转拽
} from 'lucide-react';
import type { UserProfile, UserImage } from '@/types/next-auth';
import type { Candidate } from './types/candidates';
import { motion } from 'framer-motion';
import { useSession } from 'next-auth/react';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { cn } from '@/lib/utils';
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  CardDescription,
  CardFooter,
} from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';

interface MatchmakerEditProfileProps {
  isOpen: boolean;
  onClose: () => void;
  candidate: Candidate | null;
  onCandidateDeleted?: (candidateId: string) => void;
  dict: MatchmakerPageDictionary['candidatesManager']['editProfile'];
  profileDict: ProfilePageDictionary;
  locale: string;
}

const MatchmakerEditProfile: React.FC<MatchmakerEditProfileProps> = ({
  isOpen,
  onClose,
  candidate,
  onCandidateDeleted,
  dict,
  profileDict,
  locale,
}) => {
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === 'ADMIN';
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- States ---
  const [activeTab, setActiveTab] = useState('profile');
  const [isEditing, setIsEditing] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [images, setImages] = useState<UserImage[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // 砖 驻专 砖驻
  const [names, setNames] = useState({ firstName: '', lastName: '' });

  // 驻
  const [userPhone, setUserPhone] = useState<string | null>(null);

  // 拽转 注
  const [isDeleteCandidateDialogOpen, setIsDeleteCandidateDialogOpen] =
    useState(false);
  const [deleteCandidateConfirmText, setDeleteCandidateConfirmText] =
    useState('');
  const [isDeletingCandidate, setIsDeletingCandidate] = useState(false);

  // 转 砖转砖
  const [isSetupInviteOpen, setIsSetupInviteOpen] = useState(false);
  const [inviteEmail, setInviteEmail] = useState('');
  const [isSendingInvite, setIsSendingInvite] = useState(false);

  // AI Summary (砖  -DB)
  const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);

  // Insight Text (转 砖 - 拽住 拽 PDF)
  const [insightText, setInsightText] = useState<string | null>(null);
  const [isInsightDialogOpen, setIsInsightDialogOpen] = useState(false);
  const [isGeneratingInsight, setIsGeneratingInsight] = useState(false);

  const DELETE_CANDIDATE_CONFIRMATION_PHRASE = dict.deleteConfirmationPhrase;

  // --- Handlers ---

  // 爪专转 转拽爪专 AI  (砖 manualEntryText)
  const handleGenerateSummary = async () => {
    if (!candidate) return;
    setIsGeneratingSummary(true);
    try {
      const response = await fetch('/api/ai/matchmaker/generate-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: candidate.id, locale: locale }),
      });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Failed to generate summary');
      }

      setProfile((prevProfile) => {
        if (!prevProfile) return null;
        return { ...prevProfile, manualEntryText: result.summary };
      });

      toast.success(dict.toasts.aiSummarySuccess);
    } catch (error) {
      toast.error(
        `${dict.toasts.aiSummaryError}: ${error instanceof Error ? error.message : ''}`
      );
    } finally {
      setIsGeneratingSummary(false);
    }
  };

  // 砖驻转 转 驻专驻
  const fetchProfileData = useCallback(async () => {
    if (!candidate) return;
    setIsLoading(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}?locale=${locale}`
      );
      if (!response.ok) throw new Error('Failed to fetch candidate profile');
      const data = await response.json();
      if (data.success) {
        setProfile(data.profile);
        setImages(data.images || []);

        // 注 砖转 砖专转
        setNames({
          firstName: data.user?.firstName || candidate.firstName,
          lastName: data.user?.lastName || candidate.lastName,
        });

        if (data.profile?.user?.phone) {
          setUserPhone(data.profile.user.phone);
        } else if (candidate.phone) {
          setUserPhone(candidate.phone);
        }

        if (
          candidate.email &&
          !candidate.email.endsWith('@shidduch.placeholder.com')
        ) {
          setInviteEmail(candidate.email);
        } else {
          setInviteEmail('');
        }
      } else {
        throw new Error(data.error || 'Failed to load profile data');
      }
    } catch (error) {
      console.error('Error fetching profile:', error);
      toast.error(dict.toasts.loadError);
    } finally {
      setIsLoading(false);
    }
  }, [candidate, dict.toasts.loadError, locale]);

  // Effect 注转 转
  useEffect(() => {
    if (isOpen && candidate) {
      fetchProfileData();
    } else if (!isOpen) {
      // Reset State
      setProfile(null);
      setImages([]);
      setNames({ firstName: '', lastName: '' }); // 驻住 砖转
      setUserPhone(null);
      setActiveTab('profile');
      setIsLoading(true);
      setDeleteCandidateConfirmText('');
      setIsDeleteCandidateDialogOpen(false);
      setIsSetupInviteOpen(false);
      setInviteEmail('');
      setIsSendingInvite(false);
      // Reset Insight State
      setInsightText(null);
      setIsInsightDialogOpen(false);
      setIsGeneratingInsight(false);
    }
  }, [isOpen, candidate, fetchProfileData]);

  // 注 砖转 驻专驻 ( 砖转)
  // 砖 驻住 -any  转  砖转 firstName/lastName 砖 -UserProfile
  const handleProfileUpdate = async (updatedData: any) => {
    if (!candidate || !profile) return;
    setIsSaving(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}`,
        {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        }
      );
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Failed to update profile');
      }

      // 注 -state 砖 驻专驻
      setProfile(
        (prevProfile) => ({ ...prevProfile, ...updatedData }) as UserProfile
      );

      // 注 -state 砖 砖转   砖转
      if (updatedData.firstName || updatedData.lastName) {
        setNames((prev) => ({
          firstName: updatedData.firstName || prev.firstName,
          lastName: updatedData.lastName || prev.lastName,
        }));
      }

      toast.success(dict.toasts.updateSuccess, {
        position: 'top-center',
        duration: 3000,
      });
    } catch (error) {
      console.error('Error updating profile:', error);
      toast.error(
        `${dict.toasts.updateError}: ${error instanceof Error ? error.message : 'Unknown error'}`,
        { duration: 5000 }
      );
    } finally {
      setIsSaving(false);
    }
  };

  // --- NEW: Generate Text Insight (Replacing PDF) ---
  const handleGenerateInsightText = async () => {
    if (!candidate) return;
    setIsGeneratingInsight(true);
    try {
      // 拽专 -API 砖专 拽住
      const response = await fetch('/api/profile/neshama-insight', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId: candidate.id, locale }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to generate insight');
      }

      const data = await response.json();

      // 砖专转 拽住 驻转转 
      setInsightText(data.insight);
      setIsInsightDialogOpen(true);
    } catch (error: any) {
      console.error('Error generating insight:', error);
      toast.error(
        locale === 'he' ? '砖 爪专转 ' : 'Error generating report'
      );
    } finally {
      setIsGeneratingInsight(false);
    }
  };

  const copyInsightToClipboard = () => {
    if (!insightText) return;
    navigator.clipboard.writeText(insightText);
    toast.success(locale === 'he' ? '注转拽 ' : 'Copied to clipboard');
  };

  // 注转 转转
  const handleImageUpload = async (files: File[]) => {
    if (!candidate) return;
    setIsUploading(true);
    const uploadPromises = files.map(async (file) => {
      const formData = new FormData();
      formData.append('image', file);
      formData.append('userId', candidate.id);
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/images`,
        { method: 'POST', body: formData }
      );
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(
          `砖 注转 拽抓 ${file.name}: ${data.error || '砖转 砖专转'}`
        );
      }
      return data.image;
    });
    try {
      const newImages = await Promise.all(uploadPromises);
      setImages((prev) => [...prev, ...newImages]);
      toast.success(
        newImages.length > 1
          ? dict.toasts.uploadSuccessMultiple.replace(
              '{{count}}',
              String(newImages.length)
            )
          : dict.toasts.uploadSuccessSingle
      );
    } catch (error) {
      console.error('Error uploading images:', error);
      toast.error(
        `${dict.toasts.uploadError}: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    } finally {
      setIsUploading(false);
    }
  };

  // 专转 转 专砖转
  const handleSetMainImage = async (imageId: string) => {
    if (!candidate) return;
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/images/${imageId}/main`,
        { method: 'PATCH' }
      );
      const data = await response.json();
      if (!response.ok || !data.success)
        throw new Error(data.error || 'Failed to set main image');
      setImages((prev) =>
        prev.map((img) => ({ ...img, isMain: img.id === imageId }))
      );
      toast.success(dict.toasts.setMainSuccess);
    } catch (error) {
      console.error('Error setting main image:', error);
      toast.error(dict.toasts.setMainError);
    }
  };

  // 拽转 转
  const handleDeleteImage = async (imageIds: string[]) => {
    if (!candidate || imageIds.length === 0) return;
    setIsUploading(true);
    try {
      const currentMainImage = images.find((img) => img.isMain);
      const isMainImageBeingDeleted = currentMainImage
        ? imageIds.includes(currentMainImage.id)
        : false;
      const deletePromises = imageIds.map((id) =>
        fetch(`/api/matchmaker/candidates/${candidate.id}/images/${id}`, {
          method: 'DELETE',
        })
      );
      const responses = await Promise.all(deletePromises);
      for (const response of responses) {
        if (!response.ok && response.status !== 204) {
          const errorData = await response.json().catch(() => null);
          throw new Error(
            errorData?.error ||
              `Error deleting one of the images (status: ${response.status})`
          );
        }
      }
      const remainingImages = images.filter(
        (img) => !imageIds.includes(img.id)
      );
      if (isMainImageBeingDeleted && remainingImages.length > 0) {
        setImages(remainingImages);
        await handleSetMainImage(remainingImages[0].id);
      } else {
        setImages(remainingImages);
      }
      toast.success(
        imageIds.length > 1
          ? dict.toasts.deleteImageSuccessMultiple.replace(
              '{{count}}',
              String(imageIds.length)
            )
          : dict.toasts.deleteImageSuccessSingle,
        { position: 'top-center' }
      );
    } catch (error) {
      console.error('Error deleting image(s):', error);
      toast.error(
        error instanceof Error ? error.message : dict.toasts.deleteImageError
      );
    } finally {
      setIsUploading(false);
    }
  };

  // 拽转 注 (爪转转)
  const handleDeleteCandidateRequest = async () => {
    if (!candidate) return;
    if (deleteCandidateConfirmText !== DELETE_CANDIDATE_CONFIRMATION_PHRASE) {
      toast.error(dict.toasts.deleteCandidateErrorConfirmation, {
        description: dict.toasts.deleteCandidateErrorDescription.replace(
          '{{phrase}}',
          DELETE_CANDIDATE_CONFIRMATION_PHRASE
        ),
      });
      return;
    }
    setIsDeletingCandidate(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}`,
        { method: 'DELETE' }
      );
      const data = await response.json();
      if (!response.ok || !data.success)
        throw new Error(data.error || 'Failed to delete candidate profile');
      toast.success(dict.toasts.deleteCandidateSuccess, {
        position: 'top-center',
        duration: 3000,
      });
      if (onCandidateDeleted) onCandidateDeleted(candidate.id);
      setIsDeleteCandidateDialogOpen(false);
      onClose();
    } catch (error) {
      console.error('Error deleting candidate:', error);
      toast.error(
        `${dict.toasts.deleteCandidateError}: ${error instanceof Error ? error.message : 'Unknown error'}`,
        { duration: 5000 }
      );
    } finally {
      setIsDeletingCandidate(false);
    }
  };

  // 砖转  爪专驻转
  const handleSendSetupInvite = async () => {
    if (!candidate || !inviteEmail) {
      toast.error(dict.toasts.sendInviteErrorEmail);
      return;
    }
    setIsSendingInvite(true);
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/invite-setup`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: inviteEmail }),
        }
      );
      const result = await response.json();
      if (!response.ok || !result.success)
        throw new Error(result.error || dict.toasts.sendInviteErrorGeneral);
      toast.success(dict.toasts.sendInviteSuccess);
      setIsSetupInviteOpen(false);
    } catch (error) {
      console.error('Error sending setup invite:', error);
      toast.error(
        error instanceof Error
          ? error.message
          : dict.toasts.sendInviteErrorGeneral
      );
    } finally {
      setIsSendingInvite(false);
    }
  };

  if (!candidate && isOpen) return null;
  if (!candidate) return null;

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent
          className="max-w-5xl max-h-[90vh] p-0 overflow-hidden"
          dir={direction}
        >
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.3 }}
            className="flex flex-col h-full max-h-[90vh]"
          >
            {/* --- HEADER --- */}
            <DialogHeader className="p-6 border-b bg-gradient-to-r from-blue-50/50 to-white flex-shrink-0">
              <div className="flex items-center justify-between gap-4">
                <div className="flex-1 min-w-0">
                  <DialogTitle
                    className={cn(
                      'text-2xl font-bold text-primary/90 flex items-center gap-3',
                      locale === 'he' ? 'text-right' : 'text-left'
                    )}
                  >
                    {dict.header.title
                      .replace(
                        '{{firstName}}',
                        names.firstName || candidate.firstName
                      )
                      .replace(
                        '{{lastName}}',
                        names.lastName || candidate.lastName
                      )}
                  </DialogTitle>
                  <DialogDescription
                    className={cn(
                      'text-gray-500 mt-2 flex flex-col gap-1',
                      locale === 'he' ? 'text-right' : 'text-left'
                    )}
                  >
                    <span className="flex items-center gap-2">
                      <Mail className="w-4 h-4 text-gray-400" />
                      {candidate.email}
                    </span>
                    {userPhone && (
                      <span className="flex items-center gap-2 text-gray-700 font-medium">
                        <Phone className="w-4 h-4 text-green-600" />
                        <span dir="ltr">{userPhone}</span>
                      </span>
                    )}
                  </DialogDescription>
                </div>

                {/* 专 驻注转 爪 砖/ (转 砖驻) - 砖专 住专 */}
                <div className="flex items-center gap-2 shrink-0 self-start">
                  {isSaving && (
                    <div className="hidden sm:flex items-center bg-blue-50 text-blue-700 py-1 px-3 rounded-full text-sm border border-blue-100 shadow-sm">
                      <Loader2 className="w-3 h-3 animate-spin mr-2" />
                      {dict.header.saving}
                    </div>
                  )}

                  {/* 驻转专 -X 砖 */}
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={onClose}
                    disabled={isSaving}
                    className="h-10 w-10 rounded-full hover:bg-gray-100/80 transition-colors -mr-2 sm:mr-0"
                    title={dict.footer.buttons.close || '住专'}
                  >
                    <X className="w-6 h-6 text-gray-500" />
                  </Button>
                </div>
              </div>
            </DialogHeader>

            {/* --- BODY (Loading State or Content) --- */}
            {isLoading && !profile ? (
              <div className="flex items-center justify-center h-64 flex-1">
                <Loader2 className="w-10 h-10 animate-spin text-primary" />
              </div>
            ) : (
              <>
                {/* --- TABS --- */}
                <Tabs
                  value={activeTab}
                  onValueChange={setActiveTab}
                  className="flex-1 flex flex-col min-h-0"
                >
                  <div className="px-6 pt-4 flex-shrink-0">
                    <TabsList className="w-full bg-muted/30 p-1 rounded-xl shadow-sm">
                      <TabsTrigger
                        value="profile"
                        className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                      >
                        <UserCog className="w-4 h-4" />
                        {dict.tabs.profile}
                      </TabsTrigger>
                      <TabsTrigger
                        value="photos"
                        className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                      >
                        <ImageIcon className="w-4 h-4" />
                        {dict.tabs.photos}
                      </TabsTrigger>
                      <TabsTrigger
                        value="preferences"
                        className="rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500/90 data-[state=active]:to-blue-600 data-[state=active]:text-white flex items-center gap-2"
                      >
                        <Sliders className="w-4 h-4" />
                        {dict.tabs.preferences}
                      </TabsTrigger>
                    </TabsList>
                  </div>

                  <div className="flex-1 overflow-hidden flex flex-col min-h-0">
                    <TabsContent
                      value="profile"
                      className="flex-1 overflow-auto p-4 m-0 pb-16"
                    >
                      {profile ? (
                        <div className="space-y-6">
                          {/* --- Basic Info Card (Names) --- */}
                          <Card className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <CardHeader className="bg-gray-50/50 pb-4">
                              <CardTitle className="text-lg flex items-center gap-2">
                                <UserCog className="w-5 h-5 text-gray-600" />
                                {locale === 'he'
                                  ? '驻专 砖 住住'
                                  : 'Basic Information'}
                              </CardTitle>
                            </CardHeader>
                            <CardContent className="pt-4 grid grid-cols-2 gap-4">
                              <div className="space-y-2">
                                <Label>
                                  {locale === 'he' ? '砖 驻专' : 'First Name'}
                                </Label>
                                <Input
                                  value={names.firstName}
                                  onChange={(e) =>
                                    setNames((prev) => ({
                                      ...prev,
                                      firstName: e.target.value,
                                    }))
                                  }
                                />
                              </div>
                              <div className="space-y-2">
                                <Label>
                                  {locale === 'he' ? '砖 砖驻' : 'Last Name'}
                                </Label>
                                <Input
                                  value={names.lastName}
                                  onChange={(e) =>
                                    setNames((prev) => ({
                                      ...prev,
                                      lastName: e.target.value,
                                    }))
                                  }
                                />
                              </div>
                            </CardContent>
                            <CardFooter className="bg-gray-50/30 flex justify-end py-3">
                              <Button
                                size="sm"
                                onClick={() =>
                                  handleProfileUpdate({
                                    firstName: names.firstName,
                                    lastName: names.lastName,
                                  })
                                }
                                disabled={isSaving}
                                className="bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 shadow-sm"
                              >
                                {isSaving ? (
                                  <Loader2 className="w-4 h-4 animate-spin ml-2" />
                                ) : (
                                  <Save className="w-4 h-4 ml-2" />
                                )}
                                {locale === 'he' ? '砖专 砖转' : 'Save Names'}
                              </Button>
                            </CardFooter>
                          </Card>

                          {/* --- NeshamaTech Summary Card --- */}
                          <Card className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <div className="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                            <CardHeader className="bg-slate-50/50 pb-4">
                              <div className="flex justify-between items-start">
                                <div>
                                  <CardTitle className="flex items-center gap-2 text-lg">
                                    <Award className="w-5 h-5 text-indigo-600" />
                                    {dict.neshamaTechSummary.title}
                                  </CardTitle>
                                  <CardDescription className="mt-1">
                                    {dict.neshamaTechSummary.description}
                                  </CardDescription>
                                </div>
                                <Button
                                  size="sm"
                                  onClick={handleGenerateSummary}
                                  disabled={isGeneratingSummary || isSaving}
                                  className="bg-white hover:bg-gray-50 text-indigo-600 border border-indigo-200 shadow-sm hover:shadow transition-all"
                                >
                                  {isGeneratingSummary ? (
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                  ) : (
                                    <Sparkles className="w-4 h-4 mr-2" />
                                  )}
                                  {isGeneratingSummary
                                    ? dict.neshamaTechSummary.aiButtonLoading
                                    : dict.neshamaTechSummary.aiButton}
                                </Button>
                              </div>
                            </CardHeader>
                            <CardContent className="pt-4">
                              <Textarea
                                value={profile.manualEntryText || ''}
                                onChange={(e) =>
                                  setProfile((p) =>
                                    p
                                      ? {
                                          ...p,
                                          manualEntryText: e.target.value,
                                        }
                                      : null
                                  )
                                }
                                placeholder={
                                  dict.neshamaTechSummary.placeholder
                                }
                                rows={6}
                                className="min-h-[120px] focus-visible:ring-indigo-500"
                              />
                            </CardContent>

                            {/* Footer with Save and Insight Button */}
                            <CardFooter className="flex justify-between pt-2 pb-4 bg-slate-50/30">
                              {/* 驻转专 转 砖 (拽住) */}
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={handleGenerateInsightText}
                                disabled={isGeneratingInsight}
                                className="border-indigo-200 text-indigo-700 hover:bg-indigo-50 gap-2"
                              >
                                {isGeneratingInsight ? (
                                  <Loader2 className="w-4 h-4 animate-spin" />
                                ) : (
                                  <FileText className="w-4 h-4" />
                                )}
                                {isGeneratingInsight
                                  ? locale === 'he'
                                    ? '转 转...'
                                    : 'Analyzing...'
                                  : locale === 'he'
                                    ? '转 注拽 砖'
                                    : 'Deep Personal Analysis'}
                              </Button>

                              {/* 驻转专 砖专 */}
                              <Button
                                size="sm"
                                onClick={() =>
                                  handleProfileUpdate({
                                    manualEntryText:
                                      profile.manualEntryText || null,
                                  })
                                }
                                disabled={isSaving || isGeneratingSummary}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white shadow-md transition-transform active:scale-95"
                              >
                                {isSaving ? (
                                  <Loader2 className="w-4 h-4 ml-2 animate-spin" />
                                ) : (
                                  <Save className="w-4 h-4 ml-2" />
                                )}
                                {isSaving
                                  ? dict.neshamaTechSummary.saveButtonLoading ||
                                    '砖专...'
                                  : dict.neshamaTechSummary.saveButton ||
                                    '砖专 转拽爪专'}
                              </Button>
                            </CardFooter>
                          </Card>

                          {/* --- Conversation Summary Card --- */}
                          <Card className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <div className="h-1 bg-gradient-to-r from-blue-500 to-cyan-500"></div>
                            <CardHeader className="bg-blue-50/30 pb-4">
                              <div className="flex justify-between items-start">
                                <div>
                                  <CardTitle className="flex items-center gap-2 text-lg text-blue-900">
                                    <MessageSquare className="w-5 h-5 text-blue-600" />
                                    {dict.conversationSummary?.title ||
                                      '住 砖 注 砖'}
                                  </CardTitle>
                                  <CardDescription className="mt-1 text-blue-800/70">
                                    {dict.conversationSummary?.description ||
                                      ' 转 转注 注专转 驻转 住 砖转 注 注/转.'}
                                  </CardDescription>
                                </div>
                              </div>
                            </CardHeader>
                            <CardContent className="pt-4">
                              <Textarea
                                value={profile.conversationSummary || ''}
                                onChange={(e) =>
                                  setProfile((p) =>
                                    p
                                      ? {
                                          ...p,
                                          conversationSummary: e.target.value,
                                        }
                                      : null
                                  )
                                }
                                placeholder={
                                  dict.conversationSummary?.placeholder ||
                                  '拽/  转 住 砖...'
                                }
                                rows={5}
                                className="min-h-[100px] border-blue-200 focus-visible:ring-blue-500 bg-blue-50/10"
                              />
                            </CardContent>
                            <CardFooter className="flex justify-end pt-2 pb-4 bg-blue-50/20">
                              <Button
                                size="sm"
                                onClick={() =>
                                  handleProfileUpdate({
                                    conversationSummary:
                                      profile.conversationSummary || null,
                                  })
                                }
                                disabled={isSaving || isGeneratingSummary}
                                className="bg-blue-600 hover:bg-blue-700 text-white shadow-md transition-transform active:scale-95"
                              >
                                {isSaving ? (
                                  <Loader2 className="w-4 h-4 ml-2 animate-spin" />
                                ) : (
                                  <Save className="w-4 h-4 ml-2" />
                                )}
                                {isSaving
                                  ? dict.conversationSummary
                                      ?.saveButtonLoading || '砖专...'
                                  : dict.conversationSummary?.saveButton ||
                                    '砖专 住 砖'}
                              </Button>
                            </CardFooter>
                          </Card>

                          {/* --- Main Profile Section --- */}
                          <div className="bg-white rounded-xl shadow-sm border p-1">
                            <ProfileSection
                              profile={profile}
                              isEditing={isEditing}
                              setIsEditing={setIsEditing}
                              onSave={handleProfileUpdate}
                              dict={profileDict.profileSection}
                              locale={locale}
                            />
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center justify-center h-full">
                          <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
                        </div>
                      )}
                    </TabsContent>

                    <TabsContent
                      value="photos"
                      className="flex-1 overflow-auto p-4 m-0 pb-16"
                    >
                      <div className="bg-white rounded-xl shadow-sm border">
                        <PhotosSection
                          images={images}
                          isUploading={isUploading}
                          disabled={isSaving || isDeletingCandidate}
                          onUpload={handleImageUpload}
                          onSetMain={handleSetMainImage}
                          onDelete={handleDeleteImage}
                          maxImages={10}
                          dict={profileDict.photosSection}
                          locale={locale}
                        />
                      </div>
                    </TabsContent>

                    <TabsContent
                      value="preferences"
                      className="flex-1 overflow-auto p-4 m-0 pb-16"
                    >
                      {profile ? (
                        <div className="bg-white rounded-xl shadow-sm border">
                          <PreferencesSection
                            profile={profile}
                            isEditing={isEditing}
                            setIsEditing={setIsEditing}
                            onChange={handleProfileUpdate}
                            dictionary={profileDict.preferencesSection}
                            locale={locale}
                          />
                        </div>
                      ) : (
                        <div className="flex items-center justify-center h-full">
                          <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
                        </div>
                      )}
                    </TabsContent>
                  </div>
                </Tabs>

                {/* --- FOOTER --- */}
                <div className="p-4 border-t flex justify-between items-center mt-auto bg-white/95 backdrop-blur-sm sticky bottom-0 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex-shrink-0">
                  <div>
                    <span className="text-sm text-muted-foreground hidden sm:inline-block">
                      {activeTab === 'profile'
                        ? dict.footer.tabInfo.profile
                        : activeTab === 'photos'
                          ? dict.footer.tabInfo.photos
                          : dict.footer.tabInfo.preferences}
                    </span>
                  </div>
                  <div className="flex items-center gap-3">
                    <Button
                      variant="outline"
                      onClick={() => setIsSetupInviteOpen(true)}
                      disabled={
                        isSaving || isDeletingCandidate || isSendingInvite
                      }
                      className="border-indigo-200 text-indigo-700 hover:bg-indigo-50"
                    >
                      <Send
                        className={cn(
                          'w-4 h-4',
                          locale === 'he' ? 'ml-2' : 'mr-2'
                        )}
                      />
                      {dict.footer.buttons.sendInvite}
                    </Button>
                    {isAdmin && (
                      <Button
                        variant="destructive"
                        onClick={() => setIsDeleteCandidateDialogOpen(true)}
                        disabled={
                          isSaving || isUploading || isDeletingCandidate
                        }
                        size="sm"
                      >
                        <Trash2
                          className={cn(
                            'w-4 h-4',
                            locale === 'he' ? 'ml-2' : 'mr-2'
                          )}
                        />
                        {dict.footer.buttons.deleteCandidate}
                      </Button>
                    )}
                    <Button
                      variant="outline"
                      onClick={onClose}
                      disabled={isSaving || isDeletingCandidate}
                      className="bg-gray-100 hover:bg-gray-200 transition-colors shadow-sm text-gray-700"
                      size="sm"
                    >
                      <X className="w-4 h-4 mr-2" />
                      {dict.footer.buttons.close}
                    </Button>
                  </div>
                </div>
              </>
            )}
          </motion.div>
        </DialogContent>
      </Dialog>

      {/* --- NEW: Insight Text Dialog --- */}
      <Dialog open={isInsightDialogOpen} onOpenChange={setIsInsightDialogOpen}>
        <DialogContent
          className="max-w-3xl max-h-[85vh] flex flex-col p-0 overflow-hidden"
          dir={direction}
        >
          <DialogHeader className="p-6 border-b bg-gradient-to-r from-indigo-50 to-purple-50">
            <DialogTitle className="flex items-center gap-2 text-xl text-indigo-800">
              <Sparkles className="w-5 h-5 text-indigo-600" />
              {locale === 'he'
                ? `转 注拽 砖 - ${candidate?.firstName}`
                : `Deep Personal Analysis - ${candidate?.firstName}`}
            </DialogTitle>
            <DialogDescription className="text-indigo-600/80">
              {locale === 'he'
                ? ' 转转 注拽 住住 注 转 驻专驻 砖'
                : 'Deep insight report based on profile and questionnaire data'}
            </DialogDescription>
          </DialogHeader>

          <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
            <div className="bg-white p-6 rounded-lg border shadow-sm text-gray-800 whitespace-pre-wrap leading-relaxed text-sm sm:text-base font-sans">
              {insightText}
            </div>
          </div>

          <DialogFooter className="p-4 border-t bg-white gap-2 sm:gap-0">
            <Button
              variant="outline"
              onClick={copyInsightToClipboard}
              className="gap-2"
            >
              <Copy className="w-4 h-4" />
              {locale === 'he' ? '注转拽 拽住' : 'Copy Text'}
            </Button>
            <Button
              onClick={() => setIsInsightDialogOpen(false)}
              className="bg-indigo-600 hover:bg-indigo-700"
            >
              {locale === 'he' ? '住专' : 'Close'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* --- Invite Dialog --- */}
      {candidate && (
        <Dialog open={isSetupInviteOpen} onOpenChange={setIsSetupInviteOpen}>
          <DialogContent className="sm:max-w-md" dir={direction}>
            <DialogHeader>
              <DialogTitle>{dict.inviteDialog.title}</DialogTitle>
              <DialogDescription>
                {dict.inviteDialog.description.replace(
                  '{{fullName}}',
                  `${candidate.firstName} ${candidate.lastName}`
                )}
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <Label
                htmlFor="inviteEmail"
                className={cn(locale === 'he' ? 'text-right' : 'text-left')}
              >
                {dict.inviteDialog.emailLabel}
              </Label>
              <Input
                id="inviteEmail"
                type="email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                placeholder={dict.inviteDialog.emailPlaceholder}
                className="col-span-3"
                dir="ltr"
              />
            </div>
            <DialogFooter>
              <DialogClose asChild>
                <Button
                  type="button"
                  variant="secondary"
                  disabled={isSendingInvite}
                >
                  {dict.inviteDialog.buttons.cancel}
                </Button>
              </DialogClose>
              <Button
                type="button"
                onClick={handleSendSetupInvite}
                disabled={isSendingInvite || !inviteEmail}
              >
                {isSendingInvite ? (
                  <Loader2 className="ml-2 h-4 w-4 animate-spin" />
                ) : (
                  <Send
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                  />
                )}
                {isSendingInvite
                  ? dict.inviteDialog.buttons.sending
                  : dict.inviteDialog.buttons.send}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}

      {/* --- Delete Confirmation Dialog --- */}
      {candidate && (
        <Dialog
          open={isDeleteCandidateDialogOpen}
          onOpenChange={(open) =>
            !isDeletingCandidate && setIsDeleteCandidateDialogOpen(open)
          }
        >
          <DialogContent className="sm:max-w-md">
            <DialogHeader>
              <DialogTitle className="text-xl flex items-center gap-2 text-red-600">
                <AlertCircle className="h-5 w-5" />
                {dict.deleteDialog.title}
              </DialogTitle>
              <DialogDescription>
                {dict.deleteDialog.description.replace(
                  '{{fullName}}',
                  `${candidate.firstName} ${candidate.lastName}`
                )}{' '}
                {dict.deleteDialog.irreversible}
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <Label htmlFor="deleteCandidateConfirm" className="text-gray-700">
                {dict.deleteDialog.confirmationLabel.replace(
                  '{{phrase}}',
                  DELETE_CANDIDATE_CONFIRMATION_PHRASE
                )}
              </Label>
              <Input
                id="deleteCandidateConfirm"
                value={deleteCandidateConfirmText}
                onChange={(e) => setDeleteCandidateConfirmText(e.target.value)}
                disabled={isDeletingCandidate}
                className="border-gray-300 focus:border-red-500"
                placeholder={dict.deleteDialog.inputPlaceholder}
                dir="rtl"
              />
              {deleteCandidateConfirmText &&
                deleteCandidateConfirmText !==
                  DELETE_CANDIDATE_CONFIRMATION_PHRASE && (
                  <p className="text-xs text-red-600">
                    {dict.deleteDialog.mismatchError}
                  </p>
                )}
            </div>
            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => {
                  setIsDeleteCandidateDialogOpen(false);
                  setDeleteCandidateConfirmText('');
                }}
                disabled={isDeletingCandidate}
                className="border-gray-300"
              >
                {dict.deleteDialog.buttons.cancel}
              </Button>
              <Button
                variant="destructive"
                onClick={handleDeleteCandidateRequest}
                disabled={
                  isDeletingCandidate ||
                  deleteCandidateConfirmText !==
                    DELETE_CANDIDATE_CONFIRMATION_PHRASE
                }
              >
                {isDeletingCandidate ? (
                  <span className="flex items-center gap-2">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    {dict.deleteDialog.buttons.deleting}
                  </span>
                ) : (
                  <>
                    <Trash2 className="w-4 h-4 mr-2" />
                    {dict.deleteDialog.buttons.delete}
                  </>
                )}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </>
  );
};

export default MatchmakerEditProfile;
--- End of Content for MatchmakerEditProfile.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\ProfileSummaryDisplay.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/ProfileSummaryDisplay.tsx
'use client';

import React from 'react';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from '@/components/ui/card';
import { User, Target } from 'lucide-react';
import { AiProfileSummaryResult } from '@/lib/services/aiService';

// 专  转 驻住  住驻爪驻 砖 拽驻 
// ( 住祝 转  拽抓 驻住 专砖 砖 砖)
export interface ProfileSummaryDisplayDict {
  personalityTitle: string;
  personalityDescription: string;
  lookingForTitle: string;
  lookingForDescription: string;
}

interface ProfileSummaryDisplayProps {
  summary: AiProfileSummaryResult;
  dict: ProfileSummaryDisplayDict;
  locale: string;
}

const ProfileSummaryDisplay: React.FC<ProfileSummaryDisplayProps> = ({
  summary,
  dict,
  locale,
}) => {
  const direction = locale === 'he' ? 'rtl' : 'ltr';

  return (
    <div dir={direction} className="w-full space-y-6">
      {/* 专住 住 砖转 */}
      <Card className="bg-blue-50/30 border-blue-100">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-lg text-blue-900">
            <User className="w-5 h-5 text-blue-600" />
            {dict.personalityTitle}
          </CardTitle>
          <CardDescription>
            {dict.personalityDescription}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-slate-800 whitespace-pre-wrap leading-relaxed">
            {summary.personalitySummary}
          </p>
        </CardContent>
      </Card>

      {/* 专住  驻砖/转 */}
      <Card className="bg-purple-50/30 border-purple-100">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-lg text-purple-900">
            <Target className="w-5 h-5 text-purple-600" />
            {dict.lookingForTitle}
          </CardTitle>
          <CardDescription>
            {dict.lookingForDescription}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-slate-800 whitespace-pre-wrap leading-relaxed">
            {summary.lookingForSummary}
          </p>
        </CardContent>
      </Card>
    </div>
  );
};

export default ProfileSummaryDisplay;
--- End of Content for ProfileSummaryDisplay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\new_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\Actions.tsx
--------------------------------------------------------------------------------
Content:
// /components/matchmaker/CandidateCard/Actions.tsx

'use client';

import React, {useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  Eye,
  Sparkles,
  Send,
  MessageCircle,
  Calendar,
  Star,
  Zap,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface ActionsProps {
  candidate: Candidate;
  onInvite: (candidate: Candidate) => void;
  onSuggest: (candidate: Candidate) => void;
  onCheckAvailability: (candidate: Candidate) => void;
  onViewProfile: (candidate: Candidate) => void;
  className?: string;
  variant?: 'full' | 'compact' | 'minimal';
  showLabels?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['cardActions'];
}

const Actions: React.FC<ActionsProps> = ({
  candidate,
  onInvite,
  onSuggest,
  onCheckAvailability,
  onViewProfile,
  className,
  variant = 'full',
  showLabels = true,
  dict,
}) => {
  const [isHovered, setIsHovered] = useState(false);
  const [activeAction, setActiveAction] = useState<string | null>(null);

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
  };

  const handleActionClick = (action: string, callback: () => void) => {
    setActiveAction(action);
    callback();
    setTimeout(() => setActiveAction(null), 150);
  };

  const getPriorityBadge = () => {
    if (candidate.profile.availabilityStatus === 'AVAILABLE') {
      return (
        <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-lg animate-pulse">
          <Sparkles className="w-3 h-3 mr-1" />
          {dict.availableNow}
        </Badge>
      );
    }
    return null;
  };

  const actionButtons = [
    {
      id: 'view',
      label: dict.viewProfile,
      icon: Eye,
      onClick: () => onViewProfile(candidate),
      gradient: 'from-blue-500 to-cyan-500',
      hoverGradient: 'from-blue-600 to-cyan-600',
      description: dict.viewProfileTooltip,
      primary: true,
    },
    {
      id: 'suggest',
      label: dict.suggestMatch,
      icon: Heart,
      onClick: () => onSuggest(candidate),
      gradient: 'from-pink-500 to-rose-500',
      hoverGradient: 'from-pink-600 to-rose-600',
      description: dict.suggestMatchTooltip,
      primary: true,
    },
    {
      id: 'invite',
      label: dict.sendInvite,
      icon: Send,
      onClick: () => onInvite(candidate),
      gradient: 'from-purple-500 to-indigo-500',
      hoverGradient: 'from-purple-600 to-indigo-600',
      description: dict.sendInviteTooltip,
      primary: false,
    },
    {
      id: 'availability',
      label: dict.checkAvailability,
      icon: Calendar,
      onClick: () => onCheckAvailability(candidate),
      gradient: 'from-orange-500 to-amber-500',
      hoverGradient: 'from-orange-600 to-amber-600',
      description: dict.checkAvailabilityTooltip,
      primary: false,
    },
  ];

  if (variant === 'minimal') {
    return (
      <div
        className={cn('flex items-center gap-1', className)}
        onClick={handleClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
      >
        <TooltipProvider>
          {actionButtons.slice(0, 2).map((action) => {
            const IconComponent = action.icon;
            return (
              <Tooltip key={action.id}>
                <TooltipTrigger asChild>
                  <Button
                    variant="ghost"
                    size="icon"
                    className={cn(
                      'h-8 w-8 rounded-full transition-all duration-300 transform hover:scale-110',
                      `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                      'text-white shadow-lg hover:shadow-xl',
                      activeAction === action.id && 'scale-95'
                    )}
                    onClick={() => handleActionClick(action.id, action.onClick)}
                  >
                    <IconComponent className="w-4 h-4" />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{action.description}</p>
                </TooltipContent>
              </Tooltip>
            );
          })}
        </TooltipProvider>
      </div>
    );
  }

  if (variant === 'compact') {
    return (
      <div
        className={cn('flex flex-wrap gap-2', className)}
        onClick={handleClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
      >
        {getPriorityBadge()}

        <div className="flex gap-2">
          {actionButtons.map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                variant="outline"
                size="sm"
                className={cn(
                  'transition-all duration-300 transform hover:scale-105 border-0 shadow-lg hover:shadow-xl',
                  `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                  'text-white font-medium',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <IconComponent className="w-4 h-4 mr-2" />
                {showLabels && action.label}
              </Button>
            );
          })}
        </div>
      </div>
    );
  }

  // Full variant
  return (
    <div
      className={cn('space-y-4', className)}
      onClick={handleClick}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <div className="flex justify-center">{getPriorityBadge()}</div>

      <div className="grid grid-cols-2 gap-3">
        {actionButtons
          .filter((a) => a.primary)
          .map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                className={cn(
                  'h-12 transition-all duration-300 transform hover:scale-105 border-0 shadow-xl hover:shadow-2xl font-bold text-sm',
                  `bg-gradient-to-r ${action.gradient} hover:${action.hoverGradient}`,
                  'text-white relative overflow-hidden group',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                <div className="relative z-10 flex items-center justify-center gap-2">
                  <IconComponent className="w-5 h-5" />
                  {showLabels && (
                    <span className="hidden sm:inline">{action.label}</span>
                  )}
                </div>
              </Button>
            );
          })}
      </div>

      <div className="flex gap-2">
        {actionButtons
          .filter((a) => !a.primary)
          .map((action) => {
            const IconComponent = action.icon;
            return (
              <Button
                key={action.id}
                variant="outline"
                size="sm"
                className={cn(
                  'flex-1 transition-all duration-300 transform hover:scale-105 border-2 hover:border-transparent shadow-lg hover:shadow-xl font-medium',
                  `border-gray-200 hover:bg-gradient-to-r hover:${action.gradient}`,
                  'hover:text-white group relative overflow-hidden',
                  activeAction === action.id && 'scale-95'
                )}
                onClick={() => handleActionClick(action.id, action.onClick)}
              >
                <div
                  className={cn(
                    'absolute inset-0 bg-gradient-to-r transition-all duration-300 opacity-0 group-hover:opacity-100',
                    action.gradient
                  )}
                ></div>
                <div className="relative z-10 flex items-center justify-center gap-2">
                  <IconComponent className="w-4 h-4" />
                  {showLabels && (
                    <span className="text-xs hidden sm:inline">
                      {action.label}
                    </span>
                  )}
                </div>
              </Button>
            );
          })}
      </div>

      <div className="flex justify-center pt-2">
        <Button
          variant="ghost"
          size="sm"
          className={cn(
            'text-red-500 hover:text-red-600 hover:bg-red-50 transition-all duration-300 transform hover:scale-110 group',
            'border border-red-200 hover:border-red-300 shadow-sm hover:shadow-md rounded-full px-4'
          )}
        >
          <Heart
            className={cn(
              'w-4 h-4 transition-all duration-300',
              isHovered && 'fill-current animate-pulse'
            )}
          />
          <span className="mr-2 text-sm font-medium">{dict.addToFavorites}</span>
        </Button>
      </div>

      <div className="pt-3 border-t border-gray-100">
        <div className="flex justify-between items-center text-xs text-gray-500">
          <div className="flex items-center gap-1">
            <Star className="w-3 h-3 text-yellow-500" />
            <span>{dict.rating}: 4.8</span>
          </div>
          <div className="flex items-center gap-1">
            <Zap className="w-3 h-3 text-blue-500" />
            <span>{dict.matchScore}: 95%</span>
          </div>
          <div className="flex items-center gap-1">
            <MessageCircle className="w-3 h-3 text-green-500" />
            <span>{dict.response}: {dict.quickResponse}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Actions;
--- End of Content for Actions.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\MinimalCard.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/CandidateCard/MinimalCard.tsx

'use client';

import React, { useState } from 'react';
import Image from 'next/image';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { format } from 'date-fns';
import {
  User,
  MapPin,
  MessageCircle,
  Briefcase,
  Calendar,
  Edit2,
  Sparkles,
  Star,
  Heart,
  Clock,
  Users,
  Zap,
  Award,
  MoreHorizontal,
  Mail,
  Ruler,
  Languages,
  Scroll,
  Globe,
  AlertTriangle,
  CheckCircle,
  Info,
  Brain,
  MessageSquare,
  X,
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import type { Candidate } from '../types/candidates';
import { UserSource } from '@prisma/client';
import { motion } from 'framer-motion';
import { Skeleton } from '@/components/ui/skeleton';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import { RELIGIOUS_LEVELS } from '../constants/filterOptions';

// ============================================================================
// TYPES
// ============================================================================

// 驻住 驻专 爪
interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

interface MinimalCandidateCardProps {
  candidate: Candidate & {
    // 砖转 AI Matching
    aiScore?: number;
    aiReasoning?: string;
    aiRank?: number;
    aiFirstPassScore?: number;
    aiScoreBreakdown?: ScoreBreakdown;
    aiBackgroundMultiplier?: number;
    aiBackgroundCompatibility?:
      | 'excellent'
      | 'good'
      | 'possible'
      | 'problematic'
      | 'not_recommended';
    //  砖转 Vector Search
    aiSimilarity?: number;
  };
  onClick: (candidate: Candidate) => void;
  onEdit?: (candidate: Candidate, e: React.MouseEvent) => void;
  onAnalyze?: (candidate: Candidate, e: React.MouseEvent) => void;
  onSendProfileFeedback?: (candidate: Candidate, e: React.MouseEvent) => void;
  isHighlighted?: boolean;
  highlightTerm?: string;
  className?: string;
  aiScore?: number;
  isAiTarget?: boolean;
  onSetAiTarget?: (candidate: Candidate, e: React.MouseEvent) => void;
  isSelectableForComparison?: boolean;
  isSelectedForComparison?: boolean;
  onToggleComparison?: (candidate: Candidate, e: React.MouseEvent) => void;
  aiTargetName?: string; // 砖  砖爪注转 注专 转
  dict: MatchmakerPageDictionary['candidatesManager']['list']['minimalCard'] & {
    heightUnit?: string;
    languagesLabel?: string;
  };
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

const calculateAge = (birthDate: Date | string): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

// 驻拽爪转 注专 爪注 驻 转转 专拽注
const getBackgroundBadge = (compatibility?: string) => {
  switch (compatibility) {
    case 'excellent':
      return {
        color: 'bg-green-100 text-green-700 border-green-200',
        icon: CheckCircle,
        label: '专拽注 爪',
      };
    case 'good':
      return {
        color: 'bg-blue-100 text-blue-700 border-blue-200',
        icon: CheckCircle,
        label: '专拽注 ',
      };
    case 'possible':
      return {
        color: 'bg-yellow-100 text-yellow-700 border-yellow-200',
        icon: Info,
        label: '专拽注 驻砖专',
      };
    case 'problematic':
      return {
        color: 'bg-orange-100 text-orange-700 border-orange-200',
        icon: AlertTriangle,
        label: '驻注专 专拽注',
      };
    case 'not_recommended':
      return {
        color: 'bg-red-100 text-red-700 border-red-200',
        icon: AlertTriangle,
        label: '专拽注 注转',
      };
    default:
      return null;
  }
};

// ============================================================================
// COMPONENT
// ============================================================================

const MinimalCandidateCard: React.FC<MinimalCandidateCardProps> = ({
  candidate,
  onClick,
  onEdit,
  onAnalyze,
  onSendProfileFeedback,
  isHighlighted = false,
  highlightTerm = '',
  className,
  aiScore,
  isAiTarget = false,
  onSetAiTarget,
  isSelectableForComparison = false,
  isSelectedForComparison = false,
  onToggleComparison,
  aiTargetName,
  dict,
}) => {
  const mainImage = candidate.images.find((img) => img.isMain);
  const age = calculateAge(candidate.profile.birthDate);
  const [imageLoaded, setImageLoaded] = useState(false);
  const [imageError, setImageError] = useState(false);
  const [isHovered, setIsHovered] = useState(false);

  // State 爪转 拽
  const [showReasoning, setShowReasoning] = useState(false);

  // 爪 AI 注 注爪 ( 拽)  -prop
  const effectiveAiScore = candidate.aiScore ?? aiScore;
  const hasAiData = typeof effectiveAiScore === 'number';

  //  拽   转爪转 Vector Search
  const isVectorResult = typeof candidate.aiSimilarity === 'number';

  const getReligiousLabel = (value: string | null | undefined) => {
    if (!value) return null;
    const option = RELIGIOUS_LEVELS.find((opt) => opt.value === value);
    return option ? option.label : value;
  };

  const highlightText = (text: string | undefined | null): React.ReactNode => {
    if (!highlightTerm || !text) return text;
    const parts = text.split(new RegExp(`(${highlightTerm})`, 'gi'));
    return (
      <>
        {parts.map((part, i) =>
          part.toLowerCase() === highlightTerm.toLowerCase() ? (
            <mark key={i} className="bg-yellow-200 px-0.5 rounded-sm">
              {part}
            </mark>
          ) : (
            part
          )
        )}
      </>
    );
  };

  const getAvailabilityBadge = () => {
    switch (candidate.profile.availabilityStatus) {
      case 'AVAILABLE':
        return {
          label: dict.availability.AVAILABLE,
          className:
            'bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 shadow-lg',
          icon: <Sparkles className="w-3 h-3" />,
        };
      case 'DATING':
        return {
          label: dict.availability.DATING,
          className:
            'bg-gradient-to-r from-amber-500 to-orange-500 text-white border-0 shadow-lg',
          icon: <Heart className="w-3 h-3" />,
        };
      case 'UNAVAILABLE':
        return {
          label: dict.availability.UNAVAILABLE,
          className:
            'bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-lg',
          icon: <Clock className="w-3 h-3" />,
        };
      default:
        return {
          label: dict.availability.UNKNOWN,
          className:
            'bg-gradient-to-r from-gray-500 to-slate-500 text-white border-0 shadow-lg',
          icon: <User className="w-3 h-3" />,
        };
    }
  };

  const getQualityScore = () => {
    let score = 0;
    if (candidate.images.length > 0) score += 25;
    if (candidate.profile.about) score += 25;
    if (candidate.profile.education) score += 25;
    if (candidate.profile.occupation) score += 25;
    return score;
  };

  const availabilityBadge = getAvailabilityBadge();
  const isManualEntry = candidate.source === UserSource.MANUAL_ENTRY;
  const qualityScore = getQualityScore();
  // 专 砖专 439:
  // 专转 砖驻转
  const spokenLanguages = (() => {
    const rawLangs = [
      candidate.profile.nativeLanguage,
      ...(candidate.profile.additionalLanguages || []),
    ].filter((l): l is string => !!l); // <--- 转拽: 专转 驻 驻专砖转

    const langMap: Record<string, string> = {
      hebrew: '注专转',
      english: '转',
      russian: '专住转',
      french: '爪专驻转转',
      spanish: '住驻专转',
      amharic: '专转',
      arabic: '注专转',
      german: '专转',
      italian: '拽转',
    };

    const isHebrew =
      dict.heightLabel && /[\u0590-\u05FF]/.test(dict.heightLabel);

    return rawLangs
      .map((lang) => {
        if (isHebrew) {
          return langMap[lang.toLowerCase()] || lang;
        }
        return lang.charAt(0).toUpperCase() + lang.slice(1);
      })
      .join(', ');
  })();
  return (
    <motion.div
      whileHover={{ y: -6, scale: 1.02 }}
      transition={{ type: 'spring', stiffness: 300, damping: 15 }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <Card
        className={cn(
          'relative overflow-hidden cursor-pointer transition-all hover:shadow-2xl duration-500 group border-0 shadow-xl',
          isAiTarget
            ? 'ring-4 ring-green-400 ring-opacity-60 shadow-green-200'
            : isSelectedForComparison
              ? 'ring-4 ring-blue-400 ring-opacity-60 shadow-blue-200'
              : hasAiData
                ? isVectorResult
                  ? 'ring-2 ring-blue-300 ring-opacity-50 shadow-blue-100' //  注爪 砖 -Vector
                  : 'ring-2 ring-teal-300 ring-opacity-50 shadow-teal-100'
                : isHighlighted
                  ? 'ring-2 ring-yellow-400 ring-opacity-60 shadow-yellow-100'
                  : 'shadow-gray-200',
          'bg-gradient-to-br from-white via-gray-50/30 to-white',
          className || ''
        )}
        onClick={() => onClick(candidate)}
      >
        <div className="absolute inset-0 bg-gradient-to-br from-transparent via-white/50 to-transparent opacity-60"></div>

        {/*  Badge 爪 AI 砖驻专 - 转  -Vector  -Algorithmic */}
        {hasAiData && (
          <div className="absolute top-3 left-3 z-30 flex flex-col gap-1">
            {/* Badge 专砖 - 砖 驻 住 驻砖 */}
            <Badge
              className={cn(
                'text-white border-0 shadow-xl px-3 py-1.5 text-sm font-bold flex items-center gap-2',
                isVectorResult
                  ? 'bg-gradient-to-r from-blue-400 via-cyan-500 to-blue-500'
                  : 'bg-gradient-to-r from-teal-400 via-cyan-500 to-blue-500'
              )}
            >
              {isVectorResult ? (
                <Zap className="w-4 h-4" />
              ) : (
                <Brain className="w-4 h-4" />
              )}
              {dict.aiMatch.replace('{{score}}', effectiveAiScore!.toString())}
              {candidate.aiRank && (
                <span className="bg-white/20 px-1.5 py-0.5 rounded text-xs">
                  #{candidate.aiRank}
                </span>
              )}
              {isVectorResult ? (
                <Sparkles className="w-3 h-3" />
              ) : (
                <Zap className="w-3 h-3" />
              )}
            </Badge>

            {/*  Badge  拽专 */}
            {isVectorResult && candidate.aiSimilarity !== undefined && (
              <div className="flex items-center gap-1 px-2 py-1 rounded-full text-xs border shadow-sm bg-blue-50 text-blue-700 border-blue-200">
                <Zap className="w-3 h-3" />
                <span className="font-medium">
                  : {(candidate.aiSimilarity * 100).toFixed(0)}%
                </span>
              </div>
            )}

            {/* Badge 转转 专拽注 */}
            {candidate.aiBackgroundCompatibility &&
              (() => {
                const badge = getBackgroundBadge(
                  candidate.aiBackgroundCompatibility
                );
                if (!badge) return null;
                const IconComponent = badge.icon;
                return (
                  <div
                    className={cn(
                      'flex items-center gap-1 px-2 py-1 rounded-full text-xs border shadow-sm',
                      badge.color
                    )}
                  >
                    <IconComponent className="w-3 h-3" />
                    <span className="font-medium">{badge.label}</span>
                  </div>
                );
              })()}
          </div>
        )}

        <div className="absolute top-3 right-3 z-20 flex flex-col gap-2 items-end">
          <Badge
            className={cn(
              'px-3 py-1.5 text-xs font-bold shadow-lg flex items-center gap-1.5 transition-all duration-300 hover:scale-105',
              availabilityBadge.className
            )}
          >
            {availabilityBadge.icon}
            {availabilityBadge.label}
          </Badge>

          {isManualEntry && (
            <Badge className="px-3 py-1.5 text-xs font-bold shadow-lg bg-gradient-to-r from-purple-500 to-indigo-500 text-white border-0 flex items-center gap-1.5">
              <Edit2 className="w-3 h-3" />
              {dict.manualEntry}
            </Badge>
          )}

          {candidate.profile.testimonials &&
            candidate.profile.testimonials.filter(
              (t) => t.status === 'APPROVED'
            ).length > 0 && (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ delay: 0.2 }}
              >
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger>
                      <Badge className="px-3 py-1.5 text-xs font-bold shadow-lg bg-gradient-to-r from-yellow-400 to-amber-500 text-white border-0 flex items-center gap-1.5">
                        <Users className="w-3 h-3" />
                        {dict.hasTestimonials.replace(
                          '{{count}}',
                          String(
                            candidate.profile.testimonials.filter(
                              (t) => t.status === 'APPROVED'
                            ).length
                          )
                        )}
                      </Badge>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>{dict.testimonialsTooltip}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </motion.div>
            )}
        </div>

        <div className="relative h-52 sm:h-60 bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100">
          {mainImage && !imageError ? (
            <>
              {!imageLoaded && (
                <Skeleton className="absolute inset-0 h-full w-full" />
              )}
              <Image
                src={getRelativeCloudinaryPath(mainImage.url)}
                alt={`${candidate.firstName} ${candidate.lastName}`}
                fill
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                priority={false}
                className={`object-cover transition-all duration-500 ${
                  imageLoaded ? 'opacity-100 scale-100' : 'opacity-0 scale-105'
                } ${isHovered ? 'scale-110' : 'scale-100'}`}
                onLoad={() => setImageLoaded(true)}
                onError={() => setImageError(true)}
              />
              <div className="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/40 to-transparent opacity-80 group-hover:opacity-90 transition-opacity duration-300" />
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
            </>
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100">
              <div className="text-center">
                <User className="w-16 h-16 text-gray-400 mx-auto mb-2" />
                <p className="text-sm text-gray-500">{dict.noImage}</p>
              </div>
            </div>
          )}

          <div className="absolute bottom-0 w-full p-4 text-right">
            <h3 className="font-bold mb-1 text-white drop-shadow-lg text-xl tracking-wide">
              {highlightText(`${candidate.firstName} ${candidate.lastName}`)}
            </h3>
            <div className="flex items-center justify-end gap-3 text-white/95 text-sm">
              <span className="bg-black/30 px-2 py-1 rounded-full backdrop-blur-sm font-medium">
                {age} {dict.yearsSuffix}
              </span>
              <Calendar className="w-4 h-4" />
            </div>
          </div>
        </div>

        <div className="p-5 relative z-10">
          <div className="space-y-3 text-gray-700">
            {isManualEntry && candidate.profile.manualEntryText ? (
              <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-3 rounded-xl border border-purple-100">
                <p className="line-clamp-3 text-sm leading-relaxed text-purple-800">
                  {highlightText(candidate.profile.manualEntryText)}
                </p>
              </div>
            ) : (
              <div className="space-y-2">
                {/* 注专 */}
                {candidate.profile.city && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors duration-200">
                    <span className="font-medium text-blue-800">
                      {highlightText(candidate.profile.city)}
                    </span>
                    <MapPin className="w-4 h-4 text-blue-600" />
                  </div>
                )}

                {/* 专 转转 */}
                {candidate.profile.religiousLevel && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors duration-200">
                    <span className="text-purple-800 text-sm font-medium">
                      {highlightText(
                        getReligiousLabel(candidate.profile.religiousLevel)
                      )}
                    </span>
                    <Scroll className="w-4 h-4 text-purple-600" />
                  </div>
                )}

                {/* 注住拽 */}
                {candidate.profile.occupation && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-green-50 rounded-lg hover:bg-green-100 transition-colors duration-200">
                    <span className="text-green-800 text-sm">
                      {highlightText(candidate.profile.occupation)}
                    </span>
                    <Briefcase className="w-4 h-4 text-green-600" />
                  </div>
                )}

                {/*  */}
                {candidate.profile.height && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-amber-50 rounded-lg hover:bg-amber-100 transition-colors duration-200">
                    <span className="text-amber-800 text-sm font-medium">
                      {dict.heightLabel.replace(
                        '{{height}}',
                        candidate.profile.height.toString()
                      )}
                    </span>
                    <Ruler className="w-4 h-4 text-amber-600" />
                  </div>
                )}
                {/* 砖驻转 - 砖 */}
                {spokenLanguages && dict.languagesLabel && (
                  <div className="flex items-center justify-end gap-2 p-2 bg-pink-50 rounded-lg hover:bg-pink-100 transition-colors duration-200">
                    <span className="text-pink-800 text-sm font-medium truncate max-w-[150px]">
                      {dict.languagesLabel.replace(
                        '{{languages}}',
                        spokenLanguages
                      )}
                    </span>
                    <Languages className="w-4 h-4 text-pink-600" />
                  </div>
                )}
              </div>
            )}

            {/* Modal 拽 AI */}
            <Dialog open={showReasoning} onOpenChange={setShowReasoning}>
              <DialogContent
                className="max-w-md mx-auto"
                onClick={(e) => e.stopPropagation()}
                onPointerDownOutside={(e) => e.preventDefault()}
                onInteractOutside={(e) => e.preventDefault()}
              >
                {/* 驻转专 住专 */}
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute left-4 top-4 h-8 w-8 rounded-full hover:bg-gray-100"
                  onClick={(e) => {
                    e.stopPropagation();
                    setShowReasoning(false);
                  }}
                >
                  <X className="h-4 w-4" />
                </Button>

                <DialogHeader>
                  <DialogTitle className="flex items-center gap-2 text-right pr-2">
                    {isVectorResult ? (
                      <>
                        <Zap className="w-5 h-5 text-blue-500" />
                        <span>转  驻专驻</span>
                      </>
                    ) : (
                      <>
                        <Brain className="w-5 h-5 text-purple-500" />
                        <span>转 AI 转拽</span>
                      </>
                    )}
                  </DialogTitle>
                  {/* 砖  砖 转 注专 */}
                  {aiTargetName && (
                    <p className="text-sm text-gray-500 text-right mt-1">
                      转 注专:{' '}
                      <span className="font-medium text-gray-700">
                        {aiTargetName}
                      </span>
                    </p>
                  )}
                </DialogHeader>

                <div className="space-y-4">
                  {/* 砖 注 爪 */}
                  <div
                    className={cn(
                      'flex items-center justify-between p-3 rounded-lg',
                      isVectorResult ? 'bg-blue-50' : 'bg-purple-50'
                    )}
                  >
                    <Badge
                      className={cn(
                        'text-white border-0',
                        isVectorResult
                          ? 'bg-gradient-to-r from-blue-500 to-cyan-500'
                          : 'bg-gradient-to-r from-purple-500 to-indigo-500'
                      )}
                    >
                      {effectiveAiScore} 拽转
                    </Badge>
                    <span className="font-medium text-gray-800">
                      {candidate.firstName} {candidate.lastName}
                    </span>
                  </div>

                  {/* 拽 */}
                  <div className="flex items-start gap-3">
                    <MessageSquare
                      className={cn(
                        'w-5 h-5 mt-0.5 flex-shrink-0',
                        isVectorResult ? 'text-blue-400' : 'text-purple-400'
                      )}
                    />
                    <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-line text-right">
                      {candidate.aiReasoning}
                    </p>
                  </div>

                  {/* 驻专 爪 - 专拽 注专 Algorithmic */}
                  {!isVectorResult && candidate.aiScoreBreakdown && (
                    <div className="pt-3 border-t border-gray-200">
                      <p className="text-sm font-medium text-gray-600 mb-3 text-right">
                        驻专 爪:
                      </p>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.religious}/35
                          </span>
                          <span className="text-gray-600">转</span>
                        </div>
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.careerFamily}/15
                          </span>
                          <span className="text-gray-600">拽专专-砖驻</span>
                        </div>
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.lifestyle}/15
                          </span>
                          <span className="text-gray-600">住 </span>
                        </div>
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.ambition}/12
                          </span>
                          <span className="text-gray-600">砖驻转转</span>
                        </div>
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.communication}/12
                          </span>
                          <span className="text-gray-600">转拽砖专转</span>
                        </div>
                        <div className="flex justify-between items-center p-2 bg-gray-50 rounded">
                          <span className="text-purple-600 font-medium">
                            {candidate.aiScoreBreakdown.values}/11
                          </span>
                          <span className="text-gray-600">注专</span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* 注  - 专拽 注专 Vector */}
                  {isVectorResult && candidate.aiSimilarity && (
                    <div className="pt-3 border-t border-gray-200">
                      <div className="flex items-center justify-between text-sm mb-2">
                        <span className="text-blue-600 font-bold text-lg">
                          {(candidate.aiSimilarity * 100).toFixed(1)}%
                        </span>
                        <span className="text-gray-500">爪  住</span>
                      </div>
                      <div className="h-3 bg-blue-100 rounded-full overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{
                            width: `${candidate.aiSimilarity * 100}%`,
                          }}
                          transition={{ duration: 0.5 }}
                          className="h-full bg-gradient-to-r from-blue-400 to-cyan-500 rounded-full"
                        />
                      </div>
                    </div>
                  )}

                  {/* 驻 专拽注 */}
                  {candidate.aiBackgroundMultiplier &&
                    candidate.aiBackgroundMultiplier !== 1 && (
                      <div className="flex items-center justify-end gap-2 pt-3 border-t border-gray-200">
                        <span
                          className={cn(
                            'font-medium',
                            candidate.aiBackgroundMultiplier > 1
                              ? 'text-green-600'
                              : 'text-orange-600'
                          )}
                        >
                          {candidate.aiBackgroundMultiplier > 1 ? '+' : ''}
                          {Math.round(
                            (candidate.aiBackgroundMultiplier - 1) * 100
                          )}
                          %
                        </span>
                        <span className="text-gray-500">驻 专拽注:</span>
                        <Globe className="w-4 h-4 text-gray-400" />
                      </div>
                    )}
                </div>
              </DialogContent>
            </Dialog>

            {candidate.profile.lastActive && !hasAiData && (
              <div className="flex items-center justify-end gap-2 mt-3 pt-3 border-t border-gray-100">
                <span className="text-xs text-gray-500">
                  {`${dict.lastActivePrefix} ${format(new Date(candidate.profile.lastActive), 'dd/MM/yyyy')}`}
                </span>
                <Clock className="w-3 h-3 text-gray-400" />
              </div>
            )}
          </div>
        </div>

        {/* 驻转专 爪 拽 AI - 砖专 驻专转 注 砖专 驻转专 */}
        {hasAiData && candidate.aiReasoning && (
          <div className="absolute bottom-14 left-3 z-20 transition-all duration-300 opacity-100">
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    className={cn(
                      'h-9 px-3 backdrop-blur-sm shadow-xl border-0 hover:scale-105 transition-all duration-300 flex items-center gap-2',
                      isVectorResult
                        ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white hover:from-blue-600 hover:to-cyan-600'
                        : 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white hover:from-purple-600 hover:to-indigo-600'
                    )}
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowReasoning(true);
                    }}
                  >
                    {isVectorResult ? (
                      <Zap className="h-4 w-4" />
                    ) : (
                      <Brain className="h-4 w-4" />
                    )}
                    <span className="text-xs font-medium">
                      {isVectorResult ? '拽 ' : '拽 AI'}
                    </span>
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{isVectorResult ? '爪 拽 ' : '爪 拽 AI'}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>
        )}

        <div
          className={cn(
            'absolute bottom-3 left-3 z-20 flex items-center gap-2 transition-all duration-300',
            // 砖砖 AI data, 驻转专 转 . 专转 - 专拽 专
            hasAiData
              ? 'opacity-100'
              : 'opacity-100 lg:opacity-0 group-hover:opacity-100 transform lg:translate-y-2 group-hover:translate-y-0'
          )}
        >
          {/* 驻转专  */}
          {candidate.email &&
            !candidate.email.endsWith('@shidduch.placeholder.com') && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      asChild
                      variant="outline"
                      size="icon"
                      className="h-9 w-9 bg-white/90 backdrop-blur-sm shadow-xl border-0 hover:bg-white hover:scale-110 transition-all duration-300"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <a href={`mailto:${candidate.email}`}>
                        <Mail className="h-4 w-4 text-gray-600" />
                      </a>
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{candidate.email}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}

          {/* 转驻专 驻注转 住驻转 */}
          <DropdownMenu>
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="icon"
                      className="h-9 w-9 bg-white/90 backdrop-blur-sm shadow-xl border-0 hover:bg-white hover:scale-110 transition-all duration-300"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <MoreHorizontal className="h-4 w-4 text-gray-600" />
                    </Button>
                  </DropdownMenuTrigger>
                </TooltipTrigger>
                <TooltipContent>
                  <p>驻注转 住驻转</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>

            <DropdownMenuContent
              onClick={(e) => e.stopPropagation()}
              align="start"
            >
              {/* 驻转专 住驻 */}
              {candidate.phone && (
                <DropdownMenuItem
                  onClick={(e) => {
                    e.stopPropagation();

                    let cleanPhone = candidate.phone?.replace(/\D/g, '') || '';
                    if (cleanPhone.startsWith('0')) {
                      cleanPhone = '972' + cleanPhone.substring(1);
                    }

                    if (cleanPhone) {
                      const message = ` ${candidate.firstName}  转 砖拽.   砖 砖专砖转 注专转 砖  拽  注专  爪 转 转 砖转 转 注`;
                      const encodedMessage = encodeURIComponent(message);
                      window.open(
                        `https://wa.me/${cleanPhone}?text=${encodedMessage}`,
                        '_blank'
                      );
                    }
                  }}
                  className="text-green-700 hover:text-green-800 hover:bg-green-50 focus:bg-green-50 focus:text-green-800"
                >
                  <MessageCircle className="h-4 w-4 ml-2" />
                  <span>砖 住驻</span>
                </DropdownMenuItem>
              )}
              {onEdit && (
                <DropdownMenuItem onClick={(e) => onEdit(candidate, e)}>
                  <Edit2 className="h-4 w-4 ml-2" />
                  <span>{dict.tooltips.editProfile}</span>
                </DropdownMenuItem>
              )}
              {onAnalyze && (
                <DropdownMenuItem onClick={(e) => onAnalyze(candidate, e)}>
                  <Sparkles className="h-4 w-4 ml-2" />
                  <span>{dict.tooltips.aiAnalysis}</span>
                </DropdownMenuItem>
              )}
              {onSendProfileFeedback && (
                <DropdownMenuItem
                  onClick={(e) => onSendProfileFeedback(candidate, e)}
                >
                  <Mail className="h-4 w-4 ml-2" />
                  <span>砖  驻专驻</span>
                </DropdownMenuItem>
              )}
            </DropdownMenuContent>
          </DropdownMenu>

          {/* 驻转专 拽注转 专 () */}
          {onSetAiTarget && (
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    size="icon"
                    className={cn(
                      'h-9 w-9 backdrop-blur-sm shadow-xl border-0 hover:scale-110 transition-all duration-300',
                      isAiTarget
                        ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:from-green-600 hover:to-emerald-600'
                        : 'bg-white/90 hover:bg-white text-gray-600'
                    )}
                    onClick={(e) => onSetAiTarget(candidate, e)}
                  >
                    <Star
                      className={cn(
                        'h-4 w-4 transition-all duration-300',
                        isAiTarget ? 'fill-current rotate-12' : ''
                      )}
                    />
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>
                    {isAiTarget
                      ? dict.tooltips.clearAiTarget
                      : dict.tooltips.setAsAiTarget}
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          )}
        </div>

        <div className="absolute top-3 left-1/2 transform -translate-x-1/2 z-20 opacity-0 group-hover:opacity-100 transition-all duration-300">
          <div className="flex items-center gap-1 bg-black/60 text-white px-3 py-1 rounded-full backdrop-blur-sm text-xs font-bold">
            <Award className="w-3 h-3" />
            <span>
              {dict.qualityScore.replace('{{score}}', qualityScore.toString())}
            </span>
          </div>
        </div>

        {isSelectableForComparison && onToggleComparison && (
          <div
            className="absolute top-14 right-3 z-30 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-all duration-300 transform lg:-translate-y-2 group-hover:translate-y-0"
            onClick={(e) => {
              e.stopPropagation();
              onToggleComparison(candidate, e);
            }}
          >
            <div className="flex items-center space-x-2 bg-white/90 backdrop-blur-sm p-2 rounded-xl shadow-xl cursor-pointer hover:bg-white hover:scale-105 transition-all duration-300 border-0">
              <Checkbox
                id={`compare-${candidate.id}`}
                checked={isSelectedForComparison}
                className="pointer-events-none border-2 border-blue-400 data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-blue-500 data-[state=checked]:to-cyan-500 data-[state=checked]:border-blue-500"
              />
              <label
                htmlFor={`compare-${candidate.id}`}
                className="text-xs font-bold leading-none text-gray-700 cursor-pointer"
              >
                {dict.compare}
              </label>
            </div>
          </div>
        )}

        <div className="absolute inset-0 bg-gradient-to-r from-blue-400/0 via-purple-400/0 to-pink-400/0 group-hover:from-blue-400/10 group-hover:via-purple-400/10 group-hover:to-pink-400/10 transition-all duration-500 pointer-events-none rounded-lg"></div>
      </Card>
    </motion.div>
  );
};

export default MinimalCandidateCard;
--- End of Content for MinimalCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidateCard\QuickView.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/CandidateCard/QuickView.tsx

'use client';
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Heart,
  Clock,
  Eye,
  Scroll,
  GraduationCap,
  Briefcase,
  MapPin,
  User,
  FileText,
  CalendarClock,
  Edit,
  Info,
  Star,
  Sparkles,
  Send,
  Calendar,
  Zap,
  Award,
  MessageCircle,
  X,
  Brain, // 住驻转 拽 -AI
} from 'lucide-react';

import { Separator } from '@/components/ui/separator';
import type { Candidate } from '../types/candidates';
import { UserSource } from '@prisma/client';
import { cn } from '@/lib/utils';
import { motion } from 'framer-motion';
import Image from 'next/image';
import { getRelativeCloudinaryPath } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// 驻拽爪 砖 
const calculateAge = (birthDate: Date): number => {
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

type ActionId = 'view' | 'invite' | 'suggest' | 'contact' | 'favorite' | 'edit';

interface QuickViewProps {
  candidate: Candidate;
  onAction: (action: ActionId) => void;
  onSetAiTarget?: (candidate: Candidate, e: React.MouseEvent) => void;
  isAiTarget?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['quickView'];
  // --- 注: 住驻转 砖转 -AI 砖拽 ---
  aiScore?: number;
  aiReasoning?: string;
  aiRank?: number;
  aiSimilarity?: number;
}

const QuickView: React.FC<QuickViewProps> = ({
  candidate,
  onAction,
  onSetAiTarget,
  isAiTarget = false,
  dict,
  // --- 注: 拽转 驻专专 ---
  aiScore,
  aiReasoning,
  aiSimilarity,
}) => {
  const [isClosing, setIsClosing] = useState(false);
  const [hoveredAction, setHoveredAction] = useState<string | null>(null);

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
  };

  const handleClose = () => {
    setIsClosing(true);
    setTimeout(() => {
      // The parent component will handle the actual closing
    }, 150);
  };

  const profile = candidate.profile;
  const isManualEntry = candidate.source === UserSource.MANUAL_ENTRY;
  const mainImage = candidate.images?.find((img) => img.isMain);

  // 砖  爪 转 AI
  const hasAiData =
    typeof aiScore === 'number' || typeof aiSimilarity === 'number';
  const isVectorResult = typeof aiSimilarity === 'number';

  const getAvailabilityInfo = () => {
    switch (profile.availabilityStatus) {
      case 'AVAILABLE':
        return {
          label: dict.availability.AVAILABLE,
          gradient: 'from-emerald-500 to-green-500',
          icon: <Sparkles className="w-4 h-4" />,
          description: dict.availabilityDescription.AVAILABLE,
        };
      case 'DATING':
        return {
          label: dict.availability.DATING,
          gradient: 'from-amber-500 to-orange-500',
          icon: <Heart className="w-4 h-4" />,
          description: dict.availabilityDescription.DATING,
        };
      case 'UNAVAILABLE':
        return {
          label: dict.availability.UNAVAILABLE,
          gradient: 'from-red-500 to-pink-500',
          icon: <Clock className="w-4 h-4" />,
          description: dict.availabilityDescription.UNAVAILABLE,
        };
      default:
        return {
          label: dict.availability.UNKNOWN,
          gradient: 'from-gray-500 to-slate-500',
          icon: <User className="w-4 h-4" />,
          description: dict.availabilityDescription.UNKNOWN,
        };
    }
  };

  const getQualityScore = () => {
    let score = 0;
    if (candidate.images.length > 0) score += 25;
    if (profile.about) score += 25;
    if (profile.education) score += 25;
    if (profile.occupation) score += 25;
    return score;
  };

  const availabilityInfo = getAvailabilityInfo();
  const qualityScore = getQualityScore();

  const actionButtons: {
    id: 'view' | 'invite' | 'suggest' | 'contact' | 'edit';
    label: string;
    icon: React.ElementType;
    gradient: string;
    description: string;
    primary: boolean;
  }[] = [
    {
      id: 'view',
      label: dict.actions.view,
      icon: Eye,
      gradient: 'from-blue-500 to-cyan-500',
      description: dict.actionsDescription.view,
      primary: true,
    },
    {
      id: 'suggest',
      label: dict.actions.suggest,
      icon: Heart,
      gradient: 'from-pink-500 to-rose-500',
      description: dict.actionsDescription.suggest,
      primary: true,
    },
    {
      id: 'invite',
      label: dict.actions.invite,
      icon: Send,
      gradient: 'from-purple-500 to-indigo-500',
      description: dict.actionsDescription.invite,
      primary: false,
    },
    {
      id: 'contact',
      label: dict.actions.contact,
      icon: Calendar,
      gradient: 'from-orange-500 to-amber-500',
      description: dict.actionsDescription.contact,
      primary: false,
    },
    {
      id: 'edit',
      label: dict.actions.edit,
      icon: Edit,
      gradient: 'from-gray-500 to-slate-500',
      description: dict.actionsDescription.edit,
      primary: false,
    },
  ];

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9, y: 20 }}
      animate={{
        opacity: isClosing ? 0 : 1,
        scale: isClosing ? 0.9 : 1,
        y: isClosing ? 20 : 0,
      }}
      transition={{ type: 'spring', stiffness: 300, damping: 25 }}
      className="bg-white shadow-2xl flex flex-col border-0 overflow-hidden max-w-md sm:max-w-lg w-full rounded-3xl max-h-[85vh]"
      onClick={handleClick}
    >
      <div
        className={cn(
          'relative px-6 py-6 text-white overflow-hidden',
          `bg-gradient-to-br ${availabilityInfo.gradient}`
        )}
      >
        <div className="absolute inset-0">
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/20 rounded-full blur-2xl"></div>
          <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
        </div>
        <div className="relative z-10">
          <div className="flex items-start justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="relative w-16 h-16 rounded-full overflow-hidden border-3 border-white/30 shadow-xl">
                {mainImage ? (
                  <Image
                    src={getRelativeCloudinaryPath(mainImage.url)}
                    alt={`${candidate.firstName} ${candidate.lastName}`}
                    fill
                    className="object-cover"
                  />
                ) : (
                  <div className="w-full h-full bg-white/20 flex items-center justify-center">
                    <User className="w-8 h-8 text-white/80" />
                  </div>
                )}
              </div>
              <div>
                <h3 className="text-xl font-bold mb-1">
                  {candidate.firstName} {candidate.lastName}
                </h3>
                <div className="flex items-center gap-2">
                  {availabilityInfo.icon}
                  <span className="text-white/90 font-medium">
                    {availabilityInfo.label}
                  </span>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {onSetAiTarget && (
                <Button
                  size="icon"
                  variant="ghost"
                  className="h-8 w-8 text-white hover:bg-white/20 rounded-full"
                  onClick={(e) => onSetAiTarget(candidate, e)}
                  title={
                    isAiTarget
                      ? dict.tooltips.clearAiTarget
                      : dict.tooltips.setAsAiTarget
                  }
                >
                  <Star
                    className={cn(
                      'h-5 w-5',
                      isAiTarget
                        ? 'fill-current text-yellow-300'
                        : 'text-white/80'
                    )}
                  />
                </Button>
              )}
              <Button
                size="icon"
                variant="ghost"
                className="h-8 w-8 text-white hover:bg-white/20 rounded-full"
                onClick={handleClose}
              >
                <X className="h-5 w-5" />
              </Button>
            </div>
          </div>
          <div className="flex flex-wrap gap-2">
            <Badge className="bg-white/20 text-white border-white/30 backdrop-blur-sm">
              {availabilityInfo.description}
            </Badge>
            {isManualEntry && (
              <Badge className="bg-purple-500/30 text-white border-purple-300/50 backdrop-blur-sm">
                <Edit className="w-3 h-3 mr-1" />
                {dict.manualEntry}
              </Badge>
            )}

            {/* --- 爪转 转转 AI  拽转 --- */}
            {hasAiData && (
              <Badge
                className={cn(
                  'backdrop-blur-sm border-0 text-white',
                  isVectorResult ? 'bg-blue-500/40' : 'bg-teal-500/40'
                )}
              >
                {isVectorResult ? (
                  <Zap className="w-3 h-3 mr-1" />
                ) : (
                  <Brain className="w-3 h-3 mr-1" />
                )}
                {isVectorResult
                  ? `${Math.round((aiSimilarity || 0) * 100)}% `
                  : `转: ${aiScore}`}
              </Badge>
            )}
          </div>
        </div>
      </div>
      <div className="flex-1 p-6 space-y-6 text-right overflow-y-auto bg-gradient-to-br from-white to-gray-50/30">
        {/* --- 住驻转 专 AI 转 -Quick View  拽 拽 --- */}
        {aiReasoning && (
          <div
            className={cn(
              'p-4 rounded-xl border text-sm',
              isVectorResult
                ? 'bg-blue-50 border-blue-100'
                : 'bg-purple-50 border-purple-100'
            )}
          >
            <div className="flex items-center gap-2 mb-2 font-bold text-gray-700">
              {isVectorResult ? (
                <Zap className="w-4 h-4 text-blue-500" />
              ) : (
                <Brain className="w-4 h-4 text-purple-500" />
              )}
              <span>{isVectorResult ? '转 ' : '转 转'}</span>
            </div>
            <p className="text-gray-600 leading-relaxed">{aiReasoning}</p>
          </div>
        )}

        <div className="grid grid-cols-2 gap-4">
          {profile.birthDate && (
            <div className="p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-blue-700">
                <span className="font-bold text-lg">
                  {calculateAge(new Date(profile.birthDate))}
                </span>
                <CalendarClock className="w-5 h-5" />
              </div>
              <p className="text-xs text-blue-600 mt-1">{dict.details.years}</p>
            </div>
          )}
          {profile.height && (
            <div className="p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-purple-700">
                <span className="font-bold text-lg">{profile.height}</span>
                <User className="w-5 h-5" />
              </div>
              <p className="text-xs text-purple-600 mt-1">
                {dict.details.heightUnit}
              </p>
            </div>
          )}
          {profile.maritalStatus && (
            <div className="p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-green-700">
                <span className="font-medium text-sm">
                  {profile.maritalStatus}
                </span>
                <Heart className="w-5 h-5" />
              </div>
              <p className="text-xs text-green-600 mt-1">
                {dict.details.maritalStatus}
              </p>
            </div>
          )}
          {profile.religiousLevel && (
            <div className="p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-100 hover:shadow-md transition-all duration-300">
              <div className="flex items-center justify-end gap-2 text-orange-700">
                <span className="font-medium text-sm">
                  {profile.religiousLevel}
                </span>
                <Scroll className="w-5 h-5" />
              </div>
              <p className="text-xs text-orange-600 mt-1">
                {dict.details.religiousLevel}
              </p>
            </div>
          )}
        </div>
        <Separator className="my-6 bg-gradient-to-r from-transparent via-gray-300 to-transparent" />
        {isManualEntry && profile.manualEntryText ? (
          <div className="space-y-4">
            <div className="flex items-center justify-end gap-2">
              <h4 className="text-lg font-bold text-purple-800">
                {dict.details.manualDescription}
              </h4>
              <Info className="w-6 h-6 text-purple-500" />
            </div>
            <div className="p-5 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-200 shadow-sm">
              <p className="text-purple-900 leading-relaxed whitespace-pre-wrap font-medium">
                {profile.manualEntryText}
              </p>
            </div>
          </div>
        ) : (
          <div className="space-y-4">
            <h4 className="text-lg font-bold text-gray-700 mb-4 flex items-center justify-end gap-2">
              <span>{dict.details.moreInfo}</span>
              <Sparkles className="w-5 h-5 text-blue-500" />
            </h4>
            {profile.education && (
              <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 hover:shadow-md transition-all duration-300 group">
                <div className="flex items-center justify-end gap-3">
                  <span className="font-medium text-blue-800 group-hover:text-blue-900 transition-colors">
                    {profile.education}
                  </span>
                  <div className="p-2 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg">
                    <GraduationCap className="w-4 h-4" />
                  </div>
                </div>
                <p className="text-xs text-blue-600 mt-1 text-right">
                  {dict.details.education}
                </p>
              </div>
            )}
            {profile.occupation && (
              <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300 group">
                <div className="flex items-center justify-end gap-3">
                  <span className="font-medium text-green-800 group-hover:text-green-900 transition-colors">
                    {profile.occupation}
                  </span>
                  <div className="p-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg">
                    <Briefcase className="w-4 h-4" />
                  </div>
                </div>
                <p className="text-xs text-green-600 mt-1 text-right">
                  {dict.details.occupation}
                </p>
              </div>
            )}
            {profile.city && (
              <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100 hover:shadow-md transition-all duration-300 group">
                <div className="flex items-center justify-end gap-3">
                  <span className="font-medium text-purple-800 group-hover:text-purple-900 transition-colors">
                    {profile.city}
                  </span>
                  <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
                    <MapPin className="w-4 h-4" />
                  </div>
                </div>
                <p className="text-xs text-purple-600 mt-1 text-right">
                  {dict.details.location}
                </p>
              </div>
            )}
          </div>
        )}
        {(!isManualEntry || !profile.manualEntryText) && profile.about && (
          <>
            <Separator className="my-6 bg-gradient-to-r from-transparent via-gray-300 to-transparent" />
            <div className="space-y-4">
              <h4 className="text-lg font-bold text-gray-700 flex items-center justify-end gap-2">
                <span>{dict.details.about}</span>
                <FileText className="w-5 h-5 text-gray-500" />
              </h4>
              <div className="p-5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl border border-gray-200 shadow-sm">
                <p className="text-gray-800 leading-relaxed whitespace-pre-wrap">
                  {profile.about}
                </p>
              </div>
            </div>
          </>
        )}
      </div>
      <div className="p-6 bg-gradient-to-r from-gray-50 to-white border-t border-gray-100">
        <div className="flex items-center justify-center mb-4">
          <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-cyan-50 px-4 py-2 rounded-full border border-blue-100">
            <Award className="w-4 h-4 text-blue-600" />
            <span className="text-sm font-bold text-blue-800">
              {dict.qualityScore.replace('{{score}}', String(qualityScore))}
            </span>
            <div className="flex gap-1">
              {[...Array(5)].map((_, i) => (
                <Star
                  key={i}
                  className={cn(
                    'w-3 h-3',
                    i < Math.floor(qualityScore / 20)
                      ? 'text-yellow-500 fill-current'
                      : 'text-gray-300'
                  )}
                />
              ))}
            </div>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 mb-4">
          {actionButtons
            .filter((a) => a.primary)
            .map((action) => {
              const IconComponent = action.icon;
              return (
                <Button
                  key={action.id}
                  className={cn(
                    'h-12 font-bold text-sm border-0 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 relative overflow-hidden group rounded-2xl',
                    `bg-gradient-to-r ${action.gradient} hover:${action.gradient.replace('500', '600')}`,
                    'text-white',
                    hoveredAction === action.id && 'scale-105'
                  )}
                  onClick={() => onAction(action.id)}
                  onMouseEnter={() => setHoveredAction(action.id)}
                  onMouseLeave={() => setHoveredAction(null)}
                >
                  <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  <div className="relative z-10 flex items-center justify-center gap-2">
                    <IconComponent className="w-5 h-5" />
                    <span>{action.label}</span>
                  </div>
                </Button>
              );
            })}
        </div>
        <div className="grid grid-cols-3 gap-2">
          {actionButtons
            .filter((a) => !a.primary)
            .map((action) => {
              const IconComponent = action.icon;
              return (
                <Button
                  key={action.id}
                  variant="outline"
                  size="sm"
                  className={cn(
                    'border-2 border-gray-200 hover:border-transparent shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 group relative overflow-hidden rounded-xl',
                    `hover:bg-gradient-to-r hover:${action.gradient}`,
                    'hover:text-white font-medium',
                    hoveredAction === action.id && 'scale-105'
                  )}
                  onClick={() => onAction(action.id)}
                  onMouseEnter={() => setHoveredAction(action.id)}
                  onMouseLeave={() => setHoveredAction(null)}
                >
                  <div
                    className={cn(
                      'absolute inset-0 bg-gradient-to-r transition-all duration-300 opacity-0 group-hover:opacity-100',
                      action.gradient
                    )}
                  ></div>
                  <div className="relative z-10 flex items-center justify-center gap-1">
                    <IconComponent className="w-3 h-3" />
                    <span className="text-xs">{action.label}</span>
                  </div>
                </Button>
              );
            })}
        </div>
        <div className="mt-4 pt-4 border-t border-gray-200">
          <div className="flex justify-between items-center text-xs">
            <div className="flex items-center gap-1 text-yellow-600">
              <Star className="w-3 h-3 fill-current" />
              <span className="font-medium">{dict.stats.rating}: 4.8</span>
            </div>
            <div className="flex items-center gap-1 text-blue-600">
              <Zap className="w-3 h-3" />
              <span className="font-medium">{dict.stats.match}: 95%</span>
            </div>
            <div className="flex items-center gap-1 text-green-600">
              <MessageCircle className="w-3 h-3" />
              <span className="font-medium">
                {dict.stats.response}: {dict.stats.quick}
              </span>
            </div>
          </div>
        </div>
      </div>
    </motion.div>
  );
};

export default QuickView;
--- End of Content for QuickView.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesList.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/CandidatesList.tsx

import React, {
  useState,
  useCallback,
  useEffect,
  useRef,
  useMemo,
} from 'react';
import { UserX, Edit, X } from 'lucide-react';
import MinimalCard from '../CandidateCard/MinimalCard';
import QuickView from '../CandidateCard/QuickView';
import { ProfileCard } from '@/components/profile';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { Skeleton } from '@/components/ui/skeleton';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import { ActionDialogs } from '../dialogs/ActionDialogs';
import NewSuggestionForm from '../../suggestions/NewSuggestionForm';
import MatchmakerEditProfile from '../MatchmakerEditProfile';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';

// ============================================================================
// TYPES
// ============================================================================

interface CreateSuggestionData {
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
  firstPartyId: string;
  secondPartyId: string;
  status:
    | 'DRAFT'
    | 'PENDING_FIRST_PARTY'
    | 'FIRST_PARTY_APPROVED'
    | 'FIRST_PARTY_DECLINED'
    | string;
  firstPartyNotes?: string;
  secondPartyNotes?: string;
}

//  驻住 驻专 爪
interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

//  驻住 专 注 注 转 AI
type CandidateWithAiData = Candidate & {
  aiScore?: number;
  aiReasoning?: string;
  aiRank?: number;
  aiFirstPassScore?: number;
  aiScoreBreakdown?: ScoreBreakdown;
  aiBackgroundMultiplier?: number;
  aiBackgroundCompatibility?:
    | 'excellent'
    | 'good'
    | 'possible'
    | 'problematic'
    | 'not_recommended';
  aiSimilarity?: number; //  注专 Vector Search
};

interface CandidatesListProps {
  candidates: CandidateWithAiData[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void;
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void;
  onCandidateClick?: (candidate: Candidate) => void;
  onCandidateAction?: (type: CandidateAction, candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  highlightTerm?: string;
  aiTargetCandidate: Candidate | null;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  quickViewSide?: 'left' | 'right' | 'center';
  isQuickViewEnabled: boolean;
  locale: string;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

// ============================================================================
// COMPONENT
// ============================================================================

const CandidatesList: React.FC<CandidatesListProps> = ({
  candidates,
  allCandidates,
  locale,
  onCandidateClick,
  onCandidateAction,
  isQuickViewEnabled,
  onOpenAiAnalysis,
  onSendProfileFeedback,
  viewMode,
  mobileView,
  isLoading = false,
  className,
  highlightTerm,
  aiTargetCandidate,
  onSetAiTarget,
  comparisonSelection,
  onToggleComparison,
  quickViewSide = 'center',
  dict,
  profileDict,
}) => {
  // Base states
  const [selectedCandidate, setSelectedCandidate] = useState<Candidate | null>(
    null
  );
  const [questionnaireResponse, setQuestionnaireResponse] =
    useState<QuestionnaireResponse | null>(null);
  const [isMatchmaker, setIsMatchmaker] = useState(true);
  const [hoveredCandidate, setHoveredCandidate] =
    useState<CandidateWithAiData | null>(null);
  const [hoverPosition, setHoverPosition] = useState({ top: 0, left: 0 });
  const hoverTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const quickViewRef = useRef<HTMLDivElement>(null);

  // Dialog states
  const [showInviteDialog, setShowInviteDialog] = useState(false);
  const [showAvailabilityDialog, setShowAvailabilityDialog] = useState(false);
  const [showSuggestDialog, setShowSuggestDialog] = useState(false);
  const [showEditProfileDialog, setShowEditProfileDialog] = useState(false);
  const [dialogCandidate, setDialogCandidate] = useState<Candidate | null>(
    null
  );

  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const checkScreenSize = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => {
      window.removeEventListener('resize', checkScreenSize);
    };
  }, []);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        hoveredCandidate &&
        quickViewRef.current &&
        !quickViewRef.current.contains(event.target as Node)
      ) {
        setHoveredCandidate(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [hoveredCandidate]);

  useEffect(() => {
    return () => {
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
      }
    };
  }, []);

  useEffect(() => {
    const loadQuestionnaire = async () => {
      if (!selectedCandidate) {
        setQuestionnaireResponse(null);
        return;
      }
      try {
        const params = new URLSearchParams();
        params.append('userId', selectedCandidate.id);
        params.append('locale', locale);

        const response = await fetch(
          `/api/profile/questionnaire?${params.toString()}`
        );

        const data = await response.json();
        if (data.success && data.questionnaireResponse) {
          setQuestionnaireResponse(data.questionnaireResponse);
        } else {
          console.warn('Could not load questionnaire:', data.message);
          setQuestionnaireResponse(null);
        }
      } catch (error) {
        console.error('Failed to load questionnaire:', error);
        toast.error('砖 注转 砖');
      }
    };
    loadQuestionnaire();
  }, [selectedCandidate, locale]);

  // Action handlers
  const handleInvite = async (candidate: Candidate, email: string) => {
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/invite-setup`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ candidateId: candidate.id, email }),
        }
      );
      if (!response.ok) throw new Error('Failed to send invitation');
      toast.success(' 砖 爪');
      onCandidateAction?.('invite', candidate);
    } catch (error) {
      console.error('Error sending invite:', error);
      throw error;
    }
  };

  const handleAvailabilityCheck = async (candidate: Candidate) => {
    try {
      const response = await fetch('/api/availability/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId: candidate.id }),
      });
      if (!response.ok) throw new Error('Failed to check availability');
      toast.success('拽转 转 砖');
      onCandidateAction?.('contact', candidate);
    } catch (error) {
      console.error('Error checking availability:', error);
      throw error;
    }
  };

  const handleCreateSuggestion = async (data: CreateSuggestionData) => {
    try {
      const response = await fetch(
        `/api/matchmaker/suggestions?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        }
      );
      if (!response.ok) throw new Error('Failed to create suggestion');
      toast.success('爪注 爪专 爪');
      onCandidateAction?.('suggest', dialogCandidate!);
    } catch (error) {
      console.error('Error creating suggestion:', error);
      throw error;
    }
  };

  const handleEditProfile = (candidate: Candidate) => {
    setDialogCandidate(candidate);
    setShowEditProfileDialog(true);
  };

  const handleMouseEnter = (
    candidate: CandidateWithAiData,
    e?: React.MouseEvent
  ) => {
    if (isMobile || !e || !isQuickViewEnabled) return;

    if (isMobile || !e) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
    }
    const cardElement = e.currentTarget as HTMLElement;
    const cardRect = cardElement.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const padding = 20;
    const quickViewApproxHeight = Math.min(650, viewportHeight * 0.85);
    let top;
    if (cardRect.top + quickViewApproxHeight > viewportHeight - padding) {
      top = cardElement.offsetTop + cardRect.height - quickViewApproxHeight;
    } else {
      top = cardElement.offsetTop;
    }
    const scrollContainer = cardElement.closest('.overflow-y-auto');
    if (scrollContainer) {
      top = Math.max(top, scrollContainer.scrollTop);
    }
    let left;
    const quickViewWidth = 420;
    switch (quickViewSide) {
      case 'left':
        left = window.innerWidth / 4 - quickViewWidth / 2;
        break;
      case 'right':
        left = (window.innerWidth * 3) / 4 - quickViewWidth / 2 - 470;
        break;
      case 'center':
      default:
        left = window.innerWidth / 2 - quickViewWidth / 2;
        break;
    }
    left = Math.max(
      padding,
      Math.min(left, window.innerWidth - quickViewWidth - padding)
    );
    hoverTimeoutRef.current = setTimeout(() => {
      setHoverPosition({ top, left });
      setHoveredCandidate(candidate);
    }, 300);
  };

  const handleMouseLeave = () => {
    if (isMobile) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
      hoverTimeoutRef.current = null;
    }
    setTimeout(() => {
      if (!quickViewRef.current?.matches(':hover')) {
        setHoveredCandidate(null);
      }
    }, 100);
  };

  const handleAction = useCallback(
    (
      action: CandidateAction | 'analyze' | 'sendFeedback',
      candidate: Candidate
    ) => {
      setDialogCandidate(candidate);
      setHoveredCandidate(null);
      switch (action) {
        case 'invite':
          setShowInviteDialog(true);
          break;
        case 'contact':
          setShowAvailabilityDialog(true);
          break;
        case 'suggest':
          setShowSuggestDialog(true);
          break;
        case 'view':
          setSelectedCandidate(candidate);
          onCandidateClick?.(candidate);
          break;
        case 'edit':
          handleEditProfile(candidate);
          break;
        case 'analyze':
          onOpenAiAnalysis(candidate);
          break;
        case 'sendFeedback':
          if (onSendProfileFeedback) {
            onSendProfileFeedback(candidate);
          }
          break;

        default:
          onCandidateAction?.(action as CandidateAction, candidate);
      }
    },
    [
      onCandidateAction,
      onCandidateClick,
      onOpenAiAnalysis,
      onSendProfileFeedback,
    ]
  );

  const gridLayoutClass = useMemo(() => {
    if (isMobile) {
      return mobileView === 'double'
        ? 'grid grid-cols-2 gap-2'
        : 'grid grid-cols-1 gap-3';
    }
    return viewMode === 'grid'
      ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-3 gap-y-4'
      : 'space-y-4';
  }, [isMobile, mobileView, viewMode]);

  if (isLoading) {
    return (
      <div
        className={`${
          viewMode === 'grid'
            ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
            : 'space-y-4'
        } ${className || ''}`}
      >
        {Array.from({ length: 6 }).map((_, i) => (
          <div key={i} className="relative">
            <Skeleton
              className={
                viewMode === 'list' ? 'h-32 w-full' : 'h-[350px] w-full'
              }
            />
            <div className="absolute top-3 right-3">
              <Skeleton className="h-6 w-16 rounded-full" />
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (candidates.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-32 bg-gray-50 rounded-lg border border-dashed border-gray-300 p-4 text-center">
        <UserX className="w-8 h-8 mb-2 text-gray-400" />
        <p className="text-sm font-medium text-gray-500 mb-1">
          {dict.candidatesManager.list.emptyState.title}
        </p>
        <p className="text-xs text-gray-400">
          {dict.candidatesManager.list.emptyState.description}
        </p>
      </div>
    );
  }

  return (
    <>
      <div className={cn(gridLayoutClass, className || '')}>
        {candidates.map((candidate) => (
          <div
            key={candidate.id}
            className="group relative"
            onMouseEnter={(e) => handleMouseEnter(candidate, e)}
            onMouseLeave={handleMouseLeave}
            onClick={() => handleAction('view', candidate)}
          >
            <MinimalCard
              candidate={candidate}
              onClick={() => handleAction('view', candidate)}
              onAnalyze={(c, e) => {
                e.stopPropagation();
                handleAction('analyze', c);
              }}
              aiTargetName={
                aiTargetCandidate
                  ? `${aiTargetCandidate.firstName} ${aiTargetCandidate.lastName}`
                  : undefined
              }
              onSendProfileFeedback={(c, e) => {
                e.stopPropagation();
                handleAction('sendFeedback', c);
              }}
              onEdit={(c, e) => {
                e.stopPropagation();
                handleAction('edit', c);
              }}
              className={cn(
                viewMode === 'list' && !isMobile
                  ? 'flex flex-row-reverse gap-4 h-32'
                  : '',
                isMobile && mobileView === 'double' ? 'transform scale-90' : '',
                isMobile && mobileView === 'single' ? 'transform scale-95' : ''
              )}
              highlightTerm={highlightTerm}
              aiScore={candidate.aiScore}
              onSetAiTarget={onSetAiTarget}
              isAiTarget={aiTargetCandidate?.id === candidate.id}
              isSelectableForComparison={
                !!aiTargetCandidate &&
                aiTargetCandidate.profile.gender !== candidate.profile.gender &&
                aiTargetCandidate.id !== candidate.id
              }
              isSelectedForComparison={!!comparisonSelection[candidate.id]}
              onToggleComparison={onToggleComparison}
              dict={dict.candidatesManager.list.minimalCard}
            />
            <button
              className="absolute top-2 left-2 bg-primary text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
              onClick={(e) => {
                e.stopPropagation();
                handleAction('edit', candidate);
              }}
              aria-label={dict.candidatesManager.list.editProfileTooltip}
              title={dict.candidatesManager.list.editProfileTooltip}
            >
              <Edit className="w-4 h-4" />
            </button>
          </div>
        ))}
      </div>

      {isQuickViewEnabled && hoveredCandidate && !isMobile && (
        <div
          ref={quickViewRef}
          className="absolute z-[70]"
          style={{
            top: `${hoverPosition.top}px`,
            left: `${hoverPosition.left}px`,
            width: '420px',
          }}
        >
          <div className="drop-shadow-2xl">
            <QuickView
              candidate={hoveredCandidate}
              onAction={(action) => handleAction(action, hoveredCandidate)}
              onSetAiTarget={(c, e) => onSetAiTarget(c, e)}
              isAiTarget={aiTargetCandidate?.id === hoveredCandidate.id}
              dict={dict.candidatesManager.list.quickView}
              //  注专转 转 AI -QuickView
              aiScore={hoveredCandidate.aiScore}
              aiReasoning={hoveredCandidate.aiReasoning}
              aiRank={hoveredCandidate.aiRank}
              aiSimilarity={hoveredCandidate.aiSimilarity}
            />
          </div>
        </div>
      )}

      {/* --- Main Profile Dialog --- */}
      <Dialog
        open={!!selectedCandidate}
        onOpenChange={(open) => {
          if (!open) {
            setSelectedCandidate(null);
            setQuestionnaireResponse(null);
          }
        }}
      >
        <DialogContent
          className="max-w-6xl max-h-[90vh] overflow-y-auto p-0"
          dir={locale === 'he' ? 'rtl' : 'ltr'}
          onCloseAutoFocus={(e) => {
            e.preventDefault(); // 注 驻驻  注 住 专 驻拽住
          }}
        >
          {/* Custom Sticky Header */}
          <div className="sticky top-0 z-50 flex items-center justify-between px-6 py-4 bg-white/95 backdrop-blur-sm border-b border-gray-100">
            <div className="flex items-center gap-3">
              <DialogTitle className="text-xl font-bold text-gray-800">
                {selectedCandidate
                  ? `${selectedCandidate.firstName} ${selectedCandidate.lastName}`
                  : ''}
              </DialogTitle>
              {selectedCandidate?.isVerified && (
                <Badge
                  variant="secondary"
                  className="bg-emerald-100 text-emerald-700"
                >
                  转
                </Badge>
              )}
            </div>

            <div className="flex items-center gap-2">
              <Select
                value={isMatchmaker ? 'matchmaker' : 'candidate'}
                onValueChange={(value) =>
                  setIsMatchmaker(value === 'matchmaker')
                }
              >
                <SelectTrigger className="w-[140px] h-9">
                  <SelectValue
                    placeholder={
                      dict.candidatesManager.list.profileDialog.viewAsLabel
                    }
                  />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="candidate">
                    {dict.candidatesManager.list.profileDialog.candidateView}
                  </SelectItem>
                  <SelectItem value="matchmaker">
                    {dict.candidatesManager.list.profileDialog.matchmakerView}
                  </SelectItem>
                </SelectContent>
              </Select>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleAction('edit', selectedCandidate!)}
                className="h-9 w-9 p-0 rounded-full hover:bg-gray-100"
                title={dict.candidatesManager.list.profileDialog.editButton}
              >
                <Edit className="w-4 h-4 text-gray-600" />
              </Button>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => setSelectedCandidate(null)}
                className="h-9 w-9 p-0 rounded-full hover:bg-red-50 hover:text-red-600"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>
          </div>

          {selectedCandidate && (
            <div className="p-0">
              <ProfileCard
                profile={selectedCandidate.profile}
                images={selectedCandidate.images}
                questionnaire={questionnaireResponse}
                viewMode={isMatchmaker ? 'matchmaker' : 'candidate'}
                isProfileComplete={selectedCandidate.isProfileComplete}
                dict={profileDict.profileCard}
                locale={locale}
                onClose={() => setSelectedCandidate(null)}
              />
            </div>
          )}
        </DialogContent>
      </Dialog>

      <ActionDialogs
        suggestDialog={{
          isOpen: showSuggestDialog,
          onClose: () => setShowSuggestDialog(false),
          onSubmit: handleCreateSuggestion,
          selectedCandidate: dialogCandidate,
        }}
        availabilityDialog={{
          isOpen: showAvailabilityDialog,
          onClose: () => setShowAvailabilityDialog(false),
          onCheck: handleAvailabilityCheck,
          selectedCandidate: dialogCandidate,
        }}
        inviteDialog={{
          isOpen: showInviteDialog,
          onClose: () => setShowInviteDialog(false),
          onInvite: handleInvite,
          selectedCandidate: dialogCandidate,
        }}
        dict={dict.candidatesManager.actionDialogs}
      />

      <NewSuggestionForm
        isOpen={showSuggestDialog}
        onClose={() => setShowSuggestDialog(false)}
        candidates={allCandidates}
        selectedCandidate={dialogCandidate}
        onSubmit={handleCreateSuggestion}
        dict={dict}
        locale={locale}
      />

      <MatchmakerEditProfile
        isOpen={showEditProfileDialog}
        onClose={() => setShowEditProfileDialog(false)}
        candidate={dialogCandidate}
        dict={dict.candidatesManager.editProfile}
        profileDict={profileDict}
        locale={locale}
      />
    </>
  );
};

export default CandidatesList;
--- End of Content for CandidatesList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesStats.tsx
--------------------------------------------------------------------------------
Content:
// /CandidatesManager/CandidatesStats.tsx

'use client';

import React from 'react';

import { Card, CardContent } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import {
  Users,
  UserCheck,
  Clock,
  MapPin,
  CheckCircle,
  Image as ImageIcon,
  TrendingUp,
  ArrowUp,
  ArrowDown,
  Activity,
  Heart,
  Star,
  Award,
  Sparkles,
  Target,
  Crown,
  Zap,
} from 'lucide-react';
import { useStatistics } from '../hooks/useStatistics';
import type { Candidate } from '../types/candidates';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface StatCardProps {
  title: string;
  value: string | number;
  description?: string;
  icon: React.ReactNode;
  trend?: {
    value: number;
    isPositive: boolean;
  };
  className?: string;
  gradient: string;
  iconColor: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats']['mainStats']['trend'];
}

interface CandidatesStatsProps {
  candidates: Candidate[];
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats'];
}

const CHART_COLORS = [
  '#3B82F6', // 
  '#EF4444', // 
  '#10B981', // 专拽
  '#F59E0B', // 转
  '#8B5CF6', // 住
  '#EC4899', // 专
  '#06B6D4', // 爪
  '#84CC16', // 
];

const StatCard: React.FC<StatCardProps> = ({
  title,
  value,
  description,
  icon,
  trend,
  className,
  gradient,
  iconColor,
  dict,
}) => (
  <Card
    className={cn(
      'border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden group hover:shadow-2xl transition-all duration-300 transform hover:scale-105',
      className
    )}
  >
    <CardContent className="p-6 relative">
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl opacity-50"></div>

      <div className="flex items-start justify-between relative z-10">
        <div className="space-y-3 flex-1">
          <p className="text-sm font-medium text-gray-600">{title}</p>
          <div className="flex items-baseline gap-2">
            <p className="text-3xl font-bold text-gray-800">{value}</p>
            {trend && (
              <div
                className={cn(
                  'flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold',
                  trend.isPositive
                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-700'
                    : 'bg-gradient-to-r from-red-100 to-pink-100 text-red-700'
                )}
              >
                {trend.isPositive ? (
                  <ArrowUp className="w-3 h-3" />
                ) : (
                  <ArrowDown className="w-3 h-3" />
                )}
                <span>{Math.abs(trend.value)}%</span>
              </div>
            )}
          </div>
          {description && (
            <p className="text-sm text-gray-500 leading-relaxed">
              {description}
            </p>
          )}
          {trend && (
            <p className="text-xs text-gray-400">
              {trend.isPositive ? dict.increase : dict.decrease} {dict.period}
            </p>
          )}
        </div>

        <div
          className={cn(
            'p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform duration-300',
            `bg-gradient-to-r ${gradient}`
          )}
        >
          <div className={iconColor}>{icon}</div>
        </div>
      </div>
    </CardContent>
  </Card>
);

const EnhancedChartCard: React.FC<{
  title: string;
  children: React.ReactNode;
  description?: string;
  gradient?: string;
  icon?: React.ReactNode;
}> = ({
  title,
  children,
  description,
  gradient = 'from-blue-500 to-cyan-500',
  icon,
}) => (
  <Card className="border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden hover:shadow-2xl transition-all duration-300">
    <CardContent className="p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          {icon && (
            <div
              className={cn(
                'p-3 rounded-full shadow-lg',
                `bg-gradient-to-r ${gradient}`
              )}
            >
              <div className="text-white">{icon}</div>
            </div>
          )}
          <div>
            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
            {description && (
              <p className="text-sm text-gray-500 mt-1">{description}</p>
            )}
          </div>
        </div>
      </div>
      {children}
    </CardContent>
  </Card>
);

const CandidatesStats: React.FC<CandidatesStatsProps> = ({
  candidates,
  className,
  dict,
}) => {
  const {
    stats,
    getGenderRatio,
    getTopCities,
    getActiveUsersPercent,
    getAgeGroupDistribution,
    getReligiousDistribution,
    getActivityTrend,
    getProfileCompletionStats,
  } = useStatistics(candidates);

  const genderRatio = getGenderRatio();
  const activeUsers = getActiveUsersPercent();
  const completionStats = getProfileCompletionStats();
  const ageDistribution = getAgeGroupDistribution();
  const religiousDistribution = getReligiousDistribution();
  const activityTrend = getActivityTrend();
  const topCities = getTopCities(5);

  return (
    <div className={cn('space-y-8', className)}>
      <div className="relative min-h-[200px] bg-gradient-to-br from-purple-50 via-cyan-50/30 to-emerald-50/20 overflow-hidden rounded-3xl shadow-2xl p-8">
        <div className="absolute inset-0">
          <div className="absolute top-10 right-10 w-64 h-64 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-3xl animate-float"></div>
          <div
            className="absolute bottom-10 left-10 w-48 h-48 bg-gradient-to-br from-cyan-200/30 to-blue-200/30 rounded-full blur-2xl animate-float"
            style={{ animationDelay: '2s' }}
          ></div>
        </div>

        <div className="relative z-10 text-center">
          <div className="inline-flex items-center gap-3 mb-6">
            <div className="p-4 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
              <Activity className="w-10 h-10" />
            </div>
          </div>
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4">
            {dict.hero.title}
          </h1>
          <p className="text-xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
            {dict.hero.subtitle}
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title={dict.mainStats.total.title}
          value={stats.gender.total}
          icon={<Users className="w-8 h-8" />}
          description={dict.mainStats.total.description}
          gradient="from-blue-500 to-cyan-500"
          iconColor="text-white"
          trend={{ value: 12, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.ratio.title}
          value={genderRatio.formattedRatio}
          icon={<UserCheck className="w-8 h-8" />}
          description={dict.mainStats.ratio.description}
          gradient="from-purple-500 to-pink-500"
          iconColor="text-white"
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.activity.title}
          value={`${activeUsers}%`}
          icon={<Clock className="w-8 h-8" />}
          gradient="from-green-500 to-emerald-500"
          iconColor="text-white"
          trend={{ value: 8, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.completion.title}
          value={`${completionStats.percentage}%`}
          icon={<CheckCircle className="w-8 h-8" />}
          description={dict.mainStats.completion.description
            .replace('{{completed}}', completionStats.completed.toString())
            .replace('{{total}}', stats.gender.total.toString())}
          gradient="from-orange-500 to-amber-500"
          iconColor="text-white"
          trend={{ value: 5, isPositive: true }}
          dict={dict.mainStats.trend}
        />
      </div>

      <Tabs defaultValue="demographics" className="w-full">
        <TabsList className="bg-purple-50/50 rounded-2xl p-1.5 h-auto shadow-lg border border-white/50 grid w-full grid-cols-3">
          <TabsTrigger
            value="demographics"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Users className="w-5 h-5" />
            {dict.tabs.demographics}
          </TabsTrigger>
          <TabsTrigger
            value="activity"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Activity className="w-5 h-5" />
            {dict.tabs.activity}
          </TabsTrigger>
          <TabsTrigger
            value="completion"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Target className="w-5 h-5" />
            {dict.tabs.completion}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="demographics" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.ageDistribution.title}
              description={dict.charts.ageDistribution.description}
              gradient="from-blue-500 to-cyan-500"
              icon={<Users className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={ageDistribution}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                  <XAxis
                    dataKey="range"
                    tick={{ fontSize: 12 }}
                    stroke="#666"
                  />
                  <YAxis tick={{ fontSize: 12 }} stroke="#666" />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                  <Bar
                    dataKey="count"
                    fill="url(#blueGradient)"
                    radius={[4, 4, 0, 0]}
                  />
                  <defs>
                    <linearGradient
                      id="blueGradient"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.8} />
                      <stop
                        offset="95%"
                        stopColor="#06B6D4"
                        stopOpacity={0.6}
                      />
                    </linearGradient>
                  </defs>
                </BarChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.religiousDistribution.title}
              description={dict.charts.religiousDistribution.description}
              gradient="from-purple-500 to-pink-500"
              icon={<Heart className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={religiousDistribution}
                    dataKey="count"
                    nameKey="level"
                    cx="50%"
                    cy="50%"
                    outerRadius={100}
                    innerRadius={40}
                    paddingAngle={2}
                    label={({ name, percent }) =>
                      `${name} ${(percent * 100).toFixed(0)}%`
                    }
                  >
                    {religiousDistribution.map((_, index) => (
                      <Cell
                        key={`cell-${index}`}
                        fill={CHART_COLORS[index % CHART_COLORS.length]}
                      />
                    ))}
                  </Pie>
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.topCities.title}
              description={dict.charts.topCities.description}
              gradient="from-green-500 to-emerald-500"
              icon={<MapPin className="w-6 h-6" />}
            >
              <div className="space-y-4">
                {topCities.map((city, index) => (
                  <div
                    key={city.city}
                    className="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300"
                  >
                    <div className="flex items-center gap-3">
                      <div
                        className={cn(
                          'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg',
                          index === 0
                            ? 'bg-gradient-to-r from-yellow-400 to-orange-500'
                            : index === 1
                              ? 'bg-gradient-to-r from-gray-400 to-gray-500'
                              : index === 2
                                ? 'bg-gradient-to-r from-orange-400 to-red-500'
                                : 'bg-gradient-to-r from-green-400 to-emerald-500'
                        )}
                      >
                        {index + 1}
                      </div>
                      <div className="flex items-center gap-2">
                        <MapPin className="w-4 h-4 text-green-600" />
                        <span className="font-medium text-gray-800">
                          {city.city}
                        </span>
                      </div>
                    </div>
                    <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {city.count}
                    </Badge>
                  </div>
                ))}
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="activity" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.userActivity.title}
              description={dict.charts.userActivity.description}
              gradient="from-orange-500 to-amber-500"
              icon={<Activity className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-orange-800">
                        {dict.charts.userActivity.weeklyActive}
                      </span>
                      <TrendingUp className="w-4 h-4 text-orange-600" />
                    </div>
                    <span className="text-2xl font-bold text-orange-900">
                      {activityTrend.weekly}
                    </span>
                  </div>
                  <div className="p-4 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl border border-amber-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-amber-800">
                        {dict.charts.userActivity.monthlyActive}
                      </span>
                      <Activity className="w-4 h-4 text-amber-600" />
                    </div>
                    <span className="text-2xl font-bold text-amber-900">
                      {activityTrend.monthly}
                    </span>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-100">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-yellow-800">
                      {dict.charts.userActivity.avgLogin}
                    </span>
                    <Clock className="w-4 h-4 text-yellow-600" />
                  </div>
                  <span className="text-2xl font-bold text-yellow-900">
                    {activityTrend.average} {dict.charts.userActivity.days}
                  </span>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.activityTrend.title}
              description={dict.charts.activityTrend.description}
              gradient="from-indigo-500 to-purple-500"
              icon={<Star className="w-6 h-6" />}
            >
              <div className="flex items-center justify-center h-64 text-gray-500">
                <div className="text-center">
                  <Sparkles className="w-12 h-12 mx-auto mb-4 text-indigo-400" />
                  <p>{dict.charts.activityTrend.comingSoon}</p>
                  <p className="text-sm">
                    {dict.charts.activityTrend.subtitle}
                  </p>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="completion" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.profileCompletion.title}
              description={dict.charts.profileCompletion.description}
              gradient="from-red-500 to-pink-500"
              icon={<Target className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg">
                        <ImageIcon className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasPhotos}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasPhotos}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl border border-pink-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg">
                        <CheckCircle className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.isVerified}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-pink-500 to-rose-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.isVerified}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-rose-50 to-red-50 rounded-xl border border-rose-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-rose-500 to-red-500 text-white shadow-lg">
                        <Users className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasReferences}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-rose-500 to-red-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasReferences}%
                    </Badge>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.performance.title}
              description={dict.charts.performance.description}
              gradient="from-emerald-500 to-green-500"
              icon={<Award className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="text-center p-4 bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl border border-emerald-100">
                    <Crown className="w-8 h-8 mx-auto mb-2 text-emerald-600" />
                    <div className="text-2xl font-bold text-emerald-800">
                      A+
                    </div>
                    <div className="text-sm text-emerald-600">
                      {dict.charts.performance.qualityRating}
                    </div>
                  </div>
                  <div className="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                    <Zap className="w-8 h-8 mx-auto mb-2 text-green-600" />
                    <div className="text-2xl font-bold text-green-800">95%</div>
                    <div className="text-sm text-green-600">
                      {dict.charts.performance.satisfaction}
                    </div>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                  <div className="flex items-center justify-between mb-3">
                    <span className="font-medium text-blue-800">
                      {dict.charts.performance.monthlyProgress}
                    </span>
                    <TrendingUp className="w-4 h-4 text-blue-600" />
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.newCandidates}
                      </span>
                      <span className="font-bold text-blue-800">+12%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.activity}
                      </span>
                      <span className="font-bold text-blue-800">+8%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.profileCompletion}
                      </span>
                      <span className="font-bold text-blue-800">+5%</span>
                    </div>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default CandidatesStats;
--- End of Content for CandidatesStats.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\SplitView.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/SplitView.tsx
'use client';

import React, { useMemo, useEffect, useState, useCallback } from 'react';
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from '@/components/ui/resizable';
import CandidatesList from './CandidatesList';
import { Badge } from '@/components/ui/badge';
import {
  Sparkles,
  XCircle,
  Target,
  Crown,
  Zap,
  Search,
  Loader2,
  RefreshCw,
  Database,
  Clock,
  Brain,
  MessageSquare,
  CheckCircle2,
  X,
  Users,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { FilterState } from '../types/filters';
import SearchBar from '../Filters/SearchBar';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { Gender } from '@prisma/client';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { motion, AnimatePresence } from 'framer-motion';

//  Import the global context
import {
  useMatchingJobContext,
  type SearchMethod,
  type MatchResult,
} from '@/app/[locale]/contexts/MatchingJobContext';

// ============================================================================
// TYPES & INTERFACES
// ============================================================================

type BackgroundCompatibility =
  | 'excellent'
  | 'good'
  | 'possible'
  | 'problematic'
  | 'not_recommended';

interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

interface AiMatch {
  userId: string;
  firstName?: string;
  lastName?: string;
  score?: number;
  firstPassScore?: number;
  finalScore?: number;
  scoreBreakdown?: ScoreBreakdown;
  reasoning?: string;
  shortReasoning?: string;
  detailedReasoning?: string;
  rank?: number;
  backgroundMultiplier?: number;
  backgroundCompatibility?: BackgroundCompatibility;
  similarity?: number;
}

interface AiMatchMeta {
  fromCache: boolean;
  savedAt?: string;
  isStale?: boolean;
  algorithmVersion: string;
  totalCandidatesScanned?: number;
  durationMs?: number;
}

type CandidateWithAiData = Candidate & {
  aiScore?: number;
  aiReasoning?: string;
  aiMatch?: AiMatch;
  aiRank?: number;
  aiFirstPassScore?: number;
  aiScoreBreakdown?: ScoreBreakdown;
  aiBackgroundMultiplier?: number;
  aiBackgroundCompatibility?: BackgroundCompatibility;
  aiSimilarity?: number;
};

interface SplitViewProps {
  isQuickViewEnabled: boolean;
  maleCandidates: Candidate[];
  femaleCandidates: Candidate[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void;
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void;
  onCandidateAction: (type: CandidateAction, candidate: Candidate) => void;
  onCandidateClick: (candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  locale: string;
  aiTargetCandidate: Candidate | null;
  aiMatches: AiMatch[];
  isAiLoading: boolean;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  onClearAiTarget: (e: React.MouseEvent) => void;
  setAiMatches: React.Dispatch<React.SetStateAction<AiMatch[]>>;
  setIsAiLoading: React.Dispatch<React.SetStateAction<boolean>>;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  separateFiltering: boolean;
  maleFilters?: Partial<FilterState>;
  femaleFilters?: Partial<FilterState>;
  onMaleFiltersChange: (filters: Partial<FilterState>) => void;
  onFemaleFiltersChange: (filters: Partial<FilterState>) => void;
  onCopyFilters: (source: 'male' | 'female', target: 'male' | 'female') => void;
  maleSearchQuery?: string;
  femaleSearchQuery?: string;
  onMaleSearchChange?: (query: string) => void;
  onFemaleSearchChange?: (query: string) => void;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

// ============================================================================
// SCORE BREAKDOWN DISPLAY COMPONENT
// ============================================================================

const ScoreBreakdownDisplay: React.FC<{
  breakdown: ScoreBreakdown;
  className?: string;
}> = ({ breakdown, className }) => {
  const categories = [
    { key: 'religious', label: '转 转转', max: 35, color: 'bg-purple-500' },
    {
      key: 'careerFamily',
      label: '拽专专-砖驻',
      max: 15,
      color: 'bg-blue-500',
    },
    { key: 'lifestyle', label: '住 ', max: 15, color: 'bg-green-500' },
    { key: 'ambition', label: '砖驻转转', max: 12, color: 'bg-orange-500' },
    { key: 'communication', label: '转拽砖专转', max: 12, color: 'bg-cyan-500' },
    { key: 'values', label: '注专', max: 11, color: 'bg-pink-500' },
  ];

  return (
    <div className={cn('space-y-1.5', className)}>
      {categories.map((cat) => {
        const value = breakdown[cat.key as keyof ScoreBreakdown] || 0;
        const percentage = (value / cat.max) * 100;
        return (
          <div key={cat.key} className="flex items-center gap-2">
            <span className="text-xs text-gray-600 w-20 truncate">
              {cat.label}
            </span>
            <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${percentage}%` }}
                transition={{ duration: 0.5, ease: 'easeOut' }}
                className={cn('h-full rounded-full', cat.color)}
              />
            </div>
            <span className="text-xs text-gray-500 w-10 text-right">
              {value}/{cat.max}
            </span>
          </div>
        );
      })}
    </div>
  );
};

// ============================================================================
// AI REASONING DISPLAY COMPONENT
// ============================================================================

const AiReasoningDisplay: React.FC<{
  reasoning?: string;
  similarity?: number;
  method?: SearchMethod;
  className?: string;
}> = ({ reasoning, similarity, method, className }) => {
  if (!reasoning && !similarity) return null;

  return (
    <motion.div
      initial={{ opacity: 0, y: 5 }}
      animate={{ opacity: 1, y: 0 }}
      className={cn(
        'mt-2 p-3 rounded-lg text-sm',
        method === 'vector'
          ? 'bg-blue-50 border border-blue-100'
          : 'bg-purple-50 border border-purple-100',
        className
      )}
    >
      <div className="flex items-start gap-2">
        <MessageSquare
          className={cn(
            'w-4 h-4 mt-0.5 flex-shrink-0',
            method === 'vector' ? 'text-blue-500' : 'text-purple-500'
          )}
        />
        <div className="flex-1">
          {similarity !== undefined && (
            <div className="text-xs text-gray-500 mb-1">
               拽专: {(similarity * 100).toFixed(1)}%
            </div>
          )}
          {reasoning && (
            <p className="text-gray-700 leading-relaxed">{reasoning}</p>
          )}
        </div>
      </div>
    </motion.div>
  );
};

// ============================================================================
// CACHE INFO BADGE COMPONENT
// ============================================================================

const CacheInfoBadge: React.FC<{
  meta: AiMatchMeta | null;
  matchesCount: number;
  method?: SearchMethod;
}> = ({ meta, matchesCount, method }) => {
  if (!meta || matchesCount === 0) return null;

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return '';
    try {
      return new Date(dateStr).toLocaleDateString('he-IL', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch {
      return '';
    }
  };

  const methodLabel = method === 'vector' ? '拽专' : 'AI';

  if (meta.fromCache) {
    return (
      <motion.div
        initial={{ scale: 0, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        className={cn(
          'flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full font-medium',
          meta.isStale
            ? 'bg-amber-100 text-amber-700 border border-amber-200'
            : 'bg-emerald-100 text-emerald-700 border border-emerald-200'
        )}
      >
        {meta.isStale ? (
          <>
            <Clock className="w-3 h-3" />
            <span>
              {methodLabel} 砖 ({formatDate(meta.savedAt)})
            </span>
          </>
        ) : (
          <>
            <Database className="w-3 h-3" />
            <span>
              {methodLabel} 砖专 ({formatDate(meta.savedAt)})
            </span>
          </>
        )}
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      className={cn(
        'flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full font-medium border',
        method === 'vector'
          ? 'bg-blue-100 text-blue-700 border-blue-200'
          : 'bg-purple-100 text-purple-700 border-purple-200'
      )}
    >
      {method === 'vector' ? (
        <Zap className="w-3 h-3" />
      ) : (
        <Sparkles className="w-3 h-3" />
      )}
      <span>砖</span>
      {meta.totalCandidatesScanned && (
        <span className="opacity-70">
          ({meta.totalCandidatesScanned} 住专拽)
        </span>
      )}
    </motion.div>
  );
};

// ============================================================================
// SEARCH METHOD TABS COMPONENT
// ============================================================================

const SearchMethodTabs: React.FC<{
  activeMethod: SearchMethod;
  onMethodChange: (method: SearchMethod) => void;
  algorithmicCount: number;
  vectorCount: number;
  isLoading: boolean;
}> = ({
  activeMethod,
  onMethodChange,
  algorithmicCount,
  vectorCount,
  isLoading,
}) => {
  return (
    <div className="flex gap-1 p-1 bg-gray-100 rounded-lg">
      <button
        onClick={() => onMethodChange('algorithmic')}
        disabled={isLoading}
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all',
          activeMethod === 'algorithmic'
            ? 'bg-white shadow-sm text-purple-700'
            : 'text-gray-600 hover:text-gray-800'
        )}
      >
        <Brain className="w-4 h-4" />
        <span>AI 转拽</span>
        {algorithmicCount > 0 && (
          <Badge variant="secondary" className="text-xs px-1.5 py-0">
            {algorithmicCount}
          </Badge>
        )}
      </button>
      <button
        onClick={() => onMethodChange('vector')}
        disabled={isLoading}
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all',
          activeMethod === 'vector'
            ? 'bg-white shadow-sm text-blue-700'
            : 'text-gray-600 hover:text-gray-800'
        )}
      >
        <Zap className="w-4 h-4" />
        <span> 专</span>
        {vectorCount > 0 && (
          <Badge variant="secondary" className="text-xs px-1.5 py-0">
            {vectorCount}
          </Badge>
        )}
      </button>
    </div>
  );
};

// ============================================================================
//  INLINE PROGRESS COMPONENT - Progress 拽 转 驻转专
// ============================================================================

const InlineJobProgress: React.FC<{
  progress: number;
  progressMessage: string;
  method: SearchMethod;
  onCancel: () => void;
}> = ({ progress, progressMessage, method, onCancel }) => {
  const isVector = method === 'vector';
  const gradientClass = isVector
    ? 'from-blue-500 to-cyan-500'
    : 'from-purple-500 to-pink-500';
  const bgClass = isVector ? 'bg-blue-50' : 'bg-purple-50';

  return (
    <motion.div
      initial={{ opacity: 0, height: 0 }}
      animate={{ opacity: 1, height: 'auto' }}
      exit={{ opacity: 0, height: 0 }}
      className={cn('rounded-lg p-3 border', bgClass)}
    >
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Loader2
            className={cn(
              'w-4 h-4 animate-spin',
              isVector ? 'text-blue-600' : 'text-purple-600'
            )}
          />
          <span className="text-sm font-medium text-gray-700">
            {progressMessage || '注...'}
          </span>
        </div>
        <Button
          variant="ghost"
          size="sm"
          onClick={onCancel}
          className="h-6 w-6 p-0 text-gray-400 hover:text-gray-600"
        >
          <X className="w-3 h-3" />
        </Button>
      </div>

      <div className="relative">
        <Progress value={progress} className="h-2" />
      </div>

      <div className="flex justify-between mt-1 text-xs text-gray-500">
        <span>{progress}%</span>
        <span>专抓 专拽注 - 转 砖 注</span>
      </div>
    </motion.div>
  );
};

// ============================================================================
//  JOB COMPLETE BANNER
// ============================================================================

const JobCompleteBanner: React.FC<{
  matchesCount: number;
  targetName: string;
  method: SearchMethod;
  onViewResults: () => void;
  onDismiss: () => void;
}> = ({ matchesCount, targetName, method, onViewResults, onDismiss }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: -10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -10 }}
      className="rounded-lg p-3 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200"
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <CheckCircle2 className="w-5 h-5 text-green-600" />
          <div>
            <span className="font-medium text-green-800">
              爪 {matchesCount} 转转 注专 {targetName}!
            </span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Button
            size="sm"
            onClick={onViewResults}
            className="bg-green-600 hover:bg-green-700 text-white"
          >
            <Sparkles className="w-4 h-4 ml-1" />
            爪
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={onDismiss}
            className="h-8 w-8 p-0"
          >
            <X className="w-4 h-4" />
          </Button>
        </div>
      </div>
    </motion.div>
  );
};

// ============================================================================
// PANEL HEADER COMPONENT
// ============================================================================

const PanelHeaderComponent: React.FC<{
  gender: 'male' | 'female';
  count: number;
  aiTargetCandidate: Candidate | null;
  isSearchPanel: boolean;
  isTargetPanel: boolean;
  onClearAiTarget: (e: React.MouseEvent) => void;
  onFindAiMatches: (
    e: React.MouseEvent,
    forceRefresh: boolean,
    method: SearchMethod
  ) => void;
  isAiLoading: boolean;
  currentSearchMethod: SearchMethod;
  isMobileView?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['splitView']['panelHeaders'];
  aiMatchMeta: AiMatchMeta | null;
  vectorMatchMeta: AiMatchMeta | null;
  aiMatchesCount: number;
  vectorMatchesCount: number;
  activeResultsTab: SearchMethod;
  onResultsTabChange: (method: SearchMethod) => void;
  //  Props from context
  jobProgress: number;
  jobProgressMessage: string;
  jobStatus: string;
  onCancelJob: () => void;
  showCompleteBanner: boolean;
  onDismissBanner: () => void;
  onViewResults: () => void;
}> = ({
  gender,
  count,
  aiTargetCandidate,
  isSearchPanel,
  isTargetPanel,
  onClearAiTarget,
  onFindAiMatches,
  isAiLoading,
  currentSearchMethod,
  isMobileView = false,
  dict,
  aiMatchMeta,
  vectorMatchMeta,
  aiMatchesCount,
  vectorMatchesCount,
  activeResultsTab,
  onResultsTabChange,
  jobProgress,
  jobProgressMessage,
  jobStatus,
  onCancelJob,
  showCompleteBanner,
  onDismissBanner,
  onViewResults,
}) => {
  const genderConfig = {
    male: {
      title: dict.male.title,
      subtitle: dict.male.subtitle.replace('{{count}}', count.toString()),
      icon: Target,
      colors: {
        gradient: 'from-blue-500 to-cyan-500',
        bg: 'from-blue-50 to-cyan-50',
        text: 'text-blue-800',
        badge: 'bg-blue-500',
      },
    },
    female: {
      title: dict.female.title,
      subtitle: dict.female.subtitle.replace('{{count}}', count.toString()),
      icon: Crown,
      colors: {
        gradient: 'from-purple-500 to-pink-500',
        bg: 'from-purple-50 to-pink-50',
        text: 'text-purple-800',
        badge: 'bg-purple-500',
      },
    },
  };

  const config = genderConfig[gender];
  const IconComponent = config.icon;
  const hasAnyResults = aiMatchesCount > 0 || vectorMatchesCount > 0;
  const isJobRunning = jobStatus === 'pending' || jobStatus === 'processing';

  return (
    <div
      className={cn(
        'flex flex-col gap-3 p-4 rounded-t-2xl',
        !isMobileView &&
          `bg-gradient-to-r ${config.colors.bg} border-b border-gray-100/50`
      )}
    >
      {/* Header Row */}
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-3">
          <motion.div
            className={cn(
              'p-3 rounded-full shadow-lg text-white transition-transform',
              `bg-gradient-to-r ${config.colors.gradient}`
            )}
          >
            <IconComponent className="w-6 h-6" />
          </motion.div>
          <div>
            <h2 className={cn('text-xl font-bold', config.colors.text)}>
              {config.title}
            </h2>
            <p className="text-sm text-gray-600">{config.subtitle}</p>
          </div>
          <Badge
            className={cn(
              'text-white border-0 shadow-lg px-3 py-1 font-bold',
              config.colors.badge
            )}
          >
            {count}
          </Badge>
        </div>

        {/* Target indicator */}
        {isTargetPanel && aiTargetCandidate && (
          <motion.div
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0, opacity: 0 }}
            className="flex items-center gap-2 bg-green-100 p-2 rounded-full shadow-lg"
          >
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
            <span className="text-sm font-medium text-green-800 px-2">
              {dict.targetLabel.replace(
                '{{name}}',
                aiTargetCandidate.firstName
              )}
            </span>
            <Button
              size="icon"
              variant="ghost"
              className="h-6 w-6 text-green-700 hover:bg-green-200 rounded-full"
              onClick={onClearAiTarget}
            >
              <XCircle className="h-4 w-4" />
            </Button>
          </motion.div>
        )}
      </div>

      {/* Search buttons - only show on search panel */}
      {isSearchPanel && (
        <div className="flex flex-col gap-2">
          {/*  Show completion banner if job just completed */}
          <AnimatePresence>
            {showCompleteBanner && (
              <JobCompleteBanner
                matchesCount={
                  activeResultsTab === 'vector'
                    ? vectorMatchesCount
                    : aiMatchesCount
                }
                targetName={aiTargetCandidate?.firstName || '注'}
                method={currentSearchMethod}
                onViewResults={onViewResults}
                onDismiss={onDismissBanner}
              />
            )}
          </AnimatePresence>

          {/*  Show progress if job is running */}
          <AnimatePresence>
            {isJobRunning && (
              <InlineJobProgress
                progress={jobProgress}
                progressMessage={jobProgressMessage}
                method={currentSearchMethod}
                onCancel={onCancelJob}
              />
            )}
          </AnimatePresence>

          {/* Search buttons - always visible, not disabled during search */}
          {!isJobRunning && !showCompleteBanner && (
            <>
              <div className="flex gap-2">
                <motion.div className="flex-1" whileHover={{ scale: 1.02 }}>
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'algorithmic')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg',
                      'bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white'
                    )}
                  >
                    <Brain className="w-5 h-5 ml-2" />
                    <span>驻砖 AI 转拽</span>
                  </Button>
                </motion.div>

                <motion.div className="flex-1" whileHover={{ scale: 1.02 }}>
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'vector')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg',
                      'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white'
                    )}
                  >
                    <Zap className="w-5 h-5 ml-2" />
                    <span> 专 </span>
                  </Button>
                </motion.div>

                {hasAnyResults && (
                  <Button
                    size="icon"
                    variant="outline"
                    onClick={(e) => onFindAiMatches(e, true, activeResultsTab)}
                    className="h-11 w-11"
                  >
                    <RefreshCw className="w-5 h-5" />
                  </Button>
                )}
              </div>

              <div className="flex gap-2 text-xs text-gray-500">
                <span className="flex-1 text-center">
                  ~3-5 拽转  转 注拽
                </span>
                <span className="flex-1 text-center">
                  ~30 砖转  驻砖 
                </span>
              </div>
            </>
          )}

          {/* Results tabs */}
          {hasAnyResults && !isJobRunning && (
            <div className="flex items-center justify-between mt-2">
              <SearchMethodTabs
                activeMethod={activeResultsTab}
                onMethodChange={onResultsTabChange}
                algorithmicCount={aiMatchesCount}
                vectorCount={vectorMatchesCount}
                isLoading={isJobRunning}
              />
              <CacheInfoBadge
                meta={
                  activeResultsTab === 'vector' ? vectorMatchMeta : aiMatchMeta
                }
                matchesCount={
                  activeResultsTab === 'vector'
                    ? vectorMatchesCount
                    : aiMatchesCount
                }
                method={activeResultsTab}
              />
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// ============================================================================
// LOADING COMPONENT
// ============================================================================

const LoadingComponent: React.FC<{ gender: 'male' | 'female' }> = ({
  gender,
}) => {
  const config =
    gender === 'male'
      ? {
          gradient: 'from-blue-200 to-cyan-200',
          icon: Target,
          title: '注 注...',
        }
      : {
          gradient: 'from-purple-200 to-pink-200',
          icon: Crown,
          title: '注转 注转...',
        };
  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <motion.div
        animate={{ scale: [1, 1.2, 1], rotate: [0, 360] }}
        transition={{ duration: 2, repeat: Infinity, ease: 'easeInOut' }}
        className={cn(
          'p-6 rounded-full mb-4',
          `bg-gradient-to-r ${config.gradient}`
        )}
      >
        <IconComponent className="w-12 h-12 text-white" />
      </motion.div>
      <h3 className="text-lg font-bold text-gray-700">{config.title}</h3>
    </motion.div>
  );
};

// ============================================================================
// EMPTY STATE COMPONENT
// ============================================================================

const EmptyStateComponent: React.FC<{
  gender: 'male' | 'female';
  searchQuery?: string;
  onClearSearch?: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['emptyState'];
}> = ({ gender, searchQuery, onClearSearch, dict }) => {
  const config =
    gender === 'male'
      ? { gradient: 'from-blue-100 to-cyan-100', icon: Target }
      : { gradient: 'from-purple-100 to-pink-100', icon: Crown };
  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <div
        className={cn(
          'w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-lg',
          `bg-gradient-to-br ${config.gradient}`
        )}
      >
        <IconComponent className="w-12 h-12 text-gray-400" />
      </div>
      <h3 className="text-xl font-bold text-gray-800 mb-2">{dict.title}</h3>
      <p className="text-gray-600 text-center mb-4">
        {searchQuery
          ? ` 爪 转爪转 注专 "${searchQuery}"`
          : dict.description}
      </p>
      {searchQuery && onClearSearch && (
        <Button variant="outline" onClick={onClearSearch}>
          <Search className="w-4 h-4 ml-2" />
          拽 驻砖
        </Button>
      )}
    </motion.div>
  );
};

// ============================================================================
// HELPER FUNCTION
// ============================================================================

function toBackgroundCompatibility(
  value: string | undefined
): BackgroundCompatibility | undefined {
  const validValues: BackgroundCompatibility[] = [
    'excellent',
    'good',
    'possible',
    'problematic',
    'not_recommended',
  ];
  if (value && validValues.includes(value as BackgroundCompatibility)) {
    return value as BackgroundCompatibility;
  }
  return undefined;
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

const SplitView: React.FC<SplitViewProps> = ({
  dict,
  onOpenAiAnalysis,
  onSendProfileFeedback,
  profileDict,
  isQuickViewEnabled,
  locale,
  ...props
}) => {
  const {
    maleCandidates,
    femaleCandidates,
    allCandidates,
    onCandidateAction,
    onCandidateClick,
    viewMode,
    mobileView,
    isLoading = false,
    className,
    maleSearchQuery = '',
    femaleSearchQuery = '',
    onMaleSearchChange,
    onFemaleSearchChange,
    aiTargetCandidate,
    aiMatches,
    isAiLoading,
    onSetAiTarget,
    onClearAiTarget,
    setAiMatches,
    setIsAiLoading,
    comparisonSelection,
    onToggleComparison,
    separateFiltering,
  } = props;

  //  Use global context
  const matchingJobContext = useMatchingJobContext();
  const { currentJob, startJob, cancelJob, isJobRunning, onJobComplete } =
    matchingJobContext;

  const [isMobile, setIsMobile] = useState(false);
  const [aiMatchMeta, setAiMatchMeta] = useState<AiMatchMeta | null>(null);
  const [vectorMatches, setVectorMatches] = useState<AiMatch[]>([]);
  const [vectorMatchMeta, setVectorMatchMeta] = useState<AiMatchMeta | null>(
    null
  );
  const [currentSearchMethod, setCurrentSearchMethod] =
    useState<SearchMethod>('algorithmic');
  const [activeResultsTab, setActiveResultsTab] =
    useState<SearchMethod>('algorithmic');
  const [showCompleteBanner, setShowCompleteBanner] = useState(false);

  useEffect(() => {
    const checkScreenSize = () => setIsMobile(window.innerWidth < 768);
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => window.removeEventListener('resize', checkScreenSize);
  }, []);

  //  Subscribe to job completion
  useEffect(() => {
    const unsubscribe = onJobComplete((result) => {
      if (result?.matches) {
        // Update the appropriate state based on method
        if (currentJob.method === 'vector') {
          setVectorMatches(result.matches as AiMatch[]);
          setVectorMatchMeta({
            fromCache: currentJob.fromCache,
            algorithmVersion: result.meta?.algorithmVersion || 'vector-v1',
            totalCandidatesScanned: result.meta?.totalCandidatesScanned,
          });
          setActiveResultsTab('vector');
        } else {
          setAiMatches(result.matches as AiMatch[]);
          setAiMatchMeta({
            fromCache: currentJob.fromCache,
            algorithmVersion: result.meta?.algorithmVersion || 'v3.1',
            totalCandidatesScanned: result.meta?.totalCandidatesScanned,
          });
          setActiveResultsTab('algorithmic');
        }
        setShowCompleteBanner(true);
      }
    });

    return unsubscribe;
  }, [onJobComplete, currentJob.method, currentJob.fromCache, setAiMatches]);

  //  Listen for "view results" event
  useEffect(() => {
    const handleViewResults = () => {
      setShowCompleteBanner(false);
      const resultsEl = document.getElementById('candidates-results');
      if (resultsEl) {
        resultsEl.scrollIntoView({ behavior: 'smooth' });
      }
    };

    window.addEventListener('matching-job-view-results', handleViewResults);
    return () =>
      window.removeEventListener(
        'matching-job-view-results',
        handleViewResults
      );
  }, []);

  //  Updated function - uses global context
  const handleFindAiMatches = useCallback(
    async (
      e: React.MouseEvent,
      forceRefresh: boolean = false,
      method: SearchMethod = 'algorithmic'
    ) => {
      e.stopPropagation();

      if (!aiTargetCandidate) {
        toast.error(' 专 注/转 专 转', {
          position: 'top-center',
          icon: '锔',
        });
        return;
      }

      setCurrentSearchMethod(method);
      setShowCompleteBanner(false);

      // Clear previous results for this method
      if (method === 'vector') {
        setVectorMatches([]);
        setVectorMatchMeta(null);
      } else {
        setAiMatches([]);
        setAiMatchMeta(null);
      }

      //  Use global context to start job
      await startJob(
        aiTargetCandidate.id,
        aiTargetCandidate.firstName,
        method,
        forceRefresh
      );
    },
    [aiTargetCandidate, setAiMatches, startJob]
  );

  const handleViewResults = useCallback(() => {
    setShowCompleteBanner(false);
    const resultsEl = document.getElementById('candidates-results');
    if (resultsEl) {
      resultsEl.scrollIntoView({ behavior: 'smooth' });
    }
  }, []);

  // Get active matches
  const getActiveMatches = (): AiMatch[] => {
    return activeResultsTab === 'vector' ? vectorMatches : aiMatches;
  };

  // Merge candidates with AI scores
  const maleCandidatesWithScores: CandidateWithAiData[] = useMemo(() => {
    const activeMatches = getActiveMatches();
    if (activeMatches.length === 0) return maleCandidates;
    const matchMap = new Map(activeMatches.map((m) => [m.userId, m]));

    return maleCandidates
      .map((c): CandidateWithAiData => {
        const match = matchMap.get(c.id);
        return {
          ...c,
          aiScore: match?.finalScore ?? match?.score,
          aiReasoning:
            match?.detailedReasoning ??
            match?.reasoning ??
            match?.shortReasoning,
          aiMatch: match,
          aiRank: match?.rank,
          aiFirstPassScore: match?.firstPassScore,
          aiScoreBreakdown: match?.scoreBreakdown,
          aiBackgroundMultiplier: match?.backgroundMultiplier,
          aiBackgroundCompatibility: toBackgroundCompatibility(
            match?.backgroundCompatibility
          ),
          aiSimilarity: match?.similarity,
        };
      })
      .sort((a, b) => {
        if (a.aiRank && b.aiRank) return a.aiRank - b.aiRank;
        return (b.aiScore ?? -1) - (a.aiScore ?? -1);
      });
  }, [maleCandidates, aiMatches, vectorMatches, activeResultsTab]);

  const femaleCandidatesWithScores: CandidateWithAiData[] = useMemo(() => {
    const activeMatches = getActiveMatches();
    if (activeMatches.length === 0) return femaleCandidates;
    const matchMap = new Map(activeMatches.map((m) => [m.userId, m]));

    return femaleCandidates
      .map((c): CandidateWithAiData => {
        const match = matchMap.get(c.id);
        return {
          ...c,
          aiScore: match?.finalScore ?? match?.score,
          aiReasoning:
            match?.detailedReasoning ??
            match?.reasoning ??
            match?.shortReasoning,
          aiMatch: match,
          aiRank: match?.rank,
          aiFirstPassScore: match?.firstPassScore,
          aiScoreBreakdown: match?.scoreBreakdown,
          aiBackgroundMultiplier: match?.backgroundMultiplier,
          aiBackgroundCompatibility: toBackgroundCompatibility(
            match?.backgroundCompatibility
          ),
          aiSimilarity: match?.similarity,
        };
      })
      .sort((a, b) => {
        if (a.aiRank && b.aiRank) return a.aiRank - b.aiRank;
        return (b.aiScore ?? -1) - (a.aiScore ?? -1);
      });
  }, [femaleCandidates, aiMatches, vectorMatches, activeResultsTab]);

  const renderPanelHeader = (
    gender: 'male' | 'female',
    isMobileView: boolean = false
  ) => {
    const panelGenderEnum = gender === 'male' ? Gender.MALE : Gender.FEMALE;
    const isTargetPanel = aiTargetCandidate?.profile.gender === panelGenderEnum;
    const isSearchPanel = !!(
      aiTargetCandidate && aiTargetCandidate.profile.gender !== panelGenderEnum
    );
    const count =
      gender === 'male' ? maleCandidates.length : femaleCandidates.length;

    return (
      <PanelHeaderComponent
        gender={gender}
        count={count}
        aiTargetCandidate={aiTargetCandidate}
        isSearchPanel={isSearchPanel}
        isTargetPanel={isTargetPanel}
        onClearAiTarget={onClearAiTarget}
        onFindAiMatches={handleFindAiMatches}
        isAiLoading={isJobRunning}
        currentSearchMethod={currentSearchMethod}
        isMobileView={isMobileView}
        dict={dict.candidatesManager.splitView.panelHeaders}
        aiMatchMeta={aiMatchMeta}
        vectorMatchMeta={vectorMatchMeta}
        aiMatchesCount={aiMatches.length}
        vectorMatchesCount={vectorMatches.length}
        activeResultsTab={activeResultsTab}
        onResultsTabChange={setActiveResultsTab}
        //  Pass context data
        jobProgress={currentJob.progress}
        jobProgressMessage={currentJob.progressMessage}
        jobStatus={currentJob.status}
        onCancelJob={cancelJob}
        showCompleteBanner={showCompleteBanner}
        onDismissBanner={() => setShowCompleteBanner(false)}
        onViewResults={handleViewResults}
      />
    );
  };

  const renderCandidatesListForMobile = (
    candidates: CandidateWithAiData[],
    gender: 'male' | 'female',
    searchQuery: string,
    onSearchChange?: (query: string) => void
  ) => {
    if (isLoading) return <LoadingComponent gender={gender} />;
    if (candidates.length === 0)
      return (
        <EmptyStateComponent
          gender={gender}
          searchQuery={searchQuery}
          onClearSearch={() => onSearchChange?.('')}
          dict={dict.candidatesManager.list.emptyState}
        />
      );
    return (
      <CandidatesList
        candidates={candidates}
        allCandidates={allCandidates}
        onOpenAiAnalysis={onOpenAiAnalysis}
        onCandidateClick={onCandidateClick}
        onSendProfileFeedback={onSendProfileFeedback}
        onCandidateAction={onCandidateAction}
        viewMode={viewMode}
        mobileView={mobileView}
        isLoading={isLoading}
        highlightTerm={searchQuery}
        aiTargetCandidate={aiTargetCandidate}
        onSetAiTarget={onSetAiTarget}
        comparisonSelection={comparisonSelection}
        onToggleComparison={onToggleComparison}
        quickViewSide={gender === 'male' ? 'right' : 'left'}
        isQuickViewEnabled={isQuickViewEnabled}
        dict={dict}
        profileDict={profileDict}
        locale={locale}
      />
    );
  };

  // MOBILE VIEW
  if (isMobile) {
    return (
      <div className={cn('flex flex-col h-full', className)}>
        <Tabs
          defaultValue="male"
          className="flex flex-col h-full overflow-hidden"
        >
          <TabsList className="grid grid-cols-2 mx-4 mb-2 bg-gradient-to-r from-blue-100 to-purple-100 p-1 rounded-xl shadow-lg">
            <TabsTrigger
              value="male"
              className="rounded-lg font-bold data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-700 transition-all"
            >
              <Target className="w-4 h-4 ml-1" />
              {dict.candidatesManager.splitView.panelHeaders.male.title} (
              {maleCandidates.length})
            </TabsTrigger>
            <TabsTrigger
              value="female"
              className="rounded-lg font-bold data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-purple-700 transition-all"
            >
              <Crown className="w-4 h-4 ml-1" />
              {dict.candidatesManager.splitView.panelHeaders.female.title} (
              {femaleCandidates.length})
            </TabsTrigger>
          </TabsList>

          <TabsContent value="male" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-blue-50/30 rounded-2xl">
              {aiTargetCandidate &&
                aiTargetCandidate.profile.gender === 'FEMALE' && (
                  <div className="mb-4">{renderPanelHeader('male', true)}</div>
                )}
              {separateFiltering && onMaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={maleSearchQuery}
                    onChange={onMaleSearchChange}
                    placeholder={
                      dict.candidatesManager.searchBar.malePlaceholder
                    }
                    genderTarget="male"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}
              <div
                id="candidates-results"
                className="flex-grow min-h-0 overflow-y-auto"
              >
                {renderCandidatesListForMobile(
                  maleCandidatesWithScores,
                  'male',
                  maleSearchQuery,
                  onMaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>

          <TabsContent value="female" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-purple-50/30 rounded-2xl">
              {aiTargetCandidate &&
                aiTargetCandidate.profile.gender === 'MALE' && (
                  <div className="mb-4">
                    {renderPanelHeader('female', true)}
                  </div>
                )}
              {separateFiltering && onFemaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={femaleSearchQuery}
                    onChange={onFemaleSearchChange}
                    placeholder={
                      dict.candidatesManager.searchBar.femalePlaceholder
                    }
                    genderTarget="female"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}
              <div
                id="candidates-results"
                className="flex-grow min-h-0 overflow-y-auto"
              >
                {renderCandidatesListForMobile(
                  femaleCandidatesWithScores,
                  'female',
                  femaleSearchQuery,
                  onFemaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    );
  }

  // DESKTOP VIEW
  return (
    <div className={cn('h-full', className)}>
      <ResizablePanelGroup
        direction="horizontal"
        className="h-full rounded-2xl bg-white shadow-2xl border-0 overflow-hidden"
      >
        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-blue-50/20">
            {renderPanelHeader('male')}
            {separateFiltering && onMaleSearchChange && (
              <div className="p-4 bg-blue-50/30 w-full">
                <SearchBar
                  value={maleSearchQuery}
                  onChange={onMaleSearchChange}
                  placeholder={dict.candidatesManager.searchBar.malePlaceholder}
                  genderTarget="male"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}
            <div
              id="candidates-results"
              className="flex-grow min-h-0 overflow-y-auto p-4"
            >
              <CandidatesList
                candidates={maleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={maleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="right"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>

        <ResizableHandle
          withHandle
          className="bg-gradient-to-b from-indigo-300 to-purple-300 hover:from-indigo-400 hover:to-purple-400 transition-colors w-2"
        />

        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-purple-50/20">
            {renderPanelHeader('female')}
            {separateFiltering && onFemaleSearchChange && (
              <div className="p-4 bg-purple-50/30 w-full">
                <SearchBar
                  value={femaleSearchQuery}
                  onChange={onFemaleSearchChange}
                  placeholder={
                    dict.candidatesManager.searchBar.femalePlaceholder
                  }
                  genderTarget="female"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}
            <div className="flex-grow min-h-0 overflow-y-auto p-4">
              <CandidatesList
                candidates={femaleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={femaleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="left"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>
      </ResizablePanelGroup>
    </div>
  );
};

export default SplitView;
--- End of Content for SplitView.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\StatsCard.tsx
--------------------------------------------------------------------------------
Content:
"use client";

import React from "react";

import { Card } from "@/components/ui/card";
import { cn } from "@/lib/utils";

interface StatsCardProps {
  icon: React.ElementType;
  title: string;
  value: string | number;
  trend?: {
    value: number;
    label: string;
    isPositive?: boolean;
  };
  variant?: "default" | "success" | "warning" | "destructive";
  bgGradient?: string;
  iconColor?: string;
  className?: string;
}

const StatsCard: React.FC<StatsCardProps> = ({
  icon: Icon,
  title,
  value,
  trend,
  variant = "default",
  bgGradient,
  iconColor = "text-primary",
  className,
}) => {
  const getVariantStyles = () => {
    switch (variant) {
      case "success":
        return "border-emerald-200";
      case "warning":
        return "border-amber-200";
      case "destructive":
        return "border-red-200";
      default:
        return "border-gray-200";
    }
  };

  return (
    <Card
      className={cn(
        "hover:shadow-md transition-all duration-300 p-4 overflow-hidden",
        bgGradient ? `bg-gradient-to-br ${bgGradient}` : "bg-card",
        getVariantStyles(),
        className
      )}
    >
      <div className="flex items-start justify-between">
        <div className="mr-4 flex-shrink-0">
          <div className={`p-2.5 rounded-full bg-white/60 backdrop-blur-sm shadow-sm`}>
            <Icon className={`w-4 h-4 ${iconColor}`} />
          </div>
        </div>

        <div className="flex-1 text-right">
          <p className="text-xs text-muted-foreground mb-1">{title}</p>
          <h3 className="text-xl font-bold">{value}</h3>

          {trend && (
            <div className="flex items-center justify-end gap-1 mt-1">
              <span
                className={cn(
                  "text-sm font-medium flex items-center gap-0.5",
                  trend.isPositive ? "text-emerald-600" : "text-red-600"
                )}
              >
                {trend.isPositive ? "+" : "-"}{trend.value}%
                <span className={`${trend.isPositive ? "rotate-0" : "rotate-180"} transition-transform`}>
                  
                </span>
              </span>
              <span className="text-[11px] text-muted-foreground">
                {trend.label}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Animated background pattern for more visual appeal */}
      <div className="absolute right-0 bottom-0 opacity-10 pointer-events-none">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="60" cy="60" r="40" fill="currentColor" />
        </svg>
      </div>
    </Card>
  );
};

export default StatsCard;
--- End of Content for StatsCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\index.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/index.tsx

'use client';

// --- React & Next.js Imports ---
import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { useSession } from 'next-auth/react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';

// --- Third-party Libraries ---
import {
  UserPlus,
  Filter,
  LayoutGrid,
  List,
  ArrowUpDown,
  RotateCw,
  Bot,
  Loader2,
  Columns,
  View,
  Users,
  Sparkles,
  TrendingUp,
  TrendingDown,
  Eye,
  EyeOff,
  GitCompare,
  X,
  UserCircle, // <-- 拽 砖 驻砖 专
} from 'lucide-react';
import { toast } from 'sonner';

// --- UI Components ---
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';

// --- Custom Hooks ---
import { useCandidates } from '../hooks/useCandidates';
import { useFilterLogic } from '../hooks/useFilterLogic';

// --- Internal Components ---
import SplitView from './SplitView';
import FilterPanel from '../Filters/FilterPanel';
import ActiveFilters from '../Filters/ActiveFilters';
import SearchBar from '../Filters/SearchBar';
import { LoadingContainer } from '../shared/LoadingStates';
import { AddManualCandidateDialog } from '../dialogs/AddManualCandidateDialog';
import { AiMatchAnalysisDialog } from '../dialogs/AiMatchAnalysisDialog';
import { ProfileFeedbackDialog } from '../dialogs/ProfileFeedbackDialog';
import { AiMatchmakerProfileAdvisorDialog } from '../dialogs/AiMatchmakerProfileAdvisorDialog';

// --- Virtual Search Components (NEW) ---
import { VirtualUserDialog, SavedVirtualProfiles } from '../VirtualSearch';

// --- Types, Constants & Utils ---
import type {
  Candidate,
  ViewMode,
  CandidatesFilter,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import { SORT_OPTIONS, VIEW_OPTIONS } from '../constants/filterOptions';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';

// --- Interfaces Definitions ---
type BackgroundCompatibility =
  | 'excellent'
  | 'good'
  | 'possible'
  | 'problematic'
  | 'not_recommended';

interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

interface AiMatch {
  userId: string;
  firstName?: string;
  lastName?: string;
  score?: number;
  firstPassScore?: number;
  finalScore?: number;
  scoreBreakdown?: ScoreBreakdown;
  reasoning?: string;
  shortReasoning?: string;
  detailedReasoning?: string;
  rank?: number;
  backgroundMultiplier?: number;
  backgroundCompatibility?: BackgroundCompatibility;
}

// ============================================================================
// Minimal Compact Header Component
// ============================================================================
const MinimalHeader: React.FC<{
  stats: {
    total: number;
    male: number;
    female: number;
    verified: number;
    activeToday: number;
    profilesComplete: number;
  };
  onAddCandidate: () => void;
  onRefresh: () => void;
  isRefreshing: boolean;
  onBulkUpdate?: () => void;
  isBulkUpdating?: boolean;
  isAdmin?: boolean;
  isCompact: boolean;
  onToggleCompact: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['header'];
}> = ({
  stats,
  onAddCandidate,
  onRefresh,
  isRefreshing,
  onBulkUpdate,
  isBulkUpdating,
  isAdmin,
  isCompact,
  onToggleCompact,
  dict,
}) => {
  return (
    <header
      className={cn(
        'sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm transition-all duration-300',
        isCompact ? 'h-16' : 'h-32'
      )}
    >
      <div className="container mx-auto px-6 h-full">
        {isCompact ? (
          // --- COMPACT MODE ---
          <div className="flex items-center justify-between h-full">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <div className="p-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                  <Users className="w-4 h-4" />
                </div>
                <h1 className="text-lg font-bold text-gray-800">
                  {dict.title}
                </h1>
              </div>
              <div className="hidden md:flex items-center gap-2">
                <Badge
                  variant="outline"
                  className="bg-blue-50 text-blue-700 border-blue-200"
                >
                  {stats.total} {dict.totalLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-emerald-50 text-emerald-700 border-emerald-200"
                >
                  {stats.verified} {dict.verifiedLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-orange-50 text-orange-700 border-orange-200"
                >
                  {stats.profilesComplete}
                  {dict.profilesCompleteLabel}
                </Badge>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button
                onClick={onAddCandidate}
                size="sm"
                className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-md"
              >
                <UserPlus className="w-4 h-4 ml-1" />
                {dict.addButton}
              </Button>
              <Button
                onClick={onRefresh}
                variant="outline"
                size="sm"
                disabled={isRefreshing}
                className="border-gray-300 hover:bg-gray-50"
              >
                <RotateCw
                  className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                />
              </Button>
              {isAdmin && onBulkUpdate && (
                <Button
                  onClick={onBulkUpdate}
                  variant="secondary"
                  size="sm"
                  disabled={isBulkUpdating}
                  className="bg-amber-500 hover:bg-amber-600 text-white"
                >
                  {isBulkUpdating ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Bot className="w-4 h-4" />
                  )}
                </Button>
              )}
              <Button
                onClick={onToggleCompact}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
                title={dict.expandTooltip}
              >
                <TrendingUp className="w-4 h-4" />
              </Button>
            </div>
          </div>
        ) : (
          // --- EXPANDED MODE ---
          <div className="flex flex-col justify-center h-full py-3">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                  <Users className="w-5 h-5" />
                </div>
                <div>
                  <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    {dict.advancedTitle}
                  </h1>
                  <p className="text-sm text-gray-600">
                    {dict.advancedSubtitle}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  onClick={onAddCandidate}
                  size="sm"
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg"
                >
                  <UserPlus className="w-4 h-4 ml-2" />
                  {dict.addCandidateButton}
                  <Sparkles className="w-3 h-3 mr-1" />
                </Button>
                <Button
                  onClick={onRefresh}
                  variant="outline"
                  size="sm"
                  disabled={isRefreshing}
                  className="border-indigo-300 text-indigo-600 hover:bg-indigo-50"
                >
                  <RotateCw
                    className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                  />
                </Button>
                {isAdmin && onBulkUpdate && (
                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button
                        variant="secondary"
                        size="sm"
                        disabled={isBulkUpdating}
                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white"
                      >
                        {isBulkUpdating ? (
                          <Loader2 className="w-4 h-4 animate-spin" />
                        ) : (
                          <Bot className="w-4 h-4" />
                        )}
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent dir="rtl">
                      <AlertDialogHeader>
                        <AlertDialogTitle>
                          {dict.bulkUpdateDialog.title}
                        </AlertDialogTitle>
                        <AlertDialogDescription>
                          {dict.bulkUpdateDialog.description}
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel>
                          {dict.bulkUpdateDialog.cancel}
                        </AlertDialogCancel>
                        <AlertDialogAction onClick={onBulkUpdate}>
                          {dict.bulkUpdateDialog.confirm}
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                )}
                <Button
                  onClick={onToggleCompact}
                  variant="ghost"
                  size="sm"
                  className="text-gray-500 hover:text-gray-700"
                  title={dict.collapseTooltip}
                >
                  <TrendingDown className="w-4 h-4" />
                </Button>
              </div>
            </div>
            <div className="grid grid-cols-6 gap-3">
              <div className="text-center bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-blue-100">
                <div className="text-lg font-bold text-blue-700">
                  {stats.total}
                </div>
                <div className="text-xs text-blue-600">{dict.stats.total}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-2 shadow-sm border border-indigo-100">
                <div className="text-lg font-bold text-indigo-700">
                  {stats.male}
                </div>
                <div className="text-xs text-indigo-600">{dict.stats.male}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-2 shadow-sm border border-purple-100">
                <div className="text-lg font-bold text-purple-700">
                  {stats.female}
                </div>
                <div className="text-xs text-purple-600">
                  {dict.stats.female}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-2 shadow-sm border border-emerald-100">
                <div className="text-lg font-bold text-emerald-700">
                  {stats.verified}
                </div>
                <div className="text-xs text-emerald-600">
                  {dict.stats.verified}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-2 shadow-sm border border-orange-100">
                <div className="text-lg font-bold text-orange-700">
                  {stats.activeToday}
                </div>
                <div className="text-xs text-orange-600">
                  {dict.stats.active}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-teal-100">
                <div className="text-lg font-bold text-teal-700">
                  {stats.profilesComplete}%
                </div>
                <div className="text-xs text-teal-600">
                  {dict.stats.complete}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </header>
  );
};

// ============================================================================
// Main Candidates Manager Component
// ============================================================================
interface CandidatesManagerProps {
  matchmakerDict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
  locale: string;
}

const CandidatesManager: React.FC<CandidatesManagerProps> = ({
  matchmakerDict,
  profileDict,
  locale,
}) => {
  // --- State Management ---
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [mobileView, setMobileView] = useState<MobileView>('double');
  const [isMobile, setIsMobile] = useState(false);
  const [showFiltersPanel, setShowFiltersPanel] = useState(false);
  const [showFiltersMobile, setShowFiltersMobile] = useState(false);
  const [showManualAddDialog, setShowManualAddDialog] = useState(false);
  const [isHeaderCompact, setIsHeaderCompact] = useState(true);
  const [isQuickViewEnabled, setIsQuickViewEnabled] = useState(false);

  // --- Virtual Search State ---
  const [showVirtualUserDialog, setShowVirtualUserDialog] = useState(false);
  const [showSavedVirtualProfiles, setShowSavedVirtualProfiles] =
    useState(false);

  // --- AI State ---
  const [aiTargetCandidate, setAiTargetCandidate] = useState<Candidate | null>(
    null
  );
  const [comparisonSelection, setComparisonSelection] = useState<
    Record<string, Candidate>
  >({});
  const [aiMatches, setAiMatches] = useState<AiMatch[]>([]);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isAnalysisDialogOpen, setIsAnalysisDialogOpen] = useState(false);
  const [isBulkUpdating, setIsBulkUpdating] = useState(false);
  const [feedbackCandidate, setFeedbackCandidate] = useState<Candidate | null>(
    null
  );
  const [analyzedCandidate, setAnalyzedCandidate] = useState<Candidate | null>(
    null
  );

  // --- Session & Permissions ---
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === 'ADMIN';

  const handleOpenAiAnalysis = useCallback((candidate: Candidate) => {
    setAnalyzedCandidate(candidate);
  }, []);

  const handleOpenProfileFeedback = useCallback((candidate: Candidate) => {
    setFeedbackCandidate(candidate);
  }, []);

  const handleCloseAiAnalysis = () => {
    setAnalyzedCandidate(null);
  };

  // --- Custom Hooks ---
  const {
    loading,
    candidates,
    maleCandidates,
    femaleCandidates,
    setSorting,
    setFilters: setCandidatesFilters,
    refresh,
  } = useCandidates();

  const {
    filters,
    setFilters,
    savedFilters,
    recentSearches,
    popularFilters,
    activeFilters,
    saveFilter,
    resetFilters,
    clearRecentSearches,
    toggleSeparateFiltering,
    updateMaleFilters,
    updateFemaleFilters,
    copyFilters,
    updateMaleSearchQuery,
    updateFemaleSearchQuery,
    removeFilter,
  } = useFilterLogic({ onFilterChange: setCandidatesFilters });

  // --- Derived State ---
  const activeFilterCount = useMemo(
    () => activeFilters.length,
    [activeFilters]
  );

  const heroStats = useMemo(() => {
    const total = candidates.length;
    const male = candidates.filter((c) => c.profile.gender === 'MALE').length;
    const female = candidates.filter(
      (c) => c.profile.gender === 'FEMALE'
    ).length;
    const verified = candidates.filter((c) => c.isVerified).length;
    const activeToday = candidates.filter((c) => {
      const lastActive = new Date(c.createdAt);
      const today = new Date();

      return (
        (today.getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24) <= 7
      );
    }).length;
    const profilesComplete =
      total > 0
        ? Math.round(
            (candidates.filter((c) => c.isProfileComplete).length / total) * 100
          )
        : 0;
    return { total, male, female, verified, activeToday, profilesComplete };
  }, [candidates]);

  // --- Effects ---
  useEffect(() => {
    const checkScreen = () => {
      setShowFiltersPanel(window.innerWidth >= 1024);
      setIsMobile(window.innerWidth < 768);
    };
    checkScreen();
    window.addEventListener('resize', checkScreen);
    return () => window.removeEventListener('resize', checkScreen);
  }, []);

  // --- Event Handlers ---
  const handleCandidateAdded = useCallback(() => {
    refresh();
    toast.success('注 砖 住祝 爪!');
  }, [refresh]);

  const handleSearch = useCallback(
    (value: string) => {
      setFilters({ searchQuery: value });
    },
    [setFilters]
  );

  const handleRemoveFilter = useCallback(
    (key: keyof CandidatesFilter, value?: string) => {
      removeFilter(key, value);
    },
    [removeFilter]
  );

  const handleCandidateAction = useCallback(
    async (type: CandidateAction, candidate: Candidate) => {
      console.log(
        `Action '${type}' triggered for candidate: ${candidate.firstName}`
      );
    },
    []
  );

  const handleFilterSave = useCallback(
    async (name: string) => {
      try {
        await saveFilter(name, filters);
        toast.success('驻专 砖专 爪');
      } catch {
        toast.error('砖 砖专转 驻专');
      }
    },
    [filters, saveFilter]
  );

  const handleSetAiTarget = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      if (aiTargetCandidate?.id === candidate.id) {
        handleClearAiTarget(e);
        return;
      }
      setAiTargetCandidate(candidate);
      setAiMatches([]);
      setComparisonSelection({});
      toast.info(`注 专 专: ${candidate.firstName}.`, {
        position: 'bottom-center',
      });
    },
    [aiTargetCandidate]
  );

  const handleClearAiTarget = (e: React.MouseEvent) => {
    e.stopPropagation();
    setAiTargetCandidate(null);
    setAiMatches([]);
    setComparisonSelection({});
    toast.info('专转 注 专 .', { position: 'bottom-center' });
  };

  const handleToggleComparison = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      setComparisonSelection((prev) => {
        const newSelection = { ...prev };
        if (newSelection[candidate.id]) delete newSelection[candidate.id];
        else newSelection[candidate.id] = candidate;
        return newSelection;
      });
    },
    []
  );

  // --- Virtual Profile Handler ---
  const handleVirtualProfileSelect = useCallback((virtualProfile: any) => {
    // 专转 驻专驻 专  砖 注 (Candidate)
    const mockCandidate = {
      id: virtualProfile.id,
      firstName: virtualProfile.name || '砖转砖',
      lastName: '专 (AI)',
      email: 'virtual@ai.com',
      createdAt: new Date(),
      status: 'ACTIVE',
      images: [],
      isProfileComplete: true,
      source: 'MANUAL_ENTRY',
      isVerified: false,
      profile: {
        gender: virtualProfile.gender,
        religiousLevel: virtualProfile.religiousLevel,
        //  驻专 住驻 驻专驻 专
        city: virtualProfile.generatedProfile.inferredCity,
        occupation: virtualProfile.generatedProfile.inferredOccupation,
        // 砖   转
        birthDate: new Date(
          new Date().setFullYear(
            new Date().getFullYear() -
              virtualProfile.generatedProfile.inferredAge
          )
        ),
        availabilityStatus: 'AVAILABLE',
      },
      // 砖转   专 转爪转 AI
      isVirtual: true,
      aiReasoning:
        virtualProfile.editedSummary ||
        virtualProfile.generatedProfile.displaySummary,
    } as unknown as Candidate;

    setAiTargetCandidate(mockCandidate);
    setAiMatches([]);
    setComparisonSelection({});

    toast.success('驻专驻 专 注! 注转 转 爪注 驻砖 AI.');
  }, []);

  const handleUpdateAllProfiles = async () => {
    if (
      !confirm(
        '驻注  转驻注 转 -AI 注  注 注专转.  注砖 拽转 住驻专 拽转.  砖?'
      )
    )
      return;

    setIsBulkUpdating(true);
    const toastId = toast.loading('转 转 注...', {
      duration: Infinity,
    });

    try {
      // 砖 1: 驻住 
      const resetRes = await fetch('/api/ai/matchmaker/batch-process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'RESET_FLAGS' }),
      });

      if (!resetRes.ok) throw new Error('Failed to start process');
      const resetData = await resetRes.json();
      const totalToProcess = resetData.count;
      let processedSoFar = 0;

      toast.message(`爪 ${totalToProcess} 驻专驻 注. 转 注...`, {
        id: toastId,
      });

      // 砖 2: 转 注
      let completed = false;

      while (!completed) {
        const batchRes = await fetch('/api/ai/matchmaker/batch-process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'PROCESS_BATCH', batchSize: 4 }),
        });

        if (!batchRes.ok) throw new Error('Error during batch processing');

        const batchData = await batchRes.json();

        processedSoFar += batchData.processed;
        const percent = Math.round((processedSoFar / totalToProcess) * 100);

        toast.loading(
          `注 驻专驻... ${percent}% (${processedSoFar}/${totalToProcess})`,
          { id: toastId }
        );

        if (batchData.completed || batchData.remaining === 0) {
          completed = true;
        }
      }

      toast.success('注  砖 爪!', {
        id: toastId,
        duration: 4000,
      });
      refresh();
    } catch (error) {
      console.error('Bulk update failed:', error);
      toast.error('砖 转 注. 住 砖 专 转专.', {
        id: toastId,
        duration: 4000,
      });
    } finally {
      setIsBulkUpdating(false);
    }
  };

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- Render ---
  return (
    <div
      className="min-h-screen flex flex-col bg-gradient-to-br from-slate-50 via-indigo-50/10 to-purple-50/5"
      dir={direction}
    >
      <MinimalHeader
        stats={heroStats}
        onAddCandidate={() => setShowManualAddDialog(true)}
        onRefresh={refresh}
        isRefreshing={loading}
        onBulkUpdate={handleUpdateAllProfiles}
        isBulkUpdating={isBulkUpdating}
        isAdmin={isAdmin}
        isCompact={isHeaderCompact}
        onToggleCompact={() => setIsHeaderCompact(!isHeaderCompact)}
        dict={matchmakerDict.candidatesManager.header}
      />

      {isHeaderCompact && (
        <div className="flex-shrink-0 bg-white/80 backdrop-blur-sm border-b border-gray-100 py-3 px-4 mt-16">
          <div className="container mx-auto px-2">
            <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
              {!filters.separateFiltering && (
                <div className="w-full md:flex-1 md:max-w-md">
                  <SearchBar
                    value={filters.searchQuery || ''}
                    onChange={handleSearch}
                    placeholder={
                      matchmakerDict.candidatesManager.searchBar
                        .generalPlaceholder
                    }
                    recentSearches={recentSearches}
                    onClearRecentSearches={clearRecentSearches}
                    dict={matchmakerDict.candidatesManager.searchBar}
                  />
                </div>
              )}

              <div className="flex items-center justify-between w-full md:w-auto md:justify-start gap-2 flex-wrap">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="bg-white/90 shadow-sm border border-gray-200"
                    >
                      <ArrowUpDown
                        className={cn(
                          'w-4 h-4',
                          locale === 'he' ? 'ml-1' : 'mr-1'
                        )}
                      />
                      {matchmakerDict.candidatesManager.controls.sort}
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuLabel>
                      {matchmakerDict.candidatesManager.controls.sortBy}
                    </DropdownMenuLabel>
                    <DropdownMenuSeparator />
                    {SORT_OPTIONS.map((option) => (
                      <DropdownMenuItem
                        key={option.value}
                        onClick={() =>
                          setSorting(
                            option.value,
                            option.defaultOrder as 'asc' | 'desc'
                          )
                        }
                      >
                        {
                          matchmakerDict.candidatesManager.sortOptions[
                            option.value as keyof typeof matchmakerDict.candidatesManager.sortOptions
                          ]
                        }
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>

                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsQuickViewEnabled(!isQuickViewEnabled)}
                  className="bg-white/90 shadow-sm border border-gray-200"
                >
                  {isQuickViewEnabled ? (
                    <EyeOff
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  ) : (
                    <Eye
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  )}

                  {isQuickViewEnabled
                    ? matchmakerDict.candidatesManager.controls.disableQuickView
                    : matchmakerDict.candidatesManager.controls.enableQuickView}
                </Button>

                {/* --- 驻转专 驻砖 专 砖 --- */}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowSavedVirtualProfiles(true)}
                  className="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white border-0 hover:opacity-90 shadow-sm"
                >
                  <UserCircle
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-1' : 'mr-1')}
                  />
                  驻砖 专
                </Button>

                <div className="hidden lg:flex">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowFiltersPanel(!showFiltersPanel)}
                    className="bg-white/90 shadow-sm border border-gray-200"
                  >
                    <Filter className="w-4 h-4 ml-1" />
                    {showFiltersPanel
                      ? matchmakerDict.candidatesManager.controls.hideFilters
                      : matchmakerDict.candidatesManager.controls.filters}
                  </Button>
                </div>

                <Sheet
                  open={showFiltersMobile}
                  onOpenChange={setShowFiltersMobile}
                >
                  <SheetTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="lg:hidden relative bg-white/90 shadow-sm border border-gray-200"
                    >
                      <Filter className="w-4 h-4 ml-1" />
                      {matchmakerDict.candidatesManager.controls.filters}
                      {activeFilterCount > 0 && (
                        <Badge className="absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center bg-indigo-500 border-0 text-xs">
                          {activeFilterCount}
                        </Badge>
                      )}
                    </Button>
                  </SheetTrigger>
                  <SheetContent
                    className="w-full h-full flex flex-col p-0 sm:max-w-md"
                    side={direction === 'rtl' ? 'right' : 'left'}
                  >
                    <div className="flex-1 overflow-y-auto p-4 pt-10">
                      <FilterPanel
                        filters={filters}
                        onFiltersChange={setFilters}
                        onSavePreset={handleFilterSave}
                        onReset={resetFilters}
                        savedFilters={savedFilters.map((f) => ({
                          id: f.id,
                          name: f.name,
                          isDefault: f.isDefault,
                        }))}
                        popularFilters={popularFilters}
                        separateFiltering={filters.separateFiltering}
                        onToggleSeparateFiltering={toggleSeparateFiltering}
                        onMaleFiltersChange={updateMaleFilters}
                        onFemaleFiltersChange={updateFemaleFilters}
                        onCopyFilters={copyFilters}
                        dict={matchmakerDict.candidatesManager.filterPanel}
                        className="pb-10"
                      />
                    </div>
                  </SheetContent>
                </Sheet>

                <div className="flex gap-1 bg-white/90 p-1 rounded-lg shadow-sm border border-gray-200">
                  {isMobile ? (
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button
                          variant="outline"
                          size="sm"
                          className="w-24 justify-between px-2 border-0"
                        >
                          {mobileView === 'split' && (
                            <Users className="w-4 h-4" />
                          )}
                          {mobileView === 'single' && (
                            <View className="w-4 h-4" />
                          )}
                          {mobileView === 'double' && (
                            <Columns className="w-4 h-4" />
                          )}
                          <ArrowUpDown className="w-3 h-3 opacity-50 ml-1" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuRadioGroup
                          value={mobileView}
                          onValueChange={(value) =>
                            setMobileView(value as MobileView)
                          }
                        >
                          <DropdownMenuRadioItem value="split">
                            <Users className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .split
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="single">
                            <View className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .singleCol
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="double">
                            <Columns className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .doubleCol
                            }
                          </DropdownMenuRadioItem>
                        </DropdownMenuRadioGroup>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  ) : (
                    VIEW_OPTIONS.map((option) => (
                      <Button
                        key={option.value}
                        variant={
                          viewMode === option.value ? 'default' : 'ghost'
                        }
                        size="icon"
                        onClick={() => setViewMode(option.value as ViewMode)}
                        className={cn(
                          'h-8 w-8',
                          viewMode === option.value &&
                            'bg-indigo-500 text-white'
                        )}
                      >
                        {option.value === 'grid' ? (
                          <LayoutGrid className="w-4 h-4" />
                        ) : (
                          <List className="w-4 h-4" />
                        )}
                      </Button>
                    ))
                  )}
                </div>
              </div>
            </div>
            <div className="mt-2">
              <ActiveFilters
                filters={filters}
                onRemoveFilter={handleRemoveFilter}
                onResetAll={resetFilters}
                dict={matchmakerDict.candidatesManager.activeFilters}
              />
            </div>
          </div>
        </div>
      )}

      <main
        className={cn(
          'flex-1 min-h-0 container mx-auto px-6 pb-4 pt-4',
          !isHeaderCompact && 'mt-32'
        )}
      >
        <div className="flex gap-4 h-full">
          {showFiltersPanel && (
            <aside className="hidden lg:block w-72 flex-shrink-0">
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 h-full flex flex-col">
                <FilterPanel
                  filters={filters}
                  onFiltersChange={setFilters}
                  onSavePreset={handleFilterSave}
                  onReset={resetFilters}
                  savedFilters={savedFilters.map((f) => ({
                    id: f.id,
                    name: f.name,
                    isDefault: f.isDefault,
                  }))}
                  popularFilters={popularFilters}
                  separateFiltering={filters.separateFiltering}
                  onToggleSeparateFiltering={toggleSeparateFiltering}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  className="flex-1 overflow-y-auto"
                  dict={matchmakerDict.candidatesManager.filterPanel}
                />
              </div>
            </aside>
          )}

          <div className="flex-1 min-w-0 h-full">
            {loading ? (
              <LoadingContainer>
                <div className="h-full bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl animate-pulse shadow-lg"></div>
              </LoadingContainer>
            ) : (
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 overflow-hidden h-full">
                <SplitView
                  onOpenAiAnalysis={handleOpenAiAnalysis}
                  onSendProfileFeedback={handleOpenProfileFeedback}
                  maleCandidates={maleCandidates}
                  femaleCandidates={femaleCandidates}
                  allCandidates={candidates}
                  onCandidateAction={handleCandidateAction}
                  onCandidateClick={() => {}}
                  viewMode={viewMode}
                  mobileView={mobileView}
                  isLoading={loading || isAiLoading}
                  className="flex-1 overflow-hidden"
                  aiTargetCandidate={aiTargetCandidate}
                  aiMatches={aiMatches}
                  isAiLoading={isAiLoading}
                  onSetAiTarget={handleSetAiTarget}
                  onClearAiTarget={handleClearAiTarget}
                  setAiMatches={setAiMatches}
                  setIsAiLoading={setIsAiLoading}
                  comparisonSelection={comparisonSelection}
                  onToggleComparison={handleToggleComparison}
                  separateFiltering={filters.separateFiltering ?? false}
                  maleFilters={filters.maleFilters}
                  femaleFilters={filters.femaleFilters}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  maleSearchQuery={filters.maleSearchQuery}
                  femaleSearchQuery={filters.femaleSearchQuery}
                  onMaleSearchChange={updateMaleSearchQuery}
                  onFemaleSearchChange={updateFemaleSearchQuery}
                  dict={matchmakerDict}
                  profileDict={profileDict}
                  isQuickViewEnabled={isQuickViewEnabled}
                  locale={locale}
                />
              </div>
            )}
          </div>
        </div>
      </main>
      <AnimatePresence>
        {aiTargetCandidate && Object.keys(comparisonSelection).length > 0 && (
          <motion.div
            initial={{ y: 100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 100, opacity: 0 }}
            className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"
          >
            <div className="bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-2xl border flex items-center gap-4">
              <div className="flex items-center -space-x-4">
                {Object.values(comparisonSelection)
                  .slice(0, 3)
                  .map((c) => (
                    <div
                      key={c.id}
                      className="w-10 h-10 rounded-full overflow-hidden border-2 border-white bg-gray-200 flex items-center justify-center text-gray-500 font-bold"
                    >
                      {c.images?.find((img) => img.isMain) ? (
                        <Image
                          src={getRelativeCloudinaryPath(
                            c.images.find((img) => img.isMain)!.url
                          )}
                          alt={c.firstName}
                          width={40}
                          height={40}
                          className="object-cover"
                        />
                      ) : (
                        <span>
                          {c.firstName.charAt(0)}
                          {c.lastName.charAt(0)}
                        </span>
                      )}
                    </div>
                  ))}
                {Object.keys(comparisonSelection).length > 3 && (
                  <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold text-gray-600 border-2 border-white">
                    +{Object.keys(comparisonSelection).length - 3}
                  </div>
                )}
              </div>
              <Button
                onClick={() => setIsAnalysisDialogOpen(true)}
                className="bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold shadow-lg"
              >
                <GitCompare
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {matchmakerDict.candidatesManager.controls.compareButton.replace(
                  '{{count}}',
                  String(Object.keys(comparisonSelection).length)
                )}
              </Button>
              <Button
                variant="ghost"
                size="icon"
                className="h-8 w-8 rounded-full"
                onClick={() => setComparisonSelection({})}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      <AiMatchmakerProfileAdvisorDialog
        isOpen={!!analyzedCandidate}
        onClose={handleCloseAiAnalysis}
        candidate={analyzedCandidate}
        dict={matchmakerDict.candidatesManager.aiProfileAdvisor}
        locale={locale}
      />
      <ProfileFeedbackDialog
        isOpen={!!feedbackCandidate}
        onClose={() => setFeedbackCandidate(null)}
        candidate={feedbackCandidate}
        locale={locale}
        dict={matchmakerDict.candidatesManager.profileFeedbackDialog}
      />

      {/* --- Dialogs --- */}
      <AddManualCandidateDialog
        isOpen={showManualAddDialog}
        onClose={() => setShowManualAddDialog(false)}
        onCandidateAdded={handleCandidateAdded}
        dict={matchmakerDict.candidatesManager.addManualCandidateDialog}
        locale={locale}
      />

      <AiMatchAnalysisDialog
        isOpen={isAnalysisDialogOpen}
        onClose={() => setIsAnalysisDialogOpen(false)}
        targetCandidate={aiTargetCandidate}
        comparisonCandidates={Object.values(comparisonSelection)}
        dict={matchmakerDict.candidatesManager.aiAnalysis}
        locale={locale}
      />

      {/* --- Virtual Search Dialogs (NEW) --- */}
      <VirtualUserDialog
        isOpen={showVirtualUserDialog}
        onClose={() => setShowVirtualUserDialog(false)}
        onProfileCreated={handleVirtualProfileSelect}
        locale={locale}
      />

      <SavedVirtualProfiles
        isOpen={showSavedVirtualProfiles}
        onClose={() => setShowSavedVirtualProfiles(false)}
        onSelectProfile={handleVirtualProfileSelect}
        onCreateNew={() => {
          setShowSavedVirtualProfiles(false);
          setShowVirtualUserDialog(true);
        }}
        locale={locale}
      />
    </div>
  );
};

export default CandidatesManager;
--- End of Content for index.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\ActiveFilters.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/Filters/ActiveFilters.tsx
'use client';

import React from 'react';
import { X, RefreshCw, Sparkles, Filter, Star, Zap, Crown } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import type { CandidatesFilter } from '../types/candidates';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface ActiveFiltersProps {
  filters: CandidatesFilter;
  onRemoveFilter: (key: keyof CandidatesFilter, value?: string) => void;
  onResetAll: () => void;
  onSuggestFilter?: () => void;
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['activeFilters'];
}

interface ActiveFilter {
  key: keyof CandidatesFilter;
  label: string;
  value?: string;
  color?: string;
  icon?: React.ReactNode;
  priority?: 'high' | 'medium' | 'low';
}

const ActiveFilters: React.FC<ActiveFiltersProps> = ({
  filters,
  onRemoveFilter,
  onResetAll,
  onSuggestFilter,
  className,
  dict,
}) => {
  const getActiveFilters = (): ActiveFilter[] => {
    const activeFilters: ActiveFilter[] = [];

    if (!filters.separateFiltering && filters.searchQuery) {
      activeFilters.push({
        key: 'searchQuery',
        label: dict.labels.search.replace('{{query}}', filters.searchQuery),
        color: 'primary',
        icon: <Sparkles className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering && filters.maleSearchQuery) {
      activeFilters.push({
        key: 'maleSearchQuery',
        label: dict.labels.maleSearch.replace(
          '{{query}}',
          filters.maleSearchQuery
        ),
        color: 'male',
        icon: <Star className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering && filters.femaleSearchQuery) {
      activeFilters.push({
        key: 'femaleSearchQuery',
        label: dict.labels.femaleSearch.replace(
          '{{query}}',
          filters.femaleSearchQuery
        ),
        color: 'female',
        icon: <Crown className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.separateFiltering) {
      activeFilters.push({
        key: 'separateFiltering',
        label: dict.labels.separateFiltering,
        color: 'special',
        icon: <Zap className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.gender) {
      const genderLabel =
        filters.gender === 'MALE'
          ? dict.labels.genders.MALE
          : dict.labels.genders.FEMALE;
      activeFilters.push({
        key: 'gender',
        label: dict.labels.gender.replace('{{gender}}', genderLabel),
        color: filters.gender === 'MALE' ? 'male' : 'female',
        priority: 'high',
      });
    }

    if (filters.ageRange) {
      const isDefaultMin = filters.ageRange.min === 18;
      const isDefaultMax = filters.ageRange.max === 99;

      if (!isDefaultMin || !isDefaultMax) {
        let label = '';
        if (!isDefaultMin && !isDefaultMax) {
          label = dict.labels.age
            .replace('{{min}}', String(filters.ageRange.min))
            .replace('{{max}}', String(filters.ageRange.max));
        } else if (!isDefaultMin) {
          label = dict.labels.ageAbove.replace(
            '{{min}}',
            String(filters.ageRange.min)
          );
        } else if (!isDefaultMax) {
          label = dict.labels.ageBelow.replace(
            '{{max}}',
            String(filters.ageRange.max)
          );
        }
        activeFilters.push({
          key: 'ageRange',
          label,
          color: 'primary',
          priority: 'high',
        });
      }
    }

    if (filters.heightRange) {
      const isDefaultMin = filters.heightRange.min === 140;
      const isDefaultMax = filters.heightRange.max === 210;

      if (!isDefaultMin || !isDefaultMax) {
        let label = '';
        if (!isDefaultMin && !isDefaultMax) {
          label = dict.labels.height
            .replace('{{min}}', String(filters.heightRange.min))
            .replace('{{max}}', String(filters.heightRange.max));
        } else if (!isDefaultMin) {
          label = dict.labels.heightAbove.replace(
            '{{min}}',
            String(filters.heightRange.min)
          );
        } else if (!isDefaultMax) {
          label = dict.labels.heightBelow.replace(
            '{{max}}',
            String(filters.heightRange.max)
          );
        }
        activeFilters.push({
          key: 'heightRange',
          label,
          color: 'secondary',
          priority: 'medium',
        });
      }
    }

    // FIXED: Joined the array of religious levels into a string
    if (filters.religiousLevel && filters.religiousLevel.length > 0) {
      activeFilters.push({
        key: 'religiousLevel',
        label: dict.labels.religiousLevel.replace(
          '{{level}}',
          filters.religiousLevel.join(', ')
        ),
        color: 'warning',
        priority: 'medium',
      });
    }

    if (filters.educationLevel) {
      activeFilters.push({
        key: 'educationLevel',
        label: dict.labels.educationLevel.replace(
          '{{level}}',
          filters.educationLevel
        ),
        color: 'secondary',
        priority: 'medium',
      });
    }

    filters.cities?.forEach((city) => {
      activeFilters.push({
        key: 'cities',
        value: city,
        label: dict.labels.city.replace('{{city}}', city),
        color: 'success',
        priority: 'medium',
      });
    });

    filters.occupations?.forEach((occupation) => {
      activeFilters.push({
        key: 'occupations',
        value: occupation,
        label: dict.labels.occupation.replace('{{occupation}}', occupation),
        color: 'primary',
        priority: 'medium',
      });
    });

    if (filters.availabilityStatus) {
      const status =
        filters.availabilityStatus as keyof typeof dict.labels.availability;
      const statusLabel =
        dict.labels.availability[status] || filters.availabilityStatus;
      activeFilters.push({
        key: 'availabilityStatus',
        label: dict.labels.status.replace('{{status}}', statusLabel),
        color:
          filters.availabilityStatus === 'AVAILABLE' ? 'success' : 'warning',
        priority: 'high',
      });
    }

    if (filters.maritalStatus) {
      activeFilters.push({
        key: 'maritalStatus',
        label: dict.labels.maritalStatus.replace(
          '{{status}}',
          filters.maritalStatus
        ),
        color: 'secondary',
        priority: 'medium',
      });
    }

    if (filters.isVerified) {
      activeFilters.push({
        key: 'isVerified',
        label: dict.labels.verifiedOnly,
        color: 'primary',
        icon: <Star className="w-3 h-3" />,
        priority: 'high',
      });
    }

    if (filters.hasReferences) {
      activeFilters.push({
        key: 'hasReferences',
        label: dict.labels.withRecommendations,
        color: 'success',
        priority: 'medium',
      });
    }

    if (filters.isProfileComplete) {
      activeFilters.push({
        key: 'isProfileComplete',
        label: dict.labels.fullProfile,
        color: 'primary',
        priority: 'medium',
      });
    }

    if (filters.lastActiveDays) {
      let label: string;
      switch (filters.lastActiveDays) {
        case 1:
          label = dict.labels.activeToday;
          break;
        case 3:
          label = dict.labels.activeLast3Days;
          break;
        case 7:
          label = dict.labels.activeLast7Days;
          break;
        case 30:
          label = dict.labels.activeLast30Days;
          break;
        default:
          label = dict.labels.activeInDays.replace(
            '{{days}}',
            String(filters.lastActiveDays)
          );
      }
      activeFilters.push({
        key: 'lastActiveDays',
        label,
        color: 'special',
        priority: 'medium',
      });
    }

    return activeFilters;
  };

  const getFilterColors = (color?: string) => {
    const colorSchemes = {
      primary: {
        badge:
          'bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 shadow-lg',
        hover: 'hover:from-blue-600 hover:to-cyan-600',
      },
      secondary: {
        badge:
          'bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 shadow-lg',
        hover: 'hover:from-purple-600 hover:to-pink-600',
      },
      success: {
        badge:
          'bg-gradient-to-r from-emerald-500 to-green-500 text-white border-0 shadow-lg',
        hover: 'hover:from-emerald-600 hover:to-green-600',
      },
      warning: {
        badge:
          'bg-gradient-to-r from-amber-500 to-orange-500 text-white border-0 shadow-lg',
        hover: 'hover:from-amber-600 hover:to-orange-600',
      },
      male: {
        badge:
          'bg-gradient-to-r from-blue-600 to-indigo-600 text-white border-0 shadow-lg',
        hover: 'hover:from-blue-700 hover:to-indigo-700',
      },
      female: {
        badge:
          'bg-gradient-to-r from-purple-600 to-pink-600 text-white border-0 shadow-lg',
        hover: 'hover:from-purple-700 hover:to-pink-700',
      },
      special: {
        badge:
          'bg-gradient-to-r from-indigo-500 to-purple-500 text-white border-0 shadow-lg',
        hover: 'hover:from-indigo-600 hover:to-purple-600',
      },
    };
    return (
      colorSchemes[color as keyof typeof colorSchemes] || colorSchemes.primary
    );
  };

  const activeFilters = getActiveFilters();
  const sortedFilters = activeFilters.sort((a, b) => {
    const priorityOrder = { high: 3, medium: 2, low: 1 };
    return (
      priorityOrder[b.priority || 'low'] - priorityOrder[a.priority || 'low']
    );
  });

  if (activeFilters.length === 0) {
    return null;
  }

  return (
    <div className={cn('relative', className)}>
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-200/20 to-cyan-200/20 rounded-full blur-2xl"></div>
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-xl"></div>
      </div>
      <div className="relative z-10 bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 backdrop-blur-sm rounded-2xl p-6 shadow-xl border-0">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg">
              <Filter className="w-6 h-6" />
            </div>
            <div>
              <h3 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
                {dict.title}
              </h3>
              <p className="text-sm text-gray-600 mt-1">
                {activeFilters.length === 1
                  ? dict.filterActive
                  : dict.filtersActive.replace(
                      '{{count}}',
                      String(activeFilters.length)
                    )}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            {onSuggestFilter && (
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={onSuggestFilter}
                      className="bg-gradient-to-r from-emerald-50 to-green-50 hover:from-emerald-100 hover:to-green-100 text-emerald-700 border border-emerald-200 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg"
                    >
                      <Sparkles className="w-4 h-4 mr-2" />
                      {dict.suggestButton}
                      <Zap className="w-3 h-3 ml-1" />
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>{dict.suggestTooltip}</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            )}
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={onResetAll}
                    className="bg-gradient-to-r from-red-50 to-pink-50 hover:from-red-100 hover:to-pink-100 text-red-700 border border-red-200 rounded-xl transition-all duration-300 hover:scale-105 shadow-lg"
                  >
                    <RefreshCw className="w-4 h-4 mr-2" />
                    {dict.clearAllButton}
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{dict.clearAllTooltip}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>
        </div>
        <div className="flex flex-wrap gap-3">
          <AnimatePresence mode="popLayout">
            {sortedFilters.map((filter, index) => {
              const colors = getFilterColors(filter.color);
              return (
                <motion.div
                  key={`${filter.key}-${filter.value || index}`}
                  initial={{ opacity: 0, scale: 0.8, y: 20 }}
                  animate={{ opacity: 1, scale: 1, y: 0 }}
                  exit={{ opacity: 0, scale: 0.8, y: -20 }}
                  transition={{
                    duration: 0.3,
                    delay: index * 0.05,
                    type: 'spring',
                    stiffness: 300,
                    damping: 25,
                  }}
                  whileHover={{ scale: 1.05 }}
                >
                  <Badge
                    className={cn(
                      'px-4 py-2.5 whitespace-nowrap font-bold text-sm rounded-xl transition-all duration-300 group cursor-pointer shadow-lg hover:shadow-xl',
                      colors.badge,
                      colors.hover,
                      filter.priority === 'high' && 'ring-2 ring-white/50'
                    )}
                  >
                    <div className="flex items-center gap-2">
                      {filter.icon && (
                        <span className="opacity-90 group-hover:opacity-100 transition-opacity">
                          {filter.icon}
                        </span>
                      )}
                      <span className="max-w-[200px] truncate font-medium">
                        {filter.label}
                      </span>
                      <button
                        className="ml-2 hover:bg-white/20 rounded-full p-1 transition-all duration-200 hover:scale-110 group-hover:bg-white/30"
                        onClick={(e) => {
                          e.stopPropagation();
                          onRemoveFilter(filter.key, filter.value);
                        }}
                        aria-label={`住专 驻专 ${filter.label}`}
                      >
                        <X className="w-3.5 h-3.5" />
                      </button>
                    </div>
                  </Badge>
                </motion.div>
              );
            })}
          </AnimatePresence>
        </div>
        {activeFilters.length > 3 && (
          <div className="mt-6 pt-4 border-t border-gray-200/50">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <Sparkles className="w-4 h-4 text-blue-500" />
                <span>
                  {dict.summary.title.replace(
                    '{{count}}',
                    String(activeFilters.length)
                  )}
                </span>
              </div>
              <div className="flex items-center gap-1">
                {activeFilters.filter((f) => f.priority === 'high').length >
                  0 && (
                  <Badge
                    variant="outline"
                    className="bg-red-50 text-red-700 border-red-200 text-xs"
                  >
                    {dict.summary.highPriority.replace(
                      '{{count}}',
                      String(
                        activeFilters.filter((f) => f.priority === 'high')
                          .length
                      )
                    )}
                  </Badge>
                )}
                {activeFilters.filter((f) => f.priority === 'medium').length >
                  0 && (
                  <Badge
                    variant="outline"
                    className="bg-yellow-50 text-yellow-700 border-yellow-200 text-xs"
                  >
                    {dict.summary.mediumPriority.replace(
                      '{{count}}',
                      String(
                        activeFilters.filter((f) => f.priority === 'medium')
                          .length
                      )
                    )}
                  </Badge>
                )}
              </div>
            </div>
          </div>
        )}
        <div className="absolute inset-0 bg-gradient-to-r from-blue-400/5 via-purple-400/5 to-pink-400/5 rounded-2xl pointer-events-none"></div>
      </div>
    </div>
  );
};

export default ActiveFilters;
--- End of Content for ActiveFilters.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\FilterPanel.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/Filters/FilterPanel.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

// Lucide React Icons
import {
  Activity,
  Award,
  Bookmark,
  Calendar,
  ChevronDown,
  Copy,
  Crown,
  Filter as FilterIcon,
  Heart,
  MapPin,
  RefreshCw,
  Ruler,
  Save,
  Scroll,
  Shield,
  Sparkles,
  Star,
  Target,
  User,
  Zap,
  Check,
  Search,
} from 'lucide-react';

// Utility Functions
import { cn } from '@/lib/utils';

// UI Components
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Checkbox } from '@/components/ui/checkbox';
import { ScrollArea } from '@/components/ui/scroll-area';

// Local Components, Types & Constants
import SavedFilters from './SavedFilters';
import {
  AGE_RANGE,
  HEIGHT_RANGE,
  POPULAR_CITIES,
} from '../constants/filterOptions';
import type { CandidatesFilter } from '../types/candidates';
import type { FilterState } from '../types/filters';
import type { FilterPanelDict } from '@/types/dictionaries/matchmaker';
import { DEFAULT_FILTER_STATE } from '../types/filters';

// --- Constants for Religious Levels based on Dictionary ---
const RELIGIOUS_OPTIONS = [
  { value: 'charedi_litvak', label: '专/转 /转' },
  { value: 'charedi_hasidic', label: '专/转 住/转' },
  { value: 'charedi_sephardic', label: '专/转 住驻专/转' },
  { value: 'charedi_modern', label: '专/转 专/转' },
  { value: 'chabad', label: '状' },
  { value: 'breslov', label: '专住' },
  { value: 'dati_leumi_torani', label: '转/ /转 转专/转' },
  { value: 'dati_leumi_standard', label: '转/ /转 (住专)' },
  { value: 'dati_leumi_liberal', label: '转/ /转 专/转' },
  { value: 'masorti_strong', label: '住专转/转 (拽专/ 转)' },
  { value: 'masorti_light', label: '住专转/转 (拽砖专 拽 住专转)' },
  { value: 'secular_traditional_connection', label: '/转 注 拽 住专转' },
  { value: 'secular', label: '/转' },
  { value: 'spiritual_not_religious', label: '专/转 ( 拽 转/)' },
  { value: 'other', label: '专' },
];

// Interfaces
interface FilterPanelProps {
  filters: CandidatesFilter;
  onFiltersChange: (filters: CandidatesFilter) => void;
  onSavePreset?: (name: string) => void;
  onReset: () => void;
  onApplySavedFilter?: (id: string) => void;
  savedFilters?: Array<{ id: string; name: string; isDefault?: boolean }>;
  popularFilters?: string[];
  className?: string;
  compactMode?: boolean;
  separateFiltering?: boolean;
  onToggleSeparateFiltering?: () => void;
  onMaleFiltersChange?: (filters: Partial<FilterState>) => void;
  onFemaleFiltersChange?: (filters: Partial<FilterState>) => void;
  onCopyFilters?: (
    source: 'male' | 'female',
    target: 'male' | 'female'
  ) => void;
  dict: FilterPanelDict;
}

interface FilterSectionProps {
  title: string;
  icon: React.ReactNode;
  children: React.ReactNode;
  defaultOpen?: boolean;
  badge?: number;
  gradient?: string;
}

// --- New Helper Component for Safe Typing ---
interface SafeNumberInputProps {
  value: number;
  min: number;
  max: number;
  onCommit: (value: number) => void;
  className?: string;
}

const SafeNumberInput: React.FC<SafeNumberInputProps> = ({
  value,
  min,
  max,
  onCommit,
  className,
}) => {
  const [localValue, setLocalValue] = useState<string>(value?.toString() || '');

  useEffect(() => {
    setLocalValue(value?.toString() || '');
  }, [value]);

  const handleCommit = () => {
    let num = parseInt(localValue);

    // Validation
    if (isNaN(num)) num = min;
    if (num < min) num = min;
    if (num > max) num = max;

    setLocalValue(num.toString());
    onCommit(num);
  };

  return (
    <input
      type="number"
      value={localValue}
      onChange={(e) => setLocalValue(e.target.value)}
      onBlur={handleCommit}
      onKeyDown={(e) => {
        if (e.key === 'Enter') {
          (e.target as HTMLInputElement).blur();
        }
      }}
      className={className}
    />
  );
};

// --- MultiSelect Component for Religious Levels ---
const ReligiousMultiSelect = ({
  selectedValues = [],
  onChange,
  dict,
}: {
  selectedValues: string[];
  onChange: (values: string[]) => void;
  dict: any;
}) => {
  const [searchTerm, setSearchTerm] = useState('');

  const toggleValue = (value: string) => {
    const newValues = selectedValues.includes(value)
      ? selectedValues.filter((v) => v !== value)
      : [...selectedValues, value];
    onChange(newValues);
  };

  const filteredOptions = RELIGIOUS_OPTIONS.filter((opt) =>
    opt.label.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-gray-100/50 space-y-2">
      <div className="relative">
        <Search className="absolute right-3 top-2.5 h-4 w-4 text-gray-400" />
        <Input
          placeholder={dict.placeholders?.search || '驻砖 专 转转...'}
          className="pr-9 bg-white border-gray-200"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
      </div>
      <ScrollArea className="h-48 rounded-md border border-gray-100 bg-white p-2">
        <div className="space-y-1">
          {filteredOptions.map((option) => {
            const isSelected = selectedValues.includes(option.value);
            return (
              <div
                key={option.value}
                onClick={() => toggleValue(option.value)}
                className={cn(
                  'flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-colors text-sm',
                  isSelected
                    ? 'bg-amber-50 text-amber-900'
                    : 'hover:bg-gray-50 text-gray-700'
                )}
              >
                <Checkbox
                  checked={isSelected}
                  onCheckedChange={() => toggleValue(option.value)}
                  className="data-[state=checked]:bg-amber-500 data-[state=checked]:border-amber-500"
                />
                <span className="flex-1">{option.label}</span>
              </div>
            );
          })}
          {filteredOptions.length === 0 && (
            <p className="text-center text-xs text-gray-500 py-4">
               爪 转爪转
            </p>
          )}
        </div>
      </ScrollArea>
      {selectedValues.length > 0 && (
        <div className="flex flex-wrap gap-1 pt-1">
          {selectedValues.map((val) => {
            const label = RELIGIOUS_OPTIONS.find((o) => o.value === val)?.label;
            return (
              <Badge
                key={val}
                variant="secondary"
                className="text-xs bg-amber-100 text-amber-800 hover:bg-amber-200"
              >
                {label}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    toggleValue(val);
                  }}
                  className="mr-1 hover:text-red-600"
                >
                  
                </button>
              </Badge>
            );
          })}
          <button
            onClick={() => onChange([])}
            className="text-xs text-gray-500 underline mr-auto hover:text-gray-800"
          >
            拽 
          </button>
        </div>
      )}
    </div>
  );
};

// Helper Components
const FilterSection: React.FC<FilterSectionProps> = ({
  title,
  icon,
  children,
  defaultOpen = false,
  badge,
  gradient = 'from-blue-500 to-cyan-500',
}) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="mb-4"
    >
      <Collapsible
        open={isOpen}
        onOpenChange={setIsOpen}
        className="rounded-2xl overflow-hidden shadow-xl border-0 bg-gradient-to-br from-white via-gray-50/30 to-white"
      >
        <CollapsibleTrigger asChild>
          <motion.div
            className={cn(
              'flex items-center justify-between p-4 cursor-pointer transition-all duration-300',
              'bg-gradient-to-r',
              gradient,
              'text-white hover:shadow-lg'
            )}
            whileHover={{ scale: 1.02 }}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                {icon}
              </div>
              <span className="font-bold text-lg">{title}</span>
              {badge !== undefined && (
                <Badge className="bg-white/20 text-white border-white/30 shadow-lg">
                  {badge}
                </Badge>
              )}
            </div>
            <motion.div
              animate={{ rotate: isOpen ? 180 : 0 }}
              transition={{ duration: 0.3 }}
            >
              <ChevronDown size={20} className="text-white/80" />
            </motion.div>
          </motion.div>
        </CollapsibleTrigger>
        <CollapsibleContent className="data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-top-1 data-[state=open]:slide-in-from-top-1">
          <div className="p-6 bg-gradient-to-br from-white via-gray-50/20 to-white">
            {children}
          </div>
        </CollapsibleContent>
      </Collapsible>
    </motion.div>
  );
};

const GenderFilterPanel = ({
  gender,
  filters,
  onFiltersChange,
  className,
  copyTarget,
  onCopyFilters,
  dict,
}: {
  gender: 'male' | 'female';
  filters: Partial<FilterState>;
  onFiltersChange: (filters: Partial<FilterState>) => void;
  className?: string;
  copyTarget: 'male' | 'female';
  onCopyFilters?: (
    source: 'male' | 'female',
    target: 'male' | 'female'
  ) => void;
  dict: FilterPanelDict['genderFilterPanel'];
}) => {
  const genderConfig = {
    male: {
      gradient: 'from-blue-500 to-cyan-500',
      bg: 'from-blue-50/50 to-cyan-50/30',
      text: 'text-blue-800',
      icon: <Target className="w-5 h-5" />,
      title: dict.maleTitle,
      copyLabel: dict.copyToFemale,
    },
    female: {
      gradient: 'from-purple-500 to-pink-500',
      bg: 'from-purple-50/50 to-pink-50/30',
      text: 'text-purple-800',
      icon: <Crown className="w-5 h-5" />,
      title: dict.femaleTitle,
      copyLabel: dict.copyToMale,
    },
  };
  const config = genderConfig[gender];

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      className={cn(
        'mb-6 rounded-2xl overflow-hidden shadow-xl border-0',
        className
      )}
    >
      <div
        className={cn(
          'flex justify-between items-center px-6 py-4',
          'bg-gradient-to-r',
          config.gradient,
          'text-white'
        )}
      >
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-white/20 backdrop-blur-sm">
            {config.icon}
          </div>
          <h3 className="text-lg font-bold">{config.title}</h3>
        </div>
        {onCopyFilters && (
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onCopyFilters(gender, copyTarget)}
                  className="text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-105"
                >
                  <Copy className="w-4 h-4 mr-2" />
                  {config.copyLabel}
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>
                  {dict.copyTooltip.replace(
                    '{{gender}}',
                    copyTarget === 'male' ? dict.maleTitle : dict.femaleTitle
                  )}
                </p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        )}
      </div>
      <div className={cn('p-6 space-y-6 bg-gradient-to-br', config.bg)}>
        {/* Age Range */}
        <div className="space-y-4">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <Calendar className="w-5 h-5 text-blue-600" />
            {dict.ageLabel}
          </Label>
          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-100/50">
            <div className="flex justify-between items-center mb-4">
              <div className="text-center bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-blue-600 mb-1 font-medium">
                  {dict.minLabel}
                </p>
                <SafeNumberInput
                  min={AGE_RANGE.min}
                  max={AGE_RANGE.max}
                  value={filters?.ageRange?.min || AGE_RANGE.default.min}
                  onCommit={(val) => {
                    const currentMax =
                      filters.ageRange?.max || AGE_RANGE.default.max;
                    onFiltersChange({
                      ...filters,
                      ageRange: {
                        min: Math.min(val, currentMax),
                        max: currentMax,
                      },
                    });
                  }}
                  className="w-16 text-center text-lg font-bold text-blue-700 focus:outline-none bg-transparent"
                />
              </div>
              <span className="text-xl font-bold text-gray-400">-</span>
              <div className="text-center bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-blue-600 mb-1 font-medium">
                  {dict.maxLabel}
                </p>
                <SafeNumberInput
                  min={AGE_RANGE.min}
                  max={AGE_RANGE.max}
                  value={filters?.ageRange?.max || AGE_RANGE.default.max}
                  onCommit={(val) => {
                    const currentMin =
                      filters.ageRange?.min || AGE_RANGE.default.min;
                    onFiltersChange({
                      ...filters,
                      ageRange: {
                        min: currentMin,
                        max: Math.max(val, currentMin),
                      },
                    });
                  }}
                  className="w-16 text-center text-lg font-bold text-blue-700 focus:outline-none bg-transparent"
                />
              </div>
            </div>
            <div className="px-2">
              <Slider
                value={[
                  filters?.ageRange?.min || AGE_RANGE.default.min,
                  filters?.ageRange?.max || AGE_RANGE.default.max,
                ]}
                min={AGE_RANGE.min}
                max={AGE_RANGE.max}
                step={1}
                onValueChange={(value) =>
                  onFiltersChange({
                    ...filters,
                    ageRange: { min: value[0], max: value[1] },
                  })
                }
                className="h-5 [&>span]:bg-gradient-to-r [&>span]:from-blue-500 [&>span]:to-cyan-500"
                dir="rtl"
              />
            </div>
          </div>
        </div>

        {/* Height Range */}
        <div className="space-y-4">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <Ruler className="w-5 h-5 text-purple-600" />
            {dict.heightLabel}
          </Label>
          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-100/50">
            <div className="flex justify-between items-center mb-4">
              <div className="text-center bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-purple-600 mb-1 font-medium">
                  {dict.minLabel}
                </p>
                <SafeNumberInput
                  min={HEIGHT_RANGE.min}
                  max={HEIGHT_RANGE.max}
                  value={filters?.heightRange?.min || HEIGHT_RANGE.default.min}
                  onCommit={(val) => {
                    const currentMax =
                      filters.heightRange?.max || HEIGHT_RANGE.default.max;
                    onFiltersChange({
                      ...filters,
                      heightRange: {
                        min: Math.min(val, currentMax),
                        max: currentMax,
                      },
                    });
                  }}
                  className="w-16 text-center text-lg font-bold text-purple-700 focus:outline-none bg-transparent"
                />
              </div>
              <span className="text-xl font-bold text-gray-400">-</span>
              <div className="text-center bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl shadow-md p-3 min-w-[80px]">
                <p className="text-xs text-purple-600 mb-1 font-medium">
                  {dict.maxLabel}
                </p>
                <SafeNumberInput
                  min={HEIGHT_RANGE.min}
                  max={HEIGHT_RANGE.max}
                  value={filters?.heightRange?.max || HEIGHT_RANGE.default.max}
                  onCommit={(val) => {
                    const currentMin =
                      filters.heightRange?.min || HEIGHT_RANGE.default.min;
                    onFiltersChange({
                      ...filters,
                      heightRange: {
                        min: currentMin,
                        max: Math.max(val, currentMin),
                      },
                    });
                  }}
                  className="w-16 text-center text-lg font-bold text-purple-700 focus:outline-none bg-transparent"
                />
              </div>
            </div>
            <div className="px-2">
              <Slider
                value={[
                  filters?.heightRange?.min || HEIGHT_RANGE.default.min,
                  filters?.heightRange?.max || HEIGHT_RANGE.default.max,
                ]}
                min={HEIGHT_RANGE.min}
                max={HEIGHT_RANGE.max}
                step={1}
                onValueChange={(value) =>
                  onFiltersChange({
                    ...filters,
                    heightRange: { min: value[0], max: value[1] },
                  })
                }
                className="h-5 [&>span]:bg-gradient-to-r [&>span]:from-purple-500 [&>span]:to-pink-500"
                dir="rtl"
              />
            </div>
          </div>
        </div>

        {/* Religious Level (Multi-Select) */}
        <div className="space-y-3">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <Scroll className="w-5 h-5 text-amber-600" />
            {dict.religiousLevelLabel}
          </Label>
          <ReligiousMultiSelect
            selectedValues={filters.religiousLevel || []}
            onChange={(values) =>
              onFiltersChange({ ...filters, religiousLevel: values })
            }
            dict={dict}
          />
        </div>

        {/* City (Single Select remains for simplicity per prompt request, can be upgraded too) */}
        <div className="space-y-3">
          <Label className="text-base font-bold text-gray-800 flex items-center gap-2">
            <MapPin className="w-5 h-5 text-emerald-600" />
            {dict.cityLabel}
          </Label>
          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-gray-100/50">
            <Select
              value={filters.cities?.[0] || ''}
              onValueChange={(value) => {
                const newValue = value === 'all' ? undefined : value;
                onFiltersChange({
                  ...filters,
                  cities: newValue ? [newValue] : [],
                });
              }}
            >
              <SelectTrigger className="w-full border-0 bg-transparent focus:ring-2 focus:ring-emerald-200 rounded-xl">
                <SelectValue placeholder={dict.placeholders.selectCity} />
              </SelectTrigger>
              <SelectContent className="bg-white/95 backdrop-blur-sm border-0 shadow-2xl rounded-xl">
                <SelectItem value="all" className="hover:bg-emerald-50">
                  {dict.options.all}
                </SelectItem>
                {POPULAR_CITIES.map((c) => (
                  <SelectItem key={c} value={c} className="hover:bg-emerald-50">
                    {c}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Consolidated Status Toggles */}
        <div className="space-y-4 pt-4 border-t border-gray-200/50">
          {[
            {
              key: 'isVerified',
              label: dict.verifiedOnlyLabel,
              icon: <Shield className="w-4 h-4" />,
              gradient: 'from-emerald-500 to-green-500',
            },
            {
              key: 'hasReferences',
              label: dict.withRecommendationsLabel,
              icon: <Award className="w-4 h-4" />,
              gradient: 'from-amber-500 to-orange-500',
            },
            {
              key: 'isProfileComplete',
              label: dict.fullProfileLabel,
              icon: <Star className="w-4 h-4" />,
              gradient: 'from-purple-500 to-indigo-500',
            },
            // Added Logic for Availability and Active Days
            {
              key: 'availabilityStatus',
              label: '驻 ', // Hardcoded or needs dict update
              icon: <Heart className="w-4 h-4" />,
              gradient: 'from-pink-500 to-rose-500',
              value: filters.availabilityStatus === 'AVAILABLE',
              onChange: (checked: boolean) =>
                onFiltersChange({
                  ...filters,
                  availabilityStatus: checked ? 'AVAILABLE' : undefined,
                }),
            },
            {
              key: 'lastActiveDays',
              label: '驻注 专 (7 )', // Hardcoded or needs dict update
              icon: <Activity className="w-4 h-4" />,
              gradient: 'from-blue-500 to-cyan-500',
              value: filters.lastActiveDays === 7,
              onChange: (checked: boolean) =>
                onFiltersChange({
                  ...filters,
                  lastActiveDays: checked ? 7 : undefined,
                }),
            },
          ].map((item) => (
            <div
              key={item.key}
              className="flex items-center justify-between p-3 bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100/50 hover:bg-white/80 transition-all duration-300"
            >
              <div className="flex items-center gap-3">
                <div
                  className={cn(
                    'p-2 rounded-lg bg-gradient-to-r text-white',
                    item.gradient
                  )}
                >
                  {item.icon}
                </div>
                <span className="font-medium text-gray-800 text-sm">
                  {item.label}
                </span>
              </div>
              <Switch
                checked={
                  item.value !== undefined
                    ? item.value
                    : (filters?.[
                        item.key as keyof typeof filters
                      ] as boolean) || false
                }
                onCheckedChange={
                  item.onChange
                    ? item.onChange
                    : (checked) =>
                        onFiltersChange({
                          ...filters,
                          [item.key]: checked || undefined,
                        })
                }
                className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-emerald-500 data-[state=checked]:to-green-500"
              />
            </div>
          ))}
        </div>
      </div>
    </motion.div>
  );
};

// Main Component
const FilterPanel: React.FC<FilterPanelProps> = ({
  filters,
  onFiltersChange,
  onSavePreset,
  onReset,
  onApplySavedFilter,
  savedFilters = [],
  className,
  compactMode = false,
  separateFiltering = false,
  onToggleSeparateFiltering,
  onMaleFiltersChange,
  onFemaleFiltersChange,
  onCopyFilters,
  dict,
}) => {
  const [showSavePreset, setShowSavePreset] = useState(false);
  const [presetName, setPresetName] = useState('');
  const [activeTab, setActiveTab] = useState<string>('basic');
  const [activeGenderFilter, setActiveGenderFilter] = useState<
    'male' | 'female'
  >('male');

  const handleSavePreset = () => {
    if (presetName && onSavePreset) {
      onSavePreset(presetName);
      setPresetName('');
      setShowSavePreset(false);
    }
  };
  const handleAgeRangeChange = (value: number[]) => {
    onFiltersChange({ ...filters, ageRange: { min: value[0], max: value[1] } });
  };
  const handleHeightRangeChange = (value: number[]) => {
    onFiltersChange({
      ...filters,
      heightRange: { min: value[0], max: value[1] },
    });
  };

  const countActiveFilters = (category: string): number => {
    let count = 0;
    const defaultFilters = DEFAULT_FILTER_STATE;

    switch (category) {
      case 'basic':
        if (filters.gender) count++;
        if (
          filters.ageRange &&
          (filters.ageRange.min !== defaultFilters.ageRange?.min ||
            filters.ageRange.max !== defaultFilters.ageRange?.max)
        )
          count++;
        if (filters.cities && filters.cities.length > 0) count++;
        if (filters.religiousLevel && filters.religiousLevel.length > 0)
          count++; // Updated for array

        if (
          filters.heightRange &&
          (filters.heightRange.min !== defaultFilters.heightRange?.min ||
            filters.heightRange.max !== defaultFilters.heightRange?.max)
        )
          count++;

        // Status counts now part of basic panel generally
        if (filters.availabilityStatus) count++;
        if (filters.isVerified) count++;
        if (filters.hasReferences) count++;
        if (filters.lastActiveDays) count++;
        if (filters.isProfileComplete) count++;

        break;
    }
    return count;
  };

  return (
    <Card
      className={cn(
        'shadow-2xl border-0 bg-gradient-to-br from-white via-purple-50/20 to-pink-50/10 backdrop-blur-sm rounded-3xl overflow-hidden',
        className
      )}
    >
      <div className="absolute inset-0 -z-10">
        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-200/20 to-pink-200/20 rounded-full blur-3xl"></div>
        <div className="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-br from-blue-200/20 to-cyan-200/20 rounded-full blur-2xl"></div>
      </div>
      <div className="relative">
        {!compactMode && (
          <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
                  <FilterIcon className="w-8 h-8 text-white" />
                </div>
                <div>
                  <h3 className="text-2xl font-bold text-white">
                    {dict.header.title}
                  </h3>
                  <p className="text-white/80 mt-1">{dict.header.subtitle}</p>
                </div>
              </div>
              <div className="flex gap-3">
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={onReset}
                        className="h-10 w-10 p-0 text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-110"
                      >
                        <RefreshCw className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>{dict.header.resetTooltip}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setShowSavePreset(!showSavePreset)}
                        className="h-10 w-10 p-0 text-white hover:bg-white/20 rounded-xl transition-all duration-300 hover:scale-110"
                      >
                        <Bookmark className="w-5 h-5" />
                      </Button>
                    </TooltipTrigger>
                    <TooltipContent>
                      <p>{dict.header.saveTooltip}</p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
            </div>
            {/* REMOVED POPULAR FILTERS GRID AS REQUESTED */}
          </div>
        )}
        <AnimatePresence>
          {showSavePreset && !compactMode && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="bg-gradient-to-r from-blue-50 via-purple-50 to-pink-50 border-b border-purple-100"
            >
              <div className="p-6">
                <Label className="text-lg font-bold text-gray-800 mb-3 block">
                  {dict.savePreset.title}
                </Label>
                <div className="flex gap-3">
                  <Input
                    value={presetName}
                    onChange={(e) => setPresetName(e.target.value)}
                    placeholder={dict.savePreset.placeholder}
                    className="flex-1 border-0 bg-white/80 backdrop-blur-sm shadow-lg rounded-xl focus:ring-2 focus:ring-purple-300"
                  />
                  <Button
                    size="sm"
                    onClick={handleSavePreset}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg rounded-xl px-6"
                  >
                    <Save className="w-4 h-4 mr-2" />
                    {dict.savePreset.button}
                  </Button>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
        <div className="p-6 bg-gradient-to-r from-indigo-50/50 via-purple-50/30 to-pink-50/50 border-b border-purple-100/50">
          <motion.div
            className="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/50"
            whileHover={{ scale: 1.02 }}
          >
            <div className="flex items-center justify-between">
              <div className="space-y-2">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                    <Zap className="w-5 h-5" />
                  </div>
                  <div className="font-bold text-lg bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    {dict.separateFiltering.title}
                  </div>
                </div>
                <p className="text-sm text-gray-600 mr-10">
                  {dict.separateFiltering.description}
                </p>
              </div>
              <div className="flex items-center gap-3">
                <Switch
                  checked={separateFiltering}
                  onCheckedChange={onToggleSeparateFiltering}
                  className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-indigo-500 data-[state=checked]:to-purple-500"
                />
              </div>
            </div>
          </motion.div>
        </div>
        <div className="p-6">
          {separateFiltering ? (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-white via-gray-50/30 to-white rounded-2xl p-2 shadow-lg border border-gray-100/50">
                <div className="grid grid-cols-2 gap-1">
                  <Button
                    type="button"
                    variant={
                      activeGenderFilter === 'male' ? 'default' : 'ghost'
                    }
                    onClick={() => setActiveGenderFilter('male')}
                    className={cn(
                      'rounded-xl py-3 transition-all duration-300',
                      activeGenderFilter === 'male'
                        ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-blue-50'
                    )}
                  >
                    <Target className="w-5 h-5 mr-2" />
                    {dict.genderFilterPanel.maleTitle}
                  </Button>
                  <Button
                    type="button"
                    variant={
                      activeGenderFilter === 'female' ? 'default' : 'ghost'
                    }
                    onClick={() => setActiveGenderFilter('female')}
                    className={cn(
                      'rounded-xl py-3 transition-all duration-300',
                      activeGenderFilter === 'female'
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-purple-50'
                    )}
                  >
                    <Crown className="w-5 h-5 mr-2" />
                    {dict.genderFilterPanel.femaleTitle}
                  </Button>
                </div>
              </div>
              <AnimatePresence mode="wait">
                {activeGenderFilter === 'male' ? (
                  <motion.div
                    key="male"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.3 }}
                  >
                    <GenderFilterPanel
                      gender="male"
                      filters={filters.maleFilters || {}}
                      onFiltersChange={onMaleFiltersChange || (() => {})}
                      copyTarget="female"
                      onCopyFilters={onCopyFilters}
                      dict={dict.genderFilterPanel}
                    />
                  </motion.div>
                ) : (
                  <motion.div
                    key="female"
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: -20 }}
                    transition={{ duration: 0.3 }}
                  >
                    <GenderFilterPanel
                      gender="female"
                      filters={filters.femaleFilters || {}}
                      onFiltersChange={onFemaleFiltersChange || (() => {})}
                      copyTarget="male"
                      onCopyFilters={onCopyFilters}
                      dict={dict.genderFilterPanel}
                    />
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          ) : (
            <Tabs
              value={activeTab}
              onValueChange={setActiveTab}
              className="w-full"
            >
              <TabsList className="grid grid-cols-2 w-full bg-gradient-to-r from-indigo-50 to-purple-50 p-2 rounded-2xl shadow-lg border border-white/50 h-auto">
                {[
                  {
                    value: 'basic',
                    label: dict.tabs.basic,
                    icon: User,
                    gradient: 'from-blue-500 to-cyan-500',
                  },
                  {
                    value: 'saved',
                    label: dict.tabs.saved,
                    icon: Bookmark,
                    gradient: 'from-amber-500 to-orange-500',
                  },
                ].map((tab) => {
                  const IconComponent = tab.icon;
                  const count = countActiveFilters(tab.value);
                  return (
                    <TabsTrigger
                      key={tab.value}
                      value={tab.value}
                      className={cn(
                        'flex flex-col items-center justify-center gap-2 rounded-xl text-sm font-bold transition-all duration-300 py-3 hover:scale-105 relative overflow-hidden group data-[state=active]:shadow-lg',
                        activeTab === tab.value
                          ? `bg-gradient-to-r ${tab.gradient} text-white`
                          : 'text-gray-600 hover:bg-white/50'
                      )}
                    >
                      <IconComponent className="w-5 h-5" />
                      <span>{tab.label}</span>
                      {count > 0 && (
                        <Badge className="absolute -top-1 -right-1 h-6 w-6 p-0 flex items-center justify-center bg-red-500 text-white text-xs font-bold rounded-full border-2 border-white">
                          {count}
                        </Badge>
                      )}
                    </TabsTrigger>
                  );
                })}
              </TabsList>
              <div className="mt-6 space-y-6">
                <TabsContent value="basic" className="space-y-6 m-0">
                  {/* Gender */}
                  <FilterSection
                    title={dict.sections.gender}
                    icon={<User className="w-5 h-5" />}
                    defaultOpen={true}
                    gradient="from-blue-500 to-cyan-500"
                  >
                    <div className="grid grid-cols-2 gap-4">
                      {[
                        {
                          value: 'MALE',
                          label: dict.buttons.male,
                          gradient: 'from-blue-500 to-cyan-500',
                        },
                        {
                          value: 'FEMALE',
                          label: dict.buttons.female,
                          gradient: 'from-purple-500 to-pink-500',
                        },
                      ].map((option) => (
                        <Button
                          key={option.value}
                          type="button"
                          variant={
                            filters.gender === option.value
                              ? 'default'
                              : 'outline'
                          }
                          onClick={() =>
                            onFiltersChange({
                              ...filters,
                              gender: option.value as 'MALE' | 'FEMALE',
                            })
                          }
                          className={cn(
                            'h-12 rounded-xl font-bold transition-all duration-300 hover:scale-105',
                            filters.gender === option.value
                              ? `bg-gradient-to-r ${option.gradient} text-white shadow-lg hover:shadow-xl`
                              : 'bg-white/80 backdrop-blur-sm border-2 border-gray-200 hover:border-gray-300'
                          )}
                        >
                          {option.label}
                        </Button>
                      ))}
                    </div>
                    {filters.gender && (
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() =>
                          onFiltersChange({ ...filters, gender: undefined })
                        }
                        className="w-full mt-3 text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-xl"
                      >
                        {dict.buttons.removeSelection}
                      </Button>
                    )}
                  </FilterSection>

                  {/* Religious Level (Multi-Select) */}
                  <FilterSection
                    title={dict.religiousLevelLabel}
                    icon={<Scroll className="w-5 h-5" />}
                    gradient="from-amber-500 to-orange-500"
                    defaultOpen={true}
                    badge={filters.religiousLevel?.length || undefined}
                  >
                    <ReligiousMultiSelect
                      selectedValues={filters.religiousLevel || []}
                      onChange={(values) =>
                        onFiltersChange({ ...filters, religiousLevel: values })
                      }
                      dict={dict}
                    />
                  </FilterSection>

                  {/* Age */}
                  <FilterSection
                    title={dict.sections.age}
                    icon={<Calendar className="w-5 h-5" />}
                    gradient="from-emerald-500 to-green-500"
                    badge={
                      filters.ageRange &&
                      (filters.ageRange.min !== AGE_RANGE.default.min ||
                        filters.ageRange.max !== AGE_RANGE.default.max)
                        ? 1
                        : undefined
                    }
                  >
                    <div className="space-y-6">
                      <div className="flex justify-between items-center">
                        <div className="text-center bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-emerald-600 mb-1 font-medium">
                            {dict.genderFilterPanel.minLabel}
                          </p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={
                              filters.ageRange?.min || AGE_RANGE.default.min
                            }
                            onCommit={(val) => {
                              const currentMax =
                                filters.ageRange?.max || AGE_RANGE.default.max;
                              onFiltersChange({
                                ...filters,
                                ageRange: {
                                  min: Math.min(val, currentMax),
                                  max: currentMax,
                                },
                              });
                            }}
                            className="w-16 text-center text-lg font-bold text-emerald-700 focus:outline-none bg-transparent"
                          />
                        </div>
                        <span className="text-xl font-bold text-gray-400">
                          -
                        </span>
                        <div className="text-center bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-emerald-600 mb-1 font-medium">
                            {dict.genderFilterPanel.maxLabel}
                          </p>
                          <SafeNumberInput
                            min={AGE_RANGE.min}
                            max={AGE_RANGE.max}
                            value={
                              filters.ageRange?.max || AGE_RANGE.default.max
                            }
                            onCommit={(val) => {
                              const currentMin =
                                filters.ageRange?.min || AGE_RANGE.default.min;
                              onFiltersChange({
                                ...filters,
                                ageRange: {
                                  min: currentMin,
                                  max: Math.max(val, currentMin),
                                },
                              });
                            }}
                            className="w-16 text-center text-lg font-bold text-emerald-700 focus:outline-none bg-transparent"
                          />
                        </div>
                      </div>
                      <div className="px-3">
                        <Slider
                          value={[
                            filters.ageRange?.min || AGE_RANGE.default.min,
                            filters.ageRange?.max || AGE_RANGE.default.max,
                          ]}
                          min={AGE_RANGE.min}
                          max={AGE_RANGE.max}
                          step={1}
                          onValueChange={handleAgeRangeChange}
                          className="h-6 [&>span]:bg-gradient-to-r [&>span]:from-emerald-500 [&>span]:to-green-500"
                          dir="rtl"
                        />
                      </div>
                    </div>
                  </FilterSection>

                  {/* Height */}
                  <FilterSection
                    title={dict.sections.height}
                    icon={<Ruler className="w-5 h-5" />}
                    gradient="from-indigo-500 to-purple-500"
                    badge={
                      filters.heightRange &&
                      (filters.heightRange.min !== HEIGHT_RANGE.default.min ||
                        filters.heightRange.max !== HEIGHT_RANGE.default.max)
                        ? 1
                        : undefined
                    }
                  >
                    <div className="space-y-6">
                      <div className="flex justify-between items-center">
                        <div className="text-center bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-indigo-600 mb-1 font-medium">
                            {dict.genderFilterPanel.minLabel}
                          </p>
                          <SafeNumberInput
                            min={HEIGHT_RANGE.min}
                            max={HEIGHT_RANGE.max}
                            value={
                              filters.heightRange?.min ||
                              HEIGHT_RANGE.default.min
                            }
                            onCommit={(val) => {
                              const currentMax =
                                filters.heightRange?.max ||
                                HEIGHT_RANGE.default.max;
                              onFiltersChange({
                                ...filters,
                                heightRange: {
                                  min: Math.min(val, currentMax),
                                  max: currentMax,
                                },
                              });
                            }}
                            className="w-16 text-center text-lg font-bold text-indigo-700 focus:outline-none bg-transparent"
                          />
                        </div>
                        <span className="text-xl font-bold text-gray-400">
                          -
                        </span>
                        <div className="text-center bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl shadow-md p-3 min-w-[80px]">
                          <p className="text-xs text-indigo-600 mb-1 font-medium">
                            {dict.genderFilterPanel.maxLabel}
                          </p>
                          <SafeNumberInput
                            min={HEIGHT_RANGE.min}
                            max={HEIGHT_RANGE.max}
                            value={
                              filters.heightRange?.max ||
                              HEIGHT_RANGE.default.max
                            }
                            onCommit={(val) => {
                              const currentMin =
                                filters.heightRange?.min ||
                                HEIGHT_RANGE.default.min;
                              onFiltersChange({
                                ...filters,
                                heightRange: {
                                  min: currentMin,
                                  max: Math.max(val, currentMin),
                                },
                              });
                            }}
                            className="w-16 text-center text-lg font-bold text-indigo-700 focus:outline-none bg-transparent"
                          />
                        </div>
                      </div>
                      <div className="px-3">
                        <Slider
                          value={[
                            filters.heightRange?.min ||
                              HEIGHT_RANGE.default.min,
                            filters.heightRange?.max ||
                              HEIGHT_RANGE.default.max,
                          ]}
                          min={HEIGHT_RANGE.min}
                          max={HEIGHT_RANGE.max}
                          step={1}
                          onValueChange={handleHeightRangeChange}
                          className="h-6 [&>span]:bg-gradient-to-r [&>span]:from-indigo-500 [&>span]:to-purple-500"
                          dir="rtl"
                        />
                      </div>
                    </div>
                  </FilterSection>

                  {/* City Selection */}
                  <FilterSection
                    title={dict.cityLabel}
                    icon={<MapPin className="w-5 h-5" />}
                    gradient="from-cyan-500 to-teal-500"
                  >
                    <div className="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-gray-100/50">
                      <Select
                        value={filters.cities?.[0] || ''}
                        onValueChange={(value) => {
                          const newValue = value === 'all' ? undefined : value;
                          onFiltersChange({
                            ...filters,
                            cities: newValue ? [newValue] : [],
                          });
                        }}
                      >
                        <SelectTrigger className="w-full border-0 bg-transparent focus:ring-2 focus:ring-emerald-200 rounded-xl">
                          <SelectValue
                            placeholder={dict.placeholders.selectCity}
                          />
                        </SelectTrigger>
                        <SelectContent className="bg-white/95 backdrop-blur-sm border-0 shadow-2xl rounded-xl">
                          <SelectItem
                            value="all"
                            className="hover:bg-emerald-50"
                          >
                            {dict.options.all}
                          </SelectItem>
                          {POPULAR_CITIES.map((c) => (
                            <SelectItem
                              key={c}
                              value={c}
                              className="hover:bg-emerald-50"
                            >
                              {c}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>
                  </FilterSection>

                  {/* Consolidated Status Section (Moved from header/advanced) */}
                  <FilterSection
                    title="住住 住 住驻"
                    icon={<Activity className="w-5 h-5" />}
                    gradient="from-pink-500 to-rose-500"
                    defaultOpen={true}
                  >
                    <div className="space-y-4">
                      {[
                        {
                          key: 'availabilityStatus',
                          label: '驻 ',
                          icon: <Heart className="w-4 h-4" />,
                          gradient: 'from-pink-500 to-rose-500',
                          value: filters.availabilityStatus === 'AVAILABLE',
                          onChange: (checked: boolean) =>
                            onFiltersChange({
                              ...filters,
                              availabilityStatus: checked
                                ? 'AVAILABLE'
                                : undefined,
                            }),
                        },
                        {
                          key: 'lastActiveDays',
                          label: '驻注 专 (7 )',
                          icon: <Activity className="w-4 h-4" />,
                          gradient: 'from-blue-500 to-cyan-500',
                          value: filters.lastActiveDays === 7,
                          onChange: (checked: boolean) =>
                            onFiltersChange({
                              ...filters,
                              lastActiveDays: checked ? 7 : undefined,
                            }),
                        },
                        {
                          key: 'isProfileComplete',
                          label: dict.fullProfileLabel,
                          icon: <Star className="w-4 h-4" />,
                          gradient: 'from-purple-500 to-indigo-500',
                        },
                        {
                          key: 'isVerified',
                          label: dict.verifiedOnlyLabel,
                          icon: <Shield className="w-4 h-4" />,
                          gradient: 'from-emerald-500 to-green-500',
                        },
                        {
                          key: 'hasReferences',
                          label: dict.withRecommendationsLabel,
                          icon: <Award className="w-4 h-4" />,
                          gradient: 'from-amber-500 to-orange-500',
                        },
                      ].map((item) => (
                        <div
                          key={item.key}
                          className="flex items-center justify-between p-3 bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100/50 hover:bg-white/80 transition-all duration-300"
                        >
                          <div className="flex items-center gap-3">
                            <div
                              className={cn(
                                'p-2 rounded-lg bg-gradient-to-r text-white',
                                item.gradient
                              )}
                            >
                              {item.icon}
                            </div>
                            <span className="font-medium text-gray-800 text-sm">
                              {item.label}
                            </span>
                          </div>
                          <Switch
                            checked={
                              item.value !== undefined
                                ? item.value
                                : (filters?.[
                                    item.key as keyof typeof filters
                                  ] as boolean) || false
                            }
                            onCheckedChange={
                              item.onChange
                                ? item.onChange
                                : (checked) =>
                                    onFiltersChange({
                                      ...filters,
                                      [item.key]: checked || undefined,
                                    })
                            }
                            className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-emerald-500 data-[state=checked]:to-green-500"
                          />
                        </div>
                      ))}
                    </div>
                  </FilterSection>
                </TabsContent>

                <TabsContent value="saved" className="space-y-6 m-0">
                  {savedFilters.length === 0 ? (
                    <motion.div
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="text-center py-12 bg-gradient-to-br from-white via-gray-50/30 to-white rounded-2xl shadow-xl border border-gray-100/50"
                    >
                      <div className="w-20 h-20 rounded-full bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center mx-auto mb-6">
                        <Bookmark className="w-10 h-10 text-amber-500" />
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 mb-3">
                        {dict.savedFilters.emptyState.title}
                      </h3>
                      <p className="text-gray-600 mb-6 max-w-sm mx-auto">
                        {dict.savedFilters.emptyState.description}
                      </p>
                      <Button
                        onClick={() => setShowSavePreset(true)}
                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white shadow-lg rounded-xl px-6"
                      >
                        <Save className="w-4 h-4 mr-2" />
                        {dict.savedFilters.emptyState.saveCurrentButton}
                      </Button>
                    </motion.div>
                  ) : (
                    <SavedFilters
                      filters={savedFilters.map((filter) => ({
                        id: filter.id,
                        name: filter.name,
                        filter: {},
                        isDefault: filter.isDefault,
                        createdAt: new Date(),
                      }))}
                      activeFilterId={filters.savedFilterId}
                      onSelect={(filter) => onApplySavedFilter?.(filter.id)}
                      onDelete={() => {}}
                      onEdit={() => {}}
                      onSetDefault={() => {}}
                      dict={dict.savedFilters}
                    />
                  )}
                </TabsContent>
              </div>
            </Tabs>
          )}
        </div>
        <div className="px-6 pb-6">
          <div className="flex justify-between items-center pt-6 border-t border-gray-200/50">
            <Button
              variant="outline"
              size={compactMode ? 'sm' : 'default'}
              onClick={onReset}
              className="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 text-red-600 hover:from-red-100 hover:to-pink-100 rounded-xl transition-all duration-300 hover:scale-105"
            >
              <RefreshCw className="w-4 h-4 mr-2" />
              {dict.buttons.reset}
            </Button>
            {!compactMode && (
              <Button
                onClick={() => setShowSavePreset(true)}
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg rounded-xl px-6 transition-all duration-300 hover:scale-105"
              >
                <Save className="w-4 h-4 mr-2" />
                {dict.buttons.save}
                <Sparkles className="w-3 h-3 ml-1" />
              </Button>
            )}
          </div>
        </div>
      </div>
    </Card>
  );
};
export default FilterPanel;
--- End of Content for FilterPanel.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\SavedFilters.tsx
--------------------------------------------------------------------------------
Content:
// SavedFilters.tsx - This file is correct. The issue lies in the UI component definitions.
'use client';
import React from 'react';
import {
  Star,
  MoreVertical,
  Edit,
  Trash,
  Crown,
  Bookmark,
  Calendar,
  Sparkles,
  Zap,
  Award,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { motion, AnimatePresence } from 'framer-motion';
import type { CandidatesFilter } from '../types/candidates';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface SavedFilter {
  id: string;
  name: string;
  filter: CandidatesFilter;
  isDefault?: boolean;
  createdAt: Date;
}

interface SavedFiltersProps {
  filters: SavedFilter[];
  activeFilterId?: string;
  onSelect: (filter: SavedFilter) => void;
  onDelete: (filterId: string) => void;
  onEdit: (filter: SavedFilter) => void;
  onSetDefault: (filterId: string) => void;
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['filterPanel']['savedFilters'];
}

// Enhanced filter summary function outside component for performance
const formatFilterSummary = (
  filter: CandidatesFilter,
  dict: SavedFiltersProps['dict']['filterCard']['summary']
): string => {
  const parts: string[] = [];

  if (filter.searchQuery) {
    parts.push(dict.search.replace('{{query}}', filter.searchQuery));
  }
  if (filter.gender) {
    parts.push(dict.gender.replace('{{gender}}', filter.gender));
  }
  if (filter.ageRange) {
    parts.push(
      `${dict.age} ${dict.ageValue.replace('{{min}}', String(filter.ageRange.min)).replace('{{max}}', String(filter.ageRange.max))}`
    );
  }
  if (filter.heightRange) {
    parts.push(
      `${dict.height} ${dict.heightValue.replace('{{min}}', String(filter.heightRange.min)).replace('{{max}}', String(filter.heightRange.max))}`
    );
  }
  if (filter.cities?.length) {
    if (filter.cities.length === 1) {
      parts.push(dict.city.replace('{{city}}', filter.cities[0]));
    } else {
      parts.push(
        dict.cities.replace('{{count}}', String(filter.cities.length))
      );
    }
  }
 if (filter.religiousLevel && filter.religiousLevel.length > 0) {
    parts.push(dict.religiousLevel.replace('{{level}}', filter.religiousLevel.join(', ')));
  }
  if (filter.educationLevel) {
    parts.push(dict.educationLevel.replace('{{level}}', filter.educationLevel));
  }
  if (filter.maritalStatus) {
    parts.push(dict.maritalStatus.replace('{{status}}', filter.maritalStatus));
  }
  if (filter.occupations?.length) {
    if (filter.occupations.length === 1) {
      parts.push(
        dict.occupation.replace('{{occupation}}', filter.occupations[0])
      );
    } else {
      parts.push(
        dict.occupations.replace('{{count}}', String(filter.occupations.length))
      );
    }
  }
  if (filter.availabilityStatus) {
    const statusKey = filter.availabilityStatus as keyof typeof dict.statuses;
    parts.push(dict.status.replace('{{status}}', dict.statuses[statusKey]));
  }
  if (filter.isVerified) {
    parts.push(dict.verifiedOnly);
  }
  if (filter.hasReferences) {
    parts.push(dict.withRecommendations);
  }
  if (filter.isProfileComplete) {
    parts.push(dict.fullProfile);
  }
  if (filter.lastActiveDays) {
    let label;
    switch (filter.lastActiveDays) {
      case 1:
        label = dict.activeToday;
        break;
      case 7:
        label = dict.activeLastWeek;
        break;
      case 30:
        label = dict.activeLastMonth;
        break;
      default:
        label = dict.activeInDays.replace(
          '{{days}}',
          String(filter.lastActiveDays)
        );
    }
    parts.push(label);
  }
  if (filter.separateFiltering) {
    parts.push(dict.separateFiltering);
  }

  if (parts.length === 0) {
    return dict.noCriteria;
  }
  if (parts.length <= 3) {
    return parts.join('  ');
  } else {
    return `${parts.slice(0, 2).join('  ')} ${dict.andMore.replace('{{count}}', String(parts.length - 2))}`;
  }
};

const SavedFilters: React.FC<SavedFiltersProps> = ({
  filters,
  activeFilterId,
  onSelect,
  onDelete,
  onEdit,
  onSetDefault,
  className,
  dict,
}) => {
  const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat('he-IL', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
    }).format(date);
  };

  const getFilterComplexity = (
    filter: CandidatesFilter
  ): { score: number; label: string; color: string } => {
    const score = Object.keys(filter).filter(
      (key) => filter[key as keyof CandidatesFilter] !== undefined
    ).length;

    if (score <= 2)
      return {
        score,
        label: dict.filterCard.complexity.basic,
        color: 'from-green-500 to-emerald-500',
      };
    if (score <= 5)
      return {
        score,
        label: dict.filterCard.complexity.advanced,
        color: 'from-blue-500 to-cyan-500',
      };
    if (score <= 8)
      return {
        score,
        label: dict.filterCard.complexity.complex,
        color: 'from-purple-500 to-pink-500',
      };
    return {
      score,
      label: dict.filterCard.complexity.expert,
      color: 'from-amber-500 to-orange-500',
    };
  };

  return (
    <div className={cn('space-y-4', className)}>
      <div className="flex items-center justify-between p-4 bg-gradient-to-r from-white via-purple-50/30 to-pink-50/30 rounded-2xl shadow-lg border border-gray-100/50">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
            <Bookmark className="w-5 h-5" />
          </div>
          <div>
            <h3 className="text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
              {dict.header.title}
            </h3>
            <p className="text-sm text-gray-600">
              {dict.header.subtitle
                .replace('{{count}}', String(filters.length))
                .replace(
                  '{{label}}',
                  filters.length === 1
                    ? dict.header.singleFilter
                    : dict.header.multipleFilters
                )}
            </p>
          </div>
        </div>
        <Badge className="bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 shadow-lg px-3 py-1 font-bold">
          {filters.length}
        </Badge>
      </div>

      <ScrollArea className="h-[400px] rounded-2xl">
        <div className="space-y-3 p-1">
          <AnimatePresence>
            {filters.map((filter, index) => {
              const complexity = getFilterComplexity(filter.filter);
              const isActive = activeFilterId === filter.id;
              return (
                <motion.div
                  key={filter.id}
                  initial={{ opacity: 0, y: 20, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, y: -20, scale: 0.95 }}
                  transition={{
                    delay: index * 0.05,
                    type: 'spring',
                    stiffness: 300,
                    damping: 25,
                  }}
                  whileHover={{ scale: 1.02, y: -2 }}
                  className={cn(
                    'relative group cursor-pointer rounded-2xl overflow-hidden shadow-xl border-0 transition-all duration-300',
                    isActive
                      ? 'ring-4 ring-purple-400 ring-opacity-60 shadow-purple-200'
                      : 'shadow-gray-200 hover:shadow-2xl'
                  )}
                  onClick={() => onSelect(filter)}
                >
                  <div
                    className={cn(
                      'absolute inset-0 bg-gradient-to-br transition-opacity duration-300',
                      isActive
                        ? 'from-purple-50 via-pink-50/50 to-purple-50 opacity-90'
                        : 'from-white via-gray-50/30 to-white opacity-95 group-hover:opacity-100'
                    )}
                  />
                  <div className="relative z-10 p-5">
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        {filter.isDefault && (
                          <motion.div
                            initial={{ scale: 0 }}
                            animate={{ scale: 1 }}
                            className="p-2 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white shadow-lg"
                          >
                            <Crown className="w-4 h-4" />
                          </motion.div>
                        )}
                        <div
                          className={cn(
                            'p-2 rounded-full text-white shadow-lg bg-gradient-to-r',
                            complexity.color
                          )}
                        >
                          {complexity.score <= 2 ? (
                            <Star className="w-4 h-4" />
                          ) : complexity.score <= 5 ? (
                            <Sparkles className="w-4 h-4" />
                          ) : complexity.score <= 8 ? (
                            <Zap className="w-4 h-4" />
                          ) : (
                            <Award className="w-4 h-4" />
                          )}
                        </div>
                        <div className="flex-1">
                          <h4 className="font-bold text-lg text-gray-800 group-hover:text-purple-700 transition-colors">
                            {filter.name}
                          </h4>
                          <p className="text-sm text-gray-500 mt-1">
                            {formatFilterSummary(
                              filter.filter,
                              dict.filterCard.summary
                            )}
                          </p>
                        </div>
                      </div>
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button
                            variant="ghost"
                            size="sm"
                            className="h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-purple-100 rounded-full"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <MoreVertical className="h-4 w-4 text-gray-600" />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent
                          align="end"
                          className="bg-white/95 backdrop-blur-sm border-0 shadow-2xl rounded-xl"
                        >
                          <DropdownMenuItem
                            onClick={() => onEdit(filter)}
                            className="hover:bg-blue-50 rounded-lg"
                          >
                            <Edit className="mr-2 h-4 w-4 text-blue-600" />
                            <span className="text-blue-700">
                              {dict.filterCard.actions.edit}
                            </span>
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={() => onSetDefault(filter.id)}
                            disabled={filter.isDefault}
                            className="hover:bg-yellow-50 rounded-lg"
                          >
                            <Crown className="mr-2 h-4 w-4 text-yellow-600" />
                            <span className="text-yellow-700">
                              {filter.isDefault
                                ? dict.filterCard.actions.isDefault
                                : dict.filterCard.actions.setDefault}
                            </span>
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={() => onDelete(filter.id)}
                            className="hover:bg-red-50 rounded-lg"
                          >
                            <Trash className="mr-2 h-4 w-4 text-red-600" />
                            <span className="text-red-700">
                              {dict.filterCard.actions.delete}
                            </span>
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </div>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <Badge
                          className={cn(
                            'text-white border-0 shadow-lg font-bold px-3 py-1 bg-gradient-to-r',
                            complexity.color
                          )}
                        >
                          {complexity.label} {' '}
                          {dict.filterCard.criteria.replace(
                            '{{count}}',
                            String(complexity.score)
                          )}
                        </Badge>
                        <div className="flex items-center gap-2 text-xs text-gray-500">
                          <Calendar className="w-3 h-3" />
                          <span>{formatDate(filter.createdAt)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="absolute inset-0 bg-gradient-to-r from-purple-400/0 via-pink-400/0 to-purple-400/0 group-hover:from-purple-400/10 group-hover:via-pink-400/10 group-hover:to-purple-400/10 transition-all duration-500 pointer-events-none rounded-2xl"></div>
                  {isActive && (
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      className="absolute top-3 left-3 w-3 h-3 bg-purple-500 rounded-full shadow-lg"
                    >
                      <div className="w-full h-full bg-purple-400 rounded-full animate-ping"></div>
                    </motion.div>
                  )}
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000 rounded-2xl"></div>
                </motion.div>
              );
            })}
          </AnimatePresence>
        </div>
      </ScrollArea>

      {filters.length === 0 && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center py-12 bg-gradient-to-br from-white via-gray-50/30 to-white rounded-2xl shadow-xl border border-gray-100/50"
        >
          <div className="w-20 h-20 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center mx-auto mb-6">
            <Bookmark className="w-10 h-10 text-purple-400" />
          </div>
          <h3 className="text-xl font-bold text-gray-800 mb-3">
            {dict.emptyState.title}
          </h3>
          <p className="text-gray-600 mb-6 max-w-sm mx-auto">
            {dict.emptyState.description}
          </p>
          <div className="flex flex-wrap gap-2 justify-center">
            <Badge
              variant="outline"
              className="bg-blue-50 text-blue-600 border-blue-200"
            >
              <Star className="w-3 h-3 mr-1" />
              {dict.emptyState.fastSearches}
            </Badge>
            <Badge
              variant="outline"
              className="bg-purple-50 text-purple-600 border-purple-200"
            >
              <Sparkles className="w-3 h-3 mr-1" />
              {dict.emptyState.advancedFiltering}
            </Badge>
            <Badge
              variant="outline"
              className="bg-green-50 text-green-600 border-green-200"
            >
              <Award className="w-3 h-3 mr-1" />
              {dict.emptyState.quickAccess}
            </Badge>
          </div>
        </motion.div>
      )}

      {filters.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-4 shadow-lg border border-gray-100/50"
        >
          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <div className="text-lg font-bold text-indigo-600">
                {filters.filter((f) => f.isDefault).length}
              </div>
              <div className="text-xs text-gray-600">{dict.stats.default}</div>
            </div>
            <div>
              <div className="text-lg font-bold text-purple-600">
                {
                  filters.filter((f) => getFilterComplexity(f.filter).score > 5)
                    .length
                }
              </div>
              <div className="text-xs text-gray-600">{dict.stats.advanced}</div>
            </div>
            <div>
              <div className="text-lg font-bold text-pink-600">
                {Math.round(
                  filters.reduce(
                    (acc, f) => acc + getFilterComplexity(f.filter).score,
                    0
                  ) / (filters.length || 1)
                )}
              </div>
              <div className="text-xs text-gray-600">
                {dict.stats.avgCriteria}
              </div>
            </div>
          </div>
        </motion.div>
      )}
    </div>
  );
};

export default SavedFilters;
--- End of Content for SavedFilters.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\Filters\SearchBar.tsx
--------------------------------------------------------------------------------
Content:
// SearchBar.tsx - 专住 住驻转 转拽转 注 转拽 z-index -RTL
'use client';

import React, { useState, useEffect, useRef } from 'react';
import {
  Search,
  X,
  History,
  Sparkles,
  Target,
  Crown,
  Star,
  TrendingUp,
  Zap,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { motion, AnimatePresence } from 'framer-motion';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Popover,
  PopoverContent,
  PopoverAnchor,
} from '@/components/ui/popover';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface SearchBarProps {
  value: string;
  onChange: (value: string) => void;
  onSelect?: (candidate: Candidate) => void;
  recentSearches?: string[];
  onSaveSearch?: (value: string) => void;
  onClearRecentSearches?: () => void;
  suggestions?: Candidate[];
  loading?: boolean;
  className?: string;
  placeholder?: string;
  autoFocus?: boolean;
  genderTarget?: 'male' | 'female' | 'all';
  separateMode?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['searchBar'];
}

const SearchBar: React.FC<SearchBarProps> = ({
  value,
  onChange,
  onSelect,
  recentSearches = [],
  onSaveSearch,
  onClearRecentSearches,
  suggestions = [],
  loading = false,
  className = '',
  placeholder, // We will now primarily use the placeholder from dict
  autoFocus = false,
  genderTarget = 'all',
  separateMode = false,
  dict,
}) => {
  const [inputValue, setInputValue] = useState(value);
  const [showDropdown, setShowDropdown] = useState(false);
  const [isHovered, setIsHovered] = useState(false);
  const [isFocused, setIsFocused] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    setInputValue(value);
  }, [value]);

  const searchCategories = [
    {
      id: 'name',
      label: dict.categories.name,
      icon: <Star className="w-3 h-3" />,
      gradient: 'from-blue-500 to-cyan-500',
    },
    {
      id: 'city',
      label: dict.categories.city,
      icon: <Target className="w-3 h-3" />,
      gradient: 'from-emerald-500 to-green-500',
    },
    {
      id: 'occupation',
      label: dict.categories.occupation,
      icon: <Zap className="w-3 h-3" />,
      gradient: 'from-purple-500 to-pink-500',
    },
    {
      id: 'all',
      label: dict.categories.all,
      icon: <Sparkles className="w-3 h-3" />,
      gradient: 'from-indigo-500 to-purple-500',
    },
  ];
  const [searchCategory, setSearchCategory] = useState<string>('all');

  const getSearchPlaceholder = () => {
    if (placeholder) return placeholder; // Allow override
    if (separateMode) {
      if (genderTarget === 'male') return dict.malePlaceholder;
      if (genderTarget === 'female') return dict.femalePlaceholder;
    }
    return dict.generalPlaceholder;
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setInputValue(newValue);
    onChange(newValue);
    if (!showDropdown) {
      setShowDropdown(true);
    }
  };

  const handleSearch = (searchValue: string) => {
    if (searchValue.trim()) {
      onChange(searchValue.trim());
      if (onSaveSearch) {
        onSaveSearch(searchValue.trim());
      }
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && inputValue.trim()) {
      handleSearch(inputValue);
      setShowDropdown(false);
    } else if (e.key === 'Escape') {
      setShowDropdown(false);
    }
  };

  const handleClear = () => {
    setInputValue('');
    onChange('');
    inputRef.current?.focus();
  };

  const handleSuggestionSelect = (candidate: Candidate) => {
    if (onSelect) {
      onSelect(candidate);
    } else {
      const searchText = `${candidate.firstName} ${candidate.lastName}`;
      setInputValue(searchText);
      onChange(searchText);
    }
    setShowDropdown(false);
  };

  const getStyling = () => {
    if (!separateMode || genderTarget === 'all') {
      return {
        gradient: 'from-indigo-500 via-purple-500 to-pink-500',
        ring: 'focus:ring-purple-200',
        badge: 'bg-gradient-to-r from-indigo-500 to-purple-500',
      };
    }
    if (genderTarget === 'male') {
      return {
        gradient: 'from-blue-500 to-cyan-500',
        ring: 'focus:ring-blue-200',
        badge: 'bg-gradient-to-r from-blue-500 to-cyan-500',
      };
    }
    return {
      gradient: 'from-purple-500 to-pink-500',
      ring: 'focus:ring-purple-200',
      badge: 'bg-gradient-to-r from-purple-500 to-pink-500',
    };
  };

  const styling = getStyling();

  return (
    <Popover open={showDropdown} onOpenChange={setShowDropdown}>
      <div className={cn('relative group', className)}>
        <PopoverAnchor asChild>
          <motion.div
            className={cn(
              'relative flex items-center rounded-2xl shadow-xl transition-all duration-300 backdrop-blur-sm border-0',
              `bg-gradient-to-r from-white via-gray-50/30 to-white`,
              isFocused || isHovered ? 'shadow-2xl scale-[1.02]' : 'shadow-lg',
              isFocused && `ring-2 ${styling.ring}`
            )}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            whileHover={{ y: -2 }}
            transition={{ type: 'spring', stiffness: 400, damping: 25 }}
          >
            <div
              className={cn(
                'absolute inset-0 bg-gradient-to-r opacity-5 rounded-2xl',
                styling.gradient
              )}
            />

            {separateMode && genderTarget !== 'all' && (
              <motion.div
                className="absolute left-4 top-1/2 -translate-y-1/2 z-10"
                initial={{ scale: 0 }}
                animate={{ scale: 1 }}
                transition={{ type: 'spring', stiffness: 500, damping: 25 }}
              >
                <Badge
                  className={cn(
                    'text-white border-0 shadow-lg font-bold px-3 py-1.5 rounded-xl',
                    styling.badge
                  )}
                >
                  <div className="flex items-center gap-2">
                    {genderTarget === 'male' ? (
                      <Target className="w-4 h-4" />
                    ) : (
                      <Crown className="w-4 h-4" />
                    )}
                    {genderTarget === 'male'
                      ? dict.tooltips.maleTarget
                      : dict.tooltips.femaleTarget}
                  </div>
                </Badge>
              </motion.div>
            )}

            <input
              ref={inputRef}
              type="text"
              value={inputValue}
              onChange={handleInputChange}
              onKeyDown={handleKeyDown}
              onFocus={() => {
                setShowDropdown(true);
                setIsFocused(true);
              }}
              onBlur={() => setIsFocused(false)}
              placeholder={getSearchPlaceholder()}
              className={cn(
                'w-full h-14 bg-transparent border-0 rounded-2xl text-lg font-medium relative z-10',
                'placeholder:text-gray-500 text-gray-800',
                'focus:outline-none transition-all duration-200',
                separateMode ? 'pl-32 pr-16' : 'pl-6 pr-16'
              )}
              autoFocus={autoFocus}
              autoComplete="off"
              spellCheck="false"
            />

            <div className="absolute right-4 top-1/2 -translate-y-1/2 z-10">
              <motion.div
                animate={{
                  rotate: loading ? 360 : 0,
                  scale: isHovered || isFocused ? 1.1 : 1,
                }}
                transition={{
                  rotate: {
                    duration: 1,
                    repeat: loading ? Infinity : 0,
                    ease: 'linear',
                  },
                  scale: { duration: 0.2 },
                }}
                className={cn(
                  'p-2.5 rounded-full text-white shadow-lg',
                  `bg-gradient-to-r ${styling.gradient}`
                )}
              >
                <Search className="w-5 h-5" />
              </motion.div>
            </div>

            <AnimatePresence>
              {inputValue && (
                <motion.div
                  initial={{ opacity: 0, scale: 0.8 }}
                  animate={{ opacity: 1, scale: 1 }}
                  exit={{ opacity: 0, scale: 0.8 }}
                  className={cn(
                    'absolute top-1/2 -translate-y-1/2 z-10',
                    separateMode ? 'left-32' : 'left-4'
                  )}
                >
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <button
                          type="button"
                          onClick={handleClear}
                          className="w-7 h-7 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-md"
                        >
                          <X className="w-4 h-4 text-gray-600" />
                        </button>
                      </TooltipTrigger>
                      <TooltipContent>
                        <p>{dict.clearTooltip}</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </motion.div>
              )}
            </AnimatePresence>

            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000 rounded-2xl pointer-events-none"></div>
          </motion.div>
        </PopoverAnchor>
      </div>

      <PopoverContent
        onOpenAutoFocus={(e) => e.preventDefault()}
        className="w-[--radix-popover-trigger-width] p-0 mt-2 z-[99] border-0 shadow-2xl rounded-2xl overflow-hidden bg-white/95 backdrop-blur-xl"
      >
        <div
          className={cn('p-4 bg-gradient-to-r text-white', styling.gradient)}
        >
          <div className="flex items-center justify-between mb-3 text-right">
            <div className="text-sm opacity-90">
              {dict.resultsCount.replace(
                '{{count}}',
                String(suggestions.length)
              )}
            </div>
            <div className="flex items-center gap-2">
              <span className="font-bold">{dict.smartSearch}</span>
              <Sparkles className="w-5 h-5" />
            </div>
          </div>
          <div className="relative">
            <Search className="absolute right-3 top-2.5 h-4 w-4 text-white/70" />
            <input
              type="text"
              value={inputValue}
              onChange={handleInputChange}
              className="w-full bg-white/20 backdrop-blur-sm border border-white/30 rounded-xl px-4 pr-10 py-2 text-sm text-white placeholder:text-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-right"
              placeholder={dict.filterResultsPlaceholder}
            />
          </div>
        </div>

        <div className="max-h-96 overflow-y-auto">
          {loading === false &&
            suggestions.length === 0 &&
            recentSearches.length === 0 && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                className="p-8 text-center"
              >
                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4">
                  <Search className="w-8 h-8 text-gray-400" />
                </div>
                <h3 className="font-bold text-gray-800 mb-2">
                  {dict.noResultsTitle}
                </h3>
                <p className="text-sm text-gray-500">
                  {dict.noResultsDescription}
                </p>
              </motion.div>
            )}

          {loading === true && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              className="p-8 text-center"
            >
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4">
                <Search className="w-8 h-8 text-gray-400 animate-pulse" />
              </div>
              <h3 className="font-bold text-gray-800 mb-2">驻砖...</h3>
              <p className="text-sm text-gray-500"> 转...</p>
            </motion.div>
          )}

          {recentSearches.length > 0 && (
            <div className="border-b border-gray-100">
              <div className="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100/50">
                <div className="flex justify-between items-center">
                  {onClearRecentSearches && (
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        onClearRecentSearches();
                      }}
                      className="h-6 text-xs text-gray-500 hover:text-gray-700 px-2"
                    >
                      {dict.clearHistory}
                    </Button>
                  )}
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-gray-700">
                      {dict.recentSearches}
                    </span>
                    <History className="w-4 h-4 text-gray-500" />
                  </div>
                </div>
              </div>
              <div className="p-2">
                {recentSearches.slice(0, 5).map((search, index) => (
                  <motion.div
                    key={`recent-${index}`}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.05 }}
                    className="flex items-center gap-3 px-3 py-2.5 hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 rounded-xl cursor-pointer transition-all duration-200 group"
                    onClick={() => {
                      handleSearch(search);
                      setShowDropdown(false);
                    }}
                  >
                    <div className="ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                      <Zap className="w-3 h-3 text-blue-500" />
                    </div>
                    <span className="text-sm font-medium text-gray-700 group-hover:text-blue-700">
                      {search}
                    </span>
                    <div className="p-1.5 rounded-lg bg-gradient-to-r from-blue-100 to-cyan-100 group-hover:from-blue-200 group-hover:to-cyan-200 transition-all duration-200">
                      <History className="h-3 w-3 text-blue-600" />
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          )}

          {suggestions.length > 0 && (
            <div>
              <div className="px-4 py-3 bg-gradient-to-r from-emerald-50 to-green-50 border-b border-gray-100">
                <div className="flex items-center justify-end gap-2">
                  <span className="text-sm font-medium text-emerald-800">
                    {dict.matchingResults.replace(
                      '{{count}}',
                      String(suggestions.length)
                    )}
                  </span>
                  <Star className="w-4 h-4 text-emerald-600" />
                </div>
              </div>
              <div className="p-2 space-y-1">
                {suggestions.map((candidate, index) => (
                  <motion.div
                    key={candidate.id}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.05 }}
                    className="flex items-center gap-3 px-3 py-3 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 rounded-xl cursor-pointer transition-all duration-200 group"
                    onClick={() => handleSuggestionSelect(candidate)}
                  >
                    <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                      <div className="p-1.5 rounded-lg bg-gradient-to-r from-purple-100 to-pink-100">
                        <Sparkles className="w-3 h-3 text-purple-600" />
                      </div>
                    </div>
                    <div className="flex-1 min-w-0 text-right">
                      <div className="font-medium text-gray-800 group-hover:text-purple-700 transition-colors">{`${candidate.firstName} ${candidate.lastName}`}</div>
                      <div className="text-xs text-gray-500 truncate mt-0.5">
                        {[
                          candidate.profile.city,
                          candidate.profile.occupation,
                          candidate.profile.religiousLevel,
                        ]
                          .filter(Boolean)
                          .join('  ')}
                      </div>
                    </div>
                    <div className="relative">
                      <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
                        <span className="text-sm font-bold text-purple-600">
                          {candidate.firstName.charAt(0)}
                          {candidate.lastName.charAt(0)}
                        </span>
                      </div>
                      {candidate.isVerified && (
                        <div className="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-emerald-500 to-green-500 rounded-full flex items-center justify-center">
                          <Star className="w-2 h-2 text-white" />
                        </div>
                      )}
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          )}

          <div className="md:hidden border-t border-gray-100">
            <div className="px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50">
              <div className="flex items-center justify-end gap-2 mb-3">
                <span className="text-sm font-medium text-indigo-800">
                  驻砖 驻 拽专
                </span>
                <TrendingUp className="w-4 h-4 text-indigo-600" />
              </div>
              <div className="grid grid-cols-2 gap-2">
                {searchCategories.map((category) => (
                  <motion.div key={category.id} whileHover={{ scale: 1.02 }}>
                    <Button
                      variant={
                        searchCategory === category.id ? 'default' : 'outline'
                      }
                      size="sm"
                      className={cn(
                        'w-full justify-start gap-2 rounded-xl transition-all duration-200',
                        searchCategory === category.id
                          ? `bg-gradient-to-r ${category.gradient} text-white shadow-lg border-0`
                          : 'bg-white/80 hover:bg-white border border-gray-200 hover:border-gray-300'
                      )}
                      onClick={() => setSearchCategory(category.id)}
                    >
                      {category.icon}
                      <span className="text-xs">{category.label}</span>
                    </Button>
                  </motion.div>
                ))}
              </div>
            </div>
          </div>

          <div className="p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 border-t border-gray-100">
            <div className="flex items-start gap-2 text-right">
              <Sparkles className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
              <div className="text-xs text-gray-600 leading-relaxed">
                <span className="font-medium">{dict.tip}</span>{' '}
                {dict.tipContent}
              </div>
            </div>
          </div>
        </div>
      </PopoverContent>
    </Popover>
  );
};

export default SearchBar;
--- End of Content for SearchBar.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\VirtualSearch
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\VirtualSearch\SavedVirtualProfiles.tsx
--------------------------------------------------------------------------------
Content:
// ===========================================
// 拽抓 砖: src/components/matchmaker/new/VirtualSearch/SavedVirtualProfiles.tsx
// ===========================================

'use client';

import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  Star,
  StarOff,
  Target,
  MoreVertical,
  Trash2,
  Edit3,
  Loader2,
  UserCircle,
  Clock,
  RefreshCw,
  Plus,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { formatDistanceToNow } from 'date-fns';
import { he } from 'date-fns/locale';

// ============================================================================
// TYPES
// ============================================================================

interface GeneratedVirtualProfile {
  inferredAge: number;
  inferredCity: string | null;
  inferredOccupation: string | null;
  personalitySummary: string;
  lookingForSummary: string;
  keyTraits: string[];
  displaySummary: string;
}

interface SavedProfile {
  id: string;
  name: string | null;
  gender: 'MALE' | 'FEMALE';
  religiousLevel: string;
  generatedProfile: GeneratedVirtualProfile;
  editedSummary: string | null;
  wasEdited: boolean;
  isStarred: boolean;
  lastUsedAt: string | null;
  usageCount: number;
  createdAt: string;
}

interface SavedVirtualProfilesProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectProfile: (profile: SavedProfile) => void;
  onCreateNew: () => void;
  locale: string;
}

// 驻 专转 转转 转爪
const RELIGIOUS_LEVEL_LABELS: Record<string, string> = {
  charedi_modern: '专 专',
  dati_leumi_torani: '转  转专',
  dati_leumi_standard: '转 ',
  dati_leumi_liberal: '转  专',
  masorti_strong: '住专转 拽',
  masorti_light: '住专转 ',
  secular_traditional_connection: ' 住专转',
  secular: '',
};

// ============================================================================
// COMPONENT
// ============================================================================

const SavedVirtualProfiles: React.FC<SavedVirtualProfilesProps> = ({
  isOpen,
  onClose,
  onSelectProfile,
  onCreateNew,
  locale,
}) => {
  const [profiles, setProfiles] = useState<SavedProfile[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null);
  const [deletingId, setDeletingId] = useState<string | null>(null);

  const isRtl = locale === 'he';

  // 注转 驻专驻
  const loadProfiles = async () => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/ai/virtual-profile');
      const data = await response.json();

      if (data.success) {
        setProfiles(data.profiles || []);
      } else {
        throw new Error(data.message);
      }
    } catch (error) {
      console.error('Error loading virtual profiles:', error);
      toast.error('砖 注转 驻专驻');
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    if (isOpen) {
      loadProfiles();
    }
  }, [isOpen]);

  // 住/ 
  const handleToggleStar = async (profileId: string, currentStarred: boolean) => {
    try {
      const response = await fetch('/api/ai/virtual-profile', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: profileId,
          isStarred: !currentStarred,
        }),
      });

      if (response.ok) {
        setProfiles(prev =>
          prev.map(p =>
            p.id === profileId ? { ...p, isStarred: !currentStarred } : p
          )
        );
      }
    } catch (error) {
      console.error('Error toggling star:', error);
    }
  };

  // 拽转 驻专驻
  const handleDelete = async (profileId: string) => {
    setDeletingId(profileId);
    try {
      const response = await fetch(`/api/ai/virtual-profile?id=${profileId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        setProfiles(prev => prev.filter(p => p.id !== profileId));
        toast.success('驻专驻 拽');
      } else {
        throw new Error('Failed to delete');
      }
    } catch (error) {
      console.error('Error deleting profile:', error);
      toast.error('砖 拽转 驻专驻');
    } finally {
      setDeletingId(null);
      setDeleteConfirmId(null);
    }
  };

  // 专转 驻专驻 驻砖
  const handleSelectProfile = (profile: SavedProfile) => {
    onSelectProfile(profile);
    onClose();
  };

  return (
    <>
      <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>
        <DialogContent 
          className="max-w-2xl max-h-[80vh]"
          dir={isRtl ? 'rtl' : 'ltr'}
        >
          <DialogHeader>
            <div className="flex items-center justify-between">
              <DialogTitle className="flex items-center gap-2">
                <UserCircle className="w-5 h-5 text-purple-500" />
                驻专驻 专 砖专
              </DialogTitle>
              <div className="flex items-center gap-2">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={loadProfiles}
                  disabled={isLoading}
                >
                  <RefreshCw className={cn('w-4 h-4', isLoading && 'animate-spin')} />
                </Button>
                <Button
                  size="sm"
                  onClick={() => {
                    onClose();
                    onCreateNew();
                  }}
                  className="bg-purple-600 hover:bg-purple-700 text-white"
                >
                  <Plus className="w-4 h-4 ml-1" />
                  砖
                </Button>
              </div>
            </div>
          </DialogHeader>

          <ScrollArea className="h-[60vh] mt-4">
            {isLoading ? (
              <div className="flex items-center justify-center h-40">
                <Loader2 className="w-8 h-8 animate-spin text-purple-500" />
              </div>
            ) : profiles.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-40 text-gray-500">
                <UserCircle className="w-12 h-12 mb-2 opacity-50" />
                <p> 驻专驻 砖专</p>
                <Button
                  variant="link"
                  onClick={() => {
                    onClose();
                    onCreateNew();
                  }}
                  className="text-purple-600"
                >
                  爪专 驻专驻 砖
                </Button>
              </div>
            ) : (
              <div className="space-y-3 pr-2">
                {profiles.map((profile) => (
                  <div
                    key={profile.id}
                    className={cn(
                      'group relative p-4 rounded-xl border transition-all cursor-pointer',
                      'hover:border-purple-300 hover:shadow-md',
                      profile.isStarred ? 'bg-gradient-to-br from-amber-50 to-yellow-50 border-amber-200' : 'bg-white border-gray-200'
                    )}
                    onClick={() => handleSelectProfile(profile)}
                  >
                    {/* Star Button */}
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleToggleStar(profile.id, profile.isStarred);
                      }}
                      className="absolute top-3 left-3 opacity-60 hover:opacity-100 transition-opacity"
                    >
                      {profile.isStarred ? (
                        <Star className="w-5 h-5 text-amber-500 fill-amber-500" />
                      ) : (
                        <StarOff className="w-5 h-5 text-gray-400 hover:text-amber-500" />
                      )}
                    </button>

                    {/* Main Content */}
                    <div className="flex items-start gap-4">
                      {/* Avatar */}
                      <div className={cn(
                        'w-12 h-12 rounded-full flex items-center justify-center text-white font-bold',
                        profile.gender === 'MALE' 
                          ? 'bg-gradient-to-br from-blue-500 to-indigo-600' 
                          : 'bg-gradient-to-br from-pink-500 to-rose-600'
                      )}>
                        {profile.gender === 'MALE' ? '' : ''}
                      </div>

                      {/* Details */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="font-bold text-gray-800 truncate">
                            {profile.name || '驻专驻  砖'}
                          </h3>
                          {profile.wasEdited && (
                            <span className="text-xs px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full">
                              注专
                            </span>
                          )}
                        </div>

                        <div className="flex flex-wrap items-center gap-2 text-sm text-gray-600">
                          <span className={cn(
                            'px-2 py-0.5 rounded-full text-xs',
                            profile.gender === 'MALE' 
                              ? 'bg-blue-100 text-blue-700' 
                              : 'bg-pink-100 text-pink-700'
                          )}>
                            {profile.gender === 'MALE' ? '专' : '砖'}, {profile.generatedProfile?.inferredAge || '?'}
                          </span>
                          <span className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">
                            {RELIGIOUS_LEVEL_LABELS[profile.religiousLevel] || profile.religiousLevel}
                          </span>
                        </div>

                        {/* Summary Preview */}
                        <p className="text-sm text-gray-500 mt-2 line-clamp-2">
                          {profile.editedSummary || profile.generatedProfile?.displaySummary || ' 转专'}
                        </p>

                        {/* Meta Info */}
                        <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
                          <span className="flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {profile.lastUsedAt 
                              ? `砖砖 专: ${formatDistanceToNow(new Date(profile.lastUsedAt), { addSuffix: true, locale: he })}`
                              : `爪专 ${formatDistanceToNow(new Date(profile.createdAt), { addSuffix: true, locale: he })}`
                            }
                          </span>
                          {profile.usageCount > 0 && (
                            <span>{profile.usageCount} 驻砖</span>
                          )}
                        </div>
                      </div>

                      {/* Actions Menu */}
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
                          <Button
                            variant="ghost"
                            size="sm"
                            className="h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            <MoreVertical className="w-4 h-4" />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          <DropdownMenuItem
                            onClick={(e) => {
                              e.stopPropagation();
                              handleSelectProfile(profile);
                            }}
                          >
                            <Target className="w-4 h-4 ml-2" />
                            驻注 驻砖
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={(e) => {
                              e.stopPropagation();
                              setDeleteConfirmId(profile.id);
                            }}
                            className="text-red-600"
                          >
                            <Trash2 className="w-4 h-4 ml-2" />
                            拽
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </div>

                    {/* Hover Action */}
                    <div className="absolute inset-0 flex items-center justify-center bg-purple-600/0 group-hover:bg-purple-600/5 rounded-xl transition-colors pointer-events-none">
                      <span className="opacity-0 group-hover:opacity-100 text-purple-600 font-medium flex items-center gap-1 transition-opacity">
                        <Target className="w-4 h-4" />
                        抓 驻注转 驻砖
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </ScrollArea>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteConfirmId} onOpenChange={() => setDeleteConfirmId(null)}>
        <AlertDialogContent dir={isRtl ? 'rtl' : 'ltr'}>
          <AlertDialogHeader>
            <AlertDialogTitle>拽转 驻专驻 专</AlertDialogTitle>
            <AlertDialogDescription>
               转  砖专爪 拽 转 驻专驻? 驻注   转转 .
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel></AlertDialogCancel>
            <AlertDialogAction
              onClick={() => deleteConfirmId && handleDelete(deleteConfirmId)}
              className="bg-red-600 hover:bg-red-700"
              disabled={!!deletingId}
            >
              {deletingId ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                '拽'
              )}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
};

export default SavedVirtualProfiles;
--- End of Content for SavedVirtualProfiles.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\VirtualSearch\VirtualUserDialog.tsx
--------------------------------------------------------------------------------
Content:
// ===========================================
// 拽抓 砖: src/components/matchmaker/new/VirtualSearch/VirtualUserDialog.tsx
// ===========================================

'use client';

import React, { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Loader2, Sparkles, User, Heart, Edit3, Check, X } from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';

// ============================================================================
// TYPES
// ============================================================================

interface GeneratedVirtualProfile {
  inferredAge: number;
  inferredCity: string | null;
  inferredOccupation: string | null;
  inferredMaritalStatus: string | null;
  inferredEducation: string | null;
  personalitySummary: string;
  lookingForSummary: string;
  preferredAgeMin: number;
  preferredAgeMax: number;
  preferredReligiousLevels: string[];
  preferredLocations: string[];
  keyTraits: string[];
  idealPartnerTraits: string[];
  dealBreakers: string[];
  displaySummary: string;
}

interface VirtualProfile {
  id: string;
  name: string | null;
  gender: 'MALE' | 'FEMALE';
  religiousLevel: string;
  generatedProfile: GeneratedVirtualProfile;
  editedSummary?: string | null;
  wasEdited?: boolean;
  createdAt: string;
}

interface VirtualUserDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onProfileCreated: (profile: VirtualProfile) => void;
  locale: string;
}

// 专转 转转 (转 驻  注专转)
const RELIGIOUS_LEVELS = [
  { value: 'charedi_modern', label: '专 专' },
  { value: 'dati_leumi_torani', label: '转  转专' },
  { value: 'dati_leumi_standard', label: '转 ' },
  { value: 'dati_leumi_liberal', label: '转  专' },
  { value: 'masorti_strong', label: '住专转 拽' },
  { value: 'masorti_light', label: '住专转 ' },
  { value: 'secular_traditional_connection', label: ' 注 专 住专转' },
  { value: 'secular', label: '' },
];

// ============================================================================
// COMPONENT
// ============================================================================

const VirtualUserDialog: React.FC<VirtualUserDialogProps> = ({
  isOpen,
  onClose,
  onProfileCreated,
  locale,
}) => {
  // State - 砖 1: 拽
  const [sourceText, setSourceText] = useState('');
  const [gender, setGender] = useState<'MALE' | 'FEMALE' | ''>('');
  const [religiousLevel, setReligiousLevel] = useState('');
  const [name, setName] = useState('');

  // State - 砖 2: 住
  const [generatedProfile, setGeneratedProfile] = useState<GeneratedVirtualProfile | null>(null);
  const [editedSummary, setEditedSummary] = useState('');
  const [isEditingMode, setIsEditingMode] = useState(false);

  // State - 
  const [step, setStep] = useState<1 | 2>(1);
  const [isLoading, setIsLoading] = useState(false);
  const [profileId, setProfileId] = useState<string | null>(null);

  // Reset on close
  const handleClose = () => {
    setStep(1);
    setSourceText('');
    setGender('');
    setReligiousLevel('');
    setName('');
    setGeneratedProfile(null);
    setEditedSummary('');
    setIsEditingMode(false);
    setProfileId(null);
    onClose();
  };

  // 砖 1: 爪专转 驻专驻
  const handleCreateProfile = async () => {
    if (!sourceText.trim() || sourceText.trim().length < 20) {
      toast.error('砖  转专 砖 驻转 20 转');
      return;
    }
    if (!gender) {
      toast.error('砖 专 专');
      return;
    }
    if (!religiousLevel) {
      toast.error('砖 专 专 转转');
      return;
    }

    setIsLoading(true);

    try {
      const response = await fetch('/api/ai/virtual-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sourceText: sourceText.trim(),
          gender,
          religiousLevel,
          name: name.trim() || null,
        }),
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.message || 'Failed to create profile');
      }

      setProfileId(data.virtualProfile.id);
      setGeneratedProfile(data.virtualProfile.generatedProfile);
      setEditedSummary(data.virtualProfile.generatedProfile.displaySummary);
      setStep(2);

      toast.success('驻专驻 爪专 爪!');

    } catch (error) {
      console.error('Error creating virtual profile:', error);
      toast.error('砖 爪专转 驻专驻. 住 砖.');
    } finally {
      setIsLoading(false);
    }
  };

  // 砖 2: 砖专 驻注转 驻砖
  const handleConfirmAndSearch = async () => {
    if (!profileId || !generatedProfile) return;

    setIsLoading(true);

    try {
      //  住 注, 砖专 转
      if (editedSummary !== generatedProfile.displaySummary) {
        await fetch('/api/ai/virtual-profile', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: profileId,
            editedSummary: editedSummary.trim(),
          }),
        });
      }

      // 注专 转 驻专驻 拽驻 
      onProfileCreated({
        id: profileId,
        name: name.trim() || null,
        gender: gender as 'MALE' | 'FEMALE',
        religiousLevel,
        generatedProfile,
        editedSummary: editedSummary !== generatedProfile.displaySummary ? editedSummary : null,
        wasEdited: editedSummary !== generatedProfile.displaySummary,
        createdAt: new Date().toISOString(),
      });

      handleClose();

    } catch (error) {
      console.error('Error confirming profile:', error);
      toast.error('砖 砖专转 驻专驻');
    } finally {
      setIsLoading(false);
    }
  };

  // 专 砖 1
  const handleBackToEdit = () => {
    setStep(1);
    setGeneratedProfile(null);
    setEditedSummary('');
    setIsEditingMode(false);
  };

  const isRtl = locale === 'he';

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent 
        className="max-w-2xl max-h-[90vh] overflow-y-auto"
        dir={isRtl ? 'rtl' : 'ltr'}
      >
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-xl">
            <Sparkles className="w-5 h-5 text-purple-500" />
            {step === 1 ? '爪专转 注 专' : '砖专 驻砖'}
          </DialogTitle>
          <DialogDescription>
            {step === 1 
              ? '转专/ 转 注  / 驻砖/转, 注专转 转爪专 驻专驻 驻砖 转转'
              : '拽/ 转 住 砖爪专, 注专/ 转 爪专, 砖专/ 转转 驻砖'
            }
          </DialogDescription>
        </DialogHeader>

        <AnimatePresence mode="wait">
          {/* ========== STEP 1: INPUT ========== */}
          {step === 1 && (
            <motion.div
              key="step1"
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: 20 }}
              className="space-y-6 mt-4"
            >
              {/* Text Input */}
              <div className="space-y-2">
                <Label className="flex items-center gap-2 text-base font-medium">
                  <User className="w-4 h-4 text-blue-500" />
                  转专/ 转 注  / 驻砖/转
                </Label>
                <Textarea
                  value={sourceText}
                  onChange={(e) => setSourceText(e.target.value)}
                  placeholder={`:
专  28, 转转 拽, 专 转 .
砖拽, 专爪,  专.   注 拽专.
驻砖 专 转, 专砖, 注 .
注驻转 转转,   专注砖转 ...`}
                  className="min-h-[180px] resize-none"
                  dir={isRtl ? 'rtl' : 'ltr'}
                />
                <p className="text-xs text-gray-500">
                  {sourceText.length} 转 ( 20)
                </p>
              </div>

              {/* Gender & Religious Level */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label className="text-sm font-medium">专 注</Label>
                  <Select value={gender} onValueChange={(v) => setGender(v as 'MALE' | 'FEMALE')}>
                    <SelectTrigger>
                      <SelectValue placeholder="专 专" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="MALE"> 专</SelectItem>
                      <SelectItem value="FEMALE"> 砖</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label className="text-sm font-medium">专 转转</Label>
                  <Select value={religiousLevel} onValueChange={setReligiousLevel}>
                    <SelectTrigger>
                      <SelectValue placeholder="专 专 转转" />
                    </SelectTrigger>
                    <SelectContent>
                      {RELIGIOUS_LEVELS.map((level) => (
                        <SelectItem key={level.value} value={level.value}>
                          {level.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Optional Name */}
              <div className="space-y-2">
                <Label className="text-sm font-medium">砖  (驻爪)</Label>
                <Input
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder=":  - 专 砖拽 转状"
                  dir={isRtl ? 'rtl' : 'ltr'}
                />
              </div>

              {/* Submit Button */}
              <Button
                onClick={handleCreateProfile}
                disabled={isLoading || !sourceText.trim() || sourceText.length < 20 || !gender || !religiousLevel}
                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white"
                size="lg"
              >
                {isLoading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin ml-2" />
                    爪专 驻专驻...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5 ml-2" />
                    爪专 驻专驻 砖
                  </>
                )}
              </Button>
            </motion.div>
          )}

          {/* ========== STEP 2: REVIEW & CONFIRM ========== */}
          {step === 2 && generatedProfile && (
            <motion.div
              key="step2"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              className="space-y-6 mt-4"
            >
              {/* Profile Summary Card */}
              <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border border-purple-100">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-pink-500" />
                    住 驻专驻
                  </h3>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setIsEditingMode(!isEditingMode)}
                    className="text-purple-600 hover:text-purple-700"
                  >
                    {isEditingMode ? (
                      <>
                        <Check className="w-4 h-4 ml-1" />
                        住 注专
                      </>
                    ) : (
                      <>
                        <Edit3 className="w-4 h-4 ml-1" />
                        注专 住
                      </>
                    )}
                  </Button>
                </div>

                {/* Editable Summary */}
                {isEditingMode ? (
                  <Textarea
                    value={editedSummary}
                    onChange={(e) => setEditedSummary(e.target.value)}
                    className="min-h-[150px] bg-white"
                    dir={isRtl ? 'rtl' : 'ltr'}
                  />
                ) : (
                  <div className="bg-white rounded-lg p-4 text-gray-700 whitespace-pre-wrap leading-relaxed">
                    {editedSummary || generatedProfile.displaySummary}
                  </div>
                )}

                {/* Inferred Details */}
                <div className="mt-4 grid grid-cols-2 gap-3 text-sm">
                  <div className="bg-white/60 rounded-lg p-3">
                    <span className="text-gray-500"> 砖注专:</span>
                    <span className="font-medium mr-2">{generatedProfile.inferredAge}</span>
                  </div>
                  <div className="bg-white/60 rounded-lg p-3">
                    <span className="text-gray-500">专:</span>
                    <span className="font-medium mr-2">{gender === 'MALE' ? '专' : '砖'}</span>
                  </div>
                  {generatedProfile.inferredCity && (
                    <div className="bg-white/60 rounded-lg p-3">
                      <span className="text-gray-500">注专:</span>
                      <span className="font-medium mr-2">{generatedProfile.inferredCity}</span>
                    </div>
                  )}
                  {generatedProfile.inferredOccupation && (
                    <div className="bg-white/60 rounded-lg p-3">
                      <span className="text-gray-500">拽爪注:</span>
                      <span className="font-medium mr-2">{generatedProfile.inferredOccupation}</span>
                    </div>
                  )}
                </div>

                {/* Key Traits */}
                {generatedProfile.keyTraits && generatedProfile.keyTraits.length > 0 && (
                  <div className="mt-4">
                    <span className="text-sm text-gray-500">转转 专转:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                      {generatedProfile.keyTraits.map((trait, i) => (
                        <span
                          key={i}
                          className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs"
                        >
                          {trait}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {/* Looking For */}
                {generatedProfile.idealPartnerTraits && generatedProfile.idealPartnerTraits.length > 0 && (
                  <div className="mt-3">
                    <span className="text-sm text-gray-500">驻砖 /转 :</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                      {generatedProfile.idealPartnerTraits.map((trait, i) => (
                        <span
                          key={i}
                          className="px-2 py-1 bg-pink-100 text-pink-700 rounded-full text-xs"
                        >
                          {trait}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3">
                <Button
                  variant="outline"
                  onClick={handleBackToEdit}
                  className="flex-1"
                >
                  <X className="w-4 h-4 ml-2" />
                  专 注专
                </Button>
                <Button
                  onClick={handleConfirmAndSearch}
                  disabled={isLoading}
                  className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white"
                >
                  {isLoading ? (
                    <>
                      <Loader2 className="w-5 h-5 animate-spin ml-2" />
                      砖专...
                    </>
                  ) : (
                    <>
                      <Check className="w-5 h-5 ml-2" />
                      砖专 砖 驻砖
                    </>
                  )}
                </Button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </DialogContent>
    </Dialog>
  );
};

export default VirtualUserDialog;
--- End of Content for VirtualUserDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\VirtualSearch\index.tsx
--------------------------------------------------------------------------------
Content:
// ===========================================
// 拽抓 砖: src/components/matchmaker/new/VirtualSearch/index.tsx
// ===========================================

export { default as VirtualUserDialog } from './VirtualUserDialog';
export { default as SavedVirtualProfiles } from './SavedVirtualProfiles';
--- End of Content for index.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants\filterOptions.ts
--------------------------------------------------------------------------------
Content:
// /constants/filterOptions.ts
import { AvailabilityStatus } from '@prisma/client';

export const AGE_RANGE = {
  min: 18,
  max: 130,
  default: {
    min: 20,
    max: 35
  }
};

export const HEIGHT_RANGE = {
  min: 80,
  max: 210,
  default: {
    min: 150,
    max: 190
  }
};

export const RELIGIOUS_LEVELS = [
  { value: "charedi", label: "专/转" },
  { value: "charedi_modern", label: "专/转 专/转" },
  { value: "dati_leumi_torani", label: "转/ /转 转专/转" },
  { value: "dati_leumi_liberal", label: "转/ /转 专/转" },
  { value: "dati_leumi_standard", label: "转/ /转 (住专)" },
  { value: "masorti_strong", label: "住专转/转 (拽专/ 转)" },
  { value: "masorti_light", label: "住专转/转 (拽砖专 拽 住专转)" },
  {
    value: "secular_traditional_connection",
    label: "/转 注 拽 住专转",
  },
  { value: "secular", label: "/转" },
  { value: "spiritual_not_religious", label: "专/转 ( 拽 转/)" },
  { value: "other", label: "专 ( 驻专 '转')" },
];

export const EDUCATION_LEVELS = [
  { value: '转转', label: '砖 转转' },
  { value: '砖', label: '砖' },
  { value: '住专', label: '住专' },
  { value: '转专 专砖', label: '转专 专砖' },
  { value: '转专 砖', label: '转专 砖' },
  { value: '拽专', label: '拽专' }
];

export const MARITAL_STATUS = [
  { value: '专拽/', label: '专拽/' },
  { value: '专砖/', label: '专砖/' },
  { value: '/', label: '/' }
];

export const OCCUPATION_CATEGORIES = [
  { value: '', label: ' 专' },
  { value: '拽', label: '拽 转' },
  { value: '专驻', label: '专驻 专转' },
  { value: '砖驻', label: '砖驻' },
  { value: '注住拽', label: '注住拽 ' },
  { value: '砖专转', label: '砖专转' },
  { value: '专', label: '专' }
];

export const REGIONS = [
  { value: '专砖', label: '专砖 住' },
  { value: '转 ', label: '转  专' },
  { value: '驻', label: '驻 爪驻' },
  { value: '专 砖注', label: '专 砖注 专' },
  { value: ' 砖专', label: ' 砖专' }
];

export const POPULAR_CITIES = [
  '专砖',
  '转 ',
  '驻',
  ' 专拽',
  '驻转 转拽',
  '砖',
  '转',
  '专 砖注',
  '',
  '专转 ',
  '转 砖砖',
  '注 注转',
  '注',
  '转专 注转'
];

export const AVAILABILITY_STATUS_OPTIONS = [
  { 
    value: AvailabilityStatus.AVAILABLE, 
    label: '驻/',
    description: '注/转 驻/ 爪注转'
  },
  { 
    value: AvailabilityStatus.DATING, 
    label: '转 专转',
    description: '爪/转 转 专转'
  },
  { 
    value: AvailabilityStatus.UNAVAILABLE, 
    label: ' 驻/',
    description: ' 驻/ 爪注转 专注'
  }
];

export const SORT_OPTIONS = [
  { 
    value: 'lastActive',
    label: '驻注转 专',
    defaultOrder: 'desc'
  },
  { 
    value: 'age',
    label: '',
    defaultOrder: 'asc'
  },
  { 
    value: 'name',
    label: '砖',
    defaultOrder: 'asc'
  },
  { 
    value: 'city',
    label: '注专',
    defaultOrder: 'asc'
  },
  { 
    value: 'religiousLevel',
    label: '专转 转转',
    defaultOrder: 'asc'
  },
  { 
    value: 'height',
    label: '',
    defaultOrder: 'desc'
  },
  { 
    value: 'registrationDate',
    label: '转专 专砖',
    defaultOrder: 'desc'
  }
];

export const VIEW_OPTIONS = [
  {
    value: 'grid',
    label: '转爪转 专',
    icon: 'LayoutGrid'
  },
  {
    value: 'list',
    label: '转爪转 专砖',
    icon: 'List'
  }
];

export const CARD_SIZES = [
  {
    value: 'sm',
    label: '拽',
    dimensions: {
      grid: 'h-64',
      list: 'h-24'
    }
  },
  {
    value: 'md',
    label: '',
    dimensions: {
      grid: 'h-80',
      list: 'h-32'
    }
  },
  {
    value: 'lg',
    label: '',
    dimensions: {
      grid: 'h-96',
      list: 'h-40'
    }
  }
];

export const GROUP_BY_OPTIONS = [
  {
    value: 'none',
    label: ' 拽抓'
  },
  {
    value: 'city',
    label: '注专'
  },
  {
    value: 'religiousLevel',
    label: '专转 转转'
  },
  {
    value: 'ageGroup',
    label: '拽爪转 '
  },
  {
    value: 'availability',
    label: '住住 转'
  }
];

export const DEFAULT_FILTERS = {
  gender: undefined,
  ageRange: undefined,      // : AGE_RANGE.default
  heightRange: undefined,   // : HEIGHT_RANGE.default
  cities: [],
  religiousLevel: undefined,
  occupations: [],
  availability: undefined,
  searchQuery: '',
  isVerified: undefined,
  hasReferences: undefined,
  lastActiveDays: undefined
};

export const FILTER_CATEGORIES = [
  {
    id: 'basic',
    label: '驻专 住住',
    filters: ['gender', 'ageRange', 'cities', 'religiousLevel']
  },
  {
    id: 'advanced',
    label: '驻专 转拽',
    filters: ['heightRange', 'occupations', 'education', 'maritalStatus']
  },
  {
    id: 'status',
    label: '住住 转',
    filters: ['availability', 'isVerified', 'hasReferences', 'lastActiveDays']
  }
];
--- End of Content for filterOptions.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\constants\matchingCriteria.ts
--------------------------------------------------------------------------------
Content:
// /constants/matchingCriteria.ts

export const CRITERIA_WEIGHTS = {
    // 拽专专 住住
    age: {
      weight: 15,
      description: '转转 ',
      thresholds: {
        perfect: 2,  // 驻专砖 砖 注 砖转
        good: 5,     // 驻专砖 砖 注 5 砖
        fair: 8      // 驻专砖 砖 注 8 砖
      }
    },
    
    religiousLevel: {
      weight: 20,
      description: '转 转转',
      bonusPoints: {
        exactMatch: 1.0,        // 转 拽转
        adjacentLevel: 0.8,     // 专 转转 住
        twoLevelsApart: 0.4     // 驻专砖 砖 砖转 专转
      }
    },
  
    location: {
      weight: 10,
      description: '拽 专驻',
      bonusPoints: {
        sameCity: 1.0,          // 转 注专
        sameRegion: 0.8,        // 转 专
        preferredCity: 0.7,     // 注专 注驻转
        differentRegion: 0.4    // 专 专
      }
    },
  
    // 拽专专 拽爪注 砖转
    education: {
      weight: 8,
      description: '专转 砖',
      bonusPoints: {
        sameLevel: 1.0,         // 专转 砖 
        adjacentLevel: 0.8,     // 专转 砖 住
        meetPreferences: 0.7    // 注 注驻转
      }
    },
  
    occupation: {
      weight: 7,
      description: '转 注住拽',
      bonusPoints: {
        sameField: 1.0,         // 转 转
        relatedField: 0.8,      // 转 拽专
        meetPreferences: 0.7    // 注 注驻转
      }
    },
  
    // 拽专专 砖
    familyBackground: {
      weight: 12,
      description: '专拽注 砖驻转',
      factors: {
        origin: 0.4,            // 爪
        parentStatus: 0.3,      // 爪 专
        familyType: 0.3         // 住 砖驻
      }
    },
  
    personalityMatch: {
      weight: 15,
      description: '转 砖转转',
      factors: {
        hobbies: 0.3,           // 转 砖转驻
        lifestyle: 0.4,         // 住 
        values: 0.3             // 注专 砖转驻
      }
    },
  
    // 专 住驻
    preferences: {
      weight: 8,
      description: '注驻转 砖转',
      factors: {
        agePreference: 0.3,     // 注驻转 
        locationPreference: 0.3, // 注驻转 拽
        otherPreferences: 0.4   // 注驻转 住驻转
      }
    },
  
    compatibility: {
      weight: 5,
      description: '转转 转',
      factors: {
        language: 0.3,          // 砖驻 砖转驻转
        culture: 0.4,           // 转专转
        lifestyle: 0.3          // 住 
      }
    }
  };
  
  // 住祝 爪 转 
  export const MATCH_THRESHOLDS = {
    EXCELLENT: 85,  // 转 爪转
    GOOD: 75,       // 转 
    FAIR: 65,       // 转 住专
    POOR: 50        // 转 砖
  };
  
  // 砖拽 住 驻 住 转
  export const MATCH_TYPE_WEIGHTS = {
    PRECISE: {     // 转 拽转
      exact: 1.0,
      similar: 0.8,
      partial: 0.5
    },
    FLEXIBLE: {    // 转 砖
      exact: 0.8,
      similar: 1.0,
      partial: 0.7
    },
    OPEN: {        // 转 驻转
      exact: 0.7,
      similar: 0.9,
      partial: 1.0
    }
  };
  
  // 专转 拽专转 转
  export const MATCH_CATEGORIES = {
    IMMEDIATE: {
      minScore: 90,
      label: '转 转',
      description: '转  , 抓 爪专 拽砖专 拽'
    },
    HIGH: {
      minScore: 80,
      label: '转 ',
      description: '转  , 砖 拽'
    },
    GOOD: {
      minScore: 70,
      label: '转 ',
      description: '砖 驻爪  转'
    },
    MODERATE: {
      minScore: 60,
      label: '转 转',
      description: '砖 拽转 砖转驻转,   '
    },
    LOW: {
      minScore: 50,
      label: '转 ',
      description: '砖 驻注专 砖注转  注'
    }
  };
--- End of Content for matchingCriteria.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\ActionDialogs.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogFooter,
  DialogDescription,
} from '@/components/ui/dialog';
import { Priority, MatchSuggestionStatus } from '@prisma/client';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Clock,
  Mail,
  Loader2,
  Send,
  Sparkles,
  CheckCircle,
  Heart,
  MessageCircle,
  Calendar,
  AlertCircle,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { getRelativeCloudinaryPath, getInitials } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface NewSuggestionFormData {
  firstPartyId: string;
  secondPartyId: string;
  priority: Priority;
  status: MatchSuggestionStatus;
}

interface ActionDialogsProps {
  suggestDialog: {
    isOpen: boolean;
    onClose: () => void;
    onSubmit: (data: NewSuggestionFormData) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  availabilityDialog: {
    isOpen: boolean;
    onClose: () => void;
    onCheck: (candidate: Candidate) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  inviteDialog: {
    isOpen: boolean;
    onClose: () => void;
    onInvite: (candidate: Candidate, email: string) => Promise<void>;
    selectedCandidate: Candidate | null;
  };
  dict: MatchmakerPageDictionary['candidatesManager']['actionDialogs'];
}

// Enhanced Dialog Header Component
const EnhancedDialogHeader: React.FC<{
  title: string;
  description: string;
  candidate: Candidate | null;
  icon: React.ReactNode;
  gradient: string;
}> = ({ title, description, candidate, icon, gradient }) => {
  const mainImage = candidate?.images?.find((img) => img.isMain);

  return (
    <div
      className={cn(
        'relative bg-gradient-to-br overflow-hidden rounded-t-3xl -mx-6 -mt-6 mb-6',
        gradient
      )}
    >
      <div className="absolute inset-0">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white/20 rounded-full blur-2xl"></div>
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
      </div>
      <div className="relative z-10 p-6 text-white">
        <div className="flex items-center gap-4 mb-4">
          <div className="p-3 rounded-full bg-white/20 backdrop-blur-sm shadow-lg">
            {icon}
          </div>
          <div>
            <DialogTitle className="text-2xl font-bold text-white mb-1">
              {title}
            </DialogTitle>
            <DialogDescription className="text-white/90 text-lg">
              {description}
            </DialogDescription>
          </div>
        </div>
        {candidate && (
          <div className="flex items-center gap-3 p-3 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20">
            <Avatar className="w-12 h-12 border-2 border-white/30 shadow-lg">
              {mainImage ? (
                <AvatarImage
                  src={getRelativeCloudinaryPath(mainImage.url)}
                  alt={`${candidate.firstName} ${candidate.lastName}`}
                />
              ) : (
                <AvatarFallback className="bg-white/20 text-white font-bold">
                  {getInitials(`${candidate.firstName} ${candidate.lastName}`)}
                </AvatarFallback>
              )}
            </Avatar>
            <div>
              <h3 className="font-bold text-white text-lg">
                {candidate.firstName} {candidate.lastName}
              </h3>
              <div className="flex items-center gap-2 mt-1">
                <Badge className="bg-white/20 text-white border-white/30 text-xs">
                  {candidate.profile.city || ' 爪'}
                </Badge>
                <Badge className="bg-white/20 text-white border-white/30 text-xs">
                  {candidate.profile.availabilityStatus === 'AVAILABLE'
                    ? '/'
                    : ' /'}
                </Badge>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export const ActionDialogs: React.FC<ActionDialogsProps> = ({
  suggestDialog,
  availabilityDialog,
  inviteDialog,
  dict,
}) => {
  const [inviteEmail, setInviteEmail] = useState('');
  const [isInviting, setIsInviting] = useState(false);
  const [inviteError, setInviteError] = useState<string | null>(null);
  const [inviteSuccess, setInviteSuccess] = useState(false);

  const [isChecking, setIsChecking] = useState(false);
  const [availabilityError, setAvailabilityError] = useState<string | null>(
    null
  );
  const [availabilitySuccess, setAvailabilitySuccess] = useState(false);

  useEffect(() => {
    if (inviteDialog.isOpen && inviteDialog.selectedCandidate) {
      setInviteEmail(inviteDialog.selectedCandidate.email || '');
      setInviteError(null);
      setInviteSuccess(false);
    }
  }, [inviteDialog.isOpen, inviteDialog.selectedCandidate]);

  useEffect(() => {
    if (availabilityDialog.isOpen) {
      setAvailabilityError(null);
      setAvailabilitySuccess(false);
    }
  }, [availabilityDialog.isOpen]);

  const handleInviteSubmit = async () => {
    if (!inviteDialog.selectedCandidate || !inviteEmail) return;
    try {
      setIsInviting(true);
      setInviteError(null);
      await inviteDialog.onInvite(inviteDialog.selectedCandidate, inviteEmail);
      setInviteSuccess(true);
      setTimeout(() => inviteDialog.onClose(), 2000);
    } catch (error) {
      setInviteError(
        error instanceof Error ? error.message : dict.invite.submissionError
      );
    } finally {
      setIsInviting(false);
    }
  };

  const handleAvailabilityCheck = async () => {
    if (!availabilityDialog.selectedCandidate) return;
    try {
      setIsChecking(true);
      setAvailabilityError(null);
      await availabilityDialog.onCheck(availabilityDialog.selectedCandidate);
      setAvailabilitySuccess(true);
      setTimeout(() => availabilityDialog.onClose(), 2000);
    } catch (error) {
      setAvailabilityError(
        error instanceof Error
          ? error.message
          : dict.availability.submissionError
      );
    } finally {
      setIsChecking(false);
    }
  };

  const validateEmail = (email: string) =>
    /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  return (
    <>
      <Dialog open={inviteDialog.isOpen} onOpenChange={inviteDialog.onClose}>
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.invite.title}
            description={dict.invite.description}
            candidate={inviteDialog.selectedCandidate}
            icon={<Send className="w-8 h-8" />}
            gradient="from-purple-500 to-indigo-500"
          />
          <div className="space-y-6 p-6 -mt-6">
            {inviteSuccess ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <CheckCircle className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold text-green-800 mb-2">
                  {dict.invite.successMessage}
                </h3>
                <p className="text-green-600">
                  {dict.invite.successDescription}
                </p>
              </div>
            ) : (
              <>
                <div className="space-y-3">
                  <Label className="text-sm font-bold text-gray-700 flex items-center gap-2">
                    <Mail className="w-4 h-4 text-purple-500" />
                    {dict.invite.emailLabel}
                  </Label>
                  <div className="relative">
                    <Input
                      type="email"
                      value={inviteEmail}
                      onChange={(e) => {
                        setInviteEmail(e.target.value);
                        setInviteError(null);
                      }}
                      placeholder={dict.invite.emailPlaceholder}
                      className={cn(
                        'pr-12 h-12 bg-gray-50 border-2 border-gray-200 focus:border-purple-400 focus:ring-purple-200 rounded-xl transition-all duration-300',
                        !validateEmail(inviteEmail) &&
                          inviteEmail.length > 0 &&
                          'border-red-300 focus:border-red-400'
                      )}
                      dir="ltr"
                    />
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2">
                      <Mail className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                  {inviteEmail && !validateEmail(inviteEmail) && (
                    <p className="text-red-500 text-sm flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {dict.invite.invalidEmailError}
                    </p>
                  )}
                </div>
                {inviteError && (
                  <Alert className="border-red-200 bg-red-50">
                    <AlertCircle className="h-4 w-4 text-red-600" />
                    <AlertDescription className="text-red-700 font-medium">
                      {inviteError}
                    </AlertDescription>
                  </Alert>
                )}
                <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-100">
                  <h4 className="font-bold text-purple-800 mb-2 flex items-center gap-2">
                    <Sparkles className="w-4 h-4" />
                    {dict.invite.whatsNextTitle}
                  </h4>
                  <ul className="text-sm text-purple-700 space-y-1">
                    {dict.invite.whatsNextItems.map((item, i) => (
                      <li key={i}> {item}</li>
                    ))}
                  </ul>
                </div>
              </>
            )}
          </div>
          {!inviteSuccess && (
            <DialogFooter className="p-6 pt-0 gap-3">
              <Button
                variant="outline"
                onClick={inviteDialog.onClose}
                disabled={isInviting}
                className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
              >
                {dict.invite.buttons.cancel}
              </Button>
              <Button
                onClick={handleInviteSubmit}
                disabled={
                  isInviting || !inviteEmail || !validateEmail(inviteEmail)
                }
                className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
              >
                {isInviting ? (
                  <Loader2 className="ml-2 h-5 w-5 animate-spin" />
                ) : (
                  <Send className="ml-2 h-5 w-5" />
                )}
                {isInviting
                  ? dict.invite.buttons.sending
                  : dict.invite.buttons.send}
              </Button>
            </DialogFooter>
          )}
        </DialogContent>
      </Dialog>

      <Dialog
        open={availabilityDialog.isOpen}
        onOpenChange={availabilityDialog.onClose}
      >
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.availability.title}
            description={dict.availability.description}
            candidate={availabilityDialog.selectedCandidate}
            icon={<Calendar className="w-8 h-8" />}
            gradient="from-orange-500 to-amber-500"
          />
          <div className="space-y-6 p-6 -mt-6">
            {availabilitySuccess ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <CheckCircle className="w-8 h-8 text-white" />
                </div>
                <h3 className="text-xl font-bold text-green-800 mb-2">
                  {dict.availability.successMessage}
                </h3>
                <p className="text-green-600">
                  {dict.availability.successDescription}
                </p>
              </div>
            ) : (
              <>
                <div className="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                  <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2">
                    <Clock className="w-4 h-4" />
                    {dict.availability.whatsNextTitle}
                  </h4>
                  <ul className="text-sm text-orange-700 space-y-1">
                    {dict.availability.whatsNextItems.map((item, i) => (
                      <li key={i}> {item}</li>
                    ))}
                  </ul>
                </div>
                {availabilityError && (
                  <Alert className="border-red-200 bg-red-50">
                    <AlertCircle className="h-4 w-4 text-red-600" />
                    <AlertDescription className="text-red-700 font-medium">
                      {availabilityError}
                    </AlertDescription>
                  </Alert>
                )}
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                  <div className="flex items-center gap-3 mb-3">
                    <MessageCircle className="w-5 h-5 text-blue-500" />
                    <span className="font-medium text-gray-800">
                      {dict.availability.messageToSendTitle}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 bg-white p-3 rounded-lg border italic">
                    {dict.availability.messageContent.replace(
                      '{{firstName}}',
                      availabilityDialog.selectedCandidate?.firstName || ''
                    )}
                  </p>
                </div>
              </>
            )}
          </div>
          {!availabilitySuccess && (
            <DialogFooter className="p-6 pt-0 gap-3">
              <Button
                variant="outline"
                onClick={availabilityDialog.onClose}
                disabled={isChecking}
                className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
              >
                {dict.availability.buttons.cancel}
              </Button>
              <Button
                onClick={handleAvailabilityCheck}
                disabled={isChecking}
                className="bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
              >
                {isChecking ? (
                  <Loader2 className="ml-2 h-5 w-5 animate-spin" />
                ) : (
                  <Clock className="ml-2 h-5 w-5" />
                )}
                {isChecking
                  ? dict.availability.buttons.checking
                  : dict.availability.buttons.check}
              </Button>
            </DialogFooter>
          )}
        </DialogContent>
      </Dialog>

      <Dialog open={suggestDialog.isOpen} onOpenChange={suggestDialog.onClose}>
        <DialogContent className="sm:max-w-md border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <EnhancedDialogHeader
            title={dict.suggest.title}
            description={dict.suggest.description}
            candidate={suggestDialog.selectedCandidate}
            icon={<Heart className="w-8 h-8" />}
            gradient="from-pink-500 to-rose-500"
          />
          <div className="p-6 -mt-6">
            <div className="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-xl border border-pink-100">
              <h4 className="font-bold text-pink-800 mb-2 flex items-center gap-2">
                <Sparkles className="w-4 h-4" />
                {dict.suggest.whatsNextTitle}
              </h4>
              <p className="text-sm text-pink-700">
                {dict.suggest.whatsNextDescription}
              </p>
            </div>
          </div>
          <DialogFooter className="p-6 pt-0 gap-3">
            <Button
              variant="outline"
              onClick={suggestDialog.onClose}
              className="border-2 border-gray-200 hover:bg-gray-50 rounded-xl font-medium"
            >
              {dict.suggest.buttons.cancel}
            </Button>
            <Button
              onClick={suggestDialog.onClose}
              className="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl font-bold px-6"
            >
              <Heart className="ml-2 h-5 w-5" />
              {dict.suggest.buttons.continue}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
};

export default ActionDialogs;
--- End of Content for ActionDialogs.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AddManualCandidateDialog.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React, { useState, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { Loader2, UserPlus, X, UploadCloud, Trash2 } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';
import Image from 'next/image';
import { Gender } from '@prisma/client';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { DatePicker } from '@/components/ui/date-picker';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface AddManualCandidateDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onCandidateAdded: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['addManualCandidateDialog'];
  locale: string;
}

const MAX_IMAGES = 5;
const MAX_IMAGE_SIZE_MB = 5;

export const AddManualCandidateDialog: React.FC<
  AddManualCandidateDialogProps
> = ({ isOpen, onClose, onCandidateAdded, dict }) => {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [email, setEmail] = useState('');
  const [gender, setGender] = useState<Gender | undefined>(undefined);
  // --- ADDED: Height State ---
  const [height, setHeight] = useState('');
  const [birthDate, setBirthDate] = useState<Date | undefined>(undefined);
  const [manualEntryText, setManualEntryText] = useState('');
  const [images, setImages] = useState<File[]>([]);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  const [sendInvite, setSendInvite] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [birthDateInputMode, setBirthDateInputMode] = useState<'date' | 'age'>(
    'date'
  );
  const [ageInput, setAgeInput] = useState<string>('');

  const resetForm = useCallback(() => {
    setFirstName('');
    setLastName('');
    setEmail('');
    setGender(undefined);
    // --- ADDED: Reset Height ---
    setHeight('');
    setBirthDate(undefined);
    setManualEntryText('');
    setImages([]);
    setImagePreviews([]);
    setSendInvite(false);
    setIsSaving(false);
    setBirthDateInputMode('date');
    setAgeInput('');
  }, []);

  const handleClose = () => {
    resetForm();
    onClose();
  };

  const handleImageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files) {
      const newFiles = Array.from(event.target.files);
      const validFiles: File[] = [];
      const validPreviews: string[] = [];

      newFiles.forEach((file) => {
        if (images.length + validFiles.length < MAX_IMAGES) {
          if (file.size <= MAX_IMAGE_SIZE_MB * 1024 * 1024) {
            validFiles.push(file);
            validPreviews.push(URL.createObjectURL(file));
          } else {
            toast.error(
              dict.fields.photos.fileTooLargeError
                .replace('{{fileName}}', file.name)
                .replace('{{maxSize}}', String(MAX_IMAGE_SIZE_MB))
            );
          }
        } else {
          toast.warning(
            dict.fields.photos.maxFilesWarning.replace(
              '{{max}}',
              String(MAX_IMAGES)
            )
          );
        }
      });

      setImages((prev) => [...prev, ...validFiles]);
      setImagePreviews((prev) => [...prev, ...validPreviews]);
    }
  };

  const removeImage = (index: number) => {
    setImages(images.filter((_, i) => i !== index));
    setImagePreviews(imagePreviews.filter((_, i) => i !== index));
  };

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    setIsSaving(true);

    if (!firstName || !lastName || !gender || !manualEntryText) {
      toast.error(dict.toasts.error.missingFields);
      setIsSaving(false);
      return;
    }

    let finalBirthDate: Date | undefined;
    let isBirthDateApproximate = false;

    if (birthDateInputMode === 'date') {
      if (!birthDate) {
        toast.error(dict.toasts.error.invalidBirthDate);
        setIsSaving(false);
        return;
      }
      finalBirthDate = birthDate;
    } else {
      const ageNum = parseInt(ageInput, 10);
      if (isNaN(ageNum) || ageNum <= 0 || ageNum > 120) {
        toast.error(dict.toasts.error.invalidAge);
        setIsSaving(false);
        return;
      }
      const birthYear = new Date().getFullYear() - ageNum;
      finalBirthDate = new Date(birthYear, 0, 1);
      isBirthDateApproximate = true;
    }

    const formData = new FormData();
    formData.append('firstName', firstName);
    formData.append('lastName', lastName);
    if (email) formData.append('email', email);
    formData.append('gender', gender);
    // --- ADDED: Append Height ---
    if (height) formData.append('height', height);
    formData.append('birthDate', finalBirthDate.toISOString());
    formData.append('birthDateIsApproximate', String(isBirthDateApproximate));
    formData.append('manualEntryText', manualEntryText);
    images.forEach((image) => formData.append('images', image));

    try {
      const response = await fetch('/api/matchmaker/candidates/manual', {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      if (!response.ok || !result.success)
        throw new Error(result.error || dict.toasts.error.general);

      if (sendInvite && email && result.candidate?.id) {
        const promise = fetch(
          `/api/matchmaker/candidates/${result.candidate.id}/invite-setup`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
          }
        ).then(async (inviteResponse) => {
          if (!inviteResponse.ok) {
            const errorData = await inviteResponse.json().catch(() => ({}));
            throw new Error(errorData.error || 'Invitation failed');
          }
          return inviteResponse.json();
        });
        toast.promise(promise, {
          loading: dict.toasts.success.inviteLoading,
          success: dict.toasts.success.inviteSent,
          error: (err: Error) =>
            dict.toasts.success.inviteError.replace('{{error}}', err.message),
        });
      } else {
        toast.success(dict.toasts.success.candidateAdded);
      }
      onCandidateAdded();
      handleClose();
    } catch (error) {
      console.error('Error adding manual candidate:', error);
      toast.error(
        `${dict.toasts.error.general}: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <Dialog
      open={isOpen}
      onOpenChange={(open) => {
        if (!open) handleClose();
      }}
    >
      <DialogContent className="max-w-2xl">
        <DialogClose asChild>
          <button className="absolute right-4 top-4 p-1 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
            <X className="h-4 w-4" />
            <span className="sr-only">{dict.close}</span>
          </button>
        </DialogClose>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-right">
            <UserPlus className="w-6 h-6 text-primary" />
            {dict.title}
          </DialogTitle>
          <DialogDescription className="text-right">
            {dict.description}
          </DialogDescription>
        </DialogHeader>
        <form
          onSubmit={handleSubmit}
          className="space-y-6 py-4 max-h-[70vh] overflow-y-auto pr-2 pl-1"
        >
          {/* Row 1: First & Last Name */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <Label htmlFor="firstName" className="text-right block">
                {dict.fields.firstName.label}{' '}
                <span className="text-red-500">*</span>
              </Label>
              <Input
                id="firstName"
                value={firstName}
                onChange={(e) => setFirstName(e.target.value)}
                placeholder={dict.fields.firstName.placeholder}
                required
                dir="rtl"
              />
            </div>
            <div>
              <Label htmlFor="lastName" className="text-right block">
                {dict.fields.lastName.label}{' '}
                <span className="text-red-500">*</span>
              </Label>
              <Input
                id="lastName"
                value={lastName}
                onChange={(e) => setLastName(e.target.value)}
                placeholder={dict.fields.lastName.placeholder}
                required
                dir="rtl"
              />
            </div>
          </div>

          {/* Row 2: Email & Invite */}
          <div>
            <Label htmlFor="email" className="text-right block">
              {dict.fields.email.label}
            </Label>
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder={dict.fields.email.placeholder}
              dir="ltr"
            />
            <p className="text-xs text-gray-500 mt-1 text-right">
              {dict.fields.email.description}
            </p>
          </div>
          <div className="flex items-center space-x-2 rtl:space-x-reverse pt-2">
            <Checkbox
              id="sendInvite"
              checked={sendInvite}
              onCheckedChange={(checked) => setSendInvite(Boolean(checked))}
              disabled={!email || isSaving}
            />
            <Label
              htmlFor="sendInvite"
              className={`cursor-pointer transition-colors ${!email ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700'}`}
            >
              {dict.fields.sendInvite.label}
            </Label>
          </div>

          {/* Row 3: Gender, Height & BirthDate */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Column 1: Gender & Height */}
            <div className="space-y-4">
              <div>
                <Label htmlFor="gender" className="text-right block">
                  {dict.fields.gender.label}{' '}
                  <span className="text-red-500">*</span>
                </Label>
                <Select
                  value={gender}
                  onValueChange={(value) => setGender(value as Gender)}
                >
                  <SelectTrigger id="gender" dir="rtl">
                    <SelectValue placeholder={dict.fields.gender.placeholder} />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value={Gender.MALE}>
                      {dict.fields.gender.male}
                    </SelectItem>
                    <SelectItem value={Gender.FEMALE}>
                      {dict.fields.gender.female}
                    </SelectItem>
                  </SelectContent>
                </Select>
              </div>
              {/* --- ADDED: Height Input --- */}
              <div>
                <Label htmlFor="height" className="text-right block">
                  {dict.fields.height.label}
                </Label>
                <Input
                  id="height"
                  type="number"
                  min="100"
                  max="250"
                  value={height}
                  onChange={(e) => setHeight(e.target.value)}
                  placeholder={dict.fields.height.placeholder}
                  dir="rtl"
                />
              </div>
            </div>

            {/* Column 2: Birth Date */}
            <div>
              <div>
                <Label className="text-right block mb-2">
                  {dict.fields.birthDate.modeLabel}{' '}
                  <span className="text-red-500">*</span>
                </Label>
                <RadioGroup
                  dir="rtl"
                  value={birthDateInputMode}
                  onValueChange={(value: 'date' | 'age') =>
                    setBirthDateInputMode(value)
                  }
                  className="flex space-x-4 rtl:space-x-reverse mb-3"
                >
                  <div className="flex items-center space-x-2 rtl:space-x-reverse">
                    <RadioGroupItem value="date" id="r-date" />
                    <Label htmlFor="r-date" className="cursor-pointer">
                      {dict.fields.birthDate.dateMode}
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2 rtl:space-x-reverse">
                    <RadioGroupItem value="age" id="r-age" />
                    <Label htmlFor="r-age" className="cursor-pointer">
                      {dict.fields.birthDate.ageMode}
                    </Label>
                  </div>
                </RadioGroup>
              </div>
              {birthDateInputMode === 'date' ? (
                <div>
                  <Label htmlFor="birthDate" className="text-right block">
                    {dict.fields.birthDate.dateLabel}{' '}
                    <span className="text-red-500">*</span>
                  </Label>
                  <DatePicker
                    value={birthDate ? { from: birthDate } : undefined}
                    onChange={({ from }) => setBirthDate(from)}
                    isRange={false}
                    placeholder={dict.fields.birthDate.datePlaceholder}
                    className="w-full"
                  />
                </div>
              ) : (
                <div>
                  <Label htmlFor="ageInput" className="text-right block">
                    {dict.fields.birthDate.ageLabel}{' '}
                    <span className="text-red-500">*</span>
                  </Label>
                  <Input
                    id="ageInput"
                    type="number"
                    value={ageInput}
                    onChange={(e) => setAgeInput(e.target.value)}
                    placeholder={dict.fields.birthDate.agePlaceholder}
                    required={birthDateInputMode === 'age'}
                    dir="rtl"
                    min="1"
                    max="120"
                  />
                  <p className="text-xs text-gray-500 mt-1 text-right">
                    {dict.fields.birthDate.ageDescription}
                  </p>
                </div>
              )}
            </div>
          </div>

          <div>
            <Label htmlFor="manualEntryText" className="text-right block">
              {dict.fields.notes.label} <span className="text-red-500">*</span>
            </Label>
            <Textarea
              id="manualEntryText"
              value={manualEntryText}
              onChange={(e) => setManualEntryText(e.target.value)}
              placeholder={dict.fields.notes.placeholder}
              rows={6}
              required
              className="min-h-[100px]"
              dir="rtl"
            />
          </div>
          <div>
            <Label htmlFor="image-upload" className="text-right block">
              {dict.fields.photos.label.replace('{{max}}', String(MAX_IMAGES))}
            </Label>
            <div className="mt-2 flex items-center justify-center w-full">
              <label
                htmlFor="image-upload"
                className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100"
              >
                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                  <UploadCloud className="w-8 h-8 mb-2 text-gray-500" />
                  <p className="mb-2 text-sm text-gray-500 text-center">
                    {dict.fields.photos.cta}
                  </p>
                  <p className="text-xs text-gray-500">
                    {dict.fields.photos.description.replace(
                      '{{maxSize}}',
                      String(MAX_IMAGE_SIZE_MB)
                    )}
                  </p>
                </div>
                <Input
                  id="image-upload"
                  type="file"
                  multiple
                  accept="image/png, image/jpeg, image/webp"
                  className="hidden"
                  onChange={handleImageChange}
                  disabled={images.length >= MAX_IMAGES}
                />
              </label>
            </div>
            {imagePreviews.length > 0 && (
              <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {imagePreviews.map((preview, index) => (
                  <div key={index} className="relative group">
                    <Image
                      src={preview}
                      alt={dict.fields.photos.previewAlt.replace(
                        '{{index}}',
                        String(index + 1)
                      )}
                      width={100}
                      height={100}
                      className="rounded-md object-cover w-full aspect-square"
                      onLoad={() => URL.revokeObjectURL(preview)}
                    />
                    <Button
                      type="button"
                      variant="destructive"
                      size="icon"
                      className="absolute top-1 right-1 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity p-0"
                      onClick={() => removeImage(index)}
                    >
                      <Trash2 className="h-3 w-3" />
                      <span className="sr-only">
                        {dict.fields.photos.removeLabel}
                      </span>
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>
          <DialogFooter className="pt-4 sm:justify-start">
            <Button
              type="submit"
              disabled={isSaving}
              className="w-full sm:w-auto"
            >
              {isSaving ? (
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              ) : (
                <UserPlus className="w-4 h-4 mr-2" />
              )}
              {isSaving ? dict.buttons.adding : dict.buttons.add}
            </Button>
            <DialogClose asChild>
              <Button
                variant="outline"
                type="button"
                className="w-full sm:w-auto mt-2 sm:mt-0"
              >
                <X className="w-4 h-4 mr-2" />
                {dict.buttons.cancel}
              </Button>
            </DialogClose>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for AddManualCandidateDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AiMatchAnalysisDialog.tsx
--------------------------------------------------------------------------------
Content:
// File: src/app/components/matchmaker/new/dialogs/AiMatchAnalysisDialog.tsx
'use client';
import React, { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import {
  Dialog,
  DialogContent,
  DialogClose,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  X,
  Sparkles,
  CheckCircle,
  AlertTriangle,
  MessageSquare,
  Info,
  XCircle,
  Star,
  Cake,
  MapPin,
  BookMarked,
  Users,
} from 'lucide-react';
import type { Candidate } from '../types/candidates';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// --- Interfaces ---
interface AiAnalysis {
  overallScore: number;
  matchSummary: string;
  compatibilityPoints: {
    area: string;
    explanation: string;
    strength: 'HIGH' | 'MEDIUM' | 'LOW';
  }[];
  potentialChallenges: {
    area: string;
    explanation: string;
    severity: 'HIGH' | 'MEDIUM' | 'LOW';
  }[];
  suggestedConversationStarters: string[];
}
interface AiMatchAnalysisDialogProps {
  isOpen: boolean;
  onClose: () => void;
  targetCandidate: Candidate | null;
  comparisonCandidates: Candidate[];
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis'];
  locale: string; // <--- 住祝 转 砖专 
}

// --- Helper Functions ---
const getInitials = (firstName?: string, lastName?: string): string => {
  let initials = '';
  if (firstName && firstName.length > 0) initials += firstName[0];
  if (lastName && lastName.length > 0) initials += lastName[0];
  return initials.toUpperCase() || '?';
};
const calculateAge = (birthDate: Date | string): number => {
  if (!birthDate) return 0;
  const today = new Date();
  const birth = new Date(birthDate);
  if (isNaN(birth.getTime())) return 0;
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate()))
    age--;
  return age > 0 ? age : 0;
};

// --- Sub-components ---
const MiniProfileHeader: React.FC<{
  candidate: Candidate;
  score?: number;
  isTarget?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis']['miniProfile'];
}> = ({ candidate, score, isTarget = false, dict }) => {
  const mainImage = candidate.images?.find((img) => img.isMain);
  const age = calculateAge(candidate.profile.birthDate);
  const initials = getInitials(candidate.firstName, candidate.lastName);
  return (
    <div className="p-4 rounded-t-lg bg-gradient-to-b from-slate-50 to-slate-100 border-b border-slate-200 text-center relative">
      <div className="relative w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-white shadow-lg ring-2 ring-offset-2 ring-cyan-400">
        {mainImage?.url ? (
          <Image
            src={getRelativeCloudinaryPath(mainImage.url)}
            alt={`Profile picture of ${candidate.firstName}`}
            layout="fill"
            className="object-cover"
            sizes="96px"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-slate-200 to-slate-300">
            <span className="text-4xl font-medium text-slate-500">
              {initials}
            </span>
          </div>
        )}
      </div>
      {!isTarget && typeof score === 'number' && (
        <Badge className="absolute top-4 left-4 bg-gradient-to-r from-teal-400 to-cyan-500 text-white border-0 shadow-lg px-3 py-1.5 text-sm font-bold flex items-center gap-1.5">
          <Sparkles className="w-4 h-4" />
          {dict.matchBadge.replace('{{score}}', String(score))}
        </Badge>
      )}
      {isTarget && (
        <Badge className="absolute top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white border-0 shadow-lg px-3 py-1.5 text-sm font-bold flex items-center gap-1.5">
          <Star className="w-4 h-4" />
          {dict.targetBadge}
        </Badge>
      )}
      <h3 className="mt-3 text-lg font-bold text-slate-800">
        {candidate.firstName} {candidate.lastName}
      </h3>
      <div className="mt-2 flex justify-center items-center flex-wrap gap-x-3 gap-y-1 text-xs text-slate-600">
        <div className="flex items-center gap-1">
          <Cake className="w-3.5 h-3.5 text-slate-400" /> {age} {dict.years}
        </div>
        <div className="flex items-center gap-1">
          <MapPin className="w-3.5 h-3.5 text-slate-400" />{' '}
          {candidate.profile.city || dict.notSpecified}
        </div>
        <div className="flex items-center gap-1">
          <BookMarked className="w-3.5 h-3.5 text-slate-400" />{' '}
          {candidate.profile.religiousLevel || dict.notSpecified}
        </div>
      </div>
    </div>
  );
};
const AnalysisItem: React.FC<{
  icon: React.ElementType;
  iconColor: string;
  area: string;
  explanation: string;
}> = ({ icon: Icon, iconColor, area, explanation }) => (
  <div className="flex items-start gap-4 p-3 rounded-lg hover:bg-slate-50/70 transition-colors">
    <div
      className={cn(
        'mt-1 flex-shrink-0 rounded-full p-2 bg-opacity-10',
        iconColor.replace('text-', 'bg-')
      )}
    >
      <Icon className={cn('h-5 w-5', iconColor)} />
    </div>
    <div>
      <h4 className="font-semibold text-gray-800">{area}</h4>
      <p className="text-sm text-gray-600 leading-relaxed">{explanation}</p>
    </div>
  </div>
);
const ComparisonTable: React.FC<{
  target: Candidate;
  comparison: Candidate;
  dict: MatchmakerPageDictionary['candidatesManager']['aiAnalysis']['comparisonTable'];
  language: 'he' | 'en';
}> = ({ target, comparison, dict, language }) => {
  const fieldsToCompare = [
    {
      key: 'age',
      label: dict.fields.age,
      formatter: (c: Candidate) =>
        `${calculateAge(c.profile.birthDate)}${
          c.profile.birthDateIsApproximate ? ` ${dict.fields.ageApprox}` : ''
        }`,
    },
    {
      key: 'city',
      label: dict.fields.city,
      formatter: (c: Candidate) => c.profile.city || ' 爪',
    },
    {
      key: 'maritalStatus',
      label: dict.fields.maritalStatus,
      formatter: (c: Candidate) => c.profile.maritalStatus || ' 爪',
    },
    {
      key: 'religiousLevel',
      label: dict.fields.religiousLevel,
      formatter: (c: Candidate) => c.profile.religiousLevel || ' 爪',
    },
    {
      key: 'occupation',
      label: dict.fields.occupation,
      formatter: (c: Candidate) => c.profile.occupation || ' 爪',
    },
    {
      key: 'education',
      label: dict.fields.education,
      formatter: (c: Candidate) => c.profile.education || ' 爪',
    },
  ];
  return (
    <div className="overflow-x-auto border rounded-lg">
      <table
        className={cn(
          'w-full text-sm border-collapse',
          language === 'he' ? 'text-right' : 'text-left'
        )}
      >
        <thead>
          <tr className="bg-slate-50">
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200">
              {dict.criterion}
            </th>
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200 text-center">
              {target.firstName}
            </th>
            <th className="p-3 font-semibold text-slate-600 border-b border-slate-200 text-center">
              {comparison.firstName}
            </th>
          </tr>
        </thead>
        <tbody>
          {fieldsToCompare.map((field, index) => (
            <tr
              key={field.key}
              className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}
            >
              <td className="p-3 font-medium text-slate-500 border-b border-slate-200">
                {field.label}
              </td>
              <td className="p-3 text-slate-700 border-b border-slate-200 text-center">
                {field.formatter(target)}
              </td>
              <td className="p-3 text-slate-700 border-b border-slate-200 text-center">
                {field.formatter(comparison)}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};
const AnalysisSkeleton: React.FC = () => (
  <div className="space-y-6 p-4 animate-pulse">
    <div className="p-4 bg-gray-100 rounded-lg">
      <div className="h-20 bg-gray-200 rounded-md"></div>
    </div>
    <div className="space-y-4">
      <div className="h-5 bg-gray-200 rounded-md w-1/3"></div>
      <div className="flex gap-4">
        <div className="rounded-full bg-gray-200 h-10 w-10"></div>
        <div className="flex-1 space-y-2 py-1">
          <div className="h-4 bg-gray-200 rounded w-full"></div>
          <div className="h-3 bg-gray-300 rounded w-5/6"></div>
        </div>
      </div>
      <div className="flex gap-4">
        <div className="rounded-full bg-gray-200 h-10 w-10"></div>
        <div className="flex-1 space-y-2 py-1">
          <div className="h-4 bg-gray-200 rounded w-full"></div>
          <div className="h-3 bg-gray-300 rounded w-4/6"></div>
        </div>
      </div>
    </div>
  </div>
);
const DialogBody: React.FC<AiMatchAnalysisDialogProps> = ({
  isOpen,
  locale,
  targetCandidate,
  comparisonCandidates,
  dict,
}) => {
  const [activeComparisonId, setActiveComparisonId] = useState<string | null>(
    null
  );
  const [analyses, setAnalyses] = useState<
    Record<string, AiAnalysis | 'error' | 'loading'>
  >({});
  const [language, setLanguage] = useState<'he' | 'en'>(
    locale === 'he' ? 'he' : 'en'
  );
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  const activeComparisonCandidate = useMemo(
    () => comparisonCandidates.find((c) => c.id === activeComparisonId),
    [activeComparisonId, comparisonCandidates]
  );
  const activeAnalysis = useMemo(
    () => (activeComparisonId ? analyses[activeComparisonId] || null : null),
    [activeComparisonId, analyses]
  );
  useEffect(() => {
    if (
      isOpen &&
      comparisonCandidates.length > 0 &&
      !comparisonCandidates.some((c) => c.id === activeComparisonId)
    ) {
      setActiveComparisonId(comparisonCandidates[0].id);
    }
  }, [isOpen, comparisonCandidates, activeComparisonId]);
  useEffect(() => {
    if (
      isOpen &&
      targetCandidate &&
      activeComparisonId &&
      analyses[activeComparisonId] === undefined
    ) {
      const fetchAnalysis = async () => {
        setAnalyses((prev) => ({ ...prev, [activeComparisonId]: 'loading' }));
        try {
          const response = await fetch('/api/ai/generate-rationale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId1: targetCandidate.id,
              userId2: activeComparisonId,
              language: language,
            }),
          });
          const data = await response.json();
          if (response.ok && data.success) {
            setAnalyses((prev) => ({
              ...prev,
              [activeComparisonId]: data.analysis,
            }));
          } else {
            throw new Error(data.error || 'Failed to fetch analysis');
          }
        } catch (e) {
          console.error(`Failed to get analysis for ${activeComparisonId}:`, e);
          setAnalyses((prev) => ({ ...prev, [activeComparisonId]: 'error' }));
        }
      };
      fetchAnalysis();
    }
  }, [isOpen, targetCandidate, activeComparisonId, language, analyses]);

  if (!targetCandidate) return null;
  return (
    <DialogContent
      className="max-w-6xl w-full h-[95vh] flex flex-col p-0 overflow-hidden"
      dir={language === 'he' ? 'rtl' : 'ltr'}
    >
      <DialogClose
        asChild
        className={cn(
          'absolute top-3 z-50',
          language === 'he' ? 'left-3' : 'right-3'
        )}
      >
        <Button variant="ghost" size="icon" className="rounded-full">
          <X className="h-5 w-5" />
        </Button>
      </DialogClose>
      <div className="flex-1 flex flex-col md:flex-row min-h-0">
        {isMobile ? (
          <div className="p-4 border-b md:hidden">
            <Select
              value={activeComparisonId || ''}
              onValueChange={setActiveComparisonId}
            >
              <SelectTrigger className="w-full">
                <SelectValue
                  placeholder={dict.header.languageSelectPlaceholder}
                />
              </SelectTrigger>
              <SelectContent>
                {comparisonCandidates.map((c) => (
                  <SelectItem key={c.id} value={c.id}>
                    {c.firstName} {c.lastName}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        ) : (
          <aside
            className={cn(
              'w-1/4 bg-slate-50/50 flex flex-col flex-shrink-0',
              language === 'he' ? 'border-l' : 'border-r'
            )}
          >
            <h3 className="p-3 text-sm font-semibold text-slate-600 border-b">
              {dict.sidebar.title.replace(
                '{{count}}',
                String(comparisonCandidates.length)
              )}
            </h3>
            <ScrollArea className="flex-1">
              {comparisonCandidates.map((candidate) => {
                const mainImageUrl = candidate.images?.find(
                  (img) => img.isMain
                )?.url;
                return (
                  <button
                    key={candidate.id}
                    onClick={() => setActiveComparisonId(candidate.id)}
                    className={cn(
                      'w-full p-3 flex items-center gap-3 border-b border-slate-200/60 hover:bg-slate-100 transition-colors',
                      language === 'he' ? 'text-right' : 'text-left',
                      activeComparisonId === candidate.id &&
                        'bg-cyan-50 border-cyan-500 font-semibold',
                      activeComparisonId === candidate.id &&
                        (language === 'he' ? 'border-r-4' : 'border-l-4')
                    )}
                  >
                    <div className="relative w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-200">
                      {mainImageUrl ? (
                        <Image
                          src={getRelativeCloudinaryPath(mainImageUrl)}
                          alt={candidate.firstName}
                          layout="fill"
                          className="object-cover"
                          sizes="40px"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center">
                          <span className="text-sm font-bold text-gray-500">
                            {getInitials(
                              candidate.firstName,
                              candidate.lastName
                            )}
                          </span>
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="truncate text-sm text-slate-800">
                        {candidate.firstName} {candidate.lastName}
                      </p>
                      <p className="text-xs text-slate-500">
                        {calculateAge(candidate.profile.birthDate)} |{' '}
                        {candidate.profile.city}
                      </p>
                    </div>
                    {analyses[candidate.id] &&
                      analyses[candidate.id] !== 'error' &&
                      analyses[candidate.id] !== 'loading' && (
                        <Badge
                          variant="secondary"
                          className="bg-teal-100 text-teal-800"
                        >
                          {(analyses[candidate.id] as AiAnalysis).overallScore}%
                        </Badge>
                      )}
                  </button>
                );
              })}
            </ScrollArea>
          </aside>
        )}
        <main className="flex-1 flex flex-col min-h-0 bg-white">
          {!activeComparisonCandidate ? (
            <div className="flex-1 flex flex-col items-center justify-center text-center p-6 text-gray-500">
              <Users className="w-16 h-16 text-gray-300 mb-4" />
              <h3 className="text-lg font-semibold">
                {dict.main.selectCandidate.title}
              </h3>
              <p className="max-w-xs">
                {dict.main.selectCandidate.description}
              </p>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 flex-shrink-0">
                <MiniProfileHeader
                  candidate={targetCandidate}
                  isTarget
                  dict={dict.miniProfile}
                />
                <MiniProfileHeader
                  candidate={activeComparisonCandidate}
                  score={(activeAnalysis as AiAnalysis)?.overallScore}
                  dict={dict.miniProfile}
                />
              </div>
              <Tabs
                defaultValue="summary"
                className="flex-1 flex flex-col min-h-0"
              >
                <TabsList className="mx-4 mt-4 bg-slate-100 p-1 rounded-lg">
                  <TabsTrigger value="summary">{dict.tabs.summary}</TabsTrigger>
                  <TabsTrigger value="challenges">
                    {dict.tabs.challenges}
                  </TabsTrigger>
                  <TabsTrigger value="comparison">
                    {dict.tabs.comparison}
                  </TabsTrigger>
                  <TabsTrigger value="conversation">
                    {dict.tabs.conversation}
                  </TabsTrigger>
                </TabsList>
                <ScrollArea className="flex-1">
                  <AnimatePresence mode="wait">
                    <motion.div
                      key={activeComparisonId}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: -10 }}
                      transition={{ duration: 0.2 }}
                      className="p-4 md:p-6"
                    >
                      {activeAnalysis === 'loading' && <AnalysisSkeleton />}
                      {activeAnalysis === 'error' && (
                        <div className="text-center py-10">
                          <XCircle className="w-12 h-12 text-red-400 mx-auto mb-4" />
                          <h3 className="font-semibold text-xl text-red-600">
                            {dict.main.error.title}
                          </h3>
                          <p className="text-gray-500 mt-2">
                            {dict.main.error.description}
                          </p>
                        </div>
                      )}
                      {activeAnalysis &&
                        activeAnalysis !== 'error' &&
                        activeAnalysis !== 'loading' && (
                          <>
                            <TabsContent
                              value="summary"
                              className="space-y-6 mt-0"
                            >
                              <div className="p-4 bg-slate-50/70 rounded-lg border border-slate-200">
                                <h3 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                  <Info className="w-5 h-5 text-blue-500" />
                                  {dict.analysis.summaryTitle}
                                </h3>
                                <p className="text-sm text-gray-600 leading-relaxed">
                                  {(activeAnalysis as AiAnalysis).matchSummary}
                                </p>
                              </div>
                              <div>
                                <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                  <CheckCircle className="w-5 h-5 text-green-500" />
                                  {dict.analysis.strengthsTitle}
                                </h3>
                                <div className="space-y-4">
                                  {(
                                    activeAnalysis as AiAnalysis
                                  ).compatibilityPoints.map((point) => (
                                    <AnalysisItem
                                      key={point.area}
                                      icon={CheckCircle}
                                      iconColor="text-green-500"
                                      {...point}
                                    />
                                  ))}
                                </div>
                              </div>
                            </TabsContent>
                            <TabsContent
                              value="challenges"
                              className="space-y-6 mt-0"
                            >
                              <div>
                                <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                  <AlertTriangle className="w-5 h-5 text-amber-500" />
                                  {dict.analysis.challengesTitle}
                                </h3>
                                <div className="space-y-4">
                                  {(
                                    activeAnalysis as AiAnalysis
                                  ).potentialChallenges.map((challenge) => (
                                    <AnalysisItem
                                      key={challenge.area}
                                      icon={AlertTriangle}
                                      iconColor="text-amber-500"
                                      {...challenge}
                                    />
                                  ))}
                                </div>
                              </div>
                            </TabsContent>
                            <TabsContent value="comparison" className="mt-0">
                              <ComparisonTable
                                target={targetCandidate}
                                comparison={activeComparisonCandidate}
                                dict={dict.comparisonTable}
                                language={language}
                              />
                            </TabsContent>
                            <TabsContent
                              value="conversation"
                              className="space-y-4 mt-0"
                            >
                              <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <MessageSquare className="w-5 h-5 text-indigo-500" />
                                {dict.analysis.conversationStartersTitle}
                              </h3>
                              <ul className="space-y-3 list-inside">
                                {(
                                  activeAnalysis as AiAnalysis
                                ).suggestedConversationStarters.map(
                                  (starter, index) => (
                                    <li
                                      key={index}
                                      className="flex items-start gap-2 p-2 rounded-md hover:bg-indigo-50/50"
                                    >
                                      <MessageSquare className="w-4 h-4 text-indigo-400 mt-1 flex-shrink-0" />
                                      <span className="text-sm text-gray-700">
                                        {starter}
                                      </span>
                                    </li>
                                  )
                                )}
                              </ul>
                            </TabsContent>
                          </>
                        )}
                    </motion.div>
                  </AnimatePresence>
                </ScrollArea>
              </Tabs>
            </>
          )}
        </main>
      </div>
    </DialogContent>
  );
};
export const AiMatchAnalysisDialog = (props: AiMatchAnalysisDialogProps) => {
  const { isOpen, onClose } = props;
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      {isOpen && <DialogBody {...props} />}
    </Dialog>
  );
};
--- End of Content for AiMatchAnalysisDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\AiMatchmakerProfileAdvisorDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/dialogs/AiMatchmakerProfileAdvisorDialog.tsx
'use client';

import React, { useState, useEffect, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogClose,
} from '@/components/ui/dialog';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, AlertTriangle, X, Bot, RefreshCw } from 'lucide-react';
import { toast } from 'sonner';
import type { Candidate } from '../types/candidates';
// 砖  1: 砖砖 驻住 砖 拽驻 砖
import type { AiProfileSummaryResult } from '@/lib/services/aiService'; 
import ProfileSummaryDisplay from '../ProfileSummaryDisplay'; //  砖转  拽抓 砖爪专转
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import { Button } from '@/components/ui/button';

interface AiMatchmakerProfileAdvisorDialogProps {
  candidate: Candidate | null;
  isOpen: boolean;
  onClose: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['aiProfileAdvisor'];
  locale: string;
}

export const AiMatchmakerProfileAdvisorDialog: React.FC<
  AiMatchmakerProfileAdvisorDialogProps
> = ({ candidate, isOpen, onClose, dict, locale }) => {
  // 砖 2: 注 -State 驻住 砖
  const [analysis, setAnalysis] = useState<AiProfileSummaryResult | null>(
    null
  );
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const getAnalysis = useCallback(
    async (forceRefresh = false) => {
      if (!candidate || isLoading) return;

      if (analysis && !forceRefresh) return;

      setIsLoading(true);
      setError(null);
      if (!forceRefresh) {
        setAnalysis(null);
      }

      try {
        const response = await fetch('/api/ai/matchmaker/analyze-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          //  砖 forceRefresh  砖转砖 拽砖
          body: JSON.stringify({ 
            userId: candidate.id,
            forceRefresh: forceRefresh
          }),
        });
        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Error getting profile analysis.');
        }
        setAnalysis(result.data);
      } catch (err) {
        const errorMessage =
          err instanceof Error ? err.message : 'An unexpected error occurred.';
        setError(errorMessage);
        toast.error(dict.toast.errorTitle, {
          description: dict.toast.errorDescription.replace(
            '{{error}}',
            errorMessage
          ),
        });
      } finally {
        setIsLoading(false);
      }
    },
    [candidate, isLoading, analysis, dict.toast]
  );

  useEffect(() => {
    if (isOpen) {
      getAnalysis();
    } else {
      setAnalysis(null);
      setError(null);
      setIsLoading(false);
    }
  }, [isOpen, getAnalysis]);

  const handleOpenChange = (open: boolean) => {
    if (!open) {
      onClose();
    }
  };

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // 爪专转  -拽 拽驻 砖 转  拽 ( 砖转专爪 住祝 驻转转 砖 拽砖专)
  // 专注 砖转砖 注专 转 拽砖专 拽  转
  const summaryDisplayDict = {
    personalityTitle: dict.analysisResult.summary.personalityTitle,
    personalityDescription: "转 砖转 住住 AI", // 驻砖专 住祝 
    lookingForTitle: dict.analysisResult.summary.lookingForTitle,
    lookingForDescription: "住 注驻转 专砖转", // 驻砖专 住祝 
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogContent
        className="max-w-4xl w-[95vw] h-[90vh] flex flex-col p-0"
        dir={direction}
      >
        <DialogHeader className="p-4 border-b">
          <div className="flex justify-between items-center">
            <DialogTitle className="flex items-center gap-2 text-xl">
              <Bot className="w-6 h-6 text-indigo-500" />
              <span>
                {dict.dialogTitle} {candidate?.firstName} {candidate?.lastName}
              </span>
            </DialogTitle>
            <DialogClose asChild>
              <button className="rounded-full p-1.5 text-gray-500 hover:text-gray-800 transition-colors">
                <X className="h-5 w-5" />
              </button>
            </DialogClose>
          </div>
          <DialogDescription>{dict.dialogDescription}</DialogDescription>
        </DialogHeader>

        <div className="flex-grow overflow-y-auto p-4 md:p-6 bg-slate-50/50">
          {isLoading && (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <Loader2 className="w-12 h-12 text-indigo-500 animate-spin mb-4" />
              <p className="text-lg font-semibold text-gray-700">
                {dict.loadingTitle}
              </p>
              <p className="text-sm text-gray-500 mt-2">
                {dict.loadingDescription}
              </p>
            </div>
          )}
          {error && !isLoading && (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <Alert variant="destructive" className="max-w-md">
                <AlertTriangle className="h-5 w-5" />
                <AlertTitle>{dict.errorAlertTitle}</AlertTitle>
                <AlertDescription>
                  <p>{dict.errorAlertDescription}</p>
                  <p className="text-xs mt-2">{error}</p>
                </AlertDescription>
              </Alert>
              <Button
                onClick={() => getAnalysis(true)}
                variant="outline"
                className="mt-4"
              >
                <RefreshCw className="w-4 h-4 ml-2" />
                {dict.retryButton || '住 砖'}
              </Button>
            </div>
          )}
          
          {/* 砖 3: 专专 拽驻 砖 */}
          {analysis && !isLoading && (
            <div className="space-y-6">
              <ProfileSummaryDisplay
                summary={analysis}
                dict={summaryDisplayDict}
                locale={locale}
              />
               <div className="flex justify-center pt-4">
                 <Button
                    onClick={() => getAnalysis(true)}
                    variant="ghost"
                    size="sm"
                    className="text-slate-500 hover:text-slate-800"
                  >
                    <RefreshCw className="w-3 h-3 ml-2" />
                    专注 转 (爪专 砖)
                  </Button>
               </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for AiMatchmakerProfileAdvisorDialog.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\dialogs\ProfileFeedbackDialog.tsx
--------------------------------------------------------------------------------
Content:
// src/components/matchmaker/new/dialogs/ProfileFeedbackDialog.tsx
'use client';

import React, { useState, useEffect } from 'react';
import dynamic from 'next/dynamic'; // 1. Import dynamic
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { Loader2, Send, MailPlus, Eye, Edit } from 'lucide-react';

// 2. Import CSS normally
import 'react-quill-new/dist/quill.snow.css';

import type { Candidate } from '../types/candidates';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

// 3. Dynamically import ReactQuill with SSR disabled
const ReactQuill = dynamic(() => import('react-quill-new'), {
  ssr: false,
  loading: () => <div className="h-40 bg-gray-50 animate-pulse rounded-md" />, // Optional loading state
});

interface ProfileFeedbackDialogProps {
  isOpen: boolean;
  onClose: () => void;
  candidate: Candidate | null;
  locale: string;
  dict: MatchmakerPageDictionary['candidatesManager']['profileFeedbackDialog'];
}

export const ProfileFeedbackDialog: React.FC<ProfileFeedbackDialogProps> = ({
  isOpen,
  onClose,
  candidate,
  locale,
  dict,
}) => {
  const [htmlContent, setHtmlContent] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [viewMode, setViewMode] = useState<'preview' | 'edit'>('preview');

  const isRtl = locale === 'he';
  const direction = isRtl ? 'rtl' : 'ltr';

  useEffect(() => {
    const prepareEmail = async () => {
      if (isOpen && candidate) {
        setIsLoading(true);
        setHtmlContent('');
        setViewMode('preview'); // 转 爪 转爪 拽
        try {
          const response = await fetch(
            '/api/ai/matchmaker/prepare-feedback-email',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: candidate.id,
                locale,
                isAutomated: false,
              }),
            }
          );
          const data = await response.json();
          if (data.success) {
            setHtmlContent(data.htmlContent);
          } else {
            throw new Error(data.error || 'Failed to prepare email content');
          }
        } catch (error) {
          toast.error(dict.toasts.loadError);
          console.error(error);
          onClose();
        } finally {
          setIsLoading(false);
        }
      }
    };
    prepareEmail();
  }, [isOpen, candidate, locale, dict, onClose]);

  const handleSendEmail = async () => {
    if (!candidate) return;
    setIsSending(true);
    try {
      const response = await fetch('/api/ai/matchmaker/send-feedback-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userEmail: candidate.email,
          subject: dict.emailSubject.replace('{{name}}', candidate.firstName),
          htmlContent: htmlContent,
        }),
      });
      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error || 'Failed to send email');
      }
      toast.success(dict.toasts.sendSuccess);
      onClose();
    } catch (error) {
      toast.error(dict.toasts.sendError);
      console.error(error);
    } finally {
      setIsSending(false);
    }
  };

  // ReactQuill modules 注 转 -RTL
  const quillModules = {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ color: [] }, { background: [] }],
      [{ list: 'ordered' }, { list: 'bullet' }],
      [{ align: [] }],
      ['link'],
      ['clean'],
    ],
  };

  const quillFormats = [
    'header',
    'bold',
    'italic',
    'underline',
    'color',
    'background',
    'list',
    'bullet',
    'align',
    'link',
  ];

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent
        className="max-w-6xl w-[95vw] h-[90vh] flex flex-col p-0"
        dir={direction}
      >
        <DialogHeader className="p-6 border-b">
          <div className="flex justify-between items-center">
            <DialogTitle className="flex items-center gap-2">
              <MailPlus className="w-5 h-5" />
              {dict.title.replace(
                '{{name}}',
                `${candidate?.firstName} ${candidate?.lastName}`
              )}
            </DialogTitle>
            <div className="flex gap-2">
              <Button
                variant={viewMode === 'preview' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setViewMode('preview')}
                disabled={isLoading}
              >
                <Eye className="w-4 h-4 mr-1" />
                转爪 拽
              </Button>
              <Button
                variant={viewMode === 'edit' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setViewMode('edit')}
                disabled={isLoading}
              >
                <Edit className="w-4 h-4 mr-1" />
                注专
              </Button>
            </div>
          </div>
          <DialogDescription>
            {viewMode === 'preview'
              ? '转爪 拽 砖  驻 砖转拽 爪 砖转砖'
              : dict.editPrompt}
          </DialogDescription>
        </DialogHeader>

        <div className="flex-grow overflow-y-auto" dir={direction}>
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <Loader2 className="w-8 h-8 animate-spin" />
              <p className="ml-4">{dict.preparingEmail}</p>
            </div>
          ) : viewMode === 'preview' ? (
            // 转爪 拽 - HTML  注  
            <div
              className="p-4"
              dir={direction}
              style={{
                direction: direction,
                textAlign: isRtl ? 'right' : 'left',
              }}
            >
              <div
                dangerouslySetInnerHTML={{ __html: htmlContent }}
                style={{
                  fontFamily: isRtl ? 'Arial, sans-serif' : 'inherit',
                  direction: direction,
                  textAlign: isRtl ? 'right' : 'left',
                }}
              />
            </div>
          ) : (
            // 爪 注专
            <div className="p-1" dir={direction}>
              <style>
                {`
                  .ql-editor {
                    direction: ${direction} !important;
                    text-align: ${isRtl ? 'right' : 'left'} !important;
                    font-family: ${isRtl ? 'Arial, sans-serif' : 'inherit'} !important;
                  }
                  .ql-toolbar {
                    direction: ${direction} !important;
                  }
                  ${
                    isRtl
                      ? `
                    .ql-toolbar .ql-formats {
                      margin-left: 15px;
                      margin-right: 0;
                    }
                    .ql-toolbar .ql-formats:first-child {
                      margin-left: 0;
                    }
                  `
                      : ''
                  }
                `}
              </style>
              <ReactQuill
                theme="snow"
                value={htmlContent}
                onChange={setHtmlContent}
                modules={quillModules}
                formats={quillFormats}
                style={{
                  height: 'calc(100vh - 200px)',
                  direction: direction,
                }}
                placeholder={
                  isRtl
                    ? '拽  转 转 ...'
                    : 'Type your email content here...'
                }
              />
            </div>
          )}
        </div>

        <DialogFooter className="p-4 border-t bg-gray-50" dir={direction}>
          <div className={`flex gap-2 ${isRtl ? 'flex-row-reverse' : ''}`}>
            <Button variant="outline" onClick={onClose} disabled={isSending}>
              {dict.buttons.cancel}
            </Button>
            <Button onClick={handleSendEmail} disabled={isLoading || isSending}>
              {isSending ? (
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              ) : (
                <Send className="w-4 h-4 mr-2" />
              )}
              {isSending ? dict.buttons.sending : dict.buttons.send}
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
--- End of Content for ProfileFeedbackDialog.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\filterUtils
--------------------------------------------------------------------------------
[Content skipped: File extension '' is not in the allowed code list.]

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useCandidates.ts
--------------------------------------------------------------------------------
Content:
import { useState, useEffect, useMemo, useCallback } from 'react';
import Papa from 'papaparse';
import type { Candidate, CandidatesFilter } from '../types/candidates';
import type { CandidateProfile } from '../types/candidates';
import { Dispatch, SetStateAction } from 'react';

export interface UseCandidatesReturn {
  loading: boolean;
  error: string | null;
  candidates: Candidate[];
  maleCandidates: Candidate[];
  femaleCandidates: Candidate[];
  filteredCandidates: Candidate[];
  filters: CandidatesFilter;
  setFilters: Dispatch<SetStateAction<CandidatesFilter>>;
  refresh: () => Promise<void>;
  totalCount: number;
  filteredCount: number;
  maleCount: number;
  femaleCount: number;
  searchResults: {
    term: string;
    count: number;
    male: number;
    female: number;
  } | null;
  exportCandidates: (candidates: Candidate[], filters: CandidatesFilter) => Promise<void>;
  updateCandidate: (id: string, updates: Partial<CandidateProfile>) => Promise<void>;
  sorting: {
    field: string;
    direction: 'asc' | 'desc';
  };
  setSorting: (field: string, direction: 'asc' | 'desc') => void;
  searchSuggestions: (term: string) => Promise<Candidate[]>;
}

export const useCandidates = (initialFilters: CandidatesFilter = {}): UseCandidatesReturn => {
  // Base states
  const [candidates, setCandidates] = useState<Candidate[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [filters, setFilters] = useState<CandidatesFilter>(initialFilters);
  const [searchResults, setSearchResults] = useState<{
    term: string;
    count: number;
    male: number;
    female: number;
  } | null>(null);
  const [sorting, setSortingState] = useState<{
    field: string;
    direction: 'asc' | 'desc';
  }>({
    field: 'lastActive',
    direction: 'desc',
  });

  // Helper function to calculate age
  const calculateAge = useCallback((birthDate: Date): number => {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  }, []);

  // Fetch candidates data
  const fetchCandidates = async () => {
    try {
      setLoading(true);
      setError(null);
      
      const response = await fetch('/api/matchmaker/candidates');
      if (!response.ok) {
        throw new Error(await response.text());
      }
      
      const data = await response.json();
     
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to load candidates');
      }
  
      setCandidates(data.clients);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An unexpected error occurred');
      console.error('Error fetching candidates:', err);
    } finally {
      setLoading(false);
    }
  };

  // Set sorting field and direction
  const setSorting = useCallback((field: string, direction: 'asc' | 'desc') => {
    setSortingState({ field, direction });
  }, []);

  // Search suggestions based on a term
  const searchSuggestions = useCallback(async (term: string): Promise<Candidate[]> => {
    if (!term || term.length < 2) return [];
    
    // Local search implementation for quick response
    const searchTerm = term.toLowerCase();
    return candidates.filter(candidate => {
      const searchableText = `
        ${candidate.firstName} 
        ${candidate.lastName} 
        ${candidate.profile.occupation || ''} 
        ${candidate.profile.city || ''}
        ${candidate.profile.religiousLevel || ''}
      `.toLowerCase();
      
      return searchableText.includes(searchTerm);
    }).slice(0, 10);
    
    // Alternatively, you can implement an API call for server-side search
    // if the dataset is very large
  }, [candidates]);

  const sortCandidates = useCallback((candidatesList: Candidate[], field: string, direction: 'asc' | 'desc') => {
    return [...candidatesList].sort((a, b) => {
      let valueA, valueB;
      
      switch (field) {
        case 'name':
          valueA = `${a.firstName} ${a.lastName}`.toLowerCase();
          valueB = `${b.firstName} ${b.lastName}`.toLowerCase();
          break;
        case 'age':
          valueA = calculateAge(a.profile.birthDate);
          valueB = calculateAge(b.profile.birthDate);
          break;
        case 'city':
          valueA = (a.profile.city || '').toLowerCase();
          valueB = (b.profile.city || '').toLowerCase();
          break;
        case 'religiousLevel':
          valueA = (a.profile.religiousLevel || '').toLowerCase();
          valueB = (b.profile.religiousLevel || '').toLowerCase();
          break;
        case 'lastActive':
          valueA = a.profile.lastActive ? new Date(a.profile.lastActive).getTime() : 0;
          valueB = b.profile.lastActive ? new Date(b.profile.lastActive).getTime() : 0;
          break;
        case 'registrationDate':
          valueA = new Date(a.createdAt).getTime();
          valueB = new Date(b.createdAt).getTime();
          break;
        case 'height':
          valueA = a.profile.height || 0;
          valueB = b.profile.height || 0;
          break;
        default:
          valueA = 0;
          valueB = 0;
      }
      
      if (valueA < valueB) return direction === 'asc' ? -1 : 1;
      if (valueA > valueB) return direction === 'asc' ? 1 : -1;
      return 0;
    });
  }, [calculateAge]);
  
  // 驻拽爪 拽  注 注 拽专专 驻砖
  const checkSearchMatch = useCallback((candidate: Candidate, searchTerm: string): boolean => {
    if (!searchTerm) return true;
    
    // 专 驻砖
    const normalizedTerm = searchTerm.toLowerCase().trim();
    if (!normalizedTerm) return true;
    
    // 拽转 转 砖转 砖
    const fullName = `${candidate.firstName} ${candidate.lastName}`.toLowerCase();
    const city = (candidate.profile.city || '').toLowerCase();
    const occupation = (candidate.profile.occupation || '').toLowerCase();
    const religiousLevel = (candidate.profile.religiousLevel || '').toLowerCase();
    
    return (
      fullName.includes(normalizedTerm) || 
      city.includes(normalizedTerm) || 
      occupation.includes(normalizedTerm) || 
      religiousLevel.includes(normalizedTerm)
    );
  }, []);

  // 拽抓 useCandidates.ts - 注 转 拽 砖 filteredCandidates
  const filteredCandidates = useMemo(() => {
    console.log("Filtering candidates with filters:", filters);
    
    //  住 驻专 驻注, 砖转砖 驻专    专
    const currentFilters = filters.separateFiltering 
      ? { ...filters, gender: undefined }
      : filters;

    let results = candidates.filter(candidate => {
      // 住 驻 专 专拽  住 驻专 
      if (!filters.separateFiltering && currentFilters.gender && candidate.profile.gender !== currentFilters.gender) {
        return false;
      }
      if (currentFilters.source && candidate.source !== currentFilters.source) {
    return false;
}
      // 拽转  转转
      if (currentFilters.ageRange) {
        try {
          const age = calculateAge(candidate.profile.birthDate);
          if (age < currentFilters.ageRange.min || age > currentFilters.ageRange.max) {
            return false;
          }
        } catch (err) {
          console.error("Error calculating age for candidate:", candidate.id, err);
        }
      }
      
      // 住 住住 砖转砖
      if (filters.userStatus && candidate.status !== filters.userStatus) {
        return false;
      }
   // 住 住住 砖转砖
      if (filters.userStatus && candidate.status !== filters.userStatus) {
        return false;
      }
      // 住 住住 转 -  专  砖 驻住
      if (filters.availabilityStatus && 
          candidate.profile.availabilityStatus !== filters.availabilityStatus) {
        return false;
      }
      
      // 拽转 
      if (filters.heightRange && candidate.profile.height) {
        if (
          candidate.profile.height < filters.heightRange.min || 
          candidate.profile.height > filters.heightRange.max
        ) {
          return false;
        }
      }

      // 拽转 专转 转转
    if (filters.religiousLevel?.length && candidate.profile.religiousLevel) {
        if (!filters.religiousLevel.includes(candidate.profile.religiousLevel)) {
          return false;
        }
      }

      // 拽转 注专
      if (filters.cities?.length && candidate.profile.city) {
        if (!filters.cities.includes(candidate.profile.city)) {
          return false;
        }
      }

      // 拽转 转 注住拽
      if (filters.occupations?.length && candidate.profile.occupation) {
        if (!filters.occupations.includes(candidate.profile.occupation)) {
          return false;
        }
      }

      // 拽转 砖
      if (filters.educationLevel && candidate.profile.education !== filters.educationLevel) {
        return false;
      }

      // 拽转 爪 砖驻转
      if (filters.maritalStatus && candidate.profile.maritalStatus !== filters.maritalStatus) {
        return false;
      }

      // 拽转 转
      if (filters.isVerified !== undefined && candidate.isVerified !== filters.isVerified) {
        return false;
      }

      // 拽转 爪转
   
      // 拽转 驻注转 专
      if (filters.lastActiveDays && candidate.profile.lastActive) {
        const lastActive = new Date(candidate.profile.lastActive);
        const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
        if (daysDiff > filters.lastActiveDays) {
          return false;
        }
      }

      // 拽转 砖转 驻专驻
      if (filters.isProfileComplete !== undefined && 
          candidate.isProfileComplete !== filters.isProfileComplete) {
        return false;
      }

      // 拽转 驻砖  - 专拽   住 驻专
      if (!filters.separateFiltering && currentFilters.searchQuery) {
        return checkSearchMatch(candidate, currentFilters.searchQuery);
      }

      return true;
    });

    //  转爪转
    if (sorting.field && sorting.direction) {
      results = sortCandidates(results, sorting.field, sorting.direction);
    }

    return results;
  }, [candidates, filters, calculateAge, sorting.field, sorting.direction, sortCandidates, checkSearchMatch]);

  // 拽 注 注转 注 转 驻砖 驻专
  const maleCandidates = useMemo(() => {
    // 住 驻专, 拽  转 驻砖 住驻爪驻 专
      return filteredCandidates
        .filter(c => c.profile.gender === 'MALE')
        .filter(candidate => {
          // 拽转 驻专 住驻爪驻 专
          if (filters.maleFilters) {
            // 拽转 
            if (filters.maleFilters.ageRange) {
              const age = calculateAge(candidate.profile.birthDate);
              if (age < filters.maleFilters.ageRange.min || age > filters.maleFilters.ageRange.max) {
                return false;
              }
            }
            
            // 拽转 
            if (filters.maleFilters.heightRange && candidate.profile.height) {
              if (
                candidate.profile.height < filters.maleFilters.heightRange.min || 
                candidate.profile.height > filters.maleFilters.heightRange.max
              ) {
                return false;
              }
            }

            // 拽转 专转 转转
        if (filters.maleFilters.religiousLevel?.length && candidate.profile.religiousLevel) {
              if (!filters.maleFilters.religiousLevel.includes(candidate.profile.religiousLevel)) {
                return false;
              }
            }

            // 拽转 注专
            if (filters.maleFilters.cities?.length && candidate.profile.city) {
              if (!filters.maleFilters.cities.includes(candidate.profile.city)) {
                return false;
              }
            }

            // 拽转 转 注住拽
            if (filters.maleFilters.occupations?.length && candidate.profile.occupation) {
              if (!filters.maleFilters.occupations.includes(candidate.profile.occupation)) {
                return false;
              }
            }

            // 拽转 砖
            if (filters.maleFilters.educationLevel && candidate.profile.education !== filters.maleFilters.educationLevel) {
              return false;
            }

            // 拽转 爪 砖驻转
            if (filters.maleFilters.maritalStatus && candidate.profile.maritalStatus !== filters.maleFilters.maritalStatus) {
              return false;
            }

            // 拽转 转
            if (filters.maleFilters.isVerified !== undefined && candidate.isVerified !== filters.maleFilters.isVerified) {
              return false;
            }

    

            // 拽转 驻注转 专
            if (filters.maleFilters.lastActiveDays && candidate.profile.lastActive) {
              const lastActive = new Date(candidate.profile.lastActive);
              const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff > filters.maleFilters.lastActiveDays) {
                return false;
              }
            }

            // 拽转 砖转 驻专驻
            if (filters.maleFilters.isProfileComplete !== undefined && 
                candidate.isProfileComplete !== filters.maleFilters.isProfileComplete) {
              return false;
            }

            // 拽转 驻砖 住驻爪驻 驻专 砖 专
            if (filters.maleFilters.searchQuery) {
              return checkSearchMatch(candidate, filters.maleFilters.searchQuery);
            }
          }
          
          // 拽转 驻砖 驻专 专
          if (filters.maleSearchQuery) {
            return checkSearchMatch(candidate, filters.maleSearchQuery);
          }
          
          return true;
        });
    
      }, [filteredCandidates, filters.maleFilters, filters.maleSearchQuery, calculateAge, checkSearchMatch]);
  const femaleCandidates = useMemo(() => {
    // 住 驻专, 拽  转 驻砖 住驻爪驻 砖

      return filteredCandidates
        .filter(c => c.profile.gender === 'FEMALE')
        .filter(candidate => {
          // 拽转 驻专 住驻爪驻 砖
          if (filters.femaleFilters) {
            // 拽转 
            if (filters.femaleFilters.ageRange) {
              const age = calculateAge(candidate.profile.birthDate);
              if (age < filters.femaleFilters.ageRange.min || age > filters.femaleFilters.ageRange.max) {
                return false;
              }
            }
            
            // 拽转 
            if (filters.femaleFilters.heightRange && candidate.profile.height) {
              if (
                candidate.profile.height < filters.femaleFilters.heightRange.min || 
                candidate.profile.height > filters.femaleFilters.heightRange.max
              ) {
                return false;
              }
            }

            // 拽转 专转 转转
     if (filters.femaleFilters.religiousLevel?.length && candidate.profile.religiousLevel) {
              if (!filters.femaleFilters.religiousLevel.includes(candidate.profile.religiousLevel)) {
                return false;
              }
            }

            // 拽转 注专
            if (filters.femaleFilters.cities?.length && candidate.profile.city) {
              if (!filters.femaleFilters.cities.includes(candidate.profile.city)) {
                return false;
              }
            }

            // 拽转 转 注住拽
            if (filters.femaleFilters.occupations?.length && candidate.profile.occupation) {
              if (!filters.femaleFilters.occupations.includes(candidate.profile.occupation)) {
                return false;
              }
            }

            // 拽转 砖
            if (filters.femaleFilters.educationLevel && candidate.profile.education !== filters.femaleFilters.educationLevel) {
              return false;
            }

            // 拽转 爪 砖驻转
            if (filters.femaleFilters.maritalStatus && candidate.profile.maritalStatus !== filters.femaleFilters.maritalStatus) {
              return false;
            }

            // 拽转 转
            if (filters.femaleFilters.isVerified !== undefined && candidate.isVerified !== filters.femaleFilters.isVerified) {
              return false;
            }

       

            // 拽转 驻注转 专
            if (filters.femaleFilters.lastActiveDays && candidate.profile.lastActive) {
              const lastActive = new Date(candidate.profile.lastActive);
              const daysDiff = (new Date().getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff > filters.femaleFilters.lastActiveDays) {
                return false;
              }
            }

            // 拽转 砖转 驻专驻
            if (filters.femaleFilters.isProfileComplete !== undefined && 
                candidate.isProfileComplete !== filters.femaleFilters.isProfileComplete) {
              return false;
            }

            // 拽转 驻砖 住驻爪驻 驻专 砖 砖
            if (filters.femaleFilters.searchQuery) {
              return checkSearchMatch(candidate, filters.femaleFilters.searchQuery);
            }
          }
          
          // 拽转 驻砖 驻专 砖
          if (filters.femaleSearchQuery) {
            return checkSearchMatch(candidate, filters.femaleSearchQuery);
          }
          
          return true;
        });
      }, [filteredCandidates, filters.femaleFilters, filters.femaleSearchQuery, calculateAge, checkSearchMatch]);
  // 注 转爪转 驻砖
  useEffect(() => {
    if (!filters.separateFiltering && filters.searchQuery) {
      // 爪 驻砖 专
      setSearchResults({
        term: filters.searchQuery,
        count: filteredCandidates.length,
        male: maleCandidates.length,
        female: femaleCandidates.length
      });
    } else if (filters.separateFiltering) {
      // 爪 驻砖 驻专,  爪 转爪转 驻砖 转
      setSearchResults(null);
    } else {
      setSearchResults(null);
    }
  }, [filteredCandidates, maleCandidates, femaleCandidates, filters.searchQuery, filters.separateFiltering]);

  // Export candidates to CSV
  const exportCandidates = async (
    candidates: Candidate[], 
    filters: CandidatesFilter
  ): Promise<void> => {
    try {
      // Prepare data for export
      const exportData = candidates.map(candidate => ({
        '砖 驻专': candidate.firstName,
        '砖 砖驻': candidate.lastName,
        '': calculateAge(candidate.profile.birthDate),
        '专': candidate.profile.gender === 'MALE' ? '专' : '拽',
        '注专': candidate.profile.city || '',
        '': candidate.profile.height || '',
        '专转 转转': candidate.profile.religiousLevel || '',
        '转注住拽': candidate.profile.occupation || '',
        '砖': candidate.profile.education || '',
        '爪 砖驻转': candidate.profile.maritalStatus || '',
        '住住 转': candidate.profile.availabilityStatus || '',
        '转': candidate.isVerified ? '' : '',
        '驻注转 专': candidate.profile.lastActive 
          ? new Date(candidate.profile.lastActive).toLocaleDateString('he-IL')
          : ''
      }));

      // Add filter info to filename
      const filenameSegments = ['candidates'];
      
      if (filters.gender) {
        filenameSegments.push(filters.gender === 'MALE' ? 'male' : 'female');
      }
      
  if (filters.religiousLevel && filters.religiousLevel.length > 0) {
        // 专 转  专转 砖专 注 拽祝, 祝 专 拽驻
        filenameSegments.push(filters.religiousLevel.join('-').replace(/ /g, '-'));
      }
      
      if (filters.cities?.length === 1) {
        filenameSegments.push(filters.cities[0].replace(/ /g, '-'));
      }
      
      // Convert to CSV
      const csv = Papa.unparse(exportData);
      
      // Create and download file
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const timestamp = new Date().toISOString().split('T')[0];
      
      link.setAttribute('href', url);
      link.setAttribute('download', `${filenameSegments.join('_')}_${timestamp}.csv`);
      document.body.appendChild(link);
      
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('Error exporting candidates:', error);
      throw new Error('Failed to export candidates');
    }
  };

  // Update candidate
  const updateCandidate = async (
    id: string, 
    updates: Partial<CandidateProfile>
  ): Promise<void> => {
    try {
      const response = await fetch(`/api/matchmaker/candidates/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      });
      
      if (!response.ok) {
        throw new Error('Failed to update candidate');
      }
      
      // Refresh candidates list after update
      await fetchCandidates();
    } catch (error) {
      console.error('Error updating candidate:', error);
      throw error;
    }
  };

  // Load candidates on mount
  useEffect(() => {
    fetchCandidates();
  }, []);

  // Return interface
  return {
    loading,
    error,
    candidates,
    filteredCandidates,
    maleCandidates,
    femaleCandidates,
    filters,
    setFilters,
    refresh: fetchCandidates,
    totalCount: candidates.length,
    filteredCount: filteredCandidates.length,
    maleCount: maleCandidates.length,
    femaleCount: femaleCandidates.length,
    searchResults,
    exportCandidates,
    updateCandidate,
    sorting,
    setSorting,
    searchSuggestions
  };
};
--- End of Content for useCandidates.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useFilterLogic.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/hooks/useFilterLogic.ts - 专住 砖驻专转

import { useState, useEffect, useMemo, useCallback } from 'react';
import type {
  FilterState,
  SavedFilter,
  FilterOption,
  FilterChangeHandler,  
} from '../types/filters';
import { DEFAULT_FILTER_STATE } from '../types/filters'; 

type SavedFilterFromStorage = Omit<SavedFilter, 'createdAt'> & {
  createdAt: string;
};

interface SearchHistoryItemFromStorage {
  query: string;
  timestamp: string;
}
interface UseFilterLogicProps {
  onFilterChange?: FilterChangeHandler;
  defaultFilters?: Partial<FilterState>;
  localStorageKey?: string;
}

export const useFilterLogic = ({
  onFilterChange,
  defaultFilters = {},
  localStorageKey = 'candidateFilters'
}: UseFilterLogicProps = {}) => {
  // States
  const [filters, setFilters] = useState<FilterState>({
    ...DEFAULT_FILTER_STATE,
    ...defaultFilters
  });
  
  const [savedFilters, setSavedFilters] = useState<SavedFilter[]>([]);
  const [recentSearches, setRecentSearches] = useState<string[]>([]);
  const [searchHistory, setSearchHistory] = useState<{query: string, timestamp: Date}[]>([]);
  const [lastAppliedFilter, setLastAppliedFilter] = useState<string | null>(null);

  // Load saved filters and history from localStorage
  useEffect(() => {
    try {
      // Load saved filters
      const savedPrefs = localStorage.getItem(localStorageKey);
      if (savedPrefs) {
        const parsed = JSON.parse(savedPrefs);
        setSavedFilters(parsed.map((filter: SavedFilterFromStorage) => ({
          ...filter,
          createdAt: new Date(filter.createdAt)
        })));
      }

      // Load recent searches
      const searches = localStorage.getItem(`${localStorageKey}_recent_searches`);
      if (searches) {
        setRecentSearches(JSON.parse(searches));
      }

      // Load search history
      const history = localStorage.getItem(`${localStorageKey}_search_history`);
      if (history) {
        setSearchHistory(JSON.parse(history).map((item: SearchHistoryItemFromStorage) => ({
          ...item,
          timestamp: new Date(item.timestamp)
        })));
      }
    } catch (error) {
      console.error('Error loading saved filters:', error);
    }
  }, [localStorageKey]);

  // 注 驻专 
  const updateFilters = useCallback((newFilters: Partial<FilterState>) => {
    console.log("updateFilters called with:", newFilters);
    
    setFilters(prev => {
      const updated = { ...prev, ...newFilters };
      console.log("Updated filters:", updated);
      
      //  砖 专转 驻砖 砖, 注 转 住专转 驻砖
      if (newFilters.searchQuery && newFilters.searchQuery !== prev.searchQuery) {
        const newQuery = newFilters.searchQuery;
        console.log("New search query detected:", newQuery);
        
        // 注 住专转 驻砖
        const updatedHistory = [
          { query: newQuery, timestamp: new Date() },
          ...searchHistory.filter(item => item.query !== newQuery).slice(0, 9)
        ];
        
        setSearchHistory(updatedHistory);
        setRecentSearches(updatedHistory.map(item => item.query));
        
        // 砖专 -localStorage
        try {
          localStorage.setItem(
            `${localStorageKey}_recent_searches`, 
            JSON.stringify(updatedHistory.map(item => item.query))
          );
          localStorage.setItem(
            `${localStorageKey}_search_history`,
            JSON.stringify(updatedHistory.map(item => ({
              query: item.query,
              timestamp: item.timestamp.toISOString()
            })))
          );
        } catch (e) {
          console.error("Error saving search history:", e);
        }
      }
      
      // 驻 驻砖 驻专 专
      if (newFilters.maleSearchQuery && newFilters.maleSearchQuery !== prev.maleSearchQuery) {
        //  驻砖专 爪专 住专 驻专转 驻砖 专  砖专 住专 转
        console.log("New male search query:", newFilters.maleSearchQuery);
      }
      
      // 驻 驻砖 驻专 砖
      if (newFilters.femaleSearchQuery && newFilters.femaleSearchQuery !== prev.femaleSearchQuery) {
        //  驻砖专 爪专 住专 驻专转 驻砖 砖  砖专 住专 转
        console.log("New female search query:", newFilters.femaleSearchQuery);
      }

      // 拽专 驻拽爪转 callback
      if (onFilterChange) {
        console.log("Calling onFilterChange with updated filters");
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange, searchHistory, localStorageKey, setRecentSearches, setSearchHistory]);

  // Reset filters
  const resetFilters = useCallback(() => {
    const defaultState: FilterState = {
      ...DEFAULT_FILTER_STATE,
      ...defaultFilters
    };

    setFilters(defaultState);
    setLastAppliedFilter(null);
    onFilterChange?.(defaultState);
  }, [defaultFilters, onFilterChange]);

  // Clear recent searches
  const clearRecentSearches = useCallback(() => {
    setRecentSearches([]);
    localStorage.removeItem(`${localStorageKey}_recent_searches`);
  }, [localStorageKey]);

  // Save new filter
  const saveFilter = useCallback(async (name: string, filters: FilterState) => {
    const newFilter: SavedFilter = {
      id: Date.now().toString(),
      name,
      filters,
      isDefault: false,
      createdAt: new Date()
    };

    setSavedFilters(prev => {
      const updated = [...prev, newFilter];
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });

    return newFilter;
  }, [localStorageKey]);

  // 驻拽爪 砖驻专转 驻转 爪 住 驻专
  const toggleSeparateFiltering = useCallback(() => {
    console.log("toggleSeparateFiltering called");
    
    setFilters(prev => {
      const newState = {
        ...prev,
        separateFiltering: !prev.separateFiltering
      };
      
      console.log(`Changing separateFiltering from ${prev.separateFiltering} to ${newState.separateFiltering}`);
      
      return newState;
    });
  }, []);

  // 驻拽爪 砖驻专转 注 住 专
  const updateMaleFilters = useCallback((maleFilters: Partial<FilterState>) => {
    setFilters(prev => {
      const updatedMaleFilters = {
        ...prev.maleFilters,
        ...maleFilters
      };
      
      //  砖 注 砖 专转 驻砖 住驻爪驻转 专
      if (maleFilters.searchQuery !== undefined) {
        const updated = {
          ...prev,
          maleFilters: updatedMaleFilters,
          maleSearchQuery: maleFilters.searchQuery // 砖专转 驻砖  砖 驻专
        };
        
        // 拽专 驻拽爪转 callback  拽转
        if (onFilterChange) {
          onFilterChange(updated);
        }
        
        return updated;
      }
      
      const updated = {
        ...prev,
        maleFilters: updatedMaleFilters
      };
      
      // 拽专 驻拽爪转 callback  拽转
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // 驻拽爪 砖驻专转 注 住 砖
  const updateFemaleFilters = useCallback((femaleFilters: Partial<FilterState>) => {
    setFilters(prev => {
      const updatedFemaleFilters = {
        ...prev.femaleFilters,
        ...femaleFilters
      };
      
      //  砖 注 砖 专转 驻砖 住驻爪驻转 砖
      if (femaleFilters.searchQuery !== undefined) {
        const updated = {
          ...prev,
          femaleFilters: updatedFemaleFilters,
          femaleSearchQuery: femaleFilters.searchQuery // 砖专转 驻砖  砖 驻专
        };
        
        // 拽专 驻拽爪转 callback  拽转
        if (onFilterChange) {
          onFilterChange(updated);
        }
        
        return updated;
      }
      
      const updated = {
        ...prev,
        femaleFilters: updatedFemaleFilters
      };
      
      // 拽专 驻拽爪转 callback  拽转
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  const updateMaleSearchQuery = useCallback((query: string) => {
    setFilters(prev => {
      // 砖专 转 驻砖 砖 注
      const updated = {
        ...prev,
        maleSearchQuery: query
      };
      
      // 注  转 驻专 住驻爪驻 专  驻注 住 驻专
      if (prev.separateFiltering) {
        updated.maleFilters = {
          ...prev.maleFilters,
          searchQuery: query
        };
      }
      
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);
  
  // 驻拽爪 砖 注 驻砖 驻专 砖
  const updateFemaleSearchQuery = useCallback((query: string) => {
    setFilters(prev => {
      // 砖专 转 驻砖 砖 注
      const updated = {
        ...prev,
        femaleSearchQuery: query
      };
      
      // 注  转 驻专 住驻爪驻 砖  驻注 住 驻专
      if (prev.separateFiltering) {
        updated.femaleFilters = {
          ...prev.femaleFilters,
          searchQuery: query
        };
      }
      
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // 驻拽爪 砖驻专转 注转拽转 住 爪  砖
  const copyFilters = useCallback((source: 'male' | 'female', target: 'male' | 'female') => {
    setFilters(prev => {
      const sourceFilters = source === 'male' ? prev.maleFilters : prev.femaleFilters;
      
      if (!sourceFilters) {
        return prev;
      }
      
      const updated = { ...prev };
      
      if (target === 'male') {
        updated.maleFilters = { ...sourceFilters };
      } else {
        updated.femaleFilters = { ...sourceFilters };
      }
      
      // 拽专 驻拽爪转 callback  拽转
      if (onFilterChange) {
        onFilterChange(updated);
      }
      
      return updated;
    });
  }, [onFilterChange]);

  // Update existing filter
  const updateSavedFilter = useCallback((id: string, updates: Partial<SavedFilter>) => {
    setSavedFilters(prev => {
      const updated = prev.map(filter => 
        filter.id === id ? { ...filter, ...updates } : filter
      );
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });
  }, [localStorageKey]);

  // Delete filter
  const deleteFilter = useCallback((id: string) => {
    setSavedFilters(prev => {
      const updated = prev.filter(f => f.id !== id);
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      
      if (lastAppliedFilter === id) {
        setLastAppliedFilter(null);
      }
      
      return updated;
    });
  }, [localStorageKey, lastAppliedFilter]);

  // Set default filter
  const setDefaultFilter = useCallback((id: string) => {
    setSavedFilters(prev => {
      const updated = prev.map(f => ({
        ...f,
        isDefault: f.id === id
      }));
      localStorage.setItem(localStorageKey, JSON.stringify(updated));
      return updated;
    });
  }, [localStorageKey]);

  // Load saved filter - 转 住 驻专
  const loadSavedFilter = useCallback((id: string) => {
    const filter = savedFilters.find(f => f.id === id);
    if (filter) {
      // 拽  砖 驻专 砖专 注  住 驻专
      setFilters({ 
        ...filter.filters, 
        savedFilterId: id,
        //  砖砖 转 转 驻 ,    专 驻专 拽专
        separateFiltering: true as boolean,        maleFilters: filter.filters.maleFilters || {},
        femaleFilters: filter.filters.femaleFilters || {}
      });
      
      setLastAppliedFilter(id);
      onFilterChange?.({ 
        ...filter.filters, 
        savedFilterId: id,
        separateFiltering: true as boolean,        maleFilters: filter.filters.maleFilters || {},
        femaleFilters: filter.filters.femaleFilters || {} 
      });
    }
  }, [savedFilters, onFilterChange]);

  // Apply popular filter
  const applyPopularFilter = useCallback((filterConfig: Partial<FilterState>) => {
    const updatedFilters = {
      ...DEFAULT_FILTER_STATE,
      ...filterConfig
    };
    setFilters(updatedFilters);
    onFilterChange?.(updatedFilters);
  }, [onFilterChange]);

  // Check for active filters
  const hasActiveFilters = useMemo(() => {
    return (
      filters.searchQuery ||
      filters.gender !== undefined ||
      (filters.cities?.length ?? 0) > 0 ||  // 拽  注专
      (filters.occupations?.length ?? 0) > 0 ||  // 拽  注专
      filters.religiousLevel ||
      filters.educationLevel ||
      filters.maritalStatus ||
      filters.availabilityStatus ||
      filters.userStatus ||
      filters.isVerified ||
      filters.hasReferences ||
      filters.lastActiveDays ||
      filters.isProfileComplete ||
      (filters.ageRange && (
        filters.ageRange.min !== DEFAULT_FILTER_STATE.ageRange?.min ||
        filters.ageRange.max !== DEFAULT_FILTER_STATE.ageRange?.max
      )) ||
      (filters.heightRange && (
        filters.heightRange.min !== DEFAULT_FILTER_STATE.heightRange?.min ||
        filters.heightRange.max !== DEFAULT_FILTER_STATE.heightRange?.max
      )) ||
      // 拽转 驻专 驻专 驻注
      filters.separateFiltering
    );
  }, [filters]);

  // Get active filters in formatted array
  const activeFilters = useMemo((): FilterOption[] => {
    const active: FilterOption[] = [];

    if (filters.searchQuery) {
      active.push({
        key: 'searchQuery',
        value: filters.searchQuery,
        label: `驻砖: ${filters.searchQuery}`,
        category: '驻砖'
      });
    }

    if (filters.gender) {
      active.push({
        key: 'gender',
        value: filters.gender,
        label: `专: ${filters.gender === 'MALE' ? '专' : '拽'}`,
        category: '注 住住'
      });
    }

    if (filters.separateFiltering) {
      active.push({
        key: 'separateFiltering',
        value: true,
        label: '住 驻专 驻 专',
        category: '注 住住'
      });
    }

    // 
    if (filters.ageRange && (
      filters.ageRange.min !== DEFAULT_FILTER_STATE.ageRange?.min || 
      filters.ageRange.max !== DEFAULT_FILTER_STATE.ageRange?.max
    )) {
      active.push({
        key: 'ageRange',
        value: filters.ageRange,
        label: `: ${filters.ageRange.min}-${filters.ageRange.max}`,
        category: '注 住住'
      });
    }

    // 
    if (filters.heightRange && (
      filters.heightRange.min !== DEFAULT_FILTER_STATE.heightRange?.min || 
      filters.heightRange.max !== DEFAULT_FILTER_STATE.heightRange?.max
    )) {
      active.push({
        key: 'heightRange',
        value: filters.heightRange,
        label: `: ${filters.heightRange.min}-${filters.heightRange.max} 住"`,
        category: '注 住住'
      });
    }

    // 注专
    if (filters.cities?.length) {
      if (filters.cities.length === 1) {
        active.push({
          key: 'cities',
          value: filters.cities[0],
          label: `注专: ${filters.cities[0]}`,
          category: '拽'
        });
      } else {
        active.push({
          key: 'cities',
          value: filters.cities,
          label: `注专: ${filters.cities.length} 专`,
          category: '拽'
        });
      }
    }

    // 转 注住拽
    if (filters.occupations?.length) {
      if (filters.occupations.length === 1) {
        active.push({
          key: 'occupations',
          value: filters.occupations[0],
          label: `转 注住拽: ${filters.occupations[0]}`,
          category: '转注住拽'
        });
      } else {
        active.push({
          key: 'occupations',
          value: filters.occupations,
          label: `转 注住拽: ${filters.occupations.length} 专`,
          category: '转注住拽'
        });
      }
    }

    // 专转 转转
    if (filters.religiousLevel) {
      active.push({
        key: 'religiousLevel',
        value: filters.religiousLevel,
        label: `专转 转转: ${filters.religiousLevel}`,
        category: '转'
      });
    }

    // 砖
    if (filters.educationLevel) {
      active.push({
        key: 'educationLevel',
        value: filters.educationLevel,
        label: `砖: ${filters.educationLevel}`,
        category: '砖'
      });
    }

    // 爪 砖驻转
    if (filters.maritalStatus) {
      active.push({
        key: 'maritalStatus',
        value: filters.maritalStatus,
        label: `爪 砖驻转: ${filters.maritalStatus}`,
        category: '注 砖'
      });
    }

    // 住住 转
    if (filters.availabilityStatus) {
      const statusLabel = 
        filters.availabilityStatus === "AVAILABLE" ? "驻/" :
        filters.availabilityStatus === "DATING" ? "转 专转" :
        filters.availabilityStatus === "UNAVAILABLE" ? " 驻/" :
        filters.availabilityStatus;
      
      active.push({
        key: 'availabilityStatus',
        value: filters.availabilityStatus,
        label: `住住 转: ${statusLabel}`,
        category: '转'
      });
    }

    // 住住 砖转砖
    if (filters.userStatus) {
      active.push({
        key: 'userStatus',
        value: filters.userStatus,
        label: `住住 砖转砖: ${filters.userStatus}`,
        category: '住住'
      });
    }

    // 砖转砖 转
    if (filters.isVerified !== undefined) {
      active.push({
        key: 'isVerified',
        value: filters.isVerified,
        label: `砖转砖 转: ${filters.isVerified ? '' : ''}`,
        category: '转'
      });
    }

    // 砖 爪转
    if (filters.hasReferences !== undefined) {
      active.push({
        key: 'hasReferences',
        value: filters.hasReferences,
        label: `砖 爪转: ${filters.hasReferences ? '' : ''}`,
        category: '爪转'
      });
    }

    // 驻注转 专
    if (filters.lastActiveDays !== undefined) {
      active.push({
        key: 'lastActiveDays',
        value: filters.lastActiveDays,
        label: `驻注 -${filters.lastActiveDays}  专`,
        category: '驻注转'
      });
    }

    // 驻专驻 
    if (filters.isProfileComplete !== undefined) {
      active.push({
        key: 'isProfileComplete',
        value: filters.isProfileComplete,
        label: `驻专驻 : ${filters.isProfileComplete ? '' : ''}`,
        category: '砖转 驻专驻'
      });
    }

    return active;
  }, [filters]);

  // Remove single filter
  const removeFilter = useCallback((key: keyof FilterState, value?: string) => {
    setFilters(prev => {
      const updated = { ...prev };

      if (key === 'separateFiltering') {
        updated.separateFiltering = false;
      } else if (Array.isArray(updated[key]) && value !== undefined) {
        if (key === 'cities' || key === 'occupations') {
          updated[key] = (updated[key] as string[]).filter(v => v !== value);
        }
      } else {
        delete updated[key];
      }

      onFilterChange?.(updated);
      return updated;
    });
  }, [onFilterChange]);
  
  // Calculate popular filters based on search history
  const popularFilters = useMemo(() => {
    // Group searches by frequency
    const searchFrequency: Record<string, number> = {};
    searchHistory.forEach(item => {
      searchFrequency[item.query] = (searchFrequency[item.query] || 0) + 1;
    });
    
    // Sort by frequency
    return Object.entries(searchFrequency)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([query]) => query);
  }, [searchHistory]);

  return {
    // Current state
    filters,
    savedFilters,
    recentSearches,
    searchHistory,
    activeFilters,
    hasActiveFilters,
    popularFilters,
    lastAppliedFilter,
    
    // Separate filtering functions
    toggleSeparateFiltering,
    updateMaleFilters,
    updateFemaleFilters,
    copyFilters,
    
    // 驻砖 驻专 驻拽爪转 砖转
    updateMaleSearchQuery,
    updateFemaleSearchQuery,
    
    // Actions
    setFilters: updateFilters,
    removeFilter,
    resetFilters,
    clearRecentSearches,
    applyPopularFilter,

    // Saved filters management
    saveFilter,
    updateSavedFilter,
    deleteFilter,
    setDefaultFilter,
    loadSavedFilter,
};
};
export default useFilterLogic;
--- End of Content for useFilterLogic.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useMatchingJob.ts
--------------------------------------------------------------------------------
Content:
// ===========================================
// src/hooks/useMatchingJob.ts
// ===========================================
//  Hook  Background Matching Jobs
//  polling, progress tracking, 转专转

import { useState, useEffect, useCallback, useRef } from 'react';
import { toast } from 'sonner';

// ============================================================================
// Types
// ============================================================================

export type JobStatus = 'idle' | 'pending' | 'processing' | 'completed' | 'failed';
export type SearchMethod = 'algorithmic' | 'vector';

export interface MatchResult {
  userId: string;
  firstName?: string;
  lastName?: string;
  firstPassScore?: number;
  finalScore?: number;
  scoreBreakdown?: {
    religious: number;
    careerFamily: number;
    lifestyle: number;
    ambition: number;
    communication: number;
    values: number;
  };
  shortReasoning?: string;
  detailedReasoning?: string;
  rank?: number;
  backgroundMultiplier?: number;
  backgroundCompatibility?: string;
  similarity?: number;
}

export interface JobState {
  jobId: string | null;
  status: JobStatus;
  progress: number;
  progressMessage: string;
  result: {
    matches: MatchResult[];
    meta?: any;
  } | null;
  error: string | null;
  fromCache: boolean;
  meta: {
    createdAt?: Date;
    completedAt?: Date;
    matchesFound?: number;
    totalCandidates?: number;
  };
}

export interface UseMatchingJobOptions {
  pollingInterval?: number;      // 专  拽转 (专专转 : 3000ms)
  onComplete?: (result: JobState['result']) => void;  // callback 砖住转
  onError?: (error: string) => void;                  // callback 砖砖
  showToasts?: boolean;          //  爪 转专转 (专专转 : true)
}

// ============================================================================
// Initial State
// ============================================================================

const initialState: JobState = {
  jobId: null,
  status: 'idle',
  progress: 0,
  progressMessage: '',
  result: null,
  error: null,
  fromCache: false,
  meta: {}
};

// ============================================================================
// Hook
// ============================================================================

export function useMatchingJob(options: UseMatchingJobOptions = {}) {
  const {
    pollingInterval = 3000,
    onComplete,
    onError,
    showToasts = true
  } = options;

  const [state, setState] = useState<JobState>(initialState);
  const pollingRef = useRef<NodeJS.Timeout | null>(null);
  const isPollingRef = useRef(false);

  // ============================================================================
  // Stop Polling
  // ============================================================================
  
  const stopPolling = useCallback(() => {
    if (pollingRef.current) {
      clearInterval(pollingRef.current);
      pollingRef.current = null;
    }
    isPollingRef.current = false;
  }, []);

  // ============================================================================
  // Poll Job Status
  // ============================================================================
  
  const pollJobStatus = useCallback(async (jobId: string) => {
    try {
      const response = await fetch(`/api/ai/find-matches-v2?jobId=${jobId}`);
      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to get job status');
      }

      setState(prev => ({
        ...prev,
        status: data.status,
        progress: data.progress || 0,
        progressMessage: data.progressMessage || '',
        result: data.result || null,
        error: data.error || null,
        fromCache: data.fromCache || false,
        meta: {
          createdAt: data.meta?.createdAt ? new Date(data.meta.createdAt) : undefined,
          completedAt: data.meta?.completedAt ? new Date(data.meta.completedAt) : undefined,
          matchesFound: data.meta?.matchesFound,
          totalCandidates: data.meta?.totalCandidates
        }
      }));

      // 拽  Job 住转
      if (data.status === 'completed') {
        stopPolling();
        
        if (showToasts) {
          const matchCount = data.result?.matches?.length || data.meta?.matchesFound || 0;
          toast.success(` 爪 ${matchCount} 转转!`, {
            description: '抓 爪转 转爪转',
            duration: 10000,
          });
        }
        
        onComplete?.(data.result);
      } 
      else if (data.status === 'failed') {
        stopPolling();
        
        if (showToasts) {
          toast.error(' 驻砖 砖', {
            description: data.error || '专注 砖',
            duration: 5000,
          });
        }
        
        onError?.(data.error || 'Unknown error');
      }

    } catch (error) {
      console.error('[useMatchingJob] Poll error:', error);
      //  注爪专 polling  砖转 专砖转 - 住 砖
    }
  }, [stopPolling, onComplete, onError, showToasts]);

  // ============================================================================
  // Start Polling
  // ============================================================================
  
  const startPolling = useCallback((jobId: string) => {
    if (isPollingRef.current) return;
    
    isPollingRef.current = true;
    
    // 拽 专砖 转
    pollJobStatus(jobId);
    
    // 转转 polling
    pollingRef.current = setInterval(() => {
      pollJobStatus(jobId);
    }, pollingInterval);
  }, [pollJobStatus, pollingInterval]);

  // ============================================================================
  // Start Job
  // ============================================================================
  
  const startJob = useCallback(async (
    targetUserId: string,
    method: SearchMethod = 'algorithmic',
    forceRefresh: boolean = false
  ): Promise<JobState['jobId']> => {
    // 驻住 state
    setState({
      ...initialState,
      status: 'pending',
      progressMessage: '转...'
    });

    try {
      const response = await fetch('/api/ai/find-matches-v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetUserId, method, forceRefresh })
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to start job');
      }

      // 注 state 注 -jobId
      setState(prev => ({
        ...prev,
        jobId: data.jobId,
        status: data.status,
        progress: data.progress || 0,
        progressMessage: data.progressMessage || '',
        fromCache: data.fromCache || false,
      }));

      //  拽 转爪 cache -  爪专 polling
      if (data.status === 'completed' && data.result) {
        setState(prev => ({
          ...prev,
          result: data.result,
          meta: {
            completedAt: data.meta?.completedAt ? new Date(data.meta.completedAt) : undefined,
            matchesFound: data.meta?.matchesFound,
            totalCandidates: data.meta?.totalCandidates
          }
        }));

        if (showToasts) {
          const matchCount = data.result?.matches?.length || 0;
          toast.success(` 注 ${matchCount} 转转 专`, {
            description: '转爪转 砖专转',
            duration: 5000,
          });
        }

        onComplete?.(data.result);
        return data.jobId;
      }

      // 专转 - 转 polling
      if (showToasts) {
        toast.info(' 驻砖 转', {
          description: ' 注砖 拽转  拽转',
          duration: 3000,
        });
      }

      startPolling(data.jobId);
      return data.jobId;

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      
      setState(prev => ({
        ...prev,
        status: 'failed',
        error: errorMessage
      }));

      if (showToasts) {
        toast.error(' 砖 驻注转 驻砖', {
          description: errorMessage,
        });
      }

      onError?.(errorMessage);
      throw error;
    }
  }, [startPolling, onComplete, onError, showToasts]);

  // ============================================================================
  // Cancel Job
  // ============================================================================
  
  const cancelJob = useCallback(async () => {
    stopPolling();

    if (state.jobId) {
      try {
        await fetch(`/api/ai/find-matches-v2?jobId=${state.jobId}`, {
          method: 'DELETE'
        });
      } catch (error) {
        console.error('[useMatchingJob] Cancel error:', error);
      }
    }

    setState(initialState);
    
    if (showToasts) {
      toast.info('驻砖 ');
    }
  }, [state.jobId, stopPolling, showToasts]);

  // ============================================================================
  // Reset
  // ============================================================================
  
  const reset = useCallback(() => {
    stopPolling();
    setState(initialState);
  }, [stopPolling]);

  // ============================================================================
  // Cleanup on unmount
  // ============================================================================
  
  useEffect(() => {
    return () => {
      stopPolling();
    };
  }, [stopPolling]);

  // ============================================================================
  // Return
  // ============================================================================
  
  return {
    // State
    ...state,
    
    // Computed
    isLoading: state.status === 'pending' || state.status === 'processing',
    isComplete: state.status === 'completed',
    isFailed: state.status === 'failed',
    isIdle: state.status === 'idle',
    hasResult: state.result !== null && state.result.matches.length > 0,
    
    // Actions
    startJob,
    cancelJob,
    reset,
    
    // For debugging
    _state: state
  };
}

// ============================================================================
// Export default
// ============================================================================

export default useMatchingJob;
--- End of Content for useMatchingJob.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\hooks\useStatistics.ts
--------------------------------------------------------------------------------
Content:
// /hooks/useStatistics.ts

import { useMemo } from 'react';
import type { Candidate } from '../types/candidates';
import {
  calculateAgeDistribution,
  calculateLocationDistribution,
  calculateReligiousDistribution,
  calculateActivityStats,
  calculateGenderStats,
  calculateAvailabilityStats,
  calculateCompletionStats
} from '../../suggestions/utils/statisticsCalculator';

export interface Statistics {
  gender: {
    maleCount: number;
    femaleCount: number;
    ratio: number;
    total: number;
    percentages: {
      male: number;
      female: number;
    };
  };
  age: {
    ageGroups: Record<string, number>;
    averageAge: number;
    medianAge: number;
  };
  location: {
    cities: Record<string, number>;
    topCities: Array<{ city: string; count: number }>;
  };
  religious: {
    levels: Record<string, number>;
    percentages: Record<string, number>;
  };
  activity: {
    activeLastWeek: number;
    activeLastMonth: number;
    averageLoginFrequency: number;
    completedProfiles: number;
  };
  availability: {
    counts: Record<string, number>;
    percentages: Record<string, number>;
  };
  completion: {
    counts: {
      hasPhotos: number;
      hasAbout: number;
      hasReferences: number;
      hasPreferences: number;
      isVerified: number;
      fullyCompleted: number;
    };
    percentages: {
      hasPhotos: number;
      hasAbout: number;
      hasReferences: number;
      hasPreferences: number;
      isVerified: number;
      fullyCompleted: number;
    };
  };
}

export const useStatistics = (candidates: Candidate[]) => {
  const stats = useMemo<Statistics>(() => {
    return {
      gender: calculateGenderStats(candidates),
      age: calculateAgeDistribution(candidates),
      location: calculateLocationDistribution(candidates),
      religious: calculateReligiousDistribution(candidates),
      activity: calculateActivityStats(candidates),
      availability: calculateAvailabilityStats(candidates),
      completion: calculateCompletionStats(candidates)
    };
  }, [candidates]);

  // 驻拽爪转 注专 砖驻转 转 住驻爪驻
  const getGenderRatio = () => {
    return {
      ratio: stats.gender.ratio,
      formattedRatio: `${stats.gender.maleCount}:${stats.gender.femaleCount}`
    };
  };

  const getTopCities = (limit: number = 5) => {
    return stats.location.topCities.slice(0, limit);
  };

  const getActiveUsersPercent = () => {
    return Math.round((stats.activity.activeLastWeek / stats.gender.total) * 100);
  };

  const getCompletionRate = () => {
    return stats.completion.percentages.fullyCompleted;
  };

  const getAgeGroupDistribution = () => {
    return Object.entries(stats.age.ageGroups)
      .map(([range, count]) => ({
        range,
        count,
        percentage: Math.round((count / stats.gender.total) * 100)
      }))
      .sort((a, b) => {
        const [aMin] = a.range.split('-').map(Number);
        const [bMin] = b.range.split('-').map(Number);
        return aMin - bMin;
      });
  };

  const getReligiousDistribution = () => {
    return Object.entries(stats.religious.levels)
      .map(([level, count]) => ({
        level,
        count,
        percentage: stats.religious.percentages[level]
      }))
      .sort((a, b) => b.count - a.count);
  };

  const getActivityTrend = () => {
    return {
      weekly: stats.activity.activeLastWeek,
      monthly: stats.activity.activeLastMonth,
      average: stats.activity.averageLoginFrequency
    };
  };

  const getProfileCompletionStats = () => {
    return {
      completed: stats.completion.counts.fullyCompleted,
      partial: stats.gender.total - stats.completion.counts.fullyCompleted,
      percentage: stats.completion.percentages.fullyCompleted
    };
  };

  return {
    stats,
    getGenderRatio,
    getTopCities,
    getActiveUsersPercent,
    getCompletionRate,
    getAgeGroupDistribution,
    getReligiousDistribution,
    getActivityTrend,
    getProfileCompletionStats
  };
};

export default useStatistics;
--- End of Content for useStatistics.ts ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\LoadingStates.tsx
--------------------------------------------------------------------------------
Content:
'use client';

import React from 'react';
import { Loader2, AlertCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Skeleton } from '@/components/ui/skeleton';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface LoadingContainerProps {
  children: React.ReactNode;
  className?: string;
}

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

interface LoadingCardProps {
  count?: number;
  layout?: 'grid' | 'list';
  className?: string;
}

interface LoadingTextProps {
  lines?: number;
  className?: string;
}

interface LoadingErrorProps {
  message: string;
  onRetry?: () => void;
  className?: string;
  dict: MatchmakerPageDictionary['loadingStates'];
}

export const LoadingContainer: React.FC<LoadingContainerProps> = ({
  children,
  className,
}) => {
  return (
    <div className={cn('relative min-h-[200px]', className)}>
      {/* Updated Overlay: Glassmorphism with Teal tint */}
      <div className="absolute inset-0 bg-white/60 backdrop-blur-[2px] flex items-center justify-center z-50 rounded-xl transition-all duration-500">
        <div className="relative">
          {/* Background Blob for Spinner */}
          <div className="absolute inset-0 bg-teal-200/50 blur-xl rounded-full animate-pulse"></div>
          <Loader2 className="relative z-10 h-10 w-10 animate-spin text-teal-600" />
        </div>
      </div>
      <div className="opacity-40 pointer-events-none filter blur-[1px]">
        {children}
      </div>
    </div>
  );
};

export const LoadingSpinner: React.FC<LoadingSpinnerProps> = ({
  size = 'md',
  className,
}) => {
  const sizeClasses = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' };
  return (
    <div className={cn('flex items-center justify-center', className)}>
      <Loader2
        // Updated: Blue -> Teal
        className={cn('animate-spin text-teal-600', sizeClasses[size])}
      />
    </div>
  );
};

export const LoadingCard: React.FC<LoadingCardProps> = ({
  count = 1,
  layout = 'grid',
  className,
}) => {
  return (
    <div
      className={cn(
        layout === 'grid'
          ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
          : 'space-y-4',
        className
      )}
    >
      {Array.from({ length: count }).map((_, index) => (
        <div
          key={index}
          // Updated: Card Styling to match new UI (Shadows, Border, Gradient)
          className={cn(
            'bg-white rounded-3xl overflow-hidden shadow-lg border border-teal-50',
            layout === 'list' ? 'flex gap-4 p-4' : ''
          )}
        >
          <Skeleton
            className={cn(
              // Updated: Gradient Skeleton
              'bg-gradient-to-br from-gray-100 via-teal-50/30 to-gray-100',
              layout === 'list'
                ? 'w-32 h-32 rounded-2xl'
                : 'w-full h-48 rounded-t-3xl rounded-b-none'
            )}
          />
          <div className={cn('flex-1', layout !== 'list' && 'p-6')}>
            <div className="flex items-center justify-between mb-4">
              <Skeleton className="h-6 w-1/3 bg-gray-100" />
              <Skeleton className="h-6 w-20 rounded-full bg-orange-50" />
            </div>
            <div className="space-y-3">
              <Skeleton className="h-4 w-3/4 bg-gray-100" />
              <Skeleton className="h-4 w-1/2 bg-gray-100" />
              <Skeleton className="h-4 w-5/6 bg-gray-100" />
            </div>
            <div className="flex gap-3 mt-6">
              <Skeleton className="h-10 w-28 rounded-xl bg-teal-50" />
              <Skeleton className="h-10 w-28 rounded-xl bg-gray-50" />
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};

export const LoadingText: React.FC<LoadingTextProps> = ({
  lines = 3,
  className,
}) => {
  return (
    <div className={cn('space-y-3', className)}>
      {Array.from({ length: lines }).map((_, index) => (
        <Skeleton
          key={index}
          className={cn(
            'h-4 bg-gray-100 rounded-full',
            index === lines - 1 ? 'w-2/3' : 'w-full'
          )}
        />
      ))}
    </div>
  );
};

export const LoadingError: React.FC<LoadingErrorProps> = ({
  message,
  onRetry,
  className,
  dict,
}) => {
  return (
    // Updated: Error Alert Styling (Rose/Red)
    <Alert
      variant="destructive"
      className={cn('border-2 border-rose-100 bg-rose-50/50', className)}
    >
      <AlertCircle className="h-5 w-5 text-rose-600" />
      <AlertTitle className="text-rose-800 font-bold">
        {dict.errorTitle}
      </AlertTitle>
      <AlertDescription className="flex items-center justify-between mt-2">
        <span className="text-rose-700">{message}</span>
        {onRetry && (
          <Button
            variant="outline"
            size="sm"
            onClick={onRetry}
            className="ml-4 bg-white border-rose-200 text-rose-700 hover:bg-rose-100 hover:text-rose-800"
          >
            {dict.retryButton}
          </Button>
        )}
      </AlertDescription>
    </Alert>
  );
};

export const LoadingStats: React.FC<{ className?: string }> = ({
  className,
}) => {
  return (
    <div className={cn('grid grid-cols-2 md:grid-cols-4 gap-4', className)}>
      {Array.from({ length: 4 }).map((_, index) => (
        <div
          key={index}
          className="bg-white p-6 rounded-2xl shadow-sm border border-teal-50/50"
        >
          <Skeleton className="h-5 w-20 mb-3 bg-gray-100" />
          <Skeleton className="h-10 w-16 bg-gradient-to-r from-teal-50 to-orange-50" />
        </div>
      ))}
    </div>
  );
};

export const LoadingFilters: React.FC<{ className?: string }> = ({
  className,
}) => {
  return (
    <div className={cn('space-y-4', className)}>
      <Skeleton className="h-12 w-full rounded-xl bg-gray-50" />
      <div className="flex flex-wrap gap-2">
        {Array.from({ length: 4 }).map((_, index) => (
          <Skeleton key={index} className="h-9 w-28 rounded-lg bg-gray-50" />
        ))}
      </div>
    </div>
  );
};

const LoadingComponents = {
  LoadingContainer,
  LoadingSpinner,
  LoadingCard,
  LoadingText,
  LoadingError,
  LoadingStats,
  LoadingFilters,
};

export default LoadingComponents;
--- End of Content for LoadingStates.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\Pagination.tsx
--------------------------------------------------------------------------------
Content:
// /shared/Pagination.tsx
'use client';

import React from 'react';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  ChevronRight,
  ChevronLeft,
  ChevronsLeft,
  ChevronsRight,
} from 'lucide-react';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface PaginationProps {
  currentPage: number;
  totalPages: number;
  pageSize: number;
  totalItems: number;
  onPageChange: (page: number) => void;
  onPageSizeChange: (size: number) => void;
  className?: string;
  dict: MatchmakerPageDictionary['pagination'];
}

const pageSizeOptions = [10, 20, 50, 100];

const Pagination: React.FC<PaginationProps> = ({
  currentPage,
  totalPages,
  pageSize,
  totalItems,
  onPageChange,
  onPageSizeChange,
  className,
  dict,
}) => {
  // Helper to generate page numbers array
  const getPageNumbers = () => {
    const pages: (number | string)[] = [];
    const maxVisiblePages = 5;

    if (totalPages <= maxVisiblePages) {
      return Array.from({ length: totalPages }, (_, i) => i + 1);
    }

    // Always show first page
    pages.push(1);

    // Calculate start and end of visible pages
    let start = Math.max(currentPage - 1, 2);
    let end = Math.min(currentPage + 1, totalPages - 1);

    // Adjust for edge cases
    if (currentPage <= 3) {
      end = Math.min(maxVisiblePages - 1, totalPages - 1);
    } else if (currentPage >= totalPages - 2) {
      start = Math.max(totalPages - maxVisiblePages + 2, 2);
    }

    // Add ellipsis and numbers
    if (start > 2) pages.push('...');
    for (let i = start; i <= end; i++) {
      pages.push(i);
    }
    if (end < totalPages - 1) pages.push('...');

    // Always show last page
    if (totalPages > 1) pages.push(totalPages);

    // --- 转拽  ---
    return pages;
  };

  const startItem = (currentPage - 1) * pageSize + 1;
  const endItem = Math.min(currentPage * pageSize, totalItems);
  const resultsText = dict.results
    .replace('{{start}}', String(startItem))
    .replace('{{end}}', String(endItem))
    .replace('{{total}}', String(totalItems));

  return (
    <div
      className={`flex flex-col sm:flex-row items-center justify-between gap-4 ${className}`}
    >
      <div className="flex items-center gap-2 text-sm text-gray-600">
        <span>{dict.show}</span>
        <Select
          value={pageSize.toString()}
          onValueChange={(value) => onPageSizeChange(Number(value))}
        >
          <SelectTrigger className="w-[70px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {pageSizeOptions.map((size) => (
              <SelectItem key={size} value={size.toString()}>
                {size}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
        <span>{dict.rows}</span>
      </div>

      <div className="text-sm text-gray-600">{resultsText}</div>

      <div className="flex items-center gap-1">
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(1)}
          disabled={currentPage === 1}
        >
          <ChevronsRight className="h-4 w-4" />
        </Button>
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage === 1}
        >
          <ChevronRight className="h-4 w-4" />
        </Button>
        {getPageNumbers().map((page, index) =>
          typeof page === 'number' ? (
            <Button
              key={index}
              variant={currentPage === page ? 'default' : 'outline'}
              size="sm"
              onClick={() => onPageChange(page)}
              className="hidden sm:inline-flex min-w-[32px]"
            >
              {page}
            </Button>
          ) : (
            <span key={index} className="px-2">
              {page}
            </span>
          )
        )}
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage === totalPages}
        >
          <ChevronLeft className="h-4 w-4" />
        </Button>
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(totalPages)}
          disabled={currentPage === totalPages}
        >
          <ChevronsLeft className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
};

export default Pagination;
--- End of Content for Pagination.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\shared\StatusBadge.tsx
--------------------------------------------------------------------------------
Content:
import React from 'react';
import { Badge } from '@/components/ui/badge';
import {
  Circle,
  CheckCircle,
  XCircle,
  Clock,
  AlertTriangle,
} from 'lucide-react';
import { MatchSuggestionStatus, VerificationStatus } from '@prisma/client';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

type StatusType = 'suggestion' | 'verification' | 'profile';
type StatusSize = 'sm' | 'md' | 'lg';

interface StatusConfig {
  label: string;
  color: 'destructive' | 'outline' | 'secondary' | 'success' | 'warning';
  icon:
    | typeof Circle
    | typeof CheckCircle
    | typeof XCircle
    | typeof Clock
    | typeof AlertTriangle;
}

interface StatusBadgeProps {
  type: StatusType;
  status: string;
  size?: StatusSize;
  dict: MatchmakerPageDictionary['statusBadges'];
}

// Presentation logic remains in the component
const statusStyling = {
  // Suggestion Statuses Styling
  DRAFT: { color: 'secondary', icon: Circle },
  PENDING_FIRST_PARTY: { color: 'warning', icon: Clock },
  FIRST_PARTY_APPROVED: { color: 'success', icon: CheckCircle },
  FIRST_PARTY_DECLINED: { color: 'destructive', icon: XCircle },
  PENDING_SECOND_PARTY: { color: 'warning', icon: Clock },
  SECOND_PARTY_APPROVED: { color: 'success', icon: CheckCircle },
  SECOND_PARTY_DECLINED: { color: 'destructive', icon: XCircle },
  AWAITING_MATCHMAKER_APPROVAL: { color: 'warning', icon: Clock },
  CONTACT_DETAILS_SHARED: { color: 'success', icon: CheckCircle },
  AWAITING_FIRST_DATE_FEEDBACK: { color: 'warning', icon: Clock },
  THINKING_AFTER_DATE: { color: 'warning', icon: Clock },
  PROCEEDING_TO_SECOND_DATE: { color: 'success', icon: CheckCircle },
  ENDED_AFTER_FIRST_DATE: { color: 'destructive', icon: XCircle },
  MEETING_PENDING: { color: 'warning', icon: Clock },
  MEETING_SCHEDULED: { color: 'success', icon: CheckCircle },
  MATCH_APPROVED: { color: 'success', icon: CheckCircle },
  MATCH_DECLINED: { color: 'destructive', icon: XCircle },
  DATING: { color: 'secondary', icon: Circle },
  ENGAGED: { color: 'success', icon: CheckCircle },
  MARRIED: { color: 'success', icon: CheckCircle },
  EXPIRED: { color: 'destructive', icon: XCircle },
  CLOSED: { color: 'destructive', icon: XCircle },
  CANCELLED: { color: 'destructive', icon: XCircle },

  // Verification Statuses Styling
  PENDING: { color: 'warning', icon: Clock },
  COMPLETED: { color: 'success', icon: CheckCircle },
  FAILED: { color: 'destructive', icon: XCircle },

  // Profile Statuses Styling
  INCOMPLETE: { color: 'warning', icon: AlertTriangle },
  PENDING_VERIFICATION: { color: 'warning', icon: Clock },
  VERIFIED: { color: 'success', icon: CheckCircle },
  BLOCKED: { color: 'destructive', icon: XCircle },
};

const defaultStyling = {
  color: 'secondary' as const,
  icon: Circle,
};

const getStatusConfig = (
  type: StatusType,
  status: string,
  dict: StatusBadgeProps['dict']
): StatusConfig => {
  let label: string;
  let style;

  switch (type) {
    case 'suggestion':
      label = dict.suggestion[status as MatchSuggestionStatus] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    case 'verification':
      label = dict.verification[status as VerificationStatus] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    case 'profile':
      label = dict.profile[status as keyof typeof dict.profile] || dict.unknown;
      style =
        statusStyling[status as keyof typeof statusStyling] || defaultStyling;
      break;
    default:
      label = dict.unknown;
      style = defaultStyling;
  }

  return { label, ...style };
};

const StatusBadge: React.FC<StatusBadgeProps> = ({
  type,
  status,
  size = 'md',
  dict,
}) => {
  const config = getStatusConfig(type, status, dict);
  const Icon = config.icon;

  const sizeClasses = {
    sm: 'text-xs px-2 py-0.5',
    md: 'text-sm px-2.5 py-1',
    lg: 'text-base px-3 py-1.5',
  };

  return (
    <Badge
      variant={config.color}
      className={`flex items-center gap-1.5 ${sizeClasses[size]}`}
    >
      <Icon className={size === 'sm' ? 'w-3 h-3' : 'w-4 h-4'} />
      <span>{config.label}</span>
    </Badge>
  );
};

export default StatusBadge;
--- End of Content for StatusBadge.tsx ---

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types\candidates.ts
--------------------------------------------------------------------------------
Content:
// candidates.ts
import { Gender, AvailabilityStatus, UserStatus, UserSource  } from '@prisma/client';
import type { UserProfile, UserImage, QuestionnaireResponse} from '@/types/next-auth';

// Base API Response Type
export interface APIResponse<T> {
  success: boolean;
  clients: T[];
  count: number;
  error?: string;
}
//  驻住 驻专 爪 AI
export interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}
// Base Types
export type CandidateImage = UserImage;

export type CandidateProfile = UserProfile;

export type MobileView = 'split' | 'single' | 'double';

export interface Candidate {
  id: string;
  email: string;
  phone?: string | null; 
  firstName: string;
  createdAt: Date;
  lastName: string;
  status: UserStatus;
  isVerified: boolean;
  images: CandidateImage[];
  isProfileComplete: boolean;
  source: UserSource; // Add new field
  addedByMatchmakerId?: string | null; // Add new field
  profile: CandidateProfile; // Ensure this uses the updated CandidateProfile
    suggestionStatus?: {
    status: 'BLOCKED' | 'PENDING';
    suggestionId: string;
    withCandidateName: string;
  } | null;
 aiScore?: number;
  aiReasoning?: string;
  aiRank?: number;
  aiFirstPassScore?: number;
  aiScoreBreakdown?: ScoreBreakdown;
  aiBackgroundMultiplier?: number;
  aiBackgroundCompatibility?: 'excellent' | 'good' | 'possible' | 'problematic' | 'not_recommended';
}
export interface CandidatesFilter {
   source?: UserSource;
  gender?: Gender;
  ageRange?: {
    min: number;
    max: number;
  };
  heightRange?: {
    min: number;
    max: number;
  };
  cities?: string[];
  religiousLevel?: string[];
  occupations?: string[];
  educationLevel?: string;
  maritalStatus?: string;
  availabilityStatus?: AvailabilityStatus | string;
  isVerified?: boolean;
  hasReferences?: boolean;
  lastActiveDays?: number;
  isProfileComplete?: boolean;
  searchQuery?: string;
  savedFilterId?: string;
  separateFiltering?: boolean;
  
  // 住驻转 砖转 驻砖 驻专
  maleSearchQuery?: string;
  femaleSearchQuery?: string;
  
  maleFilters?: Partial<CandidatesFilter>;
  femaleFilters?: Partial<CandidatesFilter>;
  userStatus?: UserStatus;
}

// ViewMode and Action Types -  砖专  砖
export type ViewMode = 'grid' | 'list';
export type CardSize = 'sm' | 'md' | 'lg';
export type CandidateAction = 'suggest' | 'invite' | 'contact' | 'favorite' | 'view' | 'edit';

// Profile Card Types
export interface ProfileCardData {
  profile: CandidateProfile;
  images: CandidateImage[];
  questionnaire?: QuestionnaireResponse;
}

/**
 * 驻 转 拽 注 砖专转  专砖 注专 ProfileCard
 */
export const mapCandidateToProfileCard = (candidate: Candidate): ProfileCardData => {
  return {
    profile: candidate.profile,
    images: candidate.images,
    questionnaire: undefined // 砖 住祝 拽 注转 砖 驻专
  };
};

/**
 * 驻专 注 驻 专
 */
export const separateCandidatesByGender = (candidates: Candidate[]) => {
  return {
    maleCandidates: candidates.filter(c => c.profile.gender === 'MALE'),
    femaleCandidates: candidates.filter(c => c.profile.gender === 'FEMALE')
  };
};

/**
 * 拽  驻专驻 
 */
export const isProfileComplete = (profile: CandidateProfile): boolean => {
  const requiredFields: Array<keyof CandidateProfile> = [
    'birthDate',
    'city',
    'religiousLevel',
    'about',
    'occupation',
    'education'
  ];

  return requiredFields.every(field => Boolean(profile[field]));
};

const candidateUtils = {
  mapCandidateToProfileCard,
  separateCandidatesByGender,
  isProfileComplete
};

export default candidateUtils;
--- End of Content for candidates.ts ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\types\filters.ts
--------------------------------------------------------------------------------
Content:
// src/app/components/matchmaker/new/types/filters.ts

import { Gender, AvailabilityStatus, UserStatus, UserSource  } from '@prisma/client';

// 专转  注专 住驻专
export interface RangeFilter {
  min: number;
  max: number;
}

// 专转 驻专 砖专
export interface SavedFilter {
  id: string;
  name: string;
  filters: FilterState;
  isDefault?: boolean;
  createdAt: Date;
}

export interface FilterState {
  // 住驻转 爪 转爪 驻专转
  separateFiltering: boolean;
    source?: UserSource | undefined;
  // 住驻转 砖转 驻砖 驻专
  maleSearchQuery?: string;
  femaleSearchQuery?: string;

  // 驻专 驻专 专
  maleFilters?: Omit<FilterState, 'gender' | 'maleFilters' | 'femaleFilters' | 
    'separateFiltering' | 'maleSearchQuery' | 'femaleSearchQuery'>;
  
  // 驻专 驻专 砖
  femaleFilters?: Omit<FilterState, 'gender' | 'maleFilters' | 'femaleFilters' | 
    'separateFiltering' | 'maleSearchQuery' | 'femaleSearchQuery'>;

  searchQuery?: string;
  savedFilterId?: string;
  gender?: Gender | undefined;
  ageRange?: RangeFilter;
  heightRange?: RangeFilter;
  cities?: string[];
  occupations?: string[];
  religiousLevel?: string[]; // <--- 砖 -string[]
  educationLevel?: string;
  maritalStatus?: string;
  availabilityStatus?: AvailabilityStatus | string;
  userStatus?: UserStatus;
  isVerified?: boolean;
  hasReferences?: boolean;
  lastActiveDays?: number;
  isProfileComplete?: boolean;
}

// 专转 驻砖专转 驻专
export interface FilterOption {
  key: keyof (FilterState & { education: string });
  value: Gender | AvailabilityStatus | UserStatus | RangeFilter | string[] | string | number | boolean | undefined;
  label: string;
  category?: string;
}

// 专转 拽专转 驻专
export interface FilterCategory {
  id: string;
  label: string;
  filters: Array<keyof (FilterState & { education: string })>;
}

// 专转 驻专驻 拽驻转 驻专
export interface FilterProps {
  filters: FilterState;
  onFiltersChange: (filters: FilterState) => void;
  onReset?: () => void;
  className?: string;
}

// 专转 驻砖专转 驻专
export interface FilterOptions {
  ages: RangeFilter;
  heights: RangeFilter;
  cities: string[];
  religiousLevels: string[];
  educationLevels: string[];
  occupations: string[];
  maritalStatuses: string[];
  availabilityStatuses: AvailabilityStatus[];
}

// 专转 爪 砖拽 砖 驻专
export interface FilterUIState {
  isOpen: boolean;
  activeCategory?: string;
  showSaveDialog: boolean;
  presetName: string;
}

// 专 砖 专注 砖 驻专
export type FilterChangeHandler = (filters: FilterState) => void;

// 专转 专注 砖专转 驻专
export interface SaveFilterHandler {
  (name: string, filters: FilterState): Promise<SavedFilter>;
}

// 专转 专注 注转 驻专
export interface LoadFilterHandler {
  (id: string): void;
}

// 专转 专转 驻专
export interface FilterSettings {
  localStorageKey?: string;
  defaultFilters?: Partial<FilterState>;
  onFilterChange?: FilterChangeHandler;
}

// 专转 转爪转 驻专
export interface FilterResults {
  totalResults: number;
  filteredResults: number;
  categories: Record<string, number>;
}

// 拽住转 砖 驻专
export const DEFAULT_FILTER_STATE: FilterState = {
  separateFiltering: false,
  maleFilters: {},
  femaleFilters: {},
  maleSearchQuery: '',
  femaleSearchQuery: '',
  gender: undefined,
ageRange: undefined,     // : { min: 18, max: 130}
  heightRange: undefined,  // : { min: 80, max: 210 }
  cities: [],
  occupations: [],
  religiousLevel: [],
  educationLevel: undefined,
  maritalStatus: undefined,
  availabilityStatus: undefined,
    source: undefined,
  userStatus: undefined,
  isVerified: undefined,
  hasReferences: undefined,
  lastActiveDays: undefined,
  isProfileComplete: undefined,
  searchQuery: '',
  savedFilterId: undefined
};

// 拽专转 驻专 专转 专砖
export const FILTER_CATEGORIES: FilterCategory[] = [
  {
    id: 'basic',
    label: '驻专 住住',
    filters: ['gender', 'ageRange', 'cities', 'religiousLevel']
  },
  {
    id: 'advanced',
    label: '驻专 转拽',
    filters: ['heightRange', 'occupations', 'educationLevel', 'maritalStatus']
  },
  {
    id: 'status',
    label: '住住 转',
    filters: ['availabilityStatus', 'isVerified', 'hasReferences', 'lastActiveDays']
  }
];

// 驻住 
export type SortDirection = 'asc' | 'desc';

export interface SortOption {
  field: keyof FilterState;
  direction: SortDirection;
  label: string;
}

// 专转 拽抓
export interface GroupOption {
  field: keyof FilterState;
  label: string;
}

export const filterConstants = {
  DEFAULT_FILTER_STATE,
  FILTER_CATEGORIES
};

export default filterConstants;
--- End of Content for filters.ts ---

