################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager
# Generated on: 2026-02-04 15:33:45
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesList.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/CandidatesList.tsx

import React, {
  useState,
  useCallback,
  useEffect,
  useRef,
  useMemo,
} from 'react';
import { UserX, Edit, X } from 'lucide-react';
import MinimalCard from '../CandidateCard/MinimalCard';
import QuickView from '../CandidateCard/QuickView';
import { ProfileCard } from '@/components/profile';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { QuestionnaireResponse } from '@/types/next-auth';
import { Skeleton } from '@/components/ui/skeleton';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { toast } from 'sonner';
import { ActionDialogs } from '../dialogs/ActionDialogs';
import NewSuggestionForm from '../../suggestions/NewSuggestionForm';
import MatchmakerEditProfile from '../MatchmakerEditProfile';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';

// ============================================================================
// TYPES
// ============================================================================

interface CreateSuggestionData {
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';
  firstPartyId: string;
  secondPartyId: string;
  status:
    | 'DRAFT'
    | 'PENDING_FIRST_PARTY'
    | 'FIRST_PARTY_APPROVED'
    | 'FIRST_PARTY_DECLINED'
    | string;
  firstPartyNotes?: string;
  secondPartyNotes?: string;
  firstPartyLanguage?: 'he' | 'en';
  secondPartyLanguage?: 'he' | 'en';
}

interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

type CandidateWithAiData = Candidate & {
  aiScore?: number;
  aiReasoning?: string;
  aiRank?: number;
  aiFirstPassScore?: number;
  aiScoreBreakdown?: ScoreBreakdown;
  aiBackgroundMultiplier?: number;
  aiBackgroundCompatibility?:
    | 'excellent'
    | 'good'
    | 'possible'
    | 'problematic'
    | 'not_recommended';
  aiSimilarity?: number;
};

interface CandidatesListProps {
  candidates: CandidateWithAiData[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void;
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void;
  onCandidateClick?: (candidate: Candidate) => void;
  onCandidateAction?: (type: CandidateAction, candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  highlightTerm?: string;
  aiTargetCandidate: Candidate | null;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  quickViewSide?: 'left' | 'right' | 'center';
  isQuickViewEnabled: boolean;
  locale: string;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

// ============================================================================
// COMPONENT
// ============================================================================

const CandidatesList: React.FC<CandidatesListProps> = ({
  candidates,
  allCandidates,
  locale,
  onCandidateClick,
  onCandidateAction,
  isQuickViewEnabled,
  onOpenAiAnalysis,
  onSendProfileFeedback,
  viewMode,
  mobileView,
  isLoading = false,
  className,
  highlightTerm,
  aiTargetCandidate,
  onSetAiTarget,
  comparisonSelection,
  onToggleComparison,
  quickViewSide = 'center',
  dict,
  profileDict,
}) => {
  // Base states
  const [selectedCandidate, setSelectedCandidate] = useState<Candidate | null>(null);
  const [questionnaireResponse, setQuestionnaireResponse] = useState<QuestionnaireResponse | null>(null);
  const [isMatchmaker, setIsMatchmaker] = useState(true);
  const [hoveredCandidate, setHoveredCandidate] = useState<CandidateWithAiData | null>(null);
  const [hoverPosition, setHoverPosition] = useState({ top: 0, left: 0 });
  const hoverTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const quickViewRef = useRef<HTMLDivElement>(null);
  
  // Store scroll position before opening dialogs
  const scrollPositionRef = useRef<number>(0);
  const containerRef = useRef<HTMLDivElement>(null);

  // Dialog states
  const [showInviteDialog, setShowInviteDialog] = useState(false);
  const [showAvailabilityDialog, setShowAvailabilityDialog] = useState(false);
  const [showSuggestDialog, setShowSuggestDialog] = useState(false);
  const [showEditProfileDialog, setShowEditProfileDialog] = useState(false);
  const [dialogCandidate, setDialogCandidate] = useState<Candidate | null>(null);

  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    if (selectedCandidate) {
      console.log('[DEBUG] selectedCandidate:', selectedCandidate.firstName);
      console.log('[DEBUG] selectedCandidate.images:', selectedCandidate.images);
      console.log('[DEBUG] images count:', selectedCandidate.images?.length);
    }
  }, [selectedCandidate]);

  useEffect(() => {
    const checkScreenSize = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => {
      window.removeEventListener('resize', checkScreenSize);
    };
  }, []);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        hoveredCandidate &&
        quickViewRef.current &&
        !quickViewRef.current.contains(event.target as Node)
      ) {
        setHoveredCandidate(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [hoveredCandidate]);

  useEffect(() => {
    return () => {
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
      }
    };
  }, []);

  useEffect(() => {
    const loadQuestionnaire = async () => {
      if (!selectedCandidate) {
        setQuestionnaireResponse(null);
        return;
      }
      try {
        const params = new URLSearchParams();
        params.append('userId', selectedCandidate.id);
        params.append('locale', locale);

        const response = await fetch(`/api/profile/questionnaire?${params.toString()}`);
        const data = await response.json();
        if (data.success && data.questionnaireResponse) {
          setQuestionnaireResponse(data.questionnaireResponse);
        } else {
          console.warn('Could not load questionnaire:', data.message);
          setQuestionnaireResponse(null);
        }
      } catch (error) {
        console.error('Failed to load questionnaire:', error);
        toast.error('שגיאה בטעינת השאלון');
      }
    };
    loadQuestionnaire();
  }, [selectedCandidate, locale]);

  useEffect(() => {
    if (selectedCandidate) {
      console.log('[CandidatesList] selectedCandidate.images:', selectedCandidate.images);
    }
  }, [selectedCandidate]);

  // Action handlers
  const handleInvite = async (candidate: Candidate, email: string) => {
    try {
      const response = await fetch(
        `/api/matchmaker/candidates/${candidate.id}/invite-setup`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ candidateId: candidate.id, email }),
        }
      );
      if (!response.ok) throw new Error('Failed to send invitation');
      toast.success('ההזמנה נשלחה בהצלחה');
      onCandidateAction?.('invite', candidate);
    } catch (error) {
      console.error('Error sending invite:', error);
      throw error;
    }
  };

  const handleAvailabilityCheck = async (candidate: Candidate) => {
    try {
      const response = await fetch('/api/availability/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId: candidate.id }),
      });
      if (!response.ok) throw new Error('Failed to check availability');
      toast.success('בדיקת הזמינות נשלחה');
      onCandidateAction?.('contact', candidate);
    } catch (error) {
      console.error('Error checking availability:', error);
      throw error;
    }
  };

  const handleCreateSuggestion = async (data: CreateSuggestionData) => {
    try {
      const response = await fetch(`/api/matchmaker/suggestions?locale=${locale}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) throw new Error('Failed to create suggestion');
      toast.success('ההצעה נוצרה בהצלחה');
      onCandidateAction?.('suggest', dialogCandidate!);
    } catch (error) {
      console.error('Error creating suggestion:', error);
      throw error;
    }
  };

  // Save scroll position before opening edit dialog
  const handleEditProfile = (candidate: Candidate) => {
    // Save current scroll position
    const scrollContainer = containerRef.current?.closest('.overflow-y-auto, [data-radix-scroll-area-viewport]');
    if (scrollContainer) {
      scrollPositionRef.current = scrollContainer.scrollTop;
    } else {
      scrollPositionRef.current = window.scrollY;
    }
    
    setDialogCandidate(candidate);
    setShowEditProfileDialog(true);
  };

  // Restore scroll position when edit dialog closes
  const handleCloseEditProfile = useCallback(() => {
    setShowEditProfileDialog(false);
    
    // Restore scroll position after dialog closes
    requestAnimationFrame(() => {
      const scrollContainer = containerRef.current?.closest('.overflow-y-auto, [data-radix-scroll-area-viewport]');
      if (scrollContainer) {
        scrollContainer.scrollTop = scrollPositionRef.current;
      } else {
        window.scrollTo(0, scrollPositionRef.current);
      }
    });
  }, []);

  const handleMouseEnter = (candidate: CandidateWithAiData, e?: React.MouseEvent) => {
    if (isMobile || !e || !isQuickViewEnabled) return;

    if (isMobile || !e) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
    }
    const cardElement = e.currentTarget as HTMLElement;
    const cardRect = cardElement.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const padding = 20;
    const quickViewApproxHeight = Math.min(650, viewportHeight * 0.85);
    let top;
    if (cardRect.top + quickViewApproxHeight > viewportHeight - padding) {
      top = cardElement.offsetTop + cardRect.height - quickViewApproxHeight;
    } else {
      top = cardElement.offsetTop;
    }
    const scrollContainer = cardElement.closest('.overflow-y-auto');
    if (scrollContainer) {
      top = Math.max(top, scrollContainer.scrollTop);
    }
    let left;
    const quickViewWidth = 420;
    switch (quickViewSide) {
      case 'left':
        left = window.innerWidth / 4 - quickViewWidth / 2;
        break;
      case 'right':
        left = (window.innerWidth * 3) / 4 - quickViewWidth / 2 - 470;
        break;
      case 'center':
      default:
        left = window.innerWidth / 2 - quickViewWidth / 2;
        break;
    }
    left = Math.max(padding, Math.min(left, window.innerWidth - quickViewWidth - padding));
    hoverTimeoutRef.current = setTimeout(() => {
      setHoverPosition({ top, left });
      setHoveredCandidate(candidate);
    }, 300);
  };

  const handleMouseLeave = () => {
    if (isMobile) return;
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
      hoverTimeoutRef.current = null;
    }
    setTimeout(() => {
      if (!quickViewRef.current?.matches(':hover')) {
        setHoveredCandidate(null);
      }
    }, 100);
  };

  const handleAction = useCallback(
    (action: CandidateAction | 'analyze' | 'sendFeedback', candidate: Candidate) => {
      setDialogCandidate(candidate);
      setHoveredCandidate(null);
      switch (action) {
        case 'invite':
          setShowInviteDialog(true);
          break;
        case 'contact':
          setShowAvailabilityDialog(true);
          break;
        case 'suggest':
          setShowSuggestDialog(true);
          break;
        case 'view':{ 
          // Save scroll position before opening view dialog
          const scrollContainer = containerRef.current?.closest('.overflow-y-auto, [data-radix-scroll-area-viewport]');
          if (scrollContainer) {
            scrollPositionRef.current = scrollContainer.scrollTop;
          } else {
            scrollPositionRef.current = window.scrollY;
          }
          setSelectedCandidate(candidate);
          onCandidateClick?.(candidate);
          break;
        }
        case 'edit':
          handleEditProfile(candidate);
          break;
        case 'analyze':
          onOpenAiAnalysis(candidate);
          break;
        case 'sendFeedback':
          if (onSendProfileFeedback) {
            onSendProfileFeedback(candidate);
          }
          break;
        default:
          onCandidateAction?.(action as CandidateAction, candidate);
      }
    },
    [onCandidateAction, onCandidateClick, onOpenAiAnalysis, onSendProfileFeedback]
  );

  // Handle profile dialog close with scroll restoration
  const handleCloseProfileDialog = useCallback((open: boolean) => {
    if (!open) {
      setSelectedCandidate(null);
      setQuestionnaireResponse(null);
      
      // Restore scroll position
      requestAnimationFrame(() => {
        const scrollContainer = containerRef.current?.closest('.overflow-y-auto, [data-radix-scroll-area-viewport]');
        if (scrollContainer) {
          scrollContainer.scrollTop = scrollPositionRef.current;
        } else {
          window.scrollTo(0, scrollPositionRef.current);
        }
      });
    }
  }, []);

  const gridLayoutClass = useMemo(() => {
    if (isMobile) {
      return mobileView === 'double'
        ? 'grid grid-cols-2 gap-2'
        : 'grid grid-cols-1 gap-3';
    }
    return viewMode === 'grid'
      ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-3 gap-y-4'
      : 'space-y-4';
  }, [isMobile, mobileView, viewMode]);

  if (isLoading) {
    return (
      <div
        className={`${
          viewMode === 'grid'
            ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
            : 'space-y-4'
        } ${className || ''}`}
      >
        {Array.from({ length: 6 }).map((_, i) => (
          <div key={i} className="relative">
            <Skeleton className={viewMode === 'list' ? 'h-32 w-full' : 'h-[350px] w-full'} />
            <div className="absolute top-3 right-3">
              <Skeleton className="h-6 w-16 rounded-full" />
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (candidates.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-32 bg-gray-50 rounded-lg border border-dashed border-gray-300 p-4 text-center">
        <UserX className="w-8 h-8 mb-2 text-gray-400" />
        <p className="text-sm font-medium text-gray-500 mb-1">
          {dict.candidatesManager.list.emptyState.title}
        </p>
        <p className="text-xs text-gray-400">
          {dict.candidatesManager.list.emptyState.description}
        </p>
      </div>
    );
  }

  return (
    <>
      <div ref={containerRef} className={cn(gridLayoutClass, className || '')}>
        {candidates.map((candidate) => (
          <div
            key={candidate.id}
            className="group relative"
            onMouseEnter={(e) => handleMouseEnter(candidate, e)}
            onMouseLeave={handleMouseLeave}
            onClick={() => handleAction('view', candidate)}
          >
            <MinimalCard
              candidate={candidate}
              onClick={() => handleAction('view', candidate)}
              onAnalyze={(c, e) => {
                e.stopPropagation();
                handleAction('analyze', c);
              }}
              aiTargetName={
                aiTargetCandidate
                  ? `${aiTargetCandidate.firstName} ${aiTargetCandidate.lastName}`
                  : undefined
              }
              onSendProfileFeedback={(c, e) => {
                e.stopPropagation();
                handleAction('sendFeedback', c);
              }}
              onEdit={(c, e) => {
                e.stopPropagation();
                handleAction('edit', c);
              }}
              className={cn(
                viewMode === 'list' && !isMobile ? 'flex flex-row-reverse gap-4 h-32' : '',
                isMobile && mobileView === 'double' ? 'transform scale-90' : '',
                isMobile && mobileView === 'single' ? 'transform scale-95' : ''
              )}
              highlightTerm={highlightTerm}
              aiScore={candidate.aiScore}
              onSetAiTarget={onSetAiTarget}
              isAiTarget={aiTargetCandidate?.id === candidate.id}
              isSelectableForComparison={
                !!aiTargetCandidate &&
                aiTargetCandidate.profile.gender !== candidate.profile.gender &&
                aiTargetCandidate.id !== candidate.id
              }
              isSelectedForComparison={!!comparisonSelection[candidate.id]}
              onToggleComparison={onToggleComparison}
              dict={dict.candidatesManager.list.minimalCard}
            />
            <button
              className="absolute top-2 left-2 bg-primary text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
              onClick={(e) => {
                e.stopPropagation();
                handleAction('edit', candidate);
              }}
              aria-label={dict.candidatesManager.list.editProfileTooltip}
              title={dict.candidatesManager.list.editProfileTooltip}
            >
              <Edit className="w-4 h-4" />
            </button>
          </div>
        ))}
      </div>

      {isQuickViewEnabled && hoveredCandidate && !isMobile && (
        <div
          ref={quickViewRef}
          className="absolute z-[70]"
          style={{
            top: `${hoverPosition.top}px`,
            left: `${hoverPosition.left}px`,
            width: '420px',
          }}
        >
          <div className="drop-shadow-2xl">
            <QuickView
              candidate={hoveredCandidate}
              onAction={(action) => handleAction(action, hoveredCandidate)}
              onSetAiTarget={(c, e) => onSetAiTarget(c, e)}
              isAiTarget={aiTargetCandidate?.id === hoveredCandidate.id}
              dict={dict.candidatesManager.list.quickView}
              aiScore={hoveredCandidate.aiScore}
              aiReasoning={hoveredCandidate.aiReasoning}
              aiRank={hoveredCandidate.aiRank}
              aiSimilarity={hoveredCandidate.aiSimilarity}
            />
          </div>
        </div>
      )}

      {/* --- Main Profile Dialog --- */}
      <Dialog open={!!selectedCandidate} onOpenChange={handleCloseProfileDialog}>
        <DialogContent
          className="max-w-6xl max-h-[90vh] overflow-y-auto p-0"
          dir={locale === 'he' ? 'rtl' : 'ltr'}
          onCloseAutoFocus={(e) => {
            e.preventDefault(); // Prevent focus restoration that causes scroll jump
          }}
          onEscapeKeyDown={() => {
            // Will trigger onOpenChange with false
          }}
        >
          {/* Custom Sticky Header */}
          <div className="sticky top-0 z-50 flex items-center justify-between px-6 py-4 bg-white/95 backdrop-blur-sm border-b border-gray-100">
            <div className="flex items-center gap-3">
              <DialogTitle className="text-xl font-bold text-gray-800">
                {selectedCandidate
                  ? `${selectedCandidate.firstName} ${selectedCandidate.lastName}`
                  : ''}
              </DialogTitle>
              {selectedCandidate?.isVerified && (
                <Badge variant="secondary" className="bg-emerald-100 text-emerald-700">
                  מאומת
                </Badge>
              )}
            </div>

            <div className="flex items-center gap-2">
              <Select
                value={isMatchmaker ? 'matchmaker' : 'candidate'}
                onValueChange={(value) => setIsMatchmaker(value === 'matchmaker')}
              >
                <SelectTrigger className="w-[140px] h-9">
                  <SelectValue placeholder={dict.candidatesManager.list.profileDialog.viewAsLabel} />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="candidate">
                    {dict.candidatesManager.list.profileDialog.candidateView}
                  </SelectItem>
                  <SelectItem value="matchmaker">
                    {dict.candidatesManager.list.profileDialog.matchmakerView}
                  </SelectItem>
                </SelectContent>
              </Select>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleAction('edit', selectedCandidate!)}
                className="h-9 w-9 p-0 rounded-full hover:bg-gray-100"
                title={dict.candidatesManager.list.profileDialog.editButton}
              >
                <Edit className="w-4 h-4 text-gray-600" />
              </Button>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleCloseProfileDialog(false)}
                className="h-9 w-9 p-0 rounded-full hover:bg-red-50 hover:text-red-600"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>
          </div>

          {selectedCandidate && (
            <div className="p-0">
              <ProfileCard
                profile={selectedCandidate.profile}
                images={selectedCandidate.images}
                questionnaire={questionnaireResponse}
                viewMode={isMatchmaker ? 'matchmaker' : 'candidate'}
                isProfileComplete={selectedCandidate.isProfileComplete}
                dict={profileDict.profileCard}
                locale={locale}
                onClose={() => handleCloseProfileDialog(false)}
              />
            </div>
          )}
        </DialogContent>
      </Dialog>

      <ActionDialogs
        suggestDialog={{
          isOpen: showSuggestDialog,
          onClose: () => setShowSuggestDialog(false),
          onSubmit: handleCreateSuggestion,
          selectedCandidate: dialogCandidate,
        }}
        availabilityDialog={{
          isOpen: showAvailabilityDialog,
          onClose: () => setShowAvailabilityDialog(false),
          onCheck: handleAvailabilityCheck,
          selectedCandidate: dialogCandidate,
        }}
        inviteDialog={{
          isOpen: showInviteDialog,
          onClose: () => setShowInviteDialog(false),
          onInvite: handleInvite,
          selectedCandidate: dialogCandidate,
        }}
        dict={dict.candidatesManager.actionDialogs}
      />

      <NewSuggestionForm
        isOpen={showSuggestDialog}
        onClose={() => setShowSuggestDialog(false)}
        candidates={allCandidates}
        selectedCandidate={dialogCandidate}
        onSubmit={handleCreateSuggestion}
        dict={dict}
        locale={locale}
      />

      <MatchmakerEditProfile
        isOpen={showEditProfileDialog}
        onClose={handleCloseEditProfile}
        candidate={dialogCandidate}
        dict={dict.candidatesManager.editProfile}
        profileDict={profileDict}
        locale={locale}
      />
    </>
  );
};

export default CandidatesList;
--- End of Content for CandidatesList.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesManager_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\CandidatesStats.tsx
--------------------------------------------------------------------------------
Content:
// /CandidatesManager/CandidatesStats.tsx

'use client';

import React from 'react';

import { Card, CardContent } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import {
  Users,
  UserCheck,
  Clock,
  MapPin,
  CheckCircle,
  Image as ImageIcon,
  TrendingUp,
  ArrowUp,
  ArrowDown,
  Activity,
  Heart,
  Star,
  Award,
  Sparkles,
  Target,
  Crown,
  Zap,
} from 'lucide-react';
import { useStatistics } from '../hooks/useStatistics';
import type { Candidate } from '../types/candidates';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts';
import { cn } from '@/lib/utils';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';

interface StatCardProps {
  title: string;
  value: string | number;
  description?: string;
  icon: React.ReactNode;
  trend?: {
    value: number;
    isPositive: boolean;
  };
  className?: string;
  gradient: string;
  iconColor: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats']['mainStats']['trend'];
}

interface CandidatesStatsProps {
  candidates: Candidate[];
  className?: string;
  dict: MatchmakerPageDictionary['candidatesManager']['stats'];
}

const CHART_COLORS = [
  '#3B82F6', // כחול
  '#EF4444', // אדום
  '#10B981', // ירוק
  '#F59E0B', // כתום
  '#8B5CF6', // סגול
  '#EC4899', // ורוד
  '#06B6D4', // ציאן
  '#84CC16', // ליים
];

const StatCard: React.FC<StatCardProps> = ({
  title,
  value,
  description,
  icon,
  trend,
  className,
  gradient,
  iconColor,
  dict,
}) => (
  <Card
    className={cn(
      'border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden group hover:shadow-2xl transition-all duration-300 transform hover:scale-105',
      className
    )}
  >
    <CardContent className="p-6 relative">
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/20 to-transparent rounded-full blur-2xl opacity-50"></div>

      <div className="flex items-start justify-between relative z-10">
        <div className="space-y-3 flex-1">
          <p className="text-sm font-medium text-gray-600">{title}</p>
          <div className="flex items-baseline gap-2">
            <p className="text-3xl font-bold text-gray-800">{value}</p>
            {trend && (
              <div
                className={cn(
                  'flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold',
                  trend.isPositive
                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-700'
                    : 'bg-gradient-to-r from-red-100 to-pink-100 text-red-700'
                )}
              >
                {trend.isPositive ? (
                  <ArrowUp className="w-3 h-3" />
                ) : (
                  <ArrowDown className="w-3 h-3" />
                )}
                <span>{Math.abs(trend.value)}%</span>
              </div>
            )}
          </div>
          {description && (
            <p className="text-sm text-gray-500 leading-relaxed">
              {description}
            </p>
          )}
          {trend && (
            <p className="text-xs text-gray-400">
              {trend.isPositive ? dict.increase : dict.decrease} {dict.period}
            </p>
          )}
        </div>

        <div
          className={cn(
            'p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform duration-300',
            `bg-gradient-to-r ${gradient}`
          )}
        >
          <div className={iconColor}>{icon}</div>
        </div>
      </div>
    </CardContent>
  </Card>
);

const EnhancedChartCard: React.FC<{
  title: string;
  children: React.ReactNode;
  description?: string;
  gradient?: string;
  icon?: React.ReactNode;
}> = ({
  title,
  children,
  description,
  gradient = 'from-blue-500 to-cyan-500',
  icon,
}) => (
  <Card className="border-0 shadow-xl bg-gradient-to-br from-white via-gray-50/30 to-white overflow-hidden hover:shadow-2xl transition-all duration-300">
    <CardContent className="p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          {icon && (
            <div
              className={cn(
                'p-3 rounded-full shadow-lg',
                `bg-gradient-to-r ${gradient}`
              )}
            >
              <div className="text-white">{icon}</div>
            </div>
          )}
          <div>
            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
            {description && (
              <p className="text-sm text-gray-500 mt-1">{description}</p>
            )}
          </div>
        </div>
      </div>
      {children}
    </CardContent>
  </Card>
);

const CandidatesStats: React.FC<CandidatesStatsProps> = ({
  candidates,
  className,
  dict,
}) => {
  const {
    stats,
    getGenderRatio,
    getTopCities,
    getActiveUsersPercent,
    getAgeGroupDistribution,
    getReligiousDistribution,
    getActivityTrend,
    getProfileCompletionStats,
  } = useStatistics(candidates);

  const genderRatio = getGenderRatio();
  const activeUsers = getActiveUsersPercent();
  const completionStats = getProfileCompletionStats();
  const ageDistribution = getAgeGroupDistribution();
  const religiousDistribution = getReligiousDistribution();
  const activityTrend = getActivityTrend();
  const topCities = getTopCities(5);

  return (
    <div className={cn('space-y-8', className)}>
      <div className="relative min-h-[200px] bg-gradient-to-br from-purple-50 via-cyan-50/30 to-emerald-50/20 overflow-hidden rounded-3xl shadow-2xl p-8">
        <div className="absolute inset-0">
          <div className="absolute top-10 right-10 w-64 h-64 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-3xl animate-float"></div>
          <div
            className="absolute bottom-10 left-10 w-48 h-48 bg-gradient-to-br from-cyan-200/30 to-blue-200/30 rounded-full blur-2xl animate-float"
            style={{ animationDelay: '2s' }}
          ></div>
        </div>

        <div className="relative z-10 text-center">
          <div className="inline-flex items-center gap-3 mb-6">
            <div className="p-4 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg">
              <Activity className="w-10 h-10" />
            </div>
          </div>
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent mb-4">
            {dict.hero.title}
          </h1>
          <p className="text-xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
            {dict.hero.subtitle}
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title={dict.mainStats.total.title}
          value={stats.gender.total}
          icon={<Users className="w-8 h-8" />}
          description={dict.mainStats.total.description}
          gradient="from-blue-500 to-cyan-500"
          iconColor="text-white"
          trend={{ value: 12, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.ratio.title}
          value={genderRatio.formattedRatio}
          icon={<UserCheck className="w-8 h-8" />}
          description={dict.mainStats.ratio.description}
          gradient="from-purple-500 to-pink-500"
          iconColor="text-white"
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.activity.title}
          value={`${activeUsers}%`}
          icon={<Clock className="w-8 h-8" />}
          gradient="from-green-500 to-emerald-500"
          iconColor="text-white"
          trend={{ value: 8, isPositive: true }}
          dict={dict.mainStats.trend}
        />
        <StatCard
          title={dict.mainStats.completion.title}
          value={`${completionStats.percentage}%`}
          icon={<CheckCircle className="w-8 h-8" />}
          description={dict.mainStats.completion.description
            .replace('{{completed}}', completionStats.completed.toString())
            .replace('{{total}}', stats.gender.total.toString())}
          gradient="from-orange-500 to-amber-500"
          iconColor="text-white"
          trend={{ value: 5, isPositive: true }}
          dict={dict.mainStats.trend}
        />
      </div>

      <Tabs defaultValue="demographics" className="w-full">
        <TabsList className="bg-purple-50/50 rounded-2xl p-1.5 h-auto shadow-lg border border-white/50 grid w-full grid-cols-3">
          <TabsTrigger
            value="demographics"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Users className="w-5 h-5" />
            {dict.tabs.demographics}
          </TabsTrigger>
          <TabsTrigger
            value="activity"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Activity className="w-5 h-5" />
            {dict.tabs.activity}
          </TabsTrigger>
          <TabsTrigger
            value="completion"
            className="flex items-center gap-2 rounded-xl transition-all duration-300 py-3 hover:scale-105 data-[state=active]:bg-white data-[state=active]:shadow-lg font-semibold"
          >
            <Target className="w-5 h-5" />
            {dict.tabs.completion}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="demographics" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.ageDistribution.title}
              description={dict.charts.ageDistribution.description}
              gradient="from-blue-500 to-cyan-500"
              icon={<Users className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={ageDistribution}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                  <XAxis
                    dataKey="range"
                    tick={{ fontSize: 12 }}
                    stroke="#666"
                  />
                  <YAxis tick={{ fontSize: 12 }} stroke="#666" />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                  <Bar
                    dataKey="count"
                    fill="url(#blueGradient)"
                    radius={[4, 4, 0, 0]}
                  />
                  <defs>
                    <linearGradient
                      id="blueGradient"
                      x1="0"
                      y1="0"
                      x2="0"
                      y2="1"
                    >
                      <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.8} />
                      <stop
                        offset="95%"
                        stopColor="#06B6D4"
                        stopOpacity={0.6}
                      />
                    </linearGradient>
                  </defs>
                </BarChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.religiousDistribution.title}
              description={dict.charts.religiousDistribution.description}
              gradient="from-purple-500 to-pink-500"
              icon={<Heart className="w-6 h-6" />}
            >
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={religiousDistribution}
                    dataKey="count"
                    nameKey="level"
                    cx="50%"
                    cy="50%"
                    outerRadius={100}
                    innerRadius={40}
                    paddingAngle={2}
                    label={({ name, percent }) =>
                      `${name} ${(percent * 100).toFixed(0)}%`
                    }
                  >
                    {religiousDistribution.map((_, index) => (
                      <Cell
                        key={`cell-${index}`}
                        fill={CHART_COLORS[index % CHART_COLORS.length]}
                      />
                    ))}
                  </Pie>
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.topCities.title}
              description={dict.charts.topCities.description}
              gradient="from-green-500 to-emerald-500"
              icon={<MapPin className="w-6 h-6" />}
            >
              <div className="space-y-4">
                {topCities.map((city, index) => (
                  <div
                    key={city.city}
                    className="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 hover:shadow-md transition-all duration-300"
                  >
                    <div className="flex items-center gap-3">
                      <div
                        className={cn(
                          'w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg',
                          index === 0
                            ? 'bg-gradient-to-r from-yellow-400 to-orange-500'
                            : index === 1
                              ? 'bg-gradient-to-r from-gray-400 to-gray-500'
                              : index === 2
                                ? 'bg-gradient-to-r from-orange-400 to-red-500'
                                : 'bg-gradient-to-r from-green-400 to-emerald-500'
                        )}
                      >
                        {index + 1}
                      </div>
                      <div className="flex items-center gap-2">
                        <MapPin className="w-4 h-4 text-green-600" />
                        <span className="font-medium text-gray-800">
                          {city.city}
                        </span>
                      </div>
                    </div>
                    <Badge className="bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {city.count}
                    </Badge>
                  </div>
                ))}
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="activity" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.userActivity.title}
              description={dict.charts.userActivity.description}
              gradient="from-orange-500 to-amber-500"
              icon={<Activity className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-orange-800">
                        {dict.charts.userActivity.weeklyActive}
                      </span>
                      <TrendingUp className="w-4 h-4 text-orange-600" />
                    </div>
                    <span className="text-2xl font-bold text-orange-900">
                      {activityTrend.weekly}
                    </span>
                  </div>
                  <div className="p-4 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl border border-amber-100">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-amber-800">
                        {dict.charts.userActivity.monthlyActive}
                      </span>
                      <Activity className="w-4 h-4 text-amber-600" />
                    </div>
                    <span className="text-2xl font-bold text-amber-900">
                      {activityTrend.monthly}
                    </span>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-100">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-yellow-800">
                      {dict.charts.userActivity.avgLogin}
                    </span>
                    <Clock className="w-4 h-4 text-yellow-600" />
                  </div>
                  <span className="text-2xl font-bold text-yellow-900">
                    {activityTrend.average} {dict.charts.userActivity.days}
                  </span>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.activityTrend.title}
              description={dict.charts.activityTrend.description}
              gradient="from-indigo-500 to-purple-500"
              icon={<Star className="w-6 h-6" />}
            >
              <div className="flex items-center justify-center h-64 text-gray-500">
                <div className="text-center">
                  <Sparkles className="w-12 h-12 mx-auto mb-4 text-indigo-400" />
                  <p>{dict.charts.activityTrend.comingSoon}</p>
                  <p className="text-sm">
                    {dict.charts.activityTrend.subtitle}
                  </p>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>

        <TabsContent value="completion" className="mt-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <EnhancedChartCard
              title={dict.charts.profileCompletion.title}
              description={dict.charts.profileCompletion.description}
              gradient="from-red-500 to-pink-500"
              icon={<Target className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg">
                        <ImageIcon className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasPhotos}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-red-500 to-pink-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasPhotos}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl border border-pink-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg">
                        <CheckCircle className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.isVerified}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-pink-500 to-rose-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.isVerified}%
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gradient-to-r from-rose-50 to-red-50 rounded-xl border border-rose-100 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full bg-gradient-to-r from-rose-500 to-red-500 text-white shadow-lg">
                        <Users className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-800">
                        {dict.charts.profileCompletion.hasReferences}
                      </span>
                    </div>
                    <Badge className="bg-gradient-to-r from-rose-500 to-red-500 text-white border-0 shadow-sm px-3 py-1 font-bold">
                      {stats.completion.percentages.hasReferences}%
                    </Badge>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>

            <EnhancedChartCard
              title={dict.charts.performance.title}
              description={dict.charts.performance.description}
              gradient="from-emerald-500 to-green-500"
              icon={<Award className="w-6 h-6" />}
            >
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="text-center p-4 bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl border border-emerald-100">
                    <Crown className="w-8 h-8 mx-auto mb-2 text-emerald-600" />
                    <div className="text-2xl font-bold text-emerald-800">
                      A+
                    </div>
                    <div className="text-sm text-emerald-600">
                      {dict.charts.performance.qualityRating}
                    </div>
                  </div>
                  <div className="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                    <Zap className="w-8 h-8 mx-auto mb-2 text-green-600" />
                    <div className="text-2xl font-bold text-green-800">95%</div>
                    <div className="text-sm text-green-600">
                      {dict.charts.performance.satisfaction}
                    </div>
                  </div>
                </div>
                <div className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                  <div className="flex items-center justify-between mb-3">
                    <span className="font-medium text-blue-800">
                      {dict.charts.performance.monthlyProgress}
                    </span>
                    <TrendingUp className="w-4 h-4 text-blue-600" />
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.newCandidates}
                      </span>
                      <span className="font-bold text-blue-800">+12%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.activity}
                      </span>
                      <span className="font-bold text-blue-800">+8%</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-blue-700">
                        {dict.charts.performance.profileCompletion}
                      </span>
                      <span className="font-bold text-blue-800">+5%</span>
                    </div>
                  </div>
                </div>
              </div>
            </EnhancedChartCard>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default CandidatesStats;
--- End of Content for CandidatesStats.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\SplitView.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/SplitView.tsx
'use client';

import React, { useMemo, useEffect, useState, useCallback } from 'react';
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from '@/components/ui/resizable';
import CandidatesList from './CandidatesList';
import { Badge } from '@/components/ui/badge';
import {
  Sparkles,
  XCircle,
  Target,
  Crown,
  Zap,
  Search,
  Loader2,
  RefreshCw,
  Database,
  Clock,
  Brain,
  MessageSquare,
  CheckCircle2,
  X,
  Users,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import type {
  Candidate,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import type { FilterState } from '../types/filters';
import SearchBar from '../Filters/SearchBar';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import { Gender } from '@prisma/client';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';
import { motion, AnimatePresence } from 'framer-motion';

// 🆕 Import the global context
import {
  useMatchingJobContext,
  type SearchMethod,
  type MatchResult,
} from '@/app/[locale]/contexts/MatchingJobContext';

// ============================================================================
// TYPES & INTERFACES
// ============================================================================

type BackgroundCompatibility =
  | 'excellent'
  | 'good'
  | 'possible'
  | 'problematic'
  | 'not_recommended';

interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

interface AiMatch {
  userId: string;
  firstName?: string;
  lastName?: string;
  score?: number;
  firstPassScore?: number;
  finalScore?: number;
  scoreBreakdown?: ScoreBreakdown;
  reasoning?: string;
  shortReasoning?: string;
  detailedReasoning?: string;
  rank?: number;
  backgroundMultiplier?: number;
  backgroundCompatibility?: BackgroundCompatibility;
  similarity?: number;
}

interface AiMatchMeta {
  fromCache: boolean;
  savedAt?: string;
  isStale?: boolean;
  algorithmVersion: string;
  totalCandidatesScanned?: number;
  durationMs?: number;
}

type CandidateWithAiData = Candidate & {
  aiScore?: number;
  aiReasoning?: string;
  aiMatch?: AiMatch;
  aiRank?: number;
  aiFirstPassScore?: number;
  aiScoreBreakdown?: ScoreBreakdown;
  aiBackgroundMultiplier?: number;
  aiBackgroundCompatibility?: BackgroundCompatibility;
  aiSimilarity?: number;
};

interface SplitViewProps {
  isQuickViewEnabled: boolean;
  maleCandidates: Candidate[];
  femaleCandidates: Candidate[];
  allCandidates: Candidate[];
  onOpenAiAnalysis: (candidate: Candidate) => void;
  onSendProfileFeedback: (candidate: Candidate, e?: React.MouseEvent) => void;
  onCandidateAction: (type: CandidateAction, candidate: Candidate) => void;
  onCandidateClick: (candidate: Candidate) => void;
  viewMode: 'grid' | 'list';
  mobileView: MobileView;
  isLoading?: boolean;
  className?: string;
  locale: string;
  aiTargetCandidate: Candidate | null;
  aiMatches: AiMatch[];
  isAiLoading: boolean;
  onSetAiTarget: (candidate: Candidate, e: React.MouseEvent) => void;
  onClearAiTarget: (e: React.MouseEvent) => void;
  setAiMatches: React.Dispatch<React.SetStateAction<AiMatch[]>>;
  setIsAiLoading: React.Dispatch<React.SetStateAction<boolean>>;
  comparisonSelection: Record<string, Candidate>;
  onToggleComparison: (candidate: Candidate, e: React.MouseEvent) => void;
  separateFiltering: boolean;
  maleFilters?: Partial<FilterState>;
  femaleFilters?: Partial<FilterState>;
  onMaleFiltersChange: (filters: Partial<FilterState>) => void;
  onFemaleFiltersChange: (filters: Partial<FilterState>) => void;
  onCopyFilters: (source: 'male' | 'female', target: 'male' | 'female') => void;
  maleSearchQuery?: string;
  femaleSearchQuery?: string;
  onMaleSearchChange?: (query: string) => void;
  onFemaleSearchChange?: (query: string) => void;
  dict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
}

// ============================================================================
// SCORE BREAKDOWN DISPLAY COMPONENT
// ============================================================================

const ScoreBreakdownDisplay: React.FC<{
  breakdown: ScoreBreakdown;
  className?: string;
}> = ({ breakdown, className }) => {
  const categories = [
    { key: 'religious', label: 'התאמה דתית', max: 35, color: 'bg-purple-500' },
    {
      key: 'careerFamily',
      label: 'קריירה-משפחה',
      max: 15,
      color: 'bg-blue-500',
    },
    { key: 'lifestyle', label: 'סגנון חיים', max: 15, color: 'bg-green-500' },
    { key: 'ambition', label: 'שאפתנות', max: 12, color: 'bg-orange-500' },
    { key: 'communication', label: 'תקשורת', max: 12, color: 'bg-cyan-500' },
    { key: 'values', label: 'ערכים', max: 11, color: 'bg-pink-500' },
  ];

  return (
    <div className={cn('space-y-1.5', className)}>
      {categories.map((cat) => {
        const value = breakdown[cat.key as keyof ScoreBreakdown] || 0;
        const percentage = (value / cat.max) * 100;
        return (
          <div key={cat.key} className="flex items-center gap-2">
            <span className="text-xs text-gray-600 w-20 truncate">
              {cat.label}
            </span>
            <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${percentage}%` }}
                transition={{ duration: 0.5, ease: 'easeOut' }}
                className={cn('h-full rounded-full', cat.color)}
              />
            </div>
            <span className="text-xs text-gray-500 w-10 text-right">
              {value}/{cat.max}
            </span>
          </div>
        );
      })}
    </div>
  );
};

// ============================================================================
// AI REASONING DISPLAY COMPONENT
// ============================================================================

const AiReasoningDisplay: React.FC<{
  reasoning?: string;
  similarity?: number;
  method?: SearchMethod;
  className?: string;
}> = ({ reasoning, similarity, method, className }) => {
  if (!reasoning && !similarity) return null;

  return (
    <motion.div
      initial={{ opacity: 0, y: 5 }}
      animate={{ opacity: 1, y: 0 }}
      className={cn(
        'mt-2 p-3 rounded-lg text-sm',
        method === 'vector'
          ? 'bg-blue-50 border border-blue-100'
          : 'bg-purple-50 border border-purple-100',
        className
      )}
    >
      <div className="flex items-start gap-2">
        <MessageSquare
          className={cn(
            'w-4 h-4 mt-0.5 flex-shrink-0',
            method === 'vector' ? 'text-blue-500' : 'text-purple-500'
          )}
        />
        <div className="flex-1">
          {similarity !== undefined && (
            <div className="text-xs text-gray-500 mb-1">
              דמיון וקטורי: {(similarity * 100).toFixed(1)}%
            </div>
          )}
          {reasoning && (
            <p className="text-gray-700 leading-relaxed">{reasoning}</p>
          )}
        </div>
      </div>
    </motion.div>
  );
};

// ============================================================================
// CACHE INFO BADGE COMPONENT
// ============================================================================

const CacheInfoBadge: React.FC<{
  meta: AiMatchMeta | null;
  matchesCount: number;
  method?: SearchMethod;
}> = ({ meta, matchesCount, method }) => {
  if (!meta || matchesCount === 0) return null;

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return '';
    try {
      return new Date(dateStr).toLocaleDateString('he-IL', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit',
      });
    } catch {
      return '';
    }
  };

  const methodLabel = method === 'vector' ? 'וקטורי' : 'AI';

  if (meta.fromCache) {
    return (
      <motion.div
        initial={{ scale: 0, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        className={cn(
          'flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full font-medium',
          meta.isStale
            ? 'bg-amber-100 text-amber-700 border border-amber-200'
            : 'bg-emerald-100 text-emerald-700 border border-emerald-200'
        )}
      >
        {meta.isStale ? (
          <>
            <Clock className="w-3 h-3" />
            <span>
              {methodLabel} ישן ({formatDate(meta.savedAt)})
            </span>
          </>
        ) : (
          <>
            <Database className="w-3 h-3" />
            <span>
              {methodLabel} שמור ({formatDate(meta.savedAt)})
            </span>
          </>
        )}
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      className={cn(
        'flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full font-medium border',
        method === 'vector'
          ? 'bg-blue-100 text-blue-700 border-blue-200'
          : 'bg-purple-100 text-purple-700 border-purple-200'
      )}
    >
      {method === 'vector' ? (
        <Zap className="w-3 h-3" />
      ) : (
        <Sparkles className="w-3 h-3" />
      )}
      <span>חדש</span>
      {meta.totalCandidatesScanned && (
        <span className="opacity-70">
          ({meta.totalCandidatesScanned} נסרקו)
        </span>
      )}
    </motion.div>
  );
};

// ============================================================================
// SEARCH METHOD TABS COMPONENT
// ============================================================================

const SearchMethodTabs: React.FC<{
  activeMethod: SearchMethod;
  onMethodChange: (method: SearchMethod) => void;
  algorithmicCount: number;
  vectorCount: number;
  hybridCount: number; // 🆕
  isLoading: boolean;
}> = ({
  activeMethod,
  onMethodChange,
  algorithmicCount,
  vectorCount,
  hybridCount, // 🆕
  isLoading,
}) => {
  return (
    <div className="flex gap-1 p-1 bg-gray-100 rounded-lg">
      <button
        onClick={() => onMethodChange('algorithmic')}
        disabled={isLoading}
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all',
          activeMethod === 'algorithmic'
            ? 'bg-white shadow-sm text-purple-700'
            : 'text-gray-600 hover:text-gray-800'
        )}
      >
        <Brain className="w-4 h-4" />
        <span>AI</span>
        {algorithmicCount > 0 && (
          <Badge variant="secondary" className="text-xs px-1.5 py-0">
            {algorithmicCount}
          </Badge>
        )}
      </button>

      <button
        onClick={() => onMethodChange('vector')}
        disabled={isLoading}
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all',
          activeMethod === 'vector'
            ? 'bg-white shadow-sm text-blue-700'
            : 'text-gray-600 hover:text-gray-800'
        )}
      >
        <Zap className="w-4 h-4" />
        <span>מהיר</span>
        {vectorCount > 0 && (
          <Badge variant="secondary" className="text-xs px-1.5 py-0">
            {vectorCount}
          </Badge>
        )}
      </button>

      {/* 🆕 Tab היברידי */}
      <button
        onClick={() => onMethodChange('hybrid')}
        disabled={isLoading}
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all',
          activeMethod === 'hybrid'
            ? 'bg-white shadow-sm text-emerald-700'
            : 'text-gray-600 hover:text-gray-800'
        )}
      >
        <Users className="w-4 h-4" />
        <span>היברידי</span>
        {hybridCount > 0 && (
          <Badge variant="secondary" className="text-xs px-1.5 py-0">
            {hybridCount}
          </Badge>
        )}
      </button>
    </div>
  );
};

// ============================================================================
// 🆕 INLINE PROGRESS COMPONENT - Progress קטן בתוך הכפתורים
// ============================================================================

const InlineJobProgress: React.FC<{
  progress: number;
  progressMessage: string;
  method: SearchMethod;
  onCancel: () => void;
}> = ({ progress, progressMessage, method, onCancel }) => {
  const isVector = method === 'vector';
  const gradientClass = isVector
    ? 'from-blue-500 to-cyan-500'
    : 'from-purple-500 to-pink-500';
  const bgClass = isVector ? 'bg-blue-50' : 'bg-purple-50';

  return (
    <motion.div
      initial={{ opacity: 0, height: 0 }}
      animate={{ opacity: 1, height: 'auto' }}
      exit={{ opacity: 0, height: 0 }}
      className={cn('rounded-lg p-3 border', bgClass)}
    >
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Loader2
            className={cn(
              'w-4 h-4 animate-spin',
              isVector ? 'text-blue-600' : 'text-purple-600'
            )}
          />
          <span className="text-sm font-medium text-gray-700">
            {progressMessage || 'מעבד...'}
          </span>
        </div>
        <Button
          variant="ghost"
          size="sm"
          onClick={onCancel}
          className="h-6 w-6 p-0 text-gray-400 hover:text-gray-600"
        >
          <X className="w-3 h-3" />
        </Button>
      </div>

      <div className="relative">
        <Progress value={progress} className="h-2" />
      </div>

      <div className="flex justify-between mt-1 text-xs text-gray-500">
        <span>{progress}%</span>
        <span>רץ ברקע - ניתן להמשיך לעבוד</span>
      </div>
    </motion.div>
  );
};

// ============================================================================
// 🆕 JOB COMPLETE BANNER
// ============================================================================

const JobCompleteBanner: React.FC<{
  matchesCount: number;
  targetName: string;
  method: SearchMethod;
  onViewResults: () => void;
  onDismiss: () => void;
}> = ({ matchesCount, targetName, method, onViewResults, onDismiss }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: -10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -10 }}
      className="rounded-lg p-3 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200"
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <CheckCircle2 className="w-5 h-5 text-green-600" />
          <div>
            <span className="font-medium text-green-800">
              נמצאו {matchesCount} התאמות עבור {targetName}!
            </span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Button
            size="sm"
            onClick={onViewResults}
            className="bg-green-600 hover:bg-green-700 text-white"
          >
            <Sparkles className="w-4 h-4 ml-1" />
            הצג
          </Button>
          <Button
            variant="ghost"
            size="sm"
            onClick={onDismiss}
            className="h-8 w-8 p-0"
          >
            <X className="w-4 h-4" />
          </Button>
        </div>
      </div>
    </motion.div>
  );
};

// ============================================================================
// PANEL HEADER COMPONENT
// ============================================================================

const PanelHeaderComponent: React.FC<{
  gender: 'male' | 'female';
  count: number;
  aiTargetCandidate: Candidate | null;
  isSearchPanel: boolean;
  isTargetPanel: boolean;
  onClearAiTarget: (e: React.MouseEvent) => void;
  onFindAiMatches: (
    e: React.MouseEvent,
    forceRefresh: boolean,
    method: SearchMethod
  ) => void;
  // 🆕 New prop for refreshing all methods
  onRefreshAllMethods: (e: React.MouseEvent) => void;
  isRefreshingAll: boolean;
  isAiLoading: boolean;
  currentSearchMethod: SearchMethod;
  isMobileView?: boolean;
  dict: MatchmakerPageDictionary['candidatesManager']['splitView']['panelHeaders'];
  aiMatchMeta: AiMatchMeta | null;
  vectorMatchMeta: AiMatchMeta | null;
  hybridMatchMeta: AiMatchMeta | null;
  aiMatchesCount: number;
  vectorMatchesCount: number;
  hybridMatchesCount: number;
  activeResultsTab: SearchMethod;
  onResultsTabChange: (method: SearchMethod) => void;
  // 🆕 Props from context
  jobProgress: number;
  jobProgressMessage: string;
  jobStatus: string;
  onCancelJob: () => void;
  showCompleteBanner: boolean;
  onDismissBanner: () => void;
  onViewResults: () => void;
}> = ({
  gender,
  count,
  aiTargetCandidate,
  isSearchPanel,
  isTargetPanel,
  onClearAiTarget,
  onFindAiMatches,
  onRefreshAllMethods,
  isRefreshingAll,
  isAiLoading,
  currentSearchMethod,
  isMobileView = false,
  dict,
  aiMatchMeta,
  vectorMatchMeta,
  hybridMatchMeta,
  aiMatchesCount,
  vectorMatchesCount,
  hybridMatchesCount,
  activeResultsTab,
  onResultsTabChange,
  jobProgress,
  jobProgressMessage,
  jobStatus,
  onCancelJob,
  showCompleteBanner,
  onDismissBanner,
  onViewResults,
}) => {
  const genderConfig = {
    male: {
      title: dict.male.title,
      subtitle: dict.male.subtitle.replace('{{count}}', count.toString()),
      icon: Target,
      colors: {
        gradient: 'from-blue-500 to-cyan-500',
        bg: 'from-blue-50 to-cyan-50',
        text: 'text-blue-800',
        badge: 'bg-blue-500',
      },
    },
    female: {
      title: dict.female.title,
      subtitle: dict.female.subtitle.replace('{{count}}', count.toString()),
      icon: Crown,
      colors: {
        gradient: 'from-purple-500 to-pink-500',
        bg: 'from-purple-50 to-pink-50',
        text: 'text-purple-800',
        badge: 'bg-purple-500',
      },
    },
  };

  const config = genderConfig[gender];
  const IconComponent = config.icon;
  const hasAnyResults =
    aiMatchesCount > 0 || vectorMatchesCount > 0 || hybridMatchesCount > 0; // <--- FIX HERE (Use count, not array)
  const isJobRunning = jobStatus === 'pending' || jobStatus === 'processing';

  return (
    <div
      className={cn(
        'flex flex-col gap-3 p-4 rounded-t-2xl',
        !isMobileView &&
          `bg-gradient-to-r ${config.colors.bg} border-b border-gray-100/50`
      )}
    >
      {/* Header Row */}
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-3">
          <motion.div
            className={cn(
              'p-3 rounded-full shadow-lg text-white transition-transform',
              `bg-gradient-to-r ${config.colors.gradient}`
            )}
          >
            <IconComponent className="w-6 h-6" />
          </motion.div>
          <div>
            <h2 className={cn('text-xl font-bold', config.colors.text)}>
              {config.title}
            </h2>
            <p className="text-sm text-gray-600">{config.subtitle}</p>
          </div>
          <Badge
            className={cn(
              'text-white border-0 shadow-lg px-3 py-1 font-bold',
              config.colors.badge
            )}
          >
            {count}
          </Badge>
        </div>

        {/* Target indicator */}
        {isTargetPanel && aiTargetCandidate && (
          <motion.div
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0, opacity: 0 }}
            className="flex items-center gap-2 bg-green-100 p-2 rounded-full shadow-lg"
          >
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
            <span className="text-sm font-medium text-green-800 px-2">
              {dict.targetLabel.replace(
                '{{name}}',
                `${aiTargetCandidate.firstName} ${aiTargetCandidate.lastName}`
              )}
            </span>
            <Button
              size="icon"
              variant="ghost"
              className="h-6 w-6 text-green-700 hover:bg-green-200 rounded-full"
              onClick={onClearAiTarget}
            >
              <XCircle className="h-4 w-4" />
            </Button>
          </motion.div>
        )}
      </div>

      {/* Search buttons - only show on search panel */}
      {isSearchPanel && (
        <div className="flex flex-col gap-2">
          {/* 🆕 Show completion banner if job just completed */}
          <AnimatePresence>
            {showCompleteBanner && (
              <JobCompleteBanner
                matchesCount={
                  activeResultsTab === 'vector'
                    ? vectorMatchesCount
                    : aiMatchesCount
                }
                targetName={
                  aiTargetCandidate
                    ? `${aiTargetCandidate.firstName} ${aiTargetCandidate.lastName}`
                    : 'המועמד'
                }
                method={currentSearchMethod}
                onViewResults={onViewResults}
                onDismiss={onDismissBanner}
              />
            )}
          </AnimatePresence>

          {/* 🆕 Show progress if job is running */}
          <AnimatePresence>
            {isJobRunning && (
              <InlineJobProgress
                progress={jobProgress}
                progressMessage={jobProgressMessage}
                method={currentSearchMethod}
                onCancel={onCancelJob}
              />
            )}
          </AnimatePresence>

          {/* Search buttons - always visible, not disabled during search */}
          {!isJobRunning && !showCompleteBanner && (
            <>
              <div className="flex gap-2 flex-wrap">
                {/* כפתור AI מתקדם - קיים */}
                <motion.div
                  className="flex-1 min-w-[120px]"
                  whileHover={{ scale: 1.02 }}
                >
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'algorithmic')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg px-2 sm:px-4',
                      'bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white'
                    )}
                  >
                    <Brain className="w-5 h-5 ml-1.5 flex-shrink-0" />
                    <span className="truncate text-xs sm:text-sm">
                      AI מתקדם
                    </span>
                  </Button>
                </motion.div>

                {/* כפתור דמיון מהיר - קיים */}
                <motion.div
                  className="flex-1 min-w-[120px]"
                  whileHover={{ scale: 1.02 }}
                >
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'vector')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg px-2 sm:px-4',
                      'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white'
                    )}
                  >
                    <Zap className="w-5 h-5 ml-1.5 flex-shrink-0" />
                    <span className="truncate text-xs sm:text-sm">
                      דמיון מהיר ⚡
                    </span>
                  </Button>
                </motion.div>

                {/* 🆕 כפתור סריקה היברידית - חדש! */}
                <motion.div
                  className="flex-1 min-w-[120px]"
                  whileHover={{ scale: 1.02 }}
                >
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'hybrid')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg px-2 sm:px-4',
                      'bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white'
                    )}
                  >
                    <Users className="w-5 h-5 ml-1.5 flex-shrink-0" />
                    <span className="truncate text-xs sm:text-sm">
                      היברידי 🔥
                    </span>
                  </Button>
                </motion.div>
         <motion.div
                  className="flex-1 min-w-[120px]"
                  whileHover={{ scale: 1.02 }}
                >
                  <Button
                    onClick={(e) => onFindAiMatches(e, false, 'metrics_v2')}
                    className={cn(
                      'w-full h-11 font-bold transition-all duration-300 shadow-lg px-2 sm:px-4',
                      'bg-gradient-to-r from-indigo-500 to-violet-500 hover:from-indigo-600 hover:to-violet-600 text-white'
                    )}
                  >
                    <Target className="w-5 h-5 ml-1.5 flex-shrink-0" />
                    <span className="truncate text-xs sm:text-sm">
                      מדדים V2 🎯
                    </span>
                  </Button>
                </motion.div>
                {/* כפתור רענון - קיים */}
                {hasAnyResults && (
                  <Button
                    size="icon"
                    variant="outline"
                    onClick={onRefreshAllMethods}
                    disabled={isRefreshingAll}
                    title="רענן את כל הסריקות"
                    className="h-11 w-11 flex-shrink-0 bg-white shadow-sm border-gray-200 hover:bg-gray-50"
                  >
                    <RefreshCw
                      className={cn(
                        'w-5 h-5 text-gray-600',
                        isRefreshingAll && 'animate-spin'
                      )}
                    />
                  </Button>
                )}
              </div>

              {/* תיאורי זמן מעודכנים */}
              <div className="flex gap-2 text-xs text-gray-500 mt-1">
                <span className="flex-1 text-center truncate">~3-5 דק</span>
                <span className="flex-1 text-center truncate">~30 שנ</span>
                <span className="flex-1 text-center truncate">~1-2 דק 🆕</span>
                {hasAnyResults && (
                  <div className="w-11 flex-shrink-0 hidden sm:block" />
                )}
              </div>
            </>
          )}

          {/* Results tabs */}
          {hasAnyResults && !isJobRunning && (
            <div className="flex items-center justify-between mt-2">
              <SearchMethodTabs
                activeMethod={activeResultsTab}
                onMethodChange={onResultsTabChange}
                algorithmicCount={aiMatchesCount}
                vectorCount={vectorMatchesCount}
                hybridCount={hybridMatchesCount}
                isLoading={isJobRunning}
              />
              <CacheInfoBadge
                meta={
                  activeResultsTab === 'vector'
                    ? vectorMatchMeta
                    : activeResultsTab === 'hybrid'
                      ? hybridMatchMeta // <--- הוסף תמיכה בהיברידי
                      : aiMatchMeta
                }
                matchesCount={
                  activeResultsTab === 'vector'
                    ? vectorMatchesCount
                    : activeResultsTab === 'hybrid'
                      ? hybridMatchesCount // <--- הוסף תמיכה בהיברידי
                      : aiMatchesCount
                }
                method={activeResultsTab}
              />
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// ============================================================================
// LOADING COMPONENT
// ============================================================================

const LoadingComponent: React.FC<{ gender: 'male' | 'female' }> = ({
  gender,
}) => {
  const config =
    gender === 'male'
      ? {
          gradient: 'from-blue-200 to-cyan-200',
          icon: Target,
          title: 'טוען מועמדים...',
        }
      : {
          gradient: 'from-purple-200 to-pink-200',
          icon: Crown,
          title: 'טוענת מועמדות...',
        };
  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <motion.div
        animate={{ scale: [1, 1.2, 1], rotate: [0, 360] }}
        transition={{ duration: 2, repeat: Infinity, ease: 'easeInOut' }}
        className={cn(
          'p-6 rounded-full mb-4',
          `bg-gradient-to-r ${config.gradient}`
        )}
      >
        <IconComponent className="w-12 h-12 text-white" />
      </motion.div>
      <h3 className="text-lg font-bold text-gray-700">{config.title}</h3>
    </motion.div>
  );
};

// ============================================================================
// EMPTY STATE COMPONENT
// ============================================================================

const EmptyStateComponent: React.FC<{
  gender: 'male' | 'female';
  searchQuery?: string;
  onClearSearch?: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['list']['emptyState'];
}> = ({ gender, searchQuery, onClearSearch, dict }) => {
  const config =
    gender === 'male'
      ? { gradient: 'from-blue-100 to-cyan-100', icon: Target }
      : { gradient: 'from-purple-100 to-pink-100', icon: Crown };
  const IconComponent = config.icon;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="flex flex-col items-center justify-center h-64 p-8"
    >
      <div
        className={cn(
          'w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-lg',
          `bg-gradient-to-br ${config.gradient}`
        )}
      >
        <IconComponent className="w-12 h-12 text-gray-400" />
      </div>
      <h3 className="text-xl font-bold text-gray-800 mb-2">{dict.title}</h3>
      <p className="text-gray-600 text-center mb-4">
        {searchQuery
          ? `לא נמצאו תוצאות עבור "${searchQuery}"`
          : dict.description}
      </p>
      {searchQuery && onClearSearch && (
        <Button variant="outline" onClick={onClearSearch}>
          <Search className="w-4 h-4 ml-2" />
          נקה חיפוש
        </Button>
      )}
    </motion.div>
  );
};

// ============================================================================
// HELPER FUNCTION
// ============================================================================

function toBackgroundCompatibility(
  value: string | undefined
): BackgroundCompatibility | undefined {
  const validValues: BackgroundCompatibility[] = [
    'excellent',
    'good',
    'possible',
    'problematic',
    'not_recommended',
  ];
  if (value && validValues.includes(value as BackgroundCompatibility)) {
    return value as BackgroundCompatibility;
  }
  return undefined;
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

const SplitView: React.FC<SplitViewProps> = ({
  dict,
  onOpenAiAnalysis,
  onSendProfileFeedback,
  profileDict,
  isQuickViewEnabled,
  locale,
  ...props
}) => {
  const {
    maleCandidates,
    femaleCandidates,
    allCandidates,
    onCandidateAction,
    onCandidateClick,
    viewMode,
    mobileView,
    isLoading = false,
    className,
    maleSearchQuery = '',
    femaleSearchQuery = '',
    onMaleSearchChange,
    onFemaleSearchChange,
    aiTargetCandidate,
    aiMatches,
    isAiLoading,
    onSetAiTarget,
    onClearAiTarget,
    setAiMatches,
    setIsAiLoading,
    comparisonSelection,
    onToggleComparison,
    separateFiltering,
  } = props;

  // 🆕 Use global context
  const matchingJobContext = useMatchingJobContext();
  const { currentJob, startJob, cancelJob, isJobRunning, onJobComplete } =
    matchingJobContext;

  const [isMobile, setIsMobile] = useState(false);
  const [aiMatchMeta, setAiMatchMeta] = useState<AiMatchMeta | null>(null);
  const [vectorMatches, setVectorMatches] = useState<AiMatch[]>([]);
  const [vectorMatchMeta, setVectorMatchMeta] = useState<AiMatchMeta | null>(
    null
  );

  const [currentSearchMethod, setCurrentSearchMethod] =
    useState<SearchMethod>('algorithmic');
  const [activeResultsTab, setActiveResultsTab] =
    useState<SearchMethod>('algorithmic');
  const [showCompleteBanner, setShowCompleteBanner] = useState(false);
  // 🆕 State for tracking refresh all operation
  const [isRefreshingAll, setIsRefreshingAll] = useState(false);
  const [refreshQueue, setRefreshQueue] = useState<SearchMethod[]>([]);
  const [hybridMatches, setHybridMatches] = useState<AiMatch[]>([]);
  const [hybridMatchMeta, setHybridMatchMeta] = useState<AiMatchMeta | null>(
    null
  );

  useEffect(() => {
    const checkScreenSize = () => setIsMobile(window.innerWidth < 768);
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
    return () => window.removeEventListener('resize', checkScreenSize);
  }, []);

  // 🆕 Subscribe to job completion
  useEffect(() => {
    const unsubscribe = onJobComplete((result) => {
      if (result?.matches) {
        switch (currentJob.method) {
          case 'vector':
            setVectorMatches(result.matches as AiMatch[]);
            setVectorMatchMeta({
              fromCache: currentJob.fromCache,
              algorithmVersion: result.meta?.algorithmVersion || 'vector-v1',
              totalCandidatesScanned: result.meta?.totalCandidatesScanned,
            });
            setActiveResultsTab('vector');
            break;

          case 'hybrid':
          case 'metrics_v2':
            setHybridMatches(result.matches as AiMatch[]);
            setHybridMatchMeta({
              fromCache: currentJob.fromCache,
              algorithmVersion: result.meta?.algorithmVersion || 'hybrid-v1',
              totalCandidatesScanned: result.meta?.totalCandidatesScanned,
            });
            setActiveResultsTab('hybrid');
            break;

          default: // algorithmic
            setAiMatches(result.matches as AiMatch[]);
            setAiMatchMeta({
              fromCache: currentJob.fromCache,
              algorithmVersion: result.meta?.algorithmVersion || 'v3.1',
              totalCandidatesScanned: result.meta?.totalCandidatesScanned,
            });
            setActiveResultsTab('algorithmic');
        }

        // 🆕 Check if we're in the middle of refreshing all methods
        if (refreshQueue.length > 0) {
          // Process next method in queue
          const nextMethod = refreshQueue[0];
          setRefreshQueue((prev) => prev.slice(1));

          // Start the next scan
          if (aiTargetCandidate) {
            const isVirtual = (aiTargetCandidate as any).isVirtual;
            const virtualData = (aiTargetCandidate as any).virtualData;
            let extraParams = {};

            if (isVirtual && virtualData) {
              extraParams = {
                isVirtualSearch: true,
                virtualProfileId: virtualData.virtualProfileId,
                virtualProfile: virtualData.virtualProfile,
                gender: virtualData.gender,
                religiousLevel: virtualData.religiousLevel,
                editedSummary: virtualData.editedSummary,
              };
            }

            startJob(
              aiTargetCandidate.id,
              aiTargetCandidate.firstName,
              nextMethod,
              true, // forceRefresh
              extraParams
            );
          }
        } else {
          // All refreshes complete
          setIsRefreshingAll(false);
          setShowCompleteBanner(true);
        }
      }
    });

    return unsubscribe;
  }, [
    onJobComplete,
    currentJob.method,
    currentJob.fromCache,
    setAiMatches,
    refreshQueue,
    aiTargetCandidate,
    startJob,
  ]);

  // 🆕 Listen for "view results" event
  useEffect(() => {
    const handleViewResults = () => {
      setShowCompleteBanner(false);
      const resultsEl = document.getElementById('candidates-results');
      if (resultsEl) {
        resultsEl.scrollIntoView({ behavior: 'smooth' });
      }
    };

    window.addEventListener('matching-job-view-results', handleViewResults);
    return () =>
      window.removeEventListener(
        'matching-job-view-results',
        handleViewResults
      );
  }, []);

  // 🆕 Updated function - uses global context
  const handleFindAiMatches = useCallback(
    async (
      e: React.MouseEvent,
      forceRefresh: boolean = false,
      method: SearchMethod = 'algorithmic'
    ) => {
      e.stopPropagation();

      if (!aiTargetCandidate) {
        toast.error('אנא בחר מועמד/ת מטרה תחילה', {
          position: 'top-center',
          icon: '⚠️',
        });
        return;
      }

      setCurrentSearchMethod(method);
      setShowCompleteBanner(false);

      // Clear previous results for this method
      if (method === 'vector') {
        setVectorMatches([]);
        setVectorMatchMeta(null);
      } else {
        setAiMatches([]);
        setAiMatchMeta(null);
      }

      // 🔥 התיקון: בדיקה אם זה חיפוש וירטואלי והכנת הפרמטרים 🔥
      const isVirtual = (aiTargetCandidate as any).isVirtual;
      const virtualData = (aiTargetCandidate as any).virtualData;

      let extraParams = {};

      if (isVirtual && virtualData) {
        extraParams = {
          isVirtualSearch: true,
          virtualProfileId: virtualData.virtualProfileId,
          virtualProfile: virtualData.virtualProfile,
          gender: virtualData.gender,
          religiousLevel: virtualData.religiousLevel,
          editedSummary: virtualData.editedSummary,
        };
      }

      // 🆕 Use global context to start job
      await startJob(
        aiTargetCandidate.id,
        aiTargetCandidate.firstName, // הוספנו את השם
        method,
        forceRefresh,
        extraParams // שולחים את הפרמטרים הנוספים
      );
    },
    [aiTargetCandidate, setAiMatches, startJob]
  );

  // 🆕 NEW: Function to refresh all methods
  const handleRefreshAllMethods = useCallback(
    async (e: React.MouseEvent) => {
      e.stopPropagation();

      if (!aiTargetCandidate) {
        toast.error('אנא בחר מועמד/ת מטרה תחילה', {
          position: 'top-center',
          icon: '⚠️',
        });
        return;
      }

      setIsRefreshingAll(true);
      setShowCompleteBanner(false);

      // Define all methods to refresh
      const allMethods: SearchMethod[] = [
        'algorithmic',
        'vector',
        'metrics_v2',
        'hybrid',
      ];

      // Queue the remaining methods (after the first one)
      setRefreshQueue(allMethods.slice(1));

      // Clear all previous results
      setAiMatches([]);
      setAiMatchMeta(null);
      setVectorMatches([]);
      setVectorMatchMeta(null);
      setHybridMatches([]); // 🆕
      setHybridMatchMeta(null); // 🆕
      // Prepare params
      const isVirtual = (aiTargetCandidate as any).isVirtual;
      const virtualData = (aiTargetCandidate as any).virtualData;
      let extraParams = {};

      if (isVirtual && virtualData) {
        extraParams = {
          isVirtualSearch: true,
          virtualProfileId: virtualData.virtualProfileId,
          virtualProfile: virtualData.virtualProfile,
          gender: virtualData.gender,
          religiousLevel: virtualData.religiousLevel,
          editedSummary: virtualData.editedSummary,
        };
      }

      // Start the first method
      const firstMethod = allMethods[0];
      setCurrentSearchMethod(firstMethod);

      toast.info('מרענן את כל הסריקות...', {
        position: 'top-center',
        icon: '🔄',
        description: `סורק ${allMethods.length} שיטות חיפוש`,
      });

      await startJob(
        aiTargetCandidate.id,
        aiTargetCandidate.firstName,
        firstMethod,
        true, // forceRefresh
        extraParams
      );
    },
    [aiTargetCandidate, setAiMatches, startJob]
  );

  const handleViewResults = useCallback(() => {
    setShowCompleteBanner(false);
    const resultsEl = document.getElementById('candidates-results');
    if (resultsEl) {
      resultsEl.scrollIntoView({ behavior: 'smooth' });
    }
  }, []);

  // Get active matches
  const getActiveMatches = (): AiMatch[] => {
    switch (activeResultsTab) {
      case 'vector':
        return vectorMatches;
      case 'hybrid':
        return hybridMatches;
      case 'algorithmic':
      default:
        return aiMatches;
    }
  };

  // Merge candidates with AI scores
  const maleCandidatesWithScores: CandidateWithAiData[] = useMemo(() => {
    const activeMatches = getActiveMatches();
    if (activeMatches.length === 0) return maleCandidates;
    const matchMap = new Map(activeMatches.map((m) => [m.userId, m]));

    return maleCandidates
      .map((c): CandidateWithAiData => {
        const match = matchMap.get(c.id);
        return {
          ...c,
          aiScore: match?.finalScore ?? match?.score,
          aiReasoning:
            match?.detailedReasoning ??
            match?.reasoning ??
            match?.shortReasoning,
          aiMatch: match,
          aiRank: match?.rank,
          aiFirstPassScore: match?.firstPassScore,
          aiScoreBreakdown: match?.scoreBreakdown,
          aiBackgroundMultiplier: match?.backgroundMultiplier,
          aiBackgroundCompatibility: toBackgroundCompatibility(
            match?.backgroundCompatibility
          ),
          aiSimilarity: match?.similarity,
        };
      })
      .sort((a, b) => {
        if (a.aiScore !== undefined && b.aiScore !== undefined) {
          return b.aiScore - a.aiScore;
        }
        if (a.aiScore !== undefined) return -1;
        if (b.aiScore !== undefined) return 1;
        return 0;
      });
  }, [maleCandidates, aiMatches, vectorMatches, activeResultsTab]);

  const femaleCandidatesWithScores: CandidateWithAiData[] = useMemo(() => {
    const activeMatches = getActiveMatches();
    if (activeMatches.length === 0) return femaleCandidates;
    const matchMap = new Map(activeMatches.map((m) => [m.userId, m]));

    return femaleCandidates
      .map((c): CandidateWithAiData => {
        const match = matchMap.get(c.id);
        return {
          ...c,
          aiScore: match?.finalScore ?? match?.score,
          aiReasoning:
            match?.detailedReasoning ??
            match?.reasoning ??
            match?.shortReasoning,
          aiMatch: match,
          aiRank: match?.rank,
          aiFirstPassScore: match?.firstPassScore,
          aiScoreBreakdown: match?.scoreBreakdown,
          aiBackgroundMultiplier: match?.backgroundMultiplier,
          aiBackgroundCompatibility: toBackgroundCompatibility(
            match?.backgroundCompatibility
          ),
          aiSimilarity: match?.similarity,
        };
      })
      .sort((a, b) => {
        if (a.aiScore !== undefined && b.aiScore !== undefined) {
          return b.aiScore - a.aiScore;
        }
        if (a.aiScore !== undefined) return -1;
        if (b.aiScore !== undefined) return 1;
        return 0;
      });
  }, [femaleCandidates, aiMatches, vectorMatches, activeResultsTab]);

  // Determine which panel is the "target" panel and which is the "search" panel
  const targetGender = aiTargetCandidate?.profile?.gender;
  const isTargetMale = targetGender === 'MALE';
  const isTargetFemale = targetGender === 'FEMALE';
  const searchPanelGender: 'male' | 'female' | null = isTargetMale
    ? 'female'
    : isTargetFemale
      ? 'male'
      : null;

  // Render panel header helper
  const renderPanelHeader = (
    gender: 'male' | 'female',
    isMobileView = false
  ) => {
    const count =
      gender === 'male'
        ? maleCandidatesWithScores.length
        : femaleCandidatesWithScores.length;
    const isSearchPanel = searchPanelGender === gender;
    const isTargetPanel =
      (gender === 'male' && isTargetMale) ||
      (gender === 'female' && isTargetFemale);

    return (
      <PanelHeaderComponent
        gender={gender}
        count={count}
        aiTargetCandidate={aiTargetCandidate}
        isSearchPanel={isSearchPanel}
        isTargetPanel={isTargetPanel}
        onClearAiTarget={onClearAiTarget}
        onFindAiMatches={handleFindAiMatches}
        onRefreshAllMethods={handleRefreshAllMethods}
        isRefreshingAll={isRefreshingAll}
        isAiLoading={isAiLoading}
        currentSearchMethod={currentSearchMethod}
        isMobileView={isMobileView}
        dict={dict.candidatesManager.splitView.panelHeaders}
        hybridMatchesCount={hybridMatches.length}
        aiMatchMeta={aiMatchMeta}
        vectorMatchMeta={vectorMatchMeta}
        hybridMatchMeta={hybridMatchMeta}
        aiMatchesCount={aiMatches.length}
        vectorMatchesCount={vectorMatches.length}
        activeResultsTab={activeResultsTab}
        onResultsTabChange={setActiveResultsTab}
        jobProgress={currentJob.progress}
        jobProgressMessage={currentJob.progressMessage}
        jobStatus={currentJob.status}
        onCancelJob={cancelJob}
        showCompleteBanner={showCompleteBanner}
        onDismissBanner={() => setShowCompleteBanner(false)}
        onViewResults={handleViewResults}
      />
    );
  };

  // Render candidates list for mobile
  const renderCandidatesListForMobile = (
    candidates: CandidateWithAiData[],
    gender: 'male' | 'female',
    searchQuery?: string,
    onSearchChange?: (query: string) => void
  ) => {
    if (isLoading) {
      return <LoadingComponent gender={gender} />;
    }

    if (candidates.length === 0) {
      return (
        <EmptyStateComponent
          gender={gender}
          searchQuery={searchQuery}
          onClearSearch={onSearchChange ? () => onSearchChange('') : undefined}
          dict={dict.candidatesManager.list.emptyState}
        />
      );
    }

    return (
      <CandidatesList
        candidates={candidates}
        allCandidates={allCandidates}
        onOpenAiAnalysis={onOpenAiAnalysis}
        onSendProfileFeedback={onSendProfileFeedback}
        onCandidateClick={onCandidateClick}
        onCandidateAction={onCandidateAction}
        viewMode={viewMode}
        mobileView={mobileView}
        isLoading={isLoading}
        highlightTerm={searchQuery}
        aiTargetCandidate={aiTargetCandidate}
        onSetAiTarget={onSetAiTarget}
        comparisonSelection={comparisonSelection}
        onToggleComparison={onToggleComparison}
        quickViewSide={gender === 'male' ? 'right' : 'left'}
        isQuickViewEnabled={isQuickViewEnabled}
        dict={dict}
        profileDict={profileDict}
        locale={locale}
      />
    );
  };

  // MOBILE VIEW
  if (isMobile) {
    return (
      <div className={cn('flex flex-col h-full', className)}>
        <Tabs
          defaultValue="male"
          className="flex flex-col h-full overflow-hidden"
        >
          <TabsList className="grid grid-cols-2 mx-4 mb-2 bg-gradient-to-r from-blue-100 to-purple-100 p-1 rounded-xl shadow-lg">
            <TabsTrigger
              value="male"
              className="rounded-lg font-bold data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-blue-700 transition-all"
            >
              <Target className="w-4 h-4 ml-1" />
              {dict.candidatesManager.splitView.panelHeaders.male.title} (
              {maleCandidates.length})
            </TabsTrigger>
            <TabsTrigger
              value="female"
              className="rounded-lg font-bold data-[state=active]:bg-white data-[state=active]:shadow-md data-[state=active]:text-purple-700 transition-all"
            >
              <Crown className="w-4 h-4 ml-1" />
              {dict.candidatesManager.splitView.panelHeaders.female.title} (
              {femaleCandidates.length})
            </TabsTrigger>
          </TabsList>

          <TabsContent value="male" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-blue-50/30 rounded-2xl">
              {aiTargetCandidate &&
                aiTargetCandidate.profile.gender === 'FEMALE' && (
                  <div className="mb-4">{renderPanelHeader('male', true)}</div>
                )}
              {separateFiltering && onMaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={maleSearchQuery}
                    onChange={onMaleSearchChange}
                    placeholder={
                      dict.candidatesManager.searchBar.malePlaceholder
                    }
                    genderTarget="male"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}
              <div
                id="candidates-results"
                className="flex-grow min-h-0 overflow-y-auto"
              >
                {renderCandidatesListForMobile(
                  maleCandidatesWithScores,
                  'male',
                  maleSearchQuery,
                  onMaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>

          <TabsContent value="female" className="mt-4 flex-1 min-h-0">
            <Card className="p-4 flex flex-col h-full shadow-xl border-0 bg-gradient-to-b from-white to-purple-50/30 rounded-2xl">
              {aiTargetCandidate &&
                aiTargetCandidate.profile.gender === 'MALE' && (
                  <div className="mb-4">
                    {renderPanelHeader('female', true)}
                  </div>
                )}
              {separateFiltering && onFemaleSearchChange && (
                <div className="mb-4 w-full">
                  <SearchBar
                    value={femaleSearchQuery}
                    onChange={onFemaleSearchChange}
                    placeholder={
                      dict.candidatesManager.searchBar.femalePlaceholder
                    }
                    genderTarget="female"
                    separateMode={true}
                    dict={dict.candidatesManager.searchBar}
                  />
                </div>
              )}
              <div
                id="candidates-results"
                className="flex-grow min-h-0 overflow-y-auto"
              >
                {renderCandidatesListForMobile(
                  femaleCandidatesWithScores,
                  'female',
                  femaleSearchQuery,
                  onFemaleSearchChange
                )}
              </div>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    );
  }

  // DESKTOP VIEW
  return (
    <div className={cn('h-full', className)}>
      <ResizablePanelGroup
        direction="horizontal"
        className="h-full rounded-2xl bg-white shadow-2xl border-0 overflow-hidden"
      >
        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-blue-50/20">
            {renderPanelHeader('male')}
            {separateFiltering && onMaleSearchChange && (
              <div className="p-4 bg-blue-50/30 w-full">
                <SearchBar
                  value={maleSearchQuery}
                  onChange={onMaleSearchChange}
                  placeholder={dict.candidatesManager.searchBar.malePlaceholder}
                  genderTarget="male"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}
            <div
              id="candidates-results"
              className="flex-grow min-h-0 overflow-y-auto p-4"
            >
              <CandidatesList
                candidates={maleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={maleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="right"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>

        <ResizableHandle
          withHandle
          className="bg-gradient-to-b from-indigo-300 to-purple-300 hover:from-indigo-400 hover:to-purple-400 transition-colors w-2"
        />

        <ResizablePanel defaultSize={50} minSize={30}>
          <div className="flex flex-col h-full bg-gradient-to-b from-white to-purple-50/20">
            {renderPanelHeader('female')}
            {separateFiltering && onFemaleSearchChange && (
              <div className="p-4 bg-purple-50/30 w-full">
                <SearchBar
                  value={femaleSearchQuery}
                  onChange={onFemaleSearchChange}
                  placeholder={
                    dict.candidatesManager.searchBar.femalePlaceholder
                  }
                  genderTarget="female"
                  separateMode={true}
                  dict={dict.candidatesManager.searchBar}
                />
              </div>
            )}
            <div className="flex-grow min-h-0 overflow-y-auto p-4">
              <CandidatesList
                candidates={femaleCandidatesWithScores}
                allCandidates={allCandidates}
                onOpenAiAnalysis={onOpenAiAnalysis}
                onSendProfileFeedback={onSendProfileFeedback}
                onCandidateClick={onCandidateClick}
                onCandidateAction={onCandidateAction}
                viewMode={viewMode}
                mobileView={mobileView}
                isLoading={isLoading}
                highlightTerm={femaleSearchQuery}
                aiTargetCandidate={aiTargetCandidate}
                onSetAiTarget={onSetAiTarget}
                comparisonSelection={comparisonSelection}
                onToggleComparison={onToggleComparison}
                quickViewSide="left"
                isQuickViewEnabled={isQuickViewEnabled}
                dict={dict}
                profileDict={profileDict}
                locale={locale}
              />
            </div>
          </div>
        </ResizablePanel>
      </ResizablePanelGroup>
    </div>
  );
};

export default SplitView;
--- End of Content for SplitView.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\StatsCard.tsx
--------------------------------------------------------------------------------
Content:
"use client";

import React from "react";

import { Card } from "@/components/ui/card";
import { cn } from "@/lib/utils";

interface StatsCardProps {
  icon: React.ElementType;
  title: string;
  value: string | number;
  trend?: {
    value: number;
    label: string;
    isPositive?: boolean;
  };
  variant?: "default" | "success" | "warning" | "destructive";
  bgGradient?: string;
  iconColor?: string;
  className?: string;
}

const StatsCard: React.FC<StatsCardProps> = ({
  icon: Icon,
  title,
  value,
  trend,
  variant = "default",
  bgGradient,
  iconColor = "text-primary",
  className,
}) => {
  const getVariantStyles = () => {
    switch (variant) {
      case "success":
        return "border-emerald-200";
      case "warning":
        return "border-amber-200";
      case "destructive":
        return "border-red-200";
      default:
        return "border-gray-200";
    }
  };

  return (
    <Card
      className={cn(
        "hover:shadow-md transition-all duration-300 p-4 overflow-hidden",
        bgGradient ? `bg-gradient-to-br ${bgGradient}` : "bg-card",
        getVariantStyles(),
        className
      )}
    >
      <div className="flex items-start justify-between">
        <div className="mr-4 flex-shrink-0">
          <div className={`p-2.5 rounded-full bg-white/60 backdrop-blur-sm shadow-sm`}>
            <Icon className={`w-4 h-4 ${iconColor}`} />
          </div>
        </div>

        <div className="flex-1 text-right">
          <p className="text-xs text-muted-foreground mb-1">{title}</p>
          <h3 className="text-xl font-bold">{value}</h3>

          {trend && (
            <div className="flex items-center justify-end gap-1 mt-1">
              <span
                className={cn(
                  "text-sm font-medium flex items-center gap-0.5",
                  trend.isPositive ? "text-emerald-600" : "text-red-600"
                )}
              >
                {trend.isPositive ? "+" : "-"}{trend.value}%
                <span className={`${trend.isPositive ? "rotate-0" : "rotate-180"} transition-transform`}>
                  ↑
                </span>
              </span>
              <span className="text-[11px] text-muted-foreground">
                {trend.label}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Animated background pattern for more visual appeal */}
      <div className="absolute right-0 bottom-0 opacity-10 pointer-events-none">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="60" cy="60" r="40" fill="currentColor" />
        </svg>
      </div>
    </Card>
  );
};

export default StatsCard;
--- End of Content for StatsCard.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\matchmaker\new\CandidatesManager\index.tsx
--------------------------------------------------------------------------------
Content:
// File: src/components/matchmaker/new/CandidatesManager/index.tsx

'use client';

// --- React & Next.js Imports ---
import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { useSession } from 'next-auth/react';
import { cn, getRelativeCloudinaryPath } from '@/lib/utils';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';

// --- Third-party Libraries ---
import {
  UserPlus,
  Filter,
  LayoutGrid,
  List,
  ArrowUpDown,
  RotateCw,
  Bot,
  Loader2,
  Columns,
  View,
  Users,
  Sparkles,
  TrendingUp,
  TrendingDown,
  Eye,
  EyeOff,
  GitCompare,
  X,
  UserCircle, // <-- אייקון חדש לחיפוש וירטואלי
} from 'lucide-react';
import { toast } from 'sonner';

// --- UI Components ---
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';

// --- Custom Hooks ---
import { useCandidates } from '../hooks/useCandidates';
import { useFilterLogic } from '../hooks/useFilterLogic';

// --- Internal Components ---
import SplitView from './SplitView';
import FilterPanel from '../Filters/FilterPanel';
import ActiveFilters from '../Filters/ActiveFilters';
import SearchBar from '../Filters/SearchBar';
import { LoadingContainer } from '../shared/LoadingStates';
import { AddManualCandidateDialog } from '../dialogs/AddManualCandidateDialog';
import { AiMatchAnalysisDialog } from '../dialogs/AiMatchAnalysisDialog';
import { ProfileFeedbackDialog } from '../dialogs/ProfileFeedbackDialog';
import { AiMatchmakerProfileAdvisorDialog } from '../dialogs/AiMatchmakerProfileAdvisorDialog';

// --- Virtual Search Components (NEW) ---
import { VirtualUserDialog, SavedVirtualProfiles } from '../VirtualSearch';

// --- Types, Constants & Utils ---
import type {
  Candidate,
  ViewMode,
  CandidatesFilter,
  CandidateAction,
  MobileView,
} from '../types/candidates';
import { SORT_OPTIONS, VIEW_OPTIONS } from '../constants/filterOptions';
import type { MatchmakerPageDictionary } from '@/types/dictionaries/matchmaker';
import type { ProfilePageDictionary } from '@/types/dictionary';


// הוספת שדה מותאם אישית ל-Candidate כדי למנוע שגיאות TS (אפשר גם להשתמש ב-as any)
type VirtualCandidate = Candidate & {
  isVirtual: boolean;
  virtualData?: any; // אובייקט לשמירת הנתונים הגולמיים
};


// --- Interfaces Definitions ---
type BackgroundCompatibility =
  | 'excellent'
  | 'good'
  | 'possible'
  | 'problematic'
  | 'not_recommended';

interface ScoreBreakdown {
  religious: number;
  careerFamily: number;
  lifestyle: number;
  ambition: number;
  communication: number;
  values: number;
}

interface AiMatch {
  userId: string;
  firstName?: string;
  lastName?: string;
  score?: number;
  firstPassScore?: number;
  finalScore?: number;
  scoreBreakdown?: ScoreBreakdown;
  reasoning?: string;
  shortReasoning?: string;
  detailedReasoning?: string;
  rank?: number;
  backgroundMultiplier?: number;
  backgroundCompatibility?: BackgroundCompatibility;
}

// ============================================================================
// Minimal Compact Header Component
// ============================================================================
const MinimalHeader: React.FC<{
  stats: {
    total: number;
    male: number;
    female: number;
    verified: number;
    activeToday: number;
    profilesComplete: number;
  };
  onAddCandidate: () => void;
  onRefresh: () => void;
  isRefreshing: boolean;
  onBulkUpdate?: () => void;
  isBulkUpdating?: boolean;
  isAdmin?: boolean;
  isCompact: boolean;
  onToggleCompact: () => void;
  dict: MatchmakerPageDictionary['candidatesManager']['header'];
}> = ({
  stats,
  onAddCandidate,
  onRefresh,
  isRefreshing,
  onBulkUpdate,
  isBulkUpdating,
  isAdmin,
  isCompact,
  onToggleCompact,
  dict,
}) => {
  return (
    <header
      className={cn(
        'sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm transition-all duration-300',
        isCompact ? 'h-16' : 'h-32'
      )}
    >
      <div className="container mx-auto px-6 h-full">
        {isCompact ? (
          // --- COMPACT MODE ---
          <div className="flex items-center justify-between h-full">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <div className="p-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                  <Users className="w-4 h-4" />
                </div>
                <h1 className="text-lg font-bold text-gray-800">
                  {dict.title}
                </h1>
              </div>
              <div className="hidden md:flex items-center gap-2">
                <Badge
                  variant="outline"
                  className="bg-blue-50 text-blue-700 border-blue-200"
                >
                  {stats.total} {dict.totalLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-emerald-50 text-emerald-700 border-emerald-200"
                >
                  {stats.verified} {dict.verifiedLabel}
                </Badge>
                <Badge
                  variant="outline"
                  className="bg-orange-50 text-orange-700 border-orange-200"
                >
                  {stats.profilesComplete}
                  {dict.profilesCompleteLabel}
                </Badge>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button
                onClick={onAddCandidate}
                size="sm"
                className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-md"
              >
                <UserPlus className="w-4 h-4 ml-1" />
                {dict.addButton}
              </Button>
              <Button
                onClick={onRefresh}
                variant="outline"
                size="sm"
                disabled={isRefreshing}
                className="border-gray-300 hover:bg-gray-50"
              >
                <RotateCw
                  className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                />
              </Button>
              {isAdmin && onBulkUpdate && (
                <Button
                  onClick={onBulkUpdate}
                  variant="secondary"
                  size="sm"
                  disabled={isBulkUpdating}
                  className="bg-amber-500 hover:bg-amber-600 text-white"
                >
                  {isBulkUpdating ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Bot className="w-4 h-4" />
                  )}
                </Button>
              )}
              <Button
                onClick={onToggleCompact}
                variant="ghost"
                size="sm"
                className="text-gray-500 hover:text-gray-700"
                title={dict.expandTooltip}
              >
                <TrendingUp className="w-4 h-4" />
              </Button>
            </div>
          </div>
        ) : (
          // --- EXPANDED MODE ---
          <div className="flex flex-col justify-center h-full py-3">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg">
                  <Users className="w-5 h-5" />
                </div>
                <div>
                  <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    {dict.advancedTitle}
                  </h1>
                  <p className="text-sm text-gray-600">
                    {dict.advancedSubtitle}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  onClick={onAddCandidate}
                  size="sm"
                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg"
                >
                  <UserPlus className="w-4 h-4 ml-2" />
                  {dict.addCandidateButton}
                  <Sparkles className="w-3 h-3 mr-1" />
                </Button>
                <Button
                  onClick={onRefresh}
                  variant="outline"
                  size="sm"
                  disabled={isRefreshing}
                  className="border-indigo-300 text-indigo-600 hover:bg-indigo-50"
                >
                  <RotateCw
                    className={cn('w-4 h-4', isRefreshing && 'animate-spin')}
                  />
                </Button>
                {isAdmin && onBulkUpdate && (
                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button
                        variant="secondary"
                        size="sm"
                        disabled={isBulkUpdating}
                        className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white"
                      >
                        {isBulkUpdating ? (
                          <Loader2 className="w-4 h-4 animate-spin" />
                        ) : (
                          <Bot className="w-4 h-4" />
                        )}
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent dir="rtl">
                      <AlertDialogHeader>
                        <AlertDialogTitle>
                          {dict.bulkUpdateDialog.title}
                        </AlertDialogTitle>
                        <AlertDialogDescription>
                          {dict.bulkUpdateDialog.description}
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel>
                          {dict.bulkUpdateDialog.cancel}
                        </AlertDialogCancel>
                        <AlertDialogAction onClick={onBulkUpdate}>
                          {dict.bulkUpdateDialog.confirm}
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                )}
                <Button
                  onClick={onToggleCompact}
                  variant="ghost"
                  size="sm"
                  className="text-gray-500 hover:text-gray-700"
                  title={dict.collapseTooltip}
                >
                  <TrendingDown className="w-4 h-4" />
                </Button>
              </div>
            </div>
            <div className="grid grid-cols-6 gap-3">
              <div className="text-center bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-blue-100">
                <div className="text-lg font-bold text-blue-700">
                  {stats.total}
                </div>
                <div className="text-xs text-blue-600">{dict.stats.total}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-2 shadow-sm border border-indigo-100">
                <div className="text-lg font-bold text-indigo-700">
                  {stats.male}
                </div>
                <div className="text-xs text-indigo-600">{dict.stats.male}</div>
              </div>
              <div className="text-center bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-2 shadow-sm border border-purple-100">
                <div className="text-lg font-bold text-purple-700">
                  {stats.female}
                </div>
                <div className="text-xs text-purple-600">
                  {dict.stats.female}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-2 shadow-sm border border-emerald-100">
                <div className="text-lg font-bold text-emerald-700">
                  {stats.verified}
                </div>
                <div className="text-xs text-emerald-600">
                  {dict.stats.verified}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-2 shadow-sm border border-orange-100">
                <div className="text-lg font-bold text-orange-700">
                  {stats.activeToday}
                </div>
                <div className="text-xs text-orange-600">
                  {dict.stats.active}
                </div>
              </div>
              <div className="text-center bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg p-2 shadow-sm border border-teal-100">
                <div className="text-lg font-bold text-teal-700">
                  {stats.profilesComplete}%
                </div>
                <div className="text-xs text-teal-600">
                  {dict.stats.complete}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </header>
  );
};

// ============================================================================
// Main Candidates Manager Component
// ============================================================================
interface CandidatesManagerProps {
  matchmakerDict: MatchmakerPageDictionary;
  profileDict: ProfilePageDictionary;
  locale: string;
}

const CandidatesManager: React.FC<CandidatesManagerProps> = ({
  matchmakerDict,
  profileDict,
  locale,
}) => {
  // --- State Management ---
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [mobileView, setMobileView] = useState<MobileView>('double');
  const [isMobile, setIsMobile] = useState(false);
  const [showFiltersPanel, setShowFiltersPanel] = useState(false);
  const [showFiltersMobile, setShowFiltersMobile] = useState(false);
  const [showManualAddDialog, setShowManualAddDialog] = useState(false);
  const [isHeaderCompact, setIsHeaderCompact] = useState(true);
  const [isQuickViewEnabled, setIsQuickViewEnabled] = useState(false);

  // --- Virtual Search State ---
  const [showVirtualUserDialog, setShowVirtualUserDialog] = useState(false);
  const [showSavedVirtualProfiles, setShowSavedVirtualProfiles] =
    useState(false);

  // --- AI State ---
  const [aiTargetCandidate, setAiTargetCandidate] = useState<Candidate | null>(
    null
  );
  const [comparisonSelection, setComparisonSelection] = useState<
    Record<string, Candidate>
  >({});
  const [aiMatches, setAiMatches] = useState<AiMatch[]>([]);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isAnalysisDialogOpen, setIsAnalysisDialogOpen] = useState(false);
  const [isBulkUpdating, setIsBulkUpdating] = useState(false);
  const [feedbackCandidate, setFeedbackCandidate] = useState<Candidate | null>(
    null
  );
  const [analyzedCandidate, setAnalyzedCandidate] = useState<Candidate | null>(
    null
  );

  // --- Session & Permissions ---
  const { data: session } = useSession();
  const isAdmin = session?.user?.role === 'ADMIN';

  const handleOpenAiAnalysis = useCallback((candidate: Candidate) => {
    setAnalyzedCandidate(candidate);
  }, []);

  const handleOpenProfileFeedback = useCallback((candidate: Candidate) => {
    setFeedbackCandidate(candidate);
  }, []);

  const handleCloseAiAnalysis = () => {
    setAnalyzedCandidate(null);
  };

  // --- Custom Hooks ---
  const {
    loading,
    candidates,
    maleCandidates,
    femaleCandidates,
    setSorting,
    setFilters: setCandidatesFilters,
    refresh,
  } = useCandidates();

  const {
    filters,
    setFilters,
    savedFilters,
    recentSearches,
    popularFilters,
    activeFilters,
    saveFilter,
    resetFilters,
    clearRecentSearches,
    toggleSeparateFiltering,
    updateMaleFilters,
    updateFemaleFilters,
    copyFilters,
    updateMaleSearchQuery,
    updateFemaleSearchQuery,
    removeFilter,
  } = useFilterLogic({ onFilterChange: setCandidatesFilters });

  // --- Derived State ---
  const activeFilterCount = useMemo(
    () => activeFilters.length,
    [activeFilters]
  );

  const heroStats = useMemo(() => {
    const total = candidates.length;
    const male = candidates.filter((c) => c.profile.gender === 'MALE').length;
    const female = candidates.filter(
      (c) => c.profile.gender === 'FEMALE'
    ).length;
    const verified = candidates.filter((c) => c.isVerified).length;
    const activeToday = candidates.filter((c) => {
      const lastActive = new Date(c.createdAt);
      const today = new Date();

      return (
        (today.getTime() - lastActive.getTime()) / (1000 * 60 * 60 * 24) <= 7
      );
    }).length;
    const profilesComplete =
      total > 0
        ? Math.round(
            (candidates.filter((c) => c.isProfileComplete).length / total) * 100
          )
        : 0;
    return { total, male, female, verified, activeToday, profilesComplete };
  }, [candidates]);

  // --- Effects ---
  useEffect(() => {
    const checkScreen = () => {
      setShowFiltersPanel(window.innerWidth >= 1024);
      setIsMobile(window.innerWidth < 768);
    };
    checkScreen();
    window.addEventListener('resize', checkScreen);
    return () => window.removeEventListener('resize', checkScreen);
  }, []);

  // --- Event Handlers ---
  const handleCandidateAdded = useCallback(() => {
    refresh();
    toast.success('מועמד חדש נוסף בהצלחה!');
  }, [refresh]);

  const handleSearch = useCallback(
    (value: string) => {
      setFilters({ searchQuery: value });
    },
    [setFilters]
  );

  const handleRemoveFilter = useCallback(
    (key: keyof CandidatesFilter, value?: string) => {
      removeFilter(key, value);
    },
    [removeFilter]
  );

  const handleCandidateAction = useCallback(
    async (type: CandidateAction, candidate: Candidate) => {
      console.log(
        `Action '${type}' triggered for candidate: ${candidate.firstName}`
      );
    },
    []
  );

  const handleFilterSave = useCallback(
    async (name: string) => {
      try {
        await saveFilter(name, filters);
        toast.success('הפילטר נשמר בהצלחה');
      } catch {
        toast.error('שגיאה בשמירת הפילטר');
      }
    },
    [filters, saveFilter]
  );

  const handleSetAiTarget = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      if (aiTargetCandidate?.id === candidate.id) {
        handleClearAiTarget(e);
        return;
      }
      setAiTargetCandidate(candidate);
      setAiMatches([]);
      setComparisonSelection({});
      toast.info(`מועמד מטרה נבחר: ${candidate.firstName}.`, {
        position: 'bottom-center',
      });
    },
    [aiTargetCandidate]
  );

  const handleClearAiTarget = (e: React.MouseEvent) => {
    e.stopPropagation();
    setAiTargetCandidate(null);
    setAiMatches([]);
    setComparisonSelection({});
    toast.info('בחירת מועמד מטרה בוטלה.', { position: 'bottom-center' });
  };

  const handleToggleComparison = useCallback(
    (candidate: Candidate, e: React.MouseEvent) => {
      e.stopPropagation();
      setComparisonSelection((prev) => {
        const newSelection = { ...prev };
        if (newSelection[candidate.id]) delete newSelection[candidate.id];
        else newSelection[candidate.id] = candidate;
        return newSelection;
      });
    },
    []
  );

  // --- Virtual Profile Handler ---
  const handleVirtualProfileSelect = useCallback((virtualProfile: any) => {
    // המרת הפרופיל הוירטואלי למבנה של מועמד (Candidate)
    const mockCandidate: VirtualCandidate = {
      id: virtualProfile.id,
      firstName: virtualProfile.name || 'משתמש',
      lastName: 'וירטואלי (AI)',
      email: 'virtual@ai.com',
      createdAt: new Date(),
      status: 'ACTIVE',
      images: [],
      isProfileComplete: true,
      source: 'MANUAL_ENTRY',
      isVerified: false,
      profile: {
        gender: virtualProfile.gender,
        religiousLevel: virtualProfile.religiousLevel,
        // ממלאים פרטים נוספים מהפרופיל הגנרטיבי
        city: virtualProfile.generatedProfile.inferredCity,
        occupation: virtualProfile.generatedProfile.inferredOccupation,
        // חישוב גיל ליום הולדת
        birthDate: new Date(
          new Date().setFullYear(
            new Date().getFullYear() -
              virtualProfile.generatedProfile.inferredAge
          )
        ),
        availabilityStatus: 'AVAILABLE',
      },
      // שדות מיוחדים לזיהוי וירטואלי ותצוגת AI
      isVirtual: true,
      aiReasoning:
        virtualProfile.editedSummary ||
        virtualProfile.generatedProfile.displaySummary,
      
      // 🔥 התיקון: שמירת המידע הגולמי לשימוש בחיפוש 🔥
      virtualData: {
        virtualProfileId: virtualProfile.id,
        virtualProfile: virtualProfile.generatedProfile,
        gender: virtualProfile.gender,
        religiousLevel: virtualProfile.religiousLevel,
        editedSummary: virtualProfile.editedSummary
      }
    } as unknown as VirtualCandidate;

    setAiTargetCandidate(mockCandidate);
    setAiMatches([]);
    setComparisonSelection({});

    toast.success('פרופיל וירטואלי נטען! כעת ניתן לבצע חיפוש AI.');
  }, []);


  const handleUpdateAllProfiles = async () => {
    if (
      !confirm(
        'פעולה זו תפעיל את ה-AI על כל המועמדים במערכת. זה עשוי לקחת מספר דקות. האם להמשיך?'
      )
    )
      return;

    setIsBulkUpdating(true);
    const toastId = toast.loading('מאתחל תהליך עדכון...', {
      duration: Infinity,
    });

    try {
      // שלב 1: איפוס דגלים
      const resetRes = await fetch('/api/ai/matchmaker/batch-process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'RESET_FLAGS' }),
      });

      if (!resetRes.ok) throw new Error('Failed to start process');
      const resetData = await resetRes.json();
      const totalToProcess = resetData.count;
      let processedSoFar = 0;

      toast.message(`נמצאו ${totalToProcess} פרופילים לעדכון. מתחיל עיבוד...`, {
        id: toastId,
      });

      // שלב 2: לולאת עיבוד
      let completed = false;

      while (!completed) {
        const batchRes = await fetch('/api/ai/matchmaker/batch-process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'PROCESS_BATCH', batchSize: 4 }),
        });

        if (!batchRes.ok) throw new Error('Error during batch processing');

        const batchData = await batchRes.json();

        processedSoFar += batchData.processed;
        const percent = Math.round((processedSoFar / totalToProcess) * 100);

        toast.loading(
          `מעבד פרופילים... ${percent}% (${processedSoFar}/${totalToProcess})`,
          { id: toastId }
        );

        if (batchData.completed || batchData.remaining === 0) {
          completed = true;
        }
      }

      toast.success('העדכון הכללי הושלם בהצלחה!', {
        id: toastId,
        duration: 4000,
      });
      refresh();
    } catch (error) {
      console.error('Bulk update failed:', error);
      toast.error('שגיאה בתהליך העדכון. נסה שוב מאוחר יותר.', {
        id: toastId,
        duration: 4000,
      });
    } finally {
      setIsBulkUpdating(false);
    }
  };

  const direction = locale === 'he' ? 'rtl' : 'ltr';

  // --- Render ---
  return (
    <div
      className="min-h-screen flex flex-col bg-gradient-to-br from-slate-50 via-indigo-50/10 to-purple-50/5"
      dir={direction}
    >
      <MinimalHeader
        stats={heroStats}
        onAddCandidate={() => setShowManualAddDialog(true)}
        onRefresh={refresh}
        isRefreshing={loading}
        onBulkUpdate={handleUpdateAllProfiles}
        isBulkUpdating={isBulkUpdating}
        isAdmin={isAdmin}
        isCompact={isHeaderCompact}
        onToggleCompact={() => setIsHeaderCompact(!isHeaderCompact)}
        dict={matchmakerDict.candidatesManager.header}
      />

      {isHeaderCompact && (
        <div className="flex-shrink-0 bg-white/80 backdrop-blur-sm border-b border-gray-100 py-3 px-4 mt-16">
          <div className="container mx-auto px-2">
            <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-3">
              {!filters.separateFiltering && (
                <div className="w-full md:flex-1 md:max-w-md">
                  <SearchBar
                    value={filters.searchQuery || ''}
                    onChange={handleSearch}
                    placeholder={
                      matchmakerDict.candidatesManager.searchBar
                        .generalPlaceholder
                    }
                    recentSearches={recentSearches}
                    onClearRecentSearches={clearRecentSearches}
                    dict={matchmakerDict.candidatesManager.searchBar}
                  />
                </div>
              )}

              <div className="flex items-center justify-between w-full md:w-auto md:justify-start gap-2 flex-wrap">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="bg-white/90 shadow-sm border border-gray-200"
                    >
                      <ArrowUpDown
                        className={cn(
                          'w-4 h-4',
                          locale === 'he' ? 'ml-1' : 'mr-1'
                        )}
                      />
                      {matchmakerDict.candidatesManager.controls.sort}
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuLabel>
                      {matchmakerDict.candidatesManager.controls.sortBy}
                    </DropdownMenuLabel>
                    <DropdownMenuSeparator />
                    {SORT_OPTIONS.map((option) => (
                      <DropdownMenuItem
                        key={option.value}
                        onClick={() =>
                          setSorting(
                            option.value,
                            option.defaultOrder as 'asc' | 'desc'
                          )
                        }
                      >
                        {
                          matchmakerDict.candidatesManager.sortOptions[
                            option.value as keyof typeof matchmakerDict.candidatesManager.sortOptions
                          ]
                        }
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>

                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsQuickViewEnabled(!isQuickViewEnabled)}
                  className="bg-white/90 shadow-sm border border-gray-200"
                >
                  {isQuickViewEnabled ? (
                    <EyeOff
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  ) : (
                    <Eye
                      className={cn(
                        'w-4 h-4',
                        locale === 'he' ? 'ml-1' : 'mr-1'
                      )}
                    />
                  )}

                  {isQuickViewEnabled
                    ? matchmakerDict.candidatesManager.controls.disableQuickView
                    : matchmakerDict.candidatesManager.controls.enableQuickView}
                </Button>

                {/* --- כפתור חיפוש וירטואלי חדש --- */}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowSavedVirtualProfiles(true)}
                  className="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white border-0 hover:opacity-90 shadow-sm"
                >
                  <UserCircle
                    className={cn('w-4 h-4', locale === 'he' ? 'ml-1' : 'mr-1')}
                  />
                  חיפוש וירטואלי
                </Button>

                <div className="hidden lg:flex">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowFiltersPanel(!showFiltersPanel)}
                    className="bg-white/90 shadow-sm border border-gray-200"
                  >
                    <Filter className="w-4 h-4 ml-1" />
                    {showFiltersPanel
                      ? matchmakerDict.candidatesManager.controls.hideFilters
                      : matchmakerDict.candidatesManager.controls.filters}
                  </Button>
                </div>

                <Sheet
                  open={showFiltersMobile}
                  onOpenChange={setShowFiltersMobile}
                >
                  <SheetTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="lg:hidden relative bg-white/90 shadow-sm border border-gray-200"
                    >
                      <Filter className="w-4 h-4 ml-1" />
                      {matchmakerDict.candidatesManager.controls.filters}
                      {activeFilterCount > 0 && (
                        <Badge className="absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center bg-indigo-500 border-0 text-xs">
                          {activeFilterCount}
                        </Badge>
                      )}
                    </Button>
                  </SheetTrigger>
                  <SheetContent
                    className="w-full h-full flex flex-col p-0 sm:max-w-md"
                    side={direction === 'rtl' ? 'right' : 'left'}
                  >
                    <div className="flex-1 overflow-y-auto p-4 pt-10">
                      <FilterPanel
                        filters={filters}
                        onFiltersChange={setFilters}
                        onSavePreset={handleFilterSave}
                        onReset={resetFilters}
                        savedFilters={savedFilters.map((f) => ({
                          id: f.id,
                          name: f.name,
                          isDefault: f.isDefault,
                        }))}
                        popularFilters={popularFilters}
                        separateFiltering={filters.separateFiltering}
                        onToggleSeparateFiltering={toggleSeparateFiltering}
                        onMaleFiltersChange={updateMaleFilters}
                        onFemaleFiltersChange={updateFemaleFilters}
                        onCopyFilters={copyFilters}
                        dict={matchmakerDict.candidatesManager.filterPanel}
                        className="pb-10"
                      />
                    </div>
                  </SheetContent>
                </Sheet>

                <div className="flex gap-1 bg-white/90 p-1 rounded-lg shadow-sm border border-gray-200">
                  {isMobile ? (
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button
                          variant="outline"
                          size="sm"
                          className="w-24 justify-between px-2 border-0"
                        >
                          {mobileView === 'split' && (
                            <Users className="w-4 h-4" />
                          )}
                          {mobileView === 'single' && (
                            <View className="w-4 h-4" />
                          )}
                          {mobileView === 'double' && (
                            <Columns className="w-4 h-4" />
                          )}
                          <ArrowUpDown className="w-3 h-3 opacity-50 ml-1" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuRadioGroup
                          value={mobileView}
                          onValueChange={(value) =>
                            setMobileView(value as MobileView)
                          }
                        >
                          <DropdownMenuRadioItem value="split">
                            <Users className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .split
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="single">
                            <View className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .singleCol
                            }
                          </DropdownMenuRadioItem>
                          <DropdownMenuRadioItem value="double">
                            <Columns className="w-4 h-4 mr-2" />
                            {
                              matchmakerDict.candidatesManager.controls.mobile
                                .doubleCol
                            }
                          </DropdownMenuRadioItem>
                        </DropdownMenuRadioGroup>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  ) : (
                    VIEW_OPTIONS.map((option) => (
                      <Button
                        key={option.value}
                        variant={
                          viewMode === option.value ? 'default' : 'ghost'
                        }
                        size="icon"
                        onClick={() => setViewMode(option.value as ViewMode)}
                        className={cn(
                          'h-8 w-8',
                          viewMode === option.value &&
                            'bg-indigo-500 text-white'
                        )}
                      >
                        {option.value === 'grid' ? (
                          <LayoutGrid className="w-4 h-4" />
                        ) : (
                          <List className="w-4 h-4" />
                        )}
                      </Button>
                    ))
                  )}
                </div>
              </div>
            </div>
            <div className="mt-2">
              <ActiveFilters
                filters={filters}
                onRemoveFilter={handleRemoveFilter}
                onResetAll={resetFilters}
                dict={matchmakerDict.candidatesManager.activeFilters}
              />
            </div>
          </div>
        </div>
      )}

      <main
        className={cn(
          'flex-1 min-h-0 container mx-auto px-6 pb-4 pt-4',
          !isHeaderCompact && 'mt-32'
        )}
      >
        <div className="flex gap-4 h-full">
          {showFiltersPanel && (
            <aside className="hidden lg:block w-72 flex-shrink-0">
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 h-full flex flex-col">
                <FilterPanel
                  filters={filters}
                  onFiltersChange={setFilters}
                  onSavePreset={handleFilterSave}
                  onReset={resetFilters}
                  savedFilters={savedFilters.map((f) => ({
                    id: f.id,
                    name: f.name,
                    isDefault: f.isDefault,
                  }))}
                  popularFilters={popularFilters}
                  separateFiltering={filters.separateFiltering}
                  onToggleSeparateFiltering={toggleSeparateFiltering}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  className="flex-1 overflow-y-auto"
                  dict={matchmakerDict.candidatesManager.filterPanel}
                />
              </div>
            </aside>
          )}

          <div className="flex-1 min-w-0 h-full">
            {loading ? (
              <LoadingContainer>
                <div className="h-full bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl animate-pulse shadow-lg"></div>
              </LoadingContainer>
            ) : (
              <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border-0 overflow-hidden h-full">
                <SplitView
                  onOpenAiAnalysis={handleOpenAiAnalysis}
                  onSendProfileFeedback={handleOpenProfileFeedback}
                  maleCandidates={maleCandidates}
                  femaleCandidates={femaleCandidates}
                  allCandidates={candidates}
                  onCandidateAction={handleCandidateAction}
                  onCandidateClick={() => {}}
                  viewMode={viewMode}
                  mobileView={mobileView}
                  isLoading={loading || isAiLoading}
                  className="flex-1 overflow-hidden"
                  aiTargetCandidate={aiTargetCandidate}
                  aiMatches={aiMatches}
                  isAiLoading={isAiLoading}
                  onSetAiTarget={handleSetAiTarget}
                  onClearAiTarget={handleClearAiTarget}
                  setAiMatches={setAiMatches}
                  setIsAiLoading={setIsAiLoading}
                  comparisonSelection={comparisonSelection}
                  onToggleComparison={handleToggleComparison}
                  separateFiltering={filters.separateFiltering ?? false}
                  maleFilters={filters.maleFilters}
                  femaleFilters={filters.femaleFilters}
                  onMaleFiltersChange={updateMaleFilters}
                  onFemaleFiltersChange={updateFemaleFilters}
                  onCopyFilters={copyFilters}
                  maleSearchQuery={filters.maleSearchQuery}
                  femaleSearchQuery={filters.femaleSearchQuery}
                  onMaleSearchChange={updateMaleSearchQuery}
                  onFemaleSearchChange={updateFemaleSearchQuery}
                  dict={matchmakerDict}
                  profileDict={profileDict}
                  isQuickViewEnabled={isQuickViewEnabled}
                  locale={locale}
                />
              </div>
            )}
          </div>
        </div>
      </main>
      <AnimatePresence>
        {aiTargetCandidate && Object.keys(comparisonSelection).length > 0 && (
          <motion.div
            initial={{ y: 100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 100, opacity: 0 }}
            className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"
          >
            <div className="bg-white/80 backdrop-blur-sm p-3 rounded-2xl shadow-2xl border flex items-center gap-4">
              <div className="flex items-center -space-x-4">
                {Object.values(comparisonSelection)
                  .slice(0, 3)
                  .map((c) => (
                    <div
                      key={c.id}
                      className="w-10 h-10 rounded-full overflow-hidden border-2 border-white bg-gray-200 flex items-center justify-center text-gray-500 font-bold"
                    >
                      {c.images?.find((img) => img.isMain) ? (
                        <Image
                          src={getRelativeCloudinaryPath(
                            c.images.find((img) => img.isMain)!.url
                          )}
                          alt={c.firstName}
                          width={40}
                          height={40}
                          className="object-cover"
                        />
                      ) : (
                        <span>
                          {c.firstName.charAt(0)}
                          {c.lastName.charAt(0)}
                        </span>
                      )}
                    </div>
                  ))}
                {Object.keys(comparisonSelection).length > 3 && (
                  <div className="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold text-gray-600 border-2 border-white">
                    +{Object.keys(comparisonSelection).length - 3}
                  </div>
                )}
              </div>
              <Button
                onClick={() => setIsAnalysisDialogOpen(true)}
                className="bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold shadow-lg"
              >
                <GitCompare
                  className={cn('w-4 h-4', locale === 'he' ? 'ml-2' : 'mr-2')}
                />
                {matchmakerDict.candidatesManager.controls.compareButton.replace(
                  '{{count}}',
                  String(Object.keys(comparisonSelection).length)
                )}
              </Button>
              <Button
                variant="ghost"
                size="icon"
                className="h-8 w-8 rounded-full"
                onClick={() => setComparisonSelection({})}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      <AiMatchmakerProfileAdvisorDialog
        isOpen={!!analyzedCandidate}
        onClose={handleCloseAiAnalysis}
        candidate={analyzedCandidate}
        dict={matchmakerDict.candidatesManager.aiProfileAdvisor}
        locale={locale}
      />
      <ProfileFeedbackDialog
        isOpen={!!feedbackCandidate}
        onClose={() => setFeedbackCandidate(null)}
        candidate={feedbackCandidate}
        locale={locale}
        dict={matchmakerDict.candidatesManager.profileFeedbackDialog}
      />

      {/* --- Dialogs --- */}
      <AddManualCandidateDialog
        isOpen={showManualAddDialog}
        onClose={() => setShowManualAddDialog(false)}
        onCandidateAdded={handleCandidateAdded}
        dict={matchmakerDict.candidatesManager.addManualCandidateDialog}
        locale={locale}
      />

      <AiMatchAnalysisDialog
        isOpen={isAnalysisDialogOpen}
        onClose={() => setIsAnalysisDialogOpen(false)}
        targetCandidate={aiTargetCandidate}
        comparisonCandidates={Object.values(comparisonSelection)}
        dict={matchmakerDict.candidatesManager.aiAnalysis}
        locale={locale}
      />

      {/* --- Virtual Search Dialogs (NEW) --- */}
      <VirtualUserDialog
        isOpen={showVirtualUserDialog}
        onClose={() => setShowVirtualUserDialog(false)}
        onProfileCreated={handleVirtualProfileSelect}
        locale={locale}
      />

      <SavedVirtualProfiles
        isOpen={showSavedVirtualProfiles}
        onClose={() => setShowSavedVirtualProfiles(false)}
        onSelectProfile={handleVirtualProfileSelect}
        onCreateNew={() => {
          setShowSavedVirtualProfiles(false);
          setShowVirtualUserDialog(true);
        }}
        locale={locale}
      />
    </div>
  );
};

export default CandidatesManager;
--- End of Content for index.tsx ---

