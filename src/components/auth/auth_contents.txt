################################################################################
# Directory Content Map For: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth
# Generated on: 2025-12-29 14:25:50
# Filter: Only content of code files (.bat, .c, .cfg, .conf, .cpp, .cs, .css, .go, .h, .html, .ini, .java, .js, .json, .jsx, .kt, .less, .md, .php, .py, .rb, .rs, .scss, .sh, .sql, .swift, .ts, .tsx, .txt, .xml, .yaml, .yml) is included.
################################################################################

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\AuthError.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/AuthError.tsx

'use client';

import { useSearchParams, useRouter } from "next/navigation";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

export default function AuthError() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const error = searchParams.get("error");

  const getErrorMessage = (error: string | null) => {
    switch (error) {
      case "CredentialsSignin": return "驻专 转专转 砖转  .  住 砖转.";
      case "OAuthAccountNotLinked": return "转转   专 砖转 住驻拽 专 (砖, ).  转专 爪注转.";
      default: return "专注 砖  爪驻 转 转.  住 砖转.";
    }
  };

  return (
    <Card className="w-full max-w-md">
      <CardHeader className="text-center">
        <AlertTriangle className="mx-auto h-12 w-12 text-red-500" />
        <CardTitle className="text-2xl font-bold text-red-600 mt-4">
          专注 砖
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 text-center">
        <p className="text-gray-600">{getErrorMessage(error)}</p>
        <Button onClick={() => router.push("/auth/signin")} className="w-full">
          专 祝 转专转
        </Button>
      </CardContent>
    </Card>
  );
}
--- End of Content for AuthError.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ConsentCheckbox.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/ConsentCheckbox.tsx
'use client';

import React from 'react';
import Link from 'next/link';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface ConsentCheckboxProps {
  checked: boolean;
  onChange: (isChecked: boolean) => void;
  error?: string | null;
  dict: RegisterStepsDict['consentCheckbox'];
}

const ConsentCheckbox: React.FC<ConsentCheckboxProps> = ({
  checked,
  onChange,
  error,
  dict,
}) => {
  const textParts = dict.text.split(/\{termsLink\}|\{privacyLink\}/);

  return (
    <div className="space-y-2">
      <div className="flex items-start space-x-2 rtl:space-x-reverse">
        <input
          type="checkbox"
          id="termsConsent"
          checked={checked}
          onChange={(e) => onChange(e.target.checked)}
          className={`mt-1 h-4 w-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500 ${error ? 'border-red-500' : ''}`}
        />
        <label htmlFor="termsConsent" className="text-sm text-gray-700">
          {textParts[0]}
          <Link
            href="/legal/terms-of-service"
            target="_blank"
            className="font-medium text-cyan-600 hover:text-cyan-700 underline"
          >
            {dict.termsLink}
          </Link>
          {textParts[1]}
          <Link
            href="/legal/privacy-policy"
            target="_blank"
            className="font-medium text-cyan-600 hover:text-cyan-700 underline"
          >
            {dict.privacyLink}
          </Link>
          {textParts[2]}
        </label>
      </div>
      {error && <p className="text-xs text-red-500">{error}</p>}
    </div>
  );
};

export default ConsentCheckbox;
--- End of Content for ConsentCheckbox.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ForgotPasswordForm.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/ResetPasswordForm.tsx
'use client';

import { useState, FormEvent, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Lock,
  KeySquare,
  Loader2,
  AlertCircle,
  CheckCircle,
  Eye,
  EyeOff,
  Mail,
} from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import Link from 'next/link';

const validatePassword = (value: string): string | null => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  if (!passwordRegex.test(value)) {
    return '住住 转  驻转 8 转, 转 , 转 拽 住驻专.';
  }
  return null;
};

export default function ResetPasswordForm() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [passwordError, setPasswordError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  useEffect(() => {
    const emailFromQuery = searchParams.get('email');
    const tokenFromQuery = searchParams.get('token');

    if (emailFromQuery) {
      setEmail(emailFromQuery);
    }
    if (tokenFromQuery) {
      setOtp(tokenFromQuery);
    }
  }, [searchParams]);

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setPasswordError(null);
    setSuccessMessage(null);

    if (!email) {
      setError('转转  住专.  专 转 住 砖转.');
      setIsLoading(false);
      return;
    }
    if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
      setError('拽 转 (OTP)  转  6 住驻专转.');
      setIsLoading(false);
      return;
    }
    const passValidationError = validatePassword(newPassword);
    if (passValidationError) {
      setPasswordError(passValidationError);
      setIsLoading(false);
      return;
    }
    if (newPassword !== confirmPassword) {
      setError('住住转  转转.');
      setIsLoading(false);
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp, newPassword }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || '专注 砖 驻住 住住.');
      }

      setSuccessMessage(
        data.message || '住住 驻住 爪! 注转 转 转专 注 住住 砖.'
      );
      setOtp('');
      setNewPassword('');
      setConfirmPassword('');
      setTimeout(() => {
        router.push('/auth/signin?reset=success');
      }, 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : '专注 砖  爪驻.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative border border-white/50">
      {/* UPDATED: Top Bar Gradient (Teal -> Orange -> Amber) */}
      <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"></div>
      
      <div className="p-6 sm:p-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">驻住 住住</h1>
          <p className="text-gray-600 text-sm">
             转 拽 转 (OTP) 砖拽转  转 住住 砖 砖.
          </p>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>砖</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        {passwordError && !error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>砖转 住住</AlertTitle>
            <AlertDescription id="password-error-message">
              {passwordError}
            </AlertDescription>
          </Alert>
        )}

        {successMessage && (
          // Success message can stay Green as it's a standard status color
          <Alert
            variant="default"
            className="mb-4 bg-green-50 border-green-200 text-green-700"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <AlertTitle>爪!</AlertTitle>
            <AlertDescription>
              {successMessage} 转 注专 祝 转专转...
            </AlertDescription>
          </Alert>
        )}

        {!successMessage && (
          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1">
              <label
                htmlFor="email-reset"
                className="block text-sm font-medium text-gray-700"
              >
                转转  (转) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="email"
                  id="email-reset"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@example.com"
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none"
                  disabled={isLoading || !!searchParams.get('email')}
                />
              </div>
            </div>
            <div className="space-y-1">
              <label
                htmlFor="otp-reset"
                className="block text-sm font-medium text-gray-700"
              >
                拽 转 (OTP) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <KeySquare className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="text"
                  id="otp-reset"
                  value={otp}
                  onChange={(e) =>
                    setOtp(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))
                  }
                  placeholder="xxxxxx"
                  maxLength={6}
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none tracking-widest text-center"
                  disabled={isLoading}
                  inputMode="numeric"
                />
              </div>
            </div>

            <div className="space-y-1">
              <label
                htmlFor="new-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                住住 砖 <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showPassword ? 'text' : 'password'}
                  id="new-password-reset"
                  aria-describedby={
                    passwordError ? 'password-error-message' : 'password-hint'
                  }
                  aria-invalid={!!passwordError}
                  value={newPassword}
                  onChange={(e) => {
                    setNewPassword(e.target.value);
                    const validationErr = validatePassword(e.target.value);
                    if (e.target.value && validationErr)
                      setPasswordError(validationErr);
                    else setPasswordError(null);
                  }}
                  placeholder="驻转 8 转, 转 , 拽 住驻专"
                  required
                  // UPDATED: Focus Ring (Error red, else Teal)
                  className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none ${
                    passwordError
                      ? 'border-red-500 focus:ring-red-200'
                      : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                  }`}
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showPassword ? '住转专 住住' : '爪 住住'}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
              {!passwordError && (
                <p id="password-hint" className="mt-1 text-xs text-gray-500">
                  转  驻转 8 转, 转 , 转 拽 住驻专.
                </p>
              )}
            </div>

            <div className="space-y-1">
              <label
                htmlFor="confirm-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                转 住住 砖 <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showConfirmPassword ? 'text' : 'password'}
                  id="confirm-password-reset"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder=" 转 住住 砖 砖"
                  required
                  // UPDATED: Focus Ring
                  className="w-full pr-10 pl-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none"
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showConfirmPassword ? '住转专 住住' : '爪 住住'}
                >
                  {showConfirmPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </div>

            <Button
              type="submit"
              disabled={
                isLoading ||
                !!passwordError ||
                !otp ||
                !newPassword ||
                !confirmPassword ||
                newPassword !== confirmPassword
              }
              // UPDATED: Button Gradient (Teal -> Orange -> Amber)
              className="w-full py-3 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg flex items-center justify-center gap-2"
            >
              {isLoading ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin mr-2" />
                  <span>驻住 住住...</span>
                </>
              ) : (
                '驻住 住住'
              )}
            </Button>
          </form>
        )}

        <div className="mt-6 text-center">
          {/* UPDATED: Link Color (Teal) */}
          <Link
            href="/auth/signin"
            className="text-sm text-teal-600 hover:text-teal-700 hover:underline"
          >
            专 转专转
          </Link>
        </div>
      </div>
    </div>
  );
}
--- End of Content for ForgotPasswordForm.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\FullScreenLoadingOverlay.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/FullScreenLoadingOverlay.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { CheckCircle2, Sparkles, Loader2 } from 'lucide-react';
import StandardizedLoadingSpinner from '@/components/questionnaire/common/StandardizedLoadingSpinner';

export type LoadingStep = {
  id: string;
  text: string;
  subtext?: string;
};

interface FullScreenLoadingOverlayProps {
  isVisible: boolean;
  currentStepId: string;
  steps: LoadingStep[];
  dict: {
    title: string;
    subtitle: string;
  };
  locale?: 'he' | 'en';
}

const FullScreenLoadingOverlay: React.FC<FullScreenLoadingOverlayProps> = ({
  isVisible,
  currentStepId,
  steps,
  dict,
  locale = 'he',
}) => {
  const [completedSteps, setCompletedSteps] = useState<string[]>([]);

  // 注拽 专 砖 砖砖
  useEffect(() => {
    if (!isVisible) {
      setCompletedSteps([]);
      return;
    }

    const currentIndex = steps.findIndex((s) => s.id === currentStepId);
    if (currentIndex > 0) {
      const newCompleted = steps.slice(0, currentIndex).map((s) => s.id);
      setCompletedSteps(newCompleted);
    }
  }, [currentStepId, steps, isVisible]);

  const currentStep = steps.find((s) => s.id === currentStepId);

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.3 }}
          className="fixed inset-0 z-[9999] flex flex-col items-center justify-center"
          style={{
            background:
              'linear-gradient(135deg, rgba(248, 250, 252, 0.97) 0%, rgba(240, 253, 250, 0.97) 50%, rgba(255, 247, 237, 0.97) 100%)',
            backdropFilter: 'blur(12px)',
          }}
        >
          {/* 专拽注  注 */}
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            {/* 专 注 */}
            <motion.div
              className="absolute -top-1/4 -right-1/4 w-1/2 h-1/2 rounded-full"
              style={{
                background:
                  'radial-gradient(circle, rgba(20, 184, 166, 0.08) 0%, transparent 70%)',
              }}
              animate={{
                scale: [1, 1.2, 1],
                opacity: [0.5, 0.8, 0.5],
              }}
              transition={{
                duration: 4,
                repeat: Infinity,
                ease: 'easeInOut',
              }}
            />
            {/* 专 转转 */}
            <motion.div
              className="absolute -bottom-1/4 -left-1/4 w-1/2 h-1/2 rounded-full"
              style={{
                background:
                  'radial-gradient(circle, rgba(249, 115, 22, 0.06) 0%, transparent 70%)',
              }}
              animate={{
                scale: [1.2, 1, 1.2],
                opacity: [0.5, 0.8, 0.5],
              }}
              transition={{
                duration: 4,
                repeat: Infinity,
                ease: 'easeInOut',
                delay: 2,
              }}
            />
          </div>

          {/* 转 专 */}
          <div className="relative z-10 flex flex-col items-center max-w-md px-6 text-center">
            {/*  驻砖 - 砖转砖 -StandardizedLoadingSpinner  拽住  住祝 砖 */}
            <div className="mb-0">
              <StandardizedLoadingSpinner className="!min-h-0 !p-0" />
            </div>

            {/* 转专转 */}
            <motion.h2
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
              className="text-2xl font-bold text-gray-800 mb-2"
            >
              {dict.title}
            </motion.h2>

            {/* 转转-转专转 */}
            <motion.p
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.5 }}
              className="text-gray-500 text-sm mb-8"
            >
              {dict.subtitle}
            </motion.p>

            {/* 砖 转拽转 */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.6 }}
              className="w-full space-y-3"
            >
              {steps.map((step, index) => {
                const isCompleted = completedSteps.includes(step.id);
                const isCurrent = step.id === currentStepId;

                return (
                  <motion.div
                    key={step.id}
                    initial={{ opacity: 0, x: locale === 'he' ? 20 : -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.7 + index * 0.1 }}
                    className={`flex items-center gap-3 p-3 rounded-xl transition-all duration-300 ${
                      isCurrent
                        ? 'bg-gradient-to-r from-teal-50 to-orange-50 border border-teal-200 shadow-sm'
                        : isCompleted
                          ? 'bg-green-50/50'
                          : 'bg-gray-50/50'
                    }`}
                  >
                    {/* 拽 住住 */}
                    <div
                      className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${
                        isCompleted
                          ? 'bg-green-500 text-white'
                          : isCurrent
                            ? 'bg-gradient-to-br from-teal-500 to-orange-500 text-white'
                            : 'bg-gray-200 text-gray-400'
                      }`}
                    >
                      {isCompleted ? (
                        <motion.div
                          initial={{ scale: 0 }}
                          animate={{ scale: 1 }}
                          transition={{
                            type: 'spring',
                            stiffness: 500,
                            damping: 25,
                          }}
                        >
                          <CheckCircle2 className="w-5 h-5" />
                        </motion.div>
                      ) : isCurrent ? (
                        <Loader2 className="w-5 h-5 animate-spin" />
                      ) : (
                        <span className="text-sm font-medium">{index + 1}</span>
                      )}
                    </div>

                    {/* 拽住 砖 */}
                    <div className="flex-1 text-right rtl:text-right ltr:text-left">
                      <p
                        className={`text-sm font-medium transition-colors ${
                          isCurrent
                            ? 'text-teal-700'
                            : isCompleted
                              ? 'text-green-600'
                              : 'text-gray-400'
                        }`}
                      >
                        {step.text}
                      </p>
                      {step.subtext && isCurrent && (
                        <motion.p
                          initial={{ opacity: 0, height: 0 }}
                          animate={{ opacity: 1, height: 'auto' }}
                          className="text-xs text-gray-500 mt-0.5"
                        >
                          {step.subtext}
                        </motion.p>
                      )}
                    </div>
                  </motion.div>
                );
              })}
            </motion.div>

            {/* 注转 驻 */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 1 }}
              className="mt-8 flex items-center gap-2 text-xs text-gray-400"
            >
              <Sparkles className="w-3 h-3" />
              <span>
                {locale === 'he'
                  ? '  住专 转 '
                  : "Please don't close this window"}
              </span>
            </motion.div>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default FullScreenLoadingOverlay;
--- End of Content for FullScreenLoadingOverlay.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\PhoneNumberInput.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/PhoneNumberInput.tsx
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { Phone, ChevronDown, Search, X, Edit } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// 专砖转 转 专转 注 拽转 转
const COUNTRIES = [
  // 转 驻驻专转
  {
    code: 'IL',
    name: 'Israel',
    nameHe: '砖专',
    flag: '',
    prefix: '+972',
    popular: true,
    placeholder: '50-123-4567',
  },
  {
    code: 'US',
    name: 'United States',
    nameHe: '专爪转 专转',
    flag: '吼',
    prefix: '+1',
    popular: true,
    placeholder: '555-123-4567',
  },
  {
    code: 'GB',
    name: 'United Kingdom',
    nameHe: '专',
    flag: '',
    prefix: '+44',
    popular: true,
    placeholder: '7123 456789',
  },
  {
    code: 'CA',
    name: 'Canada',
    nameHe: '拽',
    flag: '',
    prefix: '+1',
    popular: true,
    placeholder: '555-123-4567',
  },
  {
    code: 'FR',
    name: 'France',
    nameHe: '爪专驻转',
    flag: '',
    prefix: '+33',
    popular: true,
    placeholder: '06 12 34 56 78',
  },
  // ... 砖专 转 砖专转 转 专
  // (拽爪专转   住 拽, 专砖  拽转 拽 拽专 砖)
  {
    code: 'AR',
    name: 'Argentina',
    nameHe: '专',
    flag: '',
    prefix: '+54',
    popular: false,
    placeholder: '11 1234-5678',
  },
  {
    code: 'AU',
    name: 'Australia',
    nameHe: '住专',
    flag: '',
    prefix: '+61',
    popular: false,
    placeholder: '412 345 678',
  },
  {
    code: 'AT',
    name: 'Austria',
    nameHe: '住专',
    flag: '',
    prefix: '+43',
    popular: false,
    placeholder: '664 123456',
  },
  {
    code: 'BE',
    name: 'Belgium',
    nameHe: '',
    flag: 'ю',
    prefix: '+32',
    popular: false,
    placeholder: '470 12 34 56',
  },
  {
    code: 'BR',
    name: 'Brazil',
    nameHe: '专',
    flag: 'ю',
    prefix: '+55',
    popular: false,
    placeholder: '11 91234-5678',
  },
  {
    code: 'BG',
    name: 'Bulgaria',
    nameHe: '专',
    flag: 'ю',
    prefix: '+359',
    popular: false,
    placeholder: '87 123 4567',
  },
  {
    code: 'CL',
    name: 'Chile',
    nameHe: "爪'",
    flag: '',
    prefix: '+56',
    popular: false,
    placeholder: '9 1234 5678',
  },
  {
    code: 'CO',
    name: 'Colombia',
    nameHe: '拽',
    flag: '',
    prefix: '+57',
    popular: false,
    placeholder: '300 123 4567',
  },
  {
    code: 'HR',
    name: 'Croatia',
    nameHe: '拽专',
    flag: '',
    prefix: '+385',
    popular: false,
    placeholder: '91 234 567',
  },
  {
    code: 'CZ',
    name: 'Czech Republic',
    nameHe: "爪'",
    flag: '',
    prefix: '+420',
    popular: false,
    placeholder: '601 123 456',
  },
  {
    code: 'DK',
    name: 'Denmark',
    nameHe: '专拽',
    flag: '',
    prefix: '+45',
    popular: false,
    placeholder: '20 12 34 56',
  },
  {
    code: 'EE',
    name: 'Estonia',
    nameHe: '住',
    flag: '',
    prefix: '+372',
    popular: false,
    placeholder: '5123 4567',
  },
  {
    code: 'FI',
    name: 'Finland',
    nameHe: '驻',
    flag: '',
    prefix: '+358',
    popular: false,
    placeholder: '40 123 4567',
  },
  {
    code: 'GE',
    name: 'Georgia',
    nameHe: '专',
    flag: '',
    prefix: '+995',
    popular: false,
    placeholder: '555 12 34 56',
  },
  {
    code: 'DE',
    name: 'Germany',
    nameHe: '专',
    flag: '',
    prefix: '+49',
    popular: false,
    placeholder: '1512 3456789',
  },
  {
    code: 'GR',
    name: 'Greece',
    nameHe: '',
    flag: '',
    prefix: '+30',
    popular: false,
    placeholder: '694 123 4567',
  },
  {
    code: 'HU',
    name: 'Hungary',
    nameHe: '专',
    flag: '',
    prefix: '+36',
    popular: false,
    placeholder: '20 123 4567',
  },
  {
    code: 'IN',
    name: 'India',
    nameHe: '',
    flag: '',
    prefix: '+91',
    popular: false,
    placeholder: '91234 56789',
  },
  {
    code: 'IE',
    name: 'Ireland',
    nameHe: '专',
    flag: '',
    prefix: '+353',
    popular: false,
    placeholder: '85 123 4567',
  },
  {
    code: 'IT',
    name: 'Italy',
    nameHe: '',
    flag: '',
    prefix: '+39',
    popular: false,
    placeholder: '312 345 6789',
  },
  {
    code: 'LV',
    name: 'Latvia',
    nameHe: '',
    flag: '别',
    prefix: '+371',
    popular: false,
    placeholder: '21 234 567',
  },
  {
    code: 'LT',
    name: 'Lithuania',
    nameHe: '',
    flag: '别',
    prefix: '+370',
    popular: false,
    placeholder: '612 34567',
  },
  {
    code: 'LU',
    name: 'Luxembourg',
    nameHe: '拽住专',
    flag: '别',
    prefix: '+352',
    popular: false,
    placeholder: '621 123 456',
  },
  {
    code: 'MX',
    name: 'Mexico',
    nameHe: '拽住拽',
    flag: '拆',
    prefix: '+52',
    popular: false,
    placeholder: '55 1234 5678',
  },
  {
    code: 'MD',
    name: 'Moldova',
    nameHe: '',
    flag: '拆',
    prefix: '+373',
    popular: false,
    placeholder: '621 12 345',
  },
  {
    code: 'NL',
    name: 'Netherlands',
    nameHe: '',
    flag: '仇',
    prefix: '+31',
    popular: false,
    placeholder: '6 12345678',
  },
  {
    code: 'NZ',
    name: 'New Zealand',
    nameHe: ' ',
    flag: '仇',
    prefix: '+64',
    popular: false,
    placeholder: '21 123 4567',
  },
  {
    code: 'NO',
    name: 'Norway',
    nameHe: '专',
    flag: '仇',
    prefix: '+47',
    popular: false,
    placeholder: '412 34 567',
  },
  {
    code: 'PA',
    name: 'Panama',
    nameHe: '驻',
    flag: '叼',
    prefix: '+507',
    popular: false,
    placeholder: '6123-4567',
  },
  {
    code: 'PE',
    name: 'Peru',
    nameHe: '驻专',
    flag: '叼',
    prefix: '+51',
    popular: false,
    placeholder: '912 345 678',
  },
  {
    code: 'PL',
    name: 'Poland',
    nameHe: '驻',
    flag: '叼',
    prefix: '+48',
    popular: false,
    placeholder: '501 234 567',
  },
  {
    code: 'PT',
    name: 'Portugal',
    nameHe: '驻专',
    flag: '叼',
    prefix: '+351',
    popular: false,
    placeholder: '912 345 678',
  },
  {
    code: 'RO',
    name: 'Romania',
    nameHe: '专',
    flag: '佛',
    prefix: '+40',
    popular: false,
    placeholder: '712 345 678',
  },
  {
    code: 'RU',
    name: 'Russia',
    nameHe: '专住',
    flag: '佛',
    prefix: '+7',
    popular: false,
    placeholder: '912 123-45-67',
  },
  {
    code: 'RS',
    name: 'Serbia',
    nameHe: '住专',
    flag: '佛',
    prefix: '+381',
    popular: false,
    placeholder: '60 1234567',
  },
  {
    code: 'SK',
    name: 'Slovakia',
    nameHe: '住拽',
    flag: '葛',
    prefix: '+421',
    popular: false,
    placeholder: '901 123 456',
  },
  {
    code: 'SI',
    name: 'Slovenia',
    nameHe: '住',
    flag: '葛',
    prefix: '+386',
    popular: false,
    placeholder: '31 234 567',
  },
  {
    code: 'ZA',
    name: 'South Africa',
    nameHe: '专 驻专拽',
    flag: '筐',
    prefix: '+27',
    popular: false,
    placeholder: '82 123 4567',
  },
  {
    code: 'ES',
    name: 'Spain',
    nameHe: '住驻专',
    flag: '',
    prefix: '+34',
    popular: false,
    placeholder: '612 34 56 78',
  },
  {
    code: 'SE',
    name: 'Sweden',
    nameHe: '砖',
    flag: '葛',
    prefix: '+46',
    popular: false,
    placeholder: '70 123 45 67',
  },
  {
    code: 'CH',
    name: 'Switzerland',
    nameHe: '砖抓',
    flag: '',
    prefix: '+41',
    popular: false,
    placeholder: '78 123 45 67',
  },
  {
    code: 'TR',
    name: 'Turkey',
    nameHe: '专拽',
    flag: '桂',
    prefix: '+90',
    popular: false,
    placeholder: '531 234 56 78',
  },
  {
    code: 'UA',
    name: 'Ukraine',
    nameHe: '拽专',
    flag: '吼',
    prefix: '+380',
    popular: false,
    placeholder: '50 123 4567',
  },
  {
    code: 'UY',
    name: 'Uruguay',
    nameHe: '专',
    flag: '吼',
    prefix: '+598',
    popular: false,
    placeholder: '91 123 456',
  },
  {
    code: 'VE',
    name: 'Venezuela',
    nameHe: '爪',
    flag: '火',
    prefix: '+58',
    popular: false,
    placeholder: '412-1234567',
  },
  {
    code: 'JP',
    name: 'Japan',
    nameHe: '驻',
    flag: '',
    prefix: '+81',
    popular: false,
    placeholder: '90-1234-5678',
  },
  {
    code: 'CN',
    name: 'China',
    nameHe: '住',
    flag: '',
    prefix: '+86',
    popular: false,
    placeholder: '138 0013 8000',
  },
  {
    code: 'KR',
    name: 'South Korea',
    nameHe: '专 拽专',
    flag: '梆',
    prefix: '+82',
    popular: false,
    placeholder: '10-1234-5678',
  },
];

interface PhoneNumberInputProps {
  value: string | undefined;
  onChange: (value: string | undefined) => void;
  disabled?: boolean;
  locale: 'he' | 'en';
  error?: string;
}

const PhoneNumberInput: React.FC<PhoneNumberInputProps> = ({
  value,
  onChange,
  disabled = false,
  locale,
  error,
}) => {
  const [selectedCountry, setSelectedCountry] = useState(COUNTRIES[0]);
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [phoneNumber, setPhoneNumber] = useState('');
  const [isManualPrefix, setIsManualPrefix] = useState(false);
  const [manualPrefix, setManualPrefix] = useState('');

  const dropdownRef = useRef<HTMLDivElement>(null);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  // 住 转 驻 驻砖
  const filteredCountries = COUNTRIES.filter((country) => {
    const searchLower = searchTerm.toLowerCase();
    const name = locale === 'he' ? country.nameHe : country.name;
    return (
      name.toLowerCase().includes(searchLower) ||
      country.prefix.includes(searchTerm) ||
      country.code.toLowerCase().includes(searchLower)
    );
  });

  // : 驻驻专转 拽, 专  "
  const sortedCountries = filteredCountries.sort((a, b) => {
    if (a.popular && !b.popular) return -1;
    if (!a.popular && b.popular) return 1;
    const nameA = locale === 'he' ? a.nameHe : a.name;
    const nameB = locale === 'he' ? b.nameHe : b.name;
    return nameA.localeCompare(nameB);
  });

  // 注 注专 
  const updateFullValue = (prefix: string, number: string) => {
    const fullNumber = number ? `${prefix}${number.replace(/\D/g, '')}` : '';
    onChange(fullNumber);
  };

  // 驻 砖 住驻专 驻
  const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setPhoneNumber(newValue);

    const currentPrefix = isManualPrefix
      ? manualPrefix
      : selectedCountry.prefix;
    updateFullValue(currentPrefix, newValue);
  };

  // 驻 砖 拽转 转
  const handleManualPrefixChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let newPrefix = e.target.value;

    //  砖拽转 转 -+
    if (newPrefix && !newPrefix.startsWith('+')) {
      newPrefix = '+' + newPrefix;
    }

    setManualPrefix(newPrefix);
    updateFullValue(newPrefix, phoneNumber);
  };

  // 专转 
  const handleCountrySelect = (country: (typeof COUNTRIES)[0]) => {
    setSelectedCountry(country);
    setIsOpen(false);
    setSearchTerm('');
    setIsManualPrefix(false);
    setManualPrefix('');
    updateFullValue(country.prefix, phoneNumber);
  };

  // 注专 爪 拽转 转
  const enableManualPrefix = () => {
    setIsManualPrefix(true);
    setManualPrefix(selectedCountry.prefix);
    setIsOpen(false);
  };

  // 专 爪 专转 
  const disableManualPrefix = () => {
    setIsManualPrefix(false);
    setManualPrefix('');
    updateFullValue(selectedCountry.prefix, phoneNumber);
  };

  // 驻专拽 注专 住 拽转 住驻专
  useEffect(() => {
    if (value && value.startsWith('+')) {
      // 住 爪  转
      const matchingCountry = COUNTRIES.find((country) =>
        value.startsWith(country.prefix)
      );

      if (matchingCountry) {
        setSelectedCountry(matchingCountry);
        setIsManualPrefix(false);
        setManualPrefix('');
        const numberPart = value.substring(matchingCountry.prefix.length);
        setPhoneNumber(numberPart);
      } else {
        //   爪  转, 砖转砖 拽转 转
        const prefixMatch = value.match(/^\+\d+/);
        if (prefixMatch) {
          setIsManualPrefix(true);
          setManualPrefix(prefixMatch[0]);
          const numberPart = value.substring(prefixMatch[0].length);
          setPhoneNumber(numberPart);
        }
      }
    } else if (!value) {
      setPhoneNumber('');
      setIsManualPrefix(false);
      setManualPrefix('');
    }
  }, [value]);

  // 住专转 dropdown 爪 抓
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        containerRef.current &&
        !containerRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
        setSearchTerm('');
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () =>
        document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);

  // 驻拽住 注 驻砖 砖专砖 驻转转
  useEffect(() => {
    if (isOpen && searchInputRef.current) {
      setTimeout(() => searchInputRef.current?.focus(), 100);
    }
  }, [isOpen]);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Escape') {
      setIsOpen(false);
      setSearchTerm('');
    }
  };

  return (
    <div
      ref={containerRef}
      className="relative w-full"
      onKeyDown={handleKeyDown}
    >
      {/* 
          砖 拽专: 住驻 dir="ltr"  驻转 住专  砖  
          (拽转 砖, 砖 拽 )  砖专 砖驻转 祝  注专转.
      */}
      <div className="flex gap-2" dir="ltr">
        {/* 专   拽转 转 */}
        <div className="relative">
          {isManualPrefix ? (
            // 爪 拽转 转
            <div className="flex items-center gap-1">
              <input
                type="text"
                value={manualPrefix}
                onChange={handleManualPrefixChange}
                placeholder="+1"
                disabled={disabled}
                className={`
                  w-20 px-2 py-3 text-sm border rounded-lg text-center font-mono
                  transition-all duration-200
                  ${
                    disabled
                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                      : 'bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
                  }
                  ${
                    error
                      ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                      : 'border-gray-300'
                  }
                `}
              />
              <button
                type="button"
                onClick={disableManualPrefix}
                disabled={disabled}
                className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                title={
                  locale === 'he'
                    ? '专 专转 '
                    : 'Back to country selection'
                }
              >
                <ChevronDown className="w-4 h-4" />
              </button>
            </div>
          ) : (
            // 爪 专转 
            <button
              type="button"
              onClick={() => !disabled && setIsOpen(!isOpen)}
              disabled={disabled}
              className={`
                flex items-center gap-2 px-3 py-3 border rounded-lg bg-white
                transition-all duration-200 min-w-[140px]
                ${
                  disabled
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    : 'hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
                }
                ${
                  error
                    ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                    : 'border-gray-300'
                }
                ${isOpen ? 'border-blue-500 ring-2 ring-blue-200' : ''}
              `}
              aria-expanded={isOpen}
              aria-haspopup="listbox"
            >
              <span className="text-lg">{selectedCountry.flag}</span>
              <span className="text-sm font-medium truncate">
                {locale === 'he'
                  ? selectedCountry.nameHe
                  : selectedCountry.name}
              </span>
              <span className="text-xs text-gray-500 font-mono">
                ({selectedCountry.prefix})
              </span>
              <ChevronDown
                className={`w-4 h-4 text-gray-400 transition-transform duration-200 ${
                  isOpen ? 'rotate-180' : ''
                }`}
              />
            </button>
          )}

          {/* Dropdown */}
          <AnimatePresence>
            {isOpen && !isManualPrefix && (
              <motion.div
                ref={dropdownRef}
                initial={{ opacity: 0, y: -10, scale: 0.95 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                exit={{ opacity: 0, y: -10, scale: 0.95 }}
                transition={{ duration: 0.2 }}
                className="absolute top-full mt-1 left-0 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-96"
              >
                {/* 驻砖 -    转  砖驻 注专 拽住 驻砖 */}
                <div
                  className="p-3 border-b border-gray-100"
                  dir={locale === 'he' ? 'rtl' : 'ltr'}
                >
                  <div className="relative">
                    <Search
                      className={`absolute top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 ${locale === 'he' ? 'right-3' : 'left-3'}`}
                    />
                    <input
                      ref={searchInputRef}
                      type="text"
                      placeholder={
                        locale === 'he' ? '驻砖 ...' : 'Search country...'
                      }
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className={`w-full py-2 text-sm border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:border-blue-500 ${locale === 'he' ? 'pr-10 pl-3' : 'pl-10 pr-3'}`}
                    />
                    {searchTerm && (
                      <button
                        type="button"
                        onClick={() => setSearchTerm('')}
                        className={`absolute top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 ${locale === 'he' ? 'left-3' : 'right-3'}`}
                      >
                        <X className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                </div>

                {/* 驻砖专转 拽转 转 */}
                <div
                  className="p-2 border-b border-gray-100"
                  dir={locale === 'he' ? 'rtl' : 'ltr'}
                >
                  <button
                    type="button"
                    onClick={enableManualPrefix}
                    className="w-full flex items-center gap-3 px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                  >
                    <Edit className="w-4 h-4" />
                    <span>
                      {locale === 'he'
                        ? '住 拽转 注爪'
                        : 'Enter custom prefix'}
                    </span>
                  </button>
                </div>

                {/* 专砖转 转 */}
                <div className="max-h-60 overflow-y-auto">
                  {sortedCountries.length === 0 ? (
                    <div className="p-4 text-sm text-gray-500 text-center">
                      {locale === 'he'
                        ? ' 爪 转'
                        : 'No countries found'}
                    </div>
                  ) : (
                    sortedCountries.map((country) => (
                      <button
                        key={country.code}
                        type="button"
                        onClick={() => handleCountrySelect(country)}
                        className={`
                          w-full flex items-center gap-3 px-4 py-3 text-sm
                          hover:bg-blue-50 transition-colors duration-150
                          ${selectedCountry.code === country.code ? 'bg-blue-100 text-blue-700' : 'text-gray-700'}
                        `}
                        //   砖专 注  LTR  砖 住驻专  爪 砖 拽住 ,
                        //  注专转  专  专砖转 驻
                        dir="ltr"
                      >
                        <span className="text-lg">{country.flag}</span>
                        <span className="flex-1 text-left">
                          {locale === 'he' ? country.nameHe : country.name}
                        </span>
                        <span className="text-xs text-gray-500 font-mono">
                          {country.prefix}
                        </span>
                        {country.popular && (
                          <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                        )}
                      </button>
                    ))
                  )}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>

        {/* 砖 住驻专 驻 */}
        <div className="flex-1 relative">
          <input
            type="tel"
            value={phoneNumber}
            onChange={handlePhoneChange}
            disabled={disabled}
            placeholder={
              isManualPrefix
                ? locale === 'he'
                  ? '住驻专 驻'
                  : 'Phone number'
                : locale === 'he'
                  ? `: ${selectedCountry.placeholder}`
                  : `Example: ${selectedCountry.placeholder}`
            }
            //  砖拽专  LTR 注砖,  专爪 砖专 砖 转  砖  爪 拽转
            className={`
              w-full pl-3 pr-10 py-3 border rounded-lg
              transition-all duration-200 text-left
              ${
                disabled
                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                  : 'bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-200 focus:border-blue-500'
              }
              ${
                error
                  ? 'border-red-400 focus:ring-red-200 focus:border-red-500'
                  : 'border-gray-300'
              }
            `}
            dir="ltr"
          />
          {/* 拽 拽 转    LTR */}
          <Phone className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
        </div>
      </div>

      {/* 注转 砖 */}
      {error && (
        <motion.p
          initial={{ opacity: 0, y: -5 }}
          animate={{ opacity: 1, y: 0 }}
          // 注转 砖 转 砖专转 驻 砖驻转 砖拽
          className={`text-red-500 text-xs mt-2 ${locale === 'he' ? 'text-right' : 'text-left'}`}
        >
          {error}
        </motion.p>
      )}
    </div>
  );
};

export default PhoneNumberInput;
--- End of Content for PhoneNumberInput.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ProgressBar.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/ProgressBar.tsx
"use client";

import React from "react";
import { motion } from "framer-motion";

interface ProgressBarProps {
  currentStep: number;
  totalSteps: number;
  stepLabel: string;
  locale: 'he' | 'en';
}

const ProgressBar: React.FC<ProgressBarProps> = ({
  currentStep,
  totalSteps,
  stepLabel,
  locale,
}) => {
  const percentage = (currentStep / totalSteps) * 100;
  const steps = Array.from({ length: totalSteps }, (_, i) => i + 1);

  return (
    <div className="w-full relative" dir={locale === 'he' ? 'rtl' : 'ltr'}>
      {/* Step labels */}
      <div className="flex justify-between mb-2">
        {steps.map((step) => (
          <div
            key={step}
            className={`text-xs font-medium transition-colors duration-300 ${
              step <= currentStep ? "text-gray-800" : "text-gray-400"
            }`}
          >
            {stepLabel.replace('{{step}}', step.toString())}
          </div>
        ))}
      </div>

      {/* Progress bar track */}
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
        {/* UPDATED: Animated progress fill (Teal -> Orange -> Amber) */}
        <motion.div
          className="h-full bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"
          initial={{ width: `${((currentStep - 1) / totalSteps) * 100}%` }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.5, ease: "easeInOut" }}
        />
      </div>

      {/* Step markers */}
      <div className="relative flex justify-between mt-1">
        {steps.map((step) => (
          <motion.div
            key={step}
            className={`w-6 h-6 rounded-full flex items-center justify-center -mt-4 z-10 transition-all duration-300
              ${
                step <= currentStep
                  // UPDATED: Marker Color
                  ? "bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 shadow-md text-white"
                  : "bg-white border-2 border-gray-300 text-gray-500"
              }`}
            initial={{ scale: step === currentStep ? 0.8 : 1 }}
            animate={{ scale: step === currentStep ? 1.1 : 1 }}
            transition={{ duration: 0.3 }}
          >
            <span className="text-xs font-semibold">{step}</span>
          </motion.div>
        ))}
      </div>
    </div>
  );
};

export default ProgressBar;
--- End of Content for ProgressBar.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\RegisterSteps.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/RegisterSteps.tsx
'use client';

import React, { useEffect, useState, useRef } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { RegistrationProvider, useRegistration } from './RegistrationContext';
import Link from 'next/link';
import WelcomeStep from './steps/WelcomeStep';
import BasicInfoStep from './steps/BasicInfoStep';
import EmailVerificationCodeStep from './steps/EmailVerificationCodeStep';
import PersonalDetailsStep from './steps/PersonalDetailsStep';
import CompleteStep from './steps/CompleteStep';
import ProgressBar from './ProgressBar';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Info } from 'lucide-react';
import StandardizedLoadingSpinner from '@/components/questionnaire/common/StandardizedLoadingSpinner';
import type { User as SessionUserType } from '@/types/next-auth';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

// ============================================================================
// TYPES
// ============================================================================

interface RegisterStepsProps {
  dict: RegisterStepsDict;
  locale: 'he' | 'en';
}

// ============================================================================
// HELPER: 拽注转  驻转 转 砖转砖
// ============================================================================

interface UserRedirectState {
  isProfileComplete: boolean;
  isPhoneVerified: boolean;
  termsAndPrivacyAcceptedAt?: Date | string | null;
  role?: string;
  isVerified?: boolean;
  status?: string;
}

/**
 * 专 转 转 砖 爪专 驻转 转 砖转砖,
 *  null  砖转砖 爪专 砖专 祝  (register).
 */
function getRedirectPathForUser(
  user: UserRedirectState,
  locale: string
): string | null {
  //   驻专
  console.log('[getRedirectPathForUser] Input:', {
    isProfileComplete: user.isProfileComplete,
    isPhoneVerified: user.isPhoneVerified,
    termsAndPrivacyAcceptedAt: user.termsAndPrivacyAcceptedAt,
    hasTerms: !!user.termsAndPrivacyAcceptedAt,
    role: user.role,
    locale,
  });

  // 转专砖 1: /砖 -  爪专 砖 驻专驻
  if (user.role === 'ADMIN' || user.role === 'MATCHMAKER') {
    console.log(
      '[getRedirectPathForUser] -> Admin/Matchmaker, redirecting to admin'
    );
    return `/${locale}/admin/engagement`;
  }

  // 转专砖 2:  砖 - 驻 驻专驻
  if (
    user.isProfileComplete &&
    user.isPhoneVerified &&
    user.termsAndPrivacyAcceptedAt
  ) {
    console.log(
      '[getRedirectPathForUser] -> All complete, redirecting to profile'
    );
    return `/${locale}/profile`;
  }

  // 转专砖 3: 驻专驻 砖 + terms 砖专,  驻驻  转
  //   转拽 注拽专!
  if (
    user.isProfileComplete &&
    user.termsAndPrivacyAcceptedAt &&
    !user.isPhoneVerified
  ) {
    console.log(
      '[getRedirectPathForUser] -> Profile complete but phone not verified, redirecting to verify-phone'
    );
    return `/${locale}/auth/verify-phone`;
  }

  // 转专砖 4: 爪专 砖 驻专驻  砖专 terms - 砖专 祝 register
  console.log(
    '[getRedirectPathForUser] -> Needs to complete profile/terms, staying on register'
  );
  return null;
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

const RegisterStepsContent: React.FC<{
  dict: RegisterStepsDict;
  locale: 'he' | 'en';
}> = ({ dict, locale }) => {
  const {
    data: registrationContextData,
    initializeFromSession,
    resetForm,
    goToStep,
    submission,
  } = useRegistration();

  const router = useRouter();
  const {
    data: session,
    status: sessionStatus,
    update: updateSession,
  } = useSession();
  const searchParams = useSearchParams();

  // State
  const [showIncompleteProfileMessage, setShowIncompleteProfileMessage] =
    useState(false);
  const [initializationAttempted, setInitializationAttempted] = useState(false);
  const [isRedirecting, setIsRedirecting] = useState(false);

  // Ref 注转 驻转 驻转
  const redirectInProgressRef = useRef(false);

  //   注转 拽驻
  console.log('[RegisterSteps] Component rendered', {
    sessionStatus,
    hasSession: !!session,
    hasUser: !!session?.user,
    isRedirecting,
    initializationAttempted,
  });

  // ============================================================================
  // Effect 1: 爪转 注 注 驻专驻  砖
  // ============================================================================
  useEffect(() => {
    const reasonParam = searchParams.get('reason');
    if (
      (reasonParam === 'complete_profile' || reasonParam === 'verify_phone') &&
      !registrationContextData.isCompletingProfile
    ) {
      setShowIncompleteProfileMessage(true);
    } else {
      setShowIncompleteProfileMessage(false);
    }
  }, [searchParams, registrationContextData.isCompletingProfile]);

  // ============================================================================
  // Effect 2: 拽转 转 转 驻住
  // ============================================================================
  useEffect(() => {
    console.log('[RegisterSteps] Effect triggered', {
      sessionStatus,
      redirectInProgress: redirectInProgressRef.current,
    });

    //  转注砖   住砖 注   专 转 驻
    if (sessionStatus === 'loading') {
      console.log('[RegisterSteps] Session loading, waiting...');
      return;
    }

    if (redirectInProgressRef.current) {
      console.log('[RegisterSteps] Redirect already in progress, skipping');
      return;
    }

    // ============================================================================
    // 砖转砖 专
    // ============================================================================
    if (sessionStatus === 'authenticated' && session?.user) {
      const user = session.user as SessionUserType;

      //   驻专 砖 爪 砖转砖
      console.log('[RegisterSteps] ========== USER STATE ==========');
      console.log('[RegisterSteps] isProfileComplete:', user.isProfileComplete);
      console.log('[RegisterSteps] isPhoneVerified:', user.isPhoneVerified);
      console.log(
        '[RegisterSteps] termsAndPrivacyAcceptedAt:',
        user.termsAndPrivacyAcceptedAt
      );
      console.log('[RegisterSteps] role:', user.role);
      console.log('[RegisterSteps] ================================');

      // 拽  爪专 驻转
      const redirectPath = getRedirectPathForUser(user, locale);

      console.log(
        '[RegisterSteps] Redirect decision:',
        redirectPath || 'STAY ON REGISTER'
      );

      if (redirectPath) {
        // 拽 砖  专 转 注
        const currentPath =
          typeof window !== 'undefined' ? window.location.pathname : '';
        console.log('[RegisterSteps] Current path:', currentPath);
        console.log('[RegisterSteps] Target path:', redirectPath);

        if (currentPath === redirectPath) {
          console.log(
            '[RegisterSteps] Already at target path, skipping redirect'
          );
          return;
        }

        console.log(`[RegisterSteps]  REDIRECTING to: ${redirectPath}`);
        redirectInProgressRef.current = true;
        setIsRedirecting(true);
        router.push(redirectPath);
        return;
      }

      // ============================================================================
      // 砖转砖 爪专 砖专 祝 - 转 转 驻住
      // ============================================================================
      const needsSetup =
        !user.termsAndPrivacyAcceptedAt || !user.isProfileComplete;

      console.log('[RegisterSteps] Needs setup:', needsSetup);
      console.log(
        '[RegisterSteps] initializationAttempted:',
        initializationAttempted
      );
      console.log(
        '[RegisterSteps] registrationContextData.step:',
        registrationContextData.step
      );
      console.log(
        '[RegisterSteps] registrationContextData.isVerifyingEmailCode:',
        registrationContextData.isVerifyingEmailCode
      );

      if (
        needsSetup &&
        (!initializationAttempted ||
          (registrationContextData.step === 0 &&
            !registrationContextData.isVerifyingEmailCode))
      ) {
        console.log('[RegisterSteps] Initializing form from session');
        initializeFromSession(user);
        setInitializationAttempted(true);
      }
    }

    // ============================================================================
    // 砖转砖  专
    // ============================================================================
    else if (sessionStatus === 'unauthenticated') {
      console.log('[RegisterSteps] User is unauthenticated');
      const registrationInProgress =
        registrationContextData.step > 0 ||
        registrationContextData.isVerifyingEmailCode;

      if (registrationInProgress) {
        console.log('[RegisterSteps] User logged out, resetting form');
        resetForm();
      }

      // 驻住 转  驻
      redirectInProgressRef.current = false;
      setIsRedirecting(false);
    }
  }, [
    sessionStatus,
    session,
    router,
    registrationContextData.step,
    registrationContextData.isVerifyingEmailCode,
    registrationContextData.isCompletingProfile,
    initializeFromSession,
    resetForm,
    initializationAttempted,
    locale,
  ]);

  // ============================================================================
  // Effect 3: 专注 住砖 砖专 祝 (拽专 砖砖 砖转  专)
  // ============================================================================
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (
        document.visibilityState === 'visible' &&
        sessionStatus === 'authenticated'
      ) {
        console.log('[RegisterSteps] Tab became visible, refreshing session');
        updateSession();
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [sessionStatus, updateSession]);

  // ============================================================================
  // EARLY RETURNS
  // ============================================================================

  // 爪 注 砖 submission
  if (submission.isSubmitting) {
    return (
      <StandardizedLoadingSpinner
        text={submission.loadingText}
        subtext={submission.loadingSubtext}
      />
    );
  }

  // 爪 驻 - 爪 loading 注 砖驻 转砖
  if (isRedirecting) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 via-teal-50/40 to-orange-50/40">
        <StandardizedLoadingSpinner
          text={locale === 'he' ? '注专 转...' : 'Redirecting...'}
        />
      </div>
    );
  }

  // ============================================================================
  // RENDER STEP
  // ============================================================================

  const renderStep = (): React.ReactNode => {
    // 住砖 注
    if (sessionStatus === 'loading') {
      return (
        <div className="flex justify-center p-10">
          <StandardizedLoadingSpinner className="text-teal-600 w-8 h-8" />
        </div>
      );
    }

    // 转 
    if (
      registrationContextData.isVerifyingEmailCode &&
      !registrationContextData.isCompletingProfile
    ) {
      return (
        <EmailVerificationCodeStep
          dict={dict.steps.emailVerification}
          locale={locale}
        />
      );
    }

    // 砖转 驻专驻
    if (registrationContextData.isCompletingProfile) {
      switch (registrationContextData.step) {
        case 2:
          return (
            <PersonalDetailsStep
              personalDetailsDict={dict.steps.personalDetails}
              optionalInfoDict={dict.steps.optionalInfo}
              consentDict={dict.consentCheckbox}
              validationDict={dict.validationErrors}
              locale={locale}
            />
          );
        case 4:
          return <CompleteStep dict={dict.steps.complete} />;
        default:
          // 爪  爪驻 - 驻住 转转 砖
          console.warn(
            '[RegisterSteps] Unexpected step in isCompletingProfile mode:',
            registrationContextData.step
          );
          resetForm();
          return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
      }
    }

    // 专转 专砖 专
    switch (registrationContextData.step) {
      case 0:
        return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
      case 1:
        return (
          <BasicInfoStep
            dict={dict.steps.basicInfo}
            consentDict={dict.consentCheckbox}
            validationDict={dict.validationErrors}
            locale={locale}
          />
        );
      default:
        console.warn(
          '[RegisterSteps] Unexpected step in regular flow:',
          registrationContextData.step
        );
        resetForm();
        return <WelcomeStep dict={dict.steps.welcome} locale={locale} />;
    }
  };

  // ============================================================================
  // PAGE TITLE & DESCRIPTION
  // ============================================================================

  let pageTitle = dict.headers.registerTitle;
  let stepDescription = dict.headers.welcomeDescription;
  let currentProgressBarStep = 0;
  const totalProgressBarSteps = 3;
  let showProgressBar = false;

  if (
    registrationContextData.isVerifyingEmailCode &&
    !registrationContextData.isCompletingProfile
  ) {
    pageTitle = dict.headers.verifyEmailTitle;
    stepDescription = dict.headers.verifyEmailDescription.replace(
      '{{email}}',
      registrationContextData.emailForVerification || ''
    );
    showProgressBar = true;
    currentProgressBarStep = 1;
  } else if (registrationContextData.isCompletingProfile) {
    pageTitle = dict.headers.completeProfileTitle;
    showProgressBar = false;

    if (registrationContextData.step === 2) {
      stepDescription = session?.user?.termsAndPrivacyAcceptedAt
        ? dict.headers.personalDetailsConsentedDescription
        : dict.headers.personalDetailsDescription;
    } else if (registrationContextData.step === 4) {
      stepDescription = session?.user?.isPhoneVerified
        ? dict.headers.completionReadyDescription
        : dict.headers.completionPhoneVerificationDescription;
    } else {
      stepDescription = dict.headers.loadingProfileDescription;
    }
  } else {
    if (registrationContextData.step === 1) {
      pageTitle = dict.headers.registerTitle;
      stepDescription = dict.headers.accountCreationDescription;
      currentProgressBarStep = 1;
      showProgressBar = true;
    }
  }

  // ============================================================================
  // MAIN RENDER
  // ============================================================================

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 via-teal-50/40 to-orange-50/40 p-4 sm:p-8">
      <div className="mb-6 text-center">
        <h1 className="text-transparent bg-clip-text bg-gradient-to-r from-teal-600 via-orange-500 to-amber-500 text-3xl font-bold mb-2">
          {pageTitle}
        </h1>
        <p className="text-gray-600 max-w-md mx-auto">{stepDescription}</p>
      </div>

      {showIncompleteProfileMessage && (
        <Alert className="mb-6 w-full max-w-md bg-amber-50 border-amber-200 text-amber-800 shadow-md">
          <Info className="h-5 w-5 text-amber-600 flex-shrink-0 mt-1" />
          <div className="ml-3 rtl:mr-3 rtl:ml-0">
            <AlertTitle className="font-semibold mb-1">
              {dict.incompleteProfileAlert.title}
            </AlertTitle>
            <AlertDescription className="text-sm">
              {searchParams.get('reason') === 'verify_phone'
                ? dict.incompleteProfileAlert.verifyPhoneDescription
                : dict.incompleteProfileAlert.description}
            </AlertDescription>
          </div>
        </Alert>
      )}

      {showProgressBar && (
        <div className="w-full max-w-md mb-6">
          <ProgressBar
            currentStep={currentProgressBarStep}
            totalSteps={totalProgressBarSteps}
            stepLabel={dict.progressBar.stepLabel}
            locale={locale}
          />
        </div>
      )}

      <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative border border-white/50">
        <div className="p-6 sm:p-8">{renderStep()}</div>
      </div>

      <div className="mt-8 text-center text-sm text-gray-500">
        {dict.contactSupport}{' '}
        <Link
          href="/contact"
          className="text-teal-600 hover:underline hover:text-teal-700"
        >
          {dict.contactSupportLink}
        </Link>
      </div>
    </div>
  );
};

// ============================================================================
// WRAPPER WITH PROVIDER
// ============================================================================

export default function RegisterSteps({ dict, locale }: RegisterStepsProps) {
  return (
    <RegistrationProvider>
      <RegisterStepsContent dict={dict} locale={locale} />
    </RegistrationProvider>
  );
}
--- End of Content for RegisterSteps.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\RegistrationContext.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/RegistrationContext.tsx

'use client';

import React, {
  createContext,
  useContext,
  useState,
  ReactNode,
  useCallback,
} from 'react';
import { Gender, UserStatus, UserSource } from '@prisma/client';
import type { User as SessionUserType } from '@/types/next-auth';

// ============================================================================
// TYPES
// ============================================================================

export type SubmissionStatus =
  | 'idle'
  | 'acceptingTerms'
  | 'savingProfile'
  | 'uploadingPhotos'
  | 'sendingCode'
  | 'redirecting'
  | 'error';

export interface SubmissionState {
  isSubmitting: boolean;
  status: SubmissionStatus;
  loadingText: string;
  loadingSubtext?: string;
}

export interface RegistrationData {
  email: string;
  password: string;
  firstName: string;
  lastName: string;
  phone: string;
  gender: Gender | '';
  birthDate: string;
  maritalStatus: string;
  height?: number;
  occupation?: string;
  education?: string;
  religiousLevel?: string;

  // 砖转 UI
  city: string;
  hasChildren: boolean;
  numberOfChildren: string;
  profession: string; // 砖 : -DB  occupation, 驻 转  
  termsAccepted: boolean;

  // 砖转  爪
  step: number;
  isGoogleSignup: boolean;
  language: 'he' | 'en';
  isCompletingProfile: boolean;
  isVerifyingEmailCode: boolean;
  emailForVerification: string | null;
}

// ============================================================================
// INITIAL STATE
// ============================================================================

const initialRegistrationData: RegistrationData = {
  email: '',
  password: '',
  firstName: '',
  lastName: '',
  phone: '',
  gender: '',
  birthDate: '',
  maritalStatus: '',
  height: undefined,
  occupation: '',
  education: '',
  religiousLevel: '',

  // 转 砖转 砖
  city: '',
  hasChildren: false,
  numberOfChildren: '',
  profession: '',
  termsAccepted: false,

  step: 0,
  isGoogleSignup: false,
  language: 'he',
  isCompletingProfile: false,
  isVerifyingEmailCode: false,
  emailForVerification: null,
};

const initialSubmissionState: SubmissionState = {
  isSubmitting: false,
  status: 'idle',
  loadingText: '',
  loadingSubtext: undefined,
};

// ============================================================================
// CONTEXT TYPE
// ============================================================================

interface RegistrationContextType {
  data: RegistrationData;
  setData: React.Dispatch<React.SetStateAction<RegistrationData>>;
  updateField: <K extends keyof RegistrationData>(
    field: K,
    value: RegistrationData[K]
  ) => void;
  nextStep: () => void;
  prevStep: () => void;
  goToStep: (step: number) => void;
  resetForm: () => void;
  setGoogleSignup: (googleUserData: {
    email: string;
    firstName?: string;
    lastName?: string;
  }) => void;
  initializeFromSession: (sessionUser: SessionUserType) => Promise<void>; // 砖 -Promise
  proceedToEmailVerification: (email: string) => void;
  completeEmailVerification: () => void;
  exitEmailVerification: () => void;

  // Submission state management
  submission: SubmissionState;
  startSubmission: (text: string, subtext?: string) => void;
  updateSubmission: (
    status: SubmissionStatus,
    text: string,
    subtext?: string
  ) => void;
  endSubmission: (error?: boolean) => void;
}

// ============================================================================
// CONTEXT
// ============================================================================

const RegistrationContext = createContext<RegistrationContextType | undefined>(
  undefined
);

export const RegistrationProvider: React.FC<{ children: ReactNode }> = ({
  children,
}) => {
  const [data, setData] = useState<RegistrationData>(initialRegistrationData);
  const [submission, setSubmission] = useState<SubmissionState>(
    initialSubmissionState
  );

  // ============================================================================
  // FORM FIELD HANDLERS
  // ============================================================================

  const updateField = useCallback(
    <K extends keyof RegistrationData>(
      field: K,
      value: RegistrationData[K]
    ) => {
      setData((prev) => ({ ...prev, [field]: value }));
    },
    []
  );

  const nextStep = useCallback(() => {
    setData((prev) => ({ ...prev, step: prev.step + 1 }));
  }, []);

  const prevStep = useCallback(() => {
    setData((prev) => ({ ...prev, step: prev.step > 0 ? prev.step - 1 : 0 }));
  }, []);

  const goToStep = useCallback((stepNum: number) => {
    setData((prev) => ({ ...prev, step: stepNum }));
  }, []);

  const resetForm = useCallback(() => {
    setData(initialRegistrationData);
    setSubmission(initialSubmissionState);
  }, []);

  const setGoogleSignup = useCallback(
    (googleUserData: {
      email: string;
      firstName?: string;
      lastName?: string;
    }) => {
      setData({
        ...initialRegistrationData,
        email: googleUserData.email,
        isGoogleSignup: true,
      });
    },
    []
  );

  // ============================================================================
  // SESSION INITIALIZATION (UPDATED & ASYNC)
  // ============================================================================

  const initializeFromSession = useCallback(
    async (sessionUser: SessionUserType) => {
      // 1. 转 住住 注  砖砖 住砖 爪爪 ( 砖UI  )
      const isGoogleAcc = !!(
        sessionUser.source === UserSource.REGISTRATION &&
        sessionUser.accounts?.some((acc) => acc.provider === 'google')
      );

      let baseData: Partial<RegistrationData> = {
        email: sessionUser.email || '',
        firstName: sessionUser.firstName || '',
        lastName: sessionUser.lastName || '',
        phone: sessionUser.phone || '',
        isGoogleSignup: isGoogleAcc,
        // 专专转  拽专 砖-API 砖
        gender: '',
        termsAccepted: false,
      };

      try {
        // 2. 拽专 -API 砖  拽 转 转 驻专驻 
        //  驻转专 转 注转 -Cookie  
        const response = await fetch('/api/auth/registration-info');

        if (response.ok) {
          const fullUser = await response.json();
          const profile = fullUser.profile || {};

          console.log('Fetched full registration info:', fullUser);

          baseData = {
            ...baseData,
            // 转 专 专砖
            email: fullUser.email || baseData.email,
            firstName: fullUser.firstName || baseData.firstName,
            lastName: fullUser.lastName || baseData.lastName,
            phone: fullUser.phone || baseData.phone,
            termsAccepted: !!fullUser.termsAndPrivacyAcceptedAt,

            // 转 驻专驻
            gender: profile.gender || '',
            birthDate: profile.birthDate
              ? new Date(profile.birthDate).toISOString().split('T')[0]
              : '',
            maritalStatus: profile.maritalStatus || '',
            height: profile.height ?? undefined,
            occupation: profile.occupation || '',
            education: profile.education || '',
            religiousLevel: profile.religiousLevel || '',
            city: profile.city || '',

            // 驻 砖转 转 砖转
            profession: profile.occupation || '', // 砖砖 -occupation 砖 profession
            hasChildren: profile.hasChildrenFromPrevious || false,
            numberOfChildren: '', //  砖  -DB, 转 专拽
          };
        } else {
          console.warn(
            'Failed to fetch registration info from API, falling back to basic session data'
          );
        }
      } catch (error) {
        console.error('Error fetching registration info:', error);
      }

      // 3. 注 -State 注 转  拽 注住拽转
      setData((prevData) => {
        const mergedData = {
          ...initialRegistrationData,
          ...prevData,
          ...baseData,
        };

        // 转专砖 1: 转  专砖
        if (
          sessionUser.status === UserStatus.PENDING_EMAIL_VERIFICATION &&
          !isGoogleAcc &&
          !sessionUser.isVerified
        ) {
          return {
            ...mergedData,
            isVerifyingEmailCode: true,
            emailForVerification: mergedData.email,
            step: 1,
            isCompletingProfile: false,
            isGoogleSignup: false,
          };
        }

        // 转专砖 2: 砖转 驻专驻 专砖转
        if (!sessionUser.isProfileComplete) {
          return {
            ...mergedData,
            isCompletingProfile: true,
            isGoogleSignup: isGoogleAcc,
            step: 2,
            isVerifyingEmailCode: false,
          };
        }

        // 砖转砖 拽 转拽
        return {
          ...mergedData,
          isGoogleSignup: isGoogleAcc,
        };
      });
    },
    []
  );

  // ============================================================================
  // EMAIL VERIFICATION HANDLERS
  // ============================================================================

  const proceedToEmailVerification = useCallback((emailToVerify: string) => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: true,
      emailForVerification: emailToVerify,
    }));
  }, []);

  const completeEmailVerification = useCallback(() => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: false,
      emailForVerification: null,
      isCompletingProfile: true,
      step: 2,
    }));
  }, []);

  const exitEmailVerification = useCallback(() => {
    setData((prev) => ({
      ...prev,
      isVerifyingEmailCode: false,
      emailForVerification: null,
      step: 1,
    }));
  }, []);

  // ============================================================================
  // SUBMISSION STATE HANDLERS
  // ============================================================================

  const startSubmission = useCallback((text: string, subtext?: string) => {
    setSubmission({
      isSubmitting: true,
      status: 'savingProfile',
      loadingText: text,
      loadingSubtext: subtext,
    });
  }, []);

  const updateSubmission = useCallback(
    (status: SubmissionStatus, text: string, subtext?: string) => {
      setSubmission((prev) => ({
        ...prev,
        status,
        loadingText: text,
        loadingSubtext: subtext,
      }));
    },
    []
  );

  const endSubmission = useCallback((error?: boolean) => {
    setSubmission({
      isSubmitting: false,
      status: error ? 'error' : 'idle',
      loadingText: '',
      loadingSubtext: undefined,
    });
  }, []);

  // ============================================================================
  // CONTEXT VALUE
  // ============================================================================

  const value: RegistrationContextType = {
    data,
    setData,
    updateField,
    nextStep,
    prevStep,
    goToStep,
    resetForm,
    setGoogleSignup,
    initializeFromSession,
    proceedToEmailVerification,
    completeEmailVerification,
    exitEmailVerification,
    // Submission
    submission,
    startSubmission,
    updateSubmission,
    endSubmission,
  };

  return (
    <RegistrationContext.Provider value={value}>
      {children}
    </RegistrationContext.Provider>
  );
};

export const useRegistration = (): RegistrationContextType => {
  const context = useContext(RegistrationContext);
  if (context === undefined) {
    throw new Error(
      'useRegistration must be used within a RegistrationProvider'
    );
  }
  return context;
};
--- End of Content for RegistrationContext.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\ResetPasswordForm.tsx
--------------------------------------------------------------------------------
Content:
// src/app/components/auth/ResetPasswordForm.tsx
'use client';

import { useState, FormEvent, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Lock,
  KeySquare,
  Loader2,
  AlertCircle,
  CheckCircle,
  Eye,
  EyeOff,
  Mail,
} from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import Link from 'next/link';

// Password validation function (similar to your RegisterForm)
const validatePassword = (value: string): string | null => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  if (!passwordRegex.test(value)) {
    return '住住 转  驻转 8 转, 转 , 转 拽 住驻专.';
  }
  return null;
};

export default function ResetPasswordForm() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [email, setEmail] = useState(''); // To prefill if passed, or keep empty
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [passwordError, setPasswordError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  useEffect(() => {
    const emailFromQuery = searchParams.get('email');
    const tokenFromQuery = searchParams.get('token'); // If you decide to also prefill OTP via token

    if (emailFromQuery) {
      setEmail(emailFromQuery);
    }
    if (tokenFromQuery) {
      // This 'token' from query is the OTP
      setOtp(tokenFromQuery);
    }
  }, [searchParams]);

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setPasswordError(null);
    setSuccessMessage(null);

    if (!email) {
      setError('转转  住专.  专 转 住 砖转.');
      setIsLoading(false);
      return;
    }
    if (!otp || otp.length !== 6 || !/^\d+$/.test(otp)) {
      setError('拽 转 (OTP)  转  6 住驻专转.');
      setIsLoading(false);
      return;
    }
    const passValidationError = validatePassword(newPassword);
    if (passValidationError) {
      setPasswordError(passValidationError);
      setIsLoading(false);
      return;
    }
    if (newPassword !== confirmPassword) {
      setError('住住转  转转.');
      setIsLoading(false);
      return;
    }

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp, newPassword }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || '专注 砖 驻住 住住.');
      }

      setSuccessMessage(
        data.message || '住住 驻住 爪! 注转 转 转专 注 住住 砖.'
      );
      // Clear fields on success
      setOtp('');
      setNewPassword('');
      setConfirmPassword('');
      // Optionally redirect after a delay or with a button
      setTimeout(() => {
        router.push('/auth/signin?reset=success');
      }, 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : '专注 砖  爪驻.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md bg-white rounded-xl shadow-xl overflow-hidden relative">
      <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-cyan-500 to-pink-500"></div>
      <div className="p-6 sm:p-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">驻住 住住</h1>
          <p className="text-gray-600 text-sm">
             转 拽 转 (OTP) 砖拽转  转 住住 砖 砖.
          </p>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>砖</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        {passwordError && !error && (
          <Alert variant="destructive" className="mb-4" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>砖转 住住</AlertTitle>
            <AlertDescription id="password-error-message">
              {passwordError}
            </AlertDescription>
          </Alert>
        )}

        {successMessage && (
          <Alert
            variant="default"
            className="mb-4 bg-green-50 border-green-200 text-green-700"
          >
            <CheckCircle className="h-4 w-4 text-green-600" />
            <AlertTitle>爪!</AlertTitle>
            <AlertDescription>
              {successMessage} 转 注专 祝 转专转...
            </AlertDescription>
          </Alert>
        )}

        {!successMessage && ( // Only show form if no success message
          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1">
              <label
                htmlFor="email-reset"
                className="block text-sm font-medium text-gray-700"
              >
                转转  (转) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="email"
                  id="email-reset"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="you@example.com"
                  required
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
                  disabled={isLoading || !!searchParams.get('email')} // Disable if email came from query
                />
              </div>
            </div>
            <div className="space-y-1">
              <label
                htmlFor="otp-reset"
                className="block text-sm font-medium text-gray-700"
              >
                拽 转 (OTP) <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <KeySquare className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type="text"
                  id="otp-reset"
                  value={otp}
                  onChange={(e) =>
                    setOtp(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))
                  }
                  placeholder="xxxxxx"
                  maxLength={6}
                  required
                  className="w-full pr-10 pl-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none tracking-widest text-center"
                  disabled={isLoading}
                  inputMode="numeric"
                />
              </div>
            </div>

            <div className="space-y-1">
              <label
                htmlFor="new-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                住住 砖 <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showPassword ? 'text' : 'password'}
                  id="new-password-reset"
                  aria-describedby={
                    passwordError ? 'password-error-message' : 'password-hint'
                  }
                  aria-invalid={!!passwordError}
                  value={newPassword}
                  onChange={(e) => {
                    setNewPassword(e.target.value);
                    const validationErr = validatePassword(e.target.value);
                    if (e.target.value && validationErr)
                      setPasswordError(validationErr);
                    else setPasswordError(null);
                  }}
                  placeholder="驻转 8 转, 转 , 拽 住驻专"
                  required
                  className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none ${
                    passwordError
                      ? 'border-red-500 focus:ring-red-200'
                      : 'border-gray-300 focus:ring-cyan-200 focus:border-cyan-500'
                  }`}
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showPassword ? '住转专 住住' : '爪 住住'}
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
              {!passwordError && (
                <p id="password-hint" className="mt-1 text-xs text-gray-500">
                  转  驻转 8 转, 转 , 转 拽 住驻专.
                </p>
              )}
            </div>

            <div className="space-y-1">
              <label
                htmlFor="confirm-password-reset"
                className="block text-sm font-medium text-gray-700"
              >
                转 住住 砖 <span className="text-red-500">*</span>
              </label>
              <div className="relative">
                <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
                <Input
                  type={showConfirmPassword ? 'text' : 'password'}
                  id="confirm-password-reset"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder=" 转 住住 砖 砖"
                  required
                  className="w-full pr-10 pl-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  aria-label={showConfirmPassword ? '住转专 住住' : '爪 住住'}
                >
                  {showConfirmPassword ? (
                    <EyeOff className="h-5 w-5" />
                  ) : (
                    <Eye className="h-5 w-5" />
                  )}
                </button>
              </div>
            </div>

            <Button
              type="submit"
              disabled={
                isLoading ||
                !!passwordError ||
                !otp ||
                !newPassword ||
                !confirmPassword ||
                newPassword !== confirmPassword
              }
              className="w-full py-3 bg-gradient-to-r from-cyan-500 to-pink-500 hover:from-cyan-600 hover:to-pink-600 shadow-lg flex items-center justify-center gap-2"
            >
              {isLoading ? (
                <>
                  <Loader2 className="h-5 w-5 animate-spin mr-2" />
                  <span>驻住 住住...</span>
                </>
              ) : (
                '驻住 住住'
              )}
            </Button>
          </form>
        )}

        <div className="mt-6 text-center">
          <Link
            href="/auth/signin"
            className="text-sm text-cyan-600 hover:text-cyan-700 hover:underline"
          >
            专 转专转
          </Link>
        </div>
      </div>
    </div>
  );
}
--- End of Content for ResetPasswordForm.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\VerifyEmailClient.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/VerifyEmailClient.tsx
'use client';

import React, {
  useState,
  useRef,
  useEffect,
  KeyboardEvent,
  ClipboardEvent,
} from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Mail,
  CheckCircle,
  AlertCircle,
  Loader2,
  ArrowLeft,
  RefreshCw,
  Sparkles,
  Shield,
  Clock,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

interface VerifyEmailClientProps {
  locale: 'he' | 'en';
}

type VerificationStatus = 'idle' | 'verifying' | 'success' | 'error';

export default function VerifyEmailClient({ locale }: VerifyEmailClientProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const email = searchParams.get('email') || '';
  const isHebrew = locale === 'he';

  // State Management
  const [code, setCode] = useState<string[]>(Array(6).fill(''));
  const [status, setStatus] = useState<VerificationStatus>('idle');
  const [errorMessage, setErrorMessage] = useState<string>('');
  const [canResend, setCanResend] = useState(false);
  const [resendCountdown, setResendCountdown] = useState(60);
  const [isResending, setIsResending] = useState(false);

  // Refs for input boxes
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  // Countdown timer for resend
  useEffect(() => {
    if (resendCountdown > 0) {
      const timer = setTimeout(
        () => setResendCountdown(resendCountdown - 1),
        1000
      );
      return () => clearTimeout(timer);
    } else {
      setCanResend(true);
    }
  }, [resendCountdown]);

  // Auto-submit when all 6 digits are filled
  useEffect(() => {
    const fullCode = code.join('');
    if (fullCode.length === 6 && status === 'idle') {
      handleVerifyCode(fullCode);
    }
  }, [code, status]);

  const handleInputChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value)) return;
    const newCode = [...code];
    newCode[index] = value.slice(-1);
    setCode(newCode);
    if (value && index < 5) {
      inputRefs.current[index + 1]?.focus();
    }
  };

  const handleKeyDown = (index: number, e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Backspace' && !code[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const handlePaste = (e: ClipboardEvent<HTMLInputElement>) => {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text').trim();
    if (/^\d{6}$/.test(pastedData)) {
      const newCode = pastedData.split('');
      setCode(newCode);
      inputRefs.current[5]?.focus();
    }
  };

  const handleVerifyCode = async (verificationCode: string) => {
    setStatus('verifying');
    setErrorMessage('');

    try {
      const response = await fetch('/api/auth/verify-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code: verificationCode }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || '专注 砖 转 拽');
      }

      setStatus('success');

      setTimeout(() => {
        router.push(
          `/${locale}/auth/register?step=personal-details&email=${encodeURIComponent(email)}`
        );
      }, 2000);
    } catch (error) {
      setStatus('error');
      setErrorMessage(
        error instanceof Error ? error.message : '专注 砖  爪驻'
      );
      setCode(Array(6).fill(''));
      inputRefs.current[0]?.focus();
    }
  };

  const handleResendCode = async () => {
    setIsResending(true);
    setErrorMessage('');

    try {
      const response = await fetch('/api/auth/resend-verification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || '专注 砖 砖转 拽');
      }

      setCanResend(false);
      setResendCountdown(60);
      setCode(Array(6).fill(''));
      inputRefs.current[0]?.focus();
    } catch (error) {
      setErrorMessage(
        error instanceof Error ? error.message : '专注 砖 砖转 拽'
      );
    } finally {
      setIsResending(false);
    }
  };

  // Dictionary
  const dict = {
    title: isHebrew ? '转 转 转转  砖' : 'Verify Your Email',
    subtitle: isHebrew
      ? '砖 拽 转  6 住驻专转  砖'
      : 'We sent a 6-digit verification code to your email',
    emailSentTo: isHebrew ? '砖 :' : 'Sent to:',
    enterCode: isHebrew ? ' 转 拽 ' : 'Enter the code here',
    verifying: isHebrew ? '转...' : 'Verifying...',
    success: isHebrew ? '转 爪!' : 'Verified Successfully!',
    successMessage: isHebrew
      ? ' 砖 转. 注专 转 砖 转...'
      : 'Your email has been verified. Redirecting...',
    errorTitle: isHebrew ? '拽 砖' : 'Invalid Code',
    resendCode: isHebrew ? '砖 拽 砖' : 'Resend Code',
    resendIn: isHebrew ? '砖 砖 注' : 'Resend in',
    seconds: isHebrew ? '砖转' : 'seconds',
    didntReceive: isHebrew ? ' 拽转 转 拽?' : "Didn't receive the code?",
    checkSpam: isHebrew
      ? '拽 转 转转 住驻  砖 砖'
      : 'Check your spam folder or resend',
    backToRegister: isHebrew ? '专 专砖' : 'Back to Registration',
    securityNote: isHebrew
      ? '拽 转拽祝 -15 拽转 专注 砖'
      : 'Code is valid for 15 minutes from sending',
  };

  return (
    // UPDATED: Main Background (Slate/Teal/Orange)
    <div className="min-h-screen w-full bg-gradient-to-br from-slate-50 via-teal-50/40 to-orange-50/40 flex items-center justify-center p-4 relative overflow-hidden">
      {/* UPDATED: Decorative Orbs (Teal/Orange/Rose) */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <motion.div
          animate={{ scale: [1, 1.2, 1], opacity: [0.3, 0.5, 0.3] }}
          transition={{ duration: 8, repeat: Infinity, ease: 'easeInOut' }}
          // Teal Orb
          className="absolute top-20 left-10 w-64 h-64 bg-teal-200/40 rounded-full blur-3xl"
        />
        <motion.div
          animate={{ scale: [1, 1.3, 1], opacity: [0.3, 0.5, 0.3] }}
          transition={{
            duration: 10,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 2,
          }}
          // Orange Orb
          className="absolute bottom-20 right-10 w-72 h-72 bg-orange-200/40 rounded-full blur-3xl"
        />
        <motion.div
          animate={{ scale: [1, 1.15, 1], opacity: [0.2, 0.4, 0.2] }}
          transition={{
            duration: 12,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 4,
          }}
          // Rose/Purple Orb (Center)
          className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-rose-200/30 rounded-full blur-3xl"
        />
      </div>

      {/* Main Card */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6 }}
        className="relative w-full max-w-md"
      >
        <div className="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/60 overflow-hidden">
          {/* UPDATED: Gradient Header (Teal -> Orange -> Amber) */}
          <div className="h-2 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500"></div>

          <div className="p-8 sm:p-10">
            {/* Icon & Title Section */}
            <motion.div
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              transition={{ delay: 0.2, duration: 0.5 }}
              className="text-center mb-8"
            >
              <div className="relative inline-block mb-6">
                <motion.div
                  animate={{ rotate: [0, 5, -5, 0] }}
                  transition={{
                    duration: 4,
                    repeat: Infinity,
                    ease: 'easeInOut',
                  }}
                  // UPDATED: Main Icon Background (Teal -> Emerald)
                  className="w-20 h-20 rounded-2xl bg-gradient-to-br from-teal-400 to-emerald-600 flex items-center justify-center shadow-lg shadow-teal-500/20"
                >
                  <Mail className="w-10 h-10 text-white" strokeWidth={2.5} />
                </motion.div>
                <motion.div
                  animate={{ scale: [1, 1.2, 1], opacity: [0.5, 1, 0.5] }}
                  transition={{ duration: 2, repeat: Infinity }}
                  // UPDATED: Sparkle Background (Amber/Orange)
                  className="absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center"
                >
                  <Sparkles className="w-4 h-4 text-white" />
                </motion.div>
              </div>

              <h1 className="text-3xl font-bold text-gray-800 mb-3">
                {dict.title}
              </h1>
              <p className="text-gray-600 text-base mb-4">{dict.subtitle}</p>

              {/* UPDATED: Email Badge (Teal/Gray) */}
              <div className="inline-flex items-center gap-2 px-4 py-2 bg-slate-50 rounded-full border border-slate-200">
                <Mail className="w-4 h-4 text-teal-600" />
                <span className="text-sm font-medium text-gray-700">
                  {dict.emailSentTo}{' '}
                  <span className="text-teal-700 font-bold">{email}</span>
                </span>
              </div>
            </motion.div>

            {/* Code Input Section */}
            <motion.div
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3, duration: 0.5 }}
              className="mb-8"
            >
              <label className="block text-sm font-medium text-gray-700 mb-4 text-center">
                {dict.enterCode}
              </label>

              <div
                className="flex justify-center gap-2 sm:gap-3 mb-6"
                dir="ltr"
              >
                {code.map((digit, index) => (
                  <motion.input
                    key={index}
                    ref={(el) => {
                      inputRefs.current[index] = el;
                    }}
                    type="text"
                    inputMode="numeric"
                    maxLength={1}
                    value={digit}
                    onChange={(e) => handleInputChange(index, e.target.value)}
                    onKeyDown={(e) => handleKeyDown(index, e)}
                    onPaste={index === 0 ? handlePaste : undefined}
                    disabled={status === 'verifying' || status === 'success'}
                    whileFocus={{ scale: 1.05 }}
                    // UPDATED: Input Colors (Teal Focus/Fill)
                    className={`
                      w-12 h-14 sm:w-14 sm:h-16 text-center text-2xl font-bold rounded-xl
                      border-2 transition-all duration-200
                      ${
                        status === 'error'
                          ? 'border-red-400 bg-red-50 text-red-600'
                          : status === 'success'
                            ? 'border-green-400 bg-green-50 text-green-600'
                            : digit
                              ? 'border-teal-400 bg-teal-50 text-gray-800'
                              : 'border-gray-200 bg-white text-gray-800 hover:border-teal-200'
                      }
                      focus:outline-none focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500
                      disabled:opacity-60 disabled:cursor-not-allowed
                    `}
                  />
                ))}
              </div>

              {/* Status Messages */}
              <AnimatePresence mode="wait">
                {status === 'verifying' && (
                  // UPDATED: Text Color (Teal)
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="flex items-center justify-center gap-2 text-teal-600 mb-4"
                  >
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span className="text-sm font-medium">
                      {dict.verifying}
                    </span>
                  </motion.div>
                )}

                {status === 'success' && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="text-center mb-4"
                  >
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      transition={{
                        type: 'spring',
                        stiffness: 200,
                        damping: 15,
                      }}
                      className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-full border-2 border-green-400 mb-2"
                    >
                      <CheckCircle className="w-6 h-6 text-green-600" />
                      <span className="text-green-700 font-bold">
                        {dict.success}
                      </span>
                    </motion.div>
                    <p className="text-sm text-gray-600">
                      {dict.successMessage}
                    </p>
                  </motion.div>
                )}

                {status === 'error' && errorMessage && (
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-200 rounded-xl p-4 mb-4"
                  >
                    <div className="flex items-start gap-3">
                      <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                      <div>
                        <p className="font-semibold text-red-800 text-sm mb-1">
                          {dict.errorTitle}
                        </p>
                        <p className="text-red-600 text-sm">{errorMessage}</p>
                      </div>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>

              {/* Resend Section */}
              {status !== 'success' && (
                <div className="text-center space-y-3">
                  <p className="text-sm text-gray-600">{dict.didntReceive}</p>

                  {canResend ? (
                    <Button
                      onClick={handleResendCode}
                      disabled={isResending}
                      variant="outline"
                      size="sm"
                      // UPDATED: Resend Button (Teal Border/Text)
                      className="border-2 border-teal-200 text-teal-700 hover:bg-teal-50 hover:border-teal-300 rounded-full px-6 py-2 transition-all"
                    >
                      {isResending ? (
                        <>
                          <Loader2 className="w-4 h-4 animate-spin mr-2" />
                          {isHebrew ? '砖...' : 'Sending...'}
                        </>
                      ) : (
                        <>
                          <RefreshCw className="w-4 h-4 mr-2" />
                          {dict.resendCode}
                        </>
                      )}
                    </Button>
                  ) : (
                    <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full border border-gray-200">
                      <Clock className="w-4 h-4 text-gray-500" />
                      <span className="text-sm text-gray-600">
                        {dict.resendIn}{' '}
                        <span className="font-bold text-gray-800">
                          {resendCountdown}
                        </span>{' '}
                        {dict.seconds}
                      </span>
                    </div>
                  )}

                  <p className="text-xs text-gray-500 italic">
                    {dict.checkSpam}
                  </p>
                </div>
              )}
            </motion.div>

            {/* UPDATED: Security Note (Warm/Amber background) */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.5, duration: 0.5 }}
              className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100 mb-6"
            >
              <div className="flex items-start gap-3">
                <Shield className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                <p className="text-sm text-amber-800">{dict.securityNote}</p>
              </div>
            </motion.div>

            {/* Back Link */}
            <div className="text-center">
              <Link
                href={`/${locale}/auth/register`}
                // UPDATED: Link Hover (Teal)
                className="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-teal-600 transition-colors group"
              >
                <ArrowLeft
                  className={`w-4 h-4 group-hover:-translate-x-1 transition-transform ${isHebrew ? '' : 'rotate-180'}`}
                />
                <span>{dict.backToRegister}</span>
              </Link>
            </div>
          </div>
        </div>

        {/* Floating Decorative Elements */}
        <motion.div
          animate={{ y: [0, -10, 0], rotate: [0, 5, 0] }}
          transition={{ duration: 6, repeat: Infinity, ease: 'easeInOut' }}
          // Teal Blob
          className="absolute -top-6 -right-6 w-16 h-16 bg-gradient-to-br from-teal-400 to-emerald-500 rounded-2xl opacity-20 blur-xl"
        />
        <motion.div
          animate={{ y: [0, 10, 0], rotate: [0, -5, 0] }}
          transition={{
            duration: 7,
            repeat: Infinity,
            ease: 'easeInOut',
            delay: 1,
          }}
          // Orange Blob
          className="absolute -bottom-6 -left-6 w-20 h-20 bg-gradient-to-br from-orange-400 to-amber-500 rounded-2xl opacity-20 blur-xl"
        />
      </motion.div>

      <style>{`
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type='number'] {
          -moz-appearance: textfield;
        }
      `}</style>
    </div>
  );
}
--- End of Content for VerifyEmailClient.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\auth_contents.txt
--------------------------------------------------------------------------------
[This is the output log file itself. Content not included.]

================================================================================
Directory: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps
================================================================================

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\BasicInfoStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/BasicInfoStep.tsx
'use client';

import { useState } from 'react';
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import {
  ArrowLeft,
  ArrowRight,
  User,
  Mail,
  Lock,
  AlertCircle,
  Loader2,
  Eye,
  EyeOff,
  ListChecks,
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';
import { Input } from '@/components/ui/input';
import { signIn } from 'next-auth/react';

interface BasicInfoStepProps {
  dict: RegisterStepsDict['steps']['basicInfo'];
  consentDict: RegisterStepsDict['consentCheckbox'];
  validationDict: RegisterStepsDict['validationErrors'];
  locale: 'he' | 'en';
}

// 驻拽爪转 注专 爪
const isValidEmail = (email: string): boolean => {
  const emailRegex = /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i;
  return email.trim() !== '' && emailRegex.test(email);
};

const isValidPassword = (password: string): boolean => {
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
  return passwordRegex.test(password);
};

// 拽 砖 砖爪拽 爪注 专砖 注 Google
const GOOGLE_SIGNUP_SUGGESTED_ERRORS = [
  'DB_CONNECTION_ERROR',
  'DB_INIT_ERROR',
  'P1001',
  'P1002',
  'P1003',
  'P1008',
  'P1017',
];

const BasicInfoStep: React.FC<BasicInfoStepProps> = ({
  dict,
  consentDict,
  validationDict,
  locale,
}) => {
  const { data, updateField, prevStep, proceedToEmailVerification } =
    useRegistration();

  //  爪 砖 拽
  const [passwordError, setPasswordError] = useState('');
  const [emailError, setEmailError] = useState('');

  //  爪 注 砖转 转
  const [isLoading, setIsLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);

  // ==========  住驻: 爪 爪转 爪注转 Google ==========
  const [showGoogleSuggestion, setShowGoogleSuggestion] = useState(false);
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  // =====================================================

  //  专转 住住
  const [passwordVisible, setPasswordVisible] = useState(false);

  // 专砖转 砖转 住专 转爪 专砖 驻住
  const [missingFields, setMissingFields] = useState<string[]>([]);

  // ==========  住驻: 驻拽爪 专砖 注 Google ==========
  const handleGoogleSignup = async () => {
    setIsGoogleLoading(true);
    try {
      await signIn('google', {
        callbackUrl: `/${locale}/auth/register`,
        redirect: true,
      });
    } catch (error) {
      console.error('Google signup error:', error);
      setIsGoogleLoading(false);
    }
  };
  // =======================================================

  const handleRegisterSubmit = async () => {
    // 1. 驻住 砖转 拽转
    setApiError(null);
    setMissingFields([]);
    setEmailError('');
    setPasswordError('');
    setShowGoogleSuggestion(false); // ==========  住驻 ==========

    let hasError = false;
    const currentMissing: string[] = [];

    // 2. 爪 砖 砖转

    // 拽转 
    if (!isValidEmail(data.email)) {
      setEmailError(dict.errors.invalidEmail);
      currentMissing.push(validationDict.fields.email);
      hasError = true;
    }

    // 拽转 住住
    if (!isValidPassword(data.password)) {
      setPasswordError(dict.errors.invalidPassword);
      currentMissing.push(validationDict.fields.password);
      hasError = true;
    }

    // 拽转 砖 驻专
    if (!data.firstName.trim()) {
      currentMissing.push(validationDict.fields.firstName);
      hasError = true;
    }

    // 拽转 砖 砖驻
    if (!data.lastName.trim()) {
      currentMissing.push(validationDict.fields.lastName);
      hasError = true;
    }

    // 3.  砖 砖转 - 注爪专 爪 转
    if (hasError) {
      setMissingFields(currentMissing);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    // 4.   转拽 - 砖 砖专转
    setIsLoading(true);

    try {
      const response = await fetch(`/api/auth/register?locale=${locale}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: data.email,
          password: data.password,
          firstName: data.firstName,
          lastName: data.lastName,
          language: data.language,
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        // ==========  住驻: 拽  爪注 专砖 注 Google ==========
        const errorCode = result.errorCode || '';
        if (
          GOOGLE_SIGNUP_SUGGESTED_ERRORS.includes(errorCode) ||
          result.error?.includes('砖转 专') ||
          result.error?.includes('P1001')
        ) {
          setShowGoogleSuggestion(true);
        }
        // ==============================================================
        throw new Error(result.error || dict.errors.default);
      }

      // 注专 砖 转  注  砖转拽 砖专转
      proceedToEmailVerification(result.email);
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
    } finally {
      setIsLoading(false);
    }
  };

  // 专转 爪
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-5"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {/* 转专转 砖 转 (砖专转) */}
      {apiError && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{apiError}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      {/* ==========  住驻: 爪注 专砖 注 Google ==========  */}
      <AnimatePresence>
        {showGoogleSuggestion && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="overflow-hidden"
          >
            <Alert className="bg-blue-50 border-blue-200 text-blue-800">
              <div className="flex flex-col gap-3">
                <div className="flex items-start gap-2">
                  <Mail className="h-5 w-5 text-blue-600 mt-0.5 shrink-0" />
                  <div>
                    <AlertTitle className="text-blue-900 font-bold mb-1">
                      {dict.googleSuggestion?.title}
                    </AlertTitle>
                    <AlertDescription className="text-sm text-blue-700">
                      {dict.googleSuggestion?.description}
                    </AlertDescription>
                  </div>
                </div>

                <Button
                  type="button"
                  onClick={handleGoogleSignup}
                  disabled={isGoogleLoading}
                  className="w-full flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 shadow-sm"
                >
                  {isGoogleLoading ? (
                    <>
                      <Loader2 className="h-5 w-5 animate-spin" />
                      <span>{dict.googleSuggestion?.buttonLoading}</span>
                    </>
                  ) : (
                    <>
                      <svg className="h-5 w-5" viewBox="0 0 24 24">
                        <path
                          fill="#4285F4"
                          d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                        />
                        <path
                          fill="#34A853"
                          d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                        />
                        <path
                          fill="#FBBC05"
                          d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                        />
                        <path
                          fill="#EA4335"
                          d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                        />
                      </svg>
                      <span>{dict.googleSuggestion?.buttonText}</span>
                    </>
                  )}
                </Button>
              </div>
            </Alert>
          </motion.div>
        )}
      </AnimatePresence>
      {/* ========================================================= */}

      {/* 转专转 爪 (砖转 住专) */}
      <AnimatePresence>
        {missingFields.length > 0 && (
          <motion.div
            variants={itemVariants}
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
          >
            <Alert
              variant="destructive"
              className="bg-red-50 border-red-200 text-red-800"
            >
              <div className="flex items-start gap-3">
                <div className="p-2 bg-red-100 rounded-lg shrink-0">
                  <ListChecks className="h-5 w-5 text-red-600" />
                </div>
                <div>
                  <AlertTitle className="text-red-900 font-bold mb-2">
                    {validationDict.title}
                  </AlertTitle>
                  <AlertDescription className="text-sm">
                    <p className="mb-2 font-medium">
                      {validationDict.pleaseFill}
                    </p>
                    <ul className="list-disc list-inside space-y-1 opacity-90 pr-2 rtl:pr-2 rtl:pl-0 ltr:pl-2">
                      {missingFields.map((field, idx) => (
                        <li key={idx}>{field}</li>
                      ))}
                    </ul>
                  </AlertDescription>
                </div>
              </div>
            </Alert>
          </motion.div>
        )}
      </AnimatePresence>

      <motion.h2
        className="text-xl font-bold text-gray-800 mb-4"
        variants={itemVariants}
      >
        {dict.title}
      </motion.h2>

      <motion.div variants={itemVariants} className="space-y-4">
        {/* 砖  */}
        <div className="space-y-1">
          <label
            htmlFor="emailBasic"
            className="block text-sm font-medium text-gray-700"
          >
            {dict.emailLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Mail className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="email"
              id="emailBasic"
              value={data.email}
              onChange={(e) => {
                updateField('email', e.target.value);
                if (emailError) setEmailError('');
              }}
              onBlur={() =>
                setEmailError(
                  isValidEmail(data.email) ? '' : dict.errors.invalidEmail
                )
              }
              placeholder={dict.emailPlaceholder}
              disabled={isLoading}
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors 
                ${isLoading ? 'bg-gray-100' : ''} 
                ${
                  emailError ||
                  missingFields.includes(validationDict.fields.email)
                    ? 'border-red-500 focus:ring-red-200'
                    : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                }`}
            />
          </div>
          {emailError && (
            <p role="alert" className="text-red-500 text-xs mt-1">
              {emailError}
            </p>
          )}
        </div>

        {/* 砖 住住 */}
        <div className="space-y-1">
          <label
            htmlFor="passwordBasic"
            className="block text-sm font-medium text-gray-700"
          >
            {dict.passwordLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Lock className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5 pointer-events-none" />
            <Input
              type={passwordVisible ? 'text' : 'password'}
              id="passwordBasic"
              value={data.password}
              onChange={(e) => {
                updateField('password', e.target.value);
                if (passwordError) setPasswordError('');
              }}
              onBlur={() =>
                setPasswordError(
                  isValidPassword(data.password)
                    ? ''
                    : dict.errors.invalidPassword
                )
              }
              placeholder={dict.passwordPlaceholder}
              disabled={isLoading}
              className={`w-full pr-10 pl-10 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors 
                ${isLoading ? 'bg-gray-100' : ''} 
                ${
                  passwordError ||
                  missingFields.includes(validationDict.fields.password)
                    ? 'border-red-500 focus:ring-red-200'
                    : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                }`}
            />
            <button
              type="button"
              onClick={() => setPasswordVisible(!passwordVisible)}
              className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
              aria-label={passwordVisible ? '住转专 住住' : '爪 住住'}
            >
              {passwordVisible ? (
                <EyeOff className="h-5 w-5" />
              ) : (
                <Eye className="h-5 w-5" />
              )}
            </button>
          </div>
          {passwordError ? (
            <p role="alert" className="text-red-500 text-xs mt-1">
              {passwordError}
            </p>
          ) : (
            <p className="text-gray-500 text-xs mt-1">{dict.passwordHint}</p>
          )}
        </div>

        {/* 砖 砖 驻专 */}
        <div className="space-y-1">
          <label
            htmlFor="firstNameBasic"
            className="block text-sm font-medium text-gray-700"
          >
            {dict.firstNameLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <User className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="text"
              id="firstNameBasic"
              value={data.firstName}
              onChange={(e) => updateField('firstName', e.target.value)}
              placeholder={dict.firstNamePlaceholder}
              disabled={isLoading}
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors 
                ${isLoading ? 'bg-gray-100' : ''} 
                ${
                  missingFields.includes(validationDict.fields.firstName)
                    ? 'border-red-500 focus:ring-red-200'
                    : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                }`}
            />
          </div>
        </div>

        {/* 砖 砖 砖驻 */}
        <div className="space-y-1">
          <label
            htmlFor="lastNameBasic"
            className="block text-sm font-medium text-gray-700"
          >
            {dict.lastNameLabel} <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <User className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="text"
              id="lastNameBasic"
              value={data.lastName}
              onChange={(e) => updateField('lastName', e.target.value)}
              placeholder={dict.lastNamePlaceholder}
              disabled={isLoading}
              className={`w-full pr-10 pl-3 py-3 border rounded-lg focus:ring-2 focus:outline-none transition-colors 
                ${isLoading ? 'bg-gray-100' : ''} 
                ${
                  missingFields.includes(validationDict.fields.lastName)
                    ? 'border-red-500 focus:ring-red-200'
                    : 'border-gray-300 focus:ring-teal-200 focus:border-teal-500'
                }`}
            />
          </div>
        </div>
      </motion.div>

      {/* 专转 砖驻 */}
      <motion.div variants={itemVariants} className="space-y-1">
        <label
          htmlFor="language"
          className="block text-sm font-medium text-gray-700"
        >
          {dict.languageLabel}
        </label>
        <select
          id="language"
          value={data.language}
          onChange={(e) =>
            updateField('language', e.target.value as 'he' | 'en')
          }
          disabled={isLoading}
          className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-200 focus:border-teal-500 focus:outline-none bg-white"
        >
          <option value="he">注专转</option>
          <option value="en">English</option>
        </select>
      </motion.div>

      {/* 专 驻转专 */}
      <motion.div
        variants={itemVariants}
        className="pt-4 mt-6 border-t border-gray-200"
      >
        <Button
          type="button"
          onClick={handleRegisterSubmit}
          disabled={isLoading}
          className={`w-full flex items-center gap-2 justify-center text-white font-medium px-4 py-2.5 rounded-lg transition-all 
            ${
              isLoading
                ? 'bg-gray-400 cursor-not-allowed'
                : 'bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-md hover:shadow-lg'
            }`}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin mr-2" />
              <span>{dict.nextButtonLoading}</span>
            </>
          ) : (
            <>
              <span>{dict.nextButton}</span>
              <ArrowLeft
                className={`h-4 w-4 mr-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
              />{' '}
            </>
          )}
        </Button>

        <p className="text-[10px] text-gray-500 text-center mt-2 px-2">
          {dict.termsDisclaimer}
        </p>
      </motion.div>

      <div className="flex justify-center mt-2">
        <Button
          type="button"
          onClick={prevStep}
          variant="ghost"
          disabled={isLoading}
          className="text-xs text-gray-400 hover:text-gray-600"
        >
          <ArrowRight
            className={`h-3 w-3 ml-1 ${locale === 'en' ? 'transform rotate-180' : ''}`}
          />{' '}
          {dict.backButton}
        </Button>
      </div>
    </motion.div>
  );
};

export default BasicInfoStep;
--- End of Content for BasicInfoStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\CompleteStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/CompleteStep.tsx
'use client';

import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { CheckCircle, Mail, User, Phone } from 'lucide-react';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { useSession } from 'next-auth/react';
import { UserStatus } from '@prisma/client';
import type { User as SessionUserType } from '@/types/next-auth';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';
import StandardizedLoadingSpinner from '@/components/questionnaire/common/StandardizedLoadingSpinner';

interface CompleteStepProps {
  dict: RegisterStepsDict['steps']['complete'];
}

const containerVariants = {
  hidden: { opacity: 0, scale: 0.95 },
  visible: {
    opacity: 1,
    scale: 1,
    transition: { staggerChildren: 0.1, delayChildren: 0.2 },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: { opacity: 1, y: 0, transition: { type: 'spring', stiffness: 100 } },
};

const circleVariants = {
  hidden: { opacity: 0, scale: 0.5 },
  visible: {
    opacity: 1,
    scale: 1,
    transition: { duration: 0.5, ease: 'easeOut' },
  },
};

const CompleteStep: React.FC<CompleteStepProps> = ({ dict }) => {
  const router = useRouter();
  const { data: session, status: sessionStatus } = useSession();

  if (sessionStatus === 'loading') {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-center space-y-4">
        <StandardizedLoadingSpinner className="text-cyan-600 w-10 h-10" />
        <p className="text-lg text-gray-600">{dict.loading}</p>
      </div>
    );
  }

  if (sessionStatus === 'unauthenticated' || !session?.user) {
    router.push('/auth/signin');
    return null;
  }

  const user = session.user as SessionUserType;

  // Scenario 1: Needs email verification
  if (user.status === UserStatus.PENDING_EMAIL_VERIFICATION) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-cyan-100 flex items-center justify-center">
            <Mail className="h-12 w-12 text-cyan-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.verifyEmailTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.verifyEmailSubtitle}{' '}
          <span className="font-bold text-gray-700">{user.email}</span>.
          <br />
          {dict.verifyEmailPrompt}
        </motion.p>
      </motion.div>
    );
  }

  // Scenario 2: Needs profile completion
  if (!user.isProfileComplete) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center">
            <User className="h-12 w-12 text-indigo-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.completeProfileTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.completeProfileSubtitle}
        </motion.p>
        <motion.div variants={itemVariants}>
          <Button
            onClick={() =>
              router.push('/auth/register?reason=complete_profile')
            }
            className="w-full"
          >
            {dict.completeProfileButton}
          </Button>
        </motion.div>
      </motion.div>
    );
  }

  // Scenario 3: Needs phone verification
  if (!user.isPhoneVerified) {
    return (
      <motion.div
        className="space-y-6 text-center"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div className="flex justify-center" variants={circleVariants}>
          <div className="w-24 h-24 rounded-full bg-pink-100 flex items-center justify-center">
            <Phone className="h-12 w-12 text-pink-600" />
          </div>
        </motion.div>
        <motion.h2
          className="text-2xl font-bold text-gray-800"
          variants={itemVariants}
        >
          {dict.verifyPhoneTitle}
        </motion.h2>
        <motion.p className="text-gray-600" variants={itemVariants}>
          {dict.verifyPhoneSubtitle}
        </motion.p>
        <motion.div variants={itemVariants}>
          <Button
            onClick={() => router.push('/auth/verify-phone')}
            className="w-full"
          >
            {dict.verifyPhoneButton}
          </Button>
        </motion.div>
      </motion.div>
    );
  }

  // Scenario 4: Everything is complete
  return (
    <motion.div
      className="space-y-6 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.div className="flex justify-center" variants={circleVariants}>
        <div className="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center">
          <CheckCircle className="h-12 w-12 text-green-600" />
        </div>
      </motion.div>
      <motion.h2
        className="text-2xl font-bold text-gray-800"
        variants={itemVariants}
      >
        {dict.allDoneTitle}
      </motion.h2>
      <motion.p className="text-gray-600" variants={itemVariants}>
        {dict.allDoneSubtitle}
      </motion.p>
      <motion.div variants={itemVariants} className="flex flex-col gap-4">
        <Button onClick={() => router.push('/profile')} className="w-full">
          <User className="h-4 w-4 ml-2" /> {dict.myProfileButton}
        </Button>
        <Button
          onClick={() => router.push('/questionnaire')}
          variant="outline"
          className="w-full"
        >
          {dict.questionnaireButton}
        </Button>
        <Link href="/" className="text-sm text-gray-500 hover:underline mt-2">
          {dict.backToHomeLink}
        </Link>
      </motion.div>
    </motion.div>
  );
};

export default CompleteStep;
--- End of Content for CompleteStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\EmailVerificationCodeStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/EmailVerificationCodeStep.tsx
'use client';

import { useState, useRef, KeyboardEvent, useEffect, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import { signIn } from 'next-auth/react';
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Loader2, AlertCircle, MailCheck, ArrowRight } from 'lucide-react';
import { motion } from 'framer-motion';
import { Input } from '@/components/ui/input';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

const OTP_LENGTH = 6;

interface EmailVerificationCodeStepProps {
  dict: RegisterStepsDict['steps']['emailVerification'];
  locale: 'he' | 'en';
}

const EmailVerificationCodeStep: React.FC<EmailVerificationCodeStepProps> = ({
  dict,
  locale,
}) => {
  const {
    data: registrationData,
    exitEmailVerification: goBackToBasicInfo,
    completeEmailVerification,
  } = useRegistration();
  const router = useRouter();
  const [otp, setOtp] = useState<string[]>(new Array(OTP_LENGTH).fill(''));
  const [isLoading, setIsLoading] = useState(false);
  const [isResending, setIsResending] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [resendMessage, setResendMessage] = useState<string | null>(null);
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  useEffect(() => {
    inputRefs.current[0]?.focus();
  }, []);

  const handleChange = (element: HTMLInputElement, index: number) => {
    const value = element.value.replace(/[^0-9]/g, '');
    const newOtp = [...otp];
    newOtp[index] = value.slice(-1);
    setOtp(newOtp);

    if (value && index < OTP_LENGTH - 1) {
      inputRefs.current[index + 1]?.focus();
    }
  };

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>, index: number) => {
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const handleFormSubmit = async (e: FormEvent) => {
    e.preventDefault();
    const enteredCode = otp.join('');
    if (enteredCode.length !== OTP_LENGTH) {
      setApiError(
        dict.errors.incompleteCode.replace('{{length}}', OTP_LENGTH.toString())
      );
      return;
    }

    setIsLoading(true);
    setApiError(null);
    setResendMessage(null);

    try {
      const response = await fetch(
        `/api/auth/verify-email-code?locale=${locale}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: registrationData.emailForVerification,
            code: enteredCode,
          }),
        }
      );
      const result = await response.json();
      if (!response.ok || !result.success || !result.authToken) {
        throw new Error(result.error || dict.errors.default);
      }

      const signInResult = await signIn('email-verified-autologin', {
        authToken: result.authToken,
        redirect: false,
      });

      if (signInResult?.ok) {
        completeEmailVerification();
        router.push('/auth/register');
      } else {
        throw new Error(
          dict.errors.autoSignInFailed.replace(
            '{error}',
            signInResult?.error || 'Unknown error'
          )
        );
      }
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
      setIsLoading(false);
    }
  };

  const handleResendCode = async () => {
    setIsResending(true);
    setApiError(null);
    setResendMessage(null);
    try {
      const response = await fetch('/api/auth/resend-verification-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: registrationData.emailForVerification }),
      });
      const result = await response.json();
      if (!response.ok) throw new Error(result.error);
      setResendMessage(dict.alerts.resent);
    } catch (error) {
      setApiError(error instanceof Error ? error.message : dict.errors.default);
    } finally {
      setIsResending(false);
    }
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-6 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.div variants={itemVariants}>
        {/* UPDATED: Icon Color (Teal) */}
        <MailCheck className="h-12 w-12 text-teal-500 mx-auto mb-3" />
        <h2 className="text-2xl font-bold text-gray-800">{dict.title}</h2>
        <p className="text-gray-600 mt-2">
          {dict.subtitle.replace('{{length}}', OTP_LENGTH.toString())}{' '}
          <strong className="font-semibold text-gray-700">
            {registrationData.emailForVerification || dict.yourEmail}
          </strong>
          .
        </p>
      </motion.div>

      {apiError && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{apiError}</AlertDescription>
          </Alert>
        </motion.div>
      )}
      {resendMessage && !apiError && (
        <motion.div variants={itemVariants}>
          <Alert
            variant="default"
            className="bg-green-50 border-green-300 text-green-700"
            role="status"
          >
            <MailCheck className="h-4 w-4 text-green-600" />
            <AlertTitle>{dict.alerts.title}</AlertTitle>
            <AlertDescription>{resendMessage}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      <form onSubmit={handleFormSubmit}>
        <motion.div
          variants={itemVariants}
          className="flex justify-center space-x-2 rtl:space-x-reverse"
          dir="ltr"
        >
          {otp.map((digit, index) => (
            <Input
              key={index}
              type="text"
              maxLength={1}
              value={digit}
              onChange={(e) =>
                handleChange(e.target as HTMLInputElement, index)
              }
              onKeyDown={(e) =>
                handleKeyDown(e as KeyboardEvent<HTMLInputElement>, index)
              }
              ref={(el) => {
                inputRefs.current[index] = el;
              }}
              // UPDATED: Input Focus (Teal)
              className="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-200 focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 rounded-xl"
              disabled={isLoading || isResending}
              aria-label={`OTP digit ${index + 1}`}
              autoComplete="one-time-code"
              inputMode="numeric"
            />
          ))}
        </motion.div>

        <motion.div variants={itemVariants} className="mt-6">
          <Button
            type="submit"
            disabled={
              isLoading || isResending || otp.join('').length !== OTP_LENGTH
            }
            // UPDATED: Main Button Gradient (Teal -> Orange -> Amber)
            className="w-full py-6 text-lg bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg transition-all"
          >
            {isLoading ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin ml-2" />
                <span>{dict.submitButtonLoading}</span>
              </>
            ) : (
              dict.submitButton
            )}
          </Button>
        </motion.div>
      </form>

      <motion.div
        variants={itemVariants}
        className="text-sm text-gray-500 mt-2"
      >
        {dict.resendPrompt}{' '}
        <Button
          type="button"
          variant="link"
          onClick={handleResendCode}
          disabled={isLoading || isResending}
          // UPDATED: Link Color (Teal)
          className="p-0 h-auto text-teal-600 hover:text-teal-700 font-semibold"
        >
          {isResending ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin ml-1" />
              <span>{dict.resendButtonLoading}</span>
            </>
          ) : (
            dict.resendButton
          )}
        </Button>
      </motion.div>

      <motion.div variants={itemVariants} className="mt-6">
        <Button
          type="button"
          onClick={goBackToBasicInfo}
          variant="outline"
          disabled={isLoading || isResending}
          className="hover:bg-gray-50 border-gray-200"
        >
          <ArrowRight
            className={`h-4 w-4 ml-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
          />{' '}
          {dict.backButton}{' '}
        </Button>
      </motion.div>
    </motion.div>
  );
};

export default EmailVerificationCodeStep;
--- End of Content for EmailVerificationCodeStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\OptionalInfoStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/OptionalInfoStep.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
// 住专 转 useSession    爪专 转 转专 
import { useRegistration } from '../RegistrationContext';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Input } from '@/components/ui/input';
import {
  ArrowLeft,
  ArrowRight,
  Ruler,
  Briefcase,
  GraduationCap,
  Loader2,
  AlertCircle,
} from 'lucide-react';
import { motion } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface OptionalInfoStepProps {
  dict: RegisterStepsDict['steps']['optionalInfo'];
  locale: 'he' | 'en';
}

const OptionalInfoStep: React.FC<OptionalInfoStepProps> = ({
  dict,
  locale,
}) => {
  const { data, updateField, prevStep } = useRegistration();
  const router = useRouter();

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ============================ 转拽 住驻 ============================
  const handleSubmit = async () => {
    // 注 转 驻转专  注 爪转 驻转
    setIsLoading(true);
    setError(null);

    try {
      const profileData = {
        firstName: data.firstName,
        lastName: data.lastName,
        phone: data.phone,
        gender: data.gender,
        birthDate: data.birthDate,
        maritalStatus: data.maritalStatus,
        height: data.height,
        occupation: data.occupation,
        education: data.education,
      };

      if (
        !profileData.firstName ||
        !profileData.lastName ||
        !profileData.phone
      ) {
        throw new Error(dict.errors.missingData);
      }

      // 1. 砖专 转 驻专驻.  住.
      const profileResponse = await fetch('/api/auth/complete-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData),
      });
      if (!profileResponse.ok) {
        const errorData = await profileResponse.json();
        throw new Error(errorData.error || dict.errors.default);
      }

      // 2. 砖 转 拽 转.  住.
      const sendCodeResponse = await fetch('/api/auth/send-phone-code', {
        method: 'POST',
      });
      if (!sendCodeResponse.ok) {
        const errorData = await sendCodeResponse.json();
        throw new Error(errorData.error || dict.errors.default);
      }

      // 3.  转 祝 .  砖 专 爪注.
      router.push(`/${locale}/auth/verify-phone`);
    } catch (err) {
      //  砖 砖, 爪 砖 砖专专 转 驻转专
      setError(err instanceof Error ? err.message : dict.errors.default);
      setIsLoading(false);
    }
  };
  // =====================================================================

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } },
  };
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5 } },
  };

  return (
    <motion.div
      className="space-y-5"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      <motion.h2
        className="text-xl font-bold text-gray-800"
        variants={itemVariants}
      >
        {dict.title}
      </motion.h2>
      <motion.p className="text-gray-600 text-sm" variants={itemVariants}>
        {dict.subtitle}
      </motion.p>

      {error && (
        <motion.div variants={itemVariants}>
          <Alert variant="destructive" role="alert">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>{dict.errors.title}</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        </motion.div>
      )}

      <motion.div variants={itemVariants} className="space-y-4">
        {/* 砖转 驻住 */}
        <div className="space-y-1">
          <label
            htmlFor="heightOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <Ruler className="h-4 w-4 text-gray-400" />
            {dict.heightLabel}
          </label>
          <Input
            type="number"
            id="heightOptional"
            min="120"
            max="220"
            value={data.height ?? ''}
            onChange={(e) =>
              updateField(
                'height',
                e.target.value ? parseInt(e.target.value, 10) : undefined
              )
            }
            placeholder={dict.heightPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
        <div className="space-y-1">
          <label
            htmlFor="occupationOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <Briefcase className="h-4 w-4 text-gray-400" />
            {dict.occupationLabel}
          </label>
          <Input
            type="text"
            id="occupationOptional"
            value={data.occupation ?? ''}
            onChange={(e) => updateField('occupation', e.target.value)}
            placeholder={dict.occupationPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
        <div className="space-y-1">
          <label
            htmlFor="educationOptional"
            className="block text-sm font-medium text-gray-700 flex items-center gap-1"
          >
            <GraduationCap className="h-4 w-4 text-gray-400" />
            {dict.educationLabel}
          </label>
          <Input
            type="text"
            id="educationOptional"
            value={data.education ?? ''}
            onChange={(e) => updateField('education', e.target.value)}
            placeholder={dict.educationPlaceholder}
            disabled={isLoading}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500 focus:outline-none"
          />
        </div>
      </motion.div>

      <motion.div
        variants={itemVariants}
        className="flex justify-between pt-4 mt-6"
      >
        <Button
          type="button"
          onClick={prevStep}
          variant="outline"
          disabled={isLoading}
        >
          <ArrowRight
            className={`h-4 w-4 ml-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
          />{' '}
          {dict.backButton}
        </Button>
        <Button
          type="button"
          onClick={handleSubmit}
          disabled={isLoading}
          className={`flex items-center gap-2 ${isLoading ? 'bg-gray-400' : 'bg-gradient-to-r from-cyan-500 to-pink-500'}`}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin mr-2" />
              <span></span>
            </>
          ) : (
            <>
              {dict.nextButton}{' '}
              <ArrowLeft
                className={`h-4 w-4 mr-2 ${locale === 'en' ? 'transform rotate-180' : ''}`}
              />{' '}
            </>
          )}
        </Button>
      </motion.div>
    </motion.div>
  );
};

export default OptionalInfoStep;
--- End of Content for OptionalInfoStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\PersonalDetailsStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/PersonalDetailsStep.tsx
'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import { useSession } from 'next-auth/react';
import { useRegistration } from '../RegistrationContext';
import { Gender } from '@prisma/client';
import Autocomplete from 'react-google-autocomplete';

// Icons
import {
  User,
  Calendar,
  Heart,
  Sparkles,
  CheckCircle2,
  AlertCircle,
  Loader2,
  ArrowLeft,
  ArrowRight,
  Edit3,
  Ruler,
  Briefcase,
  GraduationCap,
  BookOpen,
  Shield,
  ListChecks,
  Camera,
  ImagePlus,
  FileText,
  Info,
  Trash2,
  Star,
  MapPin,
} from 'lucide-react';

// UI Components
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';

// Custom Components
import PhoneNumberInput from '../PhoneNumberInput';
import ConsentCheckbox from '../ConsentCheckbox';

// Types
import type { RegisterStepsDict } from '@/types/dictionaries/auth';
import type { User as SessionUserType } from '@/types/next-auth'; //  驻住 砖转砖

// ... (SimpleConsentBox, inputBaseClasses, FieldWrapper, SectionHeader, containerVariants, itemVariants remain unchanged) ...
// ============================================================================
// COMPONENT: SimpleConsentBox
// ============================================================================

interface SimpleConsentBoxProps {
  checked: boolean;
  onToggle: () => void;
  label: string;
  required?: boolean;
  error?: string | null;
}

const SimpleConsentBox: React.FC<SimpleConsentBoxProps> = ({
  checked,
  onToggle,
  label,
  required,
  error,
}) => {
  return (
    <div
      onClick={onToggle}
      className={`
        relative flex items-start gap-4 p-4 rounded-2xl border-2 cursor-pointer transition-all duration-200
        ${
          checked
            ? 'bg-teal-50/60 border-teal-200 shadow-sm'
            : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50'
        }
        ${error ? 'bg-red-50/50 border-red-200 ring-1 ring-red-100' : ''}
      `}
    >
      <div className="mt-1 shrink-0">
        <Checkbox
          checked={checked}
          className="pointer-events-none data-[state=checked]:bg-teal-600 data-[state=checked]:border-teal-600"
        />
      </div>

      <div className="flex-1">
        <p
          className={`text-sm font-medium leading-relaxed ${checked ? 'text-teal-900' : 'text-gray-700'}`}
        >
          {label}
          {required && <span className="text-red-500 mr-1">*</span>}
        </p>
        {error && (
          <p className="text-xs text-red-500 mt-1 font-medium animate-in slide-in-from-top-1">
            {error}
          </p>
        )}
      </div>
    </div>
  );
};

// ============================================================================
// STYLING HELPERS
// ============================================================================

const inputBaseClasses = (hasError: boolean) => `
  w-full pr-11 py-3 border-2 rounded-xl 
  bg-white/95 backdrop-blur-none
  text-base md:text-sm 
  transition-colors duration-200
  disabled:opacity-50
  ${
    hasError
      ? 'border-red-300 focus:ring-red-200 focus:border-red-400'
      : 'border-gray-200 hover:border-gray-300 focus:border-teal-400 focus:ring-2 focus:ring-teal-200'
  }
`;

interface FieldWrapperProps {
  children: React.ReactNode;
  icon: React.ReactNode;
  hasValue?: boolean;
  className?: string;
}

const FieldWrapper: React.FC<FieldWrapperProps> = ({
  children,
  icon,
  hasValue = false,
  className = '',
}) => (
  <div className={`relative group ${className}`}>
    <div
      className={`absolute right-3 top-1/2 transform -translate-y-1/2 transition-colors duration-200 z-10 pointer-events-none ${
        hasValue ? 'text-teal-500' : 'text-gray-400 group-hover:text-gray-500'
      }`}
    >
      {icon}
    </div>
    {children}
  </div>
);

interface SectionHeaderProps {
  icon: React.ReactNode;
  title: string;
  subtitle?: string;
  gradient: string;
  required?: boolean;
}

const SectionHeader: React.FC<SectionHeaderProps> = ({
  icon,
  title,
  subtitle,
  gradient,
  required = false,
}) => (
  <motion.div variants={itemVariants} className="mb-6">
    <div className="flex items-center gap-3 mb-2">
      <div className={`p-2 rounded-xl bg-gradient-to-br ${gradient} shadow-lg`}>
        <div className="text-white">{icon}</div>
      </div>
      <h3 className="text-xl font-bold text-gray-800">
        {title}
        {required && <span className="text-red-500 mr-1">*</span>}
      </h3>
    </div>
    {subtitle && (
      <p className="text-sm text-gray-600 leading-relaxed mr-12">{subtitle}</p>
    )}
  </motion.div>
);

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.08, delayChildren: 0.1 },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 15 },
  visible: {
    opacity: 1,
    y: 0,
    transition: { duration: 0.4, ease: 'easeOut' },
  },
};

// ============================================================================
// MAIN COMPONENT
// ============================================================================

interface PersonalDetailsStepProps {
  personalDetailsDict: RegisterStepsDict['steps']['personalDetails'];
  optionalInfoDict: RegisterStepsDict['steps']['optionalInfo'];
  consentDict: RegisterStepsDict['consentCheckbox'];
  validationDict: RegisterStepsDict['validationErrors'];
  locale: 'he' | 'en';
}

const validatePhoneNumber = (phone: string): boolean => {
  if (!phone) return false;
  const cleanPhone = phone.replace(/\D/g, '');
  return (
    cleanPhone.length >= 10 && cleanPhone.length <= 15 && phone.startsWith('+')
  );
};

export default function PersonalDetailsStep({
  personalDetailsDict,
  optionalInfoDict,
  consentDict,
  validationDict,
  locale,
}: PersonalDetailsStepProps) {
  const {
    data: registrationState,
    updateField,
    prevStep,
    startSubmission,
    updateSubmission,
    endSubmission,
  } = useRegistration();
  const { data: session, update: updateSession } = useSession(); // Added updateSession
  const router = useRouter();
  const fileInputRef = useRef<HTMLInputElement>(null);

  // States
  const [firstNameError, setFirstNameError] = useState('');
  const [lastNameError, setLastNameError] = useState('');
  const [phoneError, setPhoneError] = useState('');
  const [ageError, setAgeError] = useState('');
  const [religiousLevelError, setReligiousLevelError] = useState('');
  const [cityError, setCityError] = useState('');

  // Local state for city input value to handle typing before selection
  const [cityInputValue, setCityInputValue] = useState(
    registrationState.city || ''
  );

  const [isLoading, setIsLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);
  const [missingFields, setMissingFields] = useState<string[]>([]);

  interface UploadedPhoto {
    file: File;
    preview: string;
    isMain: boolean;
  }

  const [uploadedPhotos, setUploadedPhotos] = useState<UploadedPhoto[]>([]);
  const MAX_PHOTOS = 5;
  const MIN_PHOTOS = 1;
  const [aboutMe, setAboutMe] = useState('');
  const MIN_ABOUT_LENGTH = 100;

  // Consents
  const userHasAlreadyConsented = !!session?.user?.termsAndPrivacyAcceptedAt;
  const [consentChecked, setConsentChecked] = useState(userHasAlreadyConsented);
  const [consentError, setConsentError] = useState<string | null>(null);

  const [engagementConsent, setEngagementConsent] = useState(
    session?.user?.engagementEmailsConsent || false
  );
  const [promotionalConsent, setPromotionalConsent] = useState(
    session?.user?.promotionalEmailsConsent || false
  );
  const [engagementConsentError, setEngagementConsentError] = useState<
    string | null
  >(null);

  const isRTL = locale === 'he';

  const religiousLevelOptions = useMemo(() => {
    return Object.entries(personalDetailsDict.religiousLevels).map(
      ([value, label]) => ({
        value,
        label,
      })
    );
  }, [personalDetailsDict.religiousLevels]);

  const previewsRef = useRef<string[]>([]);
  useEffect(() => {
    previewsRef.current = uploadedPhotos.map((p) => p.preview);
  }, [uploadedPhotos]);

  useEffect(() => {
    return () => {
      previewsRef.current.forEach((url) => URL.revokeObjectURL(url));
    };
  }, []);

  useEffect(() => {
    // Sync local city input with registration state if it changes externally
    if (registrationState.city) {
      setCityInputValue(registrationState.city);
    }
  }, [registrationState.city]);

  useEffect(() => {
    router.prefetch(`/${locale}/auth/verify-phone`);
    router.prefetch(`/${locale}/profile`); // Prefetch profile as well
  }, [router, locale]);

  // Handlers (Photos, Age validation, etc. - keep as is)
  const handlePhotoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const remainingSlots = MAX_PHOTOS - uploadedPhotos.length;
    if (remainingSlots <= 0) {
      toast.error(
        personalDetailsDict.photos?.maxPhotosError ||
          `转 注转 注 ${MAX_PHOTOS} 转转`
      );
      return;
    }

    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
    const maxSize = 10 * 1024 * 1024; // 5MB
    const newPhotos: UploadedPhoto[] = [];

    Array.from(files)
      .slice(0, remainingSlots)
      .forEach((file) => {
        if (!validTypes.includes(file.type)) {
          toast.error(`${file.name}: 住 拽抓  转`);
          return;
        }
        if (file.size > maxSize) {
          toast.error(`${file.name}: 拽抓   (拽住 10MB)`);
          return;
        }
        const previewUrl = URL.createObjectURL(file);
        newPhotos.push({
          file,
          preview: previewUrl,
          isMain: uploadedPhotos.length === 0 && newPhotos.length === 0,
        });
      });

    if (newPhotos.length > 0) {
      setUploadedPhotos((prev) => [...prev, ...newPhotos]);
      toast.success(
        personalDetailsDict.photos?.uploadSuccess || '转转 住驻 爪'
      );
    }
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const handleRemovePhoto = (index: number) => {
    setUploadedPhotos((prev) => {
      const newPhotos = [...prev];
      const wasMain = newPhotos[index].isMain;
      newPhotos.splice(index, 1);
      if (wasMain && newPhotos.length > 0) {
        newPhotos[0].isMain = true;
      }
      return newPhotos;
    });
  };

  const handleSetMainPhoto = (index: number) => {
    setUploadedPhotos((prev) =>
      prev.map((photo, i) => ({ ...photo, isMain: i === index }))
    );
  };

  const validateAge = (birthDate: string) => {
    if (!birthDate) {
      setAgeError(personalDetailsDict.errors.birthDateRequired);
      return false;
    }
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birth.getDate())
    ) {
      age--;
    }
    if (age < 18) {
      setAgeError(personalDetailsDict.errors.ageTooLow);
      return false;
    }
    if (age > 120) {
      setAgeError(personalDetailsDict.errors.ageTooHigh);
      return false;
    }
    setAgeError('');
    return true;
  };

  const uploadPhotosToServer = async (): Promise<boolean> => {
    if (uploadedPhotos.length === 0) return true;
    try {
      const mainPhotoIndex = uploadedPhotos.findIndex((p) => p.isMain);
      const uploadResults = await Promise.all(
        uploadedPhotos.map(async (photo, index) => {
          const formData = new FormData();
          formData.append('file', photo.file);
          const response = await fetch('/api/profile/images', {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || `砖 注转 转 ${index + 1}`
            );
          }
          return response.json();
        })
      );
      if (mainPhotoIndex > 0 && uploadResults[mainPhotoIndex]?.image?.id) {
        await fetch(
          `/api/profile/images/${uploadResults[mainPhotoIndex].image.id}`,
          { method: 'PUT' }
        );
      }
      return true;
    } catch (error) {
      console.error('Photo upload error:', error);
      throw error;
    }
  };

  // ==================== UPDATED SUBMIT LOGIC ====================
  const handleSubmit = async () => {
    setApiError(null);
    setConsentError(null);
    setEngagementConsentError(null);
    setReligiousLevelError('');
    setCityError('');
    setMissingFields([]);
    setFirstNameError('');
    setLastNameError('');
    setPhoneError('');
    setAgeError('');

    const currentMissing: string[] = [];
    let hasError = false;

    // Validation
    if (!registrationState.firstName.trim()) {
      setFirstNameError(personalDetailsDict.errors.firstNameRequired);
      currentMissing.push(validationDict.fields.firstName);
      hasError = true;
    }
    if (!registrationState.lastName.trim()) {
      setLastNameError(personalDetailsDict.errors.lastNameRequired);
      currentMissing.push(validationDict.fields.lastName);
      hasError = true;
    }
    if (
      !registrationState.phone ||
      !validatePhoneNumber(registrationState.phone)
    ) {
      setPhoneError(personalDetailsDict.errors.phoneInvalid);
      currentMissing.push(validationDict.fields.phone);
      hasError = true;
    }
    if (!registrationState.gender) {
      currentMissing.push(validationDict.fields.gender);
      hasError = true;
    }
    if (!registrationState.birthDate) {
      setAgeError(personalDetailsDict.errors.birthDateRequired);
      currentMissing.push(validationDict.fields.birthDate);
      hasError = true;
    } else if (!validateAge(registrationState.birthDate)) {
      currentMissing.push(validationDict.fields.birthDate);
      hasError = true;
    }
    if (!registrationState.city || !registrationState.city.trim()) {
      setCityError(
        personalDetailsDict.errors.cityRequired || ' 专 注专 专'
      );
      currentMissing.push(personalDetailsDict.cityLabel || '注专');
      hasError = true;
    }
    if (!registrationState.maritalStatus) {
      currentMissing.push(validationDict.fields.maritalStatus);
      hasError = true;
    }
    if (!registrationState.religiousLevel) {
      setReligiousLevelError(personalDetailsDict.errors.religiousLevelRequired);
      currentMissing.push(validationDict.fields.religiousLevel);
      hasError = true;
    }
    if (!consentChecked) {
      setConsentError(personalDetailsDict.errors.consentRequired);
      currentMissing.push(validationDict.fields.terms);
      hasError = true;
    }
    if (!engagementConsent) {
      setEngagementConsentError(
        personalDetailsDict.errors.engagementConsentRequired
      );
      currentMissing.push(validationDict.fields.engagement);
      hasError = true;
    }
    if (uploadedPhotos.length < MIN_PHOTOS) {
      currentMissing.push(
        personalDetailsDict.photos?.fieldName || '转转 驻专驻'
      );
      hasError = true;
    }
    if (aboutMe.trim().length < MIN_ABOUT_LENGTH) {
      currentMissing.push(
        personalDetailsDict.aboutMe?.fieldName || '住驻专 砖'
      );
      hasError = true;
    }

    if (hasError) {
      setMissingFields(currentMissing);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    setIsLoading(true);

    try {
      // 1. Consent
      if (!userHasAlreadyConsented) {
        startSubmission(
          optionalInfoDict.loadingOverlay?.acceptingTerms ||
            '砖专 转 砖砖...',
          optionalInfoDict.loadingOverlay?.subtitle
        );
        const consentResponse = await fetch('/api/user/accept-terms', {
          method: 'POST',
        });
        if (!consentResponse.ok)
          throw new Error(personalDetailsDict.errors.consentApiError);
      } else {
        startSubmission(
          optionalInfoDict.loadingOverlay?.savingProfile ||
            optionalInfoDict.status.saving,
          optionalInfoDict.loadingOverlay?.subtitle
        );
      }

      // 2. Profile Data
      updateSubmission(
        'savingProfile',
        optionalInfoDict.loadingOverlay?.savingProfile ||
          optionalInfoDict.status.saving
      );

      const profileData = {
        firstName: registrationState.firstName,
        lastName: registrationState.lastName,
        phone: registrationState.phone,
        gender: registrationState.gender,
        birthDate: registrationState.birthDate,
        maritalStatus: registrationState.maritalStatus,
        religiousLevel: registrationState.religiousLevel,
        city: registrationState.city,
        height: registrationState.height,
        occupation: registrationState.occupation,
        education: registrationState.education,
        about: aboutMe,
        engagementEmailsConsent: engagementConsent,
        promotionalEmailsConsent: promotionalConsent,
      };

      const profileResponse = await fetch('/api/auth/complete-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(profileData),
      });

      if (!profileResponse.ok) {
        const errorData = await profileResponse.json();
        throw new Error(errorData.error || optionalInfoDict.errors.default);
      }

      // 3. Upload Photos
      if (uploadedPhotos.length > 0) {
        updateSubmission(
          'uploadingPhotos',
          personalDetailsDict.photos?.uploadingPhotos || '注 转转...'
        );
        await uploadPhotosToServer();
      }

      // 4. Update session to get latest User status
      await updateSession();
      const currentUser = session?.user as SessionUserType | undefined;
      const isAlreadyPhoneVerified = currentUser?.isPhoneVerified;

      // 5. Logic Branch: Verify Phone OR Go to Profile
      if (isAlreadyPhoneVerified) {
        // If user is ALREADY verified, skip sending code and go to profile
        updateSubmission(
          'redirecting',
          optionalInfoDict.loadingOverlay?.redirecting || '注专 驻专驻...'
        );
        router.push(`/${locale}/profile`);
      } else {
        // Normal flow: Send code and go to verify-phone
        updateSubmission(
          'sendingCode',
          optionalInfoDict.loadingOverlay?.sendingCode ||
            optionalInfoDict.status.sendingCode
        );

        const sendCodeResponse = await fetch('/api/auth/send-phone-code', {
          method: 'POST',
        });
        if (!sendCodeResponse.ok) {
          const errorData = await sendCodeResponse.json();
          throw new Error(errorData.error || optionalInfoDict.errors.default);
        }

        updateSubmission(
          'redirecting',
          optionalInfoDict.loadingOverlay?.redirecting ||
            '注专 转 驻...'
        );
        router.push(`/${locale}/auth/verify-phone`);
      }
    } catch (err) {
      endSubmission(true);
      setApiError(
        err instanceof Error ? err.message : optionalInfoDict.errors.default
      );
      setIsLoading(false);
    }
  };

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
      className="space-y-8"
    >
      {/* ... (Rest of the JSX remains exactly the same as provided in the question) ... */}

      <motion.div
        variants={itemVariants}
        className="text-center p-4 bg-gradient-to-r from-teal-50 via-orange-50 to-rose-50 rounded-2xl border border-teal-100"
      >
        <div className="flex items-center justify-center gap-2 mb-2">
          <Sparkles className="w-5 h-5 text-teal-500" />
          <h2 className="text-lg font-bold text-gray-800">
            {personalDetailsDict.title}
          </h2>
          <Heart className="w-5 h-5 text-rose-500" />
        </div>
        <p className="text-sm text-gray-600 leading-relaxed">
          {personalDetailsDict.subtitle}
        </p>
      </motion.div>

      <AnimatePresence>
        {(apiError || missingFields.length > 0) && (
          <motion.div
            initial={{ opacity: 0, y: -10, height: 0 }}
            animate={{ opacity: 1, y: 0, height: 'auto' }}
            exit={{ opacity: 0, y: -10, height: 0 }}
            className="mb-6"
          >
            <Alert
              variant="destructive"
              className="border-2 bg-red-50/80 border-red-200"
            >
              <div className="flex items-start gap-3">
                <div className="p-2 bg-red-100 rounded-lg shrink-0">
                  {apiError ? (
                    <AlertCircle className="h-5 w-5 text-red-600" />
                  ) : (
                    <ListChecks className="h-5 w-5 text-red-600" />
                  )}
                </div>
                <div className="w-full">
                  {apiError ? (
                    <AlertDescription className="text-sm font-medium pt-1">
                      {apiError}
                    </AlertDescription>
                  ) : (
                    <>
                      <AlertTitle className="text-red-900 font-bold mb-2">
                        {validationDict.title}
                      </AlertTitle>
                      <AlertDescription className="text-red-800 text-sm">
                        <p className="mb-2 font-medium">
                          {validationDict.pleaseFill}
                        </p>
                        <ul className="list-disc list-inside space-y-1 opacity-90 pr-2 rtl:pr-2 rtl:pl-0 ltr:pl-2">
                          {missingFields.map((field, i) => (
                            <li key={i}>{field}</li>
                          ))}
                        </ul>
                      </AlertDescription>
                    </>
                  )}
                </div>
              </div>
            </Alert>
          </motion.div>
        )}
      </AnimatePresence>

      {/* ... (The rest of the form UI remains unchanged) ... */}

      {/* SECTION: Personal Details Fields */}
      <div className="space-y-6">
        <SectionHeader
          icon={<User className="w-5 h-5" />}
          title={isRTL ? '驻专 砖' : 'Personal Information'}
          gradient="from-teal-500 to-cyan-500"
        />

        <div className="grid grid-cols-2 gap-4">
          <motion.div variants={itemVariants} className="space-y-2">
            <Label
              htmlFor="firstName"
              className="text-sm font-semibold text-gray-700 flex items-center"
            >
              {personalDetailsDict.firstNameLabel}{' '}
              <span className="text-red-500 mr-1">*</span>
            </Label>
            <FieldWrapper
              icon={<Edit3 className="h-5 w-5" />}
              hasValue={!!registrationState.firstName}
            >
              <Input
                id="firstName"
                type="text"
                value={registrationState.firstName}
                onChange={(e) => {
                  updateField('firstName', e.target.value);
                  if (e.target.value.trim()) setFirstNameError('');
                }}
                placeholder={personalDetailsDict.firstNamePlaceholder}
                disabled={isLoading}
                className={inputBaseClasses(
                  !!firstNameError ||
                    missingFields.includes(validationDict.fields.firstName)
                )}
              />
            </FieldWrapper>
            {firstNameError && (
              <p className="text-xs text-red-600 flex items-center gap-1">
                <AlertCircle className="w-3 h-3" /> {firstNameError}
              </p>
            )}
          </motion.div>

          <motion.div variants={itemVariants} className="space-y-2">
            <Label
              htmlFor="lastName"
              className="text-sm font-semibold text-gray-700 flex items-center"
            >
              {personalDetailsDict.lastNameLabel}{' '}
              <span className="text-red-500 mr-1">*</span>
            </Label>
            <FieldWrapper
              icon={<Edit3 className="h-5 w-5" />}
              hasValue={!!registrationState.lastName}
            >
              <Input
                id="lastName"
                type="text"
                value={registrationState.lastName}
                onChange={(e) => {
                  updateField('lastName', e.target.value);
                  if (e.target.value.trim()) setLastNameError('');
                }}
                placeholder={personalDetailsDict.lastNamePlaceholder}
                disabled={isLoading}
                className={inputBaseClasses(
                  !!lastNameError ||
                    missingFields.includes(validationDict.fields.lastName)
                )}
              />
            </FieldWrapper>
            {lastNameError && (
              <p className="text-xs text-red-600 flex items-center gap-1">
                <AlertCircle className="w-3 h-3" /> {lastNameError}
              </p>
            )}
          </motion.div>
        </div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label className="text-sm font-semibold text-gray-700 flex items-center">
            {personalDetailsDict.phoneLabel}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <PhoneNumberInput
            value={registrationState.phone}
            onChange={(value) => {
              updateField('phone', value || '');
              if (value && validatePhoneNumber(value)) setPhoneError('');
            }}
            disabled={isLoading}
            error={
              phoneError ||
              (missingFields.includes(validationDict.fields.phone)
                ? ' '
                : undefined)
            }
            locale={locale}
          />
          {phoneError && (
            <p className="text-xs text-red-600 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" /> {phoneError}
            </p>
          )}
        </motion.div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label className="text-sm font-semibold text-gray-700 flex items-center">
            {personalDetailsDict.genderLabel}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <div className="grid grid-cols-2 gap-3">
            {[
              { value: Gender.MALE, label: personalDetailsDict.male },
              { value: Gender.FEMALE, label: personalDetailsDict.female },
            ].map(({ value, label }) => (
              <button
                key={value}
                type="button"
                onClick={() => updateField('gender', value)}
                disabled={isLoading}
                className={`py-3 px-4 rounded-xl border-2 font-medium transition-colors duration-200 ${
                  registrationState.gender === value
                    ? 'bg-teal-50 border-teal-500 text-teal-700'
                    : missingFields.includes(validationDict.fields.gender)
                      ? 'border-red-300 text-gray-600 hover:bg-gray-50'
                      : 'border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50'
                }`}
              >
                {label}
              </button>
            ))}
          </div>
        </motion.div>

        {/* === CITY FIELD === */}
        <motion.div variants={itemVariants} className="space-y-2">
          <Label
            htmlFor="city-autocomplete"
            className="text-sm font-semibold text-gray-700 flex items-center"
          >
            {personalDetailsDict.cityLabel || '注专 专'}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <FieldWrapper
            icon={<MapPin className="h-5 w-5" />}
            hasValue={!!registrationState.city}
          >
            <Autocomplete
              apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
              id="city-autocomplete"
              language={locale}
              value={cityInputValue}
              onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                setCityInputValue(e.target.value);
                if (e.target.value) setCityError('');
              }}
              onPlaceSelected={(place) => {
                if (!place || !place.address_components) {
                  const fallback = cityInputValue || '';
                  updateField('city', fallback);
                  return;
                }

                const cityComponent = place.address_components.find(
                  (component) => component.types.includes('locality')
                );
                const selectedCity =
                  cityComponent?.long_name ||
                  place.formatted_address ||
                  cityInputValue;

                updateField('city', selectedCity);
                setCityInputValue(selectedCity);
                setCityError('');
              }}
              options={{
                types: ['(cities)'],
                componentRestrictions: { country: 'il' },
                fields: ['address_components', 'formatted_address', 'geometry'],
              }}
              disabled={isLoading}
              placeholder={personalDetailsDict.cityPlaceholder || '驻砖 注专...'}
              className={inputBaseClasses(
                !!cityError ||
                  missingFields.includes(personalDetailsDict.cityLabel || '注专')
              )}
            />
          </FieldWrapper>
          {cityError && (
            <p className="text-xs text-red-600 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" /> {cityError}
            </p>
          )}
        </motion.div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label
            htmlFor="birthDate"
            className="text-sm font-semibold text-gray-700 flex items-center"
          >
            {personalDetailsDict.birthDateLabel}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <FieldWrapper
            icon={<Calendar className="h-5 w-5" />}
            hasValue={!!registrationState.birthDate}
          >
            <Input
              id="birthDate"
              type="date"
              value={registrationState.birthDate}
              onChange={(e) => {
                updateField('birthDate', e.target.value);
                if (e.target.value) validateAge(e.target.value);
              }}
              disabled={isLoading}
              className={inputBaseClasses(
                !!ageError ||
                  missingFields.includes(validationDict.fields.birthDate)
              )}
            />
          </FieldWrapper>
          {ageError && (
            <p className="text-xs text-red-600 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" /> {ageError}
            </p>
          )}
        </motion.div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label className="text-sm font-semibold text-gray-700 flex items-center">
            {personalDetailsDict.maritalStatusLabel}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <FieldWrapper
            icon={<Heart className="h-5 w-5" />}
            hasValue={!!registrationState.maritalStatus}
          >
            <Select
              dir={isRTL ? 'rtl' : 'ltr'}
              value={registrationState.maritalStatus}
              onValueChange={(value) => updateField('maritalStatus', value)}
              disabled={isLoading}
            >
              <SelectTrigger
                className={inputBaseClasses(
                  missingFields.includes(validationDict.fields.maritalStatus)
                )}
              >
                <SelectValue
                  placeholder={personalDetailsDict.maritalStatusPlaceholder}
                />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="single">
                  {personalDetailsDict.maritalStatuses.single}
                </SelectItem>
                <SelectItem value="divorced">
                  {personalDetailsDict.maritalStatuses.divorced}
                </SelectItem>
                <SelectItem value="widowed">
                  {personalDetailsDict.maritalStatuses.widowed}
                </SelectItem>
              </SelectContent>
            </Select>
          </FieldWrapper>
        </motion.div>
      </div>

      <div className="space-y-6">
        <SectionHeader
          icon={<Sparkles className="w-5 h-5" />}
          title={optionalInfoDict.title}
          subtitle={optionalInfoDict.subtitle}
          gradient="from-orange-500 to-amber-500"
        />

        <div className="grid grid-cols-2 gap-4">
          <motion.div variants={itemVariants} className="space-y-2">
            <Label
              htmlFor="heightOptional"
              className="text-sm font-semibold text-gray-700"
            >
              {optionalInfoDict.heightLabel}
            </Label>
            <FieldWrapper
              icon={<Ruler className="h-5 w-5" />}
              hasValue={!!registrationState.height}
            >
              <Input
                type="number"
                id="heightOptional"
                value={registrationState.height ?? ''}
                onChange={(e) =>
                  updateField(
                    'height',
                    e.target.value ? parseInt(e.target.value, 10) : undefined
                  )
                }
                placeholder={optionalInfoDict.heightPlaceholder}
                disabled={isLoading}
                min={100}
                max={250}
                className={inputBaseClasses(false)}
              />
            </FieldWrapper>
          </motion.div>

          <motion.div variants={itemVariants} className="space-y-2">
            <Label
              htmlFor="occupationOptional"
              className="text-sm font-semibold text-gray-700"
            >
              {optionalInfoDict.occupationLabel}
            </Label>
            <FieldWrapper
              icon={<Briefcase className="h-5 w-5" />}
              hasValue={!!registrationState.occupation}
            >
              <Input
                type="text"
                id="occupationOptional"
                value={registrationState.occupation ?? ''}
                onChange={(e) => updateField('occupation', e.target.value)}
                placeholder={optionalInfoDict.occupationPlaceholder}
                disabled={isLoading}
                className={inputBaseClasses(false)}
              />
            </FieldWrapper>
          </motion.div>
        </div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label
            htmlFor="educationOptional"
            className="text-sm font-semibold text-gray-700"
          >
            {optionalInfoDict.educationLabel}
          </Label>
          <FieldWrapper
            icon={<GraduationCap className="h-5 w-5" />}
            hasValue={!!registrationState.education}
          >
            <Input
              type="text"
              id="educationOptional"
              value={registrationState.education ?? ''}
              onChange={(e) => updateField('education', e.target.value)}
              placeholder={optionalInfoDict.educationPlaceholder}
              disabled={isLoading}
              className={inputBaseClasses(false)}
            />
          </FieldWrapper>
        </motion.div>

        <motion.div variants={itemVariants} className="space-y-2">
          <Label className="text-sm font-semibold text-gray-700 flex items-center">
            {personalDetailsDict.religiousLevelLabel}{' '}
            <span className="text-red-500 mr-1">*</span>
          </Label>
          <FieldWrapper
            icon={<BookOpen className="h-5 w-5" />}
            hasValue={!!registrationState.religiousLevel}
          >
            <Select
              dir={isRTL ? 'rtl' : 'ltr'}
              value={registrationState.religiousLevel || ''}
              onValueChange={(value) => {
                updateField('religiousLevel', value);
                if (value) setReligiousLevelError('');
              }}
              disabled={isLoading}
            >
              <SelectTrigger
                className={inputBaseClasses(
                  !!religiousLevelError ||
                    missingFields.includes(validationDict.fields.religiousLevel)
                )}
              >
                <SelectValue
                  placeholder={personalDetailsDict.religiousLevelPlaceholder}
                />
              </SelectTrigger>
              <SelectContent className="max-h-[200px]">
                {religiousLevelOptions.map((opt) => (
                  <SelectItem key={opt.value} value={opt.value}>
                    {opt.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </FieldWrapper>
          {religiousLevelError && (
            <p className="text-xs text-red-600 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" /> {religiousLevelError}
            </p>
          )}
        </motion.div>
      </div>

      <div className="space-y-6">
        <SectionHeader
          icon={<Camera className="w-5 h-5" />}
          title={personalDetailsDict.photos?.title || '转转 砖'}
          subtitle={
            personalDetailsDict.photos?.subtitle ||
            '转转 转 转 砖注转转 转 住 转转 爪转'
          }
          gradient="from-rose-500 to-pink-500"
          required={true}
        />

        <motion.div variants={itemVariants}>
          <div className="grid grid-cols-3 gap-3 mb-4">
            {uploadedPhotos.map((photo, index) => (
              <div
                key={photo.preview}
                className={`relative aspect-square rounded-xl overflow-hidden border-2 transition-colors duration-200 group ${
                  photo.isMain
                    ? 'border-teal-500 ring-2 ring-teal-200'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <img
                  src={photo.preview}
                  alt={`转 ${index + 1}`}
                  className="absolute inset-0 w-full h-full object-cover"
                />
                {photo.isMain && (
                  <Badge className="absolute top-2 right-2 z-10 bg-gradient-to-r from-teal-500 to-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 border-none shadow-md">
                    <Star className="w-3 h-3 fill-current" />
                    <span>
                      {personalDetailsDict.photos?.mainPhoto || '专砖转'}
                    </span>
                  </Badge>
                )}
                <div className="absolute inset-0 z-20 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                  {!photo.isMain && (
                    <button
                      type="button"
                      onClick={() => handleSetMainPhoto(index)}
                      className="p-2 bg-white/90 rounded-full text-gray-700 hover:bg-white transition-colors"
                      title={
                        personalDetailsDict.photos?.setAsMain ||
                        '专 转 专砖转'
                      }
                    >
                      <Star className="w-4 h-4" />
                    </button>
                  )}
                  <button
                    type="button"
                    onClick={() => handleRemovePhoto(index)}
                    className="p-2 bg-red-500/90 rounded-full text-white hover:bg-red-600 transition-colors"
                    title={personalDetailsDict.photos?.remove || '住专'}
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}

            {uploadedPhotos.length < MAX_PHOTOS && (
              <button
                type="button"
                onClick={() => fileInputRef.current?.click()}
                disabled={isLoading}
                className={`aspect-square rounded-xl border-2 border-dashed transition-colors duration-200 flex flex-col items-center justify-center gap-2 ${
                  uploadedPhotos.length < MIN_PHOTOS &&
                  missingFields.includes(
                    personalDetailsDict.photos?.fieldName || '转转 驻专驻'
                  )
                    ? 'border-red-300 bg-red-50/30 text-red-500 hover:border-red-400 hover:bg-red-50/50'
                    : 'border-teal-300 bg-teal-50/30 text-teal-600 hover:border-teal-400 hover:bg-teal-50/50'
                }`}
              >
                <ImagePlus className="w-8 h-8" />
                <span className="text-xs font-medium">
                  {personalDetailsDict.photos?.addPhoto || '住祝 转'}
                </span>
                <span className="text-[10px] opacity-70">
                  {MAX_PHOTOS - uploadedPhotos.length}{' '}
                  {isRTL ? '转专' : 'remaining'}
                </span>
              </button>
            )}
          </div>

          <input
            ref={fileInputRef}
            type="file"
            accept="image/jpeg,image/png,image/jpg,image/webp"
            multiple
            onChange={handlePhotoSelect}
            className="hidden"
          />

          {uploadedPhotos.length < MIN_PHOTOS &&
            missingFields.includes(
              personalDetailsDict.photos?.fieldName || '转转 驻专驻'
            ) && (
              <p className="text-xs text-red-600 flex items-center gap-1 mb-3">
                <AlertCircle className="w-3 h-3" />
                {personalDetailsDict.photos?.required ||
                  '砖 注转 驻转 转 转'}
              </p>
            )}

          <div className="bg-gradient-to-r from-rose-50/50 to-pink-50/50 rounded-xl p-3 border border-rose-100">
            <p className="text-xs text-gray-600 leading-relaxed">
              <span className="font-semibold text-rose-600">
                {personalDetailsDict.photos?.tip || ' 驻:'}
              </span>{' '}
              {personalDetailsDict.photos?.tipText ||
                '注 转转 专专转 砖爪转 转 驻 砖.'}
            </p>
          </div>
        </motion.div>
      </div>

      <div className="space-y-6">
        <SectionHeader
          icon={<FileText className="w-5 h-5" />}
          title={personalDetailsDict.aboutMe?.title || '住驻专 砖  砖'}
          subtitle={
            personalDetailsDict.aboutMe?.subtitle ||
            '住驻专 注 注爪 -  拽 砖 注专 砖 专 转'
          }
          gradient="from-purple-500 to-indigo-500"
          required={true}
        />

        <motion.div variants={itemVariants} className="space-y-2">
          <div className="flex items-center justify-between">
            <Label
              htmlFor="aboutMe"
              className="text-sm font-semibold text-gray-700 flex items-center gap-1"
            >
              {personalDetailsDict.aboutMe?.label || '住驻专 注 注爪'}
              <span className="text-red-500 mr-1">*</span>
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      className="text-gray-400 hover:text-gray-600"
                    >
                      <Info className="w-4 h-4" />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent
                    side="top"
                    className="max-w-xs text-center"
                    dir={isRTL ? 'rtl' : 'ltr'}
                  >
                    <p>
                      {personalDetailsDict.aboutMe?.tooltip ||
                        '砖转驻 注 转, 注专,  砖   注专转 住'}
                    </p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </Label>
          </div>

          <Textarea
            id="aboutMe"
            value={aboutMe}
            onChange={(e) => setAboutMe(e.target.value)}
            placeholder={
              personalDetailsDict.aboutMe?.placeholder || '住驻专 注 注爪...'
            }
            disabled={isLoading}
            className={`min-h-[150px] py-3 border-2 rounded-xl transition-colors duration-200 bg-white/95 resize-none text-base md:text-sm ${
              aboutMe.trim().length < MIN_ABOUT_LENGTH &&
              missingFields.includes(
                personalDetailsDict.aboutMe?.fieldName || '住驻专 砖'
              )
                ? 'border-red-300 focus:ring-red-200 focus:border-red-400'
                : aboutMe.length > 0 && aboutMe.trim().length < MIN_ABOUT_LENGTH
                  ? 'border-amber-300 focus:ring-amber-200 focus:border-amber-400'
                  : 'border-gray-200 hover:border-gray-300 focus:border-purple-400 focus:ring-2 focus:ring-purple-200'
            }`}
            rows={6}
          />

          <div className="flex justify-between items-center">
            <div>
              {aboutMe.trim().length < MIN_ABOUT_LENGTH &&
              missingFields.includes(
                personalDetailsDict.aboutMe?.fieldName || '住驻专 砖'
              ) ? (
                <p className="text-xs text-red-600 flex items-center gap-1">
                  <AlertCircle className="w-3 h-3" />
                  {personalDetailsDict.aboutMe?.required ||
                    `砖 转 驻转 ${MIN_ABOUT_LENGTH} 转`}
                </p>
              ) : (
                aboutMe.length > 0 &&
                aboutMe.trim().length < MIN_ABOUT_LENGTH && (
                  <span className="text-xs text-amber-600">
                    {personalDetailsDict.aboutMe?.minChars?.replace(
                      '{{remaining}}',
                      String(MIN_ABOUT_LENGTH - aboutMe.trim().length)
                    ) ||
                      `注 ${MIN_ABOUT_LENGTH - aboutMe.trim().length} 转 `}
                  </span>
                )
              )}
            </div>
            <span
              className={`text-xs ${aboutMe.trim().length >= MIN_ABOUT_LENGTH ? 'text-green-600' : 'text-gray-400'}`}
            >
              {aboutMe.trim().length} / {MIN_ABOUT_LENGTH}+
            </span>
          </div>
        </motion.div>
      </div>

      {/* --- SECTION 5: CONSENTS --- */}
      <motion.div variants={itemVariants} className="space-y-4">
        <div
          className={
            consentError || missingFields.includes(validationDict.fields.terms)
              ? 'rounded-2xl border-2 border-red-300'
              : ''
          }
        >
          <ConsentCheckbox
            checked={consentChecked}
            onChange={(isChecked) => {
              setConsentChecked(isChecked);
              if (isChecked) setConsentError(null);
            }}
            error={consentError}
            dict={consentDict}
          />
        </div>

        <div className="space-y-3">
          <SimpleConsentBox
            checked={engagementConsent}
            onToggle={() => {
              const newValue = !engagementConsent;
              setEngagementConsent(newValue);
              if (newValue) setEngagementConsentError(null);
            }}
            label={personalDetailsDict.engagementConsentLabel}
            required={true}
            error={
              engagementConsentError ||
              (missingFields.includes(validationDict.fields.engagement)
                ? ' '
                : null)
            }
          />

          <SimpleConsentBox
            checked={promotionalConsent}
            onToggle={() => setPromotionalConsent(!promotionalConsent)}
            label={personalDetailsDict.promotionalConsentLabel}
            required={false}
          />
        </div>

        <div className="flex items-start gap-3 p-4 bg-gray-50 rounded-2xl border border-gray-200 mt-2">
          <Shield className="w-5 h-5 text-teal-500 flex-shrink-0 mt-0.5" />
          <p className="text-xs text-gray-600 leading-relaxed">
            {isRTL
              ? '驻专 砖  爪驻.'
              : 'Your details are secure and encrypted.'}
          </p>
        </div>
      </motion.div>

      <motion.div variants={itemVariants} className="flex gap-4 pt-4">
        <Button
          type="button"
          onClick={prevStep}
          variant="outline"
          disabled={isLoading}
          className="px-6 py-6 rounded-xl border-2 hover:bg-gray-50"
        >
          <ArrowRight className={`h-5 w-5 ${isRTL ? '' : 'rotate-180'}`} />
          <span className="sr-only">{personalDetailsDict.backButton}</span>
        </Button>

        <Button
          type="button"
          onClick={handleSubmit}
          disabled={isLoading}
          className="flex-1 py-6 bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 rounded-xl text-base font-semibold group relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {!isLoading && (
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />
          )}

          {isLoading ? (
            <>
              <Loader2 className="h-5 w-5 animate-spin" />
              <span>{personalDetailsDict.nextButtonLoading}</span>
            </>
          ) : (
            <>
              <CheckCircle2 className="w-5 h-5" />
              <span>{personalDetailsDict.nextButton}</span>
              <ArrowLeft
                className={`w-5 h-5 group-hover:-translate-x-1 transition-transform ${
                  !isRTL ? 'rotate-180 group-hover:translate-x-1' : ''
                }`}
              />
            </>
          )}
        </Button>
      </motion.div>
    </motion.div>
  );
}
--- End of Content for PersonalDetailsStep.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\SubmissionStatusIndicator.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/SubmissionStatusIndicator.tsx
'use client';

import { CheckCircle, ShieldCheck } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import StandardizedLoadingSpinner from '@/components/questionnaire/common/StandardizedLoadingSpinner';

export type SubmissionStatus =
  | 'idle'
  | 'creatingAccount'
  | 'sendingCode'
  | 'savingProfile'
  | 'updatingSession'
  | 'redirecting'
  | 'error';

interface Step {
  id: SubmissionStatus;
  text: string;
}

interface SubmissionStatusIndicatorProps {
  currentStatus: SubmissionStatus;
  steps: Step[];
  dict: {
    title: string;
    subtitle: string;
  };
}

const SubmissionStatusIndicator: React.FC<SubmissionStatusIndicatorProps> = ({
  currentStatus,
  steps,
  dict,
}) => {
  const getStepStatus = (
    stepId: SubmissionStatus,
    current: SubmissionStatus
  ): 'completed' | 'in-progress' | 'pending' => {
    const stepIndex = steps.findIndex((s) => s.id === stepId);
    const currentIndex = steps.findIndex((s) => s.id === current);

    if (currentIndex === -1 || current === 'idle' || current === 'error') {
      return 'pending';
    }
    if (stepIndex < currentIndex) {
      return 'completed';
    }
    if (stepIndex === currentIndex) {
      return 'in-progress';
    }
    return 'pending';
  };

  const statusIcons = {
    completed: <CheckCircle className="h-6 w-6 text-green-500" />,
    'in-progress': (
      <StandardizedLoadingSpinner className="h-6 w-6 text-cyan-500" />
    ),
    pending: (
      <div className="h-6 w-6 rounded-full border-2 border-gray-300"></div>
    ),
  };

  const isVisible = currentStatus !== 'idle' && currentStatus !== 'error';

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center z-50 p-4"
          aria-modal="true"
          role="dialog"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{ type: 'spring', stiffness: 260, damping: 20 }}
            className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden"
          >
            <div className="h-2 bg-gradient-to-r from-cyan-500 to-pink-500"></div>

            <div className="p-6 text-center">
              <div className="flex justify-center items-center gap-2 mb-4">
                <ShieldCheck className="h-7 w-7 text-cyan-500" />
                <h3 className="text-xl font-bold text-gray-800">
                  {dict.title}
                </h3>
              </div>
              <p className="text-sm text-gray-600 mb-6">{dict.subtitle}</p>

              <div className="space-y-4">
                {steps.map((step) => {
                  const status = getStepStatus(step.id, currentStatus);
                  return (
                    <div
                      key={step.id}
                      className="flex items-center gap-4 text-right p-3 bg-gray-50 rounded-lg"
                    >
                      <div className="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                        {statusIcons[status]}
                      </div>
                      <span
                        className={`text-base font-medium ${status === 'pending' ? 'text-gray-400' : 'text-gray-700'}`}
                      >
                        {step.text}
                      </span>
                    </div>
                  );
                })}
              </div>
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default SubmissionStatusIndicator;
--- End of Content for SubmissionStatusIndicator.tsx ---

--------------------------------------------------------------------------------
File: C:\Users\eytan\Desktop\NeshamaTech\shidduch-system\src\components\auth\steps\WelcomeStep.tsx
--------------------------------------------------------------------------------
Content:
// src/components/auth/steps/WelcomeStep.tsx
'use client';

import { useState } from 'react';
import { useRegistration } from '../RegistrationContext';
import { signIn } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import { Heart, ArrowLeft, Mail, Loader2, ArrowRight } from 'lucide-react';
import Link from 'next/link';
import { motion } from 'framer-motion';
import type { RegisterStepsDict } from '@/types/dictionaries/auth';

interface WelcomeStepProps {
  dict: RegisterStepsDict['steps']['welcome'];
  locale: 'he' | 'en';
}

const WelcomeStep: React.FC<WelcomeStepProps> = ({ dict, locale }) => {
  const { nextStep } = useRegistration();
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const isRTL = locale === 'he';

  const handleGoogleSignIn = async () => {
    try {
      setIsGoogleLoading(true);
      localStorage.setItem('registration_started', 'true');
      await signIn('google', undefined, { hl: locale });
    } catch (error) {
      console.error('Google sign-in error:', error);
      setIsGoogleLoading(false);
    }
  };

  const handleEmailSignUp = () => {
    nextStep();
  };

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { 
      opacity: 1, 
      transition: { 
        staggerChildren: 0.1,
        delayChildren: 0.2 
      } 
    }
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5, ease: "easeOut" } }
  };

  return (
    <motion.div 
      className="space-y-8 text-center"
      variants={containerVariants}
      initial="hidden"
      animate="visible"
    >
      {/* --- Icon Header --- */}
      <motion.div variants={itemVariants} className="flex justify-center mb-6">
        <div className="relative">
          {/* UPDATED: Glow Effect (Rose/Orange) */}
          <div className="absolute inset-0 bg-rose-200/60 rounded-full blur-xl animate-pulse"></div>
          
          {/* UPDATED: Card Background (White/Rose/Orange) */}
          <div className="relative w-24 h-24 rounded-3xl bg-gradient-to-br from-white to-rose-50 border border-rose-100 flex items-center justify-center shadow-xl transform rotate-3 transition-transform hover:rotate-6 duration-500">
            {/* UPDATED: Icon Color (Rose to match the "Personal" principle) */}
            <Heart className="h-10 w-10 text-rose-500 fill-rose-500 drop-shadow-sm" />
          </div>
          
          {/* UPDATED: Decorative Element (Teal - for contrast) */}
          <motion.div 
            className="absolute -top-3 -right-3 w-10 h-10 rounded-full bg-gradient-to-br from-teal-400 to-emerald-500 flex items-center justify-center text-white text-lg font-bold shadow-lg border-2 border-white"
            animate={{ y: [0, -5, 0] }}
            transition={{ duration: 3, repeat: Infinity, ease: "easeInOut" }}
          >
            
          </motion.div>
        </div>
      </motion.div>

      {/* --- Title & Subtitle --- */}
      <motion.div variants={itemVariants} className="space-y-3">
        <h2 className="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
          {dict.title}
        </h2>
        <p className="text-gray-600 max-w-sm mx-auto text-lg leading-relaxed">
          {dict.subtitle}
        </p>
      </motion.div>

      {/* --- Action Buttons --- */}
      <motion.div variants={itemVariants} className="space-y-4 mt-8">
        {/* Google Button */}
        <Button
          onClick={handleGoogleSignIn}
          disabled={isGoogleLoading}
          variant="outline"
          size="lg"
          className="w-full relative z-20 bg-white hover:bg-gray-50 border-2 border-gray-200 hover:border-gray-300 py-7 rounded-2xl flex items-center justify-center gap-3 group transition-all duration-300 shadow-sm hover:shadow-md"
        >
          {isGoogleLoading ? (
            <Loader2 className="animate-spin h-5 w-5 text-gray-500" />
          ) : (
            <>
              {/* Google SVG remains standard colors */}
              <svg className="h-6 w-6 flex-shrink-0 transition-transform group-hover:scale-110 duration-300" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  fill="#4285F4"
                />
                <path
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  fill="#34A853"
                />
                <path
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                  fill="#FBBC05"
                />
                <path
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  fill="#EA4335"
                />
              </svg>
              <span className="text-gray-700 font-semibold text-base">
                {dict.googleButton}
              </span>
            </>
          )}
        </Button>

        {/* Email Button */}
        <Button
          onClick={handleEmailSignUp}
          size="lg"
          // UPDATED: Gradient (Teal -> Orange -> Amber)
          className="w-full relative z-20 py-7 rounded-2xl bg-gradient-to-r from-teal-500 via-orange-500 to-amber-500 hover:from-teal-600 hover:via-orange-600 hover:to-amber-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-3 group overflow-hidden"
        >
          {/* Shine Effect */}
          <span className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] pointer-events-none"></span>
          
          <Mail className="h-5 w-5 text-white" />
          <span className="font-semibold text-base tracking-wide">{dict.emailButton}</span>
          {isRTL ? (
            <ArrowLeft className="h-5 w-5 text-white opacity-70 group-hover:opacity-100 group-hover:-translate-x-1 transition-all duration-300" />
          ) : (
            <ArrowRight className="h-5 w-5 text-white opacity-70 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-300" />
          )}
        </Button>
      </motion.div>

      {/* --- Footer Links --- */}
      <motion.div 
        variants={itemVariants} 
        className="pt-6 border-t border-gray-100 relative z-20"
      >
        <p className="text-gray-500 text-sm">
          {dict.signInPrompt}{' '}
          {/* UPDATED: Link Gradient (Teal -> Orange) */}
          <Link
            href="/auth/signin"
            className="font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-orange-600 hover:from-teal-700 hover:to-orange-700 hover:underline transition-all"
          >
            {dict.signInLink}
          </Link>
        </p>
      </motion.div>

      <style>{`
        @keyframes shimmer {
          100% { transform: translateX(100%); }
        }
      `}</style>
    </motion.div>
  );
};

export default WelcomeStep;
--- End of Content for WelcomeStep.tsx ---

